<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <!-- AGGRESSIVE CACHE PREVENTION -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <!-- APP VERSION - Update this when making changes -->
    <meta name="app-version" content="2025.01.05.1">
    <title>CER Interactive Questions</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --main-text: #333;
            --light-text: #555;
            --peach: #fcece3;
            --teal: #d7eded;
            --blue-light: #e7f5ff;
            --border-color: #dee2e6;
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --primary-blue: #007bff;
            --secondary-blue: #6c757d;
            --disabled-grey: #b0b8c0;
            --label-color: #aab5c0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--main-text);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            background: transparent;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            padding: 0;
        }

        .sidebar {
            width: 250px;
            padding: 2rem;
            background-color: #fdfdfd;
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .sidebar h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .sidebar-nav button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0.9rem 1.5rem;
            margin-bottom: 1rem;
            border-radius: 50px;
            border: 2px solid var(--border-color);
            background-color: transparent;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
        }

        .sidebar-nav button.active {
            background-color: var(--teal);
            border-color: #bedbdb;
            color: #000;
            font-weight: 600;
        }

        .sidebar-nav button:hover {
            background-color: var(--blue-light);
            border-color: var(--primary-blue);
        }

        /* Sidebar Topic Count Badge */
        .sidebar-topic-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.5);
            background: rgba(0, 0, 0, 0.08);
            margin-left: auto;
        }

        .sidebar-nav button.active .sidebar-topic-badge {
            background: rgba(0, 0, 0, 0.12);
            color: rgba(0, 0, 0, 0.65);
        }

        .sidebar-nav button:hover .sidebar-topic-badge {
            background: rgba(0, 123, 255, 0.15);
            color: var(--primary-blue);
        }

        .main-content,
        .view-content,
        .topic-content {
            flex-grow: 1;
            padding: 2.5rem 3rem;
        }

        /* Premium Navigation Group Styles */
        .main-nav-groups {
            position: relative;
        }

        .nav-group {
            position: relative;
        }

        .nav-group-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-group:hover .nav-group-btn {
            background: rgba(0, 123, 255, 0.08) !important;
            color: var(--primary-blue) !important;
        }

        .nav-group:hover .nav-dropdown {
            opacity: 1 !important;
            transform: translateY(0) !important;
            pointer-events: all !important;
        }

        .nav-group:hover .nav-arrow {
            transform: rotate(180deg) !important;
        }

        /* Create invisible bridge between button and dropdown to maintain hover */
        .nav-group::after {
            content: '';
            position: absolute;
            top: 100%;
            left: -20px;
            right: -20px;
            height: 12px;
            background: transparent;
            z-index: 999;
        }

        .nav-dropdown {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .nav-dropdown-item {
            position: relative;
            overflow: hidden;
        }

        .nav-dropdown-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary-blue);
            transform: scaleY(0);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-dropdown-item:hover {
            background: rgba(0, 123, 255, 0.08) !important;
            transform: translateX(4px);
        }

        .nav-dropdown-item:hover::before {
            transform: scaleY(1);
        }

        .nav-dropdown-item:active {
            transform: translateX(4px) scale(0.98);
        }

        /* Tutorial Help Button */
        .tutorial-help-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tutorial-help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4) !important;
            background: #0056b3 !important;
        }

        .tutorial-help-btn:active {
            transform: scale(0.95);
        }

        /* ==================== LIQUID GLASS TOOLTIP SYSTEM ==================== */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip {
            position: absolute;
            /* Liquid Glass Effect */
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.9) 0%,
                rgba(255, 255, 255, 0.7) 50%,
                rgba(240, 248, 255, 0.85) 100%
            );
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            color: #1a1a2e;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.9) translateY(-8px);
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            /* Glass border and shadow */
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.12),
                0 2px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -1px 0 rgba(0, 0, 0, 0.05);
            max-width: 280px;
            white-space: normal;
            line-height: 1.5;
            letter-spacing: 0.01em;
        }

        /* Glass shimmer effect on hover */
        .tooltip::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.4) 50%,
                transparent 100%
            );
            border-radius: 16px;
            pointer-events: none;
        }

        .tooltip.show::after {
            animation: glassShimmer 0.8s ease-out forwards;
        }

        @keyframes glassShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Tooltip positioning - arrows with CSS custom properties for dynamic positioning */
        .tooltip-top::before {
            content: '';
            position: absolute;
            top: 100%;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: rgba(255, 255, 255, 0.9);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .tooltip-bottom::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-bottom-color: rgba(255, 255, 255, 0.9);
            filter: drop-shadow(0 -2px 4px rgba(0, 0, 0, 0.1));
        }

        .tooltip-left::before {
            content: '';
            position: absolute;
            left: 100%;
            top: var(--arrow-top, 50%);
            transform: translateY(-50%);
            border: 8px solid transparent;
            border-left-color: rgba(255, 255, 255, 0.9);
            filter: drop-shadow(2px 0 4px rgba(0, 0, 0, 0.1));
        }

        .tooltip-right::before {
            content: '';
            position: absolute;
            right: 100%;
            top: var(--arrow-top, 50%);
            transform: translateY(-50%);
            border: 8px solid transparent;
            border-right-color: rgba(255, 255, 255, 0.9);
            filter: drop-shadow(-2px 0 4px rgba(0, 0, 0, 0.1));
        }

        /* Show animations for fixed positioning */
        .tooltip.show {
            opacity: 1 !important;
        }

        .tooltip-top.show {
            animation: liquidGlassAppearTop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .tooltip-bottom.show {
            animation: liquidGlassAppearBottom 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .tooltip-right.show {
            animation: liquidGlassAppearRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .tooltip-left.show {
            animation: liquidGlassAppearLeft 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes liquidGlassAppearTop {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(-8px);
                backdrop-filter: blur(0px);
            }
            60% {
                transform: scale(1.02) translateY(2px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
                backdrop-filter: blur(20px);
            }
        }

        @keyframes liquidGlassAppearBottom {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(8px);
                backdrop-filter: blur(0px);
            }
            60% {
                transform: scale(1.02) translateY(-2px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
                backdrop-filter: blur(20px);
            }
        }

        @keyframes liquidGlassAppearRight {
            0% {
                opacity: 0;
                transform: scale(0.9) translateX(8px);
                backdrop-filter: blur(0px);
            }
            60% {
                transform: scale(1.02) translateX(-2px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateX(0);
                backdrop-filter: blur(20px);
            }
        }

        @keyframes liquidGlassAppearLeft {
            0% {
                opacity: 0;
                transform: scale(0.9) translateX(-8px);
                backdrop-filter: blur(0px);
            }
            60% {
                transform: scale(1.02) translateX(2px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateX(0);
                backdrop-filter: blur(20px);
            }
        }

        /* Liquid glass tooltip title styling */
        .tooltip-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: #0a0a1a;
            margin-bottom: 4px;
            display: block;
        }

        .tooltip-desc {
            font-weight: 400;
            font-size: 0.8rem;
            color: #3a3a5a;
            line-height: 1.45;
        }

        /* Dark mode support for liquid glass */
        @media (prefers-color-scheme: dark) {
            .tooltip {
                background: linear-gradient(
                    135deg,
                    rgba(40, 40, 60, 0.85) 0%,
                    rgba(30, 30, 50, 0.75) 50%,
                    rgba(45, 45, 70, 0.8) 100%
                );
                color: #e8e8f0;
                border: 1px solid rgba(255, 255, 255, 0.15);
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.4),
                    0 2px 8px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            }

            .tooltip::before {
                border-top-color: rgba(40, 40, 60, 0.85);
            }

            .tooltip-top::before {
                border-top-color: rgba(40, 40, 60, 0.85);
            }

            .tooltip-bottom::before {
                border-bottom-color: rgba(40, 40, 60, 0.85);
            }

            .tooltip-title {
                color: #ffffff;
            }

            .tooltip-desc {
                color: #c8c8e0;
            }
        }
        /* ==================== END LIQUID GLASS TOOLTIP SYSTEM ==================== */

        .question-container {
            margin-bottom: 3rem;
            position: relative;
            padding: 1.5rem;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .main-content p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            color: var(--light-text);
            line-height: 1.8;
        }

        .question-diagram {
            width: 100%;
            max-width: 600px;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .results-table {
            width: 100%;
            max-width: 700px;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .results-table th,
        .results-table td {
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .results-table thead {
            background-color: var(--peach);
        }

        .question-title {
            font-weight: 600;
            font-size: 1.15rem;
            color: var(--main-text);
        }

        .answer-box {
            background-color: var(--blue-light);
            padding: 2.5rem;
            border-radius: 12px;
            margin-top: 2rem;
        }

        .answer-template {
            font-size: 1.1rem;
            line-height: 2.2;
            color: var(--main-text);
        }

        .answer-blank {
            display: inline-flex;
            align-items: center;
            margin: 0 0.2rem;
        }

        .answer-input {
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            border: none;
            border-bottom: 2px solid var(--main-text);
            background: transparent;
            width: auto;
            min-width: 80px;
            text-align: center;
            padding: 0.1rem 0.5rem;
            margin: 0 4px;
        }

        .answer-input:focus {
            outline: none;
            border-bottom-color: var(--primary-blue);
        }

        .feedback-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            margin-left: 0.5rem;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 14px;
            transform: scale(0);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .feedback-icon.visible.correct,
        .feedback-icon.visible.incorrect {
            transform: scale(1);
            opacity: 1;
            animation: circle-pop 0.4s ease-out;
        }

        .feedback-icon.correct {
            background-color: var(--correct-color);
        }

        .feedback-icon.incorrect {
            background-color: var(--incorrect-color);
        }

        /* Answer feedback icon next to submit button */
        .answer-feedback-icon {
            display: inline-block;
            font-size: 1.5rem;
            font-weight: bold;
            margin-left: 12px;
            vertical-align: middle;
            animation: feedbackPop 0.3s ease-out;
        }

        @keyframes feedbackPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Explanation box - hidden by default, shown after answering */
        .explanation-box {
            display: none;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #f0f4ff;
            border-left: 4px solid #007bff;
            border-radius: 8px;
        }
        
        .explanation-box.visible {
            display: block;
        }

        /* Video container - hidden by default, shown after answering */
        .video-container.hidden-until-answered {
            display: none;
        }

        /* Draggable admin blocks */
        .admin-block {
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
        }
        
        .admin-block:not(.no-drag) {
            cursor: grab;
        }
        
        .admin-block:not(.no-drag):active {
            cursor: grabbing;
        }
        
        .admin-block.no-drag {
            cursor: default;
            opacity: 0.95;
        }
        
        .admin-block.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .admin-block.drag-over {
            border-top: 3px solid #007bff !important;
            margin-top: -3px;
        }
        
        .admin-block .drag-handle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: grab;
            color: #999;
            font-size: 1.2rem;
            padding: 5px;
            user-select: none;
        }
        
        .admin-block .drag-handle:hover {
            color: #666;
        }
        
        .admin-block .drag-handle:active {
            cursor: grabbing;
        }

        /* Rich Text Editor Styles */
        .text-formatting-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 8px;
            padding: 8px 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }

        .toolbar-group {
            display: flex;
            gap: 2px;
            padding: 0 8px;
            border-right: 1px solid #dee2e6;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-group:first-child {
            padding-left: 0;
        }

        .format-btn {
            width: 34px;
            height: 34px;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            color: #495057;
        }

        .format-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            transform: translateY(-1px);
        }

        .format-btn:active {
            background: #dee2e6;
            transform: translateY(0);
        }

        .format-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .rich-text-editor {
            min-height: 120px;
            padding: 14px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            outline: none;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.7;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .rich-text-editor:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }

        .rich-text-editor:empty:before {
            content: attr(data-placeholder);
            color: #adb5bd;
            pointer-events: none;
        }

        .rich-text-editor ol {
            padding-left: 2em;
            margin: 0.5em 0;
        }

        .rich-text-editor ul {
            padding-left: 2em;
            margin: 0.5em 0;
        }

        .rich-text-editor li {
            margin: 0.3em 0;
        }

        /* List type dropdown */
        .list-type-select {
            height: 34px;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0 8px;
            color: #495057;
            transition: all 0.15s ease;
        }

        .list-type-select:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .list-type-select:focus {
            outline: none;
            border-color: #007bff;
        }

        /* Parenthesis list styles using CSS counters */
        .rich-text-editor ol.paren-list {
            list-style: none;
            counter-reset: paren-counter;
        }

        .rich-text-editor ol.paren-list li {
            counter-increment: paren-counter;
        }

        .rich-text-editor ol.paren-list li::before {
            content: counter(paren-counter) ") ";
            margin-right: 0.3em;
        }

        .rich-text-editor ol.paren-list[data-list-type="lower-alpha"] li::before {
            content: counter(paren-counter, lower-alpha) ") ";
        }

        .rich-text-editor ol.paren-list[data-list-type="upper-alpha"] li::before {
            content: counter(paren-counter, upper-alpha) ") ";
        }

        .rich-text-editor ol.paren-list[data-list-type="decimal"] li::before {
            content: counter(paren-counter, decimal) ") ";
        }

        @keyframes circle-pop {
            0% {
                transform: scale(0);
            }

            60% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .cer-segment {
            position: relative;
            display: block;
            padding: 1.5rem 1.5rem 2.5rem 1.5rem;
            border: 1.5px solid var(--label-color);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .cer-segment:last-of-type {
            margin-bottom: 0;
        }

        .cer-segment::after {
            content: attr(data-label);
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--blue-light);
            padding: 0 0.5rem;
            font-size: 0.9rem;
            font-style: italic;
            color: var(--light-text);
            font-weight: 500;
        }

        .controls {
            margin-top: 2rem;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn {
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer !important;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            pointer-events: auto !important;
            position: relative;
            z-index: 1;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Worksheet Styles */
        .worksheet-badge {
            background: #ff4757;
            color: white;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 0.7rem;
            margin-left: 5px;
            vertical-align: middle;
        }

        .btn-worksheet-add {
            background: #f1f2f6;
            color: #2f3542;
            border: 1px solid #dfe4ea;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .btn-worksheet-add:hover {
            background: #2ed573;
            color: white;
            border-color: #2ed573;
        }

        .btn-worksheet-add.added {
            background: #2ed573;
            color: white;
            border-color: #2ed573;
        }

        .btn-worksheet-remove {
            background: #ffeae8;
            color: #dc3545;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-worksheet-remove:hover {
            background: #dc3545;
            color: white;
        }

        .submit-btn {
            background-color: var(--primary-blue);
            color: #fff;
        }

        .submit-btn:disabled {
            background-color: var(--disabled-grey);
            cursor: not-allowed;
        }

        .next-btn {
            background-color: var(--secondary-blue);
            color: #fff;
        }

        .hidden {
            display: none !important;
        }

        /* Top Navigation Tabs */
        .app-header {
            padding: 0.8rem 1rem 0;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            background: #f8f9fa;
        }

        /* Colored line below header that changes with tabs */
        .header-color-line {
            height: 5px;
            background: linear-gradient(90deg, #4a90d9 0%, #6ba3e0 100%);
            transition: background 0.4s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        /* Header Tabs Row with Level Selector */
        .header-tabs-row {
            display: flex;
            align-items: flex-end;
            gap: 0;
        }

        .level-selector-container {
            display: flex;
            align-items: center;
            padding-right: 12px;
            gap: 0;
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px 12px 0 0;
            padding: 6px 12px 8px 12px;
            box-shadow:
                0 -2px 10px rgba(102, 126, 234, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            animation: levelSelectorPulse 3s ease-in-out infinite;
            cursor: pointer;
        }

        @keyframes levelSelectorPulse {
            0%, 100% {
                box-shadow:
                    0 -2px 10px rgba(102, 126, 234, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }
            50% {
                box-shadow:
                    0 -2px 20px rgba(102, 126, 234, 0.5),
                    0 0 30px rgba(118, 75, 162, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
        }

        .level-selector-container:hover {
            animation: none;
            box-shadow:
                0 -4px 20px rgba(102, 126, 234, 0.5),
                0 0 30px rgba(118, 75, 162, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .level-selector-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            margin-right: 8px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }

        .level-selector-badge {
            position: absolute;
            top: -8px;
            right: -5px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(245, 87, 108, 0.4);
            animation: badgeBounce 2s ease-in-out infinite;
        }

        @keyframes badgeBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-2px) scale(1.05); }
        }

        .level-select {
            padding: 0.4rem 1.8rem 0.4rem 0.7rem;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            font-weight: 800;
            color: #1a1a2e;
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            cursor: pointer;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            min-width: 65px;
            text-align: center;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.2s ease;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
            background-size: 12px;
        }

        .level-select:hover {
            background: linear-gradient(135deg, #ffffff 0%, #e8edff 100%);
            transform: scale(1.02);
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        .level-select:focus {
            box-shadow:
                0 0 0 3px rgba(102, 126, 234, 0.3),
                0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .level-select option {
            background: white;
            color: #333;
            font-weight: 700;
            padding: 12px;
        }

        #header-tabs-container {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            margin: 0;
            padding: 0;
            flex: 1;
        }

        .app-logo {
            height: 50px;
            margin-right: 0;
            margin-bottom: 0;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            transition: transform 0.3s ease;
        }

        .app-logo:hover {
            transform: scale(1.05) rotate(-2deg);
        }

        .tab-btn {
            padding: 0.45rem 0.9rem;
            border: 1px solid #ccc;
            border-bottom: none;
            background-color: #e8e8e8;
            font-family: 'Poppins', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            color: #555;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            transition: all 0.15s ease;
            position: relative;
            margin: 0;
            margin-left: -1px;
            opacity: 0.9;
        }

        .tab-btn:first-child {
            margin-left: 0;
        }

        .tab-btn:hover {
            opacity: 1;
            z-index: 2;
        }

        .tab-btn.active {
            opacity: 1;
            border-color: #aaa;
            z-index: 3;
            font-weight: 600;
            color: #333;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.08);
        }

        /* Specific Pastel Colors for Tabs */
        .tab-btn[data-type="cer"] {
            background-color: #AEC6CF;
        }

        .tab-btn[data-type="single-relationship"] {
            background-color: #FFB7B2;
        }

        .tab-btn[data-type="double-relationship"] {
            background-color: #FFDAC1;
        }

        .tab-btn[data-type="fairness"] {
            background-color: #E2F0CB;
        }

        .tab-btn[data-type="reliability"] {
            background-color: #C7CEEA;
        }

        .tab-btn[data-type="accuracy"] {
            background-color: #FDFD96;
        }

        .tab-btn[data-type="constant-variable"] {
            background-color: #B5EAD7;
        }

        .tab-btn[data-type="explanation"] {
            background-color: #FF9AA2;
        }

        .tab-btn[data-type="control-setup"] {
            background-color: #E0BBE4;
        }

        .tab-btn[data-type="definition"] {
            background-color: #ADD8E6;
        }

        /* Tab Question Count Badge */
        .tab-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            margin-left: 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.6);
            background: rgba(0, 0, 0, 0.12);
            vertical-align: middle;
        }

        .tab-btn.active .tab-count-badge {
            background: rgba(0, 0, 0, 0.18);
            color: rgba(0, 0, 0, 0.7);
        }

        .tab-btn[data-type="definition"] {
            background-color: #ADD8E6;
        }

        .app-body {
            display: none;
            flex-grow: 1;
            background: #fff;
            border-top: none;
            position: relative;
            z-index: 15;
        }

        .app-body.active {
            display: flex;
        }

        .app-body>.sidebar {
            border-right: 1px solid var(--border-color);
            background: #fdfdfd;
        }

        .placeholder-content {
            padding: 3rem;
            text-align: center;
            width: 100%;
        }

        /* Variable Labels & Tooltips */
        .answer-group {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: bottom;
            margin: 0 0.2rem;
            position: relative;
            top: 10px;
        }

        .answer-group .answer-blank {
            margin: 0;
        }

        .variable-label {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
            border-bottom: 1px dotted #ccc;
            cursor: help;
            position: relative;
        }

        .variable-label:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            /* Liquid Glass Effect */
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.92) 0%,
                rgba(255, 255, 255, 0.75) 50%,
                rgba(240, 248, 255, 0.88) 100%
            );
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            color: #1a1a2e;
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 0.8rem;
            font-weight: 500;
            width: 220px;
            text-align: center;
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.12),
                0 2px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            pointer-events: none;
            line-height: 1.45;
            animation: liquidGlassAppear 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .variable-label:hover::before {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: rgba(255, 255, 255, 0.9);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .print-btn {
            background-color: #ffda9e;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #555;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-family: 'Poppins', sans-serif;
        }

        .print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: #ffc978;
        }

        /* Auth Overlay */
        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .auth-box {
            background: white;
            padding: 3rem;
            border-radius: 24px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.15);
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.05);
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .auth-logo {
            height: 70px;
            margin-bottom: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .auth-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .auth-subtitle {
            color: #666;
            margin-bottom: 2.5rem;
            font-size: 1.1rem;
        }

        .auth-input {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 16px;
            border: 2px solid #f0f0f0;
            border-radius: 14px;
            font-size: 1rem;
            transition: all 0.2s;
            font-family: inherit;
            background: #fafafa;
        }

        .auth-input:focus {
            border-color: var(--primary-blue);
            background: #fff;
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
            font-family: inherit;
        }

        .auth-btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
            box-shadow: 0 10px 20px rgba(0, 123, 255, 0.2);
        }

        .btn-primary:hover {
            box-shadow: 0 15px 30px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-google {
            background: white;
            border: 2px solid #eee;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .btn-google:hover {
            background: #fafafa;
            border-color: #ddd;
        }

        .toggle-link {
            color: var(--primary-blue);
            cursor: pointer;
            font-size: 0.95rem;
            margin-top: 20px;
            display: inline-block;
            font-weight: 500;
        }

        .toggle-link:hover {
            text-decoration: underline;
        }

        .error-msg {
            color: #dc3545;
            font-size: 0.95rem;
            margin-bottom: 20px;
            min-height: 24px;
            font-weight: 500;
        }

        .legal-check {
            text-align: left;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
        }

        .legal-check input {
            margin-top: 4px;
        }

        /* Streak Display */
        #login-days-display {
            background: linear-gradient(135deg, #e7f5ff 0%, #d7eded 100%);
            color: #007bff;
            padding: 15px;
            border-radius: 14px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.05rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
        }

        /* Animated Practice Mode Button */
        .practice-btn-animated {
            width: 100%;
            padding: 14px 16px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            color: white;
            font-family: 'Poppins', sans-serif;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3);
            animation: practiceGradient 3s ease infinite, practicePulse 2s ease-in-out infinite;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .practice-btn-animated:hover {
            transform: scale(1.03) translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5), 0 0 40px rgba(118, 75, 162, 0.4);
        }

        .practice-btn-animated:active {
            transform: scale(0.98);
        }

        .practice-btn-animated::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: practiceShine 3s ease-in-out infinite;
        }

        .practice-btn-icon {
            font-size: 1.3rem;
            animation: practiceBounce 1s ease-in-out infinite;
        }

        .practice-btn-text {
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .practice-btn-sparkle {
            font-size: 1rem;
            animation: practiceSparkle 1.5s ease-in-out infinite;
        }

        @keyframes practiceGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes practicePulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(102, 126, 234, 0.6), 0 0 45px rgba(118, 75, 162, 0.5); }
        }

        @keyframes practiceShine {
            0% { left: -50%; opacity: 0; }
            20% { opacity: 1; }
            50% { left: 100%; opacity: 0; }
            100% { left: 100%; opacity: 0; }
        }

        @keyframes practiceBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        @keyframes practiceSparkle {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
            25% { transform: scale(1.2) rotate(10deg); opacity: 0.8; }
            50% { transform: scale(0.8) rotate(-10deg); opacity: 1; }
            75% { transform: scale(1.1) rotate(5deg); opacity: 0.9; }
        }

        .practice-btn-animated.active {
            background: linear-gradient(135deg, #4c5fd5 0%, #5d3d8a 50%, #d87de8 100%);
        }

        /* Admin Edit Buttons */
        .admin-controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 50;
        }

        .admin-edit-btn,
        .admin-duplicate-btn,
        .admin-delete-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .admin-edit-btn:hover {
            background: #e7f5ff;
            border-color: #007bff;
            color: #007bff;
        }

        .admin-duplicate-btn:hover {
            background: #fdfdfd;
            border-color: #555;
        }

        .admin-delete-btn:hover {
            background: #dc3545 !important;
            color: white !important;
            border-color: #dc3545 !important;
        }

        /* Worksheet Control Bar */
        .worksheet-control-bar {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 50;
        }

        /* Worksheet Question Card */
        .worksheet-question-card {
            background: #fff;
            border: 2px solid #e3f2fd;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .worksheet-question-card .question-number {
            position: absolute;
            top: -12px;
            left: 20px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 4px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .worksheet-question-card .remove-btn-wrapper {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        /* MCQ Option Styles */
        .mcq-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: white;
            border: 2px solid #eee;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mcq-option:hover {
            border-color: var(--primary-blue);
            background: var(--blue-light);
        }

        .mcq-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* MCQ Correct Answer Dropdown Fix */
        #mcq-correct {
            line-height: normal;
            padding-top: 5px;
            padding-bottom: 5px;
            appearance: auto;
        }

        /* Logout Button */
        .logout-btn {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #ffeae8;
            color: #dc3545;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #dc3545;
            color: white;
        }

        /* Sidebar Sections */
        .sidebar-top-section {
            padding-bottom: 15px;
        }

        .sidebar-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #ddd, transparent);
            margin: 15px 0;
            position: relative;
        }

        .sidebar-divider::before {
            content: '  ';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #fdfdfd;
            padding: 0 10px;
            color: #bbb;
            font-size: 0.7rem;
            letter-spacing: 3px;
        }

        .sidebar-nav-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .sidebar-nav-btn {
            width: 100%;
            border-radius: 10px;
            border: none;
            padding: 12px 15px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            text-align: left;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-nav-btn:hover {
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sidebar-nav-btn.admin-btn {
            background: #ffd1dc;
            color: #d81b60;
        }

        .sidebar-nav-btn.worksheet-btn {
            background: #e3f2fd;
            color: #1976d2;
        }

        .sidebar-nav-btn.saved-btn {
            background: #e8f5e9;
            color: #388e3c;
        }

        .sidebar-nav-btn.lessons-btn {
            background: #fff3e0;
            color: #f57c00;
        }

        .sidebar-nav-btn.progress-btn {
            background: linear-gradient(135deg, #e8eaf6, #c5cae9);
            color: #3f51b5;
        }

        /* iOS-Style Toggle Switch */
        .ios-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            border-radius: 16px;
            margin-bottom: 5px;
        }

        .ios-toggle-label {
            font-size: 0.9rem;
            font-weight: 700;
            color: #666;
            min-width: 35px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .ios-toggle-label.active {
            color: #007AFF;
            transform: scale(1.1);
        }

        .ios-toggle {
            position: relative;
            width: 60px;
            height: 32px;
            cursor: pointer;
        }

        .ios-toggle-track {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #34C759 0%, #30D158 100%);
            border-radius: 16px;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 8px rgba(52, 199, 89, 0.3);
        }

        .ios-toggle.mcq-active .ios-toggle-track {
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .ios-toggle-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2), 0 1px 2px rgba(0,0,0,0.1);
        }

        .ios-toggle.mcq-active .ios-toggle-thumb {
            left: 30px;
        }

        .ios-toggle:hover .ios-toggle-thumb {
            transform: scale(1.05);
        }

        .ios-toggle:active .ios-toggle-thumb {
            width: 34px;
        }

        .ios-toggle.mcq-active:active .ios-toggle-thumb {
            left: 24px;
        }

        /* Exam Mode Toggle (Colour/Monochrome) */
        .exam-mode-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
            border-radius: 12px;
            margin-top: 8px;
        }

        .exam-mode-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #888;
            min-width: 50px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .exam-mode-label:first-of-type {
            text-align: right;
        }

        .exam-mode-label:last-of-type {
            text-align: left;
        }

        .exam-mode-toggle-container .exam-mode-label:first-of-type {
            color: #4CAF50;
            font-weight: 700;
        }

        .exam-mode-toggle-container.exam-active .exam-mode-label:first-of-type {
            color: #888;
            font-weight: 600;
        }

        .exam-mode-toggle-container.exam-active .exam-mode-label:last-of-type {
            color: #616161;
            font-weight: 700;
        }

        .exam-mode-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            cursor: pointer;
        }

        .exam-mode-track {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #4CAF50 0%, #81C784 100%);
            border-radius: 13px;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .exam-mode-toggle-container.exam-active .exam-mode-track {
            background: linear-gradient(135deg, #616161 0%, #9E9E9E 100%);
        }

        .exam-mode-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .exam-mode-toggle-container.exam-active .exam-mode-thumb {
            left: 26px;
        }

        /* Exam Mode (Monochrome) Styles for Questions */
        body.exam-mode .question-container,
        body.exam-mode .question-body,
        body.exam-mode .answer-template,
        body.exam-mode .answer-box {
            filter: grayscale(100%);
            -webkit-filter: grayscale(100%);
        }

        body.exam-mode .question-container img,
        body.exam-mode .question-body img,
        body.exam-mode .answer-template img,
        body.exam-mode .answer-box img {
            filter: grayscale(100%) contrast(1.1);
            -webkit-filter: grayscale(100%) contrast(1.1);
        }

        body.exam-mode .question-container {
            background: #fff !important;
            border-color: #333 !important;
        }

        body.exam-mode .question-container h3 {
            color: #000 !important;
        }

        body.exam-mode .cer-segment {
            background: #f5f5f5 !important;
            border-color: #999 !important;
        }

        body.exam-mode .answer-input {
            border-bottom-color: #333 !important;
        }

        /* Keep buttons and controls coloured for usability */
        body.exam-mode .controls,
        body.exam-mode .worksheet-control-bar,
        body.exam-mode .admin-controls,
        body.exam-mode button,
        body.exam-mode .btn {
            filter: none !important;
            -webkit-filter: none !important;
        }

        /* Toggle animation glow */
        .ios-toggle::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.3), rgba(48, 209, 88, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .ios-toggle:hover::after {
            opacity: 1;
        }

        .ios-toggle.mcq-active::after {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.3), rgba(88, 86, 214, 0.1));
        }

        /* Logout Button Update */
        .logout-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            margin-top: 5px;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #ff5252, #e04848);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(238, 90, 90, 0.3);
        }

        /* Version indicator (for debugging) */
        .version-indicator {
            position: fixed;
            bottom: 5px;
            right: 5px;
            font-size: 10px;
            color: #ccc;
            z-index: 9999;
        }

        /* Update notification banner */
        .update-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 100000;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            animation: slideDown 0.5s ease;
            flex-wrap: wrap;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .update-banner-text {
            font-size: 0.95rem;
            font-weight: 500;
        }

        .update-banner-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .update-banner-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .update-banner-dismiss {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .update-banner-dismiss:hover {
            background: rgba(255,255,255,0.1);
            border-color: white;
        }

        /* Table Grid Selector (PowerPoint-style) */
        .table-grid-selector {
            position: fixed;
            background: white;
            border: 2px solid #81c784;
            border-radius: 12px;
            padding: 15px 18px 18px 18px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25), 0 0 0 4px rgba(129, 199, 132, 0.2);
            z-index: 10000;
            visibility: hidden;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }

        .table-grid-selector.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        /* Arrow pointing down to the button (default, when selector is above) */
        .table-grid-selector.arrow-down::after {
            content: '';
            position: absolute;
            bottom: -10px;
            top: auto;
            left: 50%;
            transform: translateX(-50%);
            border-width: 10px 10px 0 10px;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }
        
        .table-grid-selector.arrow-down::before {
            content: '';
            position: absolute;
            bottom: -13px;
            top: auto;
            left: 50%;
            transform: translateX(-50%);
            border-width: 12px 12px 0 12px;
            border-style: solid;
            border-color: #81c784 transparent transparent transparent;
        }
        
        /* Arrow pointing up to the button (when selector is below) */
        .table-grid-selector.arrow-up::after {
            content: '';
            position: absolute;
            top: -10px;
            bottom: auto;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 10px 10px 10px;
            border-style: solid;
            border-color: transparent transparent white transparent;
        }
        
        .table-grid-selector.arrow-up::before {
            content: '';
            position: absolute;
            top: -13px;
            bottom: auto;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 12px 12px 12px;
            border-style: solid;
            border-color: transparent transparent #81c784 transparent;
        }

        .table-grid-selector h4 {
            margin: 0 0 12px 0;
            font-size: 0.95rem;
            color: #333;
            font-weight: 600;
        }

        .table-grid {
            display: grid;
            grid-template-columns: repeat(8, 28px);
            grid-template-rows: repeat(8, 28px);
            gap: 3px;
            background: #f5f5f5;
            padding: 5px;
            border-radius: 6px;
        }

        .table-grid-cell {
            width: 28px;
            height: 28px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .table-grid-cell.selected {
            background: #81c784;
            border-color: #4caf50;
        }

        .table-grid-cell:hover {
            border-color: #4caf50;
        }

        .grid-size-label {
            text-align: center;
            margin-top: 12px;
            font-size: 0.9rem;
            color: #007bff;
            font-weight: 600;
        }

        /* Admin Table Editor */
        .admin-table-wrapper {
            margin-top: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .admin-table-container {
            overflow-x: auto;
            padding: 10px;
            background: white;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Century Gothic', 'Segoe UI', 'Poppins', sans-serif;
            font-size: 0.95rem;
        }

        .admin-table td,
        .admin-table th {
            border: 1px solid #bbb;
            padding: 10px 14px;
            min-width: 60px;
            position: relative;
            vertical-align: middle;
            word-wrap: break-word;
        }
        
        /* Multi-cell selection highlight */
        .admin-table td.cell-selected,
        .admin-table th.cell-selected {
            background-color: #bbdefb !important;
            outline: 2px solid #1976d2;
            outline-offset: -2px;
        }
        
        /* Selection styles */
        .admin-table td.selected-row,
        .admin-table th.selected-row {
            background-color: #e3f2fd !important;
            outline: 2px solid #2196f3;
            outline-offset: -2px;
        }
        
        .admin-table td.selected-col,
        .admin-table th.selected-col {
            background-color: #e8f5e9 !important;
            outline: 2px solid #4caf50;
            outline-offset: -2px;
        }
        
        .admin-table.selected-all td,
        .admin-table.selected-all th {
            background-color: #fff3e0 !important;
            outline: 2px solid #ff9800;
            outline-offset: -2px;
        }
        
        /* Merged cell indicator */
        .admin-table td.merged-cell,
        .admin-table th.merged-cell {
            background: linear-gradient(135deg, transparent 0%, transparent 95%, #1976d2 95%, #1976d2 100%);
        }
        
        /* Hidden cells (covered by merge) */
        .admin-table td.hidden-by-merge,
        .admin-table th.hidden-by-merge {
            display: none;
        }
        
        /* Resize overlay to capture mouse during drag */
        .table-resize-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 99999;
            cursor: col-resize;
        }
        
        .table-resize-overlay.row-resize {
            cursor: row-resize;
        }
        
        /* Selection overlay for drag selection */
        .table-selection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 99998;
            cursor: crosshair;
        }

        .admin-table td[contenteditable="true"],
        .admin-table th[contenteditable="true"] {
            outline: none;
            cursor: text;
        }

        .admin-table td[contenteditable="true"]:focus,
        .admin-table th[contenteditable="true"]:focus {
            box-shadow: inset 0 0 0 2px #007bff;
            background: #f8fbff !important;
        }

        .admin-table th {
            background: #e8e8e8;
            font-weight: 600;
        }

        .admin-table td.selected-cell,
        .admin-table th.selected-cell {
            outline: 3px solid #007bff;
            outline-offset: -3px;
        }

        /* Table Toolbar */
        .table-toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #ddd;
            align-items: center;
        }

        .table-toolbar-group {
            display: flex;
            gap: 5px;
            align-items: center;
            padding-right: 12px;
            border-right: 1px solid #ccc;
        }

        .table-toolbar-group:last-child {
            border-right: none;
        }

        .table-toolbar-group label {
            font-size: 0.75rem;
            color: #555;
            margin-right: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-toolbar button {
            padding: 7px 12px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .table-toolbar button:hover {
            background: #e7f5ff;
            border-color: #007bff;
            transform: translateY(-1px);
        }

        .table-toolbar button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .table-toolbar button.danger {
            color: #dc3545;
        }

        .table-toolbar button.danger:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        /* Pastel Color Palette */
        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 28px);
            gap: 5px;
        }

        .color-swatch {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .color-swatch:hover {
            transform: scale(1.15);
            border-color: #555;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .color-swatch.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }

        /* Color picker dropdown */
        .color-picker-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.18);
            z-index: 1002;
            display: none;
        }

        .color-picker-dropdown.visible {
            display: block;
        }

        .color-picker-dropdown h5 {
            margin: 0 0 10px 0;
            font-size: 0.8rem;
            color: #555;
            font-weight: 600;
        }

        /* Row/Column highlight on hover */
        .admin-table tr:hover td {
            background-color: rgba(0, 123, 255, 0.05);
        }

        /* Add Table Button */
        .add-block-btn.table-btn {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #81c784;
            color: #2e7d32;
        }

        .add-block-btn.table-btn:hover {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            border-color: #66bb6a;
        }

        .table-grid {
            display: grid;
            grid-template-columns: repeat(8, 24px);
            grid-template-rows: repeat(8, 24px);
            gap: 2px;
        }

        .table-grid-cell {
            width: 24px;
            height: 24px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.1s;
        }

        .table-grid-cell.selected {
            background: #AEC6CF;
            border-color: #8eb3be;
        }

        .table-grid-cell:hover {
            background: #d7eded;
        }

        .grid-size-label {
            text-align: center;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        /* Admin Table Editor */
        .admin-table-container {
            margin-top: 10px;
            overflow-x: auto;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Century Gothic', 'Poppins', sans-serif;
        }

        .admin-table td,
        .admin-table th {
            border: 1px solid #ccc;
            padding: 8px 12px;
            min-width: 80px;
            position: relative;
        }

        .admin-table td[contenteditable="true"],
        .admin-table th[contenteditable="true"] {
            outline: none;
        }

        .admin-table td[contenteditable="true"]:focus,
        .admin-table th[contenteditable="true"]:focus {
            box-shadow: inset 0 0 0 2px #007bff;
        }

        .admin-table th {
            background: #f0f0f0;
            font-weight: 600;
        }

        /* Table Toolbar */
        .table-toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            align-items: center;
        }

        .table-toolbar-group {
            display: flex;
            gap: 4px;
            align-items: center;
            padding-right: 10px;
            border-right: 1px solid #ddd;
        }

        .table-toolbar-group:last-child {
            border-right: none;
        }

        .table-toolbar-group label {
            font-size: 0.75rem;
            color: #666;
            margin-right: 5px;
        }

        .table-toolbar button {
            padding: 6px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .table-toolbar button:hover {
            background: #e7f5ff;
            border-color: #007bff;
        }

        .table-toolbar button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Pastel Color Palette */
        .color-palette {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            max-width: 200px;
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            border-color: #333;
        }

        .color-swatch.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }

        /* Row/Column Selection */
        .admin-table tr.row-selected td,
        .admin-table tr.row-selected th {
            outline: 2px solid #007bff;
            outline-offset: -2px;
        }

        .admin-table td.col-selected,
        .admin-table th.col-selected {
            outline: 2px solid #28a745;
            outline-offset: -2px;
        }

        /* Color picker dropdown */
        .color-picker-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 1001;
            display: none;
        }

        .color-picker-dropdown.visible {
            display: block;
        }

        .color-picker-dropdown h5 {
            margin: 0 0 8px 0;
            font-size: 0.8rem;
            color: #555;
        }

        /* --- PRINT STYLES --- */
        @media print {

            /* Hide all UI elements */
            .app-header,
            .sidebar,
            .controls,
            .admin-controls,
            .btn-worksheet-add,
            .worksheet-control-bar,
            .worksheet-actions,
            .print-btn,
            .next-btn,
            .submit-btn,
            .variable-label,
            .logout-btn,
            .mode-switcher,
            #tab-admin,
            #auth-overlay,
            .remove-btn-wrapper,
            .btn-worksheet-remove,
            .version-indicator {
                display: none !important;
            }

            /* Reset body */
            body {
                padding: 0 !important;
                background: white !important;
                margin: 0 !important;
                color: black !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Reset containers */
            .app-container,
            .app-body,
            #main-content-area {
                display: block !important;
                overflow: visible !important;
                height: auto !important;
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                position: static !important;
                background: white !important;
            }

            /* Hide all views by default */
            .view-content {
                display: none !important;
            }

            /* Show ONLY the worksheet view when printing worksheet */
            body.print-worksheet #view-worksheet {
                display: block !important;
                visibility: visible !important;
                padding: 20px !important;
            }

            body.print-worksheet #view-worksheet * {
                visibility: visible !important;
            }

            /* Worksheet summary page styles */
            #worksheet-summary-page {
                display: block !important;
                visibility: visible !important;
                page-break-after: always !important;
                break-after: page !important;
                margin-bottom: 2rem;
            }

            body.print-worksheet #worksheet-summary-page {
                display: block !important;
                visibility: visible !important;
            }

            #worksheet-summary-page table {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            #worksheet-summary-page th,
            #worksheet-summary-page td {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Hide worksheet header in non-print, show in print */
            #worksheet-header {
                display: none;
            }

            body.print-worksheet #worksheet-header {
                display: block !important;
                visibility: visible !important;
                margin-bottom: 2rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid #000;
            }

            /* Question container print styles */
            .worksheet-question-card {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                margin-bottom: 2rem !important;
                padding: 1.5rem !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                background: white !important;
            }

            .worksheet-question-card .question-number {
                background: #333 !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Answer box print styles */
            .answer-box {
                background: #f9f9f9 !important;
                border: 1px solid #ddd !important;
                padding: 1.5rem !important;
                margin-top: 1rem !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Answer input lines for handwriting */
            .answer-input {
                border: none !important;
                border-bottom: 1.5px solid #000 !important;
                background: transparent !important;
                min-width: 150px !important;
                height: 25px !important;
                padding: 0 !important;
                display: inline-block !important;
            }

            /* CER segments print */
            .cer-segment {
                border: 1px solid #ccc !important;
                margin-bottom: 1rem !important;
                padding: 1rem !important;
                background: white !important;
            }

            .cer-segment::after {
                background: white !important;
                color: #666 !important;
            }

            /* Table print styles */
            .results-table {
                width: 100% !important;
                border-collapse: collapse !important;
            }

            .results-table th {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .results-table th,
            .results-table td {
                border: 1px solid #333 !important;
                padding: 8px !important;
            }

            /* Images print */
            .question-diagram {
                max-width: 400px !important;
                page-break-inside: avoid !important;
            }

            /* MCQ print styles */
            .mcq-option {
                border: none !important;
                background: transparent !important;
                padding: 8px 0 !important;
                display: block !important;
                page-break-inside: avoid;
            }

            .mcq-option input {
                display: none !important;
            }

            .mcq-option span::before {
                content: " ";
                font-size: 1.2rem;
            }

            /* Hide empty placeholder */
            #worksheet-empty-msg {
                display: none !important;
            }

            /* Print all questions mode */
            body.print-all .view-content.active {
                display: block !important;
            }

            body.print-all .topic-content:not(.hidden) {
                display: block !important;
            }

            body.print-all .question-container {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                margin-bottom: 2rem !important;
                padding: 1.5rem !important;
                border: 1px solid #ddd !important;
            }

            /* Single question print */
            body.print-single .question-container:not(.printing) {
                display: none !important;
            }

            body.print-single .question-container.printing {
                display: block !important;
                break-inside: avoid !important;
            }
        }

        /* Save Worksheet Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-box {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.visible .modal-box {
            transform: translateY(0);
        }

        .modal-box h3 {
            margin: 0 0 1.5rem;
            color: var(--primary-blue);
            font-size: 1.4rem;
        }

        .modal-box .form-group {
            margin-bottom: 1.5rem;
        }

        .modal-box label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .modal-box input, .modal-box textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .modal-box input:focus, .modal-box textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .modal-box .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .modal-box .btn-cancel {
            background: #f5f5f5;
            color: #666;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .modal-box .btn-save {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .modal-box .btn-save:hover {
            background: #1565c0;
        }

        /* Saved Worksheet Card */
        .saved-worksheet-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #388e3c;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .saved-worksheet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .saved-worksheet-card h4 {
            margin: 0 0 0.5rem;
            color: #333;
            font-size: 1.2rem;
        }

        .saved-worksheet-card .meta {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .saved-worksheet-card .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Lesson Card */
        .lesson-card {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #f57c00;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .lesson-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .lesson-card h4 {
            margin: 0 0 0.5rem;
            color: #e65100;
            font-size: 1.3rem;
        }

        .lesson-card .meta {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .lesson-card .description {
            color: #444;
            font-size: 0.95rem;
        }

        .lesson-card .badge {
            display: inline-block;
            background: #f57c00;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        /* Lesson Detail */
        .lesson-video-container {
            margin-bottom: 2rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .lesson-video-container iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .lesson-questions-section {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .lesson-questions-section h3 {
            margin: 0 0 1.5rem;
            color: #333;
        }

        .scroll-buttons-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            justify-content: flex-end;
        }

        .scroll-btn {
            background: #f57c00;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .scroll-btn:hover {
            background: #e65100;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(245, 124, 0, 0.3);
        }

        .scroll-btn:active {
            transform: translateY(0);
        }

        /* Student Entry Styles */
        .student-entry {
            transition: all 0.3s ease;
        }

        .add-student-btn:hover {
            background: #bbdefb !important;
        }

        /* Practice Mode Styles */
        #practice-question-content .question-container {
            margin-bottom: 0;
            box-shadow: none;
            border: none;
            padding: 0;
        }

        #practice-question-content .mcq-option,
        #practice-question-content label {
            transition: all 0.2s ease;
        }

        .practice-progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .practice-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7b1fa2, #9c27b0);
            transition: width 0.3s ease;
        }

        /* Inbox Badge */
        .inbox-badge {
            background: #dc3545;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: bold;
        }

        /* Header Icons (Inbox, Settings) */
        .header-icons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-icon-btn {
            position: relative;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid #e0e0e0;
            background: white;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-icon-btn:hover {
            background: #e3f2fd;
            border-color: #1976d2;
            transform: scale(1.05);
        }

        .header-icon-btn.active {
            background: #e3f2fd;
            border-color: #1976d2;
        }

        .header-icon-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            font-size: 0.65rem;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
        }

        /* Inbox Tabs */
        .inbox-tab {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .inbox-tab:hover {
            border-color: #0288d1;
        }

        .inbox-tab.active {
            background: #0288d1;
            color: white;
            border-color: #0288d1;
        }

        /* Message Card */
        .message-card {
            background: white;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #0288d1;
        }

        .message-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .message-card.unread {
            background: #e3f2fd;
            border-left-color: #f57c00;
        }

        .message-card .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .message-card .message-from {
            font-weight: 600;
            color: #333;
        }

        .message-card .message-date {
            font-size: 0.8rem;
            color: #888;
        }

        .message-card .message-subject {
            font-weight: 600;
            color: #0288d1;
            margin-bottom: 0.3rem;
        }

        .message-card .message-preview {
            color: #666;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .message-card .unread-dot {
            width: 10px;
            height: 10px;
            background: #f57c00;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        /* Inbox Empty State */
        .inbox-empty {
            text-align: center;
            padding: 3rem;
            color: #888;
        }

        /* Consult Button */
        .consult-btn {
            background: linear-gradient(135deg, #0288d1, #03a9f4);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .consult-btn:hover {
            background: linear-gradient(135deg, #0277bd, #0288d1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(2, 136, 209, 0.3);
        }

        .print-question-btn {
            background: linear-gradient(135deg, #5c6bc0, #7986cb);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .print-question-btn:hover {
            background: linear-gradient(135deg, #3f51b5, #5c6bc0);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(92, 107, 192, 0.3);
        }

        /* Flag Question Button */
        .flag-question-btn {
            background: linear-gradient(135deg, #ff9800, #ffc107);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .flag-question-btn:hover {
            background: linear-gradient(135deg, #f57c00, #ff9800);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }

        .flag-question-btn.flagged {
            background: linear-gradient(135deg, #f44336, #e91e63);
        }

        .flag-question-btn.flagged:hover {
            background: linear-gradient(135deg, #d32f2f, #c2185b);
        }

        /* Flag Modal */
        .flag-modal-content {
            max-width: 450px;
        }

        .flag-modal-content h3 {
            color: #ff9800;
            margin-bottom: 1rem;
        }

        .flag-modal-content textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .flag-modal-content textarea:focus {
            border-color: #ff9800;
            outline: none;
        }

        .flag-question-preview {
            background: #fff3e0;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #ff9800;
            font-size: 0.9rem;
        }

        /* Flagged Questions View */
        .flagged-question-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #ff9800;
        }

        .flagged-question-card.resolved {
            border-left-color: #4CAF50;
            opacity: 0.7;
        }

        .flagged-question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .flagged-question-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .flagged-question-meta {
            font-size: 0.8rem;
            color: #888;
        }

        .flagged-question-comment {
            background: #f5f5f5;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-style: italic;
            color: #555;
        }

        .flagged-question-comment::before {
            content: '"';
            font-size: 1.5rem;
            color: #ff9800;
            margin-right: 5px;
        }

        .flagged-question-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .flagged-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .flagged-status-badge.pending {
            background: #fff3e0;
            color: #e65100;
        }

        .flagged-status-badge.resolved {
            background: #e8f5e9;
            color: #2e7d32;
        }

        /* Ratings Dashboard Table */
        #ratings-table-body tr:hover {
            background-color: #f3e5f5 !important;
        }

        #ratings-table-body tr:hover td {
            color: #7b1fa2;
        }

        #ratings-table-body tr:hover td span[style*="underline"] {
            color: #4a148c;
        }

        /* Activity Dashboard Table */
        #activity-table-body tr:hover {
            background-color: #e3f2fd !important;
        }

        #activity-table-body tr:hover td {
            color: #1565c0;
        }

        /* Welcome Back Modal Animation */
        #welcome-back-modal .modal-box {
            animation: welcomeBounce 0.5s ease-out;
        }

        @keyframes welcomeBounce {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        #new-questions-info {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(76, 175, 80, 0.2); }
        }

        /* View Message Modal Content */
        .view-message-header {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .view-message-body {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 8px;
            min-height: 100px;
            white-space: pre-wrap;
        }

        .view-message-question {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #0288d1;
            font-size: 0.9rem;
        }

        /* =====================================================
           MOBILE MENU TOGGLE BUTTON
           ===================================================== */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1976d2, #2196f3);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .mobile-menu-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5);
        }

        .mobile-menu-toggle.active {
            background: linear-gradient(135deg, #d32f2f, #f44336);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* =====================================================
           TABLET STYLES (768px - 1024px)
           ===================================================== */
        @media screen and (max-width: 1024px) {
            body {
                padding: 1rem;
            }

            .app-container {
                max-width: 100%;
            }

            .sidebar {
                width: 220px;
                padding: 1.5rem;
            }

            .main-content,
            .view-content,
            .topic-content {
                padding: 1.5rem 2rem;
            }

            .tab-btn {
                padding: 0.4rem 0.7rem;
                font-size: 0.75rem;
            }

            .app-logo {
                height: 40px;
            }

            .question-container {
                padding: 1.25rem;
                margin-bottom: 2rem;
            }

            .answer-box {
                padding: 1.5rem;
            }

            .modal-box {
                width: 95%;
                max-width: 600px;
                padding: 1.5rem;
            }
        }

        /* =====================================================
           MOBILE STYLES (max-width: 768px)
           ===================================================== */
        @media screen and (max-width: 768px) {
            body {
                padding: 0;
                align-items: stretch;
            }

            .app-container {
                border-radius: 0;
                box-shadow: none;
                min-height: 100vh;
            }

            /* Header icons on mobile */
            .header-icons {
                gap: 5px;
            }

            .header-icon-btn {
                width: 38px;
                height: 38px;
                font-size: 1.1rem;
            }

            .header-icon-badge {
                top: -4px;
                right: -4px;
                min-width: 16px;
                height: 16px;
                font-size: 0.6rem;
            }

            /* Show mobile menu toggle */
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .sidebar-overlay {
                display: block;
                pointer-events: none;
            }

            .sidebar-overlay.active {
                pointer-events: auto;
            }
            
            /* Ensure sidebar is always above overlay and clickable */
            .app-body > .sidebar.mobile-open {
                pointer-events: auto !important;
            }
            

            /* Sidebar - slide in from left */
            .app-body > .sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                width: 280px;
                height: 100vh;
                z-index: 10000;
                padding: 1.5rem;
                padding-top: 2rem;
                overflow-y: auto;
                transition: left 0.3s ease;
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
                pointer-events: auto;
                background: white;
            }

            .app-body > .sidebar.mobile-open {
                left: 0;
                pointer-events: auto;
            }

            /* Ensure all interactive elements in sidebar are clickable */
            .app-body > .sidebar.mobile-open button,
            .app-body > .sidebar.mobile-open a,
            .app-body > .sidebar.mobile-open input,
            .app-body > .sidebar.mobile-open select,
            .app-body > .sidebar.mobile-open .ios-toggle,
            .app-body > .sidebar.mobile-open .exam-mode-toggle,
            .app-body > .sidebar.mobile-open .ios-toggle-track,
            .app-body > .sidebar.mobile-open .ios-toggle-thumb,
            .app-body > .sidebar.mobile-open .exam-mode-track,
            .app-body > .sidebar.mobile-open .exam-mode-thumb {
                pointer-events: auto !important;
                position: relative;
                z-index: 10001;
            }

            /* Show close button in mobile sidebar */
            .app-body > .sidebar .mobile-sidebar-close {
                display: block !important;
                z-index: 10001;
                pointer-events: auto !important;
            }

            /* Header adjustments */
            .app-header {
                padding: 0.5rem 0.75rem 0;
            }

            .app-logo {
                height: 35px;
            }

            #header-tabs-container {
                overflow-x: auto;
                overflow-y: hidden;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                padding-bottom: 2px;
            }

            #header-tabs-container::-webkit-scrollbar {
                display: none;
            }

            /* Level selector mobile */
            .header-tabs-row {
                flex-wrap: nowrap;
            }

            .level-selector-container {
                padding: 4px 8px 6px 8px;
                border-radius: 10px 10px 0 0;
            }

            .level-selector-label {
                font-size: 0.7rem;
                margin-right: 4px;
            }

            .level-selector-badge {
                font-size: 0.5rem;
                padding: 1px 4px;
                top: -6px;
                right: -3px;
            }

            .level-select {
                padding: 0.3rem 1.4rem 0.3rem 0.5rem;
                font-size: 0.8rem;
                min-width: 50px;
                border-radius: 6px;
            }

            .tab-btn {
                padding: 0.35rem 0.6rem;
                font-size: 0.7rem;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Main content area */
            .app-body {
                flex-direction: column;
            }

            .main-content,
            .view-content,
            .topic-content {
                padding: 1rem;
            }

            /* Question container */
            .question-container {
                padding: 1rem;
                margin-bottom: 1.5rem;
                border-radius: 10px;
            }

            .question-container h3 {
                font-size: 1rem;
            }

            .main-content p,
            .question-container p {
                font-size: 0.95rem;
                line-height: 1.6;
            }

            /* Answer box */
            .answer-box {
                padding: 1rem;
                border-radius: 10px;
            }

            .answer-template {
                font-size: 0.95rem;
                line-height: 1.8;
            }

            .answer-input {
                font-size: 0.95rem;
                min-width: 60px;
            }

            /* Buttons */
            .btn, .submit-btn, .next-btn {
                padding: 12px 20px;
                font-size: 0.95rem;
                min-height: 44px;
            }

            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .controls button {
                width: 100%;
            }

            /* Worksheet control bar */
            .worksheet-control-bar {
                flex-direction: column;
                gap: 8px;
            }

            .worksheet-control-bar button {
                width: 100%;
            }

            /* MCQ Options */
            .mcq-option, .mcq-container label {
                padding: 12px 15px;
                font-size: 0.95rem;
                min-height: 48px;
            }

            /* Tables - horizontal scroll */
            .results-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .results-table th,
            .results-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
                white-space: nowrap;
            }

            /* Images */
            .question-diagram {
                max-width: 100%;
            }

            /* Modal - full screen on mobile */
            .modal-overlay {
                padding: 0;
            }

            .modal-box {
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
                padding: 1rem;
                overflow-y: auto;
            }

            .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .modal-buttons button {
                width: 100%;
            }

            /* Auth box */
            .auth-box {
                width: 95%;
                padding: 1.5rem;
                border-radius: 16px;
            }

            .auth-input {
                padding: 14px 16px;
                font-size: 1rem;
            }

            .auth-btn {
                padding: 14px;
                font-size: 1rem;
            }

            /* Sidebar buttons */
            .sidebar button,
            .sidebar-nav button {
                padding: 12px 16px;
                font-size: 0.95rem;
            }

            /* Sidebar topic badges on mobile */
            .sidebar-topic-badge {
                min-width: 22px;
                height: 22px;
                font-size: 0.7rem;
                padding: 0 6px;
            }

            /* Tab count badges on mobile */
            .tab-count-badge {
                min-width: 18px;
                height: 18px;
                font-size: 0.65rem;
                padding: 0 5px;
                margin-left: 4px;
            }

            /* Practice mode stats */
            #practice-stats {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Inbox */
            .message-card {
                padding: 1rem;
            }

            .message-header {
                flex-direction: column;
                gap: 5px;
            }

            .inbox-tab {
                padding: 8px 16px;
                font-size: 0.9rem;
            }

            /* Consult, Print, and Flag buttons on mobile */
            .consult-btn,
            .print-question-btn,
            .flag-question-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }

            /* Admin form */
            .admin-form-section {
                padding: 1rem;
            }

            .admin-form-section input,
            .admin-form-section select,
            .admin-form-section textarea {
                font-size: 1rem;
            }

            /* Lesson cards */
            .lesson-card {
                padding: 1rem;
            }

            .lesson-video-container iframe {
                height: 250px;
            }

            /* Login days display */
            #login-days-display {
                font-size: 0.9rem;
                padding: 8px;
            }

            /* iOS Toggle mobile */
            .ios-toggle-container {
                padding: 10px;
                border-radius: 12px;
            }

            .ios-toggle-label {
                font-size: 0.85rem;
                min-width: 30px;
            }

            .ios-toggle {
                width: 52px;
                height: 28px;
            }

            .ios-toggle-thumb {
                width: 24px;
                height: 24px;
            }

            .ios-toggle.mcq-active .ios-toggle-thumb {
                left: 26px;
            }

            /* Exam Mode Toggle mobile */
            .exam-mode-toggle-container {
                padding: 8px;
                gap: 6px;
            }

            .exam-mode-label {
                font-size: 0.7rem;
                min-width: 40px;
            }

            .exam-mode-toggle {
                width: 44px;
                height: 22px;
            }

            .exam-mode-thumb {
                width: 18px;
                height: 18px;
            }

            .exam-mode-toggle-container.exam-active .exam-mode-thumb {
                left: 24px;
            }

            /* Sidebar sections on mobile */
            .sidebar-nav-btn {
                padding: 10px 12px;
                font-size: 0.85rem;
            }

            .sidebar-divider {
                margin: 12px 0;
            }

            /* Text formatting toolbar on mobile */
            .text-formatting-toolbar {
                padding: 6px;
                gap: 3px;
            }

            .toolbar-group {
                padding: 0 4px;
            }

            .format-btn {
                width: 30px;
                height: 30px;
                font-size: 0.8rem;
            }

            .list-type-select {
                height: 30px;
                font-size: 0.7rem;
                padding: 0 4px;
            }

            .rich-text-editor {
                min-height: 100px;
                padding: 10px;
                font-size: 0.95rem;
            }

            /* Saved worksheets */
            .saved-worksheet-card .actions {
                flex-direction: column;
            }

            .saved-worksheet-card .actions button {
                width: 100%;
            }

            /* Explanation box */
            .explanation-box {
                padding: 1rem;
                font-size: 0.9rem;
            }

            /* CER segments */
            .cer-segment {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .segment-title {
                font-size: 0.95rem;
            }

            /* OEQ Sidebar Content */
            #oeq-sidebar-content h2,
            #mcq-sidebar-content h2 {
                font-size: 1.1rem;
            }

            /* Student entry in registration */
            .student-entry > div {
                flex-direction: column !important;
            }

            .student-entry .auth-input {
                width: 100% !important;
            }

            /* Version indicator */
            .version-indicator {
                font-size: 0.6rem;
                padding: 2px 6px;
            }
        }

        /* =====================================================
           SMALL MOBILE STYLES (max-width: 480px)
           ===================================================== */
        @media screen and (max-width: 480px) {
            .tab-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.65rem;
            }

            .app-logo {
                height: 30px;
            }

            .question-container {
                padding: 0.75rem;
            }

            .answer-box {
                padding: 0.75rem;
            }

            .answer-template {
                font-size: 0.9rem;
            }

            .answer-input {
                font-size: 0.9rem;
                min-width: 50px;
            }

            #practice-stats {
                grid-template-columns: 1fr 1fr !important;
                gap: 0.5rem;
            }

            #practice-stats > div {
                padding: 0.75rem;
            }

            #practice-stats > div > div:first-child {
                font-size: 1.5rem;
            }

            .modal-box {
                padding: 0.75rem;
            }

            .modal-box h3 {
                font-size: 1.1rem;
            }

            .auth-box {
                padding: 1rem;
            }

            .auth-logo {
                width: 60px;
                height: 60px;
            }

            .auth-title {
                font-size: 1.3rem;
            }

            .legal-check label {
                font-size: 0.75rem;
            }
        }

        /* =====================================================
           LANDSCAPE ORIENTATION FIXES
           ===================================================== */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .modal-box {
                max-height: 95vh;
                overflow-y: auto;
            }

            .auth-box {
                max-height: 95vh;
                overflow-y: auto;
            }
        }

        /* =====================================================
           IPAD SPECIFIC STYLES
           ===================================================== */
        @media screen and (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            .sidebar {
                width: 200px;
            }

            .main-content,
            .view-content,
            .topic-content {
                padding: 1.5rem;
            }

            #practice-stats {
                grid-template-columns: repeat(4, 1fr) !important;
            }
        }

        @media screen and (min-width: 1024px) and (max-width: 1366px) and (orientation: landscape) {
            /* iPad Pro landscape */
            .sidebar {
                width: 230px;
            }
        }

        /* =====================================================
           TOUCH DEVICE OPTIMIZATIONS
           ===================================================== */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            .btn, button, .tab-btn, .sidebar-nav button {
                min-height: 44px;
            }

            .mcq-option, .mcq-container label {
                min-height: 48px;
            }

            /* Remove hover effects that don't work well on touch */
            .tab-btn:hover,
            .sidebar-nav button:hover,
            .btn:hover {
                transform: none;
            }

            /* Better tap feedback */
            .btn:active, button:active {
                transform: scale(0.98);
                opacity: 0.9;
            }

            /* Prevent text selection on buttons */
            button, .btn, .tab-btn {
                -webkit-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
            }

            /* Improve scrolling */
            .main-content, .view-content, .topic-content {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* =====================================================
           SAFE AREA INSETS (for notched devices)
           ===================================================== */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }

            .mobile-menu-toggle {
                bottom: max(20px, calc(env(safe-area-inset-bottom) + 10px));
                right: max(20px, calc(env(safe-area-inset-right) + 10px));
            }

            .app-body > .sidebar {
                padding-bottom: max(1.5rem, calc(env(safe-area-inset-bottom) + 1rem));
            }
        }

        /* =====================================================
           ADDITIONAL MOBILE FIXES
           ===================================================== */
        @media screen and (max-width: 768px) {
            /* Fix for iOS input zoom */
            input, select, textarea {
                font-size: 16px !important;
            }

            /* Ensure forms don't overflow */
            .form-group input,
            .form-group select,
            .form-group textarea,
            .auth-input {
                max-width: 100%;
                box-sizing: border-box;
            }

            /* Fix horizontal scroll issues */
            html, body {
                overflow-x: hidden;
                width: 100%;
            }

            .app-container {
                overflow-x: hidden;
            }

            /* Better table display on mobile */
            table {
                font-size: 0.85rem;
            }

            /* Improve question text readability */
            .question-container p {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            /* Fix image overflow */
            img {
                max-width: 100%;
                height: auto;
            }

            /* Admin controls layout */
            .admin-controls {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .admin-controls button {
                flex: 1 1 auto;
                min-width: 100px;
            }

            /* OEQ segment inputs */
            .segment-input, .cer-textarea {
                font-size: 16px;
                min-height: 80px;
            }

            /* Topic buttons in sidebar */
            #oeq-sidebar-content .topic-link,
            #mcq-sidebar-content .topic-link {
                padding: 12px;
                font-size: 0.9rem;
            }

            /* Header tabs scrollable indicator */
            #header-tabs-container::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to right, transparent, #f8f9fa);
                pointer-events: none;
            }

            /* Question popup modal fix */
            #question-popup-modal .modal-box {
                max-height: calc(100vh - 20px);
            }

            /* Consult modal fix */
            #consult-modal .modal-box,
            #new-message-modal .modal-box,
            #view-message-modal .modal-box {
                max-height: calc(100vh - 20px);
                overflow-y: auto;
            }
        }

        /* =====================================================
           IPAD PRO AND LARGE TABLET STYLES
           ===================================================== */
        @media screen and (min-width: 1024px) and (max-width: 1400px) {
            .sidebar {
                width: 240px;
            }

            .main-content,
            .view-content,
            .topic-content {
                padding: 2rem;
            }

            .tab-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.78rem;
            }
        }

        /* =====================================================
           PREVENT PULL-TO-REFRESH ON MOBILE
           ===================================================== */
        body {
            overscroll-behavior-y: contain;
        }

        /* =====================================================
           FIX FOR 100VH ON MOBILE BROWSERS
           ===================================================== */
        @media screen and (max-width: 768px) {
            .modal-overlay {
                height: 100%;
                height: -webkit-fill-available;
            }

            .auth-overlay {
                min-height: 100%;
                min-height: -webkit-fill-available;
            }
        }

        /* =====================================================
           PRINT STYLES - HIDE MOBILE ELEMENTS
           ===================================================== */
        @media print {
            .mobile-menu-toggle,
            .sidebar-overlay {
                display: none !important;
            }
        }
    </style>
</head>

<body>

    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" onclick="toggleMobileSidebar()">
        <span id="mobile-menu-icon"></span>
    </button>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeMobileSidebar()" style="display: none;"></div>

    <!-- Version Indicator for debugging -->
    <div class="version-indicator" id="version-display"></div>

    <!-- Auth Overlay -->
    <div id="auth-overlay">
        <div class="auth-box">
            <img src="https://www.dropbox.com/scl/fi/h40yjlyg8ldefwfaa3dib/polymath-logo-sticker.png?rlkey=o1ra4taqy79gt9t8u096v82zj&raw=1"
                alt="Polymath Logo" class="auth-logo">
            <h2 id="auth-title" class="auth-title">Welcome Back!</h2>
            <p class="auth-subtitle" id="auth-subtitle">Sign in to continue your learning journey</p>

            <div class="error-msg" id="auth-error"></div>

            <input type="email" id="auth-email" class="auth-input" placeholder="Email Address">
            <input type="password" id="auth-pass" class="auth-input" placeholder="Password">
            
            <!-- Password Confirmation (Registration only) -->
            <input type="password" id="auth-pass-confirm" class="auth-input" placeholder="Confirm Password" style="display: none;">

            <div id="forgot-password-link" style="text-align: right; margin-bottom: 20px; margin-top: -10px;">
                <span class="toggle-link" onclick="handleForgotPassword()" style="font-size: 0.85rem;">Forgot
                    Password?</span>
            </div>

            <!-- Registration Fields (Hidden by default) -->
            <div id="reg-fields" style="display: none;">
                <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #1976d2;">
                    <div style="font-weight: 600; color: #1565c0; margin-bottom: 5px;"> Parent & Student Information</div>
                    <div style="font-size: 0.85rem; color: #666;">Please provide details for each student</div>
                </div>
                
                <input type="text" id="parent-name" class="auth-input" placeholder="Parent's Name">
                
                <div id="students-container">
                    <div class="student-entry" data-student-index="0">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" class="auth-input student-name" placeholder="Student's Name" style="flex: 1; margin-bottom: 0;">
                            <select class="auth-input student-level" style="width: 100px; margin-bottom: 0;">
                                <option value="">Level</option>
                                <option value="P3">P3</option>
                                <option value="P4">P4</option>
                                <option value="P5">P5</option>
                                <option value="P6">P6</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button type="button" onclick="addStudentEntry()" class="add-student-btn" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #e3f2fd; border: 2px dashed #1976d2; border-radius: 8px; color: #1976d2; font-weight: 600; cursor: pointer;">
                     Add Another Student
                </button>
            </div>

            <div id="legal-box" class="legal-check" style="display: none;">
                <input type="checkbox" id="legal-agree">
                <label for="legal-agree" style="font-size: 0.85rem; line-height: 1.4;">
                    By registering, logging in, and using this system, I confirm that I am a parent/guardian and agree to be liable for the tuition fees of the current month or whichever period is applicable. I acknowledge that Polymath Learning Centre reserves the right to change any aspect of this system at any time and may remove access to any student without prior notice at any time.
                </label>
            </div>

            <button onclick="handleLogin()" id="btn-login" class="auth-btn btn-primary">Login</button>
            <button onclick="handleGoogleLogin()" id="btn-google" class="auth-btn btn-google">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Sign in with
                Google
            </button>

            <span class="toggle-link" onclick="toggleAuthMode()">New here? Create an Account</span>
        </div>
    </div>
    
    <!-- First-time Google User Student Setup Modal -->
    <div id="google-setup-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 500px;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 3rem; margin-bottom: 0.5rem;"></div>
                <h3 style="color: #1976d2; margin: 0;">Welcome to Polymath!</h3>
                <p style="color: #666; margin-top: 0.5rem;">Let's set up your account</p>
            </div>
            
            <div class="error-msg" id="google-setup-error"></div>
            
            <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #1976d2;">
                <div style="font-weight: 600; color: #1565c0; margin-bottom: 5px;"> Student Information Required</div>
                <div style="font-size: 0.85rem; color: #666;">Please tell us about the student(s) using this account</div>
            </div>
            
            <div class="form-group">
                <label style="font-weight: 600; color: #333;">Parent's Name *</label>
                <input type="text" id="google-parent-name" class="auth-input" placeholder="Enter parent's name" style="margin-top: 5px;">
            </div>
            
            <div id="google-students-container">
                <label style="font-weight: 600; color: #333; display: block; margin-bottom: 10px;">Student(s) *</label>
                <div class="google-student-entry" data-student-index="0">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" class="auth-input google-student-name" placeholder="Student's Name" style="flex: 1; margin-bottom: 0;">
                        <select class="auth-input google-student-level" style="width: 100px; margin-bottom: 0;">
                            <option value="">Level</option>
                            <option value="P3">P3</option>
                            <option value="P4">P4</option>
                            <option value="P5">P5</option>
                            <option value="P6">P6</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <button type="button" onclick="addGoogleStudentEntry()" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #e3f2fd; border: 2px dashed #1976d2; border-radius: 8px; color: #1976d2; font-weight: 600; cursor: pointer;">
                 Add Another Student
            </button>
            
            <div class="legal-check" style="margin-bottom: 1rem;">
                <input type="checkbox" id="google-legal-agree">
                <label for="google-legal-agree" style="font-size: 0.85rem; line-height: 1.4;">
                    By registering, I confirm that I am a parent/guardian and agree to be liable for the tuition fees. I acknowledge that Polymath Learning Centre reserves the right to change any aspect of this system at any time.
                </label>
            </div>
            
            <button onclick="completeGoogleSetup()" class="btn-save" style="width: 100%; padding: 12px; font-size: 1rem;">
                 Complete Setup
            </button>
        </div>
    </div>

    <div class="app-container">
        <header class="app-header">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.3rem;">
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                    <img src="https://www.dropbox.com/scl/fi/h40yjlyg8ldefwfaa3dib/polymath-logo-sticker.png?rlkey=o1ra4taqy79gt9t8u096v82zj&raw=1"
                        alt="Polymath Logo" class="app-logo">
                    <button class="print-btn tooltip-container" onclick="printAll()" data-tooltip="Print the current page or worksheet"> Print All</button>
                </div>
                <div class="header-icons">
                    <button class="header-icon-btn tooltip-container hidden" onclick="switchTab('flagged', this)" data-tooltip="View questions that have been flagged for review (Admin only)" id="header-flagged-btn">
                        
                        <span id="header-flagged-badge" class="header-icon-badge" style="display: none;">0</span>
                    </button>
                    <button class="header-icon-btn tooltip-container" onclick="switchTab('inbox', this)" data-tooltip="View messages and notifications from teachers" id="header-inbox-btn">
                        
                        <span id="header-inbox-badge" class="header-icon-badge" style="display: none;">0</span>
                    </button>
                    <button class="header-icon-btn tooltip-container" onclick="showAccountSettings()" data-tooltip="Access account settings and preferences" id="header-settings-btn">
                        
                    </button>
                    <button class="tutorial-help-btn tooltip-container" onclick="startTutorial()" data-tooltip="Click to view a comprehensive tutorial covering all features of the app" id="header-tutorial-btn" style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-blue); color: white; border: none; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3); transition: all 0.3s;">
                        ?
                    </button>
                </div>
            </div>
            
            <!-- Horizontal Tab Groups - Practice, Progress, Learn -->
            <div class="main-nav-groups" style="display: flex; align-items: center; gap: 32px; padding: 8px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 8px;">
                <div class="nav-group" data-group="practice" style="position: relative;">
                    <button class="nav-group-btn" style="background: none; border: none; font-size: 14px; font-weight: 600; color: var(--main-text); cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 6px;">
                        Practice
                        <span class="nav-arrow" style="font-size: 10px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);"></span>
                    </button>
                    <div class="nav-dropdown" id="practice-dropdown" style="position: absolute; top: calc(100% + 4px); left: 0; background: white; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); padding: 8px; min-width: 220px; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000;">
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('practice', this)" data-tooltip="Practice mode - work through questions at your own pace" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; gap: 10px;">
                            <span></span> Practice Mode
                        </button>
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('worksheet', this)" data-tooltip="My Worksheet - view and manage your practice questions" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; justify-content: space-between;">
                            <span style="display: flex; align-items: center; gap: 10px;"><span></span> My Worksheet</span>
                            <span id="worksheet-count-header" style="background: var(--primary-blue); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">0</span>
                        </button>
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('saved-worksheets', this)" data-tooltip="Access your previously saved worksheets" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; gap: 10px;">
                            <span></span> Saved Worksheets
                        </button>
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('question-list', this)" data-tooltip="Question Library - browse and search all available questions" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; gap: 10px;">
                            <span></span> Question Library
                        </button>
                    </div>
                </div>
                
                <div class="nav-group" data-group="progress" style="position: relative;">
                    <button class="nav-group-btn" style="background: none; border: none; font-size: 14px; font-weight: 600; color: var(--main-text); cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 6px;">
                        Progress
                        <span class="nav-arrow" style="font-size: 10px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);"></span>
                    </button>
                    <div class="nav-dropdown" id="progress-dropdown" style="position: absolute; top: calc(100% + 4px); left: 0; background: white; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); padding: 8px; min-width: 200px; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000;">
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('my-progress', this)" data-tooltip="View your learning progress and mastery statistics" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; gap: 10px;">
                            <span></span> My Progress
                        </button>
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('leaderboard', this)" data-tooltip="See how you rank among other students" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; gap: 10px;">
                            <span></span> Leaderboard
                        </button>
                    </div>
                </div>
                
                <div class="nav-group" data-group="learn" style="position: relative;">
                    <button class="nav-group-btn" style="background: none; border: none; font-size: 14px; font-weight: 600; color: var(--main-text); cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 6px;">
                        Learn
                        <span class="nav-arrow" style="font-size: 10px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);"></span>
                    </button>
                    <div class="nav-dropdown" id="learn-dropdown" style="position: absolute; top: calc(100% + 4px); left: 0; background: white; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); padding: 8px; min-width: 180px; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000;">
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('lessons', this)" data-tooltip="Watch video lessons and complete practice questions" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; gap: 10px;">
                            <span></span> Lessons
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="header-tabs-row">
                <div class="level-selector-container tooltip-container" id="header-level-selector" data-tooltip="Select your grade level to see questions appropriate for your class">
                    <span class="level-selector-label"> Level</span>
                    <select id="header-level-select" class="level-select" onchange="changeLevel(this.value)">
                        <option value="P3">P3</option>
                        <option value="P4">P4</option>
                        <option value="P5">P5</option>
                        <option value="P6" selected>P6</option>
                    </select>
                    <span class="level-selector-badge">Grade</span>
                </div>
                <div id="header-tabs-container">
                    <button class="tab-btn active" data-type="cer" onclick="switchTab('cer', this)">CER</button><button class="tab-btn" data-type="definition"
                        onclick="switchTab('definition', this)">Definition</button><button class="tab-btn" data-type="single-relationship"
                        onclick="switchTab('single-relationship', this)">Single Relationship</button><button class="tab-btn" data-type="double-relationship"
                        onclick="switchTab('double-relationship', this)">Double Relationship</button><button class="tab-btn" data-type="fairness" onclick="switchTab('fairness', this)">Fairness</button><button class="tab-btn" data-type="reliability"
                        onclick="switchTab('reliability', this)">Reliability</button><button class="tab-btn" data-type="accuracy" onclick="switchTab('accuracy', this)">Accuracy</button><button class="tab-btn" data-type="constant-variable"
                        onclick="switchTab('constant-variable', this)">Constant Variable</button><button class="tab-btn" data-type="explanation"
                        onclick="switchTab('explanation', this)">Explanation</button><button class="tab-btn" data-type="control-setup" onclick="switchTab('control-setup', this)">Control Set-up</button>
                </div>
            </div>
        </header>
        
        <!-- Colored line that changes based on active tab -->
        <div class="header-color-line" id="header-color-line" style="background: linear-gradient(90deg, #AEC6CF 0%, #c4d6dd 50%, #AEC6CF 100%);"></div>

        <!-- Save Worksheet Modal -->
        <div id="save-worksheet-modal" class="modal-overlay">
            <div class="modal-box">
                <h3 id="save-worksheet-modal-title"> Save Worksheet</h3>
                <div class="form-group">
                    <label for="worksheet-name-input">Worksheet Name *</label>
                    <input type="text" id="worksheet-name-input" placeholder="e.g., Heat Chapter Review">
                </div>
                <div class="form-group">
                    <label for="worksheet-description-input">Description (optional)</label>
                    <textarea id="worksheet-description-input" rows="2" placeholder="Brief description of this worksheet..."></textarea>
                </div>
                <div id="admin-lesson-fields" class="hidden">
                    <div class="form-group">
                        <label for="lesson-video-input"> Video Link (Dropbox)</label>
                        <input type="text" id="lesson-video-input" placeholder="https://www.dropbox.com/...">
                        <small style="color: #888; font-size: 0.8rem;">Optional: Dropbox video link for this lesson</small>
                    </div>
                    <div class="form-group" style="background: #fff3e0; padding: 10px; border-radius: 8px; border-left: 4px solid #f57c00;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="share-as-lesson-checkbox" style="width: auto; margin: 0;">
                            <span> Share as Lesson (visible to all students)</span>
                        </label>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="hideSaveWorksheetModal()">Cancel</button>
                    <button class="btn-save" onclick="saveWorksheet()">Save</button>
                </div>
            </div>
        </div>

        <div class="app-body active" style="display: flex;">
            <aside class="sidebar">
                <button class="mobile-sidebar-close" onclick="closeMobileSidebar()" style="display: none; position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.2rem; cursor: pointer; z-index: 10;"></button>
                
                <!-- TOP SECTION: Streak, Practice, Toggle -->
                <div class="sidebar-top-section">
                    <div id="login-days-display"> Loading Streak...</div>
                    
                    <!-- Animated Practice Mode Button -->
                    <button id="btn-sidebar-practice" class="practice-btn-animated tooltip-container" onclick="switchTab('practice', this)" data-tooltip="Enter practice mode to work through questions at your own pace">
                        <span class="practice-btn-icon"></span>
                        <span class="practice-btn-text">Practice Mode</span>
                        <span class="practice-btn-sparkle"></span>
                    </button>
                    
                    <!-- iOS-style OEQ/MCQ Toggle -->
                    <div class="ios-toggle-container">
                        <span class="ios-toggle-label">OEQ</span>
                        <div class="ios-toggle tooltip-container" id="mode-toggle" onclick="toggleMode()" data-tooltip="Switch between OEQ (Open-Ended Questions) and MCQ (Multiple Choice Questions) modes">
                            <div class="ios-toggle-track">
                                <div class="ios-toggle-thumb" id="toggle-thumb"></div>
                            </div>
                        </div>
                        <span class="ios-toggle-label">MCQ</span>
                    </div>
                    
                    <!-- Exam Mode Toggle (Monochrome) -->
                    <div class="exam-mode-toggle-container" title="Exam Mode: Shows questions in black & white like actual exams">
                        <span class="exam-mode-label"> Colour</span>
                        <div class="exam-mode-toggle" id="exam-mode-toggle" onclick="toggleExamMode()">
                            <div class="exam-mode-track">
                                <div class="exam-mode-thumb"></div>
                            </div>
                        </div>
                        <span class="exam-mode-label"> Exam</span>
                    </div>
                </div>
                
                <!-- DIVIDER -->
                <div class="sidebar-divider"></div>
                
                <!-- BOTTOM SECTION: Navigation Buttons -->
                <div class="sidebar-nav-section">
                    <button id="btn-sidebar-admin" class="hidden sidebar-nav-btn admin-btn tooltip-container" onclick="switchTab('admin', this)" data-tooltip="Access admin panel to manage questions and view student data (Admin only)">
                         Admin Mode
                    </button>

                    <button id="btn-sidebar-progress" class="hidden sidebar-nav-btn progress-btn tooltip-container" onclick="switchTab('student-progress', this)" data-tooltip="View detailed progress for all students (Admin only)">
                         Student Progress
                    </button>

                    <button id="btn-sidebar-leaderboard" class="sidebar-nav-btn tooltip-container" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: white;" onclick="switchTab('leaderboard', this)" data-tooltip="See rankings and compare your performance with other students">
                         Leaderboard
                    </button>

                    <button id="btn-sidebar-my-progress" class="sidebar-nav-btn tooltip-container" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;" onclick="switchTab('my-progress', this)" data-tooltip="Track your learning progress, mastery percentages, and improvement over time">
                         My Progress
                    </button>

                    <button id="btn-sidebar-worksheet" class="sidebar-nav-btn worksheet-btn tooltip-container" onclick="switchTab('worksheet', this)" data-tooltip="View and manage your collection of practice questions">
                         My Worksheet <span id="worksheet-count" class="worksheet-badge">0</span>
                    </button>

                    <button id="btn-sidebar-saved-worksheets" class="sidebar-nav-btn saved-btn tooltip-container" onclick="switchTab('saved-worksheets', this)" data-tooltip="Access previously saved worksheets for review">
                         Saved Worksheets
                    </button>

                    <button id="btn-sidebar-lessons" class="sidebar-nav-btn lessons-btn tooltip-container" onclick="switchTab('lessons', this)" data-tooltip="Browse video lessons with practice questions">
                         Lessons
                    </button>

                    <button id="btn-sidebar-question-list" class="sidebar-nav-btn tooltip-container" style="background: linear-gradient(135deg, #9c27b0, #673ab7); color: white;" onclick="switchTab('question-list', this)" data-tooltip="Browse and search all available questions in the library">
                         Question Library
                    </button>
                    
                    <!-- Tutorial button moved to header -->
                    
                    <button onclick="handleLogout()" class="logout-btn tooltip-container" data-tooltip="Sign out of your account"> Logout</button>
                </div>

                <div id="oeq-sidebar-content">
                    <h2 id="oeq-title">OEQ Questions</h2>
                    <nav id="oeq-topic-nav" class="sidebar-nav">
                        <!-- Dynamic topic buttons will be populated here -->
                    </nav>
                </div>

                <div id="mcq-sidebar-content" class="hidden">
                    <h2 style="margin-bottom: 0.5rem;">MCQ Level</h2>
                    <select id="mcq-level-select" onchange="window.currentMcqLevel = this.value; renderMcqHeaders();"
                        class="auth-input"
                        style="height: 40px; margin-bottom: 1rem; border-radius: 8px; padding: 5px 10px; font-size: 0.9rem;">
                        <option value="P3">Primary 3</option>
                        <option value="P4">Primary 4</option>
                        <option value="P5">Primary 5</option>
                        <option value="P6">Primary 6</option>
                    </select>
                    <h2 id="mcq-topic-label" style="font-size: 1rem; color: #666; margin-bottom: 1rem;">Questions</h2>
                    <nav id="mcq-question-nav" class="sidebar-nav">
                        <!-- Dynamic Question Buttons (Q1, Q2...) -->
                    </nav>
                </div>
            </aside>

            <main id="main-content-area" style="flex: 1; overflow-y: auto;">

                <!-- View: CER (Existing - Part of OEQ) -->
                <div id="view-cer" class="view-content active">
                    <!-- TOPIC: HEAT -->
                    <div id="topic-heat" class="topic-content hidden">
                        <!-- Question 1: Heat -->
                        <div id="heat-question-1" class="question-container">
                            <h3>Question 1</h3>
                            <p>Peter conducted an experiment to find out how the materials of bowls affect the time
                                taken for the water in them to cool down. He measured the temperature of the water in
                                the three bowls every two minutes and recorded it in the table.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2" style="vertical-align: middle;">Time (min)</th>
                                        <th colspan="3">Temperature of Water (C)</th>
                                    </tr>
                                    <tr>
                                        <th>Bowl A</th>
                                        <th>Bowl B</th>
                                        <th>Bowl C</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>0</td>
                                        <td>80</td>
                                        <td>80</td>
                                        <td>80</td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>79</td>
                                        <td>74</td>
                                        <td>78</td>
                                    </tr>
                                    <tr>
                                        <td>4</td>
                                        <td>78</td>
                                        <td>68</td>
                                        <td>74</td>
                                    </tr>
                                    <tr>
                                        <td>6</td>
                                        <td>78</td>
                                        <td>61</td>
                                        <td>72</td>
                                    </tr>
                                    <tr>
                                        <td>8</td>
                                        <td>76</td>
                                        <td>55</td>
                                        <td>69</td>
                                    </tr>
                                    <tr>
                                        <td>10</td>
                                        <td>74</td>
                                        <td>49</td>
                                        <td>66</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Which bowl is the most suitable for storing frozen ice-cream?
                                Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="heat-form-1">
                                    <div class="cer-segment" data-label="claim">Bowl<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="A"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The temperature of water in bowl A
                                        decreased by the<div class="answer-blank"><input type="text"
                                                class="answer-input" data-answer="least"></div> amount,<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that bowl A is the poorest
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                style="width: 120px;" data-answer="conductor"></div>of<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="heat"></div>, allowing the ice-cream to<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="gain"></div>heat from the warmer surrounding air slowest to
                                        melt the slowest.<span class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                    <button class="next-btn btn hidden">Next Question</button>
                                </div>
                            </div>
                        </div>

                        <!-- Question 2: Heat -->
                        <div id="heat-question-2" class="question-container">
                            <h3>Question 2</h3>
                            <p>Warren conducted an experiment on three solid blocks made of materials, A, B and C, of
                                the same size and thickness. He heated the three materials and measured the time taken
                                for each to increase from 30C to 50C. The table below shows his results.</p>
                            <img src="https://www.dropbox.com/scl/fi/tsjlvlar0etwnhd3wyple/Screenshot-2025-10-18-at-8.42.36-AM.png?rlkey=l15xphdym7bmg352669a8ykt1&raw=1"
                                alt="Cooler Box Experiment Diagram" class="question-diagram">
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Materials</th>
                                        <th>Time taken for the experiment (second)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>A</td>
                                        <td>50</td>
                                    </tr>
                                    <tr>
                                        <td>B</td>
                                        <td>80</td>
                                    </tr>
                                    <tr>
                                        <td>C</td>
                                        <td>35</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Which material A, B or C, should Warren choose to keep the ice
                                cold for the longest time? Explain why.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="heat-form-2">
                                    <div class="cer-segment" data-label="claim">Material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="B"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The time taken for the temperature of
                                        the block made of material B to increase from 30C to 50C is the<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="longest"></div>,<span class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that material B is the
                                        poorest<div class="answer-blank"><input type="text" class="answer-input"
                                                style="width: 120px;" data-answer="conductor"></div>of<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="heat"></div>, allowing the ice in the ice box to<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="gain"></div>heat from the warmer surrounding air<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="slowest"></div>to melt<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="slowest"></div>.<span
                                            class="feedback-icon"></span></div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                    <button class="next-btn btn hidden">Next Question</button>
                                </div>
                            </div>
                        </div>

                        <!-- Question 3: Heat (Jarrell/Double-Glazed) -->
                        <div id="heat-question-3" class="question-container">
                            <h3>Question 3</h3>
                            <p>Jarrell wanted to investigate which glass, A or B, keeps water cold for a longer time.
                                Both glasses were made of the same material.</p>
                            <p>He measured the temperature of water in each glass at the start of the experiment and
                                every 10 minutes for 50 minutes. He plotted the results in the graph.</p>
                            <div style="display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-start;">
                                <img src="https://www.dropbox.com/scl/fi/6k92e3bl2ypvtoj2z3vgh/Screenshot-2026-01-01-at-1.23.56-AM.png?rlkey=sod3j1qoo1luvqt9of4vsfbak&raw=1"
                                    alt="Glasses Diagram (A: Double vs B: Single)" class="question-diagram"
                                    style="max-width: 45%; border: 1px dashed #ccc; min-height: 150px; background: #f9f9f9;">
                                <img src="https://www.dropbox.com/scl/fi/qlxcbhuj6m9awgtd3xb2z/Screenshot-2026-01-01-at-1.27.47-AM.png?rlkey=cd4cwykuja7k335j2qwymavmn&raw=1"
                                    alt="Graph Diagram (Line X vs Line Y)" class="question-diagram"
                                    style="max-width: 45%; border: 1px dashed #ccc; min-height: 150px; background: #f9f9f9;">
                            </div>
                            <p>The table shows the daily average temperature for Singapore during the day.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Average temperature (C) in the day</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Inside the house</td>
                                        <td>28C</td>
                                    </tr>
                                    <tr>
                                        <td>Outside the house</td>
                                        <td>32C</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Are double-layered or single-layered glass windows more suitable
                                for houses in Singapore, so that it is cooler inside the house? Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="heat-form-3">
                                    <div class="cer-segment" data-label="claim">
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                style="width: 150px;" data-answer="Double-layered"></div>glass windows
                                        are more suitable.<span class="feedback-icon"></span>
                                    </div>
                                    <div class="cer-segment" data-label="evidence">The temperature of water increases
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="slower"></div> for glass <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="A"></div> when compared to
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="B"></div> over 50 minutes.<span
                                            class="feedback-icon"></span>
                                    </div>
                                    <div class="cer-segment" data-label="reasoning">The layer of <div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="air"></div> trapped between the glass layer is a <div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="poor"></div> conductor of <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="heat"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="link">This <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="reduces"></div> the heat
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="gained"></div> from the <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="warmer"></div> surrounding
                                        air outside the house into the inside of the house, thus, keeping the inside of
                                        the house <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="cooler"></div>.<span class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TOPIC: LIGHT -->
                    <div id="topic-light" class="topic-content hidden">
                        <div id="light-question-1" class="question-container">
                            <h3>Question 1</h3>
                            <p>Jeremy conducted an experiment in a dark room to investigate the properties of materials
                                P, Q, R and S. He placed different materials at positions 1 and 2 respectively each
                                time.</p>
                            <img src="https://www.dropbox.com/scl/fi/m72szjzburi7sqf8u9vcj/Screenshot-2025-10-18-at-8.06.48-AM.png?rlkey=h2pcg2ig894ot07xjx7bld0fn&raw=1"
                                alt="Light Experiment Diagram" class="question-diagram">
                            <p>The amount of light detected by the light sensor was recorded as shown in the table.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Material at position 1</th>
                                        <th>Material at position 2</th>
                                        <th>Amount of light detected (lux)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>P</td>
                                        <td>Q</td>
                                        <td>2000</td>
                                    </tr>
                                    <tr>
                                        <td>Q</td>
                                        <td>R</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>R</td>
                                        <td>S</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>S</td>
                                        <td>P</td>
                                        <td>300</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Which material would be most suitable to make a bedroom curtain
                                that keeps the room totally dark? Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="light-form-1">
                                    <div class="cer-segment" data-label="claim">Material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="R"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The amount of light detected is<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="0"></div>lux when material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="R"></div>is placed in
                                        either position 1 or position 2,<span class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that material R is the only
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="opaque"></div>material, allowing the curtain to block<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="all"></div>light and keep the room totally dark.<span
                                            class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TOPIC: MATERIALS -->
                    <div id="topic-materials" class="topic-content hidden">
                        <div id="materials-question-1" class="question-container">
                            <h3>Question 1</h3>
                            <p>Tony set up an experiment to compare the property of four strips, A, B, C and D, made of
                                different materials but of the same thickness.</p>
                            <img src="https://www.dropbox.com/scl/fi/jsxkxtz7ryrm3s4i04x49/Screenshot-2025-10-18-at-2.29.33-AM.png?rlkey=cib9nnrvpxta2imuncs4j9ugw&raw=1"
                                alt="Flexibility Experiment Diagram" class="question-diagram">
                            <p>He recorded the distance, x, in the table below.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Distance x (cm)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>A</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>B</td>
                                        <td>9</td>
                                    </tr>
                                    <tr>
                                        <td>C</td>
                                        <td>30</td>
                                    </tr>
                                    <tr>
                                        <td>D</td>
                                        <td>10</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Based on the results, which strip is most suitable for making a
                                belt? Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="materials-form-1">
                                    <div class="cer-segment" data-label="claim">Material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="C"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="distance"></div>X for
                                        material<div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="C"></div>is the<div class="answer-blank"><input type="text"
                                                class="answer-input" data-answer="greatest"></div>,<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that material<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="C"></div>is the most<div class="answer-blank"><input
                                                type="text" class="answer-input" style="width: 120px;"
                                                data-answer="flexible"></div>material, allowing a belt made of it to
                                        wrap around a person's waist most easily.<span class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TOPIC: MCQ CONTENT (Dynamic) -->
                <div id="topic-mcq-living-and-non-living-things" class="topic-content hidden"></div>
                <div id="topic-mcq-materials" class="topic-content hidden"></div>
                <div id="topic-mcq-life-cycles" class="topic-content hidden"></div>
                <div id="topic-mcq-magnets" class="topic-content hidden"></div>
                <div id="topic-mcq-plant-systems" class="topic-content hidden"></div>
                <div id="topic-mcq-human-body-systems" class="topic-content hidden"></div>
                <div id="topic-mcq-matter-and-its-3-states" class="topic-content hidden"></div>
                <div id="topic-mcq-light" class="topic-content hidden"></div>
                <div id="topic-mcq-heat" class="topic-content hidden"></div>
                <div id="topic-mcq-water-and-its-3-states" class="topic-content hidden"></div>
                <div id="topic-mcq-plant-reproduction" class="topic-content hidden"></div>
                <div id="topic-mcq-human-reproduction" class="topic-content hidden"></div>
                <div id="topic-mcq-human-and-plant-respiration" class="topic-content hidden"></div>
                <div id="topic-mcq-human-and-plant-transport" class="topic-content hidden"></div>
                <div id="topic-mcq-electrical-systems" class="topic-content hidden"></div>
                <div id="topic-mcq-forces" class="topic-content hidden"></div>
                <div id="topic-mcq-energy-in-food" class="topic-content hidden"></div>
                <div id="topic-mcq-energy-conversion" class="topic-content hidden"></div>
                <div id="topic-mcq-living-together" class="topic-content hidden"></div>
                <div id="topic-mcq-food-chains-and-webs" class="topic-content hidden"></div>
                <div id="topic-mcq-humans-and-the-environment" class="topic-content hidden"></div>

                <!-- View: Single Relationship -->
                <div id="view-single-relationship" class="view-content hidden">
                    <!-- TOPIC: FORCES -->
                    <div id="topic-sr-forces" class="topic-content">
                        <div id="sr-forces-question-1" class="question-container">
                                <h3>Question 1</h3>
                                <p>Meiling conducted an experiment by placing a 1 kg block on a flat surface and
                                    measured the amount of force needed to pull it along the surface using a spring
                                    balance.</p>
                                <img src="https://www.dropbox.com/scl/fi/xvhgx31uk82s32edfv6a6/spring-block.jpg?rlkey=8aejaocw35svctiogmy9mbbwt&raw=1"
                                    alt="Spring Block Diagram" class="question-diagram">
                                <p>She repeated the experiment using three similar blocks that are of different masses
                                    and recorded the results in the graph.</p>
                                <img src="https://www.dropbox.com/scl/fi/j1kumnl75vervdk5he9p7/graph-app.jpg?rlkey=4gqp7teop1dy2wa38yr20iu2n&raw=1"
                                    alt="Force Graph Diagram" class="question-diagram">
                                <p class="question-title">State what Meiling could conclude based on the results of her
                                    experiment.</p>
                                <div class="answer-box">
                                    <div class="answer-template" id="sr-forces-form-1">
                                        <div class="cer-segment" style="border:none; padding:0; margin-bottom:0;"
                                            data-label="">
                                            As the
                                            <div class="answer-group">
                                                <div class="answer-blank"><input type="text" class="answer-input"
                                                        style="width: 200px;" data-answer="mass of the block|mass">
                                                </div>
                                                <span class="variable-label"
                                                    data-tooltip="The variable that is changed or controlled in a scientific experiment to test the effects on the dependent variable.">independent
                                                    variable</span>
                                            </div>
                                            increases, the
                                            <div class="answer-group">
                                                <div class="answer-blank"><input type="text" class="answer-input"
                                                        style="width: 350px;"
                                                        data-answer="amount of force needed to pull it along the surface|amount of force|force">
                                                </div>
                                                <span class="variable-label"
                                                    data-tooltip="The variable being tested and measured in a scientific experiment.">dependent
                                                    variable</span>
                                            </div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="increases"></div>.
                                            <span class="feedback-icon" style="margin-left: 10px;"></span>
                                        </div>
                                    </div>
                                    <div class="controls">
                                        <button class="submit-btn btn">Submit</button>
                                        <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>

                <div id="view-double-relationship" class="view-content hidden">
                    <div class="placeholder-content">
                        <h2>Double Relationship Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-definition" class="view-content hidden">
                    <div id="topic-def-evap" class="topic-content">
                        <div id="def-evap-question-1" class="question-container">
                                <h3>Question 1</h3>
                                <p class="question-title">Define evaporation.</p>
                                <div class="answer-box">
                                    <div class="answer-template" id="def-form-1"
                                        style="font-size: 1.2rem; line-height: 2;">
                                        <div class="cer-segment" data-label="definition">
                                            Evaporation is a process where a <div class="answer-blank"><input
                                                    type="text" class="answer-input" data-answer="liquid"></div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="gains"></div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="heat"></div> from a heat source to become <div
                                                class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="gas"></div> at <div class="answer-blank"><input
                                                    type="text" class="answer-input" data-answer="any"></div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    style="width: 150px;" data-answer="temperature"></div>.
                                            <span class="feedback-icon"></span>
                                        </div>
                                    </div>
                                    <div class="controls">
                                        <button class="submit-btn btn">Submit</button>
                                        <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>

                <div id="view-fairness" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Fairness Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-reliability" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Reliability Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-accuracy" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Accuracy Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-constant-variable" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Constant Variable Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-explanation" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Explanation Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-control-setup" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Control Set-up Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-admin" class="view-content hidden" style="flex: 1;">
                    <main style="max-width: 900px; margin: 0 auto; padding-top: 2rem;">
                        <h2 style="margin-bottom: 1rem; color: var(--main-text);">Question Creator (Admin)</h2>
                        
                        <!-- Push Update Section -->
                        <div id="push-update-section" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #667eea30;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <strong style="color: #667eea;"> Push App Update</strong>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 2px;">Current version: <code id="current-version-display" style="background: #e9ecef; padding: 2px 6px; border-radius: 4px;"></code></div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="pushUpdateNotification(false)" class="btn" style="background: #667eea; color: white; font-size: 0.85rem; padding: 8px 16px;">
                                         Notify Users
                                    </button>
                                    <button onclick="pushUpdateNotification(true)" class="btn" style="background: #dc3545; color: white; font-size: 0.85rem; padding: 8px 16px;">
                                         Force Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Question Ratings Dashboard (Admin Only) -->
                        <div id="ratings-dashboard-section" style="background: linear-gradient(135deg, #f3e5f515 0%, #e1bee715 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #ce93d830;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 1rem;">
                                <div>
                                    <strong style="color: #7b1fa2;"> Question Ratings Dashboard</strong>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 2px;">View and manage question difficulty ratings (Elo-based)</div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="loadRatingsDashboard()" class="btn" style="background: #7b1fa2; color: white; font-size: 0.85rem; padding: 8px 16px;">
                                         Refresh Ratings
                                    </button>
                                    <button onclick="toggleRatingsDashboard()" class="btn" style="background: #9c27b0; color: white; font-size: 0.85rem; padding: 8px 16px;" id="btn-toggle-ratings">
                                         Show Dashboard
                                    </button>
                                </div>
                            </div>
                            <div id="ratings-dashboard-content" class="hidden">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 1rem;">
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #7b1fa2;" id="stat-total-questions">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Total Questions</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #4CAF50;" id="stat-rated-questions">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Rated Questions</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #ff9800;" id="stat-avg-rating">1200</div>
                                        <div style="font-size: 0.8rem; color: #888;">Avg Rating</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #2196F3;" id="stat-total-attempts">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Total Attempts</div>
                                    </div>
                                </div>
                                <div style="max-height: 400px; overflow-y: auto; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                        <thead style="position: sticky; top: 0; background: #f5f5f5;">
                                            <tr>
                                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e0e0e0;">Question</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Level</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Topic</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Rating</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Attempts</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Correct %</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Confidence</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ratings-table-body">
                                            <tr><td colspan="7" style="padding: 20px; text-align: center; color: #888;">Click "Refresh Ratings" to load data</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Activity Dashboard (Admin Only) -->
                        <div id="activity-dashboard-section" style="background: linear-gradient(135deg, #e3f2fd15 0%, #bbdefb15 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #2196f330;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 1rem;">
                                <div>
                                    <strong style="color: #1976d2;"> User Activity Dashboard</strong>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 2px;">Track user logins and account activities</div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="loadActivityDashboard()" class="btn" style="background: #1976d2; color: white; font-size: 0.85rem; padding: 8px 16px;">
                                         Refresh
                                    </button>
                                    <button onclick="toggleActivityDashboard()" class="btn" style="background: #2196f3; color: white; font-size: 0.85rem; padding: 8px 16px;" id="btn-toggle-activity">
                                         Show Dashboard
                                    </button>
                                </div>
                            </div>
                            <div id="activity-dashboard-content" class="hidden">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 1rem;">
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #1976d2;" id="stat-total-users">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Total Users</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #4CAF50;" id="stat-active-today">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Active Today</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #ff9800;" id="stat-active-week">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Active This Week</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #9c27b0;" id="stat-total-practice-sessions">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Total Questions Done</div>
                                    </div>
                                </div>
                                <div style="max-height: 350px; overflow-y: auto; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                        <thead style="position: sticky; top: 0; background: #f5f5f5;">
                                            <tr>
                                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e0e0e0;">User</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Students</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Last Active</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Questions Done</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Correct %</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Avg Rating</th>
                                            </tr>
                                        </thead>
                                        <tbody id="activity-table-body">
                                            <tr><td colspan="6" style="padding: 20px; text-align: center; color: #888;">Click "Refresh" to load data</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div id="editing-indicator" class="hidden" style="background: #fff3cd; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; color: #856404; display: flex; justify-content: space-between; align-items: center;">
                            <span> <strong>Editing:</strong> <span id="editing-question-name"></span></span>
                            <button onclick="cancelEditing()" style="background: #856404; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Cancel Edit</button>
                        </div>
                        <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.9rem; color: #2e7d32;">
                            <strong> How to create a question:</strong>
                            <ol style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
                                <li>Fill in the <strong>Title</strong> and select <strong>Category/Topic</strong></li>
                                <li>Add <strong>Text blocks</strong> for question content and <strong>Answer blocks</strong> for fill-in-the-blank sections</li>
                                <li>Click <strong>"Preview & Select Blanks"</strong> to see your question and click words to turn them into blanks</li>
                                <li>Click <strong>"Save Question"</strong> when done</li>
                            </ol>
                            <p style="margin-top: 0.5rem; font-size: 0.85rem;"><em> Tip: In Answer blocks, wrap words in [brackets] to automatically make them blanks (e.g., "The answer is [correct]")</em></p>
                        </div>
                        <div id="admin-editor" class="answer-box"
                            style="background: #fff; border: 1px solid var(--border-color);">
                            <div id="admin-basic-meta"
                                style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-top-left-radius: 8px; border-top-right-radius: 8px;">
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="flex: 1;">
                                        <label for="admin-category"
                                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Category:</label>
                                        <select id="admin-category" class="auth-input"
                                            style="width: 100%; height: 50px; cursor: pointer;"
                                            onchange="handleCategoryChange(this.value)">
                                            <option value="cer">CER (Open Ended)</option>
                                            <option value="definition">Definition</option>
                                            <option value="single-relationship">Single Relationship</option>
                                            <option value="double-relationship">Double Relationship</option>
                                            <option value="mcq">Multiple Choice (MCQ)</option>
                                            <option value="fairness">Fairness</option>
                                            <option value="reliability">Reliability</option>
                                            <option value="accuracy">Accuracy</option>
                                            <option value="constant-variable">Constant Variable</option>
                                            <option value="explanation">Explanation</option>
                                            <option value="control-setup">Control Set-up</option>
                                        </select>
                                    </div>
                                    <div id="admin-level-container" class="hidden" style="flex: 1;">
                                        <label for="admin-level"
                                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Level:</label>
                                        <select id="admin-level" class="auth-input"
                                            style="width: 100%; height: 50px; cursor: pointer;"
                                            onchange="updateAdminTopicsByLevel(this.value)">
                                            <option value="P3">Primary 3</option>
                                            <option value="P4">Primary 4</option>
                                            <option value="P5">Primary 5</option>
                                            <option value="P6">Primary 6</option>
                                        </select>
                                    </div>
                                </div>
                                <label for="admin-title"
                                    style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Question
                                    Title:</label>
                                <input type="text" id="admin-title" class="auth-input"
                                    style="width: 100%; height: 50px; margin-bottom: 1rem;"
                                    placeholder="e.g., Bird Life Cycle">
                                <label for="admin-topic"
                                    style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Topic:</label>
                                <select id="admin-topic" class="auth-input"
                                    style="width: 100%; height: 50px; cursor: pointer; margin-bottom: 0.5rem;"
                                    onchange="handleTopicChange(this.value)">
                                    <option value="heat">Heat</option>
                                    <option value="light">Light</option>
                                    <option value="materials">Materials</option>
                                    <option value="air">Air</option>
                                    <option value="water">Water</option>
                                    <option value="new-topic">-- Add Custom Topic --</option>
                                </select>
                                <input type="text" id="admin-new-topic" class="auth-input hidden"
                                    style="width: 100%; height: 50px;" placeholder="Enter new topic name...">
                                <!-- MCQ Options (Hidden by default) -->
                                <div id="mcq-options-container" class="hidden"
                                    style="margin-top: 1rem; padding: 1rem; background: #eee; border-radius: 8px;">
                                    <p style="font-weight: 600; margin-bottom: 0.5rem;">Enter Options:</p>
                                    <input type="text" id="mcq-opt-1" class="auth-input" placeholder="Option 1"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <input type="text" id="mcq-opt-2" class="auth-input" placeholder="Option 2"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <input type="text" id="mcq-opt-3" class="auth-input" placeholder="Option 3"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <input type="text" id="mcq-opt-4" class="auth-input" placeholder="Option 4"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <p style="font-weight: 600; margin-top: 0.5rem;">Correct Answer:</p>
                                    <select id="mcq-correct" class="auth-input" style="height: 40px;">
                                        <option value="1">Option 1</option>
                                        <option value="2">Option 2</option>
                                        <option value="3">Option 3</option>
                                        <option value="4">Option 4</option>
                                    </select>
                                </div>
                            </div>
                            <div id="admin-blocks"></div>
                            <div
                                style="display: flex; gap: 0.8rem; margin-top: 2rem; border-top: 2px dashed #eee; padding-top: 1.5rem; flex-wrap: wrap; justify-content: center;">
                                <button class="btn" onclick="addAdminBlock('text')"
                                    style="background: #e7f5ff; color: #007bff; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+ Add Text</button>
                                <button class="btn" onclick="addAdminBlock('answer')"
                                    style="background: #fff9c4; color: #f9a825; border: 1px solid #fbc02d; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+
                                    Add Answer</button>
                                <button class="btn" onclick="addAdminBlock('explanation')"
                                    style="background: #f0f4ff; color: #007bff; border: 1px solid #007bff; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+
                                    Add Explanation</button>
                                <button class="btn" onclick="addAdminBlock('video')"
                                    style="background: #fff5f5; color: #dc3545; border: 1px solid #dc3545; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+
                                    Add Video URL</button>
                                <button class="btn" onclick="addAdminBlock('image')"
                                    style="background: #fdfdfd; border: 1px solid #ddd; color: #555; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+ Add
                                    Image URL</button>
                                <button class="btn" onclick="event.stopPropagation(); showTableGridSelector(this)" id="add-table-btn"
                                    style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 1px solid #81c784; color: #2e7d32; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+ Add
                                    Table</button>
                            </div>
                            <div id="admin-actions" class="controls"
                                style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #eee;">
                                <button id="admin-clear-btn" class="btn" onclick="clearAdminForm(false, true)"
                                    style="background: #dc3545; color: white;"> Clear Form</button>
                                <button id="admin-process-btn" class="btn" onclick="processAdminQuestion()"
                                    style="background: #28a745; color: white;"> Preview & Select Blanks</button>
                                <button id="save-question-btn" class="btn" onclick="saveAdminQuestion()"
                                    style="background: var(--primary-blue); color: white;"> Save Question</button>
                            </div>
                        </div>
                        <div id="admin-preview-section" class="hidden" style="margin-top: 4rem;">
                            <h3 style="margin-bottom: 1.5rem;">Interactive Preview</h3>
                            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">Click the words you want
                                to turn into blanks. Yellow words will become questions.</p>
                            <div id="admin-preview-content" class="answer-template"
                                style="background: var(--blue-light); padding: 2rem; border-radius: 12px;"></div>
                        </div>
                    </main>
                </div>

                <!-- WORKSHEET VIEW -->
                <div id="view-worksheet" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div class="worksheet-actions"
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0;"> My Worksheet</h2>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn" style="background: #9c27b0; color: white;"
                                    onclick="quickGenerateWorksheet()"> Quick Generate</button>
                                <button class="btn" style="background: #1976d2; color: white;"
                                    onclick="showSaveWorksheetModal()"> Save Worksheet</button>
                                <button class="btn" style="background: #28a745; color: white;"
                                    onclick="exportWorksheet()"> Export PDF</button>
                                <button class="btn" style="background: #dc3545; color: white;"
                                    onclick="clearWorksheet()"> Clear All</button>
                            </div>
                        </div>

                        <div id="worksheet-header"
                            style="display: none; border-bottom: 2px solid #000; padding-bottom: 1rem; margin-bottom: 2rem;">
                            <div
                                style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem;">
                                <span>Name: __________________________</span>
                                <span>Score: ________ / ________</span>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">Date: ________________</div>
                        </div>

                        <div id="worksheet-questions-container">
                            <div class="placeholder-content" id="worksheet-empty-msg">
                                <p style="font-size: 1.2rem; color: #666;">No questions added to your worksheet yet.</p>
                                <p style="font-size: 0.95rem; margin-top: 10px; color: #888;">Browse questions and click
                                    the <strong style="color: #2ed573;"> Worksheet</strong> button to add them here.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SAVED WORKSHEETS VIEW -->
                <div id="view-saved-worksheets" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0;"> My Saved Worksheets</h2>
                            <button class="btn" style="background: #dc3545; color: white;" onclick="refreshSavedWorksheets()"> Refresh</button>
                        </div>
                        <div id="saved-worksheets-container">
                            <div class="placeholder-content" id="saved-worksheets-empty-msg">
                                <p style="font-size: 1.2rem; color: #666;">No saved worksheets yet.</p>
                                <p style="font-size: 0.95rem; margin-top: 10px; color: #888;">
                                    Create a worksheet and click <strong style="color: #1976d2;"> Save Worksheet</strong> to save it here.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LEADERBOARD VIEW -->
                <div id="view-leaderboard" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 1000px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                            <h2 style="margin: 0; background: linear-gradient(135deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"> Student Leaderboard</h2>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <button class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; padding: 10px 24px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);" onclick="switchTab('practice', this)" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
                                     Practice Now
                                </button>
                                <button class="btn" style="background: #1976d2; color: white;" onclick="loadLeaderboard()"> Refresh</button>
                            </div>
                        </div>

                        <!-- Leaderboard Info Box -->
                        <div style="background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%); border-left: 4px solid #667eea; border-radius: 8px; padding: 1.25rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="display: flex; align-items: flex-start; gap: 12px;">
                                <div style="font-size: 1.5rem; line-height: 1;"></div>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: #333; font-weight: 600;">How the Leaderboard Works</h3>
                                    <p style="margin: 0; font-size: 0.9rem; color: #555; line-height: 1.6;">
                                        Your ranking is based on your <strong>rating</strong>, which changes when you answer questions in <strong>Practice Mode</strong>. 
                                        Answering questions correctly increases your rating, while incorrect answers decrease it. 
                                        The leaderboard shows your current rating, improvement score, and total attempts. 
                                        <strong>Only practice mode activities count towards your leaderboard ranking.</strong>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div id="leaderboard-container">
                            <div class="placeholder-content" id="leaderboard-loading-msg">
                                <p style="font-size: 1.2rem; color: #666;">Loading leaderboard...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MY PROGRESS VIEW (Student) -->
                <div id="view-my-progress" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <h2 style="margin: 0; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"> My Progress</h2>
                            <button class="btn" style="background: #1976d2; color: white;" onclick="loadMyProgress()"> Refresh</button>
                        </div>

                        <!-- Student Selector (if multiple students) -->
                        <div id="my-progress-student-selector" style="margin-bottom: 2rem; display: none;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Select Student:</label>
                            <select id="my-progress-student-select" style="padding: 10px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%; max-width: 300px;" onchange="loadMyProgress()">
                            </select>
                        </div>

                        <div id="my-progress-container">
                            <div class="placeholder-content" id="my-progress-loading-msg">
                                <p style="font-size: 1.2rem; color: #666;">Loading your progress...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QUESTION LIST VIEW -->
                <div id="view-question-list" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 1400px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <h2 style="margin: 0; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"> Question Library</h2>
                            <button class="btn" style="background: #1976d2; color: white;" onclick="loadQuestionList()"> Refresh</button>
                        </div>

                        <!-- Filter and Sort Controls -->
                        <div style="background: #f5f5f5; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Sort By:</label>
                                <select id="question-list-sort" class="auth-input" style="width: 100%; padding: 10px; border-radius: 8px;" onchange="sortQuestionList()">
                                    <option value="rating-desc">Rating (High to Low)</option>
                                    <option value="rating-asc">Rating (Low to High)</option>
                                    <option value="topic-asc">Topic (A-Z)</option>
                                    <option value="topic-desc">Topic (Z-A)</option>
                                    <option value="date-desc">Date Added (Newest)</option>
                                    <option value="date-asc">Date Added (Oldest)</option>
                                    <option value="level-asc">Level (P3-P6)</option>
                                    <option value="level-desc">Level (P6-P3)</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Filter by Topic:</label>
                                <select id="question-list-filter-topic" class="auth-input" style="width: 100%; padding: 10px; border-radius: 8px;" onchange="filterQuestionList()">
                                    <option value="">All Topics</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Filter by Level:</label>
                                <select id="question-list-filter-level" class="auth-input" style="width: 100%; padding: 10px; border-radius: 8px;" onchange="filterQuestionList()">
                                    <option value="">All Levels</option>
                                    <option value="P3">Primary 3</option>
                                    <option value="P4">Primary 4</option>
                                    <option value="P5">Primary 5</option>
                                    <option value="P6">Primary 6</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Search:</label>
                                <input type="text" id="question-list-search" class="auth-input" style="width: 100%; padding: 10px; border-radius: 8px;" placeholder="Search questions..." onkeyup="filterQuestionList()">
                            </div>
                        </div>

                        <div id="question-list-container">
                            <div class="placeholder-content" id="question-list-loading-msg">
                                <p style="font-size: 1.2rem; color: #666;">Loading questions...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STUDENT PROGRESS VIEW (Admin Only) -->
                <div id="view-student-progress" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 1100px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <h2 style="margin: 0;"> Student Progress Tracker</h2>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" style="background: #1976d2; color: white;" onclick="refreshStudentProgress()"> Refresh</button>
                                <button class="btn" style="background: #28a745; color: white;" onclick="exportProgressToCSV()"> Export CSV</button>
                            </div>
                        </div>
                        
                        <!-- Filter Controls -->
                        <div style="background: #f5f5f5; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <div>
                                <label style="font-weight: 600; margin-right: 8px;">Worksheet:</label>
                                <select id="progress-worksheet-filter" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.9rem;" onchange="filterProgressByWorksheet()">
                                    <option value="all">All Worksheets</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight: 600; margin-right: 8px;">Student:</label>
                                <select id="progress-student-filter" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.9rem;" onchange="filterProgressByStudent()">
                                    <option value="all">All Students</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight: 600; margin-right: 8px;">Status:</label>
                                <select id="progress-status-filter" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.9rem;" onchange="filterProgressByStatus()">
                                    <option value="all">All</option>
                                    <option value="completed">Completed</option>
                                    <option value="in-progress">In Progress</option>
                                </select>
                            </div>
                        </div>

                        <!-- Summary Stats -->
                        <div id="progress-summary-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 1.2rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #1976d2;" id="stat-total-attempts">0</div>
                                <div style="color: #666; font-size: 0.85rem;">Total Attempts</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 1.2rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #388e3c;" id="stat-completed-count">0</div>
                                <div style="color: #666; font-size: 0.85rem;">Completed</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 1.2rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #f57c00;" id="stat-avg-score">0%</div>
                                <div style="color: #666; font-size: 0.85rem;">Avg Score</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fce4ec, #f8bbd9); padding: 1.2rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #c2185b;" id="stat-unique-students">0</div>
                                <div style="color: #666; font-size: 0.85rem;">Students</div>
                            </div>
                        </div>

                        <!-- Progress Table -->
                        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                            <div style="overflow-x: auto;">
                                <table id="progress-table" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                    <thead>
                                        <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                            <th style="padding: 1rem; text-align: left; font-weight: 600;">Student</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600;">Worksheet</th>
                                            <th style="padding: 1rem; text-align: center; font-weight: 600;">Score</th>
                                            <th style="padding: 1rem; text-align: center; font-weight: 600;">Status</th>
                                            <th style="padding: 1rem; text-align: center; font-weight: 600;">Date</th>
                                            <th style="padding: 1rem; text-align: center; font-weight: 600;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="progress-table-body">
                                        <tr>
                                            <td colspan="6" style="padding: 3rem; text-align: center; color: #888;">
                                                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                                                <p>No worksheet attempts yet</p>
                                                <p style="font-size: 0.85rem; margin-top: 0.5rem;">Student progress will appear here when they attempt assigned worksheets</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Progress Detail Modal -->
                <div id="progress-detail-modal" class="modal-overlay">
                    <div class="modal-box" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 1rem;">
                            <h3 style="margin: 0; color: #1976d2;"> Detailed Results</h3>
                            <button class="btn" style="background: #666; color: white;" onclick="hideProgressDetailModal()"> Close</button>
                        </div>
                        
                        <!-- Student Info -->
                        <div id="progress-detail-header" style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <!-- Populated dynamically -->
                        </div>
                        
                        <!-- Question Results -->
                        <div id="progress-detail-questions">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- SHARED LESSONS VIEW -->
                <div id="view-lessons" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0;"> Lessons</h2>
                            <button class="btn" style="background: #f57c00; color: white;" onclick="refreshSharedLessons()"> Refresh</button>
                        </div>
                        <div id="lessons-container">
                            <div class="placeholder-content" id="lessons-empty-msg">
                                <p style="font-size: 1.2rem; color: #666;">No lessons available yet.</p>
                                <p style="font-size: 0.95rem; margin-top: 10px; color: #888;">
                                    Check back later for new lessons from your teacher!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LESSON DETAIL VIEW -->
                <div id="view-lesson-detail" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <button class="btn" style="background: #666; color: white; margin-bottom: 1.5rem;" onclick="switchTab('lessons')"> Back to Lessons</button>
                        <div id="lesson-detail-content"></div>
                    </div>
                </div>

                <!-- PRACTICE MODE VIEW -->
                <div id="view-practice" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h2 style="margin: 0; color: #7b1fa2;"> Practice Mode</h2>
                                <p style="margin: 0.5rem 0 0; color: #666;" id="practice-student-info">Select a student to start practicing</p>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="practice-student-select" style="height: 45px; margin: 0; border-radius: 8px; min-width: 250px; padding: 0 15px; font-size: 1rem; border: 2px solid #e0e0e0; background: #fafafa; cursor: pointer;" onchange="selectPracticeStudent()">
                                    <option value="">-- Select Student --</option>
                                </select>
                            </div>
                        </div>

                        <!-- Practice Stats -->
                        <div id="practice-stats" class="hidden" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: #e8f5e9; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #28a745;" id="stat-correct">0</div>
                                <div style="color: #666; font-size: 0.9rem;">Correct</div>
                            </div>
                            <div style="background: #ffebee; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #dc3545;" id="stat-wrong">0</div>
                                <div style="color: #666; font-size: 0.9rem;">Wrong</div>
                            </div>
                            <div style="background: #fff3e0; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #f57c00;" id="stat-review">0</div>
                                <div style="color: #666; font-size: 0.9rem;"> Review</div>
                            </div>
                            <div style="background: #e3f2fd; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #1976d2;" id="stat-remaining">0</div>
                                <div style="color: #666; font-size: 0.9rem;">Remaining</div>
                            </div>
                            <div style="background: #f3e5f5; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #7b1fa2;" id="stat-streak">0</div>
                                <div style="color: #666; font-size: 0.9rem;">Streak </div>
                            </div>
                        </div>

                        <!-- Start Practice Button -->
                        <div id="practice-start-container" style="text-align: center; padding: 3rem;">
                            <button id="btn-start-practice" class="btn" style="background: #7b1fa2; color: white; font-size: 1.2rem; padding: 15px 40px;" onclick="startPractice()" disabled>
                                 Start Practice
                            </button>
                            <p style="color: #888; margin-top: 1rem; font-size: 0.9rem;">Questions will be served based on your level. Review questions (from 7 days ago) come first!</p>
                        </div>

                        <!-- Current Question Container -->
                        <div id="practice-question-container" class="hidden">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span style="background: #f3e5f5; color: #7b1fa2; padding: 5px 15px; border-radius: 20px; font-weight: 600;" id="practice-question-level">P6</span>
                                <span style="color: #888; font-size: 0.9rem;" id="practice-question-topic">Topic: Forces</span>
                            </div>
                            <div id="practice-question-content" style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
                            <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;">
                                <button class="btn" style="background: #7b1fa2; color: white;" onclick="nextPracticeQuestion()">Next Question </button>
                                <button class="btn" style="background: #666; color: white;" onclick="endPractice()">End Practice</button>
                            </div>
                        </div>

                        <!-- Practice Complete -->
                        <div id="practice-complete" class="hidden" style="text-align: center; padding: 3rem;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                            <h3 style="color: #7b1fa2;">Practice Complete!</h3>
                            <p style="color: #666;" id="practice-summary">Great job!</p>
                            <button class="btn" style="background: #7b1fa2; color: white; margin-top: 1rem;" onclick="restartPractice()">Practice Again</button>
                        </div>
                    </div>
                </div>

                <!-- INBOX VIEW -->
                <div id="view-inbox" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h2 style="margin: 0; color: #0288d1;"> Inbox</h2>
                                <p style="margin: 0.5rem 0 0; color: #666;">Messages between you and Mr Chung</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" style="background: #0288d1; color: white;" onclick="refreshInbox()"> Refresh</button>
                                <button id="btn-new-message" class="btn" style="background: #28a745; color: white;" onclick="showNewMessageModal()"> New Message</button>
                            </div>
                        </div>

                        <!-- Message Tabs -->
                        <div style="display: flex; gap: 10px; margin-bottom: 1.5rem; flex-wrap: wrap;">
                            <button id="inbox-tab-received" class="inbox-tab active" onclick="switchInboxTab('received')"> Received</button>
                            <button id="inbox-tab-sent" class="inbox-tab" onclick="switchInboxTab('sent')"> Sent</button>
                            <button id="inbox-tab-deleted" class="inbox-tab" onclick="switchInboxTab('deleted')" style="background: #fff5f5; border-color: #ffcdd2;"> Deleted</button>
                        </div>

                        <!-- Messages Container -->
                        <div id="inbox-messages-container">
                            <div class="inbox-empty" id="inbox-empty-msg">
                                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                                <p>No messages yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Flagged Questions View (Admin Only) -->
                <div id="view-flagged" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h2 style="margin: 0; color: #ff9800;"> Flagged Questions</h2>
                                <p style="margin: 0.5rem 0 0; color: #666;">Questions reported by users as having issues</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" style="background: #ff9800; color: white;" onclick="loadFlaggedQuestions()"> Refresh</button>
                            </div>
                        </div>

                        <!-- Flagged Questions Tabs -->
                        <div style="display: flex; gap: 10px; margin-bottom: 1.5rem; flex-wrap: wrap;">
                            <button id="flagged-tab-pending" class="inbox-tab active" onclick="switchFlaggedTab('pending')" style="border-color: #ff9800;"> Pending</button>
                            <button id="flagged-tab-resolved" class="inbox-tab" onclick="switchFlaggedTab('resolved')" style="border-color: #4CAF50;"> Resolved</button>
                            <button id="flagged-tab-all" class="inbox-tab" onclick="switchFlaggedTab('all')"> All</button>
                        </div>

                        <!-- Flagged Questions Container -->
                        <div id="flagged-questions-container">
                            <div class="inbox-empty" id="flagged-empty-msg">
                                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                                <p>No flagged questions</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Worksheet Attempt Modal -->
    <div id="worksheet-attempt-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #667eea; padding-bottom: 1rem;">
                <div>
                    <h3 style="margin: 0; color: #667eea;" id="attempt-worksheet-title"> Worksheet</h3>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;" id="attempt-worksheet-progress">Question 1 of 5</div>
                </div>
                <button class="btn" style="background: #666; color: white;" onclick="cancelWorksheetAttempt()"> Exit</button>
            </div>
            
            <!-- Progress Bar -->
            <div style="background: #e0e0e0; height: 8px; border-radius: 4px; margin-bottom: 1.5rem; overflow: hidden;">
                <div id="attempt-progress-bar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
            </div>
            
            <!-- Question Container -->
            <div id="attempt-question-container" style="min-height: 300px;">
                <!-- Question will be loaded here -->
            </div>
            
            <!-- Navigation Buttons -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e0e0e0;">
                <button id="attempt-prev-btn" class="btn" style="background: #666; color: white;" onclick="prevAttemptQuestion()"> Previous</button>
                <div style="display: flex; gap: 10px;">
                    <button id="attempt-next-btn" class="btn" style="background: #667eea; color: white;" onclick="nextAttemptQuestion()">Next </button>
                    <button id="attempt-submit-btn" class="btn hidden" style="background: #28a745; color: white;" onclick="submitWorksheetAttempt()"> Submit Worksheet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Consult Mr Chung Modal -->
    <div id="consult-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 600px;">
            <h3 style="color: #0288d1; margin-bottom: 1rem;"> Ask Mr Chung</h3>
            <div id="consult-question-preview" style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; max-height: 150px; overflow-y: auto; font-size: 0.9rem; border-left: 4px solid #0288d1;">
                <!-- Question preview will be inserted here -->
            </div>
            <div class="form-group">
                <label for="consult-message">Your Question / Message *</label>
                <textarea id="consult-message" rows="4" placeholder="Type your question here..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideConsultModal()">Cancel</button>
                <button class="btn-save" style="background: #0288d1;" onclick="sendConsultMessage()"> Send Message</button>
            </div>
        </div>
    </div>

    <!-- New Message Modal (for admin to message students) -->
    <div id="new-message-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 600px;">
            <h3 style="color: #0288d1; margin-bottom: 1rem;"> New Message</h3>
            <div class="form-group" id="recipient-select-group">
                <label for="message-recipient">To *</label>
                <select id="message-recipient" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    <option value="">-- Select Recipient --</option>
                    <option value="admin">Mr Chung (Teacher)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="new-message-subject">Subject *</label>
                <input type="text" id="new-message-subject" placeholder="Subject..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
            </div>
            <div class="form-group">
                <label for="new-message-content">Message *</label>
                <textarea id="new-message-content" rows="5" placeholder="Type your message here..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideNewMessageModal()">Cancel</button>
                <button class="btn-save" style="background: #0288d1;" onclick="sendNewMessage()"> Send</button>
            </div>
        </div>
    </div>

    <!-- View Message Modal -->
    <div id="view-message-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 650px;">
            <div id="view-message-content"></div>
            <div class="modal-buttons" style="margin-top: 1.5rem; flex-wrap: wrap;">
                <button class="btn-cancel" onclick="hideViewMessageModal()">Close</button>
                <button id="btn-delete-message" class="btn" style="background: #dc3545; color: white;" onclick="deleteCurrentMessage()"> Delete</button>
                <button id="btn-reply-message" class="btn-save" style="background: #0288d1;" onclick="replyToMessage()"> Reply</button>
            </div>
        </div>
    </div>

    <!-- Flag Question Modal -->
    <div id="flag-question-modal" class="modal-overlay">
        <div class="modal-box flag-modal-content">
            <h3> Flag Question</h3>
            <div id="flag-question-preview" class="flag-question-preview">
                <strong>Question:</strong> <span id="flag-question-title"></span>
            </div>
            <div class="form-group">
                <label for="flag-comment-input">What's wrong with this question?</label>
                <textarea id="flag-comment-input" placeholder="Describe the issue (e.g., incorrect answer, unclear wording, typo, etc.)..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideFlagModal()">Cancel</button>
                <button class="btn-save" onclick="submitFlag()" style="background: #ff9800;"> Submit Flag</button>
            </div>
        </div>
    </div>

    <!-- Question Popup Modal -->
    <div id="question-popup-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 1rem;">
                <h3 style="margin: 0; color: #1976d2;"> Original Question</h3>
                <button class="btn" style="background: #666; color: white; padding: 8px 16px;" onclick="hideQuestionPopup()"> Close</button>
            </div>
            <div id="question-popup-content" style="padding: 1rem 0;"></div>
        </div>
    </div>

    <!-- Account Settings Modal -->
    <div id="account-settings-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 500px;">
            <h3 style="color: #1976d2; margin-bottom: 1.5rem;"> Account Settings</h3>
            
            <!-- Account Info Section -->
            <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">Email</div>
                <div id="settings-email" style="font-weight: 600; color: #333;">Loading...</div>
            </div>

            <!-- Student Names Section -->
            <div id="settings-students-section" style="margin-bottom: 1.5rem;">
                <h4 style="color: #333; margin-bottom: 1rem; font-size: 1rem;"> Students</h4>
                <div id="settings-students-list">
                    <!-- Student entries will be populated here -->
                </div>
            </div>

            <!-- Change Password Section -->
            <div style="border-top: 1px solid #e0e0e0; padding-top: 1.5rem; margin-bottom: 1.5rem;">
                <h4 style="color: #333; margin-bottom: 1rem; font-size: 1rem;"> Change Password</h4>
                <div class="form-group">
                    <label for="settings-new-password">New Password</label>
                    <input type="password" id="settings-new-password" class="auth-input" placeholder="Enter new password" style="margin-bottom: 10px;">
                </div>
                <div class="form-group">
                    <label for="settings-confirm-password">Confirm New Password</label>
                    <input type="password" id="settings-confirm-password" class="auth-input" placeholder="Confirm new password">
                </div>
                <button class="btn" style="background: #f57c00; color: white; width: 100%; margin-top: 1rem;" onclick="changePassword()">
                     Update Password
                </button>
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideAccountSettings()">Close</button>
                <button class="btn-save" onclick="saveAccountSettings()"> Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Welcome Back / New Questions Modal -->
    <div id="welcome-back-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 450px; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
            <h3 style="color: #667eea; margin-bottom: 0.5rem;" id="welcome-back-title">Welcome Back!</h3>
            <p style="color: #666; margin-bottom: 1.5rem;" id="welcome-back-subtitle">Good to see you again</p>
            
            <!-- New Questions Info -->
            <div id="new-questions-info" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                <div style="font-size: 2.5rem; font-weight: 700; color: #2e7d32;" id="new-questions-count">0</div>
                <div style="font-size: 1rem; color: #2e7d32; font-weight: 600;">New Questions Added!</div>
                <div style="font-size: 0.85rem; color: #666; margin-top: 5px;" id="new-questions-since">Since your last visit</div>
            </div>
            
            <!-- Quick Stats -->
            <div id="welcome-quick-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 1.5rem;">
                <div style="background: #f5f5f5; padding: 10px; border-radius: 8px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: #667eea;" id="welcome-stat-streak">0</div>
                    <div style="font-size: 0.75rem; color: #888;">Day Streak</div>
                </div>
                <div style="background: #f5f5f5; padding: 10px; border-radius: 8px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: #4CAF50;" id="welcome-stat-rating">1000</div>
                    <div style="font-size: 0.75rem; color: #888;">Your Rating</div>
                </div>
                <div style="background: #f5f5f5; padding: 10px; border-radius: 8px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: #ff9800;" id="welcome-stat-review">0</div>
                    <div style="font-size: 0.75rem; color: #888;">Due for Review</div>
                </div>
            </div>
            
            <div class="modal-buttons" style="flex-direction: column; gap: 10px;">
                <button class="btn-save" onclick="practiceNewQuestions()" style="width: 100%; background: linear-gradient(135deg, #667eea, #764ba2); padding: 12px;" id="btn-practice-new">
                     Practice New Questions
                </button>
                <button class="btn-cancel" onclick="hideWelcomeModal()" style="width: 100%;">
                    Maybe Later
                </button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // FORCE FRESH CONTENT - AGGRESSIVE CACHE BUSTING
        // =====================================================
        (function() {
            'use strict';
            
            // Generate unique version based on current timestamp
            const currentTimestamp = Date.now();
            const storedTimestamp = sessionStorage.getItem('page_load_time');
            
            // Display version for debugging (can be removed in production)
            const versionDisplay = document.getElementById('version-display');
            if (versionDisplay) {
                versionDisplay.textContent = 'v' + currentTimestamp;
            }
            
            // Method 1: Force reload if this is a new browser session
            if (!storedTimestamp) {
                sessionStorage.setItem('page_load_time', currentTimestamp);
                
                // Check if URL already has cache buster
                const urlParams = new URLSearchParams(window.location.search);
                if (!urlParams.has('_cb')) {
                    // Add cache buster to URL and reload
                    const newUrl = window.location.pathname + '?_cb=' + currentTimestamp + window.location.hash;
                    window.location.replace(newUrl);
                    return; // Stop execution
                }
            }
            
            // Method 2: Fetch the page with no-cache headers to check for updates
            // BUT skip if user is in admin mode (editing questions)
            fetch(window.location.pathname, {
                method: 'HEAD',
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            }).then(response => {
                const serverLastModified = response.headers.get('Last-Modified');
                const serverETag = response.headers.get('ETag');
                const serverVersion = serverLastModified || serverETag || '';
                
                const cachedVersion = localStorage.getItem('server_file_version');
                
                if (cachedVersion && serverVersion && cachedVersion !== serverVersion) {
                    // Check if user is in admin mode - don't auto-reload if they're working on a question
                    const isInAdminMode = document.getElementById('view-admin') && 
                                          !document.getElementById('view-admin').classList.contains('hidden');
                    const hasUnsavedWork = window.adminBlocks && window.adminBlocks.length > 0;
                    const isSaving = window.isSavingQuestion;
                    
                    if (isInAdminMode || hasUnsavedWork || isSaving) {
                        console.log('New version available but user is in admin mode - skipping auto-reload');
                        localStorage.setItem('server_file_version', serverVersion);
                        return;
                    }
                    
                    // Server file has changed - force hard reload
                    console.log('New version detected! Reloading...');
                    localStorage.setItem('server_file_version', serverVersion);
                    
                    // Clear all caches
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                        });
                    }
                    
                    // Force reload bypassing cache
                    window.location.href = window.location.pathname + '?_cb=' + Date.now();
                } else if (!cachedVersion && serverVersion) {
                    localStorage.setItem('server_file_version', serverVersion);
                }
            }).catch(err => {
                console.log('Version check failed:', err);
            });
            
            // Method 3: Clear service worker caches if present
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => {
                        registration.unregister();
                    });
                });
            }
        })();

        // =====================================================
        // GLOBAL STATE & UTILITIES
        // =====================================================
        window.adminBlocks = [];
        window.isAdminUser = false;
        window.worksheetItems = [];
        window.currentActiveTab = 'cer';
        window.currentMode = 'oeq';
        window.currentMcqLevel = 'P3';
        window.currentOeqLevel = 'P6';
        window.currentMcqTopic = '';
        window.editingQuestionId = null;

        // Change level (works for both OEQ and MCQ modes)
        window.changeLevel = function(level) {
            if (window.currentMode === 'mcq') {
                window.currentMcqLevel = level;
                // Update MCQ level select if it exists
                const mcqSelect = document.getElementById('mcq-level-select');
                if (mcqSelect) mcqSelect.value = level;
                renderMcqHeaders();
            } else {
                window.currentOeqLevel = level;
                // Refresh OEQ tabs with new level
                renderOeqHeaderTabs(window.currentActiveTab || 'cer');
                // Update sidebar
                updateOeqSidebar(window.currentActiveTab || 'cer');
            }
            
            // Update the header level select
            const headerSelect = document.getElementById('header-level-select');
            if (headerSelect) headerSelect.value = level;
            
            // Save preference
            localStorage.setItem('selectedLevel', level);
        };

        // Initialize level from localStorage
        window.initLevel = function() {
            const savedLevel = localStorage.getItem('selectedLevel');
            if (savedLevel) {
                window.currentOeqLevel = savedLevel;
                window.currentMcqLevel = savedLevel;
                const headerSelect = document.getElementById('header-level-select');
                if (headerSelect) headerSelect.value = savedLevel;
                const mcqSelect = document.getElementById('mcq-level-select');
                if (mcqSelect) mcqSelect.value = savedLevel;
            }
        };

        window.mcqCurriculum = {
            'P3': ['Living and non-living things', 'Materials', 'Life Cycles', 'Magnets'],
            'P4': ['Plant Systems', 'Human Body Systems', 'Matter and its 3 States', 'Light', 'Heat'],
            'P5': ['Water and its 3 States', 'Plant Reproduction', 'Human Reproduction', 'Human and Plant Respiration', 'Human and Plant Transport', 'Electrical Systems'],
            'P6': ['Forces', 'Energy in Food', 'Energy Conversion', 'Living Together', 'Food Chains and Webs', 'Humans and the Environment']
        };

        window.typeColors = {
            'cer': '#AEC6CF',
            'definition': '#ADD8E6',
            'single-relationship': '#FFB7B2',
            'double-relationship': '#FFDAC1',
            'fairness': '#E2F0CB',
            'reliability': '#C7CEEA',
            'accuracy': '#FDFD96',
            'constant-variable': '#B5EAD7',
            'explanation': '#FF9AA2',
            'control-setup': '#E0BBE4',
            'admin': '#ffd1dc',
            'worksheet': '#e3f2fd',
            'saved-worksheets': '#e8f5e9',
            'practice': '#f3e5f5',
            'inbox': '#e1f5fe',
            'lessons': '#fff3e0',
            'lesson-detail': '#fff3e0',
            'flagged': '#fff3e0',
            'leaderboard': '#FFD700',
            'student-progress': '#e3f2fd',
            'my-progress': '#667eea',
            // MCQ level colors
            'mcq-P3': '#FFB3BA',
            'mcq-P4': '#BAFFC9',
            'mcq-P5': '#BAE1FF',
            'mcq-P6': '#FFFFBA'
        };

        // =====================================================
        // QUESTION COUNT PER TAB TYPE
        // =====================================================
        
        // Count questions in a specific tab type
        window.countQuestionsForType = function(tabType) {
            const viewContainer = document.getElementById(`view-${tabType}`);
            if (!viewContainer) return 0;
            
            // Count all question-container elements within this view
            const questions = viewContainer.querySelectorAll('.question-container');
            return questions.length;
        };

        // Get all OEQ tab types with their question counts
        window.getOeqTabsWithCounts = function() {
            const tabTypes = [
                { type: 'cer', name: 'CER' },
                { type: 'definition', name: 'Definition' },
                { type: 'single-relationship', name: 'Single Relationship' },
                { type: 'double-relationship', name: 'Double Relationship' },
                { type: 'fairness', name: 'Fairness' },
                { type: 'reliability', name: 'Reliability' },
                { type: 'accuracy', name: 'Accuracy' },
                { type: 'constant-variable', name: 'Constant Variable' },
                { type: 'explanation', name: 'Explanation' },
                { type: 'control-setup', name: 'Control Set-up' }
            ];
            
            return tabTypes.map(tab => ({
                ...tab,
                count: countQuestionsForType(tab.type)
            }));
        };

        // Render OEQ header tabs with question count badges
        window.renderOeqHeaderTabs = function(activeType = 'cer') {
            const container = document.getElementById('header-tabs-container');
            if (!container) return;
            
            const tabs = getOeqTabsWithCounts();
            
            container.innerHTML = tabs.map(tab => {
                const activeClass = tab.type === activeType ? 'active' : '';
                const countBadge = `<span class="tab-count-badge">${tab.count}</span>`;
                return `<button class="tab-btn ${activeClass}" data-type="${tab.type}" onclick="switchTab('${tab.type}', this)">${tab.name}${countBadge}</button>`;
            }).join('');
        };

        // Update tab counts (call after adding/removing questions)
        window.updateTabCounts = function() {
            // Only update if in OEQ mode
            if (window.currentMode !== 'mcq') {
                const activeTab = window.currentActiveTab || 'cer';
                renderOeqHeaderTabs(activeTab);
            }
        };

        // =====================================================
        // OEQ TOPICS BY TAB TYPE
        // =====================================================
        // Maps tab type to array of {name, id} objects
        window.oeqTopics = {
            'cer': [
                {name: 'Heat', id: 'heat'},
                {name: 'Light', id: 'light'},
                {name: 'Materials', id: 'materials'}
            ],
            'definition': [
                {name: 'Evaporation', id: 'def-evap'}
            ],
            'single-relationship': [
                {name: 'Forces', id: 'sr-forces'}
            ],
            'double-relationship': [],
            'fairness': [],
            'reliability': [],
            'accuracy': [],
            'constant-variable': [],
            'explanation': [],
            'control-setup': []
        };

        window.currentOeqTab = 'cer';
        window.currentOeqTopic = 'heat';

        // Update OEQ sidebar topics based on current tab
        window.updateOeqSidebar = function(tabType) {
            const nav = document.getElementById('oeq-topic-nav');
            const title = document.getElementById('oeq-title');
            if (!nav) return;

            const topics = window.oeqTopics[tabType] || [];
            const tabNames = {
                'cer': 'CER Questions',
                'definition': 'Definition',
                'single-relationship': 'Single Relationship',
                'double-relationship': 'Double Relationship',
                'fairness': 'Fairness',
                'reliability': 'Reliability',
                'accuracy': 'Accuracy',
                'constant-variable': 'Constant Variable',
                'explanation': 'Explanation',
                'control-setup': 'Control Set-up'
            };

            if (title) {
                title.textContent = tabNames[tabType] || 'OEQ Questions';
            }

            if (topics.length === 0) {
                nav.innerHTML = '<p style="color: #888; font-size: 0.9rem;">Coming Soon</p>';
                return;
            }

            nav.innerHTML = topics.map((topic, idx) => {
                const activeClass = idx === 0 ? 'active' : '';
                // Count questions for this specific topic
                const questionCount = countQuestionsForTopic(tabType, topic.id);
                const countBadge = `<span class="sidebar-topic-badge">${questionCount}</span>`;
                return `<button id="btn-${topic.id}" class="${activeClass}" onclick="selectOeqTopic('${tabType}', '${topic.id}', this)">${topic.name}${countBadge}</button>`;
            }).join('');

            // Select first topic by default
            if (topics.length > 0) {
                selectOeqTopic(tabType, topics[0].id, nav.querySelector('button'));
            }
        };

        // Count questions for a specific topic within a tab type
        window.countQuestionsForTopic = function(tabType, topicId) {
            const viewContainer = document.getElementById(`view-${tabType}`);
            if (!viewContainer) return 0;
            
            const topicContainer = viewContainer.querySelector(`#topic-${topicId}`);
            if (!topicContainer) return 0;
            
            return topicContainer.querySelectorAll('.question-container').length;
        };

        // Select an OEQ topic and show its content
        window.selectOeqTopic = function(tabType, topicId, btn) {
            window.currentOeqTopic = topicId;

            // Update button states
            const nav = document.getElementById('oeq-topic-nav');
            if (nav) {
                nav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                if (btn) btn.classList.add('active');
            }

            // Hide all topic contents within the current view
            const viewContainer = document.getElementById(`view-${tabType}`);
            if (viewContainer) {
                viewContainer.querySelectorAll('.topic-content').forEach(tc => {
                    tc.classList.add('hidden');
                });

                // Show the selected topic - try multiple ID patterns
                let targetTopic = viewContainer.querySelector(`#topic-${topicId}`);
                if (targetTopic) {
                    targetTopic.classList.remove('hidden');
                }
            }
        };

        // =====================================================
        // WORKSHEET FUNCTIONALITY - FIXED
        // =====================================================

        // Load worksheet from localStorage on page load
        function loadWorksheetFromStorage() {
            try {
                const stored = localStorage.getItem('worksheetItems');
                if (stored) {
                    window.worksheetItems = JSON.parse(stored);
                } else {
                    window.worksheetItems = [];
                }
            } catch (e) {
                console.error('Error loading worksheet:', e);
                window.worksheetItems = [];
            }
        }

        // Save worksheet to localStorage
        function saveWorksheetToStorage() {
            try {
                localStorage.setItem('worksheetItems', JSON.stringify(window.worksheetItems));
            } catch (e) {
                console.error('Error saving worksheet:', e);
            }
        }

        // Toggle question in/out of worksheet
        window.toggleWorksheetItem = function (btn) {
            const container = btn.closest('.question-container');
            if (!container) {
                alert("Could not find question container.");
                return;
            }

            // Get or create a unique ID for this question
            let qId = container.id;
            if (!qId) {
                qId = 'q-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                container.id = qId;
            }

            const existingIndex = window.worksheetItems.findIndex(item => item.id === qId);

            if (existingIndex > -1) {
                // Remove from worksheet
                window.worksheetItems.splice(existingIndex, 1);
                btn.innerHTML = ' Worksheet';
                btn.classList.remove('added');
            } else {
                // Add to worksheet - capture the full question content
                const questionTitle = container.querySelector('h3')?.textContent || 'Question';

                // Clone the container to capture its content
                const clone = container.cloneNode(true);

                // Remove UI elements from the clone
                clone.querySelectorAll('.admin-controls, .worksheet-control-bar, .controls, .feedback-icon').forEach(el => el.remove());

                // Reset any input states in the clone
                clone.querySelectorAll('.answer-input').forEach(input => {
                    input.disabled = false;
                    input.value = '';
                    input.style.borderBottomColor = '';
                });

                // Get the cleaned HTML
                const cleanedHtml = clone.innerHTML;

                window.worksheetItems.push({
                    id: qId,
                    title: questionTitle,
                    html: cleanedHtml,
                    addedAt: new Date().toISOString()
                });

                btn.innerHTML = ' Added';
                btn.classList.add('added');
            }

            saveWorksheetToStorage();
            updateWorksheetUI();
        };

        // Update worksheet display
        window.updateWorksheetUI = function () {
            const countBadge = document.getElementById('worksheet-count');
            const container = document.getElementById('worksheet-questions-container');
            const emptyMsg = document.getElementById('worksheet-empty-msg');

            if (!container) return;

            const count = window.worksheetItems.length;

            // Update badge count
            if (countBadge) {
                countBadge.textContent = count;
            }
            // Update header badge
            updateWorksheetCountHeader();

            // Clear existing question cards (keep empty message)
            const existingCards = container.querySelectorAll('.worksheet-question-card');
            existingCards.forEach(card => card.remove());

            if (count === 0) {
                if (emptyMsg) emptyMsg.style.display = 'block';
            } else {
                if (emptyMsg) emptyMsg.style.display = 'none';

                // Render each worksheet item
                window.worksheetItems.forEach((item, idx) => {
                    const card = document.createElement('div');
                    card.className = 'worksheet-question-card';
                    card.setAttribute('data-worksheet-id', item.id);

                    card.innerHTML = `
                        <span class="question-number">Question ${idx + 1}</span>
                        <div class="remove-btn-wrapper">
                            <button class="btn-worksheet-remove" onclick="removeFromWorksheet('${item.id}')"> Remove</button>
                        </div>
                        <div class="worksheet-question-content" style="margin-top: 1rem;">
                            ${item.html}
                        </div>
                    `;

                    container.appendChild(card);
                });
            }

            // Update all add/remove buttons in main content
            syncWorksheetButtons();
        };

        // Sync worksheet buttons with current state
        function syncWorksheetButtons() {
            document.querySelectorAll('.question-container').forEach(container => {
                const qId = container.id;
                const btn = container.querySelector('.btn-worksheet-add');
                if (btn && qId) {
                    const isInWorksheet = window.worksheetItems.some(item => item.id === qId);
                    if (isInWorksheet) {
                        btn.innerHTML = ' Added';
                        btn.classList.add('added');
                    } else {
                        btn.innerHTML = ' Worksheet';
                        btn.classList.remove('added');
                    }
                }
            });
        }

        // Remove question from worksheet
        window.removeFromWorksheet = function (qId) {
            window.worksheetItems = window.worksheetItems.filter(item => item.id !== qId);
            saveWorksheetToStorage();
            updateWorksheetUI();
        };

        // Clear all worksheet items
        window.clearWorksheet = function () {
            if (!confirm("Are you sure you want to clear all questions from your worksheet?")) return;
            window.worksheetItems = [];
            saveWorksheetToStorage();
            updateWorksheetUI();
        };

        // Quick Generate Worksheet - generates 30 questions prioritizing unanswered and ELO-matched questions
        window.quickGenerateWorksheet = async function() {
            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) {
                    alert("Please log in to use Quick Generate.");
                    return;
                }

                // Show loading message
                const loadingMsg = document.createElement('div');
                loadingMsg.id = 'quick-generate-loading';
                loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
                loadingMsg.innerHTML = '<div style="font-size: 1.2rem; margin-bottom: 1rem;"> Generating worksheet...</div><div style="color: #666;">Loading questions and student data...</div>';
                document.body.appendChild(loadingMsg);

                // Get student data and answered questions
                let studentIndex = 0;
                let studentRating = RATING_CONFIG.DEFAULT_STUDENT_RATING;
                let answeredQuestions = new Set();

                // Try to get current student from practice state, otherwise use first student
                if (window.practiceState?.currentStudent) {
                    studentIndex = window.practiceState.currentStudent.index;
                } else {
                    // Load user data to get first student
                    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                    const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        const students = data.students || [];
                        if (students.length > 0 && students[0].rating !== undefined) {
                            studentRating = students[0].rating;
                        }
                    }
                }

                // Get student rating
                if (window.getStudentRating) {
                    const ratingData = await window.getStudentRating(studentIndex);
                    studentRating = ratingData.rating || RATING_CONFIG.DEFAULT_STUDENT_RATING;
                }

                // Load answered questions
                const answeredKey = `answered_${user.uid}_${studentIndex}`;
                const answeredStored = localStorage.getItem(answeredKey);
                if (answeredStored) {
                    answeredQuestions = new Set(JSON.parse(answeredStored));
                }

                // Load question ratings
                if (window.loadQuestionRatings) {
                    await window.loadQuestionRatings();
                }

                loadingMsg.innerHTML = '<div style="font-size: 1.2rem; margin-bottom: 1rem;"> Generating worksheet...</div><div style="color: #666;">Fetching questions from database...</div>';

                // Get all questions from Firestore
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const questionsRef = collection(window.db_fs, "custom_questions");
                const snapshot = await getDocs(questionsRef);

                const allQuestions = [];
                const firestoreQuestionIds = new Set();
                
                // First, add questions from Firestore
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const qId = `q-${doc.id}`;
                    firestoreQuestionIds.add(qId);
                    
                    // Check if question is already in worksheet
                    const isInWorksheet = window.worksheetItems.some(item => item.id === qId);
                    
                    // Check if question has been answered
                    const isAnswered = answeredQuestions.has(qId);
                    
                    // Get question rating
                    const qRatingData = window.getQuestionRating ? window.getQuestionRating(qId) : { rating: RATING_CONFIG.DEFAULT_QUESTION_RATING };
                    const questionRating = qRatingData.rating || RATING_CONFIG.DEFAULT_QUESTION_RATING;
                    
                    // Calculate if in growth zone
                    let inGrowthZone = false;
                    if (window.isInGrowthZone) {
                        inGrowthZone = window.isInGrowthZone(studentRating, questionRating);
                    }
                    
                    // Calculate expected success rate
                    let expectedSuccess = 0.5;
                    if (window.calculateExpectedSuccess) {
                        expectedSuccess = window.calculateExpectedSuccess(studentRating, questionRating);
                    }
                    
                    allQuestions.push({
                        id: qId,
                        firestoreId: doc.id,
                        title: data.title || 'Question',
                        html: data.html || '',
                        topic: data.topic || 'general',
                        category: data.category || 'mcq',
                        level: data.level || 'P6',
                        isAnswered: isAnswered,
                        questionRating: questionRating,
                        inGrowthZone: inGrowthZone,
                        expectedSuccess: expectedSuccess,
                        isInWorksheet: isInWorksheet,
                        fromFirestore: true
                    });
                });

                // Also gather questions from DOM that aren't in Firestore (hardcoded questions)
                const domQuestions = document.querySelectorAll('.question-container[id]');
                domQuestions.forEach(container => {
                    const qId = container.id;
                    // Skip if already in Firestore questions or doesn't have a valid ID
                    if (!qId || firestoreQuestionIds.has(qId) || qId.startsWith('q-custom-')) {
                        return;
                    }
                    
                    // Check if question is already in worksheet
                    const isInWorksheet = window.worksheetItems.some(item => item.id === qId);
                    
                    // Check if question has been answered
                    const isAnswered = answeredQuestions.has(qId);
                    
                    // Get question rating
                    const qRatingData = window.getQuestionRating ? window.getQuestionRating(qId) : { rating: RATING_CONFIG.DEFAULT_QUESTION_RATING };
                    const questionRating = qRatingData.rating || RATING_CONFIG.DEFAULT_QUESTION_RATING;
                    
                    // Calculate if in growth zone
                    let inGrowthZone = false;
                    if (window.isInGrowthZone) {
                        inGrowthZone = window.isInGrowthZone(studentRating, questionRating);
                    }
                    
                    // Calculate expected success rate
                    let expectedSuccess = 0.5;
                    if (window.calculateExpectedSuccess) {
                        expectedSuccess = window.calculateExpectedSuccess(studentRating, questionRating);
                    }
                    
                    // Get question title
                    const questionTitle = container.querySelector('h3')?.textContent || 'Question';
                    
                    allQuestions.push({
                        id: qId,
                        firestoreId: null,
                        title: questionTitle,
                        html: container.innerHTML,
                        topic: 'general',
                        category: 'mcq',
                        level: 'P6',
                        isAnswered: isAnswered,
                        questionRating: questionRating,
                        inGrowthZone: inGrowthZone,
                        expectedSuccess: expectedSuccess,
                        isInWorksheet: isInWorksheet,
                        fromFirestore: false,
                        domElement: container
                    });
                });

                loadingMsg.innerHTML = '<div style="font-size: 1.2rem; margin-bottom: 1rem;"> Generating worksheet...</div><div style="color: #666;">Selecting best questions for you...</div>';

                // Sort questions by priority:
                // 1. Not in worksheet already
                // 2. Not answered (unanswered first)
                // 3. In growth zone (ELO-matched)
                // 4. Closest to optimal challenge (55% expected success)
                const sortedQuestions = allQuestions
                    .filter(q => !q.isInWorksheet) // Exclude questions already in worksheet
                    .sort((a, b) => {
                        // Priority 1: Unanswered questions first
                        if (a.isAnswered !== b.isAnswered) {
                            return a.isAnswered ? 1 : -1;
                        }
                        
                        // Priority 2: Growth zone questions
                        if (a.inGrowthZone !== b.inGrowthZone) {
                            return a.inGrowthZone ? -1 : 1;
                        }
                        
                        // Priority 3: Closest to optimal challenge (55% expected success)
                        const optimalExpected = 0.55;
                        const aDiff = Math.abs(a.expectedSuccess - optimalExpected);
                        const bDiff = Math.abs(b.expectedSuccess - optimalExpected);
                        return aDiff - bDiff;
                    });

                // Select top 30 questions
                const selectedQuestions = sortedQuestions.slice(0, 30);

                if (selectedQuestions.length === 0) {
                    loadingMsg.remove();
                    alert("No new questions available to add. All questions are either already in your worksheet or you've completed them all!");
                    return;
                }

                loadingMsg.innerHTML = '<div style="font-size: 1.2rem; margin-bottom: 1rem;"> Generating worksheet...</div><div style="color: #666;">Adding questions to worksheet...</div>';

                // Add questions to worksheet
                // First, clear existing worksheet if user wants
                if (window.worksheetItems.length > 0) {
                    if (!confirm(`You currently have ${window.worksheetItems.length} questions in your worksheet. Quick Generate will add ${selectedQuestions.length} new questions. Continue?`)) {
                        loadingMsg.remove();
                        return;
                    }
                }

                // Add each question to worksheet
                for (const question of selectedQuestions) {
                    // Check if question container exists in DOM
                    const questionContainer = document.getElementById(question.id);
                    
                    if (questionContainer) {
                        // Question exists in DOM, use existing toggleWorksheetItem logic
                        const btn = questionContainer.querySelector('.btn-worksheet-add');
                        if (btn && !window.worksheetItems.some(item => item.id === question.id)) {
                            // Simulate adding to worksheet
                            const questionTitle = questionContainer.querySelector('h3')?.textContent || question.title;
                            
                            // Clone the container to capture its content
                            const clone = questionContainer.cloneNode(true);
                            
                            // Remove UI elements from the clone
                            clone.querySelectorAll('.admin-controls, .worksheet-control-bar, .controls, .feedback-icon').forEach(el => el.remove());
                            
                            // Reset any input states in the clone
                            clone.querySelectorAll('.answer-input').forEach(input => {
                                input.disabled = false;
                                input.value = '';
                                input.style.borderBottomColor = '';
                            });
                            
                            // Get the cleaned HTML
                            const cleanedHtml = clone.innerHTML;
                            
                            window.worksheetItems.push({
                                id: question.id,
                                title: questionTitle,
                                html: cleanedHtml,
                                addedAt: new Date().toISOString()
                            });
                            
                            // Update button state
                            if (btn) {
                                btn.innerHTML = ' Added';
                                btn.classList.add('added');
                            }
                        }
                    } else {
                        // Question not in DOM, create worksheet item from stored data
                        if (!window.worksheetItems.some(item => item.id === question.id)) {
                            // Process HTML similar to how it's done in loadCustomQuestions
                            let processedHtml = question.html;
                            
                            // Fix Dropbox image URLs
                            processedHtml = processedHtml.replace(/src="(https:\/\/www\.dropbox\.com\/scl\/[^"]+)"/g, (match, url) => {
                                let fixedUrl = url.replace(/[?&]dl=[01]/, '&raw=1');
                                if (!fixedUrl.includes('raw=1')) {
                                    fixedUrl += (fixedUrl.includes('?') ? '&' : '?') + 'raw=1';
                                }
                                return `src="${fixedUrl}"`;
                            });
                            
                            // Remove controls/buttons from HTML
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = processedHtml;
                            tempDiv.querySelectorAll('.controls, .admin-controls, .worksheet-control-bar, .feedback-icon').forEach(el => el.remove());
                            tempDiv.querySelectorAll('button.submit-btn, button.next-btn, button.print-btn, button.btn-primary').forEach(el => el.remove());
                            tempDiv.querySelectorAll('.explanation-box').forEach(el => {
                                el.style.display = 'none';
                            });
                            tempDiv.querySelectorAll('.video-container').forEach(el => {
                                el.style.display = 'none';
                                el.classList.add('hidden-until-answered');
                            });
                            processedHtml = tempDiv.innerHTML;
                            
                            window.worksheetItems.push({
                                id: question.id,
                                title: question.title,
                                html: processedHtml,
                                addedAt: new Date().toISOString()
                            });
                        }
                    }
                }

                // Save and update UI
                saveWorksheetToStorage();
                updateWorksheetUI();

                loadingMsg.remove();
                
                const unansweredCount = selectedQuestions.filter(q => !q.isAnswered).length;
                const growthZoneCount = selectedQuestions.filter(q => q.inGrowthZone).length;
                
                alert(` Worksheet generated successfully!\n\nAdded ${selectedQuestions.length} questions:\n- ${unansweredCount} new questions (not yet attempted)\n- ${growthZoneCount} questions matched to your skill level`);
                
            } catch (e) {
                console.error("Error generating worksheet:", e);
                const loadingMsg = document.getElementById('quick-generate-loading');
                if (loadingMsg) loadingMsg.remove();
                alert("Error generating worksheet: " + e.message);
            }
        };

        // Helper function to get topic and rating for a question
        async function getQuestionInfo(questionId) {
            let topic = 'General';
            let rating = RATING_CONFIG.DEFAULT_QUESTION_RATING;
            
            // Try to find the question in the DOM
            const questionElement = document.getElementById(questionId);
            if (questionElement) {
                // Try to find topic from parent containers
                const mcqParent = questionElement.closest('[id^="topic-mcq-"]');
                if (mcqParent) {
                    const topicId = mcqParent.id.replace('topic-mcq-', '');
                    // Find which level this topic belongs to
                    if (window.mcqCurriculum) {
                        for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                            const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                            if (matchingTopic) {
                                topic = matchingTopic;
                                break;
                            }
                        }
                    }
                } else {
                    // Check for OEQ topic container
                    const topicParent = questionElement.closest('[id^="topic-"]');
                    if (topicParent) {
                        const topicId = topicParent.id.replace('topic-', '');
                        // Remove view prefix if present
                        const cleanTopicId = topicId.replace(/^(mcq|oeq|cer)-/, '');
                        topic = cleanTopicId.charAt(0).toUpperCase() + cleanTopicId.slice(1).replace(/-/g, ' ');
                    }
                }
                
                // Get rating
                if (window.getQuestionRating) {
                    const ratingData = window.getQuestionRating(questionId);
                    rating = ratingData.rating || RATING_CONFIG.DEFAULT_QUESTION_RATING;
                }
            } else {
                // Question not in DOM - might be from Firestore
                // Check if it's a custom question (starts with q-)
                if (questionId.startsWith('q-')) {
                    const firestoreId = questionId.replace('q-', '');
                    try {
                        // Try to get topic from Firestore
                        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                        const questionDoc = await getDoc(doc(window.db_fs, "custom_questions", firestoreId));
                        if (questionDoc.exists()) {
                            const data = questionDoc.data();
                            topic = data.topic || 'General';
                        }
                    } catch (e) {
                        console.warn("Could not fetch question topic from Firestore:", e);
                    }
                }
                
                // Get rating
                if (window.getQuestionRating) {
                    const ratingData = window.getQuestionRating(questionId);
                    rating = ratingData.rating || RATING_CONFIG.DEFAULT_QUESTION_RATING;
                }
            }
            
            return { topic, rating };
        }

        // Export worksheet as PDF
        window.exportWorksheet = async function () {
            if (window.worksheetItems.length === 0) {
                alert("Your worksheet is empty! Add some questions first.");
                return;
            }

            // Load question ratings if not already loaded
            if (window.loadQuestionRatings && !window.questionRatings || Object.keys(window.questionRatings || {}).length === 0) {
                await window.loadQuestionRatings();
            }

            // Create summary table page
            const summaryContainer = document.createElement('div');
            summaryContainer.id = 'worksheet-summary-page';
            summaryContainer.style.cssText = 'page-break-after: always; padding: 2rem; background: white;';
            
            // Create summary table
            let summaryTableHTML = `
                <div style="margin-bottom: 2rem;">
                    <h2 style="text-align: center; margin-bottom: 1.5rem; color: #333;">Worksheet Summary</h2>
                    <table style="width: 100%; border-collapse: collapse; border: 2px solid #333; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="border: 1px solid #333; padding: 12px; text-align: center; font-weight: bold; width: 10%;">Question #</th>
                                <th style="border: 1px solid #333; padding: 12px; text-align: center; font-weight: bold; width: 20%;">Rating</th>
                                <th style="border: 1px solid #333; padding: 12px; text-align: left; font-weight: bold; width: 40%;">Topic</th>
                                <th style="border: 1px solid #333; padding: 12px; text-align: center; font-weight: bold; width: 30%;">Marks</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add rows for each question (await all async calls)
            const questionInfos = await Promise.all(
                window.worksheetItems.map(item => getQuestionInfo(item.id))
            );
            
            questionInfos.forEach((questionInfo, idx) => {
                const questionNum = idx + 1;
                const topic = questionInfo.topic;
                const rating = questionInfo.rating;
                
                summaryTableHTML += `
                    <tr>
                        <td style="border: 1px solid #333; padding: 10px; text-align: center; font-weight: 600;">${questionNum}</td>
                        <td style="border: 1px solid #333; padding: 10px; text-align: center;">${rating}</td>
                        <td style="border: 1px solid #333; padding: 10px; text-align: left;">${topic}</td>
                        <td style="border: 1px solid #333; padding: 10px; text-align: center;">_____</td>
                    </tr>
                `;
            });
            
            // Add total row
            const totalRating = questionInfos.reduce((sum, info) => sum + info.rating, 0);
            const avgRating = Math.round(totalRating / window.worksheetItems.length);
            
            summaryTableHTML += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #f9f9f9; font-weight: bold;">
                                <td style="border: 1px solid #333; padding: 12px; text-align: center;" colspan="2">Total Questions: ${window.worksheetItems.length}</td>
                                <td style="border: 1px solid #333; padding: 12px; text-align: center;" colspan="2">Average Rating: ${avgRating}</td>
                            </tr>
                            <tr style="background: #f9f9f9;">
                                <td style="border: 1px solid #333; padding: 12px; text-align: center; font-weight: bold;" colspan="4">Total Marks: ________ / ________</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            summaryContainer.innerHTML = summaryTableHTML;
            
            // Insert summary page at the beginning of the worksheet view
            const worksheetView = document.getElementById('view-worksheet');
            if (worksheetView) {
                // Insert after the header but before questions container
                const worksheetContainer = document.getElementById('worksheet-questions-container');
                if (worksheetContainer && worksheetContainer.parentNode) {
                    worksheetContainer.parentNode.insertBefore(summaryContainer, worksheetContainer);
                } else {
                    // Fallback: insert at the beginning of worksheet view
                    const firstChild = worksheetView.firstElementChild;
                    if (firstChild) {
                        worksheetView.insertBefore(summaryContainer, firstChild);
                    } else {
                        worksheetView.appendChild(summaryContainer);
                    }
                }
            }

            // Add print class to body
            document.body.classList.add('print-worksheet');

            // Show worksheet header
            const header = document.getElementById('worksheet-header');
            if (header) header.style.display = 'block';

            // Trigger print
            window.print();

            // Clean up after print
            setTimeout(() => {
                document.body.classList.remove('print-worksheet');
                if (header) header.style.display = 'none';
                // Remove summary page
                if (summaryContainer && summaryContainer.parentNode) {
                    summaryContainer.parentNode.removeChild(summaryContainer);
                }
            }, 100);
        };

        // =====================================================
        // WORKSHEET SAVE/LOAD SYSTEM
        // =====================================================

        window.showSaveWorksheetModal = function() {
            if (window.worksheetItems.length === 0) {
                alert("Your worksheet is empty! Add some questions first.");
                return;
            }

            const modal = document.getElementById('save-worksheet-modal');
            const adminFields = document.getElementById('admin-lesson-fields');
            const title = document.getElementById('save-worksheet-modal-title');
            
            // Show admin fields if admin user
            if (window.isAdminUser) {
                adminFields.classList.remove('hidden');
                title.textContent = ' Save Worksheet / Create Lesson';
            } else {
                adminFields.classList.add('hidden');
                title.textContent = ' Save Worksheet';
            }
            
            // Clear previous inputs
            document.getElementById('worksheet-name-input').value = '';
            document.getElementById('worksheet-description-input').value = '';
            document.getElementById('lesson-video-input').value = '';
            document.getElementById('share-as-lesson-checkbox').checked = false;
            
            modal.classList.add('visible');
            document.getElementById('worksheet-name-input').focus();
            
            // Close when clicking outside modal box
            modal.onclick = function(e) {
                if (e.target === modal) {
                    hideSaveWorksheetModal();
                }
            };
        };

        window.hideSaveWorksheetModal = function() {
            document.getElementById('save-worksheet-modal').classList.remove('visible');
        };

        window.saveWorksheet = async function() {
            const name = document.getElementById('worksheet-name-input').value.trim();
            const description = document.getElementById('worksheet-description-input').value.trim();
            
            if (!name) {
                alert("Please enter a name for your worksheet.");
                document.getElementById('worksheet-name-input').focus();
                return;
            }
            
            const isAdmin = window.isAdminUser;
            const shareAsLesson = isAdmin && document.getElementById('share-as-lesson-checkbox').checked;
            const videoUrl = document.getElementById('lesson-video-input').value.trim();
            
            if (shareAsLesson && !videoUrl) {
                alert("Please provide a video link for the lesson.");
                document.getElementById('lesson-video-input').focus();
                return;
            }
            
            try {
                const { doc, setDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const worksheetId = 'ws_' + Date.now();
                const user = window.auth.currentUser;
                
                // Prepare question data (store question IDs and HTML)
                const questionsData = window.worksheetItems.map(item => ({
                    id: item.id,
                    title: item.title,
                    html: item.html
                }));
                
                if (shareAsLesson) {
                    // Save as shared lesson (visible to all)
                    const lessonData = {
                        name: name,
                        description: description,
                        videoUrl: convertYoutubeUrl(videoUrl),
                        questions: questionsData,
                        questionCount: questionsData.length,
                        createdBy: user.email,
                        createdAt: new Date().toISOString(),
                        type: 'lesson'
                    };
                    
                    await setDoc(doc(window.db_fs, "shared_lessons", worksheetId), lessonData);
                    alert("Lesson created and shared with all students! ");
                } else {
                    // Save as personal worksheet
                    const worksheetData = {
                        name: name,
                        description: description,
                        questions: questionsData,
                        questionCount: questionsData.length,
                        userId: user.uid,
                        userEmail: user.email,
                        createdAt: new Date().toISOString(),
                        type: 'worksheet'
                    };
                    
                    await setDoc(doc(window.db_fs, "user_worksheets", worksheetId), worksheetData);
                    alert("Worksheet saved successfully! ");
                }
                
                hideSaveWorksheetModal();
                
                // Optionally clear the current worksheet
                if (confirm("Would you like to clear your current worksheet?")) {
                    window.worksheetItems = [];
                    saveWorksheetToStorage();
                    updateWorksheetUI();
                }
                
            } catch (e) {
                console.error("Save worksheet error:", e);
                alert("Error saving worksheet: " + e.message);
            }
        };

        // Convert YouTube URL to embed format
        window.convertYoutubeUrl = function(url) {
            if (!url) return url;
            if (url.includes('youtube.com/watch?v=')) {
                return url.replace('watch?v=', 'embed/');
            } else if (url.includes('youtu.be/')) {
                return url.replace('youtu.be/', 'youtube.com/embed/');
            }
            return url;
        };

        // Load user's saved worksheets
        window.loadSavedWorksheets = async function() {
            const container = document.getElementById('saved-worksheets-container');
            const emptyMsg = document.getElementById('saved-worksheets-empty-msg');
            
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const user = window.auth.currentUser;
                if (!user) return;
                
                // Fetch all worksheets and filter client-side
                const snapshot = await getDocs(collection(window.db_fs, "user_worksheets"));
                
                const worksheets = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId === user.uid) {
                        worksheets.push({ id: doc.id, ...data });
                    }
                });
                
                if (worksheets.length === 0) {
                    container.innerHTML = '';
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'inbox-empty';
                    emptyDiv.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <p>No saved worksheets yet</p>
                    `;
                    container.appendChild(emptyDiv);
                    return;
                }
                
                container.innerHTML = '';
                
                // Sort by date descending
                worksheets.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                worksheets.forEach(ws => {
                    const date = new Date(ws.createdAt).toLocaleDateString();
                    const card = document.createElement('div');
                    card.className = 'saved-worksheet-card';
                    card.innerHTML = `
                        <h4> ${ws.name}</h4>
                        <div class="meta">${ws.questionCount} questions  Saved on ${date}</div>
                        ${ws.description ? `<p style="color: #666; margin-bottom: 1rem;">${ws.description}</p>` : ''}
                        <div class="actions" style="flex-wrap: wrap;">
                            <button class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;" onclick="attemptWorksheet('${ws.id}')"> Attempt</button>
                            <button class="btn" style="background: #1976d2; color: white;" onclick="loadWorksheetToActive('${ws.id}')"> Load</button>
                            <button class="btn" style="background: #28a745; color: white;" onclick="viewSavedWorksheet('${ws.id}')"> View</button>
                            <button class="btn" style="background: #dc3545; color: white;" onclick="deleteSavedWorksheet('${ws.id}')"> Delete</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
                
            } catch (e) {
                console.error("Load worksheets error:", e);
                container.innerHTML = '<p style="color: #dc3545;">Error loading worksheets. Please try again.</p>';
            }
        };

        window.refreshSavedWorksheets = function() {
            loadSavedWorksheets();
        };

        // Load a saved worksheet into the active worksheet
        window.loadWorksheetToActive = async function(worksheetId) {
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const docRef = doc(window.db_fs, "user_worksheets", worksheetId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert("Worksheet not found.");
                    return;
                }
                
                const data = docSnap.data();
                
                if (window.worksheetItems.length > 0) {
                    if (!confirm(`This will replace your current worksheet (${window.worksheetItems.length} items). Continue?`)) {
                        return;
                    }
                }
                
                window.worksheetItems = data.questions.map(q => ({
                    id: q.id,
                    title: q.title,
                    html: q.html
                }));
                
                saveWorksheetToStorage();
                updateWorksheetUI();
                
                alert(`Loaded "${data.name}" with ${data.questions.length} questions!`);
                switchTab('worksheet');
                
            } catch (e) {
                console.error("Load worksheet error:", e);
                alert("Error loading worksheet: " + e.message);
            }
        };

        // View a saved worksheet (read-only)
        window.viewSavedWorksheet = async function(worksheetId) {
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const docRef = doc(window.db_fs, "user_worksheets", worksheetId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert("Worksheet not found.");
                    return;
                }
                
                const data = docSnap.data();
                
                // Open in new window for viewing/printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${data.name}</title>
                        <style>
                            body { font-family: 'Segoe UI', sans-serif; padding: 2rem; max-width: 900px; margin: 0 auto; }
                            h1 { color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 10px; }
                            .question { background: #f5f5f5; padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid #1976d2; }
                            .question h3 { margin-top: 0; color: #333; }
                            .header-info { display: flex; justify-content: space-between; margin-bottom: 2rem; }
                            .answer-input { border: none; border-bottom: 2px solid #333; background: transparent; min-width: 100px; }
                            @media print { button { display: none; } }
                        </style>
                    </head>
                    <body>
                        <h1> ${data.name}</h1>
                        <div class="header-info">
                            <span>Name: _______________________</span>
                            <span>Date: _______________</span>
                            <span>Score: _____ / ${data.questionCount}</span>
                        </div>
                        ${data.questions.map((q, i) => `
                            <div class="question">
                                <h3>Question ${i + 1}: ${q.title}</h3>
                                <div>${q.html}</div>
                            </div>
                        `).join('')}
                        <button onclick="window.print()" style="margin-top: 2rem; padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer;"> Print</button>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
            } catch (e) {
                console.error("View worksheet error:", e);
                alert("Error viewing worksheet: " + e.message);
            }
        };

        // Delete a saved worksheet
        window.deleteSavedWorksheet = async function(worksheetId) {
            if (!confirm("Are you sure you want to delete this worksheet? This cannot be undone.")) {
                return;
            }
            
            try {
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                await deleteDoc(doc(window.db_fs, "user_worksheets", worksheetId));
                
                alert("Worksheet deleted.");
                loadSavedWorksheets();
                
            } catch (e) {
                console.error("Delete worksheet error:", e);
                alert("Error deleting worksheet: " + e.message);
            }
        };

        // =====================================================
        // WORKSHEET ATTEMPT SYSTEM
        // =====================================================
        
        window.currentAttempt = {
            worksheetId: null,
            worksheetName: null,
            questions: [],
            currentIndex: 0,
            answers: [] // {questionId, questionTitle, topic, type, studentAnswer, correctAnswer, correct}
        };

        // Start attempting a worksheet
        window.attemptWorksheet = async function(worksheetId) {
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const docRef = doc(window.db_fs, "user_worksheets", worksheetId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert("Worksheet not found.");
                    return;
                }
                
                const data = docSnap.data();
                
                // Initialize attempt state
                window.currentAttempt = {
                    worksheetId: worksheetId,
                    worksheetName: data.name,
                    questions: data.questions || [],
                    currentIndex: 0,
                    answers: data.questions.map((q, i) => ({
                        questionId: q.id || `q-${i}`,
                        questionTitle: q.title || `Question ${i + 1}`,
                        topic: q.topic || 'N/A',
                        type: q.type || 'unknown',
                        studentAnswer: null,
                        correctAnswer: null,
                        correct: false
                    }))
                };
                
                // Update UI
                document.getElementById('attempt-worksheet-title').textContent = ` ${data.name}`;
                
                // Show modal
                document.getElementById('worksheet-attempt-modal').classList.add('visible');
                
                // Show first question
                showAttemptQuestion(0);
                
            } catch (e) {
                console.error("Error loading worksheet for attempt:", e);
                alert("Error loading worksheet: " + e.message);
            }
        };

        // Show a specific question in the attempt
        window.showAttemptQuestion = function(index) {
            const attempt = window.currentAttempt;
            const total = attempt.questions.length;
            
            if (index < 0 || index >= total) return;
            
            attempt.currentIndex = index;
            
            // Update progress
            document.getElementById('attempt-worksheet-progress').textContent = `Question ${index + 1} of ${total}`;
            document.getElementById('attempt-progress-bar').style.width = `${((index + 1) / total) * 100}%`;
            
            // Update navigation buttons
            document.getElementById('attempt-prev-btn').style.display = index === 0 ? 'none' : 'inline-block';
            document.getElementById('attempt-next-btn').classList.toggle('hidden', index === total - 1);
            document.getElementById('attempt-submit-btn').classList.toggle('hidden', index !== total - 1);
            
            // Render question
            const question = attempt.questions[index];
            const container = document.getElementById('attempt-question-container');
            
            // Get previous answer if any
            const previousAnswer = attempt.answers[index]?.studentAnswer;
            
            container.innerHTML = `
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #667eea;">
                    <h4 style="margin: 0 0 1rem 0; color: #333;">Question ${index + 1}: ${question.title || 'Untitled'}</h4>
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">
                        <span style="background: #e3f2fd; padding: 2px 8px; border-radius: 4px; margin-right: 8px;">Topic: ${question.topic || 'N/A'}</span>
                        <span style="background: #f3e5f5; padding: 2px 8px; border-radius: 4px;">Type: ${question.type || 'N/A'}</span>
                    </div>
                    <div id="attempt-question-content" style="margin-bottom: 1.5rem;">
                        ${question.html || '<p>No question content</p>'}
                    </div>
                    ${renderAttemptAnswerInput(question, index, previousAnswer)}
                </div>
            `;
            
            // Initialize MCQ radio buttons with previous selection
            if (previousAnswer && question.type === 'mcq') {
                const radios = container.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => {
                    if (radio.value === previousAnswer) {
                        radio.checked = true;
                    }
                });
            }
        };

        // Render answer input based on question type
        window.renderAttemptAnswerInput = function(question, index, previousAnswer) {
            if (question.type === 'mcq') {
                // For MCQ, find the options in the HTML
                return `
                    <div style="background: white; padding: 1rem; border-radius: 8px; border: 2px solid #e0e0e0;">
                        <p style="font-weight: 600; margin-bottom: 0.5rem; color: #555;">Select your answer:</p>
                        <p style="font-size: 0.85rem; color: #888;">Click on an option above or in the question content</p>
                    </div>
                `;
            } else {
                // For other types, provide a text area
                return `
                    <div style="background: white; padding: 1rem; border-radius: 8px; border: 2px solid #e0e0e0;">
                        <p style="font-weight: 600; margin-bottom: 0.5rem; color: #555;">Your Answer:</p>
                        <textarea id="attempt-answer-${index}" 
                                  style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; resize: vertical;"
                                  placeholder="Type your answer here..."
                                  onchange="saveAttemptAnswer(${index}, this.value)">${previousAnswer || ''}</textarea>
                    </div>
                `;
            }
        };

        // Save answer for a question
        window.saveAttemptAnswer = function(index, answer) {
            if (window.currentAttempt.answers[index]) {
                window.currentAttempt.answers[index].studentAnswer = answer;
            }
        };

        // Navigate to previous question
        window.prevAttemptQuestion = function() {
            const index = window.currentAttempt.currentIndex;
            if (index > 0) {
                // Save current answer first
                saveCurrentAttemptAnswer();
                showAttemptQuestion(index - 1);
            }
        };

        // Navigate to next question
        window.nextAttemptQuestion = function() {
            const attempt = window.currentAttempt;
            const index = attempt.currentIndex;
            
            // Save current answer first
            saveCurrentAttemptAnswer();
            
            if (index < attempt.questions.length - 1) {
                showAttemptQuestion(index + 1);
            }
        };

        // Save the current question's answer
        window.saveCurrentAttemptAnswer = function() {
            const attempt = window.currentAttempt;
            const index = attempt.currentIndex;
            const question = attempt.questions[index];
            
            if (question.type === 'mcq') {
                // Find selected MCQ option
                const container = document.getElementById('attempt-question-container');
                const selected = container.querySelector('input[type="radio"]:checked');
                if (selected) {
                    attempt.answers[index].studentAnswer = selected.value || selected.nextSibling?.textContent?.trim();
                    attempt.answers[index].correct = selected.dataset.correct === 'true';
                }
            } else {
                // Get text answer
                const textarea = document.getElementById(`attempt-answer-${index}`);
                if (textarea) {
                    attempt.answers[index].studentAnswer = textarea.value;
                    // For non-MCQ, we can't automatically determine correctness
                    // Mark as correct if they provided an answer (teacher can review)
                    attempt.answers[index].correct = textarea.value.trim().length > 0;
                }
            }
        };

        // Submit the worksheet attempt
        window.submitWorksheetAttempt = async function() {
            // Save last answer
            saveCurrentAttemptAnswer();
            
            const attempt = window.currentAttempt;
            
            // Check if all questions answered
            const unanswered = attempt.answers.filter(a => !a.studentAnswer || a.studentAnswer.trim() === '').length;
            if (unanswered > 0) {
                if (!confirm(`You have ${unanswered} unanswered question(s). Submit anyway?`)) {
                    return;
                }
            }
            
            try {
                // Calculate results for MCQ questions
                let correctCount = 0;
                attempt.answers.forEach((ans, idx) => {
                    const question = attempt.questions[idx];
                    if (question.type === 'mcq') {
                        // For MCQ, correctness was determined when selecting
                        if (ans.correct) correctCount++;
                    } else {
                        // For other types, mark as correct if answered
                        if (ans.studentAnswer && ans.studentAnswer.trim()) {
                            ans.correct = true;
                            correctCount++;
                        }
                    }
                });
                
                // Save the attempt to Firestore
                await saveWorksheetAttempt(
                    attempt.worksheetId,
                    attempt.worksheetName,
                    attempt.answers,
                    'completed'
                );
                
                // Show completion message
                const score = Math.round((correctCount / attempt.answers.length) * 100);
                const wrongCount = attempt.answers.length - correctCount;
                
                alert(`Worksheet submitted!\n\nScore: ${score}%\nCorrect: ${correctCount}/${attempt.answers.length}\nWrong: ${wrongCount}`);
                
                // Close modal
                document.getElementById('worksheet-attempt-modal').classList.remove('visible');
                
                // Reset attempt state
                window.currentAttempt = {
                    worksheetId: null,
                    worksheetName: null,
                    questions: [],
                    currentIndex: 0,
                    answers: []
                };
                
            } catch (e) {
                console.error("Error submitting worksheet:", e);
                alert("Error submitting worksheet: " + e.message);
            }
        };

        // Cancel worksheet attempt
        window.cancelWorksheetAttempt = function() {
            if (confirm("Are you sure you want to exit? Your progress will be lost.")) {
                document.getElementById('worksheet-attempt-modal').classList.remove('visible');
                window.currentAttempt = {
                    worksheetId: null,
                    worksheetName: null,
                    questions: [],
                    currentIndex: 0,
                    answers: []
                };
            }
        };

        // =====================================================
        // SHARED LESSONS SYSTEM
        // =====================================================

        window.loadSharedLessons = async function() {
            const container = document.getElementById('lessons-container');
            const emptyMsg = document.getElementById('lessons-empty-msg');
            
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const snapshot = await getDocs(collection(window.db_fs, "shared_lessons"));
                
                if (snapshot.empty) {
                    container.innerHTML = '';
                    container.appendChild(emptyMsg);
                    emptyMsg.style.display = 'block';
                    return;
                }
                
                emptyMsg.style.display = 'none';
                container.innerHTML = '';
                
                const lessons = [];
                snapshot.forEach(doc => {
                    lessons.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by date descending
                lessons.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                lessons.forEach(lesson => {
                    const date = new Date(lesson.createdAt).toLocaleDateString();
                    const card = document.createElement('div');
                    card.className = 'lesson-card';
                    card.onclick = () => openLesson(lesson.id);
                    card.innerHTML = `
                        <h4> ${lesson.name}</h4>
                        <div class="meta"> Video Lesson  ${lesson.questionCount} practice questions</div>
                        ${lesson.description ? `<p class="description">${lesson.description}</p>` : ''}
                        <span class="badge"> ${date}</span>
                        ${window.isAdminUser ? `<button class="btn" style="margin-left: 10px; background: #dc3545; color: white; padding: 3px 10px; font-size: 0.75rem;" onclick="event.stopPropagation(); deleteSharedLesson('${lesson.id}')"> Delete</button>` : ''}
                    `;
                    container.appendChild(card);
                });
                
            } catch (e) {
                console.error("Load lessons error:", e);
                container.innerHTML = '<p style="color: #dc3545;">Error loading lessons. Please try again.</p>';
            }
        };

        window.refreshSharedLessons = function() {
            loadSharedLessons();
        };

        window.openLesson = async function(lessonId) {
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const docRef = doc(window.db_fs, "shared_lessons", lessonId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert("Lesson not found.");
                    return;
                }
                
                const lesson = docSnap.data();
                const container = document.getElementById('lesson-detail-content');
                
                container.innerHTML = `
                    <h2 style="margin: 0 0 1rem; color: #e65100;"> ${lesson.name}</h2>
                    ${lesson.description ? `<p style="color: #666; margin-bottom: 1.5rem;">${lesson.description}</p>` : ''}
                    
                    <div class="lesson-video-container">
                        <iframe src="${lesson.videoUrl}" allowfullscreen></iframe>
                    </div>
                    
                    <div class="lesson-questions-section">
                        <h3> Practice Questions (${lesson.questionCount})</h3>
                        <div class="scroll-buttons-container">
                            <button class="scroll-btn" onclick="scrollToTop('lesson-questions-section')">
                                 Go to Top
                            </button>
                            <button class="scroll-btn" onclick="scrollToBottom('lesson-questions-section')">
                                 Go to Bottom
                            </button>
                        </div>
                        <div id="lesson-questions-list"></div>
                    </div>
                `;
                
                const questionsList = document.getElementById('lesson-questions-list');
                lesson.questions.forEach((q, i) => {
                    const qDiv = document.createElement('div');
                    qDiv.className = 'question-container';
                    qDiv.style.marginBottom = '1.5rem';
                    qDiv.style.background = 'white';
                    qDiv.style.padding = '1.5rem';
                    qDiv.style.borderRadius = '8px';
                    qDiv.style.borderLeft = '4px solid #f57c00';
                    qDiv.innerHTML = `
                        <h4 style="margin: 0 0 1rem; color: #333;">Question ${i + 1}: ${q.title}</h4>
                        <div class="question-body answer-template">${q.html}</div>
                    `;
                    questionsList.appendChild(qDiv);
                    
                    // Setup question functionality
                    if (window.setupQuestionFormGlobal) {
                        const bodyDiv = qDiv.querySelector('.question-body');
                        if (bodyDiv && bodyDiv.id) {
                            window.setupQuestionFormGlobal(bodyDiv.id);
                        }
                    }
                });
                
                // Add controls to lesson questions
                setTimeout(() => {
                    questionsList.querySelectorAll('.question-body').forEach(body => {
                        // Find MCQ containers and add check functionality
                        const mcqContainer = body.querySelector('.mcq-container');
                        if (mcqContainer) {
                            const existingBtn = body.querySelector('.submit-btn');
                            if (!existingBtn) {
                                const btn = document.createElement('button');
                                btn.className = 'btn btn-primary submit-btn';
                                btn.style.marginTop = '1rem';
                                btn.textContent = 'Check Answer';
                                btn.onclick = function() {
                                    const selected = mcqContainer.querySelector('input[type="radio"]:checked');
                                    if (!selected) {
                                        alert('Please select an answer.');
                                        return;
                                    }
                                    const isCorrect = selected.dataset.correct === 'true';
                                    
                                    // Show correct answer highlighting with icons inside options
                                    mcqContainer.querySelectorAll('label, .mcq-option').forEach(opt => {
                                        const radio = opt.querySelector('input');
                                        opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());
                                        
                                        if (radio && radio.dataset.correct === 'true') {
                                            opt.style.background = '#d4edda';
                                            opt.style.borderColor = '#28a745';
                                            const icon = document.createElement('span');
                                            icon.className = 'option-feedback-icon';
                                            icon.textContent = '';
                                            icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #28a745; margin-left: auto; padding-left: 10px;';
                                            opt.style.display = 'flex';
                                            opt.style.alignItems = 'center';
                                            opt.appendChild(icon);
                                        } else if (radio && radio.checked && !isCorrect) {
                                            opt.style.background = '#f8d7da';
                                            opt.style.borderColor = '#dc3545';
                                            const icon = document.createElement('span');
                                            icon.className = 'option-feedback-icon';
                                            icon.textContent = '';
                                            icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #dc3545; margin-left: auto; padding-left: 10px;';
                                            opt.style.display = 'flex';
                                            opt.style.alignItems = 'center';
                                            opt.appendChild(icon);
                                        }
                                    });
                                    
                                    // Disable all radios
                                    mcqContainer.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);
                                    btn.disabled = true;
                                    
                                    // Show explanation if exists
                                    const explanationBox = body.querySelector('.explanation-box');
                                    if (explanationBox) {
                                        explanationBox.style.display = 'block';
                                    }
                                };
                                body.appendChild(btn);
                            }
                        }
                    });
                }, 100);
                
                switchTab('lesson-detail');
                
            } catch (e) {
                console.error("Open lesson error:", e);
                alert("Error opening lesson: " + e.message);
            }
        };

        window.deleteSharedLesson = async function(lessonId) {
            if (!confirm("Are you sure you want to delete this lesson? This will remove it for all students.")) {
                return;
            }
            
            try {
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                await deleteDoc(doc(window.db_fs, "shared_lessons", lessonId));
                
                alert("Lesson deleted.");
                loadSharedLessons();
                
            } catch (e) {
                console.error("Delete lesson error:", e);
                alert("Error deleting lesson: " + e.message);
            }
        };

        // =====================================================
        // MULTI-STUDENT REGISTRATION
        // =====================================================
        
        window.studentEntryCount = 1;
        
        window.addStudentEntry = function() {
            const container = document.getElementById('students-container');
            const index = window.studentEntryCount++;
            
            const entry = document.createElement('div');
            entry.className = 'student-entry';
            entry.dataset.studentIndex = index;
            entry.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <input type="text" class="auth-input student-name" placeholder="Student's Name" style="flex: 1; margin-bottom: 0;">
                    <select class="auth-input student-level" style="width: 100px; margin-bottom: 0;">
                        <option value="">Level</option>
                        <option value="P3">P3</option>
                        <option value="P4">P4</option>
                        <option value="P5">P5</option>
                        <option value="P6">P6</option>
                    </select>
                    <button type="button" onclick="removeStudentEntry(${index})" style="background: #dc3545; color: white; border: none; border-radius: 8px; width: 35px; height: 35px; cursor: pointer; font-size: 1.2rem;"></button>
                </div>
            `;
            container.appendChild(entry);
        };
        
        window.removeStudentEntry = function(index) {
            const entry = document.querySelector(`.student-entry[data-student-index="${index}"]`);
            if (entry) entry.remove();
        };
        
        window.getStudentsData = function() {
            const students = [];
            document.querySelectorAll('.student-entry').forEach(entry => {
                const name = entry.querySelector('.student-name').value.trim();
                const level = entry.querySelector('.student-level').value;
                if (name && level) {
                    students.push({ name, level });
                }
            });
            return students;
        };

        // =====================================================
        // PRACTICE MODE
        // =====================================================
        
        window.practiceState = {
            currentStudent: null,
            questions: [],
            currentIndex: 0,
            correct: 0,
            wrong: 0,
            streak: 0,
            answeredQuestions: new Set(),
            wrongAnswersForReview: {} // {questionId: timestamp} - questions to review after 7 days
        };

        // =====================================================
        // ELO RATING SYSTEM FOR DELIBERATE PRACTICE
        // =====================================================
        // Based on Elo chess rating system adapted for education
        // Questions and students both have ratings
        // More attempts = more accurate ratings (confidence)
        
        // Rating constants
        const RATING_CONFIG = {
            DEFAULT_QUESTION_RATING: 1200,  // Starting difficulty for questions
            DEFAULT_STUDENT_RATING: 1000,   // Starting rating for students
            MIN_RATING: 400,                // Minimum possible rating
            MAX_RATING: 2400,               // Maximum possible rating
            K_FACTOR_BASE: 32,              // Base K-factor for rating changes
            K_FACTOR_MIN: 8,                // Minimum K-factor (after many attempts)
            GROWTH_ZONE_MIN: 0.35,          // Minimum expected success rate for growth zone
            GROWTH_ZONE_MAX: 0.75,          // Maximum expected success rate for growth zone
            CONFIDENCE_THRESHOLD: 20        // Number of attempts for full confidence
        };

        // Calculate expected probability of correct answer
        // Uses standard Elo formula: E = 1 / (1 + 10^((Rq - Rs) / 400))
        window.calculateExpectedSuccess = function(studentRating, questionRating) {
            const exponent = (questionRating - studentRating) / 400;
            return 1 / (1 + Math.pow(10, exponent));
        };

        // Calculate K-factor based on number of attempts (decreases with more data)
        window.calculateKFactor = function(attempts) {
            if (attempts <= 0) return RATING_CONFIG.K_FACTOR_BASE;
            
            // K-factor decreases as confidence increases
            const confidence = Math.min(attempts / RATING_CONFIG.CONFIDENCE_THRESHOLD, 1);
            return Math.max(
                RATING_CONFIG.K_FACTOR_MIN,
                RATING_CONFIG.K_FACTOR_BASE * (1 - confidence * 0.75)
            );
        };

        // Update ratings after an answer
        // Returns { newStudentRating, newQuestionRating, ratingChange }
        window.calculateRatingUpdate = function(studentRating, questionRating, isCorrect, studentAttempts, questionAttempts) {
            const expected = calculateExpectedSuccess(studentRating, questionRating);
            const actual = isCorrect ? 1 : 0;
            
            // Calculate K-factors
            const studentK = calculateKFactor(studentAttempts);
            const questionK = calculateKFactor(questionAttempts);
            
            // Calculate rating changes
            const studentChange = studentK * (actual - expected);
            const questionChange = -questionK * (actual - expected) * 0.5; // Questions change more slowly
            
            // Apply changes with bounds
            let newStudentRating = Math.round(studentRating + studentChange);
            let newQuestionRating = Math.round(questionRating + questionChange);
            
            // Enforce bounds
            newStudentRating = Math.max(RATING_CONFIG.MIN_RATING, Math.min(RATING_CONFIG.MAX_RATING, newStudentRating));
            newQuestionRating = Math.max(RATING_CONFIG.MIN_RATING, Math.min(RATING_CONFIG.MAX_RATING, newQuestionRating));
            
            return {
                newStudentRating,
                newQuestionRating,
                studentChange: Math.round(studentChange),
                questionChange: Math.round(questionChange),
                expected: Math.round(expected * 100)
            };
        };

        // Check if a question is in the student's growth zone
        window.isInGrowthZone = function(studentRating, questionRating) {
            const expected = calculateExpectedSuccess(studentRating, questionRating);
            return expected >= RATING_CONFIG.GROWTH_ZONE_MIN && expected <= RATING_CONFIG.GROWTH_ZONE_MAX;
        };

        // Get difficulty label based on expected success rate
        window.getDifficultyLabel = function(studentRating, questionRating) {
            const expected = calculateExpectedSuccess(studentRating, questionRating);
            
            if (expected >= 0.85) return { label: 'Easy', color: '#4CAF50', icon: '' };
            if (expected >= 0.70) return { label: 'Moderate', color: '#8BC34A', icon: '' };
            if (expected >= 0.50) return { label: 'Challenging', color: '#FF9800', icon: '' };
            if (expected >= 0.35) return { label: 'Hard', color: '#f44336', icon: '' };
            return { label: 'Very Hard', color: '#9C27B0', icon: '' };
        };

        // Get rating tier name
        window.getRatingTier = function(rating) {
            if (rating >= 2000) return { tier: 'Master', color: '#9C27B0' };
            if (rating >= 1600) return { tier: 'Expert', color: '#673AB7' };
            if (rating >= 1400) return { tier: 'Advanced', color: '#3F51B5' };
            if (rating >= 1200) return { tier: 'Intermediate', color: '#2196F3' };
            if (rating >= 1000) return { tier: 'Developing', color: '#4CAF50' };
            if (rating >= 800) return { tier: 'Beginner', color: '#FF9800' };
            return { tier: 'Novice', color: '#f44336' };
        };

        // Question ratings cache (loaded from Firebase)
        window.questionRatings = {};

        // Load question ratings from Firebase
        window.loadQuestionRatings = async function() {
            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) return;
                
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const ratingsRef = collection(window.db_fs, "question_ratings");
                const snapshot = await getDocs(ratingsRef);
                
                window.questionRatings = {};
                snapshot.forEach(doc => {
                    window.questionRatings[doc.id] = doc.data();
                });
                
                console.log(`Loaded ${Object.keys(window.questionRatings).length} question ratings`);
            } catch (e) {
                console.error("Error loading question ratings:", e);
            }
        };

        // Get rating for a specific question
        window.getQuestionRating = function(questionId) {
            if (window.questionRatings[questionId]) {
                return window.questionRatings[questionId];
            }
            return {
                rating: RATING_CONFIG.DEFAULT_QUESTION_RATING,
                attempts: 0,
                correctCount: 0,
                lastUpdated: null
            };
        };

        // Update question rating in Firebase
        window.updateQuestionRating = async function(questionId, newRating, isCorrect) {
            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) return;
                
                const { doc, setDoc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get current data
                const currentData = getQuestionRating(questionId);
                
                const updatedData = {
                    rating: newRating,
                    attempts: (currentData.attempts || 0) + 1,
                    correctCount: (currentData.correctCount || 0) + (isCorrect ? 1 : 0),
                    lastUpdated: new Date()
                };
                
                await setDoc(doc(window.db_fs, "question_ratings", questionId), updatedData);
                
                // Update local cache
                window.questionRatings[questionId] = updatedData;
            } catch (e) {
                console.error("Error updating question rating:", e);
            }
        };

        // Get student rating from Firebase
        window.getStudentRating = async function(studentIndex) {
            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) {
                    console.warn("Cannot get rating - no user or db");
                    return { rating: RATING_CONFIG.DEFAULT_STUDENT_RATING, attempts: 0 };
                }
                
                // Validate studentIndex
                if (typeof studentIndex !== 'number' || isNaN(studentIndex) || studentIndex < 0) {
                    console.warn("Invalid studentIndex:", studentIndex);
                    return { rating: RATING_CONFIG.DEFAULT_STUDENT_RATING, attempts: 0 };
                }
                
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    const students = data.students || [];
                    
                    if (students[studentIndex]) {
                        // Check if rating exists (could be 0, so check for undefined/null)
                        const rating = students[studentIndex].rating;
                        if (rating !== undefined && rating !== null) {
                            console.log("Loaded rating:", rating, "for student index:", studentIndex);
                            return {
                                rating: rating,
                                attempts: students[studentIndex].totalAttempts || 0
                            };
                        }
                    }
                }
                
                return {
                    rating: RATING_CONFIG.DEFAULT_STUDENT_RATING,
                    attempts: 0
                };
            } catch (e) {
                console.error("Error getting student rating:", e);
                return {
                    rating: RATING_CONFIG.DEFAULT_STUDENT_RATING,
                    attempts: 0
                };
            }
        };

        // Update student rating in Firebase
        window.updateStudentRating = async function(studentIndex, newRating, isCorrect) {
            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) {
                    console.warn("Cannot update rating - no user or db");
                    return;
                }
                
                // Validate studentIndex
                if (typeof studentIndex !== 'number' || isNaN(studentIndex) || studentIndex < 0) {
                    console.warn("Invalid studentIndex:", studentIndex);
                    return;
                }
                
                const { doc, getDoc, updateDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const userRef = doc(window.db_fs, "users", user.uid);
                const userDoc = await getDoc(userRef);
                
                let students = [];
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    students = data.students || [];
                }
                
                // Ensure student exists at this index
                if (!students[studentIndex]) {
                    // Create a placeholder student if needed
                    while (students.length <= studentIndex) {
                        students.push({ name: 'Student ' + (students.length + 1), level: 'P6' });
                    }
                }
                
                // Store starting rating if this is the first time the student gets a rating
                if (students[studentIndex].startingRating === undefined || students[studentIndex].startingRating === null) {
                    students[studentIndex].startingRating = RATING_CONFIG.DEFAULT_STUDENT_RATING;
                }
                
                // Update the student's rating data
                students[studentIndex].rating = Math.round(newRating);
                students[studentIndex].totalAttempts = (students[studentIndex].totalAttempts || 0) + 1;
                students[studentIndex].correctCount = (students[studentIndex].correctCount || 0) + (isCorrect ? 1 : 0);
                students[studentIndex].lastPractice = new Date().toISOString();
                
                // Save to Firebase
                await updateDoc(userRef, { students: students });
                
                console.log("Rating saved:", students[studentIndex].rating, "for student index:", studentIndex);
                
                // Update local state
                if (window.practiceState.currentStudent) {
                    window.practiceState.currentStudent.rating = Math.round(newRating);
                    window.practiceState.currentStudent.attempts = students[studentIndex].totalAttempts;
                }
            } catch (e) {
                console.error("Error updating student rating:", e);
            }
        };

        // Load and display leaderboard
        window.loadLeaderboard = async function() {
            const container = document.getElementById('leaderboard-container');
            if (!container) return;

            container.innerHTML = '<div class="placeholder-content" id="leaderboard-loading-msg"><p style="font-size: 1.2rem; color: #666;">Loading leaderboard...</p></div>';

            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Fetch all users
                const usersRef = collection(window.db_fs, "users");
                const snapshot = await getDocs(usersRef);
                
                const allStudents = [];
                
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    const students = userData.students || [];
                    const parentName = userData.parentName || userData.email || 'Unknown';
                    
                    students.forEach((student, index) => {
                        const currentRating = student.rating !== undefined && student.rating !== null 
                            ? student.rating 
                            : RATING_CONFIG.DEFAULT_STUDENT_RATING;
                        
                        // Get starting rating (stored or default to 1000)
                        const startingRating = student.startingRating !== undefined && student.startingRating !== null
                            ? student.startingRating
                            : RATING_CONFIG.DEFAULT_STUDENT_RATING;
                        
                        // Calculate improvement
                        const improvement = currentRating - startingRating;
                        
                        allStudents.push({
                            name: student.name || 'Student',
                            level: student.level || 'P6',
                            rating: currentRating,
                            startingRating: startingRating,
                            improvement: improvement,
                            attempts: student.totalAttempts || 0,
                            correctCount: student.correctCount || 0,
                            parentName: parentName,
                            userId: doc.id,
                            studentIndex: index
                        });
                    });
                });

                if (allStudents.length === 0) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #666;">No students found in the leaderboard.</p></div>';
                    return;
                }

                // Sort by rating (descending) for top ratings
                const sortedByRating = [...allStudents].sort((a, b) => b.rating - a.rating);
                
                // Sort by improvement (descending) for biggest improvement
                const sortedByImprovement = [...allStudents].sort((a, b) => b.improvement - a.improvement);
                
                // Get top 3 and biggest improvement
                const top1 = sortedByRating[0];
                const top2 = sortedByRating[1];
                const top3 = sortedByRating[2];
                const biggestImprovement = sortedByImprovement[0];

                // Build leaderboard HTML
                let leaderboardHTML = `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #333; margin-bottom: 1rem;"> Top Ratings</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                `;

                // Top 3 podium
                if (top3) {
                    leaderboardHTML += `
                        <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;"></div>
                            <div style="font-weight: bold; font-size: 1.2rem; margin-bottom: 0.5rem;">${top1.name}</div>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">${top1.level}</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333;">${top1.rating}</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">${top1.attempts} attempts</div>
                        </div>
                    `;
                }

                if (top2) {
                    leaderboardHTML += `
                        <div style="background: linear-gradient(135deg, #C0C0C0, #A8A8A8); padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(192, 192, 192, 0.3);">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;"></div>
                            <div style="font-weight: bold; font-size: 1.2rem; margin-bottom: 0.5rem;">${top2.name}</div>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">${top2.level}</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333;">${top2.rating}</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">${top2.attempts} attempts</div>
                        </div>
                    `;
                }

                if (top3) {
                    leaderboardHTML += `
                        <div style="background: linear-gradient(135deg, #CD7F32, #B87333); padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(205, 127, 50, 0.3);">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;"></div>
                            <div style="font-weight: bold; font-size: 1.2rem; margin-bottom: 0.5rem;">${top3.name}</div>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">${top3.level}</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333;">${top3.rating}</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">${top3.attempts} attempts</div>
                        </div>
                    `;
                }

                leaderboardHTML += `</div>`;

                // Biggest improvement
                if (biggestImprovement && biggestImprovement.improvement > 0) {
                    leaderboardHTML += `
                        <div style="background: linear-gradient(135deg, #4CAF50, #45a049); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                            <h3 style="color: white; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 2rem;"></span>
                                <span>Biggest Improvement</span>
                            </h3>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 1rem; align-items: center;">
                                <div style="font-size: 2.5rem;"></div>
                                <div>
                                    <div style="font-weight: bold; font-size: 1.3rem; color: white; margin-bottom: 0.3rem;">${biggestImprovement.name}</div>
                                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.9); margin-bottom: 0.5rem;">${biggestImprovement.level}</div>
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                        <div>
                                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">Starting Rating</div>
                                            <div style="font-size: 1.1rem; font-weight: bold; color: white;">${biggestImprovement.startingRating}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">Current Rating</div>
                                            <div style="font-size: 1.1rem; font-weight: bold; color: white;">${biggestImprovement.rating}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">Improvement</div>
                                            <div style="font-size: 1.1rem; font-weight: bold; color: #FFD700;">+${biggestImprovement.improvement}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Full leaderboard table
                leaderboardHTML += `
                    <h3 style="color: #333; margin-bottom: 1rem;"> Full Leaderboard</h3>
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                    <th style="padding: 12px; text-align: center; font-weight: bold; width: 60px;">Rank</th>
                                    <th style="padding: 12px; text-align: left; font-weight: bold;">Student</th>
                                    <th style="padding: 12px; text-align: center; font-weight: bold; width: 100px;">Level</th>
                                    <th style="padding: 12px; text-align: center; font-weight: bold; width: 120px;">Rating</th>
                                    <th style="padding: 12px; text-align: center; font-weight: bold; width: 120px;">Improvement</th>
                                    <th style="padding: 12px; text-align: center; font-weight: bold; width: 100px;">Attempts</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                sortedByRating.forEach((student, index) => {
                    const rank = index + 1;
                    let medalIcon = '';
                    let rowStyle = '';
                    
                    if (rank === 1) {
                        medalIcon = '';
                        rowStyle = 'background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));';
                    } else if (rank === 2) {
                        medalIcon = '';
                        rowStyle = 'background: linear-gradient(90deg, rgba(192, 192, 192, 0.1), rgba(192, 192, 192, 0.05));';
                    } else if (rank === 3) {
                        medalIcon = '';
                        rowStyle = 'background: linear-gradient(90deg, rgba(205, 127, 50, 0.1), rgba(205, 127, 50, 0.05));';
                    }
                    
                    const isBiggestImprovement = biggestImprovement && 
                        student.name === biggestImprovement.name && 
                        student.userId === biggestImprovement.userId &&
                        student.studentIndex === biggestImprovement.studentIndex;
                    
                    if (isBiggestImprovement && rank > 3) {
                        rowStyle += ' border-left: 4px solid #4CAF50;';
                    }

                    const clickableStyle = window.isAdminUser ? 'cursor: pointer; transition: background 0.2s;' : '';
                    const onClickHandler = window.isAdminUser ? `onclick="viewStudentProgress('${student.userId}', ${student.studentIndex}, '${student.name}')" onmouseover="this.style.background='rgba(102, 126, 234, 0.1)'" onmouseout="this.style.background='${rowStyle}'"` : '';
                    
                    leaderboardHTML += `
                        <tr style="${rowStyle} ${clickableStyle}" ${onClickHandler}>
                            <td style="padding: 12px; text-align: center; font-weight: bold;">
                                ${medalIcon || rank}
                            </td>
                            <td style="padding: 12px; text-align: left;">
                                <div style="font-weight: 600;">${student.name} ${window.isAdminUser ? '' : ''}</div>
                                ${isBiggestImprovement ? '<div style="font-size: 0.75rem; color: #4CAF50; margin-top: 2px;"> Biggest Improvement</div>' : ''}
                            </td>
                            <td style="padding: 12px; text-align: center;">${student.level}</td>
                            <td style="padding: 12px; text-align: center; font-weight: bold; color: #667eea;">${student.rating}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="color: ${student.improvement >= 0 ? '#4CAF50' : '#dc3545'}; font-weight: ${student.improvement !== 0 ? 'bold' : 'normal'};">
                                    ${student.improvement > 0 ? '+' : ''}${student.improvement}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center;">${student.attempts}</td>
                        </tr>
                    `;
                });

                leaderboardHTML += `
                            </tbody>
                        </table>
                    </div>
                `;

                container.innerHTML = leaderboardHTML;

            } catch (e) {
                console.error("Error loading leaderboard:", e);
                container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Error loading leaderboard. Please try again.</p></div>';
            }
        };

        // Load and display student's own progress
        window.loadMyProgress = async function() {
            const container = document.getElementById('my-progress-container');
            if (!container) return;

            // Reset header to default
            const progressHeader = document.querySelector('#view-my-progress h2');
            if (progressHeader) {
                progressHeader.innerHTML = ' My Progress';
            }

            container.innerHTML = '<div class="placeholder-content" id="my-progress-loading-msg"><p style="font-size: 1.2rem; color: #666;">Loading your progress...</p></div>';

            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Please log in to view your progress.</p></div>';
                    return;
                }

                const { doc, getDoc, collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get user data
                const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                if (!userDoc.exists()) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #666;">No progress data found.</p></div>';
                    return;
                }

                const userData = userDoc.data();
                const students = userData.students || [];
                const questionAttempts = userData.questionAttempts || {};

                // Handle student selection
                let selectedStudentIndex = 0;
                const studentSelect = document.getElementById('my-progress-student-select');
                const studentSelector = document.getElementById('my-progress-student-selector');
                
                if (students.length > 1) {
                    studentSelector.style.display = 'block';
                    if (studentSelect.value) {
                        selectedStudentIndex = parseInt(studentSelect.value, 10);
                    }
                    // Populate selector if empty
                    if (studentSelect.options.length <= 1) {
                        studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
                        students.forEach((student, idx) => {
                            const option = document.createElement('option');
                            option.value = idx;
                            option.textContent = `${student.name} (${student.level})`;
                            if (idx === 0) option.selected = true;
                            studentSelect.appendChild(option);
                        });
                    }
                } else {
                    studentSelector.style.display = 'none';
                }

                if (students.length === 0) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #666;">No student data found.</p></div>';
                    return;
                }

                const currentStudent = students[selectedStudentIndex];
                if (!currentStudent) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #666;">Student not found.</p></div>';
                    return;
                }

                const studentKey = `student_${selectedStudentIndex}`;
                const studentQuestionAttempts = questionAttempts[studentKey] || {};

                console.log("Student question attempts:", studentQuestionAttempts);
                console.log("Student key:", studentKey);

                // Get all questions from Firestore to determine topics
                const questionsSnapshot = await getDocs(collection(window.db_fs, "custom_questions"));
                const allQuestions = {};
                questionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const qId = `q-${doc.id}`;
                    allQuestions[qId] = {
                        id: qId,
                        title: data.title || 'Question',
                        topic: data.topic || 'General',
                        level: data.level || 'P6',
                        category: data.category || 'mcq'
                    };
                });

                // Also get questions from DOM (including hardcoded questions)
                document.querySelectorAll('.question-container[id]').forEach(container => {
                    const qId = container.id;
                    if (!allQuestions[qId]) {
                        // Try to determine topic from DOM
                        let topic = 'General';
                        const mcqParent = container.closest('[id^="topic-mcq-"]');
                        if (mcqParent) {
                            const topicId = mcqParent.id.replace('topic-mcq-', '');
                            if (window.mcqCurriculum) {
                                for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                                    const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                                    if (matchingTopic) {
                                        topic = matchingTopic;
                                        break;
                                    }
                                }
                            }
                        } else {
                            const topicParent = container.closest('[id^="topic-"]');
                            if (topicParent) {
                                const topicId = topicParent.id.replace('topic-', '').replace(/^(mcq|oeq|cer)-/, '');
                                topic = topicId.charAt(0).toUpperCase() + topicId.slice(1).replace(/-/g, ' ');
                            }
                        }
                        
                        allQuestions[qId] = {
                            id: qId,
                            title: container.querySelector('h3')?.textContent || 'Question',
                            topic: topic,
                            level: currentStudent.level || 'P6',
                            category: 'mcq'
                        };
                    }
                });

                // Also check for questions that have attempts but aren't in allQuestions yet
                Object.keys(studentQuestionAttempts).forEach(qId => {
                    if (!allQuestions[qId]) {
                        // Try to find in DOM
                        const container = document.getElementById(qId);
                        if (container) {
                            let topic = 'General';
                            const mcqParent = container.closest('[id^="topic-mcq-"]');
                            if (mcqParent) {
                                const topicId = mcqParent.id.replace('topic-mcq-', '');
                                if (window.mcqCurriculum) {
                                    for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                                        const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                                        if (matchingTopic) {
                                            topic = matchingTopic;
                                            break;
                                        }
                                    }
                                }
                            }
                            allQuestions[qId] = {
                                id: qId,
                                title: container.querySelector('h3')?.textContent || 'Question',
                                topic: topic,
                                level: currentStudent.level || 'P6',
                                category: 'mcq'
                            };
                        } else {
                            // Question not found, use generic info
                            allQuestions[qId] = {
                                id: qId,
                                title: 'Question',
                                topic: 'General',
                                level: currentStudent.level || 'P6',
                                category: 'mcq'
                            };
                        }
                    }
                });

                // Calculate topic mastery
                const topicStats = {};
                Object.keys(allQuestions).forEach(qId => {
                    const question = allQuestions[qId];
                    const topic = question.topic;
                    if (!topicStats[topic]) {
                        topicStats[topic] = { total: 0, attempted: 0, correct: 0, questions: [] };
                    }
                    topicStats[topic].total++;
                    
                    const attempt = studentQuestionAttempts[qId];
                    if (attempt) {
                        topicStats[topic].attempted += attempt.attempts;
                        topicStats[topic].correct += attempt.correct;
                        topicStats[topic].questions.push({
                            id: qId,
                            title: question.title,
                            attempts: attempt.attempts,
                            correct: attempt.correct,
                            successRate: attempt.attempts > 0 ? (attempt.correct / attempt.attempts) * 100 : 0
                        });
                    }
                });

                // Find weak questions (success rate < 50% and attempted at least once)
                const weakQuestions = [];
                Object.values(topicStats).forEach(topic => {
                    topic.questions.forEach(q => {
                        if (q.attempts > 0 && q.successRate < 50) {
                            weakQuestions.push(q);
                        }
                    });
                });
                weakQuestions.sort((a, b) => a.successRate - b.successRate);

                // Build progress HTML with beautiful pastel colors and emojis
                const totalAttempted = Object.values(studentQuestionAttempts).reduce((sum, a) => sum + (a.attempts || 0), 0);
                const totalCorrect = Object.values(studentQuestionAttempts).reduce((sum, a) => sum + (a.correct || 0), 0);
                const overallSuccess = totalAttempted > 0 ? (totalCorrect / totalAttempted * 100).toFixed(1) : 0;

                let progressHTML = `
                    <div style="margin-bottom: 2rem;">
                        <div style="background: linear-gradient(135deg, #a8e6cf, #dcedc8); padding: 2rem; border-radius: 16px; color: #2d5016; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <span style="font-size: 3rem;"></span>
                                <h3 style="margin: 0; font-size: 1.8rem; color: #2d5016;">${currentStudent.name}</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Level</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${currentStudent.level || 'N/A'}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Rating</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${currentStudent.rating || RATING_CONFIG.DEFAULT_STUDENT_RATING}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Total Attempts</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${currentStudent.totalAttempts || 0}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Overall Success</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${overallSuccess}%</div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span style="font-size: 2rem;"></span>
                            <h3 style="color: #333; margin: 0; font-size: 1.5rem;">Topic Mastery</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.2rem; margin-bottom: 2rem;">
                `;

                // Sort topics by mastery percentage
                const sortedTopics = Object.entries(topicStats).sort((a, b) => {
                    const masteryA = a[1].attempted > 0 ? (a[1].correct / a[1].attempted) * 100 : 0;
                    const masteryB = b[1].attempted > 0 ? (b[1].correct / b[1].attempted) * 100 : 0;
                    return masteryB - masteryA;
                });

                // Pastel color palette for topics
                const pastelColors = [
                    { bg: '#ffe0e6', border: '#ffb3c1', text: '#8b1538', icon: '' }, // Pink
                    { bg: '#e0f2f1', border: '#b2dfdb', text: '#004d40', icon: '' }, // Teal
                    { bg: '#fff3e0', border: '#ffe0b2', text: '#e65100', icon: '' }, // Orange
                    { bg: '#e8eaf6', border: '#c5cae9', text: '#1a237e', icon: '' }, // Indigo
                    { bg: '#f3e5f5', border: '#e1bee7', text: '#4a148c', icon: '' }, // Purple
                    { bg: '#e0f7fa', border: '#b2ebf2', text: '#006064', icon: '' }, // Cyan
                    { bg: '#fff8e1', border: '#ffecb3', text: '#f57f17', icon: '' }, // Yellow
                    { bg: '#fce4ec', border: '#f8bbd0', text: '#880e4f', icon: '' }, // Pink
                    { bg: '#e8f5e9', border: '#c8e6c9', text: '#1b5e20', icon: '' }, // Green
                    { bg: '#fff9c4', border: '#fff59d', text: '#f57f17', icon: '' }, // Yellow
                ];

                sortedTopics.forEach(([topic, stats], index) => {
                    const mastery = stats.attempted > 0 ? (stats.correct / stats.attempted) * 100 : 0;
                    const colorIndex = index % pastelColors.length;
                    const colors = pastelColors[colorIndex];
                    
                    let masteryIcon = '';
                    let masteryEmoji = '';
                    if (mastery >= 80) {
                        masteryIcon = '';
                        masteryEmoji = '';
                    } else if (mastery >= 50) {
                        masteryIcon = '';
                        masteryEmoji = '';
                    } else if (mastery > 0) {
                        masteryIcon = '';
                        masteryEmoji = '';
                    } else {
                        masteryIcon = '';
                        masteryEmoji = '';
                    }

                    const progressColor = mastery >= 80 ? '#4CAF50' : mastery >= 50 ? '#FF9800' : mastery > 0 ? '#FFC107' : '#9E9E9E';

                    progressHTML += `
                        <div style="background: ${colors.bg}; padding: 1.5rem; border-radius: 16px; border: 2px solid ${colors.border}; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.8rem;">${colors.icon}</span>
                                    <h4 style="margin: 0; font-size: 1.1rem; color: ${colors.text}; font-weight: 600;">${topic}</h4>
                                </div>
                                <span style="font-size: 1.8rem;">${masteryIcon}</span>
                            </div>
                            <div style="margin-bottom: 0.8rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem;">
                                    <span style="font-size: 0.9rem; color: ${colors.text}; font-weight: 500;">${masteryEmoji} Mastery</span>
                                    <span style="font-weight: bold; color: ${progressColor}; font-size: 1.2rem;">${mastery.toFixed(1)}%</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.6); height: 24px; border-radius: 12px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="background: linear-gradient(90deg, ${progressColor}, ${progressColor}cc); height: 100%; width: ${Math.max(mastery, 2)}%; transition: width 0.8s ease; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                                </div>
                            </div>
                            <div style="font-size: 0.85rem; color: ${colors.text}; margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid ${colors.border};">
                                <div style="display: flex; justify-content: space-between;">
                                    <span> ${stats.correct} / ${stats.attempted} correct</span>
                                    <span> ${stats.total} questions</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                progressHTML += `</div>`;

                // Weak Questions Section
                if (weakQuestions.length > 0) {
                    progressHTML += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span style="font-size: 2rem;"></span>
                            <h3 style="color: #333; margin: 0; font-size: 1.5rem;">Questions Needing Practice</h3>
                        </div>
                        <div style="background: linear-gradient(135deg, #fff5f5, #ffe0e0); border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; border: 2px solid #ffb3b3;">
                            <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f); padding: 1rem; color: white;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;"></span>
                                    <span style="font-weight: 600;">Focus on these to improve!</span>
                                </div>
                            </div>
                            <div style="padding: 1rem;">
                    `;

                    weakQuestions.slice(0, 10).forEach((q, idx) => {
                        const bgColor = idx % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'rgba(255,255,255,0.3)';
                        progressHTML += `
                            <div style="background: ${bgColor}; padding: 1rem; border-radius: 12px; margin-bottom: 0.8rem; border-left: 4px solid #ff6b6b;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <div style="font-weight: 600; color: #333; margin-bottom: 0.3rem;"> ${q.title}</div>
                                    </div>
                                    <div style="display: flex; gap: 1.5rem; align-items: center;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666;">Attempts</div>
                                            <div style="font-weight: bold; color: #333;">${q.attempts}</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666;">Success</div>
                                            <div style="font-weight: bold; color: #ff6b6b; font-size: 1.1rem;">${q.successRate.toFixed(1)}%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    progressHTML += `
                            </div>
                        </div>
                    `;
                } else {
                    progressHTML += `
                        <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 2rem; border-radius: 16px; text-align: center; border: 2px solid #4CAF50; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                            <p style="margin: 0; font-size: 1.2rem; color: #155724; font-weight: 600;">Excellent work! No weak questions found.</p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 1rem; color: #2e7d32;">Keep up the amazing progress! </p>
                        </div>
                    `;
                }

                container.innerHTML = progressHTML;

            } catch (e) {
                console.error("Error loading my progress:", e);
                container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Error loading progress. Please try again.</p></div>';
            }
        };

        // View student progress (Admin only) - Now uses the same view as My Progress
        window.viewStudentProgress = async function(userId, studentIndex, studentName) {
            if (!window.isAdminUser) return;
            
            try {
                // Switch to my-progress view
                const progressBtn = document.getElementById('btn-sidebar-my-progress');
                if (progressBtn) {
                    window.switchTab('my-progress', progressBtn);
                }

                const container = document.getElementById('my-progress-container');
                if (!container) {
                    alert("Progress view not found.");
                    return;
                }

                // Update header to show student name
                const progressHeader = document.querySelector('#view-my-progress h2');
                if (progressHeader) {
                    progressHeader.innerHTML = ` ${studentName}'s Progress`;
                }

                container.innerHTML = '<div class="placeholder-content" id="my-progress-loading-msg"><p style="font-size: 1.2rem; color: #666;">Loading student progress...</p></div>';

                const { doc, getDoc, collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get user data
                const userDoc = await getDoc(doc(window.db_fs, "users", userId));
                if (!userDoc.exists()) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Student data not found.</p></div>';
                    return;
                }

                const userData = userDoc.data();
                const students = userData.students || [];
                const questionAttempts = userData.questionAttempts || {};

                if (!students[studentIndex]) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Student not found.</p></div>';
                    return;
                }

                const currentStudent = students[studentIndex];
                const studentKey = `student_${studentIndex}`;
                const studentQuestionAttempts = questionAttempts[studentKey] || {};

                // Hide student selector for admin view
                const studentSelector = document.getElementById('my-progress-student-selector');
                if (studentSelector) {
                    studentSelector.style.display = 'none';
                }

                // Get all questions from Firestore to determine topics
                const questionsSnapshot = await getDocs(collection(window.db_fs, "custom_questions"));
                const allQuestions = {};
                questionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const qId = `q-${doc.id}`;
                    allQuestions[qId] = {
                        id: qId,
                        title: data.title || 'Question',
                        topic: data.topic || 'General',
                        level: data.level || 'P6',
                        category: data.category || 'mcq'
                    };
                });

                // Also get questions from DOM (including hardcoded questions)
                document.querySelectorAll('.question-container[id]').forEach(container => {
                    const qId = container.id;
                    if (!allQuestions[qId]) {
                        // Try to determine topic from DOM
                        let topic = 'General';
                        const mcqParent = container.closest('[id^="topic-mcq-"]');
                        if (mcqParent) {
                            const topicId = mcqParent.id.replace('topic-mcq-', '');
                            if (window.mcqCurriculum) {
                                for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                                    const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                                    if (matchingTopic) {
                                        topic = matchingTopic;
                                        break;
                                    }
                                }
                            }
                        } else {
                            const topicParent = container.closest('[id^="topic-"]');
                            if (topicParent) {
                                const topicId = topicParent.id.replace('topic-', '').replace(/^(mcq|oeq|cer)-/, '');
                                topic = topicId.charAt(0).toUpperCase() + topicId.slice(1).replace(/-/g, ' ');
                            }
                        }
                        
                        allQuestions[qId] = {
                            id: qId,
                            title: container.querySelector('h3')?.textContent || 'Question',
                            topic: topic,
                            level: currentStudent.level || 'P6',
                            category: 'mcq'
                        };
                    }
                });

                // Also check for questions that have attempts but aren't in allQuestions yet
                Object.keys(studentQuestionAttempts).forEach(qId => {
                    if (!allQuestions[qId]) {
                        // Try to find in DOM
                        const container = document.getElementById(qId);
                        if (container) {
                            let topic = 'General';
                            const mcqParent = container.closest('[id^="topic-mcq-"]');
                            if (mcqParent) {
                                const topicId = mcqParent.id.replace('topic-mcq-', '');
                                if (window.mcqCurriculum) {
                                    for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                                        const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                                        if (matchingTopic) {
                                            topic = matchingTopic;
                                            break;
                                        }
                                    }
                                }
                            }
                            allQuestions[qId] = {
                                id: qId,
                                title: container.querySelector('h3')?.textContent || 'Question',
                                topic: topic,
                                level: currentStudent.level || 'P6',
                                category: 'mcq'
                            };
                        } else {
                            // Question not found, use generic info
                            allQuestions[qId] = {
                                id: qId,
                                title: 'Question',
                                topic: 'General',
                                level: currentStudent.level || 'P6',
                                category: 'mcq'
                            };
                        }
                    }
                });

                // Calculate topic mastery
                const topicStats = {};
                Object.keys(allQuestions).forEach(qId => {
                    const question = allQuestions[qId];
                    const topic = question.topic;
                    if (!topicStats[topic]) {
                        topicStats[topic] = { total: 0, attempted: 0, correct: 0, questions: [] };
                    }
                    topicStats[topic].total++;
                    
                    const attempt = studentQuestionAttempts[qId];
                    if (attempt) {
                        topicStats[topic].attempted += attempt.attempts;
                        topicStats[topic].correct += attempt.correct;
                        topicStats[topic].questions.push({
                            id: qId,
                            title: question.title,
                            attempts: attempt.attempts,
                            correct: attempt.correct,
                            successRate: attempt.attempts > 0 ? (attempt.correct / attempt.attempts) * 100 : 0
                        });
                    }
                });

                // Find weak questions (success rate < 50% and attempted at least once)
                const weakQuestions = [];
                Object.values(topicStats).forEach(topic => {
                    topic.questions.forEach(q => {
                        if (q.attempts > 0 && q.successRate < 50) {
                            weakQuestions.push(q);
                        }
                    });
                });
                weakQuestions.sort((a, b) => a.successRate - b.successRate);

                // Build progress HTML with beautiful pastel colors and emojis (same as loadMyProgress)
                const totalAttempted = Object.values(studentQuestionAttempts).reduce((sum, a) => sum + (a.attempts || 0), 0);
                const totalCorrect = Object.values(studentQuestionAttempts).reduce((sum, a) => sum + (a.correct || 0), 0);
                const overallSuccess = totalAttempted > 0 ? (totalCorrect / totalAttempted * 100).toFixed(1) : 0;

                let progressHTML = `
                    <div style="margin-bottom: 2rem;">
                        <div style="background: linear-gradient(135deg, #a8e6cf, #dcedc8); padding: 2rem; border-radius: 16px; color: #2d5016; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <span style="font-size: 3rem;"></span>
                                <h3 style="margin: 0; font-size: 1.8rem; color: #2d5016;">${currentStudent.name}</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Level</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${currentStudent.level || 'N/A'}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Rating</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${currentStudent.rating || RATING_CONFIG.DEFAULT_STUDENT_RATING}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Total Attempts</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${currentStudent.totalAttempts || 0}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Overall Success</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${overallSuccess}%</div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span style="font-size: 2rem;"></span>
                            <h3 style="color: #333; margin: 0; font-size: 1.5rem;">Topic Mastery</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.2rem; margin-bottom: 2rem;">
                `;

                // Sort topics by mastery percentage
                const sortedTopics = Object.entries(topicStats).sort((a, b) => {
                    const masteryA = a[1].attempted > 0 ? (a[1].correct / a[1].attempted) * 100 : 0;
                    const masteryB = b[1].attempted > 0 ? (b[1].correct / b[1].attempted) * 100 : 0;
                    return masteryB - masteryA;
                });

                // Pastel color palette for topics
                const pastelColors = [
                    { bg: '#ffe0e6', border: '#ffb3c1', text: '#8b1538', icon: '' }, // Pink
                    { bg: '#e0f2f1', border: '#b2dfdb', text: '#004d40', icon: '' }, // Teal
                    { bg: '#fff3e0', border: '#ffe0b2', text: '#e65100', icon: '' }, // Orange
                    { bg: '#e8eaf6', border: '#c5cae9', text: '#1a237e', icon: '' }, // Indigo
                    { bg: '#f3e5f5', border: '#e1bee7', text: '#4a148c', icon: '' }, // Purple
                    { bg: '#e0f7fa', border: '#b2ebf2', text: '#006064', icon: '' }, // Cyan
                    { bg: '#fff8e1', border: '#ffecb3', text: '#f57f17', icon: '' }, // Yellow
                    { bg: '#fce4ec', border: '#f8bbd0', text: '#880e4f', icon: '' }, // Pink
                    { bg: '#e8f5e9', border: '#c8e6c9', text: '#1b5e20', icon: '' }, // Green
                    { bg: '#fff9c4', border: '#fff59d', text: '#f57f17', icon: '' }, // Yellow
                ];

                sortedTopics.forEach(([topic, stats], index) => {
                    const mastery = stats.attempted > 0 ? (stats.correct / stats.attempted) * 100 : 0;
                    const colorIndex = index % pastelColors.length;
                    const colors = pastelColors[colorIndex];
                    
                    let masteryIcon = '';
                    let masteryEmoji = '';
                    if (mastery >= 80) {
                        masteryIcon = '';
                        masteryEmoji = '';
                    } else if (mastery >= 50) {
                        masteryIcon = '';
                        masteryEmoji = '';
                    } else if (mastery > 0) {
                        masteryIcon = '';
                        masteryEmoji = '';
                    } else {
                        masteryIcon = '';
                        masteryEmoji = '';
                    }

                    const progressColor = mastery >= 80 ? '#4CAF50' : mastery >= 50 ? '#FF9800' : mastery > 0 ? '#FFC107' : '#9E9E9E';

                    progressHTML += `
                        <div style="background: ${colors.bg}; padding: 1.5rem; border-radius: 16px; border: 2px solid ${colors.border}; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.8rem;">${colors.icon}</span>
                                    <h4 style="margin: 0; font-size: 1.1rem; color: ${colors.text}; font-weight: 600;">${topic}</h4>
                                </div>
                                <span style="font-size: 1.8rem;">${masteryIcon}</span>
                            </div>
                            <div style="margin-bottom: 0.8rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem;">
                                    <span style="font-size: 0.9rem; color: ${colors.text}; font-weight: 500;">${masteryEmoji} Mastery</span>
                                    <span style="font-weight: bold; color: ${progressColor}; font-size: 1.2rem;">${mastery.toFixed(1)}%</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.6); height: 24px; border-radius: 12px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="background: linear-gradient(90deg, ${progressColor}, ${progressColor}cc); height: 100%; width: ${Math.max(mastery, 2)}%; transition: width 0.8s ease; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                                </div>
                            </div>
                            <div style="font-size: 0.85rem; color: ${colors.text}; margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid ${colors.border};">
                                <div style="display: flex; justify-content: space-between;">
                                    <span> ${stats.correct} / ${stats.attempted} correct</span>
                                    <span> ${stats.total} questions</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                progressHTML += `</div>`;

                // Weak Questions Section
                if (weakQuestions.length > 0) {
                    progressHTML += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span style="font-size: 2rem;"></span>
                            <h3 style="color: #333; margin: 0; font-size: 1.5rem;">Questions Needing Practice</h3>
                        </div>
                        <div style="background: linear-gradient(135deg, #fff5f5, #ffe0e0); border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; border: 2px solid #ffb3b3;">
                            <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f); padding: 1rem; color: white;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;"></span>
                                    <span style="font-weight: 600;">Focus on these to improve!</span>
                                </div>
                            </div>
                            <div style="padding: 1rem;">
                    `;

                    weakQuestions.slice(0, 10).forEach((q, idx) => {
                        const bgColor = idx % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'rgba(255,255,255,0.3)';
                        progressHTML += `
                            <div style="background: ${bgColor}; padding: 1rem; border-radius: 12px; margin-bottom: 0.8rem; border-left: 4px solid #ff6b6b;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <div style="font-weight: 600; color: #333; margin-bottom: 0.3rem;"> ${q.title}</div>
                                    </div>
                                    <div style="display: flex; gap: 1.5rem; align-items: center;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666;">Attempts</div>
                                            <div style="font-weight: bold; color: #333;">${q.attempts}</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666;">Success</div>
                                            <div style="font-weight: bold; color: #ff6b6b; font-size: 1.1rem;">${q.successRate.toFixed(1)}%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    progressHTML += `
                            </div>
                        </div>
                    `;
                } else {
                    progressHTML += `
                        <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 2rem; border-radius: 16px; text-align: center; border: 2px solid #4CAF50; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                            <p style="margin: 0; font-size: 1.2rem; color: #155724; font-weight: 600;">Excellent work! No weak questions found.</p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 1rem; color: #2e7d32;">Keep up the amazing progress! </p>
                        </div>
                    `;
                }

                container.innerHTML = progressHTML;

            } catch (e) {
                console.error("Error loading student progress:", e);
                const container = document.getElementById('my-progress-container');
                if (container) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Error loading student progress. Please try again.</p></div>';
                }
            }
        };

        // Sort questions by priority for deliberate practice
        window.sortQuestionsByPriority = function(questions, studentRating) {
            return questions.sort((a, b) => {
                // Priority 1: Review questions (spaced repetition)
                if (a.isReviewQuestion !== b.isReviewQuestion) {
                    return a.isReviewQuestion ? -1 : 1;
                }
                
                // Priority 2: New questions (never attempted)
                if (a.answered !== b.answered) {
                    return a.answered ? 1 : -1;
                }
                
                // Priority 3: Growth zone questions
                const aInGrowthZone = isInGrowthZone(studentRating, a.questionRating || RATING_CONFIG.DEFAULT_QUESTION_RATING);
                const bInGrowthZone = isInGrowthZone(studentRating, b.questionRating || RATING_CONFIG.DEFAULT_QUESTION_RATING);
                
                if (aInGrowthZone !== bInGrowthZone) {
                    return aInGrowthZone ? -1 : 1;
                }
                
                // Priority 4: Questions closest to optimal challenge (55% expected success)
                const optimalExpected = 0.55;
                const aExpected = calculateExpectedSuccess(studentRating, a.questionRating || RATING_CONFIG.DEFAULT_QUESTION_RATING);
                const bExpected = calculateExpectedSuccess(studentRating, b.questionRating || RATING_CONFIG.DEFAULT_QUESTION_RATING);
                
                const aDiff = Math.abs(aExpected - optimalExpected);
                const bDiff = Math.abs(bExpected - optimalExpected);
                
                return aDiff - bDiff;
            });
        };

        // =====================================================
        // QUESTION LIST PAGE FUNCTIONS
        // =====================================================

        window.allQuestionsList = [];
        window.filteredQuestionsList = [];

        // Load all questions for the question list page
        window.loadQuestionList = async function() {
            const container = document.getElementById('question-list-container');
            if (!container) return;

            container.innerHTML = '<div class="placeholder-content" id="question-list-loading-msg"><p style="font-size: 1.2rem; color: #666;">Loading questions...</p></div>';

            try {
                // Load question ratings if available
                if (window.loadQuestionRatings) {
                    await window.loadQuestionRatings();
                }

                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get questions from Firestore
                const questionsSnapshot = await getDocs(collection(window.db_fs, "custom_questions"));
                const allQuestions = [];

                questionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const qId = `q-${doc.id}`;
                    const ratingData = window.getQuestionRating ? window.getQuestionRating(qId) : { rating: RATING_CONFIG.DEFAULT_QUESTION_RATING };
                    
                    allQuestions.push({
                        id: qId,
                        firestoreId: doc.id,
                        title: data.title || 'Question',
                        html: data.html || '',
                        topic: data.topic || 'General',
                        level: data.level || 'P6',
                        category: data.category || 'mcq',
                        rating: ratingData.rating || RATING_CONFIG.DEFAULT_QUESTION_RATING,
                        createdAt: data.createdAt || data.updatedAt || new Date().toISOString(),
                        fromFirestore: true
                    });
                });

                // Get questions from DOM (hardcoded questions)
                document.querySelectorAll('.question-container[id]').forEach(container => {
                    const qId = container.id;
                    // Skip if already in Firestore list
                    if (allQuestions.find(q => q.id === qId)) return;

                    // Get title
                    const titleEl = container.querySelector('h3, h4');
                    const title = titleEl ? titleEl.textContent.trim() : 'Question';

                    // Get topic
                    let topic = 'General';
                    const mcqParent = container.closest('[id^="topic-mcq-"]');
                    if (mcqParent) {
                        const topicId = mcqParent.id.replace('topic-mcq-', '');
                        if (window.mcqCurriculum) {
                            for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                                const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                                if (matchingTopic) {
                                    topic = matchingTopic;
                                    break;
                                }
                            }
                        }
                    } else {
                        const topicParent = container.closest('[id^="topic-"]');
                        if (topicParent) {
                            const topicId = topicParent.id.replace('topic-', '').replace(/^(mcq|oeq|cer)-/, '');
                            topic = topicId.charAt(0).toUpperCase() + topicId.slice(1).replace(/-/g, ' ');
                        }
                    }

                    // Get level
                    let level = 'P6';
                    const levelParent = container.closest('[id^="topic-mcq-"]');
                    if (levelParent && window.mcqCurriculum) {
                        for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                            const topicId = levelParent.id.replace('topic-mcq-', '');
                            if (topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId)) {
                                level = lvl;
                                break;
                            }
                        }
                    } else {
                        level = window.currentMcqLevel || window.currentOeqLevel || 'P6';
                    }

                    // Get rating
                    const ratingData = window.getQuestionRating ? window.getQuestionRating(qId) : { rating: RATING_CONFIG.DEFAULT_QUESTION_RATING };
                    
                    // Get HTML content
                    const questionBody = container.querySelector('.question-body, .mcq-body');
                    const html = questionBody ? questionBody.innerHTML : container.innerHTML;

                    // Determine category
                    const category = container.querySelector('.mcq-container') ? 'mcq' : 'oeq';

                    allQuestions.push({
                        id: qId,
                        title: title,
                        html: html,
                        topic: topic,
                        level: level,
                        category: category,
                        rating: ratingData.rating || RATING_CONFIG.DEFAULT_QUESTION_RATING,
                        createdAt: new Date(0).toISOString(), // DOM questions have no date
                        fromFirestore: false
                    });
                });

                window.allQuestionsList = allQuestions;
                window.filteredQuestionsList = [...allQuestions];

                // Populate topic filter
                const topicFilter = document.getElementById('question-list-filter-topic');
                if (topicFilter) {
                    const topics = [...new Set(allQuestions.map(q => q.topic))].sort();
                    topicFilter.innerHTML = '<option value="">All Topics</option>';
                    topics.forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic;
                        option.textContent = topic;
                        topicFilter.appendChild(option);
                    });
                }

                // Apply initial sort and render
                performSort();

            } catch (e) {
                console.error("Error loading question list:", e);
                container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Error loading questions. Please try again.</p></div>';
            }
        };

        // Current sort state
        window.currentQuestionSort = { field: 'rating', order: 'desc' };

        // Render the question list as a table
        function renderQuestionList() {
            const container = document.getElementById('question-list-container');
            if (!container) return;

            if (window.filteredQuestionsList.length === 0) {
                container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #666;">No questions found.</p></div>';
                return;
            }

            const sortField = window.currentQuestionSort.field;
            const sortOrder = window.currentQuestionSort.order;

            // Helper to get sort indicator
            const getSortIndicator = (field) => {
                if (sortField !== field) return '';
                return sortOrder === 'asc' ? '' : '';
            };

            let html = `
                <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="btn" style="background: #4CAF50; color: white; padding: 0.75rem 1.5rem; font-weight: 600;" onclick="addSelectedQuestionsToWorksheet()">
                             Add Selected to Worksheet
                        </button>
                        <span id="selected-count" style="color: #666; font-size: 0.9rem;">0 selected</span>
                    </div>
                    <button class="btn" style="background: #2196F3; color: white; padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="selectAllQuestions()">
                        Select All
                    </button>
                </div>
                <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                <th style="padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; width: 40px; font-size: 0.85rem;">
                                    <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)" style="cursor: pointer; width: 16px; height: 16px;">
                                </th>
                                <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; cursor: pointer; user-select: none; transition: background 0.2s; font-size: 0.85rem; min-width: 200px;" 
                                    onclick="sortByColumn('title')"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                    onmouseout="this.style.background='transparent'">
                                    Title ${getSortIndicator('title')}
                                </th>
                                <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; cursor: pointer; user-select: none; transition: background 0.2s; font-size: 0.85rem; min-width: 150px;" 
                                    onclick="sortByColumn('topic')"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                    onmouseout="this.style.background='transparent'">
                                    Topic ${getSortIndicator('topic')}
                                </th>
                                <th style="padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; cursor: pointer; user-select: none; transition: background 0.2s; font-size: 0.85rem; width: 80px;" 
                                    onclick="sortByColumn('level')"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                    onmouseout="this.style.background='transparent'">
                                    Level ${getSortIndicator('level')}
                                </th>
                                <th style="padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; cursor: pointer; user-select: none; transition: background 0.2s; font-size: 0.85rem; width: 90px;" 
                                    onclick="sortByColumn('rating')"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                    onmouseout="this.style.background='transparent'">
                                    Rating ${getSortIndicator('rating')}
                                </th>
                                <th style="padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; cursor: pointer; user-select: none; transition: background 0.2s; font-size: 0.85rem; width: 80px;" 
                                    onclick="sortByColumn('category')"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                    onmouseout="this.style.background='transparent'">
                                    Type ${getSortIndicator('category')}
                                </th>
                                <th style="padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; cursor: pointer; user-select: none; transition: background 0.2s; font-size: 0.85rem; width: 120px;" 
                                    onclick="sortByColumn('date')"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                    onmouseout="this.style.background='transparent'">
                                    Date Added ${getSortIndicator('date')}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            window.filteredQuestionsList.forEach((question, index) => {
                let date = 'N/A';
                if (question.createdAt) {
                    try {
                        const dateObj = new Date(question.createdAt);
                        if (!isNaN(dateObj.getTime())) {
                            date = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                        }
                    } catch (e) {
                        date = 'N/A';
                    }
                }
                const ratingColor = question.rating >= 1500 ? '#4CAF50' : question.rating >= 1200 ? '#FF9800' : '#9E9E9E';
                const categoryIcon = question.category === 'mcq' ? ' MCQ' : ' OEQ';
                const sourceBadge = question.fromFirestore ? '<span style="font-size: 0.7rem; background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">Custom</span>' : '';

                html += `
                    <tr style="border-bottom: 1px solid #eee; transition: background 0.2s;" 
                        onmouseover="this.style.background='#f5f5f5'"
                        onmouseout="this.style.background='white'">
                        <td style="padding: 0.75rem 0.5rem; text-align: center;" onclick="event.stopPropagation();">
                            <input type="checkbox" class="question-checkbox" data-question-id="${question.id}" onchange="updateSelectedCount()" style="cursor: pointer; width: 16px; height: 16px;">
                        </td>
                        <td style="padding: 0.75rem 0.5rem; color: #333; cursor: pointer; font-size: 0.85rem;" onclick="showQuestionPopup('${question.id.replace(/'/g, "\\'")}', ${index})">
                            <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px;">
                                ${question.title}${sourceBadge}
                            </div>
                        </td>
                        <td style="padding: 0.75rem 0.5rem; color: #666; cursor: pointer; font-size: 0.85rem;" onclick="showQuestionPopup('${question.id.replace(/'/g, "\\'")}', ${index})">
                            <span style="background: #f5f5f5; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">
                                 ${question.topic}
                            </span>
                        </td>
                        <td style="padding: 0.75rem 0.5rem; text-align: center; color: #1976d2; cursor: pointer; font-size: 0.85rem;" onclick="showQuestionPopup('${question.id.replace(/'/g, "\\'")}', ${index})">
                            <span style="background: #e3f2fd; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">
                                 ${question.level}
                            </span>
                        </td>
                        <td style="padding: 0.75rem 0.5rem; text-align: center; cursor: pointer; font-size: 0.85rem;" onclick="showQuestionPopup('${question.id.replace(/'/g, "\\'")}', ${index})">
                            <span style="background: ${ratingColor}15; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; color: ${ratingColor}; font-weight: 600; white-space: nowrap;">
                                 ${question.rating}
                            </span>
                        </td>
                        <td style="padding: 0.75rem 0.5rem; text-align: center; color: #7b1fa2; cursor: pointer; font-size: 0.85rem;" onclick="showQuestionPopup('${question.id.replace(/'/g, "\\'")}', ${index})">
                            <span style="background: #f3e5f5; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">
                                ${categoryIcon}
                            </span>
                        </td>
                        <td style="padding: 0.75rem 0.5rem; text-align: center; color: #999; font-size: 0.75rem; cursor: pointer; white-space: nowrap;" onclick="showQuestionPopup('${question.id.replace(/'/g, "\\'")}', ${index})">
                            ${question.fromFirestore ? ` ${date}` : ' Built-in'}
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = html;
            updateSelectedCount();
        }

        // Toggle select all
        window.toggleSelectAll = function(checked) {
            const checkboxes = document.querySelectorAll('.question-checkbox');
            checkboxes.forEach(cb => cb.checked = checked);
            updateSelectedCount();
        };

        // Select all questions
        window.selectAllQuestions = function() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = true;
                toggleSelectAll(true);
            }
        };

        // Update selected count
        window.updateSelectedCount = function() {
            const selectedCount = document.querySelectorAll('.question-checkbox:checked').length;
            const countElement = document.getElementById('selected-count');
            if (countElement) {
                countElement.textContent = `${selectedCount} selected`;
            }
            // Update select all checkbox state
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const allCheckboxes = document.querySelectorAll('.question-checkbox');
            if (selectAllCheckbox && allCheckboxes.length > 0) {
                selectAllCheckbox.checked = selectedCount === allCheckboxes.length;
            }
        };

        // Add selected questions to worksheet
        window.addSelectedQuestionsToWorksheet = async function() {
            const selectedCheckboxes = document.querySelectorAll('.question-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one question to add to the worksheet.');
                return;
            }

            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.questionId);
            let addedCount = 0;
            let skippedCount = 0;

            for (const questionId of selectedIds) {
                // Check if already in worksheet
                if (window.worksheetItems.some(item => item.id === questionId)) {
                    skippedCount++;
                    continue;
                }

                // Find question in the list
                const question = window.allQuestionsList.find(q => q.id === questionId);
                if (!question) continue;

                try {
                    // Try to get question from DOM first
                    const questionContainer = document.getElementById(questionId);
                    
                    if (questionContainer) {
                        // Question exists in DOM, clone it
                        const clone = questionContainer.cloneNode(true);
                        
                        // Remove UI elements from the clone
                        clone.querySelectorAll('.admin-controls, .worksheet-control-bar, .controls, .feedback-icon').forEach(el => el.remove());
                        
                        // Reset any input states in the clone
                        clone.querySelectorAll('.answer-input').forEach(input => {
                            input.disabled = false;
                            input.value = '';
                            input.style.borderBottomColor = '';
                        });
                        
                        // Get the cleaned HTML
                        const cleanedHtml = clone.innerHTML;
                        
                        window.worksheetItems.push({
                            id: questionId,
                            title: question.title,
                            html: cleanedHtml,
                            addedAt: new Date().toISOString()
                        });
                    } else {
                        // Question not in DOM, use stored HTML
                        // Clean the HTML if needed
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = question.html;
                        
                        // Remove unwanted elements
                        tempDiv.querySelectorAll('.admin-controls, .worksheet-control-bar, .controls, .feedback-icon').forEach(el => el.remove());
                        
                        // Reset inputs
                        tempDiv.querySelectorAll('.answer-input').forEach(input => {
                            input.disabled = false;
                            input.value = '';
                            input.style.borderBottomColor = '';
                        });
                        
                        const processedHtml = tempDiv.innerHTML;
                        
                        window.worksheetItems.push({
                            id: questionId,
                            title: question.title,
                            html: processedHtml,
                            addedAt: new Date().toISOString()
                        });
                    }
                    
                    addedCount++;
                } catch (e) {
                    console.error(`Error adding question ${questionId}:`, e);
                }
            }

            // Save and update UI
            if (window.saveWorksheetToStorage) {
                window.saveWorksheetToStorage();
            }
            if (window.updateWorksheetUI) {
                window.updateWorksheetUI();
            }

            // Uncheck all checkboxes
            selectedCheckboxes.forEach(cb => cb.checked = false);
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateSelectedCount();

            // Show success message
            let message = ` Successfully added ${addedCount} question${addedCount !== 1 ? 's' : ''} to your worksheet!`;
            if (skippedCount > 0) {
                message += `\n\n${skippedCount} question${skippedCount !== 1 ? 's were' : ' was'} already in your worksheet and ${skippedCount !== 1 ? 'were' : 'was'} skipped.`;
            }
            alert(message);
        };

        // Sort by column header click
        window.sortByColumn = function(field) {
            if (!window.filteredQuestionsList) return;

            // Toggle order if clicking the same column, otherwise default to desc
            if (window.currentQuestionSort.field === field) {
                window.currentQuestionSort.order = window.currentQuestionSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                window.currentQuestionSort.field = field;
                window.currentQuestionSort.order = 'desc';
            }

            // Update dropdown to match
            const sortSelect = document.getElementById('question-list-sort');
            if (sortSelect) {
                const order = window.currentQuestionSort.order;
                let value = '';
                switch (field) {
                    case 'rating':
                        value = `rating-${order}`;
                        break;
                    case 'topic':
                        value = `topic-${order === 'desc' ? 'desc' : 'asc'}`;
                        break;
                    case 'date':
                        value = `date-${order}`;
                        break;
                    case 'level':
                        value = `level-${order === 'desc' ? 'desc' : 'asc'}`;
                        break;
                    case 'title':
                        value = `topic-${order === 'desc' ? 'desc' : 'asc'}`; // Use topic sort for title
                        break;
                    case 'category':
                        value = `topic-${order === 'desc' ? 'desc' : 'asc'}`; // Use topic sort for category
                        break;
                }
                if (value) sortSelect.value = value;
            }

            performSort();
        };

        // Perform the actual sorting
        function performSort() {
            if (!window.filteredQuestionsList) return;

            const sortField = window.currentQuestionSort.field;
            const sortOrder = window.currentQuestionSort.order;

            window.filteredQuestionsList.sort((a, b) => {
                let aVal, bVal;

                switch (sortField) {
                    case 'rating':
                        aVal = a.rating;
                        bVal = b.rating;
                        break;
                    case 'topic':
                        aVal = a.topic.toLowerCase();
                        bVal = b.topic.toLowerCase();
                        break;
                    case 'title':
                        aVal = a.title.toLowerCase();
                        bVal = b.title.toLowerCase();
                        break;
                    case 'date':
                        aVal = new Date(a.createdAt || 0).getTime();
                        bVal = new Date(b.createdAt || 0).getTime();
                        break;
                    case 'level':
                        const levelOrder = { 'P3': 1, 'P4': 2, 'P5': 3, 'P6': 4 };
                        aVal = levelOrder[a.level] || 5;
                        bVal = levelOrder[b.level] || 5;
                        break;
                    case 'category':
                        aVal = a.category.toLowerCase();
                        bVal = b.category.toLowerCase();
                        break;
                    default:
                        return 0;
                }

                if (sortOrder === 'desc') {
                    return bVal > aVal ? 1 : bVal < aVal ? -1 : 0;
                } else {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                }
            });

            renderQuestionList();
        }

        // Sort question list (from dropdown)
        window.sortQuestionList = function() {
            const sortSelect = document.getElementById('question-list-sort');
            if (!sortSelect || !window.filteredQuestionsList) return;

            const sortValue = sortSelect.value;
            const [sortBy, order] = sortValue.split('-');

            // Map dropdown values to table column fields
            let field = sortBy;
            if (sortBy === 'rating') field = 'rating';
            else if (sortBy === 'topic') field = 'topic';
            else if (sortBy === 'date') field = 'date';
            else if (sortBy === 'level') field = 'level';

            window.currentQuestionSort.field = field;
            window.currentQuestionSort.order = order;

            performSort();
        };

        // Filter question list
        window.filterQuestionList = function() {
            if (!window.allQuestionsList) return;

            const topicFilter = document.getElementById('question-list-filter-topic')?.value || '';
            const levelFilter = document.getElementById('question-list-filter-level')?.value || '';
            const searchInput = document.getElementById('question-list-search')?.value.toLowerCase() || '';

            window.filteredQuestionsList = window.allQuestionsList.filter(question => {
                const matchesTopic = !topicFilter || question.topic === topicFilter;
                const matchesLevel = !levelFilter || question.level === levelFilter;
                const matchesSearch = !searchInput || 
                    question.title.toLowerCase().includes(searchInput) ||
                    question.topic.toLowerCase().includes(searchInput);

                return matchesTopic && matchesLevel && matchesSearch;
            });

            // Apply current sort
            performSort();
        };

        // Show question popup
        window.showQuestionPopup = function(questionId, listIndex) {
            let question = window.filteredQuestionsList[listIndex];
            if (!question) {
                // Try to find by ID
                const found = window.allQuestionsList.find(q => q.id === questionId);
                if (!found) {
                    alert('Question not found');
                    return;
                }
                question = found;
            }

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay visible';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal-box" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #667eea; padding-bottom: 1rem;">
                        <h3 style="margin: 0; color: #667eea;">${question.title}</h3>
                        <button class="btn" style="background: #666; color: white;" onclick="this.closest('.modal-overlay').remove()"> Close</button>
                    </div>
                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <span style="background: #f5f5f5; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; color: #666;">
                             ${question.topic}
                        </span>
                        <span style="background: #e3f2fd; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; color: #1976d2;">
                             ${question.level}
                        </span>
                        <span style="background: #fff3e0; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; color: #e65100; font-weight: 600;">
                             Rating: ${question.rating}
                        </span>
                        <span style="background: #f3e5f5; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; color: #7b1fa2;">
                            ${question.category === 'mcq' ? ' MCQ' : ' OEQ'}
                        </span>
                    </div>
                    <div class="question-body" style="background: #f9f9f9; padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                        ${question.html || '<p style="color: #999;">Question content not available.</p>'}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Setup question functionality if needed
            if (window.setupQuestionFormGlobal && question.id) {
                setTimeout(() => {
                    const bodyDiv = modal.querySelector('.question-body');
                    if (bodyDiv) {
                        // Create a temporary ID for the question body
                        bodyDiv.id = question.id + '-popup-body';
                        window.setupQuestionFormGlobal(bodyDiv.id);
                    }
                }, 100);
            }

            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        };

        // Load wrong answers that are due for review
        window.loadWrongAnswersForReview = async function() {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const studentIndex = window.practiceState.currentStudent?.index || 0;
                const storageKey = `wrongAnswers_${user.uid}_${studentIndex}`;
                const stored = localStorage.getItem(storageKey);
                
                if (stored) {
                    window.practiceState.wrongAnswersForReview = JSON.parse(stored);
                } else {
                    window.practiceState.wrongAnswersForReview = {};
                }
            } catch (e) {
                console.error("Error loading wrong answers:", e);
                window.practiceState.wrongAnswersForReview = {};
            }
        };

        // Save wrong answer for 7-day review
        window.saveWrongAnswerForReview = function(questionId) {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const studentIndex = window.practiceState.currentStudent?.index || 0;
                const storageKey = `wrongAnswers_${user.uid}_${studentIndex}`;
                
                // Store the timestamp when the question was answered wrong
                window.practiceState.wrongAnswersForReview[questionId] = Date.now();
                
                localStorage.setItem(storageKey, JSON.stringify(window.practiceState.wrongAnswersForReview));
            } catch (e) {
                console.error("Error saving wrong answer:", e);
            }
        };

        // Remove question from review queue (when answered correctly after review)
        window.removeFromReviewQueue = function(questionId) {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const studentIndex = window.practiceState.currentStudent?.index || 0;
                const storageKey = `wrongAnswers_${user.uid}_${studentIndex}`;
                
                delete window.practiceState.wrongAnswersForReview[questionId];
                
                localStorage.setItem(storageKey, JSON.stringify(window.practiceState.wrongAnswersForReview));
            } catch (e) {
                console.error("Error removing from review queue:", e);
            }
        };

        // Check if a question is due for review (7 days after wrong answer)
        window.isQuestionDueForReview = function(questionId) {
            const wrongTimestamp = window.practiceState.wrongAnswersForReview[questionId];
            if (!wrongTimestamp) return false;
            
            const now = Date.now();
            const sevenDaysMs = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds
            
            return (now - wrongTimestamp) >= sevenDaysMs;
        };

        // Get days until review for a question
        window.getDaysUntilReview = function(questionId) {
            const wrongTimestamp = window.practiceState.wrongAnswersForReview[questionId];
            if (!wrongTimestamp) return null;
            
            const now = Date.now();
            const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
            const timeUntilReview = (wrongTimestamp + sevenDaysMs) - now;
            
            if (timeUntilReview <= 0) return 0;
            return Math.ceil(timeUntilReview / (24 * 60 * 60 * 1000));
        };

        window.loadPracticeMode = async function() {
            const select = document.getElementById('practice-student-select');
            select.innerHTML = '<option value="">-- Select Student --</option>';
            
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    let students = data.students || [];
                    
                    // Backwards compatibility: if no students array, create one from old format
                    if (students.length === 0 && data.studentName) {
                        students.push({ name: data.studentName, level: data.level || 'P6' });
                    }
                    
                    // If admin user and no students, add default P6 student for testing
                    if (window.isAdminUser && students.length === 0) {
                        students.push({ name: 'Admin', level: 'P6' });
                    }
                    
                    // If admin user, also add an "Admin (P6)" option at the top for testing
                    if (window.isAdminUser) {
                        const adminOption = document.createElement('option');
                        adminOption.value = 'admin';
                        adminOption.textContent = 'Admin Test Mode (P6)';
                        adminOption.dataset.name = 'Admin';
                        adminOption.dataset.level = 'P6';
                        select.appendChild(adminOption);
                    }
                    
                    students.forEach((student, idx) => {
                        const option = document.createElement('option');
                        option.value = idx;
                        option.textContent = `${student.name} (${student.level})`;
                        option.dataset.name = student.name;
                        option.dataset.level = student.level;
                        select.appendChild(option);
                    });
                    
                    window.userStudents = students;
                } else if (window.isAdminUser) {
                    // Admin without user doc - still allow practice as P6
                    const adminOption = document.createElement('option');
                    adminOption.value = 'admin';
                    adminOption.textContent = 'Admin Test Mode (P6)';
                    adminOption.dataset.name = 'Admin';
                    adminOption.dataset.level = 'P6';
                    select.appendChild(adminOption);
                    
                    window.userStudents = [{ name: 'Admin', level: 'P6' }];
                }
            } catch (e) {
                console.error("Error loading students:", e);
                
                // Fallback for admin if error occurs
                if (window.isAdminUser) {
                    const adminOption = document.createElement('option');
                    adminOption.value = 'admin';
                    adminOption.textContent = 'Admin Test Mode (P6)';
                    adminOption.dataset.name = 'Admin';
                    adminOption.dataset.level = 'P6';
                    select.appendChild(adminOption);
                    
                    window.userStudents = [{ name: 'Admin', level: 'P6' }];
                }
            }
        };

        window.selectPracticeStudent = function() {
            const select = document.getElementById('practice-student-select');
            const selectedOption = select.options[select.selectedIndex];
            const startBtn = document.getElementById('btn-start-practice');
            
            if (select.value && selectedOption.dataset.name) {
                // Handle admin test mode vs regular students
                const isAdminMode = select.value === 'admin';
                window.practiceState.currentStudent = {
                    index: isAdminMode ? 0 : parseInt(select.value, 10),
                    name: selectedOption.dataset.name,
                    level: selectedOption.dataset.level,
                    isAdminMode: isAdminMode
                };
                document.getElementById('practice-student-info').textContent = 
                    `Student: ${selectedOption.dataset.name} | Level: ${selectedOption.dataset.level}`;
                startBtn.disabled = false;
            } else {
                window.practiceState.currentStudent = null;
                document.getElementById('practice-student-info').textContent = 'Select a student to start practicing';
                startBtn.disabled = true;
            }
        };

        window.startPractice = async function() {
            if (!window.practiceState.currentStudent) {
                alert("Please select a student first.");
                return;
            }
            
            const student = window.practiceState.currentStudent;
            const level = student.level;
            const studentIndex = student.index;
            
            // Reset state
            window.practiceState.questions = [];
            window.practiceState.currentIndex = 0;
            window.practiceState.correct = 0;
            window.practiceState.wrong = 0;
            window.practiceState.streak = 0;
            
            // Load answered questions, wrong answers for review, and ratings
            await loadAnsweredQuestions();
            await loadWrongAnswersForReview();
            await loadQuestionRatings();
            
            // Get student's current rating
            const studentRatingData = await getStudentRating(studentIndex);
            student.rating = studentRatingData.rating;
            student.startRating = studentRatingData.rating; // Store for session summary
            student.attempts = studentRatingData.attempts;
            window.practiceState.currentStudent = student;
            
            // Update student info display with rating
            const ratingTier = getRatingTier(student.rating);
            document.getElementById('practice-student-info').innerHTML = 
                `Student: ${student.name} | Level: ${level} | 
                <span style="color: ${ratingTier.color}; font-weight: 600;">Rating: ${student.rating} (${ratingTier.tier})</span>`;
            
            // Collect questions from current level and one level down
            const levels = ['P3', 'P4', 'P5', 'P6'];
            const currentLevelIndex = levels.indexOf(level);
            const targetLevels = [level];
            if (currentLevelIndex > 0) {
                targetLevels.push(levels[currentLevelIndex - 1]);
            }
            
            // Gather MCQ questions from the DOM with ratings
            const allQuestions = [];
            const reviewQuestions = []; // Questions due for 7-day review
            
            targetLevels.forEach(lvl => {
                const topics = window.mcqCurriculum[lvl] || [];
                topics.forEach(topic => {
                    const topicId = topic.toLowerCase().replace(/\s+/g, '-');
                    const container = document.getElementById(`topic-mcq-${topicId}`);
                    if (container) {
                        container.querySelectorAll('.question-container').forEach(q => {
                            const qId = q.id;
                            const isAnswered = window.practiceState.answeredQuestions.has(qId);
                            const isDueForReview = isQuestionDueForReview(qId);
                            const daysUntilReview = getDaysUntilReview(qId);
                            
                            // Get question rating
                            const qRatingData = getQuestionRating(qId);
                            const questionRating = qRatingData.rating;
                            const questionAttempts = qRatingData.attempts;
                            
                            // Calculate expected success and difficulty
                            const expectedSuccess = calculateExpectedSuccess(student.rating, questionRating);
                            const inGrowthZone = isInGrowthZone(student.rating, questionRating);
                            const difficulty = getDifficultyLabel(student.rating, questionRating);
                            
                            const questionData = {
                                id: qId,
                                level: lvl,
                                topic: topic,
                                element: q,
                                answered: isAnswered,
                                isReviewQuestion: isDueForReview,
                                daysUntilReview: daysUntilReview,
                                questionRating: questionRating,
                                questionAttempts: questionAttempts,
                                expectedSuccess: expectedSuccess,
                                inGrowthZone: inGrowthZone,
                                difficulty: difficulty,
                                priority: lvl === level ? 0 : 1 // Current level first
                            };
                            
                            // If due for review, add to priority review queue
                            if (isDueForReview) {
                                reviewQuestions.push(questionData);
                            } else {
                                allQuestions.push(questionData);
                            }
                        });
                    }
                });
            });
            
            // Sort questions using rating-based priority (deliberate practice)
            const sortedQuestions = sortQuestionsByPriority(allQuestions, student.rating);
            
            // Filter for new questions only if coming from welcome modal
            let finalQuestions;
            let practiceMode = 'normal';
            
            if (window.practiceNewQuestionsOnly && window.newQuestionIds && window.newQuestionIds.length > 0) {
                // Filter to only include new questions
                const newQuestionIdsSet = new Set(window.newQuestionIds.map(id => 'q-' + id));
                const newQuestionsFiltered = sortedQuestions.filter(q => {
                    // Check both the question ID and if it's a custom question ID
                    return newQuestionIdsSet.has(q.id) || 
                           newQuestionIdsSet.has(q.id.replace('q-custom-', 'custom-')) ||
                           window.newQuestionIds.includes(q.id.replace('q-', ''));
                });
                
                if (newQuestionsFiltered.length > 0) {
                    finalQuestions = newQuestionsFiltered;
                    practiceMode = 'new';
                } else {
                    // No new questions found in DOM, use all questions
                    finalQuestions = [...reviewQuestions, ...sortedQuestions];
                }
                
                // Reset the flag
                window.practiceNewQuestionsOnly = false;
                window.newQuestionIds = [];
            } else {
                // Combine: Review questions first (highest priority), then sorted questions
                finalQuestions = [...reviewQuestions, ...sortedQuestions];
            }
            
            window.practiceState.questions = finalQuestions;
            
            // Count growth zone questions
            const growthZoneCount = allQuestions.filter(q => q.inGrowthZone && !q.answered).length;
            const newQuestionsCount = allQuestions.filter(q => !q.answered).length;
            
            // Show practice summary with ratings info
            const practiceContainer = document.getElementById('practice-question-container');
            const existingNotification = document.getElementById('review-notification');
            if (existingNotification) existingNotification.remove();
            const existingSummary = document.getElementById('practice-summary-notification');
            if (existingSummary) existingSummary.remove();
            
            // Show review notification if there are review questions
            if (reviewQuestions.length > 0) {
                const reviewNotification = document.createElement('div');
                reviewNotification.id = 'review-notification';
                reviewNotification.style.cssText = 'background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 12px; margin-bottom: 1rem; text-align: center; animation: practicePulse 2s infinite;';
                reviewNotification.innerHTML = `
                    <div style="font-size: 1.5rem; margin-bottom: 5px;"> Review Time!</div>
                    <div>You have <strong>${reviewQuestions.length}</strong> question${reviewQuestions.length > 1 ? 's' : ''} ready for 7-day review</div>
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 5px;">Master these to remove them from review</div>
                `;
                practiceContainer.insertBefore(reviewNotification, practiceContainer.firstChild);
            }
            
            // Show practice summary with growth zone info
            const summaryNotification = document.createElement('div');
            summaryNotification.id = 'practice-summary-notification';
            
            if (practiceMode === 'new') {
                // Special banner for practicing new questions
                summaryNotification.style.cssText = 'background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 15px; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #2196f3;';
                summaryNotification.innerHTML = `
                    <div style="font-weight: 600; color: #1565c0; margin-bottom: 8px;"> Practicing New Questions!</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.9rem; color: #555;">
                        <span> Your Rating: <strong style="color: ${ratingTier.color};">${student.rating}</strong></span>
                        <span> New Questions: <strong style="color: #1565c0;">${finalQuestions.length}</strong></span>
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 8px;">
                        These questions were added since your last visit. Let's practice them!
                    </div>
                `;
            } else {
                summaryNotification.style.cssText = 'background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 15px; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #4CAF50;';
                summaryNotification.innerHTML = `
                    <div style="font-weight: 600; color: #2e7d32; margin-bottom: 8px;"> Deliberate Practice Session</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.9rem; color: #555;">
                        <span> Your Rating: <strong style="color: ${ratingTier.color};">${student.rating}</strong></span>
                        <span> New Questions: <strong>${newQuestionsCount}</strong></span>
                        <span> Growth Zone: <strong style="color: #ff9800;">${growthZoneCount}</strong></span>
                        <span> Total Available: <strong>${finalQuestions.length}</strong></span>
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 8px;">
                        Questions are prioritized: New  Growth Zone (35-75% success rate)  Mastered
                    </div>
                `;
            }
            practiceContainer.insertBefore(summaryNotification, practiceContainer.firstChild);
            
            // Update UI
            document.getElementById('practice-start-container').classList.add('hidden');
            document.getElementById('practice-stats').classList.remove('hidden');
            document.getElementById('practice-stats').style.display = 'grid';
            document.getElementById('practice-question-container').classList.remove('hidden');
            document.getElementById('practice-complete').classList.add('hidden');
            
            updatePracticeStats();
            showCurrentPracticeQuestion();
        };

        window.showCurrentPracticeQuestion = function() {
            const state = window.practiceState;
            if (state.currentIndex >= state.questions.length) {
                endPractice();
                return;
            }
            
            const question = state.questions[state.currentIndex];
            const container = document.getElementById('practice-question-content');
            const student = state.currentStudent;
            
            // Clone the question
            const clone = question.element.cloneNode(true);
            clone.id = 'practice-q-' + question.id;
            
            // Reset any answered state
            clone.querySelectorAll('input[type="radio"]').forEach(r => {
                r.checked = false;
                r.disabled = false;
                r.name = 'practice-mcq-' + state.currentIndex; // Unique name for this question
            });
            clone.querySelectorAll('.mcq-option, label').forEach(opt => {
                opt.style.borderColor = '';
                opt.style.background = '';
                opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());
            });
            clone.querySelectorAll('.explanation-box').forEach(e => e.style.display = 'none');
            clone.querySelectorAll('.submit-btn').forEach(b => b.disabled = false);
            
            // Update submit button to use practice check
            const submitBtn = clone.querySelector('.submit-btn');
            if (submitBtn) {
                submitBtn.onclick = () => checkPracticeAnswer();
            }
            
            container.innerHTML = '';
            
            // Add difficulty badge (visible to all users)
            const difficulty = question.difficulty || getDifficultyLabel(student.rating, question.questionRating || 1200);
            const expectedSuccess = question.expectedSuccess || calculateExpectedSuccess(student.rating, question.questionRating || 1200);
            const inGrowthZone = question.inGrowthZone || isInGrowthZone(student.rating, question.questionRating || 1200);
            
            const difficultyBadge = document.createElement('div');
            difficultyBadge.className = 'question-difficulty-badge';
            difficultyBadge.style.cssText = `
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                padding: 10px 15px; 
                border-radius: 10px; 
                margin-bottom: 1rem; 
                background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
                border-left: 4px solid ${difficulty.color};
            `;
            
            let badgeContent = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.3rem;">${difficulty.icon}</span>
                    <div>
                        <div style="font-weight: 600; color: ${difficulty.color};">${difficulty.label}</div>
                        <div style="font-size: 0.75rem; color: #888;">Success chance: ~${Math.round(expectedSuccess * 100)}%</div>
                    </div>
                </div>
            `;
            
            // Show growth zone indicator
            if (inGrowthZone) {
                badgeContent += `
                    <div style="background: linear-gradient(135deg, #ff9800, #ffc107); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                         Growth Zone
                    </div>
                `;
            }
            
            // Admin-only: Show actual ratings
            if (window.isAdminUser) {
                const qRating = question.questionRating || 1200;
                const qAttempts = question.questionAttempts || 0;
                const confidence = Math.min(qAttempts / 20, 1) * 100;
                
                badgeContent += `
                    <div style="background: #f3e5f5; padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; border: 1px solid #ce93d8;">
                        <div style="color: #7b1fa2; font-weight: 600;"> Admin View</div>
                        <div style="color: #666;">Q-Rating: <strong>${qRating}</strong></div>
                        <div style="color: #666;">Attempts: ${qAttempts} (${Math.round(confidence)}% confidence)</div>
                    </div>
                `;
            }
            
            difficultyBadge.innerHTML = badgeContent;
            container.appendChild(difficultyBadge);
            
            // Add review badge if this is a review question
            if (question.isReviewQuestion) {
                const reviewBadge = document.createElement('div');
                reviewBadge.className = 'review-question-badge';
                reviewBadge.style.cssText = 'background: linear-gradient(135deg, #ff6b6b, #ffa502); color: white; padding: 10px 15px; border-radius: 10px; margin-bottom: 1rem; display: flex; align-items: center; gap: 10px; font-weight: 600; animation: practicePulse 2s infinite;';
                reviewBadge.innerHTML = `
                    <span style="font-size: 1.5rem;"></span>
                    <div>
                        <div>7-Day Review Question</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">Answer correctly to master this topic!</div>
                    </div>
                `;
                container.appendChild(reviewBadge);
            }
            
            container.appendChild(clone);
            
            // Update level and topic display
            document.getElementById('practice-question-level').textContent = question.level;
            document.getElementById('practice-question-topic').textContent = `Topic: ${question.topic}`;
            
            updatePracticeStats();
        };

        window.checkPracticeAnswer = async function() {
            const state = window.practiceState;
            const question = state.questions[state.currentIndex];
            const container = document.getElementById('practice-question-content');
            const student = state.currentStudent;
            
            const selected = container.querySelector('input[type="radio"]:checked');
            if (!selected) {
                alert("Please select an answer!");
                return;
            }
            
            const isCorrect = selected.dataset.correct === 'true';
            
            // Show feedback on options
            container.querySelectorAll('.mcq-option, label').forEach(opt => {
                const radio = opt.querySelector('input');
                opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());
                
                if (radio && radio.dataset.correct === 'true') {
                    opt.style.background = '#d4edda';
                    opt.style.borderColor = '#28a745';
                    const icon = document.createElement('span');
                    icon.className = 'option-feedback-icon';
                    icon.textContent = '';
                    icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #28a745; margin-left: auto; padding-left: 10px;';
                    opt.style.display = 'flex';
                    opt.style.alignItems = 'center';
                    opt.appendChild(icon);
                } else if (radio && radio.checked && !isCorrect) {
                    opt.style.background = '#f8d7da';
                    opt.style.borderColor = '#dc3545';
                    const icon = document.createElement('span');
                    icon.className = 'option-feedback-icon';
                    icon.textContent = '';
                    icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #dc3545; margin-left: auto; padding-left: 10px;';
                    opt.style.display = 'flex';
                    opt.style.alignItems = 'center';
                    opt.appendChild(icon);
                }
            });
            
            // Disable radios
            container.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);
            
            // Show explanation
            const explanation = container.querySelector('.explanation-box');
            if (explanation) explanation.style.display = 'block';
            
            // =====================================================
            // ELO RATING UPDATE
            // =====================================================
            const studentRating = student.rating || 1000;
            const studentAttempts = student.attempts || 0;
            const questionRating = question.questionRating || 1200;
            const questionAttempts = question.questionAttempts || 0;
            
            // Calculate rating changes
            const ratingUpdate = calculateRatingUpdate(
                studentRating, 
                questionRating, 
                isCorrect, 
                studentAttempts, 
                questionAttempts
            );
            
            // Update ratings in Firebase (await to ensure they're saved)
            await updateStudentRating(student.index, ratingUpdate.newStudentRating, isCorrect);
            await updateQuestionRating(question.id, ratingUpdate.newQuestionRating, isCorrect);
            
            // Track question attempt for progress tracking
            if (window.trackQuestionAttempt) {
                await window.trackQuestionAttempt(question.id, isCorrect);
            }
            
            // Update local state
            student.rating = ratingUpdate.newStudentRating;
            student.attempts = studentAttempts + 1;
            question.questionRating = ratingUpdate.newQuestionRating;
            question.questionAttempts = questionAttempts + 1;
            
            // Create rating feedback message
            const ratingFeedback = document.createElement('div');
            ratingFeedback.className = 'rating-feedback';
            
            if (isCorrect) {
                const ratingTier = getRatingTier(ratingUpdate.newStudentRating);
                ratingFeedback.style.cssText = 'background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 12px 15px; border-radius: 10px; margin-top: 1rem; border-left: 4px solid #4CAF50;';
                ratingFeedback.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <div style="font-weight: 600; color: #2e7d32;"> Rating Updated!</div>
                            <div style="font-size: 0.85rem; color: #555;">
                                Your rating: ${studentRating}  <strong style="color: ${ratingTier.color};">${ratingUpdate.newStudentRating}</strong>
                                <span style="color: #4CAF50;">(+${ratingUpdate.studentChange})</span>
                            </div>
                        </div>
                        <div style="background: ${ratingTier.color}; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                            ${ratingTier.tier}
                        </div>
                    </div>
                `;
            } else {
                const ratingTier = getRatingTier(ratingUpdate.newStudentRating);
                const ratingChange = ratingUpdate.studentChange;
                ratingFeedback.style.cssText = 'background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 12px 15px; border-radius: 10px; margin-top: 1rem; border-left: 4px solid #ff9800;';
                ratingFeedback.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <div style="font-weight: 600; color: #e65100;"> Keep Practicing!</div>
                            <div style="font-size: 0.85rem; color: #555;">
                                Your rating: ${studentRating}  <strong style="color: ${ratingTier.color};">${ratingUpdate.newStudentRating}</strong>
                                ${ratingChange < 0 ? `<span style="color: #f44336;">(${ratingChange})</span>` : ''}
                            </div>
                            <div style="font-size: 0.8rem; color: #888; margin-top: 3px;">
                                This was a ${getDifficultyLabel(studentRating, questionRating).label.toLowerCase()} question for you
                            </div>
                        </div>
                        <div style="background: ${ratingTier.color}; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                            ${ratingTier.tier}
                        </div>
                    </div>
                `;
            }
            
            // Admin-only: Show question rating change
            if (window.isAdminUser) {
                const qChangeSpan = document.createElement('div');
                qChangeSpan.style.cssText = 'margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ccc; font-size: 0.8rem; color: #7b1fa2;';
                qChangeSpan.innerHTML = `
                     <strong>Admin:</strong> Q-Rating: ${questionRating}  ${ratingUpdate.newQuestionRating} 
                    (${ratingUpdate.questionChange >= 0 ? '+' : ''}${ratingUpdate.questionChange}) | 
                    Expected: ${ratingUpdate.expected}% | Attempts: ${questionAttempts + 1}
                `;
                ratingFeedback.appendChild(qChangeSpan);
            }
            
            container.appendChild(ratingFeedback);
            
            // Update student info display
            const ratingTier = getRatingTier(ratingUpdate.newStudentRating);
            document.getElementById('practice-student-info').innerHTML = 
                `Student: ${student.name} | Level: ${student.level} | 
                <span style="color: ${ratingTier.color}; font-weight: 600;">Rating: ${ratingUpdate.newStudentRating} (${ratingTier.tier})</span>`;
            
            // Update stats and handle spaced repetition
            if (isCorrect) {
                state.correct++;
                state.streak++;
                
                // If this was a review question answered correctly, remove from review queue
                if (question.isReviewQuestion) {
                    removeFromReviewQueue(question.id);
                    
                    // Show encouraging message for mastered review question
                    const masteredMsg = document.createElement('div');
                    masteredMsg.style.cssText = 'background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 12px; border-radius: 8px; margin-top: 1rem; text-align: center; font-weight: 600; color: #155724;';
                    masteredMsg.innerHTML = ' Great job! You\'ve mastered this review question!';
                    container.appendChild(masteredMsg);
                }
            } else {
                state.wrong++;
                state.streak = 0;
                
                // Save wrong answer for 7-day review (spaced repetition)
                saveWrongAnswerForReview(question.id);
                
                // Show spaced repetition reminder
                const reviewMsg = document.createElement('div');
                reviewMsg.style.cssText = 'background: linear-gradient(135deg, #fff3cd, #ffeeba); padding: 12px; border-radius: 8px; margin-top: 1rem; text-align: center; font-weight: 600; color: #856404;';
                reviewMsg.innerHTML = ' This question will return for review in <strong>7 days</strong> to help you master it!';
                container.appendChild(reviewMsg);
            }
            
            // Mark as answered
            state.answeredQuestions.add(question.id);
            saveAnsweredQuestions();
            
            // Disable submit button
            container.querySelectorAll('.submit-btn').forEach(b => b.disabled = true);
            
            updatePracticeStats();
        };

        window.nextPracticeQuestion = function() {
            window.practiceState.currentIndex++;
            showCurrentPracticeQuestion();
        };

        window.endPractice = function() {
            const state = window.practiceState;
            const student = state.currentStudent;
            
            document.getElementById('practice-question-container').classList.add('hidden');
            document.getElementById('practice-complete').classList.remove('hidden');
            
            const total = state.correct + state.wrong;
            const percentage = total > 0 ? Math.round((state.correct / total) * 100) : 0;
            
            // Calculate rating change during session
            const startRating = student.startRating || 1000;
            const endRating = student.rating || 1000;
            const ratingChange = endRating - startRating;
            const ratingTier = getRatingTier(endRating);
            
            // Build summary with rating info
            let summaryHtml = `
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; margin-bottom: 1rem;">
                        You got <strong>${state.correct}</strong> out of <strong>${total}</strong> correct (<strong>${percentage}%</strong>)!
                    </div>
                    <div style="background: linear-gradient(135deg, #f5f5f5, #e8e8e8); padding: 15px; border-radius: 12px; margin-top: 1rem;">
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 10px;"> Rating Summary</div>
                        <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
                            <div>
                                <div style="color: #888; font-size: 0.85rem;">Current Rating</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${ratingTier.color};">${endRating}</div>
                                <div style="font-size: 0.8rem; color: ${ratingTier.color};">${ratingTier.tier}</div>
                            </div>
                            <div style="font-size: 2rem; color: ${ratingChange >= 0 ? '#4CAF50' : '#f44336'};">
                                ${ratingChange >= 0 ? '' : ''}
                            </div>
                            <div>
                                <div style="color: #888; font-size: 0.85rem;">Session Change</div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: ${ratingChange >= 0 ? '#4CAF50' : '#f44336'};">
                                    ${ratingChange >= 0 ? '+' : ''}${ratingChange}
                                </div>
                            </div>
                        </div>
                    </div>
            `;
            
            // Add performance feedback
            if (percentage >= 80) {
                summaryHtml += `
                    <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 12px; border-radius: 8px; margin-top: 1rem; color: #155724;">
                         Excellent work! You're mastering this material!
                    </div>
                `;
            } else if (percentage >= 60) {
                summaryHtml += `
                    <div style="background: linear-gradient(135deg, #cce5ff, #b8daff); padding: 12px; border-radius: 8px; margin-top: 1rem; color: #004085;">
                         Good progress! Keep practicing to improve further.
                    </div>
                `;
            } else {
                summaryHtml += `
                    <div style="background: linear-gradient(135deg, #fff3cd, #ffeeba); padding: 12px; border-radius: 8px; margin-top: 1rem; color: #856404;">
                         Don't give up! Review the explanations and try again.
                    </div>
                `;
            }
            
            summaryHtml += '</div>';
            
            document.getElementById('practice-summary').innerHTML = summaryHtml;
        };

        window.restartPractice = function() {
            document.getElementById('practice-complete').classList.add('hidden');
            document.getElementById('practice-start-container').classList.remove('hidden');
            document.getElementById('practice-stats').classList.add('hidden');
            document.getElementById('practice-question-container').classList.add('hidden');
        };

        window.updatePracticeStats = function() {
            const state = window.practiceState;
            document.getElementById('stat-correct').textContent = state.correct;
            document.getElementById('stat-wrong').textContent = state.wrong;
            document.getElementById('stat-remaining').textContent = 
                Math.max(0, state.questions.length - state.currentIndex - 1);
            document.getElementById('stat-streak').textContent = state.streak;
            
            // Count review questions remaining
            const reviewRemaining = state.questions
                .slice(state.currentIndex)
                .filter(q => q.isReviewQuestion).length;
            document.getElementById('stat-review').textContent = reviewRemaining;
        };

        window.loadAnsweredQuestions = async function() {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const studentIndex = window.practiceState.currentStudent?.index || 0;
                const key = `answered_${user.uid}_${studentIndex}`;
                const stored = localStorage.getItem(key);
                
                if (stored) {
                    window.practiceState.answeredQuestions = new Set(JSON.parse(stored));
                } else {
                    window.practiceState.answeredQuestions = new Set();
                }
            } catch (e) {
                console.error("Error loading answered questions:", e);
                window.practiceState.answeredQuestions = new Set();
            }
        };

        window.saveAnsweredQuestions = function() {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const studentIndex = window.practiceState.currentStudent?.index || 0;
                const key = `answered_${user.uid}_${studentIndex}`;
                const data = Array.from(window.practiceState.answeredQuestions);
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error("Error saving answered questions:", e);
            }
        };

        // Track answer for practice mode (called from checkMcq)
        window.trackAnswerForPractice = function(questionId, isCorrect) {
            // This can be expanded to track performance over time
            console.log(`Question ${questionId}: ${isCorrect ? 'Correct' : 'Wrong'}`);
            
            // Track this attempt in Firebase for admin dashboard
            trackQuestionAttempt(questionId, isCorrect);
        };

        // Track all question attempts (both practice mode and regular mode) for admin dashboard
        window.trackQuestionAttempt = async function(questionId, isCorrect) {
            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) return;
                
                const { doc, getDoc, updateDoc, setDoc, increment } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const userRef = doc(window.db_fs, "users", user.uid);
                const userDoc = await getDoc(userRef);
                
                const now = new Date();
                const today = now.toISOString().split('T')[0]; // YYYY-MM-DD
                
                // Get current student index
                const studentIndex = window.practiceState?.currentStudent?.index ?? 0;
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    
                    // Update activity tracking
                    const activityStats = data.activityStats || {};
                    activityStats.totalQuestionsAttempted = (activityStats.totalQuestionsAttempted || 0) + 1;
                    activityStats.totalCorrect = (activityStats.totalCorrect || 0) + (isCorrect ? 1 : 0);
                    activityStats.lastActivity = now;
                    
                    // Track daily activity
                    const dailyActivity = activityStats.dailyActivity || {};
                    if (!dailyActivity[today]) {
                        dailyActivity[today] = { attempts: 0, correct: 0 };
                    }
                    dailyActivity[today].attempts++;
                    if (isCorrect) dailyActivity[today].correct++;
                    activityStats.dailyActivity = dailyActivity;
                    
                    // Track per-question attempts per student
                    const questionAttempts = data.questionAttempts || {};
                    const studentKey = `student_${studentIndex}`;
                    if (!questionAttempts[studentKey]) {
                        questionAttempts[studentKey] = {};
                    }
                    if (!questionAttempts[studentKey][questionId]) {
                        questionAttempts[studentKey][questionId] = { attempts: 0, correct: 0, lastAttempt: null };
                    }
                    questionAttempts[studentKey][questionId].attempts++;
                    if (isCorrect) questionAttempts[studentKey][questionId].correct++;
                    questionAttempts[studentKey][questionId].lastAttempt = now;
                    
                    // Keep only last 30 days of daily activity
                    const thirtyDaysAgo = new Date(now);
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
                    Object.keys(dailyActivity).forEach(date => {
                        if (date < thirtyDaysAgoStr) delete dailyActivity[date];
                    });
                    
                    await updateDoc(userRef, { 
                        activityStats: activityStats,
                        questionAttempts: questionAttempts,
                        lastActivity: now
                    });
                    
                    console.log("Activity tracked - Total attempts:", activityStats.totalQuestionsAttempted);
                } else {
                    // Create new user document with activity
                    const questionAttempts = {};
                    const studentKey = `student_${studentIndex}`;
                    questionAttempts[studentKey] = {};
                    questionAttempts[studentKey][questionId] = { attempts: 1, correct: isCorrect ? 1 : 0, lastAttempt: now };
                    
                    await setDoc(userRef, {
                        email: user.email,
                        activityStats: {
                            totalQuestionsAttempted: 1,
                            totalCorrect: isCorrect ? 1 : 0,
                            lastActivity: now,
                            dailyActivity: {
                                [today]: { attempts: 1, correct: isCorrect ? 1 : 0 }
                            }
                        },
                        questionAttempts: questionAttempts,
                        lastActivity: now,
                        createdAt: now
                    }, { merge: true });
                }
            } catch (e) {
                console.error("Error tracking question attempt:", e);
            }
        };

        // =====================================================
        // ADMIN RATINGS DASHBOARD
        // =====================================================
        
        window.toggleRatingsDashboard = function() {
            const content = document.getElementById('ratings-dashboard-content');
            const btn = document.getElementById('btn-toggle-ratings');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                btn.textContent = ' Hide Dashboard';
                loadRatingsDashboard();
            } else {
                content.classList.add('hidden');
                btn.textContent = ' Show Dashboard';
            }
        };

        window.loadRatingsDashboard = async function() {
            if (!window.isAdminUser) return;
            
            const tableBody = document.getElementById('ratings-table-body');
            tableBody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #888;">Loading...</td></tr>';
            
            try {
                // Load question ratings
                await loadQuestionRatings();
                
                // Get all questions from DOM with level and topic info
                const allQuestions = [];
                document.querySelectorAll('.question-container').forEach(q => {
                    const id = q.id;
                    const titleEl = q.querySelector('h3');
                    const title = titleEl ? titleEl.textContent.trim() : id;
                    
                    // Extract level and topic from parent container IDs
                    let level = '-';
                    let topic = '-';
                    
                    // Check if it's an MCQ question (parent has topic-mcq-* id)
                    const mcqParent = q.closest('[id^="topic-mcq-"]');
                    if (mcqParent) {
                        // Find which level this topic belongs to
                        const topicId = mcqParent.id.replace('topic-mcq-', '');
                        for (const [lvl, topics] of Object.entries(window.mcqCurriculum || {})) {
                            const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                            if (matchingTopic) {
                                level = lvl;
                                topic = matchingTopic;
                                break;
                            }
                        }
                    } else {
                        // OEQ question - check parent view container
                        const viewParent = q.closest('[id^="view-"]');
                        if (viewParent) {
                            const viewType = viewParent.id.replace('view-', '');
                            // Check topic container
                            const topicParent = q.closest('[id^="topic-"]');
                            if (topicParent) {
                                const topicId = topicParent.id.replace('topic-', '').replace(viewType + '-', '');
                                topic = topicId.charAt(0).toUpperCase() + topicId.slice(1).replace(/-/g, ' ');
                            }
                            // Set level based on current OEQ level
                            level = window.currentOeqLevel || 'P6';
                        }
                    }
                    
                    const ratingData = getQuestionRating(id);
                    allQuestions.push({
                        id,
                        title: title.substring(0, 40) + (title.length > 40 ? '...' : ''),
                        fullTitle: title,
                        level: level,
                        topic: topic.length > 20 ? topic.substring(0, 18) + '...' : topic,
                        fullTopic: topic,
                        rating: ratingData.rating,
                        attempts: ratingData.attempts,
                        correctCount: ratingData.correctCount || 0,
                        element: q
                    });
                });
                
                // Calculate stats
                const ratedQuestions = allQuestions.filter(q => q.attempts > 0);
                const totalAttempts = ratedQuestions.reduce((sum, q) => sum + q.attempts, 0);
                const avgRating = ratedQuestions.length > 0 
                    ? Math.round(ratedQuestions.reduce((sum, q) => sum + q.rating, 0) / ratedQuestions.length)
                    : 1200;
                
                // Update stats
                document.getElementById('stat-total-questions').textContent = allQuestions.length;
                document.getElementById('stat-rated-questions').textContent = ratedQuestions.length;
                document.getElementById('stat-avg-rating').textContent = avgRating;
                document.getElementById('stat-total-attempts').textContent = totalAttempts;
                
                // Sort by rating descending (hardest first)
                allQuestions.sort((a, b) => b.rating - a.rating);
                
                // Store for popup access
                window.ratingsDashboardQuestions = allQuestions;
                
                // Render table
                if (allQuestions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #888;">No questions found</td></tr>';
                    return;
                }
                
                // Level colors
                const levelColors = {
                    'P3': '#FFB3BA',
                    'P4': '#BAFFC9',
                    'P5': '#BAE1FF',
                    'P6': '#FFFFBA'
                };
                
                tableBody.innerHTML = allQuestions.map((q, idx) => {
                    const correctPercent = q.attempts > 0 
                        ? Math.round((q.correctCount / q.attempts) * 100) 
                        : '-';
                    const confidence = Math.min(q.attempts / 20, 1) * 100;
                    const ratingColor = q.rating >= 1600 ? '#9C27B0' 
                        : q.rating >= 1400 ? '#673AB7'
                        : q.rating >= 1200 ? '#2196F3'
                        : q.rating >= 1000 ? '#4CAF50'
                        : '#FF9800';
                    const levelBg = levelColors[q.level] || '#f5f5f5';
                    
                    return `
                        <tr style="cursor: pointer;" onclick="showRatingQuestionPopup(${idx})" title="Click to view question">
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; max-width: 180px; overflow: hidden; text-overflow: ellipsis;">
                                <span style="color: #1976d2; text-decoration: underline;">${q.title}</span>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <span style="background: ${levelBg}; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${q.level}</span>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center; font-size: 0.8rem; color: #666;" title="${q.fullTopic}">${q.topic}</td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <strong style="color: ${ratingColor};">${q.rating}</strong>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">${q.attempts}</td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                ${correctPercent !== '-' ? `<span style="color: ${correctPercent >= 70 ? '#4CAF50' : correctPercent >= 50 ? '#ff9800' : '#f44336'};">${correctPercent}%</span>` : '-'}
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <div style="background: #e0e0e0; border-radius: 10px; height: 8px; width: 60px; display: inline-block; overflow: hidden;">
                                    <div style="background: ${confidence >= 80 ? '#4CAF50' : confidence >= 50 ? '#ff9800' : '#f44336'}; height: 100%; width: ${confidence}%;"></div>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (e) {
                console.error("Error loading ratings dashboard:", e);
                tableBody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #dc3545;">Error loading data</td></tr>';
            }
        };

        // Show question popup from ratings dashboard
        window.showRatingQuestionPopup = function(idx) {
            const questions = window.ratingsDashboardQuestions;
            if (!questions || !questions[idx]) return;
            
            const q = questions[idx];
            const questionElement = q.element;
            
            if (!questionElement) {
                alert('Question element not found');
                return;
            }
            
            // Clone the question content
            const clone = questionElement.cloneNode(true);
            
            // Remove controls, buttons, etc.
            clone.querySelectorAll('.controls, .worksheet-control-bar, .admin-controls, .consult-btn, .print-question-btn, .flag-question-btn').forEach(el => el.remove());
            
            // Get rating info
            const ratingData = getQuestionRating(q.id);
            const ratingTier = q.rating >= 1600 ? 'Hard' : q.rating >= 1400 ? 'Medium-Hard' : q.rating >= 1200 ? 'Medium' : q.rating >= 1000 ? 'Medium-Easy' : 'Easy';
            
            // Build popup content
            const content = document.getElementById('question-popup-content');
            content.innerHTML = `
                <div style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); padding: 12px 15px; border-radius: 10px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <div style="font-weight: 600; color: #7b1fa2; font-size: 1.1rem;">${q.fullTitle}</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                                Level: <strong>${q.level}</strong> | Topic: <strong>${q.fullTopic}</strong>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #7b1fa2;">${ratingData.rating}</div>
                            <div style="font-size: 0.75rem; color: #888;">${ratingTier}  ${ratingData.attempts} attempts</div>
                        </div>
                    </div>
                </div>
            `;
            content.appendChild(clone);
            
            // Show the popup
            document.getElementById('question-popup-modal').classList.add('visible');
        };

        // =====================================================
        // USER ACTIVITY DASHBOARD (ADMIN)
        // =====================================================
        
        window.toggleActivityDashboard = function() {
            const content = document.getElementById('activity-dashboard-content');
            const btn = document.getElementById('btn-toggle-activity');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                btn.textContent = ' Hide Dashboard';
                loadActivityDashboard();
            } else {
                content.classList.add('hidden');
                btn.textContent = ' Show Dashboard';
            }
        };

        window.loadActivityDashboard = async function() {
            if (!window.isAdminUser) return;
            
            const tableBody = document.getElementById('activity-table-body');
            tableBody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #888;">Loading...</td></tr>';
            
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Load all users
                const usersRef = collection(window.db_fs, "users");
                const snapshot = await getDocs(usersRef);
                
                const users = [];
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekStart = new Date(todayStart);
                weekStart.setDate(weekStart.getDate() - 7);
                const today = now.toISOString().split('T')[0];
                
                let activeToday = 0;
                let activeWeek = 0;
                let totalQuestionsAttempted = 0;
                let totalQuestionsToday = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const lastLogin = data.lastLogin?.toDate ? data.lastLogin.toDate() : null;
                    const lastActivity = data.lastActivity?.toDate ? data.lastActivity.toDate() : 
                                         (data.lastActivity ? new Date(data.lastActivity) : null);
                    const students = data.students || [];
                    const activityStats = data.activityStats || {};
                    
                    // Calculate average rating across all students
                    let avgRating = 1000;
                    let studentAttempts = 0;
                    if (students.length > 0) {
                        const ratings = students.filter(s => s.rating).map(s => s.rating);
                        avgRating = ratings.length > 0 ? Math.round(ratings.reduce((a, b) => a + b, 0) / ratings.length) : 1000;
                        studentAttempts = students.reduce((sum, s) => sum + (s.totalAttempts || 0), 0);
                    }
                    
                    // Get total attempts from activityStats (includes all question types)
                    const totalAttempts = activityStats.totalQuestionsAttempted || studentAttempts || 0;
                    const totalCorrect = activityStats.totalCorrect || 0;
                    const correctRate = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
                    
                    // Get today's attempts
                    const dailyActivity = activityStats.dailyActivity || {};
                    const todayAttempts = dailyActivity[today]?.attempts || 0;
                    
                    // Check activity (use lastActivity if available, fallback to lastLogin)
                    const lastActiveTime = lastActivity || lastLogin;
                    if (lastActiveTime) {
                        if (lastActiveTime >= todayStart) activeToday++;
                        if (lastActiveTime >= weekStart) activeWeek++;
                    }
                    
                    totalQuestionsAttempted += totalAttempts;
                    totalQuestionsToday += todayAttempts;
                    
                    users.push({
                        id: doc.id,
                        email: data.email || doc.id,
                        students: students,
                        studentCount: students.length,
                        lastLogin: lastLogin,
                        lastActivity: lastActiveTime,
                        loginCount: data.loginCount || 0,
                        totalAttempts: totalAttempts,
                        todayAttempts: todayAttempts,
                        correctRate: correctRate,
                        avgRating: avgRating
                    });
                });
                
                // Update stats
                document.getElementById('stat-total-users').textContent = users.length;
                document.getElementById('stat-active-today').textContent = activeToday;
                document.getElementById('stat-active-week').textContent = activeWeek;
                document.getElementById('stat-total-practice-sessions').textContent = totalQuestionsAttempted;
                
                // Sort by last activity (most recent first)
                users.sort((a, b) => {
                    if (!a.lastActivity) return 1;
                    if (!b.lastActivity) return -1;
                    return b.lastActivity - a.lastActivity;
                });
                
                // Render table
                if (users.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #888;">No users found</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = users.map(u => {
                    const lastActivityStr = u.lastActivity 
                        ? formatRelativeTime(u.lastActivity)
                        : 'Never';
                    const isRecent = u.lastActivity && u.lastActivity >= todayStart;
                    const studentNames = u.students.map(s => s.name || 'Unknown').join(', ');
                    const ratingTier = getRatingTier(u.avgRating);
                    const correctRateColor = u.correctRate >= 70 ? '#4CAF50' : u.correctRate >= 50 ? '#ff9800' : '#f44336';
                    
                    return `
                        <tr>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee;">
                                <div style="font-weight: 500;">${u.email}</div>
                                <div style="font-size: 0.75rem; color: #888;" title="${studentNames}">${studentNames.length > 25 ? studentNames.substring(0, 23) + '...' : studentNames || '-'}</div>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <span style="background: #e3f2fd; color: #1976d2; padding: 3px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">${u.studentCount}</span>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <span style="color: ${isRecent ? '#4CAF50' : '#888'}; font-weight: ${isRecent ? '600' : '400'};">${lastActivityStr}</span>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <div style="font-weight: 600;">${u.totalAttempts}</div>
                                ${u.todayAttempts > 0 ? `<div style="font-size: 0.7rem; color: #4CAF50;">+${u.todayAttempts} today</div>` : ''}
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <span style="color: ${correctRateColor}; font-weight: 600;">${u.correctRate}%</span>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <span style="color: ${ratingTier.color}; font-weight: 600;">${u.avgRating}</span>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (e) {
                console.error("Error loading activity dashboard:", e);
                tableBody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #dc3545;">Error loading data</td></tr>';
            }
        };

        // Format relative time (e.g., "2 hours ago", "Yesterday")
        window.formatRelativeTime = function(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        };

        // =====================================================
        // WELCOME BACK & NEW QUESTIONS NOTIFICATION
        // =====================================================
        
        window.newQuestionsForPractice = [];
        
        window.showWelcomeModal = function(newQuestionsCount, lastLoginDate, userStats) {
            const modal = document.getElementById('welcome-back-modal');
            const isNewUser = userStats?.isNewUser || false;
            const reviewCount = userStats?.reviewCount || 0;
            
            // Update title based on new user or time of day
            const hour = new Date().getHours();
            let greeting = 'Welcome Back!';
            let subtitle = 'Good to see you again';
            
            if (isNewUser) {
                greeting = 'Welcome! ';
                subtitle = 'Let\'s start learning!';
            } else {
                if (hour < 12) greeting = 'Good Morning! ';
                else if (hour < 17) greeting = 'Good Afternoon! ';
                else greeting = 'Good Evening! ';
            }
            
            document.getElementById('welcome-back-title').textContent = greeting;
            document.getElementById('welcome-back-subtitle').textContent = subtitle;
            
            // Update quick stats
            if (userStats) {
                document.getElementById('welcome-stat-streak').textContent = userStats.streak || 0;
                document.getElementById('welcome-stat-rating').textContent = userStats.rating || 1000;
                document.getElementById('welcome-stat-review').textContent = reviewCount;
            }
            
            // Update button text and info display
            const practiceBtn = document.getElementById('btn-practice-new');
            const infoBox = document.getElementById('new-questions-info');
            
            if (isNewUser) {
                // New user - show welcome message with total questions
                infoBox.style.background = 'linear-gradient(135deg, #e3f2fd, #bbdefb)';
                infoBox.innerHTML = `
                    <div style="font-size: 2.5rem; font-weight: 700; color: #1565c0;">${newQuestionsCount}</div>
                    <div style="font-size: 1rem; color: #1565c0; font-weight: 600;">Questions Ready to Practice!</div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">Start your learning journey now</div>
                `;
                practiceBtn.innerHTML = ' Start Learning';
            } else if (newQuestionsCount > 0) {
                // Returning user with new questions
                const daysAgo = lastLoginDate ? Math.floor((new Date() - lastLoginDate) / 86400000) : 0;
                let sinceText = 'Since your last visit';
                if (daysAgo === 0) sinceText = 'Since earlier today';
                else if (daysAgo === 1) sinceText = 'Since yesterday';
                else if (daysAgo > 1) sinceText = `Since ${daysAgo} days ago`;
                
                infoBox.style.background = 'linear-gradient(135deg, #e8f5e9, #c8e6c9)';
                infoBox.innerHTML = `
                    <div style="font-size: 2.5rem; font-weight: 700; color: #2e7d32;">${newQuestionsCount}</div>
                    <div style="font-size: 1rem; color: #2e7d32; font-weight: 600;">New Questions Added!</div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">${sinceText}</div>
                `;
                practiceBtn.innerHTML = ` Practice ${newQuestionsCount} New Questions`;
            } else if (reviewCount > 0) {
                // Returning user with no new questions but has reviews due
                infoBox.style.background = 'linear-gradient(135deg, #fff3e0, #ffe0b2)';
                infoBox.innerHTML = `
                    <div style="font-size: 2.5rem; font-weight: 700; color: #e65100;">${reviewCount}</div>
                    <div style="font-size: 1rem; color: #e65100; font-weight: 600;">Questions Due for Review!</div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">Practice to reinforce your learning</div>
                `;
                practiceBtn.innerHTML = ' Start Review';
            } else {
                // Returning user with no new questions and no reviews - all caught up!
                infoBox.style.background = 'linear-gradient(135deg, #f3e5f5, #e1bee7)';
                infoBox.innerHTML = `
                    <div style="font-size: 2.5rem; margin-bottom: 5px;"></div>
                    <div style="font-size: 1rem; color: #7b1fa2; font-weight: 600;">You're All Caught Up!</div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">No new questions since your last visit</div>
                `;
                practiceBtn.innerHTML = ' Continue Practice';
            }
            
            modal.classList.add('visible');
        };

        window.hideWelcomeModal = function() {
            document.getElementById('welcome-back-modal').classList.remove('visible');
        };

        window.practiceNewQuestions = function() {
            hideWelcomeModal();
            
            // Switch to practice mode
            switchMode('mcq');
            switchTab('practice', document.getElementById('btn-sidebar-practice'));
            
            // If there are new questions, start practice automatically after a short delay
            if (window.newQuestionsForPractice && window.newQuestionsForPractice.length > 0) {
                setTimeout(() => {
                    // Store new questions IDs for filtering in practice
                    window.practiceNewQuestionsOnly = true;
                    window.newQuestionIds = window.newQuestionsForPractice.map(q => q.id);
                }, 500);
            }
        };

        // Check for new questions since last login
        window.checkNewQuestionsSinceLastLogin = async function(lastLogin) {
            if (!lastLogin) return 0;
            
            try {
                const { collection, getDocs, query, where, orderBy } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Query questions added after last login
                const questionsRef = collection(window.db_fs, "custom_questions");
                const snapshot = await getDocs(questionsRef);
                
                let newCount = 0;
                window.newQuestionsForPractice = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Handle both Firestore Timestamp and ISO string formats
                    let createdAt = null;
                    if (data.createdAt) {
                        if (data.createdAt.toDate) {
                            createdAt = data.createdAt.toDate();
                        } else if (typeof data.createdAt === 'string') {
                            createdAt = new Date(data.createdAt);
                        } else if (data.createdAt instanceof Date) {
                            createdAt = data.createdAt;
                        }
                    }
                    
                    if (createdAt && createdAt > lastLogin) {
                        newCount++;
                        window.newQuestionsForPractice.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                
                return newCount;
            } catch (e) {
                console.error("Error checking new questions:", e);
                return 0;
            }
        };

        // Track login and show welcome modal
        window.trackLoginAndShowWelcome = async function(user) {
            try {
                const { doc, getDoc, updateDoc, setDoc, increment } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const userRef = doc(window.db_fs, "users", user.uid);
                const userDoc = await getDoc(userRef);
                
                let lastLogin = null;
                let loginStreak = 0;
                let userRating = 1000;
                let reviewCount = 0;
                let isNewUser = false;
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    lastLogin = data.lastLogin?.toDate ? data.lastLogin.toDate() : null;
                    loginStreak = data.loginStreak || 0;
                    
                    // Get first student's rating as user rating
                    const students = data.students || [];
                    if (students.length > 0 && students[0].rating) {
                        userRating = students[0].rating;
                    }
                    
                    // Calculate login streak
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const yesterdayStart = new Date(todayStart);
                    yesterdayStart.setDate(yesterdayStart.getDate() - 1);
                    
                    if (lastLogin) {
                        if (lastLogin >= todayStart) {
                            // Already logged in today, maintain streak
                        } else if (lastLogin >= yesterdayStart) {
                            // Logged in yesterday, increment streak
                            loginStreak++;
                        } else {
                            // More than a day gap, reset streak
                            loginStreak = 1;
                        }
                    } else {
                        loginStreak = 1;
                    }
                    
                    // Update login info
                    await updateDoc(userRef, {
                        lastLogin: new Date(),
                        loginCount: increment(1),
                        loginStreak: loginStreak
                    });
                } else {
                    // New user, create document
                    isNewUser = true;
                    await setDoc(userRef, {
                        email: user.email,
                        lastLogin: new Date(),
                        loginCount: 1,
                        loginStreak: 1,
                        createdAt: new Date()
                    }, { merge: true });
                    loginStreak = 1;
                }
                
                // Count questions due for review
                const studentIndex = 0;
                const reviewKey = `wrongAnswers_${user.uid}_${studentIndex}`;
                const storedReviews = localStorage.getItem(reviewKey);
                if (storedReviews) {
                    const reviews = JSON.parse(storedReviews);
                    const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
                    const now = Date.now();
                    reviewCount = Object.values(reviews).filter(ts => (now - ts) >= sevenDaysMs).length;
                }
                
                // Check for new questions (for returning users) or total questions (for new users)
                let newQuestionsCount = 0;
                let totalQuestionsCount = 0;
                
                if (isNewUser || !lastLogin) {
                    // For new users, count total available questions
                    totalQuestionsCount = await countTotalQuestions();
                    newQuestionsCount = totalQuestionsCount; // Show all as "new" for new users
                } else {
                    // For returning users, check questions added since last login
                    newQuestionsCount = await checkNewQuestionsSinceLastLogin(lastLogin);
                }
                
                // Always show welcome modal on login
                setTimeout(() => {
                    showWelcomeModal(newQuestionsCount, lastLogin, {
                        streak: loginStreak,
                        rating: userRating,
                        reviewCount: reviewCount,
                        isNewUser: isNewUser,
                        totalQuestions: totalQuestionsCount
                    });
                }, 1500); // Delay to let page load
                
            } catch (e) {
                console.error("Error tracking login:", e);
            }
        };

        // Count total available questions
        window.countTotalQuestions = async function() {
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const questionsRef = collection(window.db_fs, "custom_questions");
                const snapshot = await getDocs(questionsRef);
                
                return snapshot.size;
            } catch (e) {
                console.error("Error counting questions:", e);
                return 0;
            }
        };

        // =====================================================
        // AUTO-UPDATE SYSTEM
        // =====================================================
        
        // Get current app version from meta tag
        window.getCurrentAppVersion = function() {
            const versionMeta = document.querySelector('meta[name="app-version"]');
            return versionMeta ? versionMeta.content : '0';
        };

        // Check for updates from Firestore
        window.checkForUpdates = async function() {
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const currentVersion = getCurrentAppVersion();
                const lastCheckedVersion = localStorage.getItem('app_last_version');
                
                // Check Firestore for the latest version
                const versionDoc = await getDoc(doc(window.db_fs, "app_settings", "version"));
                
                if (versionDoc.exists()) {
                    const serverVersion = versionDoc.data().current;
                    const forceRefresh = versionDoc.data().forceRefresh || false;
                    
                    console.log(`Current: ${currentVersion}, Server: ${serverVersion}, Last: ${lastCheckedVersion}`);
                    
                    // If server version is newer than current version
                    if (serverVersion && serverVersion !== currentVersion) {
                        if (forceRefresh) {
                            // Force refresh immediately
                            showUpdateBanner(serverVersion, true);
                        } else {
                            // Show update notification
                            showUpdateBanner(serverVersion, false);
                        }
                    }
                }
                
                // Update last checked version
                localStorage.setItem('app_last_version', currentVersion);
                
            } catch (e) {
                console.log("Update check skipped:", e.message);
            }
        };

        // Show update notification banner
        window.showUpdateBanner = function(newVersion, autoRefresh = false) {
            // Remove existing banner if any
            const existingBanner = document.getElementById('update-banner');
            if (existingBanner) existingBanner.remove();
            
            const banner = document.createElement('div');
            banner.id = 'update-banner';
            banner.className = 'update-banner';
            
            if (autoRefresh) {
                banner.innerHTML = `
                    <span class="update-banner-text"> New update available! Refreshing in <span id="refresh-countdown">5</span> seconds...</span>
                    <button class="update-banner-btn" onclick="forceRefresh()">Refresh Now</button>
                `;
                document.body.prepend(banner);
                
                // Countdown and refresh
                let countdown = 5;
                const interval = setInterval(() => {
                    countdown--;
                    const countdownEl = document.getElementById('refresh-countdown');
                    if (countdownEl) countdownEl.textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(interval);
                        forceRefresh();
                    }
                }, 1000);
            } else {
                banner.innerHTML = `
                    <span class="update-banner-text"> A new version is available with new features and improvements!</span>
                    <button class="update-banner-btn" onclick="forceRefresh()"> Update Now</button>
                    <button class="update-banner-dismiss" onclick="dismissUpdateBanner()">Later</button>
                `;
                document.body.prepend(banner);
            }
        };

        // Force refresh the page
        window.forceRefresh = function() {
            // Clear cache and reload
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            
            // Force reload from server
            window.location.reload(true);
        };

        // Dismiss update banner
        window.dismissUpdateBanner = function() {
            const banner = document.getElementById('update-banner');
            if (banner) {
                banner.style.animation = 'slideUp 0.3s ease forwards';
                setTimeout(() => banner.remove(), 300);
            }
            
            // Don't show again for this session
            sessionStorage.setItem('update_dismissed', 'true');
        };

        // Admin function to push update notification to all users
        window.pushAppUpdate = async function(newVersion, forceRefresh = false) {
            if (!window.isAdminUser) {
                alert("Only admins can push updates.");
                return;
            }
            
            try {
                const { doc, setDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                await setDoc(doc(window.db_fs, "app_settings", "version"), {
                    current: newVersion,
                    forceRefresh: forceRefresh,
                    updatedAt: serverTimestamp(),
                    updatedBy: window.auth.currentUser.email
                });
                
                alert(` Update pushed!\n\nVersion: ${newVersion}\nForce Refresh: ${forceRefresh ? 'Yes' : 'No'}\n\nAll users will be notified on their next page load.`);
                
            } catch (e) {
                console.error("Error pushing update:", e);
                alert("Error pushing update: " + e.message);
            }
        };

        // UI function for push update button
        window.pushUpdateNotification = function(forceRefresh = false) {
            const currentVersion = getCurrentAppVersion();
            const newVersion = prompt(
                `Push Update to All Users\n\n` +
                `Current version: ${currentVersion}\n\n` +
                `Enter new version number (or leave blank to use current):`,
                currentVersion
            );
            
            if (newVersion === null) return; // Cancelled
            
            const versionToUse = newVersion.trim() || currentVersion;
            const confirmMsg = forceRefresh 
                ? ` FORCE REFRESH\n\nThis will immediately refresh all users' browsers!\n\nVersion: ${versionToUse}\n\nProceed?`
                : ` NOTIFY USERS\n\nUsers will see an update banner and can choose to refresh.\n\nVersion: ${versionToUse}\n\nProceed?`;
            
            if (confirm(confirmMsg)) {
                pushAppUpdate(versionToUse, forceRefresh);
            }
        };

        // Update version display when admin view loads
        window.updateVersionDisplay = function() {
            const display = document.getElementById('current-version-display');
            if (display) {
                display.textContent = getCurrentAppVersion();
            }
        };

        // Periodic update check (every 5 minutes)
        window.startUpdateChecker = function() {
            // Check immediately
            setTimeout(() => {
                if (!sessionStorage.getItem('update_dismissed')) {
                    checkForUpdates();
                }
            }, 3000);
            
            // Then check every 5 minutes
            setInterval(() => {
                if (!sessionStorage.getItem('update_dismissed')) {
                    checkForUpdates();
                }
            }, 5 * 60 * 1000);
        };

        // Add CSS for slideUp animation
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            @keyframes slideUp {
                from { transform: translateY(0); opacity: 1; }
                to { transform: translateY(-100%); opacity: 0; }
            }
        `;
        document.head.appendChild(styleSheet);

        // =====================================================
        // STUDENT PROGRESS TRACKING (Admin)
        // =====================================================
        
        window.allProgressData = [];
        window.filteredProgressData = [];

        // Load student progress data
        window.loadStudentProgress = async function() {
            if (!window.isAdminUser) {
                alert("Only admins can view student progress.");
                return;
            }
            
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Fetch all worksheet attempts
                const attemptsSnapshot = await getDocs(collection(window.db_fs, "worksheet_attempts"));
                const worksheetsSnapshot = await getDocs(collection(window.db_fs, "user_worksheets"));
                
                // Build worksheets lookup
                const worksheetsMap = {};
                worksheetsSnapshot.forEach(doc => {
                    worksheetsMap[doc.id] = { id: doc.id, ...doc.data() };
                });
                
                // Build progress data
                window.allProgressData = [];
                const studentsSet = new Set();
                const worksheetsSet = new Set();
                
                attemptsSnapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    data.worksheetInfo = worksheetsMap[data.worksheetId] || { name: 'Unknown Worksheet' };
                    window.allProgressData.push(data);
                    
                    if (data.studentName) studentsSet.add(data.studentName);
                    if (data.worksheetInfo.name) worksheetsSet.add(data.worksheetInfo.name);
                });
                
                // Sort by date descending
                window.allProgressData.sort((a, b) => {
                    const dateA = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt || 0);
                    const dateB = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt || 0);
                    return dateB - dateA;
                });
                
                window.filteredProgressData = [...window.allProgressData];
                
                // Populate filter dropdowns
                populateProgressFilters(studentsSet, worksheetsSet);
                
                // Update summary stats
                updateProgressSummaryStats();
                
                // Render table
                renderProgressTable();
                
            } catch (e) {
                console.error("Error loading student progress:", e);
                document.getElementById('progress-table-body').innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 2rem; text-align: center; color: #dc3545;">
                            Error loading progress data. Please try again.
                        </td>
                    </tr>
                `;
            }
        };

        window.populateProgressFilters = function(studentsSet, worksheetsSet) {
            // Worksheet filter
            const worksheetFilter = document.getElementById('progress-worksheet-filter');
            worksheetFilter.innerHTML = '<option value="all">All Worksheets</option>';
            [...worksheetsSet].sort().forEach(ws => {
                worksheetFilter.innerHTML += `<option value="${ws}">${ws}</option>`;
            });
            
            // Student filter
            const studentFilter = document.getElementById('progress-student-filter');
            studentFilter.innerHTML = '<option value="all">All Students</option>';
            [...studentsSet].sort().forEach(st => {
                studentFilter.innerHTML += `<option value="${st}">${st}</option>`;
            });
        };

        window.updateProgressSummaryStats = function() {
            const data = window.filteredProgressData;
            
            // Total attempts
            document.getElementById('stat-total-attempts').textContent = data.length;
            
            // Completed count
            const completed = data.filter(d => d.status === 'completed').length;
            document.getElementById('stat-completed-count').textContent = completed;
            
            // Average score
            const scoresData = data.filter(d => typeof d.score === 'number');
            const avgScore = scoresData.length > 0 
                ? Math.round(scoresData.reduce((sum, d) => sum + d.score, 0) / scoresData.length) 
                : 0;
            document.getElementById('stat-avg-score').textContent = avgScore + '%';
            
            // Unique students
            const uniqueStudents = new Set(data.map(d => d.studentName)).size;
            document.getElementById('stat-unique-students').textContent = uniqueStudents;
        };

        window.renderProgressTable = function() {
            const tbody = document.getElementById('progress-table-body');
            const data = window.filteredProgressData;
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 3rem; text-align: center; color: #888;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                            <p>No worksheet attempts found</p>
                            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Student progress will appear here when they attempt worksheets</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.map(attempt => {
                const date = attempt.completedAt?.toDate 
                    ? attempt.completedAt.toDate().toLocaleString() 
                    : new Date(attempt.completedAt).toLocaleString();
                
                const scoreClass = attempt.score >= 80 ? 'color: #28a745;' : 
                                   attempt.score >= 50 ? 'color: #f57c00;' : 'color: #dc3545;';
                
                const statusBadge = attempt.status === 'completed' 
                    ? '<span style="background: #d4edda; color: #155724; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;"> Completed</span>'
                    : '<span style="background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;"> In Progress</span>';
                
                const wrongCount = attempt.questionResults ? 
                    attempt.questionResults.filter(q => !q.correct).length : 0;
                const totalCount = attempt.questionResults ? attempt.questionResults.length : 0;
                
                return `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 1rem;">
                            <div style="font-weight: 600;">${attempt.studentName || 'Unknown'}</div>
                            <div style="font-size: 0.8rem; color: #888;">${attempt.studentLevel || ''}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-weight: 500;">${attempt.worksheetInfo?.name || 'Unknown'}</div>
                            <div style="font-size: 0.8rem; color: #888;">${totalCount} questions</div>
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <div style="font-size: 1.3rem; font-weight: bold; ${scoreClass}">${attempt.score || 0}%</div>
                            ${wrongCount > 0 ? `<div style="font-size: 0.75rem; color: #dc3545;">${wrongCount} wrong</div>` : ''}
                        </td>
                        <td style="padding: 1rem; text-align: center;">${statusBadge}</td>
                        <td style="padding: 1rem; text-align: center; font-size: 0.85rem; color: #666;">${date}</td>
                        <td style="padding: 1rem; text-align: center;">
                            <button class="btn" style="background: #1976d2; color: white; padding: 6px 12px; font-size: 0.8rem;" 
                                    onclick="viewProgressDetail('${attempt.id}')">
                                 Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        window.filterProgressByWorksheet = function() {
            const value = document.getElementById('progress-worksheet-filter').value;
            applyProgressFilters();
        };

        window.filterProgressByStudent = function() {
            applyProgressFilters();
        };

        window.filterProgressByStatus = function() {
            applyProgressFilters();
        };

        window.applyProgressFilters = function() {
            const worksheetFilter = document.getElementById('progress-worksheet-filter').value;
            const studentFilter = document.getElementById('progress-student-filter').value;
            const statusFilter = document.getElementById('progress-status-filter').value;
            
            window.filteredProgressData = window.allProgressData.filter(d => {
                if (worksheetFilter !== 'all' && d.worksheetInfo?.name !== worksheetFilter) return false;
                if (studentFilter !== 'all' && d.studentName !== studentFilter) return false;
                if (statusFilter !== 'all' && d.status !== statusFilter) return false;
                return true;
            });
            
            updateProgressSummaryStats();
            renderProgressTable();
        };

        window.refreshStudentProgress = function() {
            loadStudentProgress();
        };

        window.viewProgressDetail = async function(attemptId) {
            const attempt = window.allProgressData.find(a => a.id === attemptId);
            if (!attempt) {
                alert("Attempt not found.");
                return;
            }
            
            // Populate header
            const header = document.getElementById('progress-detail-header');
            const date = attempt.completedAt?.toDate 
                ? attempt.completedAt.toDate().toLocaleString() 
                : new Date(attempt.completedAt).toLocaleString();
            
            header.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">Student</div>
                        <div style="font-weight: 600;">${attempt.studentName || 'Unknown'} (${attempt.studentLevel || 'N/A'})</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">Worksheet</div>
                        <div style="font-weight: 600;">${attempt.worksheetInfo?.name || 'Unknown'}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">Score</div>
                        <div style="font-weight: 600; font-size: 1.2rem; color: ${attempt.score >= 80 ? '#28a745' : attempt.score >= 50 ? '#f57c00' : '#dc3545'};">
                            ${attempt.score || 0}%
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">Date</div>
                        <div style="font-weight: 500;">${date}</div>
                    </div>
                </div>
            `;
            
            // Populate question results
            const questionsContainer = document.getElementById('progress-detail-questions');
            
            if (!attempt.questionResults || attempt.questionResults.length === 0) {
                questionsContainer.innerHTML = '<p style="color: #888; text-align: center;">No detailed question results available.</p>';
            } else {
                questionsContainer.innerHTML = attempt.questionResults.map((q, idx) => {
                    const isCorrect = q.correct;
                    const bgColor = isCorrect ? '#d4edda' : '#f8d7da';
                    const borderColor = isCorrect ? '#28a745' : '#dc3545';
                    const icon = isCorrect ? '' : '';
                    
                    return `
                        <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                <strong style="color: #333;">Question ${idx + 1}: ${q.questionTitle || 'Untitled'}</strong>
                                <span style="font-size: 1.2rem; color: ${borderColor};">${icon}</span>
                            </div>
                            <div style="font-size: 0.9rem; color: #555; margin-bottom: 0.5rem;">
                                <span style="background: white; padding: 2px 8px; border-radius: 4px; margin-right: 8px;">Topic: ${q.topic || 'N/A'}</span>
                                <span style="background: white; padding: 2px 8px; border-radius: 4px;">Type: ${q.type || 'N/A'}</span>
                            </div>
                            ${!isCorrect ? `
                                <div style="margin-top: 0.75rem; padding: 0.75rem; background: white; border-radius: 6px;">
                                    <div style="font-size: 0.85rem;">
                                        <span style="color: #dc3545;">Student's Answer:</span> ${q.studentAnswer || 'No answer'}
                                    </div>
                                    ${q.correctAnswer ? `
                                        <div style="font-size: 0.85rem; margin-top: 0.5rem;">
                                            <span style="color: #28a745;">Correct Answer:</span> ${q.correctAnswer}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('progress-detail-modal').classList.add('visible');
        };

        window.hideProgressDetailModal = function() {
            document.getElementById('progress-detail-modal').classList.remove('visible');
        };

        // Export progress data to CSV
        window.exportProgressToCSV = function() {
            if (window.filteredProgressData.length === 0) {
                alert("No data to export.");
                return;
            }
            
            const headers = ['Student', 'Level', 'Worksheet', 'Score', 'Status', 'Questions', 'Wrong', 'Date'];
            const rows = window.filteredProgressData.map(d => {
                const date = d.completedAt?.toDate 
                    ? d.completedAt.toDate().toLocaleString() 
                    : new Date(d.completedAt).toLocaleString();
                const wrongCount = d.questionResults ? d.questionResults.filter(q => !q.correct).length : 0;
                const totalCount = d.questionResults ? d.questionResults.length : 0;
                
                return [
                    d.studentName || 'Unknown',
                    d.studentLevel || 'N/A',
                    d.worksheetInfo?.name || 'Unknown',
                    (d.score || 0) + '%',
                    d.status || 'unknown',
                    totalCount,
                    wrongCount,
                    date
                ];
            });
            
            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `student_progress_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // Save worksheet attempt when student completes/submits
        window.saveWorksheetAttempt = async function(worksheetId, worksheetName, questionResults, status = 'completed') {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get student info
                const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                let studentName = 'Unknown';
                let studentLevel = 'N/A';
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    if (data.students && data.students.length > 0) {
                        studentName = data.students[0].name;
                        studentLevel = data.students[0].level;
                    } else if (data.studentName) {
                        studentName = data.studentName;
                        studentLevel = data.level || 'N/A';
                    }
                }
                
                // Calculate score
                const correctCount = questionResults.filter(q => q.correct).length;
                const totalCount = questionResults.length;
                const score = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;
                
                await addDoc(collection(window.db_fs, "worksheet_attempts"), {
                    worksheetId: worksheetId,
                    worksheetName: worksheetName,
                    userId: user.uid,
                    userEmail: user.email,
                    studentName: studentName,
                    studentLevel: studentLevel,
                    questionResults: questionResults,
                    score: score,
                    status: status,
                    completedAt: serverTimestamp()
                });
                
                console.log("Worksheet attempt saved successfully");
                
            } catch (e) {
                console.error("Error saving worksheet attempt:", e);
            }
        };

        // =====================================================
        // MESSAGING SYSTEM
        // =====================================================
        
        // Admin email (hidden from users, used internally)
        const ADMIN_EMAIL = 'chungzhikai@gmail.com';
        
        window.currentInboxTab = 'received';
        window.currentViewingMessage = null;

        // Load inbox messages
        window.loadInbox = async function() {
            const container = document.getElementById('inbox-messages-container');
            const emptyMsg = document.getElementById('inbox-empty-msg');
            
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Fetch all messages and filter client-side (avoids need for composite indexes)
                const snapshot = await getDocs(collection(window.db_fs, "messages"));
                
                // Filter messages based on current tab
                let messages = [];
                const now = new Date();
                
                snapshot.forEach(doc => {
                    const msg = { id: doc.id, ...doc.data() };
                    
                    // Check if message is deleted by this user
                    const isDeletedByMe = msg.deletedBy && msg.deletedBy.includes(user.uid);
                    
                    // For deleted tab, show messages deleted by this user
                    if (window.currentInboxTab === 'deleted') {
                        if (isDeletedByMe && (msg.recipientId === user.uid || msg.senderId === user.uid)) {
                            // Check if message is older than 30 days since deletion
                            const deletedAt = msg.deletedAt?.[user.uid];
                            if (deletedAt) {
                                const deletedDate = deletedAt.toDate ? deletedAt.toDate() : new Date(deletedAt);
                                const daysSinceDeleted = (now - deletedDate) / (1000 * 60 * 60 * 24);
                                if (daysSinceDeleted < 30) {
                                    msg.daysUntilPermanentDelete = Math.ceil(30 - daysSinceDeleted);
                                    messages.push(msg);
                                }
                            } else {
                                messages.push(msg);
                            }
                        }
                    } else if (window.currentInboxTab === 'received') {
                        // Show non-deleted received messages
                        if (msg.recipientId === user.uid && !isDeletedByMe) {
                            messages.push(msg);
                        }
                    } else if (window.currentInboxTab === 'sent') {
                        // Show non-deleted sent messages
                        if (msg.senderId === user.uid && !isDeletedByMe) {
                            messages.push(msg);
                        }
                    }
                });
                
                // Sort by date descending (client-side)
                messages.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return dateB - dateA;
                });
                
                if (messages.length === 0) {
                    container.innerHTML = '';
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'inbox-empty';
                    emptyDiv.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;">${window.currentInboxTab === 'deleted' ? '' : ''}</div>
                        <p>${window.currentInboxTab === 'deleted' ? 'No deleted messages' : 'No messages yet'}</p>
                        ${window.currentInboxTab === 'deleted' ? '<p style="font-size: 0.85rem; color: #888;">Deleted messages are permanently removed after 30 days</p>' : ''}
                    `;
                    container.appendChild(emptyDiv);
                    return;
                }
                
                container.innerHTML = '';
                
                messages.forEach(msg => {
                    const date = msg.createdAt ? new Date(msg.createdAt.toDate ? msg.createdAt.toDate() : msg.createdAt).toLocaleString() : 'Unknown';
                    const isUnread = !msg.read && window.currentInboxTab === 'received';
                    
                    // Format sender display with level if available
                    let senderDisplay = msg.senderName || 'Unknown';
                    if (msg.senderLevel) {
                        senderDisplay = `${msg.senderName} (${msg.senderLevel})`;
                    }
                    
                    const card = document.createElement('div');
                    card.className = `message-card ${isUnread ? 'unread' : ''} ${window.currentInboxTab === 'deleted' ? 'deleted-message' : ''}`;
                    card.style.cssText = window.currentInboxTab === 'deleted' ? 'border-left-color: #dc3545; opacity: 0.85;' : '';
                    
                    let cardContent = `
                        <div class="message-header">
                            <span class="message-from">
                                ${isUnread ? '<span class="unread-dot"></span>' : ''}
                                ${window.currentInboxTab === 'received' || window.currentInboxTab === 'deleted' ? senderDisplay : `To: ${msg.recipientName || 'Mr Chung'}`}
                            </span>
                            <span class="message-date">${date}</span>
                        </div>
                        <div class="message-subject">${msg.subject || 'No Subject'}</div>
                        <div class="message-preview">${(msg.message || '').substring(0, 100)}${msg.message?.length > 100 ? '...' : ''}</div>
                    `;
                    
                    if (msg.questionId && window.currentInboxTab !== 'deleted') {
                        cardContent += '<span style="font-size: 0.75rem; background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 4px; margin-top: 5px; display: inline-block;"> Has Question</span>';
                    }
                    
                    if (window.currentInboxTab === 'deleted' && msg.daysUntilPermanentDelete) {
                        cardContent += `<div style="font-size: 0.75rem; color: #dc3545; margin-top: 8px;"> Permanently deleted in ${msg.daysUntilPermanentDelete} days</div>`;
                        cardContent += `<button class="btn" style="background: #28a745; color: white; padding: 5px 10px; font-size: 0.8rem; margin-top: 8px;" onclick="event.stopPropagation(); restoreMessage('${msg.id}')"> Restore</button>`;
                    }
                    
                    card.innerHTML = cardContent;
                    card.onclick = () => viewMessage(msg.id);
                    container.appendChild(card);
                });
                
                // Update unread count
                updateUnreadCount();
                
            } catch (e) {
                console.error("Error loading inbox:", e);
                container.innerHTML = '<p style="color: #dc3545; text-align: center;">Error loading messages. Please try again.</p>';
            }
        };

        window.refreshInbox = function() {
            loadInbox();
        };

        window.switchInboxTab = function(tab) {
            window.currentInboxTab = tab;
            document.getElementById('inbox-tab-received').classList.toggle('active', tab === 'received');
            document.getElementById('inbox-tab-sent').classList.toggle('active', tab === 'sent');
            document.getElementById('inbox-tab-deleted').classList.toggle('active', tab === 'deleted');
            loadInbox();
        };

        // Update unread message count
        window.updateUnreadCount = async function() {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Fetch all messages and count unread client-side (avoids composite index)
                const snapshot = await getDocs(collection(window.db_fs, "messages"));
                let count = 0;
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    // Count unread messages that are not deleted by this user
                    const isDeletedByMe = msg.deletedBy && msg.deletedBy.includes(user.uid);
                    if (msg.recipientId === user.uid && msg.read === false && !isDeletedByMe) {
                        count++;
                    }
                });
                
                // Update header badge
                const headerBadge = document.getElementById('header-inbox-badge');
                if (headerBadge) {
                    headerBadge.textContent = count;
                    headerBadge.style.display = count > 0 ? 'flex' : 'none';
                }
            } catch (e) {
                console.error("Error updating unread count:", e);
            }
        };

        // View a single message
        window.viewMessage = async function(messageId) {
            try {
                const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const msgRef = doc(window.db_fs, "messages", messageId);
                const msgSnap = await getDoc(msgRef);
                
                if (!msgSnap.exists()) {
                    alert("Message not found.");
                    return;
                }
                
                const msg = { id: msgSnap.id, ...msgSnap.data() };
                window.currentViewingMessage = msg;
                
                // Mark as read if recipient
                const user = window.auth?.currentUser;
                if (user && msg.recipientId === user.uid && !msg.read) {
                    await updateDoc(msgRef, { read: true });
                    updateUnreadCount();
                }
                
                const date = msg.createdAt ? new Date(msg.createdAt.toDate ? msg.createdAt.toDate() : msg.createdAt).toLocaleString() : 'Unknown';
                const isReceived = msg.recipientId === user?.uid;
                
                // Format sender display with level
                let senderDisplay = msg.senderName || 'Unknown';
                if (msg.senderLevel) {
                    senderDisplay = `${msg.senderName} (${msg.senderLevel})`;
                }
                
                const content = document.getElementById('view-message-content');
                content.innerHTML = `
                    <div class="view-message-header">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                            ${isReceived ? 'From' : 'To'}: <strong>${isReceived ? senderDisplay : (msg.recipientName || 'Mr Chung')}</strong>
                            ${isReceived && msg.senderLevel ? `<span style="background: #e8f5e9; color: #388e3c; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 8px;">${msg.senderLevel}</span>` : ''}
                        </div>
                        <div style="font-size: 0.85rem; color: #888;">${date}</div>
                        <h3 style="margin: 0.5rem 0; color: #0288d1;">${msg.subject || 'No Subject'}</h3>
                    </div>
                    ${msg.questionContext ? `
                        <div class="view-message-question">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <strong> Related Question:</strong>
                                ${msg.questionId ? `<button class="btn" style="background: #1976d2; color: white; padding: 5px 12px; font-size: 0.8rem;" onclick="viewOriginalQuestion('${msg.questionId}')"> View Full Question</button>` : ''}
                            </div>
                            <div style="color: #555;">${msg.questionContext}</div>
                        </div>
                    ` : ''}
                    <div class="view-message-body">${msg.message || ''}</div>
                `;
                
                // Show/hide reply button based on whether this is a received message
                document.getElementById('btn-reply-message').style.display = isReceived ? 'inline-block' : 'none';
                
                document.getElementById('view-message-modal').classList.add('visible');
                
            } catch (e) {
                console.error("Error viewing message:", e);
                alert("Error loading message.");
            }
        };

        // View original question from message
        window.viewOriginalQuestion = function(questionId) {
            const questionElement = document.getElementById(questionId);
            
            if (questionElement) {
                // Clone the question for the popup
                const clone = questionElement.cloneNode(true);
                clone.id = 'popup-question-clone';
                
                // Remove controls from clone
                clone.querySelectorAll('.worksheet-control-bar, .admin-controls').forEach(el => el.remove());
                
                // Show in a popup modal
                const popupContent = document.getElementById('question-popup-content');
                popupContent.innerHTML = '';
                popupContent.appendChild(clone);
                
                document.getElementById('question-popup-modal').classList.add('visible');
            } else {
                alert("Question not found. It may have been deleted or moved.");
            }
        };

        window.hideQuestionPopup = function() {
            document.getElementById('question-popup-modal').classList.remove('visible');
        };

        window.hideViewMessageModal = function() {
            document.getElementById('view-message-modal').classList.remove('visible');
            window.currentViewingMessage = null;
            loadInbox(); // Refresh inbox to update read status
        };

        // Delete current message (move to trash)
        window.deleteCurrentMessage = async function() {
            if (!window.currentViewingMessage) return;
            
            if (!confirm("Move this message to deleted folder? It will be permanently deleted after 30 days.")) return;
            
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { doc, updateDoc, arrayUnion } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const msgRef = doc(window.db_fs, "messages", window.currentViewingMessage.id);
                
                // Add user to deletedBy array and record deletion time
                await updateDoc(msgRef, {
                    deletedBy: arrayUnion(user.uid),
                    [`deletedAt.${user.uid}`]: new Date()
                });
                
                alert("Message moved to deleted folder.");
                hideViewMessageModal();
                
            } catch (e) {
                console.error("Error deleting message:", e);
                alert("Error deleting message: " + e.message);
            }
        };

        // Restore a deleted message
        window.restoreMessage = async function(messageId) {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { doc, updateDoc, arrayRemove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const msgRef = doc(window.db_fs, "messages", messageId);
                
                // Remove user from deletedBy array
                await updateDoc(msgRef, {
                    deletedBy: arrayRemove(user.uid)
                });
                
                alert("Message restored!");
                loadInbox();
                
            } catch (e) {
                console.error("Error restoring message:", e);
                alert("Error restoring message: " + e.message);
            }
        };

        // =====================================================
        // ACCOUNT SETTINGS
        // =====================================================

        window.showAccountSettings = async function() {
            const user = window.auth?.currentUser;
            if (!user) {
                alert("Please login first.");
                return;
            }
            
            // Show email
            document.getElementById('settings-email').textContent = user.email;
            
            // Clear password fields
            document.getElementById('settings-new-password').value = '';
            document.getElementById('settings-confirm-password').value = '';
            
            // Load student info
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const studentsContainer = document.getElementById('settings-students-list');
                    studentsContainer.innerHTML = '';
                    
                    // Check if using new students array or old format
                    if (userData.students && Array.isArray(userData.students)) {
                        userData.students.forEach((student, index) => {
                            const entry = document.createElement('div');
                            entry.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                            entry.innerHTML = `
                                <input type="text" class="auth-input student-name-input" value="${student.name || ''}" 
                                       data-index="${index}" placeholder="Student Name" 
                                       style="flex: 1; margin: 0;">
                                <span style="background: #e8f5e9; color: #388e3c; padding: 8px 16px; border-radius: 8px; font-weight: 600; min-width: 60px; text-align: center;">
                                    ${student.level || 'N/A'}
                                </span>
                            `;
                            studentsContainer.appendChild(entry);
                        });
                    } else if (userData.studentName) {
                        // Old format - single student
                        const entry = document.createElement('div');
                        entry.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                        entry.innerHTML = `
                            <input type="text" class="auth-input student-name-input" value="${userData.studentName || ''}" 
                                   data-index="0" placeholder="Student Name" 
                                   style="flex: 1; margin: 0;">
                            <span style="background: #e8f5e9; color: #388e3c; padding: 8px 16px; border-radius: 8px; font-weight: 600; min-width: 60px; text-align: center;">
                                ${userData.level || 'N/A'}
                            </span>
                        `;
                        studentsContainer.appendChild(entry);
                    } else {
                        studentsContainer.innerHTML = '<p style="color: #666;">No students registered</p>';
                    }
                }
            } catch (e) {
                console.error("Error loading user data:", e);
            }
            
            document.getElementById('account-settings-modal').classList.add('visible');
        };

        window.hideAccountSettings = function() {
            document.getElementById('account-settings-modal').classList.remove('visible');
        };

        window.saveAccountSettings = async function() {
            const user = window.auth?.currentUser;
            if (!user) return;
            
            try {
                const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const userRef = doc(window.db_fs, "users", user.uid);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const nameInputs = document.querySelectorAll('.student-name-input');
                    
                    if (userData.students && Array.isArray(userData.students)) {
                        // Update students array
                        const updatedStudents = [...userData.students];
                        nameInputs.forEach(input => {
                            const index = parseInt(input.dataset.index, 10);
                            if (updatedStudents[index]) {
                                updatedStudents[index].name = input.value.trim();
                            }
                        });
                        await updateDoc(userRef, { students: updatedStudents });
                    } else if (nameInputs.length > 0) {
                        // Old format - update studentName
                        await updateDoc(userRef, { studentName: nameInputs[0].value.trim() });
                    }
                    
                    alert("Settings saved successfully!");
                    hideAccountSettings();
                }
            } catch (e) {
                console.error("Error saving settings:", e);
                alert("Error saving settings: " + e.message);
            }
        };

        window.changePassword = async function() {
            const newPassword = document.getElementById('settings-new-password').value;
            const confirmPassword = document.getElementById('settings-confirm-password').value;
            
            if (!newPassword || !confirmPassword) {
                alert("Please fill in both password fields.");
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert("Passwords do not match.");
                return;
            }
            
            if (newPassword.length < 6) {
                alert("Password must be at least 6 characters.");
                return;
            }
            
            try {
                const user = window.auth?.currentUser;
                if (!user) {
                    alert("Please login again to change your password.");
                    return;
                }
                
                const { updatePassword } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
                
                await updatePassword(user, newPassword);
                
                alert("Password updated successfully!");
                document.getElementById('settings-new-password').value = '';
                document.getElementById('settings-confirm-password').value = '';
                
            } catch (e) {
                console.error("Error changing password:", e);
                if (e.code === 'auth/requires-recent-login') {
                    alert("For security, please logout and login again before changing your password.");
                } else {
                    alert("Error changing password: " + e.message);
                }
            }
        };

        // Reply to a message
        window.replyToMessage = function() {
            if (!window.currentViewingMessage) return;
            
            const msg = window.currentViewingMessage;
            hideViewMessageModal();
            
            // Open new message modal with pre-filled info
            document.getElementById('new-message-modal').classList.add('visible');
            document.getElementById('new-message-subject').value = `Re: ${msg.subject || 'No Subject'}`;
            document.getElementById('new-message-content').value = '';
            
            // Store the recipient info for sending
            window.replyToRecipient = {
                id: msg.senderId,
                name: msg.senderName,
                email: msg.senderEmail
            };
            
            // Hide recipient select for replies
            document.getElementById('recipient-select-group').style.display = 'none';
        };

        // Show new message modal
        window.showNewMessageModal = async function() {
            window.replyToRecipient = null;
            document.getElementById('recipient-select-group').style.display = 'block';
            document.getElementById('new-message-subject').value = '';
            document.getElementById('new-message-content').value = '';
            
            // If admin, load all students as potential recipients
            const select = document.getElementById('message-recipient');
            select.innerHTML = '<option value="">-- Select Recipient --</option>';
            
            if (window.isAdminUser) {
                // Admin can message any student
                try {
                    const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                    const usersSnap = await getDocs(collection(window.db_fs, "users"));
                    
                    const students = [];
                    usersSnap.forEach(doc => {
                        const userData = doc.data();
                        if (userData.email !== ADMIN_EMAIL) {
                            const studentName = userData.studentName || userData.parentName || 'Student';
                            const level = userData.level || (userData.students && userData.students[0]?.level) || '';
                            students.push({
                                id: doc.id,
                                email: userData.email,
                                name: studentName,
                                level: level,
                                displayName: level ? `${studentName} (${level})` : studentName
                            });
                        }
                    });
                    
                    // Sort by level then name
                    students.sort((a, b) => {
                        if (a.level && b.level) {
                            if (a.level !== b.level) return a.level.localeCompare(b.level);
                        }
                        return a.name.localeCompare(b.name);
                    });
                    
                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.dataset.email = student.email;
                        option.dataset.name = student.name;
                        option.dataset.level = student.level;
                        option.textContent = student.displayName;
                        select.appendChild(option);
                    });
                    
                    // Add "All Students" option for broadcast
                    const allOption = document.createElement('option');
                    allOption.value = 'all';
                    allOption.textContent = ' All Students (Broadcast)';
                    select.insertBefore(allOption, select.options[1]);
                    
                } catch (e) {
                    console.error("Error loading students:", e);
                }
            } else {
                // Students can only message admin
                const option = document.createElement('option');
                option.value = 'admin';
                option.textContent = 'Mr Chung (Teacher)';
                select.appendChild(option);
            }
            
            document.getElementById('new-message-modal').classList.add('visible');
        };

        window.hideNewMessageModal = function() {
            document.getElementById('new-message-modal').classList.remove('visible');
            window.replyToRecipient = null;
        };

        // Send a new message
        window.sendNewMessage = async function() {
            const subject = document.getElementById('new-message-subject').value.trim();
            const message = document.getElementById('new-message-content').value.trim();
            
            if (!subject || !message) {
                alert("Please fill in subject and message.");
                return;
            }
            
            try {
                const user = window.auth?.currentUser;
                if (!user) {
                    alert("Please login first.");
                    return;
                }
                
                const { collection, addDoc, getDocs, query, where, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get sender info
                const senderDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                const senderData = senderDoc.exists() ? senderDoc.data() : {};
                const senderName = senderData.studentName || senderData.parentName || user.email;
                
                let recipients = [];
                
                if (window.replyToRecipient) {
                    // Reply to specific person
                    recipients.push(window.replyToRecipient);
                } else {
                    // New message - check recipient select
                    const select = document.getElementById('message-recipient');
                    const selectedValue = select.value;
                    const selectedOption = select.options[select.selectedIndex];
                    
                    if (!selectedValue) {
                        alert("Please select a recipient.");
                        return;
                    }
                    
                    if (selectedValue === 'admin') {
                        // Find admin user ID by fetching all users and filtering
                        const usersSnap = await getDocs(collection(window.db_fs, "users"));
                        let adminFound = false;
                        usersSnap.forEach(adminDoc => {
                            if (adminDoc.data().email === ADMIN_EMAIL) {
                                recipients.push({
                                    id: adminDoc.id,
                                    email: ADMIN_EMAIL,
                                    name: 'Mr Chung'
                                });
                                adminFound = true;
                            }
                        });
                        if (!adminFound) {
                            // Create placeholder if admin hasn't logged in yet
                            recipients.push({
                                id: 'admin_placeholder',
                                email: ADMIN_EMAIL,
                                name: 'Mr Chung'
                            });
                        }
                    } else if (selectedValue === 'all') {
                        // Broadcast to all students
                        const usersSnap = await getDocs(collection(window.db_fs, "users"));
                        usersSnap.forEach(userDoc => {
                            const userData = userDoc.data();
                            if (userData.email !== ADMIN_EMAIL && userDoc.id !== user.uid) {
                                recipients.push({
                                    id: userDoc.id,
                                    email: userData.email,
                                    name: userData.studentName || userData.parentName || 'Student'
                                });
                            }
                        });
                    } else {
                        // Specific student
                        recipients.push({
                            id: selectedValue,
                            email: selectedOption.dataset.email,
                            name: selectedOption.dataset.name
                        });
                    }
                }
                
                // Send message to each recipient
                for (const recipient of recipients) {
                    await addDoc(collection(window.db_fs, "messages"), {
                        senderId: user.uid,
                        senderEmail: user.email,
                        senderName: senderName,
                        recipientId: recipient.id,
                        recipientEmail: recipient.email,
                        recipientName: recipient.name,
                        subject: subject,
                        message: message,
                        read: false,
                        createdAt: new Date()
                    });
                }
                
                alert(`Message sent successfully${recipients.length > 1 ? ` to ${recipients.length} recipients` : ''}!`);
                hideNewMessageModal();
                loadInbox();
                
            } catch (e) {
                console.error("Error sending message:", e);
                alert("Error sending message: " + e.message);
            }
        };

        // =====================================================
        // CONSULT MR CHUNG FUNCTIONALITY
        // =====================================================

        window.currentConsultQuestion = null;

        window.showConsultModal = function(questionElement) {
            // Get question content
            const questionContainer = questionElement.closest('.question-container');
            if (!questionContainer) {
                alert("Could not find question.");
                return;
            }
            
            // Get question title and content
            const title = questionContainer.querySelector('h3')?.textContent || 'Question';
            const questionText = questionContainer.querySelector('p')?.textContent || '';
            
            // Store for sending
            window.currentConsultQuestion = {
                id: questionContainer.id,
                title: title,
                preview: `${title}: ${questionText.substring(0, 200)}${questionText.length > 200 ? '...' : ''}`
            };
            
            // Show preview
            document.getElementById('consult-question-preview').innerHTML = `
                <strong> Question Reference:</strong><br>
                ${window.currentConsultQuestion.preview}
            `;
            
            document.getElementById('consult-message').value = '';
            document.getElementById('consult-modal').classList.add('visible');
        };

        window.hideConsultModal = function() {
            document.getElementById('consult-modal').classList.remove('visible');
            window.currentConsultQuestion = null;
        };

        window.sendConsultMessage = async function() {
            const message = document.getElementById('consult-message').value.trim();
            
            if (!message) {
                alert("Please enter your question or message.");
                return;
            }
            
            try {
                const user = window.auth?.currentUser;
                if (!user) {
                    alert("Please login first.");
                    return;
                }
                
                const { collection, addDoc, getDocs, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get sender info including level
                const senderDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                const senderData = senderDoc.exists() ? senderDoc.data() : {};
                const senderName = senderData.studentName || senderData.parentName || user.email;
                const senderLevel = senderData.level || (senderData.students && senderData.students[0]?.level) || '';
                
                // Find admin user ID by fetching all users and filtering
                let adminId = 'admin_placeholder';
                const usersSnap = await getDocs(collection(window.db_fs, "users"));
                usersSnap.forEach(adminDoc => {
                    if (adminDoc.data().email === ADMIN_EMAIL) {
                        adminId = adminDoc.id;
                    }
                });
                
                // Create message with student info
                await addDoc(collection(window.db_fs, "messages"), {
                    senderId: user.uid,
                    senderEmail: user.email,
                    senderName: senderName,
                    senderLevel: senderLevel,
                    recipientId: adminId,
                    recipientEmail: ADMIN_EMAIL,
                    recipientName: 'Mr Chung',
                    subject: `Question about: ${window.currentConsultQuestion?.title || 'Practice Question'}`,
                    message: message,
                    questionContext: window.currentConsultQuestion?.preview || '',
                    questionId: window.currentConsultQuestion?.id || '',
                    read: false,
                    createdAt: new Date()
                });
                
                alert("Message sent to Mr Chung! You will receive a reply in your inbox.");
                hideConsultModal();
                updateUnreadCount();
                
            } catch (e) {
                console.error("Error sending message:", e);
                alert("Error sending message: " + e.message);
            }
        };

        // Add Consult button to all question containers
        window.addConsultButtons = function() {
            document.querySelectorAll('.question-container').forEach(container => {
                // Check if buttons already exist
                if (container.querySelector('.consult-btn')) return;
                
                // Find the controls div or create button placement
                const controls = container.querySelector('.controls');
                if (controls) {
                    // Check if add-to-worksheet button exists
                    const addBtn = controls.querySelector('.add-to-worksheet-btn, button[onclick*="addToWorksheet"]');
                    
                    // Create consult button
                    const consultBtn = document.createElement('button');
                    consultBtn.className = 'consult-btn';
                    consultBtn.type = 'button';
                    consultBtn.innerHTML = ' Ask Mr Chung';
                    consultBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        showConsultModal(this);
                    };
                    
                    // Create print button
                    const printBtn = document.createElement('button');
                    printBtn.className = 'print-question-btn';
                    printBtn.type = 'button';
                    printBtn.innerHTML = ' Print';
                    printBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        printSingleQuestion(container);
                    };
                    
                    // Create flag button
                    const flagBtn = document.createElement('button');
                    flagBtn.className = 'flag-question-btn';
                    flagBtn.type = 'button';
                    flagBtn.innerHTML = ' Flag';
                    flagBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        showFlagModal(container);
                    };
                    
                    if (addBtn) {
                        addBtn.insertAdjacentElement('afterend', consultBtn);
                        consultBtn.insertAdjacentElement('afterend', printBtn);
                        printBtn.insertAdjacentElement('afterend', flagBtn);
                    } else {
                        controls.insertBefore(flagBtn, controls.firstChild);
                        controls.insertBefore(printBtn, controls.firstChild);
                        controls.insertBefore(consultBtn, controls.firstChild);
                    }
                }
            });
        };

        // Print a single question
        window.printSingleQuestion = function(questionContainer) {
            if (!questionContainer) return;
            
            // Get question title
            const titleEl = questionContainer.querySelector('h3');
            const title = titleEl ? titleEl.textContent.trim() : 'Question';
            
            // Check if exam mode is enabled
            const isExamMode = window.examModeEnabled || false;
            
            // Clone the question content
            const clone = questionContainer.cloneNode(true);
            
            // Remove buttons and controls from the clone
            clone.querySelectorAll('.controls, .consult-btn, .print-question-btn, .add-to-worksheet-btn, .worksheet-added-btn, button').forEach(el => el.remove());
            
            // Remove any hidden elements
            clone.querySelectorAll('.hidden, [style*="display: none"]').forEach(el => el.remove());
            
            // Exam mode styles
            const examModeStyles = isExamMode ? `
                body, .question-body, .answer-template, .answer-box {
                    filter: grayscale(100%);
                    -webkit-filter: grayscale(100%);
                }
                img {
                    filter: grayscale(100%) contrast(1.1);
                    -webkit-filter: grayscale(100%) contrast(1.1);
                }
                h3 {
                    color: #000 !important;
                    border-bottom-color: #333 !important;
                }
                .question-body {
                    background: #f5f5f5 !important;
                    border-left-color: #333 !important;
                }
            ` : '';
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        * {
                            box-sizing: border-box;
                        }
                        body {
                            font-family: 'Poppins', 'Segoe UI', sans-serif;
                            padding: 2rem;
                            max-width: 800px;
                            margin: 0 auto;
                            color: #333;
                            line-height: 1.6;
                        }
                        h3 {
                            color: #1976d2;
                            border-bottom: 2px solid #1976d2;
                            padding-bottom: 10px;
                            margin-top: 0;
                        }
                        .question-body {
                            background: #f8f9fa;
                            padding: 1.5rem;
                            border-radius: 12px;
                            border-left: 4px solid #1976d2;
                        }
                        .answer-box, .answer-template {
                            background: white;
                            padding: 1rem;
                            border-radius: 8px;
                            margin: 1rem 0;
                        }
                        input[type="text"], .blank-input {
                            border: none;
                            border-bottom: 2px solid #333;
                            background: transparent;
                            min-width: 100px;
                            padding: 2px 5px;
                        }
                        .header-info {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 1.5rem;
                            padding-bottom: 1rem;
                            border-bottom: 1px dashed #ccc;
                        }
                        table {
                            border-collapse: collapse;
                            width: 100%;
                            margin: 1rem 0;
                        }
                        td, th {
                            border: 1px solid #ddd;
                            padding: 8px;
                        }
                        img {
                            max-width: 100%;
                            height: auto;
                        }
                        .exam-mode-indicator {
                            background: #f5f5f5;
                            padding: 5px 10px;
                            border-radius: 4px;
                            font-size: 0.8rem;
                            color: #666;
                            display: ${isExamMode ? 'inline-block' : 'none'};
                        }
                        .print-btn-container {
                            text-align: center;
                            margin-top: 2rem;
                        }
                        .print-btn-container button {
                            padding: 12px 24px;
                            background: #1976d2;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1rem;
                            font-weight: 600;
                        }
                        .print-btn-container button:hover {
                            background: #1565c0;
                        }
                        ${examModeStyles}
                        @media print {
                            .print-btn-container {
                                display: none;
                            }
                            body {
                                padding: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header-info">
                        <span>Name: _______________________</span>
                        <span>Date: _______________</span>
                        <span class="exam-mode-indicator"> Exam Mode</span>
                    </div>
                    ${clone.innerHTML}
                    <div class="print-btn-container">
                        <button onclick="window.print()"> Print Question</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        // =====================================================
        // FLAG QUESTION FUNCTIONALITY
        // =====================================================

        window.currentFlaggedQuestion = null;
        window.flaggedQuestions = [];
        window.currentFlaggedTab = 'pending';

        // Show flag modal
        window.showFlagModal = function(questionContainer) {
            if (!questionContainer) return;
            
            window.currentFlaggedQuestion = questionContainer;
            
            // Get question title
            const titleEl = questionContainer.querySelector('h3');
            const title = titleEl ? titleEl.textContent.trim() : 'Question';
            
            document.getElementById('flag-question-title').textContent = title;
            document.getElementById('flag-comment-input').value = '';
            document.getElementById('flag-question-modal').classList.add('visible');
        };

        // Hide flag modal
        window.hideFlagModal = function() {
            document.getElementById('flag-question-modal').classList.remove('visible');
            window.currentFlaggedQuestion = null;
        };

        // Submit flag (will be connected to Firebase in module)
        window.submitFlag = async function() {
            const comment = document.getElementById('flag-comment-input').value.trim();
            
            if (!comment) {
                alert('Please describe what is wrong with the question.');
                return;
            }
            
            if (!window.currentFlaggedQuestion) {
                alert('No question selected.');
                return;
            }
            
            const questionContainer = window.currentFlaggedQuestion;
            const titleEl = questionContainer.querySelector('h3');
            const questionTitle = titleEl ? titleEl.textContent.trim() : 'Unknown Question';
            const questionId = questionContainer.id || `q-${Date.now()}`;
            
            // Get question type/category from URL or tab
            const questionType = window.currentActiveTab || 'cer';
            
            // Call Firebase function if available
            if (window.submitFlagToFirebase) {
                await window.submitFlagToFirebase({
                    questionId: questionId,
                    questionTitle: questionTitle,
                    questionType: questionType,
                    comment: comment,
                    questionHtml: questionContainer.innerHTML
                });
            } else {
                console.log('Flag submitted:', { questionId, questionTitle, questionType, comment });
                alert('Thank you for reporting this issue! An admin will review it soon.');
            }
            
            hideFlagModal();
        };

        // Load flagged questions (admin only)
        window.loadFlaggedQuestions = async function() {
            if (!window.isAdminUser) return;
            
            const container = document.getElementById('flagged-questions-container');
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #888;">Loading flagged questions...</div>';
            
            if (window.loadFlaggedQuestionsFromFirebase) {
                await window.loadFlaggedQuestionsFromFirebase();
            }
            
            renderFlaggedQuestions();
        };

        // Render flagged questions based on current tab
        window.renderFlaggedQuestions = function() {
            const container = document.getElementById('flagged-questions-container');
            const emptyMsg = document.getElementById('flagged-empty-msg');
            
            let filtered = window.flaggedQuestions || [];
            
            if (window.currentFlaggedTab === 'pending') {
                filtered = filtered.filter(q => q.status !== 'resolved');
            } else if (window.currentFlaggedTab === 'resolved') {
                filtered = filtered.filter(q => q.status === 'resolved');
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '';
                if (emptyMsg) {
                    emptyMsg.style.display = 'block';
                    emptyMsg.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;">${window.currentFlaggedTab === 'resolved' ? '' : ''}</div>
                        <p>${window.currentFlaggedTab === 'pending' ? 'No pending flags' : window.currentFlaggedTab === 'resolved' ? 'No resolved flags' : 'No flagged questions'}</p>
                    `;
                }
                return;
            }
            
            if (emptyMsg) emptyMsg.style.display = 'none';
            
            container.innerHTML = filtered.map(flag => `
                <div class="flagged-question-card ${flag.status === 'resolved' ? 'resolved' : ''}" data-flag-id="${flag.id}">
                    <div class="flagged-question-header">
                        <div>
                            <div class="flagged-question-title">${flag.questionTitle || 'Unknown Question'}</div>
                            <div class="flagged-question-meta">
                                <span>Type: ${flag.questionType || 'N/A'}</span>  
                                <span>Flagged by: ${flag.userEmail || 'Anonymous'}</span>  
                                <span>${flag.createdAt ? new Date(flag.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown date'}</span>
                            </div>
                        </div>
                        <span class="flagged-status-badge ${flag.status === 'resolved' ? 'resolved' : 'pending'}">
                            ${flag.status === 'resolved' ? ' Resolved' : ' Pending'}
                        </span>
                    </div>
                    <div class="flagged-question-comment">${flag.comment || 'No comment provided'}</div>
                    <div class="flagged-question-actions">
                        <button class="btn" style="background: #667eea; color: white;" onclick="viewFlaggedQuestion('${flag.id}')"> View Question</button>
                        <button class="btn" style="background: #4CAF50; color: white;" onclick="editFlaggedQuestion('${flag.questionId}')"> Edit</button>
                        ${flag.status !== 'resolved' ? 
                            `<button class="btn" style="background: #ff9800; color: white;" onclick="resolveFlaggedQuestion('${flag.id}')"> Mark Resolved</button>` : 
                            `<button class="btn" style="background: #9e9e9e; color: white;" onclick="reopenFlaggedQuestion('${flag.id}')"> Reopen</button>`
                        }
                        <button class="btn" style="background: #dc3545; color: white;" onclick="deleteFlaggedQuestion('${flag.id}')"> Delete Flag</button>
                    </div>
                </div>
            `).join('');
        };

        // Switch flagged questions tab
        window.switchFlaggedTab = function(tab) {
            window.currentFlaggedTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('[id^="flagged-tab-"]').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(`flagged-tab-${tab}`);
            if (activeBtn) activeBtn.classList.add('active');
            
            renderFlaggedQuestions();
        };

        // View flagged question (show modal with question content)
        window.viewFlaggedQuestion = function(flagId) {
            const flag = window.flaggedQuestions.find(f => f.id === flagId);
            if (!flag || !flag.questionHtml) {
                alert('Question content not available.');
                return;
            }
            
            const content = document.getElementById('question-popup-content');
            content.innerHTML = flag.questionHtml;
            document.getElementById('question-popup-modal').classList.add('visible');
        };

        // Edit flagged question (navigate to question)
        window.editFlaggedQuestion = function(questionId) {
            // Try to find and scroll to the question
            const question = document.getElementById(questionId);
            if (question) {
                // Switch to the appropriate tab
                const flag = window.flaggedQuestions.find(f => f.questionId === questionId);
                if (flag && flag.questionType) {
                    switchTab(flag.questionType, document.querySelector(`.tab-btn[data-type="${flag.questionType}"]`));
                }
                setTimeout(() => {
                    question.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    question.style.boxShadow = '0 0 20px rgba(255, 152, 0, 0.5)';
                    setTimeout(() => question.style.boxShadow = '', 3000);
                }, 300);
            } else {
                alert('Could not locate question. It may have been deleted or is from a different level.');
            }
        };

        // Resolve flagged question (will be connected to Firebase in module)
        window.resolveFlaggedQuestion = async function(flagId) {
            if (window.updateFlagStatusInFirebase) {
                await window.updateFlagStatusInFirebase(flagId, 'resolved');
            }
            
            // Update local data
            const flag = window.flaggedQuestions.find(f => f.id === flagId);
            if (flag) flag.status = 'resolved';
            
            renderFlaggedQuestions();
            updateFlaggedCount();
        };

        // Reopen flagged question
        window.reopenFlaggedQuestion = async function(flagId) {
            if (window.updateFlagStatusInFirebase) {
                await window.updateFlagStatusInFirebase(flagId, 'pending');
            }
            
            const flag = window.flaggedQuestions.find(f => f.id === flagId);
            if (flag) flag.status = 'pending';
            
            renderFlaggedQuestions();
            updateFlaggedCount();
        };

        // Delete flagged question (will be connected to Firebase in module)
        window.deleteFlaggedQuestion = async function(flagId) {
            if (!confirm('Are you sure you want to delete this flag? This cannot be undone.')) return;
            
            if (window.deleteFlagFromFirebase) {
                await window.deleteFlagFromFirebase(flagId);
            }
            
            window.flaggedQuestions = window.flaggedQuestions.filter(f => f.id !== flagId);
            renderFlaggedQuestions();
            updateFlaggedCount();
        };

        // Update flagged count badge
        window.updateFlaggedCount = function() {
            const badge = document.getElementById('header-flagged-badge');
            if (!badge) return;
            
            const pendingCount = (window.flaggedQuestions || []).filter(f => f.status !== 'resolved').length;
            
            if (pendingCount > 0) {
                badge.textContent = pendingCount > 99 ? '99+' : pendingCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        };

        // =====================================================
        // TAB & VIEW SWITCHING
        // =====================================================

        window.switchTab = function (type, btn) {
            window.currentActiveTab = type;

            // Close mobile sidebar if open
            if (window.innerWidth <= 768) {
                closeMobileSidebar();
            }

            // Update button states
            const allBtns = document.querySelectorAll('.tab-btn, #btn-sidebar-admin, #btn-sidebar-worksheet, #btn-sidebar-saved-worksheets, #btn-sidebar-practice, #btn-sidebar-lessons, #btn-sidebar-progress, #btn-sidebar-leaderboard, #btn-sidebar-my-progress, #header-inbox-btn, #header-flagged-btn');
            allBtns.forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            // Hide all views
            const mainContentArea = document.getElementById('main-content-area');
            mainContentArea.querySelectorAll('.view-content').forEach(el => {
                el.classList.add('hidden');
            });
            
            // List of special tabs (admin, worksheet, etc) - these need topic containers hidden
            const specialTabs = ['admin', 'worksheet', 'saved-worksheets', 'practice', 'inbox', 'lessons', 'lesson-detail', 'student-progress', 'my-progress', 'flagged', 'leaderboard', 'question-list'];
            
            // Hide all topic containers for special tabs (practice mode should be a full-page view)
            if (specialTabs.includes(type)) {
                mainContentArea.querySelectorAll('.topic-content').forEach(el => {
                    el.classList.add('hidden');
                });
            }

            // Show target view
            const target = document.getElementById(`view-${type}`);
            if (target) {
                target.classList.remove('hidden');
            }

            // Handle sidebar visibility
            const oeqSidebarContent = document.getElementById('oeq-sidebar-content');
            const mcqSidebarContent = document.getElementById('mcq-sidebar-content');
            
            // List of all OEQ tabs
            const oeqTabs = ['cer', 'definition', 'single-relationship', 'double-relationship', 'fairness', 'reliability', 'accuracy', 'constant-variable', 'explanation', 'control-setup'];
            
            if (oeqSidebarContent && mcqSidebarContent) {
                if (oeqTabs.includes(type)) {
                    // Show OEQ sidebar for all OEQ tabs and update topics
                    oeqSidebarContent.classList.remove('hidden');
                    mcqSidebarContent.classList.add('hidden');
                    window.currentOeqTab = type;
                    updateOeqSidebar(type);
                } else if (specialTabs.includes(type)) {
                    // Hide both sidebars for special tabs
                    oeqSidebarContent.classList.add('hidden');
                    mcqSidebarContent.classList.add('hidden');
                }
            }

            // Update border color and header line color
            const appBody = document.querySelector('.app-body');
            const headerLine = document.getElementById('header-color-line');
            if (window.typeColors[type]) {
                const color = window.typeColors[type];
                if (appBody) {
                    appBody.style.borderTopColor = color;
                }
                if (headerLine) {
                    // Create a gradient effect for the line
                    const lighterColor = adjustColorBrightness(color, 20);
                    headerLine.style.background = `linear-gradient(90deg, ${color} 0%, ${lighterColor} 50%, ${color} 100%)`;
                }
            }

            // Refresh worksheet UI when switching to worksheet tab
            if (type === 'worksheet') {
                updateWorksheetUI();
            }
            
            // Load saved worksheets when switching to that tab
            if (type === 'saved-worksheets') {
                loadSavedWorksheets();
            }
            
            // Load shared lessons when switching to lessons tab
            if (type === 'lessons') {
                loadSharedLessons();
            }
            
            // Load practice mode when switching to practice tab
            if (type === 'practice') {
                loadPracticeMode();
            }
            
            // Load inbox when switching to inbox tab
            if (type === 'inbox') {
                loadInbox();
            }
            
            // Load student progress when switching to student-progress tab
            if (type === 'student-progress') {
                loadStudentProgress();
            }
            
            // Load leaderboard when switching to leaderboard tab
            if (type === 'leaderboard') {
                loadLeaderboard();
            }
            
            // Load my progress when switching to my-progress tab
            if (type === 'my-progress') {
                loadMyProgress();
            }
            
            // Load question list when switching to question-list tab
            if (type === 'question-list') {
                loadQuestionList();
            }
            
            // Update version display when switching to admin tab
            if (type === 'admin') {
                updateVersionDisplay();
            }
            
            // Load flagged questions when switching to flagged tab
            if (type === 'flagged') {
                loadFlaggedQuestions();
            }
        };
        
        // Helper function to adjust color brightness
        function adjustColorBrightness(hex, percent) {
            // Remove # if present
            hex = hex.replace('#', '');
            
            // Parse the hex color
            let r = parseInt(hex.substring(0, 2), 16);
            let g = parseInt(hex.substring(2, 4), 16);
            let b = parseInt(hex.substring(4, 6), 16);
            
            // Adjust brightness
            r = Math.min(255, Math.floor(r + (255 - r) * (percent / 100)));
            g = Math.min(255, Math.floor(g + (255 - g) * (percent / 100)));
            b = Math.min(255, Math.floor(b + (255 - b) * (percent / 100)));
            
            // Convert back to hex
            return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        // =====================================================
        // MODE SWITCHING (OEQ/MCQ)
        // =====================================================

        window.currentMode = 'oeq';
        window.examModeEnabled = false;

        // Toggle mode using iOS-style switch
        window.toggleMode = function() {
            const newMode = window.currentMode === 'oeq' ? 'mcq' : 'oeq';
            switchMode(newMode);
        };

        // Toggle Exam Mode (Colour/Monochrome)
        window.toggleExamMode = function() {
            window.examModeEnabled = !window.examModeEnabled;
            const toggleContainer = document.querySelector('.exam-mode-toggle-container');
            
            if (window.examModeEnabled) {
                document.body.classList.add('exam-mode');
                if (toggleContainer) toggleContainer.classList.add('exam-active');
                localStorage.setItem('examMode', 'true');
            } else {
                document.body.classList.remove('exam-mode');
                if (toggleContainer) toggleContainer.classList.remove('exam-active');
                localStorage.setItem('examMode', 'false');
            }
        };

        // Initialize exam mode from localStorage
        window.initExamMode = function() {
            const savedExamMode = localStorage.getItem('examMode');
            if (savedExamMode === 'true') {
                window.examModeEnabled = true;
                document.body.classList.add('exam-mode');
                const toggleContainer = document.querySelector('.exam-mode-toggle-container');
                if (toggleContainer) toggleContainer.classList.add('exam-active');
            }
        };

        window.switchMode = function (mode) {
            window.currentMode = mode;
            const oeqSidebar = document.getElementById('oeq-sidebar-content');
            const mcqSidebar = document.getElementById('mcq-sidebar-content');
            const container = document.getElementById('header-tabs-container');
            const toggle = document.getElementById('mode-toggle');
            const oeqLabel = document.querySelector('.ios-toggle-label:first-of-type');
            const mcqLabel = document.querySelector('.ios-toggle-label:last-of-type');
            const headerLevelSelect = document.getElementById('header-level-select');

            // Update iOS toggle state
            if (toggle) {
                if (mode === 'mcq') {
                    toggle.classList.add('mcq-active');
                } else {
                    toggle.classList.remove('mcq-active');
                }
            }

            // Update labels
            if (oeqLabel && mcqLabel) {
                oeqLabel.classList.toggle('active', mode === 'oeq');
                mcqLabel.classList.toggle('active', mode === 'mcq');
            }

            if (mode === 'mcq') {
                oeqSidebar.classList.add('hidden');
                mcqSidebar.classList.remove('hidden');
                document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                // Sync header level selector with MCQ level
                if (headerLevelSelect) headerLevelSelect.value = window.currentMcqLevel;
                renderMcqHeaders();
            } else {
                oeqSidebar.classList.remove('hidden');
                mcqSidebar.classList.add('hidden');
                // Sync header level selector with OEQ level
                if (headerLevelSelect) headerLevelSelect.value = window.currentOeqLevel;
                renderOeqHeaderTabs('cer');
                switchTab('cer', document.querySelector('.tab-btn[data-type="cer"]'));
                if (window.isAdminUser) document.getElementById('btn-sidebar-admin').classList.remove('hidden');
            }
        };

        // =====================================================
        // MCQ FUNCTIONALITY
        // =====================================================

        window.renderMcqHeaders = function () {
            const container = document.getElementById('header-tabs-container');
            const topics = window.mcqCurriculum[window.currentMcqLevel] || [];
            const pastelColors = ['#AEC6CF', '#FFB7B2', '#FFDAC1', '#E2F0CB', '#C7CEEA', '#FDFD96', '#B5EAD7', '#FF9AA2', '#E0BBE4', '#ADD8E6'];

            container.innerHTML = topics.map((t, i) => {
                const topicId = t.toLowerCase().replace(/\s+/g, '-');
                const activeClass = i === 0 ? 'active' : '';
                const color = pastelColors[i % pastelColors.length];
                if (i === 0) window.currentMcqTopic = topicId;
                
                // Count questions for this MCQ topic
                const topicContainerId = `topic-mcq-${topicId}`;
                const topicContainer = document.getElementById(topicContainerId);
                const questionCount = topicContainer ? topicContainer.querySelectorAll('.question-container').length : 0;
                const countBadge = `<span class="tab-count-badge">${questionCount}</span>`;
                
                return `<button class="tab-btn ${activeClass}" onclick="switchMcqTopicAndTab('${topicId}', this)" style="background-color: ${color};">${t}${countBadge}</button>`;
            }).join('');

            // Set initial header line color to first topic's color
            const headerLine = document.getElementById('header-color-line');
            if (headerLine && topics.length > 0) {
                const firstColor = pastelColors[0];
                const lighterColor = adjustColorBrightness(firstColor, 20);
                headerLine.style.background = `linear-gradient(90deg, ${firstColor} 0%, ${lighterColor} 50%, ${firstColor} 100%)`;
            }

            renderMcqQuestionList();
        };

        window.switchMcqTopicAndTab = function (topicId, btn) {
            document.querySelectorAll('#header-tabs-container .tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            window.currentMcqTopic = topicId;
            
            // Update header line color based on the button's background color
            const headerLine = document.getElementById('header-color-line');
            if (headerLine && btn) {
                const btnColor = btn.style.backgroundColor || '#AEC6CF';
                // Convert rgb to hex if needed
                let hexColor = btnColor;
                if (btnColor.startsWith('rgb')) {
                    const rgb = btnColor.match(/\d+/g);
                    if (rgb) {
                        hexColor = '#' + ((1 << 24) + (parseInt(rgb[0], 10) << 16) + (parseInt(rgb[1], 10) << 8) + parseInt(rgb[2], 10)).toString(16).slice(1);
                    }
                }
                const lighterColor = adjustColorBrightness(hexColor, 20);
                headerLine.style.background = `linear-gradient(90deg, ${hexColor} 0%, ${lighterColor} 50%, ${hexColor} 100%)`;
            }
            
            renderMcqQuestionList();
        };

        window.renderMcqQuestionList = function () {
            const nav = document.getElementById('mcq-question-nav');
            if (!nav) return;

            const topicId = `topic-mcq-${window.currentMcqTopic}`;
            const container = document.getElementById(topicId);
            const questions = container ? container.querySelectorAll('.question-container') : [];

            nav.innerHTML = Array.from(questions).map((q, i) => {
                const qId = q.id;
                return `<button onclick="scrollToMcqQuestion('${qId}', this)">Question ${i + 1}</button>`;
            }).join('');

            document.querySelectorAll('.topic-content').forEach(t => t.classList.add('hidden'));
            if (container) container.classList.remove('hidden');
        };

        window.scrollToMcqQuestion = function (qId, btn) {
            document.querySelectorAll('#mcq-question-nav button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const q = document.getElementById(qId);
            if (q) q.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        window.checkMcq = function (containerId) {
            const container = document.getElementById(containerId);
            const selected = container.querySelector('input[type="radio"]:checked');
            if (!selected) return alert("Please select an option!");

            const isCorrect = selected.dataset.correct === 'true';
            
            const allOptions = container.querySelectorAll('.mcq-option');
            allOptions.forEach(opt => {
                const radio = opt.querySelector('input');
                // Remove any existing feedback icons
                opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());
                
                if (radio.dataset.correct === 'true') {
                    opt.style.borderColor = 'var(--correct-color)';
                    opt.style.background = '#e8f5e9';
                    // Add checkmark inside the correct answer option
                    const icon = document.createElement('span');
                    icon.className = 'option-feedback-icon';
                    icon.textContent = '';
                    icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #28a745; margin-left: auto; padding-left: 10px;';
                    opt.style.display = 'flex';
                    opt.style.alignItems = 'center';
                    opt.appendChild(icon);
                } else if (radio.checked) {
                    opt.style.borderColor = 'var(--incorrect-color)';
                    opt.style.background = '#ffebee';
                    // Add cross inside the wrong selected option
                    const icon = document.createElement('span');
                    icon.className = 'option-feedback-icon';
                    icon.textContent = '';
                    icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #dc3545; margin-left: auto; padding-left: 10px;';
                    opt.style.display = 'flex';
                    opt.style.alignItems = 'center';
                    opt.appendChild(icon);
                }
                radio.disabled = true;
            });
            
            const submitBtn = container.querySelector('.submit-btn');
            submitBtn.disabled = true;
            
            // Show explanation if it exists
            const explanationBox = container.querySelector('.explanation-box');
            if (explanationBox) {
                explanationBox.style.display = 'block';
            }
            
            // Show video if it exists
            const videoContainer = container.querySelector('.video-container');
            if (videoContainer) {
                videoContainer.style.display = 'block';
            }
            
            // Track answer for practice mode and regular mode
            const questionId = container.closest('.question-container')?.id;
            if (questionId) {
                // Track for practice mode if in practice
                if (window.trackAnswerForPractice) {
                    window.trackAnswerForPractice(questionId, isCorrect);
                }
                // Always track question attempts (for progress tracking)
                if (window.trackQuestionAttempt) {
                    window.trackQuestionAttempt(questionId, isCorrect);
                }
            }
        };

        // =====================================================
        // ADMIN FUNCTIONALITY
        // =====================================================

        window.handleTopicChange = function (value) {
            const newTopicInput = document.getElementById('admin-new-topic');
            if (value === 'new-topic') {
                newTopicInput.classList.remove('hidden');
            } else {
                newTopicInput.classList.add('hidden');
            }
        };

        window.updateAdminTopicsByLevel = function (level) {
            const topicSelect = document.getElementById('admin-topic');
            const topics = window.mcqCurriculum[level] || [];
            let html = topics.map(t => `<option value="${t.toLowerCase().replace(/\s+/g, '-')}">${t}</option>`).join('');
            html += `<option value="new-topic">-- Add Custom Topic --</option>`;
            topicSelect.innerHTML = html;
        };

        window.handleCategoryChange = function (value) {
            const mcqOptions = document.getElementById('mcq-options-container');
            const levelContainer = document.getElementById('admin-level-container');
            const previewInstructions = document.querySelector('#admin-preview-section p');
            const processBtn = document.getElementById('admin-process-btn');

            if (value === 'mcq') {
                mcqOptions.classList.remove('hidden');
                levelContainer.classList.remove('hidden');
                if (processBtn) processBtn.classList.add('hidden');
                updateAdminTopicsByLevel(document.getElementById('admin-level').value);
                if (previewInstructions) previewInstructions.classList.add('hidden');
            } else {
                mcqOptions.classList.add('hidden');
                levelContainer.classList.add('hidden');
                if (processBtn) processBtn.classList.remove('hidden');
                const topicSelect = document.getElementById('admin-topic');
                topicSelect.innerHTML = `
                    <option value="heat">Heat</option>
                    <option value="light">Light</option>
                    <option value="materials">Materials</option>
                    <option value="air">Air</option>
                    <option value="water">Water</option>
                    <option value="new-topic">-- Add Custom Topic --</option>
                `;
                if (previewInstructions) previewInstructions.classList.remove('hidden');
            }
        };

        function addAdminBlock(type) {
            const id = Date.now();
            const block = { id, type, value: '' };
            
            // Video and explanation should always be at the end
            if (type === 'video' || type === 'explanation') {
                window.adminBlocks.push(block);
            } else {
                // Insert before any video/explanation blocks
                const lastContentIndex = window.adminBlocks.findIndex(b => b.type === 'video' || b.type === 'explanation');
                if (lastContentIndex === -1) {
                    window.adminBlocks.push(block);
                } else {
                    window.adminBlocks.splice(lastContentIndex, 0, block);
                }
            }
            renderAdminBlocks();
        }

        function renderAdminBlocks() {
            const container = document.getElementById('admin-blocks');
            if (!container) return;
            
            let html = '';
            let addedSeparator = false;
            
            window.adminBlocks.forEach((block, index) => {
                // Add separator before first video/explanation block
                if (!addedSeparator && (block.type === 'video' || block.type === 'explanation')) {
                    html += `<div style="margin: 1.5rem 0; padding: 0.8rem; background: linear-gradient(90deg, #e3f2fd 0%, #f5f5f5 50%, #e3f2fd 100%); border-radius: 8px; text-align: center;">
                        <span style="color: #666; font-size: 0.85rem; font-weight: 500;"> Shown after students answer (drag blocks above to reorder)</span>
                    </div>`;
                    addedSeparator = true;
                }
                
                // Handle table blocks specially
                if (block.type === 'table') {
                    html += renderTableBlock(block);
                    return;
                }
                
                let inputHtml = '';
                if (block.type === 'text' || block.type === 'answer' || block.type === 'explanation') {
                    const placeholders = {
                        'answer': 'Enter text to be blanked... Use [brackets] around words to make them blanks.',
                        'explanation': 'Enter step-by-step explanation...',
                        'text': 'Enter question text...'
                    };
                    
                    // Add formatting toolbar for text and explanation blocks
                    const formattingToolbar = `
                        <div class="text-formatting-toolbar">
                            <!-- Text Style -->
                            <div class="toolbar-group">
                                <button type="button" onclick="formatText(${block.id}, 'bold')" class="format-btn" title="Bold (Ctrl+B)"><strong>B</strong></button>
                                <button type="button" onclick="formatText(${block.id}, 'italic')" class="format-btn" title="Italic (Ctrl+I)"><em>I</em></button>
                                <button type="button" onclick="formatText(${block.id}, 'underline')" class="format-btn" title="Underline (Ctrl+U)"><u>U</u></button>
                            </div>
                            
                            <!-- Alignment -->
                            <div class="toolbar-group">
                                <button type="button" onclick="formatText(${block.id}, 'justifyLeft')" class="format-btn" title="Align Left">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg>
                                </button>
                                <button type="button" onclick="formatText(${block.id}, 'justifyCenter')" class="format-btn" title="Align Center">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>
                                </button>
                                <button type="button" onclick="formatText(${block.id}, 'justifyRight')" class="format-btn" title="Align Right">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/></svg>
                                </button>
                                <button type="button" onclick="formatText(${block.id}, 'justifyFull')" class="format-btn" title="Justify">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                                </button>
                            </div>
                            
                            <!-- Indentation -->
                            <div class="toolbar-group">
                                <button type="button" onclick="formatText(${block.id}, 'outdent')" class="format-btn" title="Decrease Indent">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/><polyline points="7 9 4 12 7 15"/></svg>
                                </button>
                                <button type="button" onclick="formatText(${block.id}, 'indent')" class="format-btn" title="Increase Indent">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="9" y1="18" x2="21" y2="18"/><polyline points="4 9 7 12 4 15"/></svg>
                                </button>
                            </div>
                            
                            <!-- Lists/Numbering -->
                            <div class="toolbar-group" style="border-right: none;">
                                <button type="button" onclick="formatText(${block.id}, 'insertUnorderedList')" class="format-btn" title="Bullet List">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="4" cy="6" r="1.5" fill="currentColor"/><circle cx="4" cy="12" r="1.5" fill="currentColor"/><circle cx="4" cy="18" r="1.5" fill="currentColor"/><line x1="9" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="9" y1="18" x2="21" y2="18"/></svg>
                                </button>
                                <button type="button" onclick="formatText(${block.id}, 'insertOrderedList')" class="format-btn" title="Numbered List">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><text x="2" y="8" font-size="6" fill="currentColor">1</text><text x="2" y="14" font-size="6" fill="currentColor">2</text><text x="2" y="20" font-size="6" fill="currentColor">3</text><line x1="9" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="9" y1="18" x2="21" y2="18"/></svg>
                                </button>
                                <select class="list-type-select" onchange="insertNumberedList(${block.id}, this.value); this.selectedIndex=0;" title="List Style">
                                    <option value="">List Style </option>
                                    <optgroup label="Numbers">
                                        <option value="decimal">1, 2, 3...</option>
                                        <option value="decimal-paren">1), 2), 3)...</option>
                                    </optgroup>
                                    <optgroup label="Letters">
                                        <option value="lower-alpha">a, b, c...</option>
                                        <option value="upper-alpha">A, B, C...</option>
                                        <option value="lower-alpha-paren">a), b), c)...</option>
                                        <option value="upper-alpha-paren">A), B), C)...</option>
                                    </optgroup>
                                    <optgroup label="Roman Numerals">
                                        <option value="lower-roman">i, ii, iii...</option>
                                        <option value="upper-roman">I, II, III...</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        <div id="editor-${block.id}" 
                             class="rich-text-editor" 
                             contenteditable="true" 
                             data-placeholder="${placeholders[block.type]}"
                             oninput="updateBlockValueFromEditor(${block.id})"
                             onpaste="handleEditorPaste(event)"
                             onkeydown="handleEditorKeydown(event, ${block.id})"
                        >${block.value || ''}</div>
                    `;
                    inputHtml = formattingToolbar;
                } else if (block.type === 'image') {
                    const previewUrl = convertDropboxUrl(block.value);
                    inputHtml = `
                        <input type="text" class="auth-input" style="margin-top: 10px;" oninput="updateBlockValue(${block.id}, this.value); updateImagePreview(${block.id})" value="${block.value}" placeholder="Enter image URL (Dropbox, Imgur, etc.)...">
                        <div id="img-preview-${block.id}" style="margin-top: 10px; text-align: center;">
                            ${block.value ? `<img src="${previewUrl}" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #ddd;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><span style="display: none; color: #dc3545; font-size: 0.85rem;"> Image failed to load</span>` : '<span style="color: #888; font-size: 0.85rem;">Image preview will appear here</span>'}
                        </div>
                    `;
                } else if (block.type === 'video') {
                    inputHtml = `<input type="text" class="auth-input" style="margin-top: 10px;" oninput="updateBlockValue(${block.id}, this.value)" value="${block.value}" placeholder="Enter Video URL (Dropbox or YouTube)...">`;
                }

                const typeColors = {
                    'answer': 'background: #fffdf0; border-color: #fbc02d;',
                    'explanation': 'background: #f0f4ff; border-color: #007bff;',
                    'video': 'background: #fdf2f2; border-color: #dc3545;',
                    'image': 'background: #f5f5f5; border-color: #9e9e9e;',
                    'text': ''
                };
                
                const typeLabels = {
                    'text': ' TEXT BLOCK',
                    'answer': ' ANSWER BLOCK (fill-in-blank)',
                    'explanation': ' EXPLANATION (shown after answer)',
                    'video': ' VIDEO (shown after answer, optional)',
                    'image': ' IMAGE BLOCK'
                };
                
                // Only text, image, answer, and table blocks are draggable
                // Video and explanation are fixed at the end
                const isDraggable = ['text', 'image', 'answer', 'table'].includes(block.type);
                const dragAttrs = isDraggable ? `draggable="true" 
                             ondragstart="handleDragStart(event, ${block.id})" 
                             ondragend="handleDragEnd(event)"
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)"
                             ondrop="handleDrop(event, ${block.id})"` : '';
                const dragHandle = isDraggable ? `<span class="drag-handle" title="Drag to reorder"></span>` : '';
                const leftPadding = isDraggable ? '40px' : '1rem';

                html += `
                        <div class="admin-block ${isDraggable ? '' : 'no-drag'}" data-block-id="${block.id}" ${dragAttrs}
                             style="margin-bottom: 1rem; position: relative; padding: 1rem 1rem 1rem ${leftPadding}; border: 1px solid #eee; border-radius: 8px; ${typeColors[block.type] || ''}">
                            ${dragHandle}
                            <span style="font-size: 0.8rem; color: #666; font-weight: 600;">${typeLabels[block.type] || block.type.toUpperCase()}</span>
                            <button onclick="removeAdminBlock(${block.id})" style="position: absolute; right: 10px; top: 10px; border: none; background: none; cursor: pointer; color: #dc3545; font-size: 1.2rem;"></button>
                            ${inputHtml}
                        </div>
                    `;
            });
            
            container.innerHTML = html;
            
            // Re-attach any event listeners if needed
            initDragAndDrop();
        }
        
        // ==================== TEXT FORMATTING FUNCTIONS ====================
        
        window.formatText = function(blockId, command) {
            const editor = document.getElementById(`editor-${blockId}`);
            if (!editor) return;
            
            // Focus the editor first
            editor.focus();
            
            // Execute the formatting command
            document.execCommand(command, false, null);
            
            // Update block value
            updateBlockValueFromEditor(blockId);
        };
        
        window.insertNumberedList = function(blockId, listType) {
            const editor = document.getElementById(`editor-${blockId}`);
            if (!editor || !listType) return;
            
            editor.focus();
            
            // Handle parenthesis variants
            let cssListType = listType;
            let useParenthesis = false;
            
            if (listType.endsWith('-paren')) {
                cssListType = listType.replace('-paren', '');
                useParenthesis = true;
            }
            
            // Insert ordered list first
            document.execCommand('insertOrderedList', false, null);
            
            // Find the created ol element and set its style
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                let node = selection.anchorNode;
                while (node && node.nodeName !== 'OL') {
                    node = node.parentNode;
                }
                if (node && node.nodeName === 'OL') {
                    node.style.listStyleType = cssListType;
                    node.style.paddingLeft = '2em';
                    
                    // For parenthesis style, we use CSS counter
                    if (useParenthesis) {
                        node.classList.add('paren-list');
                        node.setAttribute('data-list-type', cssListType);
                    }
                }
            }
            
            // Update block value
            updateBlockValueFromEditor(blockId);
        };
        
        window.updateBlockValueFromEditor = function(blockId) {
            const editor = document.getElementById(`editor-${blockId}`);
            if (!editor) return;
            
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (block) {
                block.value = editor.innerHTML;
            }
        };
        
        // Handle keyboard shortcuts in the editor
        window.handleEditorKeydown = function(event, blockId) {
            // Ctrl/Cmd + B = Bold
            if ((event.ctrlKey || event.metaKey) && event.key === 'b') {
                event.preventDefault();
                formatText(blockId, 'bold');
            }
            // Ctrl/Cmd + I = Italic
            else if ((event.ctrlKey || event.metaKey) && event.key === 'i') {
                event.preventDefault();
                formatText(blockId, 'italic');
            }
            // Ctrl/Cmd + U = Underline
            else if ((event.ctrlKey || event.metaKey) && event.key === 'u') {
                event.preventDefault();
                formatText(blockId, 'underline');
            }
            // Tab = Indent
            else if (event.key === 'Tab' && !event.shiftKey) {
                event.preventDefault();
                formatText(blockId, 'indent');
            }
            // Shift + Tab = Outdent
            else if (event.key === 'Tab' && event.shiftKey) {
                event.preventDefault();
                formatText(blockId, 'outdent');
            }
        };
        
        window.handleEditorPaste = function(event) {
            // Prevent default paste and paste as plain text to avoid formatting issues
            event.preventDefault();
            
            const text = event.clipboardData.getData('text/html') || event.clipboardData.getData('text/plain');
            
            // Create a temporary div to parse the HTML
            const temp = document.createElement('div');
            temp.innerHTML = text;
            
            // Remove scripts and potentially harmful elements
            temp.querySelectorAll('script, style, meta, link').forEach(el => el.remove());
            
            // Insert the cleaned HTML
            document.execCommand('insertHTML', false, temp.innerHTML);
        };
        
        // ==================== DRAG AND DROP FUNCTIONS ====================
        
        window.draggedBlockId = null;
        
        window.initDragAndDrop = function() {
            // Initialize is called after render, nothing special needed here
            // All handlers are inline in the HTML
        };
        
        window.handleDragStart = function(event, blockId) {
            window.draggedBlockId = blockId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', blockId);
        };
        
        window.handleDragEnd = function(event) {
            event.target.classList.remove('dragging');
            // Remove drag-over class from all blocks
            document.querySelectorAll('.admin-block').forEach(block => {
                block.classList.remove('drag-over');
            });
            window.draggedBlockId = null;
        };
        
        window.handleDragOver = function(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const block = event.target.closest('.admin-block');
            if (block && !block.classList.contains('dragging')) {
                // Remove drag-over from other blocks
                document.querySelectorAll('.admin-block').forEach(b => {
                    if (b !== block) b.classList.remove('drag-over');
                });
                block.classList.add('drag-over');
            }
        };
        
        window.handleDragLeave = function(event) {
            const block = event.target.closest('.admin-block');
            if (block) {
                block.classList.remove('drag-over');
            }
        };
        
        window.handleDrop = function(event, targetBlockId) {
            event.preventDefault();
            const block = event.target.closest('.admin-block');
            if (block) {
                block.classList.remove('drag-over');
            }
            
            if (window.draggedBlockId === null || window.draggedBlockId === targetBlockId) return;
            
            // Find the blocks
            const draggedBlock = window.adminBlocks.find(b => b.id === window.draggedBlockId);
            const targetBlock = window.adminBlocks.find(b => b.id === targetBlockId);
            
            // Don't allow dragging video/explanation blocks
            if (draggedBlock && (draggedBlock.type === 'video' || draggedBlock.type === 'explanation')) {
                window.draggedBlockId = null;
                return;
            }
            
            // Don't allow dropping onto video/explanation blocks
            if (targetBlock && (targetBlock.type === 'video' || targetBlock.type === 'explanation')) {
                window.draggedBlockId = null;
                return;
            }
            
            // Find indices
            const fromIndex = window.adminBlocks.findIndex(b => b.id === window.draggedBlockId);
            const toIndex = window.adminBlocks.findIndex(b => b.id === targetBlockId);
            
            if (fromIndex === -1 || toIndex === -1) return;
            
            // Reorder the array
            const [movedBlock] = window.adminBlocks.splice(fromIndex, 1);
            window.adminBlocks.splice(toIndex, 0, movedBlock);
            
            // Re-render
            renderAdminBlocks();
            
            window.draggedBlockId = null;
        };
        
        // ==================== END DRAG AND DROP ====================
        
        // Update image preview when URL changes
        window.updateImagePreview = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            const previewDiv = document.getElementById(`img-preview-${blockId}`);
            if (block && previewDiv) {
                const previewUrl = convertDropboxUrl(block.value);
                if (block.value) {
                    previewDiv.innerHTML = `<img src="${previewUrl}" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #ddd;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><span style="display: none; color: #dc3545; font-size: 0.85rem;"> Image failed to load</span>`;
                } else {
                    previewDiv.innerHTML = '<span style="color: #888; font-size: 0.85rem;">Image preview will appear here</span>';
                }
            }
        };

        // ==================== TABLE EDITOR FUNCTIONS ====================
        
        // Pastel colors for table
        const pastelColors = [
            '#FFFFFF', '#F5F5F5', '#E8E8E8',  // Whites/Grays
            '#FFB3BA', '#FFDFBA', '#FFFFBA',  // Light Pink, Peach, Yellow
            '#BAFFC9', '#BAE1FF', '#E0BBE4',  // Mint, Sky Blue, Lavender
            '#FFC6D9', '#C9FFE5', '#D4F0F0',  // Rose, Seafoam, Aqua
            '#FCE4EC', '#E8F5E9', '#E3F2FD',  // Pale Pink, Pale Green, Pale Blue
            '#FFF8E1', '#F3E5F5', '#ECEFF1'   // Cream, Pale Purple, Blue Gray
        ];

        // Initialize table grid selector
        window.initTableGridSelector = function() {
            const grid = document.getElementById('table-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'table-grid-cell';
                    cell.dataset.row = row + 1;
                    cell.dataset.col = col + 1;
                    cell.addEventListener('mouseenter', handleGridHover);
                    cell.addEventListener('click', handleGridClick);
                    grid.appendChild(cell);
                }
            }
        };

        function handleGridHover(e) {
            const targetRow = parseInt(e.target.dataset.row, 10);
            const targetCol = parseInt(e.target.dataset.col, 10);
            const cells = document.querySelectorAll('.table-grid-cell');

            cells.forEach(cell => {
                const cellRow = parseInt(cell.dataset.row, 10);
                const cellCol = parseInt(cell.dataset.col, 10);
                if (cellRow <= targetRow && cellCol <= targetCol) {
                    cell.classList.add('selected');
                } else {
                    cell.classList.remove('selected');
                }
            });
            
            document.getElementById('grid-size-label').innerHTML = `<strong>${targetCol}  ${targetRow}</strong> table`;
        }

        function handleGridClick(e) {
            const rows = parseInt(e.target.dataset.row, 10);
            const cols = parseInt(e.target.dataset.col, 10);
            createTableBlock(rows, cols);
            hideTableGridSelector();
        }

        window.showTableGridSelector = function(btn) {
            const selector = document.getElementById('table-grid-selector');
            if (!selector) {
                console.error('Table grid selector not found');
                return;
            }
            
            // Toggle - if already visible, hide it
            if (selector.classList.contains('visible')) {
                hideTableGridSelector();
                return;
            }
            
            // Initialize grid if needed
            if (!document.querySelector('.table-grid-cell')) {
                initTableGridSelector();
            }
            
            // Get button position relative to viewport
            const rect = btn.getBoundingClientRect();
            const selectorWidth = 280;
            const selectorHeight = 320;
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            const padding = 15;
            
            let top, left;
            let showAbove = true;
            
            // Calculate horizontal position (centered on button)
            left = rect.left + (rect.width / 2) - (selectorWidth / 2);
            
            // Keep within horizontal bounds
            if (left < padding) {
                left = padding;
            } else if (left + selectorWidth > viewportWidth - padding) {
                left = viewportWidth - selectorWidth - padding;
            }
            
            // Determine vertical position
            const spaceAbove = rect.top;
            const spaceBelow = viewportHeight - rect.bottom;
            
            if (spaceAbove >= selectorHeight + padding) {
                // Enough space above - show above
                top = rect.top - selectorHeight - 10;
                showAbove = true;
            } else if (spaceBelow >= selectorHeight + padding) {
                // Not enough above but enough below - show below
                top = rect.bottom + 10;
                showAbove = false;
            } else {
                // Not enough space either way - center in viewport
                top = Math.max(padding, (viewportHeight - selectorHeight) / 2);
                showAbove = spaceAbove > spaceBelow; // Arrow points to closer edge
            }
            
            // Apply position
            selector.style.top = top + 'px';
            selector.style.left = left + 'px';
            
            // Update arrow direction
            if (showAbove) {
                selector.classList.remove('arrow-up');
                selector.classList.add('arrow-down');
            } else {
                selector.classList.remove('arrow-down');
                selector.classList.add('arrow-up');
            }
            
            selector.classList.add('visible');
            
            // Reset grid selection
            document.querySelectorAll('.table-grid-cell').forEach(c => c.classList.remove('selected'));
            document.getElementById('grid-size-label').innerHTML = '<span style="color: #888;">Hover to select</span>';
            
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeGridSelectorOnClickOutside, true);
            }, 100);
        };

        function hideTableGridSelector() {
            const selector = document.getElementById('table-grid-selector');
            if (selector) {
                selector.classList.remove('visible');
            }
            document.removeEventListener('click', closeGridSelectorOnClickOutside, true);
        }

        function closeGridSelectorOnClickOutside(e) {
            const selector = document.getElementById('table-grid-selector');
            const btn = document.getElementById('add-table-btn');
            if (selector && !selector.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
                hideTableGridSelector();
            }
        }

        function createTableBlock(rows, cols) {
            // Create table data structure
            const tableData = {
                rows: rows,
                cols: cols,
                cells: [],
                headerRow: true,
                colWidths: Array(cols).fill('auto')
            };
            
            // Initialize cells with empty content
            for (let r = 0; r < rows; r++) {
                const rowData = [];
                for (let c = 0; c < cols; c++) {
                    rowData.push({
                        content: r === 0 ? `Header ${c + 1}` : '',
                        align: 'left',
                        vAlign: 'middle',
                        bgColor: r === 0 ? '#E8E8E8' : '#FFFFFF'
                    });
                }
                tableData.cells.push(rowData);
            }
            
            const blockId = Date.now();
            window.adminBlocks.push({
                id: blockId,
                type: 'table',
                value: tableData
            });
            
            renderAdminBlocks();
            
            // Scroll to the new table
            setTimeout(() => {
                const tableBlock = document.getElementById(`table-block-${blockId}`);
                if (tableBlock) {
                    tableBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        // Render table in admin blocks
        window.renderTableBlock = function(block) {
            const tableData = block.value;
            const blockId = block.id;
            
            // Build a map of cells that are hidden due to merging
            const hiddenCells = new Set();
            if (tableData.mergedCells) {
                tableData.mergedCells.forEach(merge => {
                    for (let r = merge.startRow; r <= merge.endRow; r++) {
                        for (let c = merge.startCol; c <= merge.endCol; c++) {
                            if (r !== merge.startRow || c !== merge.startCol) {
                                hiddenCells.add(`${r}-${c}`);
                            }
                        }
                    }
                });
            }
            
            // Build a map of merge info for cells that start a merge
            const mergeMap = {};
            if (tableData.mergedCells) {
                tableData.mergedCells.forEach(merge => {
                    mergeMap[`${merge.startRow}-${merge.startCol}`] = {
                        colspan: merge.endCol - merge.startCol + 1,
                        rowspan: merge.endRow - merge.startRow + 1
                    };
                });
            }
            
            let tableHtml = `<table class="admin-table" id="admin-table-${blockId}">`;
            
            for (let r = 0; r < tableData.rows; r++) {
                tableHtml += `<tr data-row="${r}">`;
                for (let c = 0; c < tableData.cols; c++) {
                    // Skip hidden cells
                    if (hiddenCells.has(`${r}-${c}`)) {
                        continue;
                    }
                    
                    const cell = tableData.cells[r][c];
                    const tag = (r === 0 && tableData.headerRow) ? 'th' : 'td';
                    const colWidth = tableData.colWidths && tableData.colWidths[c] ? `width: ${tableData.colWidths[c]}px;` : '';
                    const rowHeight = tableData.rowHeights && tableData.rowHeights[r] ? `height: ${tableData.rowHeights[r]}px;` : '';
                    
                    // Check for merge attributes
                    const mergeInfo = mergeMap[`${r}-${c}`];
                    const colspanAttr = mergeInfo && mergeInfo.colspan > 1 ? `colspan="${mergeInfo.colspan}"` : '';
                    const rowspanAttr = mergeInfo && mergeInfo.rowspan > 1 ? `rowspan="${mergeInfo.rowspan}"` : '';
                    const mergedClass = mergeInfo ? 'merged-cell' : '';
                    
                    tableHtml += `<${tag} 
                        contenteditable="true" 
                        data-row="${r}" 
                        data-col="${c}" 
                        data-block="${blockId}"
                        ${colspanAttr}
                        ${rowspanAttr}
                        class="${mergedClass}"
                        style="text-align: ${cell.align}; vertical-align: ${cell.vAlign || 'middle'}; background-color: ${cell.bgColor}; ${colWidth} ${rowHeight}"
                        onclick="selectTableCell(this, event)"
                        onblur="updateTableCell(this)"
                        oninput="updateTableCell(this)"
                        onmousedown="handleTableCellMouseDown(event, ${blockId}, ${r}, ${c})"
                    >${cell.content}</${tag}>`;
                }
                tableHtml += '</tr>';
            }
            
            tableHtml += '</table>';
            
            return `
                <div class="admin-block" id="table-block-${blockId}" data-block-id="${blockId}" draggable="true"
                     ondragstart="handleDragStart(event, ${blockId})" 
                     ondragend="handleDragEnd(event)"
                     ondragover="handleDragOver(event)" 
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event, ${blockId})"
                     style="margin-bottom: 1rem; position: relative; padding: 1rem 1rem 1rem 40px; border: 1px solid #81c784; border-radius: 8px; background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);">
                    <span class="drag-handle" title="Drag to reorder"></span>
                    <span style="font-size: 0.8rem; color: #2e7d32; font-weight: 600;"> TABLE BLOCK</span>
                    <button onclick="removeAdminBlock(${blockId})" style="position: absolute; right: 10px; top: 10px; border: none; background: none; cursor: pointer; color: #dc3545; font-size: 1.2rem;"></button>
                    
                    <div class="admin-table-wrapper" style="margin-top: 10px;">
                        <div class="table-toolbar">
                            <div class="table-toolbar-group">
                                <label>Select:</label>
                                <button onclick="selectTableRow(${blockId})" title="Select Entire Row"> Row</button>
                                <button onclick="selectTableColumn(${blockId})" title="Select Entire Column"> Col</button>
                                <button onclick="selectEntireTable(${blockId})" title="Select Entire Table"> All</button>
                                <button onclick="clearCellSelection(${blockId})" title="Clear Selection"></button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Merge:</label>
                                <button onclick="mergeCells(${blockId})" title="Merge Selected Cells"> Merge</button>
                                <button onclick="unmergeCells(${blockId})" title="Unmerge Cell"> Unmerge</button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Align:</label>
                                <button onclick="setTableAlignment(${blockId}, 'left')" title="Align Left"></button>
                                <button onclick="setTableAlignment(${blockId}, 'center')" title="Align Center"></button>
                                <button onclick="setTableAlignment(${blockId}, 'right')" title="Align Right"></button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>V-Align:</label>
                                <button onclick="setTableVerticalAlignment(${blockId}, 'top')" title="Align Top"></button>
                                <button onclick="setTableVerticalAlignment(${blockId}, 'middle')" title="Align Middle"></button>
                                <button onclick="setTableVerticalAlignment(${blockId}, 'bottom')" title="Align Bottom"></button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Color:</label>
                                <button onclick="showColorPicker(${blockId}, 'selection')" title="Color Selection"></button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Rows:</label>
                                <button onclick="addTableRow(${blockId})" title="Add Row">+</button>
                                <button onclick="deleteTableRow(${blockId})" class="danger" title="Delete Row"></button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Cols:</label>
                                <button onclick="addTableColumn(${blockId})" title="Add Column">+</button>
                                <button onclick="deleteTableColumn(${blockId})" class="danger" title="Delete Column"></button>
                            </div>
                        </div>
                        <p style="font-size: 0.75rem; color: #666; margin: 5px 0; padding: 0 15px;"> Shift+Click or Ctrl+Click to select multiple cells for merging</p>
                        <div class="admin-table-container">
                            ${tableHtml}
                        </div>
                    </div>
                    
                    <!-- Color Picker Dropdown -->
                    <div id="color-picker-${blockId}" class="color-picker-dropdown">
                        <h5 id="color-picker-title-${blockId}">Select Color</h5>
                        <div class="color-palette">
                            ${pastelColors.map(color => `
                                <div class="color-swatch" 
                                    style="background-color: ${color};" 
                                    onclick="applyTableColor(${blockId}, '${color}')"
                                    title="${color}">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        };

        // Track selected cell for operations
        window.selectedTableCell = null;
        window.selectedCells = []; // Array of {row, col, blockId} for multi-select
        window.colorPickerMode = null; // 'row', 'col', or 'cell'
        window.colorPickerBlockId = null;

        window.selectTableCell = function(cell, event) {
            const blockId = parseInt(cell.dataset.block, 10);
            const row = parseInt(cell.dataset.row, 10);
            const col = parseInt(cell.dataset.col, 10);
            
            // Check for Shift or Ctrl key for multi-selection
            if (event && (event.shiftKey || event.ctrlKey || event.metaKey)) {
                // Multi-select mode
                const cellKey = `${row}-${col}`;
                const existingIndex = window.selectedCells.findIndex(c => 
                    c.row === row && c.col === col && c.blockId === blockId
                );
                
                if (event.shiftKey && window.selectedCells.length > 0) {
                    // Shift+Click: Select range from last selected to current
                    const lastCell = window.selectedCells[window.selectedCells.length - 1];
                    if (lastCell.blockId === blockId) {
                        const startRow = Math.min(lastCell.row, row);
                        const endRow = Math.max(lastCell.row, row);
                        const startCol = Math.min(lastCell.col, col);
                        const endCol = Math.max(lastCell.col, col);
                        
                        // Clear existing selection and select range
                        window.selectedCells = [];
                        for (let r = startRow; r <= endRow; r++) {
                            for (let c = startCol; c <= endCol; c++) {
                                window.selectedCells.push({ row: r, col: c, blockId });
                            }
                        }
                    }
                } else if (existingIndex >= 0) {
                    // Ctrl+Click on already selected: deselect
                    window.selectedCells.splice(existingIndex, 1);
                } else {
                    // Ctrl+Click on new cell: add to selection
                    window.selectedCells.push({ row, col, blockId });
                }
                
                // Update visual selection
                updateCellSelectionVisual(blockId);
            } else {
                // Single selection mode - clear multi-select
                window.selectedCells = [{ row, col, blockId }];
                
                // Remove all previous selections
                document.querySelectorAll('.admin-table td.selected-cell, .admin-table th.selected-cell').forEach(c => {
                    c.classList.remove('selected-cell');
                });
                document.querySelectorAll('.admin-table td.cell-selected, .admin-table th.cell-selected').forEach(c => {
                    c.classList.remove('cell-selected');
                });
                
                cell.classList.add('selected-cell');
            }
            
            window.selectedTableCell = cell;
        };
        
        window.updateCellSelectionVisual = function(blockId) {
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Clear existing selection visual
            table.querySelectorAll('.cell-selected').forEach(c => c.classList.remove('cell-selected'));
            table.querySelectorAll('.selected-cell').forEach(c => c.classList.remove('selected-cell'));
            
            // Apply selection visual to all selected cells
            window.selectedCells.forEach(sel => {
                if (sel.blockId === blockId) {
                    const cell = table.querySelector(`[data-row="${sel.row}"][data-col="${sel.col}"]`);
                    if (cell) {
                        cell.classList.add('cell-selected');
                    }
                }
            });
        };
        
        window.clearCellSelection = function(blockId) {
            window.selectedCells = [];
            window.selectedTableCell = null;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (table) {
                table.querySelectorAll('.cell-selected, .selected-cell, .selected-row, .selected-col').forEach(c => {
                    c.classList.remove('cell-selected', 'selected-cell', 'selected-row', 'selected-col');
                });
                table.classList.remove('selected-all');
            }
            
            // Also clear table selection
            window.tableSelection = { blockId: null, type: null, row: null, col: null };
        };
        
        // ==================== MERGE CELLS FUNCTIONS ====================
        
        window.mergeCells = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            // Get selected cells for this block
            const selectedForBlock = window.selectedCells.filter(c => c.blockId === blockId);
            
            if (selectedForBlock.length < 2) {
                alert('Please select at least 2 cells to merge. Use Shift+Click or Ctrl+Click to select multiple cells.');
                return;
            }
            
            // Find the bounding rectangle of selected cells
            const rows = selectedForBlock.map(c => c.row);
            const cols = selectedForBlock.map(c => c.col);
            const startRow = Math.min(...rows);
            const endRow = Math.max(...rows);
            const startCol = Math.min(...cols);
            const endCol = Math.max(...cols);
            
            // Check if selection forms a complete rectangle
            const expectedCount = (endRow - startRow + 1) * (endCol - startCol + 1);
            if (selectedForBlock.length !== expectedCount) {
                alert('Please select a rectangular area of cells to merge.');
                return;
            }
            
            // Check if any of the selected cells are already part of a merge
            if (!block.value.mergedCells) {
                block.value.mergedCells = [];
            }
            
            for (const merge of block.value.mergedCells) {
                for (let r = startRow; r <= endRow; r++) {
                    for (let c = startCol; c <= endCol; c++) {
                        if (r >= merge.startRow && r <= merge.endRow && 
                            c >= merge.startCol && c <= merge.endCol) {
                            alert('Cannot merge: some selected cells are already part of a merged region. Unmerge them first.');
                            return;
                        }
                    }
                }
            }
            
            // Combine content from all cells into the top-left cell
            let combinedContent = '';
            for (let r = startRow; r <= endRow; r++) {
                for (let c = startCol; c <= endCol; c++) {
                    const cellContent = block.value.cells[r][c].content.trim();
                    if (cellContent) {
                        if (combinedContent) combinedContent += ' ';
                        combinedContent += cellContent;
                    }
                }
            }
            block.value.cells[startRow][startCol].content = combinedContent;
            
            // Add the merge info
            block.value.mergedCells.push({
                startRow, endRow, startCol, endCol
            });
            
            // Clear selection and re-render
            window.selectedCells = [];
            renderAdminBlocks();
        };
        
        window.unmergeCells = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table' || !block.value.mergedCells) return;
            
            // Find which merge the selected cell belongs to
            if (!window.selectedTableCell || parseInt(window.selectedTableCell.dataset.block, 10) !== blockId) {
                alert('Please click on a merged cell to unmerge it.');
                return;
            }

            const row = parseInt(window.selectedTableCell.dataset.row, 10);
            const col = parseInt(window.selectedTableCell.dataset.col, 10);
            
            // Find the merge that contains this cell
            const mergeIndex = block.value.mergedCells.findIndex(merge => 
                row >= merge.startRow && row <= merge.endRow &&
                col >= merge.startCol && col <= merge.endCol
            );
            
            if (mergeIndex === -1) {
                alert('This cell is not part of a merged region.');
                return;
            }
            
            // Remove the merge
            block.value.mergedCells.splice(mergeIndex, 1);
            
            // Clean up empty array
            if (block.value.mergedCells.length === 0) {
                delete block.value.mergedCells;
            }
            
            renderAdminBlocks();
        };
        
        // ==================== END MERGE CELLS FUNCTIONS ====================

        window.updateTableCell = function(cell) {
            const blockId = parseInt(cell.dataset.block, 10);
            const row = parseInt(cell.dataset.row, 10);
            const col = parseInt(cell.dataset.col, 10);
            
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (block && block.type === 'table') {
                block.value.cells[row][col].content = cell.textContent;
            }
        };

        window.setTableAlignment = function(blockId, alignment) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Check for table selection first (row/col/all)
            if (window.tableSelection.blockId === blockId && window.tableSelection.type) {
                const sel = window.tableSelection;
                
                if (sel.type === 'all') {
                    // Align entire table
                    for (let r = 0; r < block.value.rows; r++) {
                        for (let c = 0; c < block.value.cols; c++) {
                            const cell = table.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            if (cell) {
                                cell.style.textAlign = alignment;
                                block.value.cells[r][c].align = alignment;
                            }
                        }
                    }
                } else if (sel.type === 'row') {
                    // Align selected row
                    const row = sel.row;
                    for (let c = 0; c < block.value.cols; c++) {
                        const cell = table.querySelector(`[data-row="${row}"][data-col="${c}"]`);
                        if (cell) {
                            cell.style.textAlign = alignment;
                            block.value.cells[row][c].align = alignment;
                        }
                    }
                } else if (sel.type === 'col') {
                    // Align selected column
                    const col = sel.col;
                    for (let r = 0; r < block.value.rows; r++) {
                        const cell = table.querySelector(`[data-row="${r}"][data-col="${col}"]`);
                        if (cell) {
                            cell.style.textAlign = alignment;
                            block.value.cells[r][col].align = alignment;
                        }
                    }
                }
                return;
            }
            
            // Check for multi-cell selection
            const selectedForBlock = window.selectedCells.filter(c => c.blockId === blockId);
            if (selectedForBlock.length > 0) {
                selectedForBlock.forEach(sel => {
                    const cell = table.querySelector(`[data-row="${sel.row}"][data-col="${sel.col}"]`);
                    if (cell) {
                        cell.style.textAlign = alignment;
                        block.value.cells[sel.row][sel.col].align = alignment;
                    }
                });
                return;
            }
            
            // Fall back to single cell
            if (!window.selectedTableCell || parseInt(window.selectedTableCell.dataset.block, 10) !== blockId) {
                alert('Please select a cell, row, column, or table first.');
                return;
            }

            const cell = window.selectedTableCell;
            const row = parseInt(cell.dataset.row, 10);
            const col = parseInt(cell.dataset.col, 10);
            
            cell.style.textAlign = alignment;
            block.value.cells[row][col].align = alignment;
        };
        
        window.setTableVerticalAlignment = function(blockId, vAlign) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Check for table selection first (row/col/all)
            if (window.tableSelection.blockId === blockId && window.tableSelection.type) {
                const sel = window.tableSelection;
                
                if (sel.type === 'all') {
                    for (let r = 0; r < block.value.rows; r++) {
                        for (let c = 0; c < block.value.cols; c++) {
                            const cell = table.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            if (cell) {
                                cell.style.verticalAlign = vAlign;
                                block.value.cells[r][c].vAlign = vAlign;
                            }
                        }
                    }
                } else if (sel.type === 'row') {
                    const row = sel.row;
                    for (let c = 0; c < block.value.cols; c++) {
                        const cell = table.querySelector(`[data-row="${row}"][data-col="${c}"]`);
                        if (cell) {
                            cell.style.verticalAlign = vAlign;
                            block.value.cells[row][c].vAlign = vAlign;
                        }
                    }
                } else if (sel.type === 'col') {
                    const col = sel.col;
                    for (let r = 0; r < block.value.rows; r++) {
                        const cell = table.querySelector(`[data-row="${r}"][data-col="${col}"]`);
                        if (cell) {
                            cell.style.verticalAlign = vAlign;
                            block.value.cells[r][col].vAlign = vAlign;
                        }
                    }
                }
                return;
            }
            
            // Check for multi-cell selection
            const selectedForBlock = window.selectedCells.filter(c => c.blockId === blockId);
            if (selectedForBlock.length > 0) {
                selectedForBlock.forEach(sel => {
                    const cell = table.querySelector(`[data-row="${sel.row}"][data-col="${sel.col}"]`);
                    if (cell) {
                        cell.style.verticalAlign = vAlign;
                        block.value.cells[sel.row][sel.col].vAlign = vAlign;
                    }
                });
                return;
            }
            
            // Fall back to single cell
            if (!window.selectedTableCell || parseInt(window.selectedTableCell.dataset.block, 10) !== blockId) {
                alert('Please select a cell, row, column, or table first.');
                return;
            }

            const cell = window.selectedTableCell;
            const row = parseInt(cell.dataset.row, 10);
            const col = parseInt(cell.dataset.col, 10);
            
            cell.style.verticalAlign = vAlign;
            block.value.cells[row][col].vAlign = vAlign;
        };

        window.showColorPicker = function(blockId, mode) {
            const picker = document.getElementById(`color-picker-${blockId}`);
            const title = document.getElementById(`color-picker-title-${blockId}`);
            
            // Check if we have a selection or selected cell
            const hasTableSelection = window.tableSelection.blockId === blockId && window.tableSelection.type;
            const hasMultiSelect = window.selectedCells.filter(c => c.blockId === blockId).length > 0;
            const hasCell = window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block, 10) === blockId;
            
            if (!hasTableSelection && !hasMultiSelect && !hasCell) {
                alert('Please select a cell, row, column, or table first.');
                return;
            }
            
            window.colorPickerMode = mode;
            window.colorPickerBlockId = blockId;
            
            // Determine title based on selection type
            let titleText = 'Select Color';
            if (hasTableSelection) {
                const typeLabels = { 'row': 'Row', 'col': 'Column', 'all': 'Table' };
                titleText = `Color ${typeLabels[window.tableSelection.type] || 'Selection'}`;
            } else if (hasMultiSelect && window.selectedCells.length > 1) {
                titleText = `Color ${window.selectedCells.length} Cells`;
            } else {
                titleText = 'Color Cell';
            }
            title.textContent = titleText;
            
            picker.classList.add('visible');
            
            // Position picker
            const table = document.getElementById(`admin-table-${blockId}`);
            if (table) {
                const tableRect = table.getBoundingClientRect();
                const parentRect = picker.parentElement.getBoundingClientRect();
                picker.style.top = (tableRect.bottom - parentRect.top + 10) + 'px';
                picker.style.left = '0px';
            }
            
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeColorPicker(e) {
                    if (!picker.contains(e.target) && !e.target.textContent.includes('')) {
                        picker.classList.remove('visible');
                        document.removeEventListener('click', closeColorPicker);
                    }
                });
            }, 10);
        };

        window.applyTableColor = function(blockId, color) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Check for table selection first (row/col/all)
            if (window.tableSelection.blockId === blockId && window.tableSelection.type) {
                const sel = window.tableSelection;
                
                if (sel.type === 'all') {
                    // Color entire table
                    for (let r = 0; r < block.value.rows; r++) {
                        for (let c = 0; c < block.value.cols; c++) {
                            const cell = table.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            if (cell) {
                                cell.style.backgroundColor = color;
                                block.value.cells[r][c].bgColor = color;
                            }
                        }
                    }
                } else if (sel.type === 'row') {
                    // Color selected row
                    const row = sel.row;
                    for (let c = 0; c < block.value.cols; c++) {
                        const cell = table.querySelector(`[data-row="${row}"][data-col="${c}"]`);
                        if (cell) {
                            cell.style.backgroundColor = color;
                            block.value.cells[row][c].bgColor = color;
                        }
                    }
                } else if (sel.type === 'col') {
                    // Color selected column
                    const col = sel.col;
                    for (let r = 0; r < block.value.rows; r++) {
                        const cell = table.querySelector(`[data-row="${r}"][data-col="${col}"]`);
                        if (cell) {
                            cell.style.backgroundColor = color;
                            block.value.cells[r][col].bgColor = color;
                        }
                    }
                }
                
                // Clear selection visual after applying
                clearTableSelection(blockId);
            }
            // Check for multi-cell selection
            else {
                const selectedForBlock = window.selectedCells.filter(c => c.blockId === blockId);
                if (selectedForBlock.length > 0) {
                    selectedForBlock.forEach(sel => {
                        const cell = table.querySelector(`[data-row="${sel.row}"][data-col="${sel.col}"]`);
                        if (cell) {
                            cell.style.backgroundColor = color;
                            block.value.cells[sel.row][sel.col].bgColor = color;
                        }
                    });
                }
                // Fall back to single cell
                else if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block, 10) === blockId) {
                    const row = parseInt(window.selectedTableCell.dataset.row, 10);
                    const col = parseInt(window.selectedTableCell.dataset.col, 10);
                    window.selectedTableCell.style.backgroundColor = color;
                    block.value.cells[row][col].bgColor = color;
                }
            }
            
            // Hide color picker
            document.getElementById(`color-picker-${blockId}`).classList.remove('visible');
        };

        window.addTableRow = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            const newRow = [];
            for (let c = 0; c < block.value.cols; c++) {
                newRow.push({
                    content: '',
                    align: 'left',
                    vAlign: 'middle',
                    bgColor: '#FFFFFF'
                });
            }
            
            block.value.cells.push(newRow);
            block.value.rows++;
            
            // Add default height for new row if rowHeights exists
            if (block.value.rowHeights) {
                block.value.rowHeights.push(40);
            }
            
            renderAdminBlocks();
        };

        window.deleteTableRow = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table' || block.value.rows <= 1) {
                alert('Table must have at least one row.');
                return;
            }
            
            let rowToDelete = block.value.rows - 1; // Default to last row
            
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block, 10) === blockId) {
                rowToDelete = parseInt(window.selectedTableCell.dataset.row, 10);
            }
            
            block.value.cells.splice(rowToDelete, 1);
            block.value.rows--;
            
            // Also remove row height if stored
            if (block.value.rowHeights) {
                block.value.rowHeights.splice(rowToDelete, 1);
            }
            
            window.selectedTableCell = null;
            renderAdminBlocks();
        };

        window.addTableColumn = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            for (let r = 0; r < block.value.rows; r++) {
                block.value.cells[r].push({
                    content: r === 0 && block.value.headerRow ? `Header ${block.value.cols + 1}` : '',
                    align: 'left',
                    vAlign: 'middle',
                    bgColor: r === 0 && block.value.headerRow ? '#E8E8E8' : '#FFFFFF'
                });
            }
            
            block.value.cols++;
            
            // Add default width for new column if colWidths exists
            if (block.value.colWidths) {
                block.value.colWidths.push(100);
            }
            
            renderAdminBlocks();
        };

        window.deleteTableColumn = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table' || block.value.cols <= 1) {
                alert('Table must have at least one column.');
                return;
            }
            
            let colToDelete = block.value.cols - 1; // Default to last column
            
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block, 10) === blockId) {
                colToDelete = parseInt(window.selectedTableCell.dataset.col, 10);
            }
            
            for (let r = 0; r < block.value.rows; r++) {
                block.value.cells[r].splice(colToDelete, 1);
            }
            
            block.value.cols--;
            
            // Also remove column width if stored
            if (block.value.colWidths) {
                block.value.colWidths.splice(colToDelete, 1);
            }
            
            window.selectedTableCell = null;
            renderAdminBlocks();
        };
        
        // ==================== TABLE SELECTION FUNCTIONS ====================
        
        window.tableSelection = {
            blockId: null,
            type: null, // 'cell', 'row', 'col', 'all'
            row: null,
            col: null
        };
        
        window.selectTableRow = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            // Use currently selected cell's row, or default to first row
            let rowIndex = 0;
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block, 10) === blockId) {
                rowIndex = parseInt(window.selectedTableCell.dataset.row, 10);
            }
            
            window.tableSelection = { blockId, type: 'row', row: rowIndex, col: null };
            
            // Clear previous selection
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            table.classList.remove('selected-all');
            table.querySelectorAll('.selected-row, .selected-col').forEach(c => {
                c.classList.remove('selected-row', 'selected-col');
            });
            
            // Highlight row
            table.querySelectorAll(`td[data-row="${rowIndex}"], th[data-row="${rowIndex}"]`).forEach(c => {
                c.classList.add('selected-row');
            });
        };
        
        window.selectTableColumn = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            // Use currently selected cell's column, or default to first column
            let colIndex = 0;
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block, 10) === blockId) {
                colIndex = parseInt(window.selectedTableCell.dataset.col, 10);
            }
            
            window.tableSelection = { blockId, type: 'col', row: null, col: colIndex };
            
            // Clear previous selection
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            table.classList.remove('selected-all');
            table.querySelectorAll('.selected-row, .selected-col').forEach(c => {
                c.classList.remove('selected-row', 'selected-col');
            });
            
            // Highlight column
            table.querySelectorAll(`td[data-col="${colIndex}"], th[data-col="${colIndex}"]`).forEach(c => {
                c.classList.add('selected-col');
            });
        };
        
        window.selectEntireTable = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            window.tableSelection = { blockId, type: 'all', row: null, col: null };
            
            // Clear previous selection
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            table.querySelectorAll('.selected-row, .selected-col').forEach(c => {
                c.classList.remove('selected-row', 'selected-col');
            });
            
            // Highlight entire table
            table.classList.add('selected-all');
        };
        
        window.clearTableSelection = function(blockId) {
            window.tableSelection = { blockId: null, type: null, row: null, col: null };
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            table.classList.remove('selected-all');
            table.querySelectorAll('.selected-row, .selected-col').forEach(c => {
                c.classList.remove('selected-row', 'selected-col');
            });
        };
        
        // Add mousemove listener for cursor changes on table cells
        document.addEventListener('mousemove', function(event) {
            const cell = event.target.closest('.admin-table td, .admin-table th');
            if (!cell) return;
            
            const rect = cell.getBoundingClientRect();
            const edgeThreshold = 8;
            
            const isRightEdge = event.clientX >= rect.right - edgeThreshold;
            const isBottomEdge = event.clientY >= rect.bottom - edgeThreshold;
            
            const blockId = parseInt(cell.dataset.block, 10);
            const col = parseInt(cell.dataset.col, 10);
            const row = parseInt(cell.dataset.row, 10);
            const block = window.adminBlocks?.find(b => b.id === blockId);
            
            if (!block) return;
            
            // Not last column and on right edge
            if (isRightEdge && col < block.value.cols - 1) {
                cell.style.cursor = 'col-resize';
            }
            // Not last row and on bottom edge
            else if (isBottomEdge && row < block.value.rows - 1) {
                cell.style.cursor = 'row-resize';
            }
            // Normal text cursor
            else {
                cell.style.cursor = 'text';
            }
        });
        
        // ==================== TABLE RESIZE FUNCTIONS ====================
        
        window.tableResizeState = {
            isResizing: false,
            type: null, // 'col' or 'row'
            blockId: null,
            index: null,
            startX: 0,
            startY: 0,
            startSize: 0,
            overlay: null
        };
        
        // Handle mousedown on table cell to detect edge clicks for resizing
        window.handleTableCellMouseDown = function(event, blockId, row, col) {
            const cell = event.target.closest('td, th');
            if (!cell) return;
            
            const rect = cell.getBoundingClientRect();
            const edgeThreshold = 8; // pixels from edge to trigger resize
            
            const isRightEdge = event.clientX >= rect.right - edgeThreshold;
            const isBottomEdge = event.clientY >= rect.bottom - edgeThreshold;
            
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            // Check if on right edge (column resize) - not for last column
            if (isRightEdge && col < block.value.cols - 1) {
                event.preventDefault();
                startColResize(event, blockId, col);
                return;
            }
            
            // Check if on bottom edge (row resize) - not for last row
            if (isBottomEdge && row < block.value.rows - 1) {
                event.preventDefault();
                startRowResize(event, blockId, row);
                return;
            }
            
            // Normal cell selection - clear any table selections
            clearTableSelection(blockId);
        };
        
        window.startColResize = function(event, blockId, colIndex) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Get current column width
            const firstRowCells = table.querySelectorAll('tr:first-child th, tr:first-child td');
            const cell = firstRowCells[colIndex];
            const startWidth = cell ? cell.offsetWidth : 100;
            
            // Initialize colWidths array if not exists
            if (!block.value.colWidths) {
                block.value.colWidths = [];
                firstRowCells.forEach((c, idx) => {
                    block.value.colWidths[idx] = c.offsetWidth;
                });
            }
            
            window.tableResizeState = {
                isResizing: true,
                type: 'col',
                blockId: blockId,
                index: colIndex,
                startX: event.clientX,
                startY: 0,
                startSize: startWidth,
                overlay: null
            };
            
            // Add overlay to capture mouse
            const overlay = document.createElement('div');
            overlay.className = 'table-resize-overlay';
            document.body.appendChild(overlay);
            window.tableResizeState.overlay = overlay;
            
            document.addEventListener('mousemove', handleTableResize);
            document.addEventListener('mouseup', stopTableResize);
        };
        
        window.startRowResize = function(event, blockId, rowIndex) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Get current row height
            const rows = table.querySelectorAll('tr');
            const row = rows[rowIndex];
            const startHeight = row ? row.offsetHeight : 40;
            
            // Initialize rowHeights array if not exists
            if (!block.value.rowHeights) {
                block.value.rowHeights = [];
                rows.forEach((r, idx) => {
                    block.value.rowHeights[idx] = r.offsetHeight;
                });
            }
            
            window.tableResizeState = {
                isResizing: true,
                type: 'row',
                blockId: blockId,
                index: rowIndex,
                startX: 0,
                startY: event.clientY,
                startSize: startHeight,
                overlay: null
            };
            
            // Add overlay to capture mouse
            const overlay = document.createElement('div');
            overlay.className = 'table-resize-overlay row-resize';
            document.body.appendChild(overlay);
            window.tableResizeState.overlay = overlay;
            
            document.addEventListener('mousemove', handleTableResize);
            document.addEventListener('mouseup', stopTableResize);
        };
        
        function handleTableResize(event) {
            if (!window.tableResizeState.isResizing) return;
            
            const state = window.tableResizeState;
            const block = window.adminBlocks.find(b => b.id === state.blockId);
            if (!block) return;
            
            const table = document.getElementById(`admin-table-${state.blockId}`);
            if (!table) return;
            
            if (state.type === 'col') {
                const deltaX = event.clientX - state.startX;
                const newWidth = Math.max(40, state.startSize + deltaX);
                
                // Update all cells in this column
                const cells = table.querySelectorAll(`td[data-col="${state.index}"], th[data-col="${state.index}"]`);
                cells.forEach(cell => {
                    cell.style.width = newWidth + 'px';
                });
                
                // Store width
                if (!block.value.colWidths) block.value.colWidths = [];
                block.value.colWidths[state.index] = newWidth;
                
            } else if (state.type === 'row') {
                const deltaY = event.clientY - state.startY;
                const newHeight = Math.max(25, state.startSize + deltaY);
                
                // Update all cells in this row
                const cells = table.querySelectorAll(`td[data-row="${state.index}"], th[data-row="${state.index}"]`);
                cells.forEach(cell => {
                    cell.style.height = newHeight + 'px';
                });
                
                // Store height
                if (!block.value.rowHeights) block.value.rowHeights = [];
                block.value.rowHeights[state.index] = newHeight;
            }
        }
        
        function stopTableResize(event) {
            if (!window.tableResizeState.isResizing) return;
            
            // Remove overlay
            if (window.tableResizeState.overlay) {
                window.tableResizeState.overlay.remove();
            }
            
            window.tableResizeState.isResizing = false;
            document.removeEventListener('mousemove', handleTableResize);
            document.removeEventListener('mouseup', stopTableResize);
        }
        
        // ==================== END TABLE RESIZE FUNCTIONS ====================

        // ==================== END TABLE EDITOR FUNCTIONS ====================

        window.removeAdminBlock = function (id) {
            window.adminBlocks = window.adminBlocks.filter(b => b.id !== id);
            renderAdminBlocks();
        };

        window.updateBlockValue = function (id, value) {
            const block = window.adminBlocks.find(b => b.id === id);
            if (block) block.value = value;
        };

        window.toggleBlank = function (el) {
            if (el.classList.contains('is-blank')) {
                el.classList.remove('is-blank');
                el.style.backgroundColor = 'transparent';
                el.style.borderBottom = 'none';
            } else {
                el.classList.add('is-blank');
                el.style.backgroundColor = '#fff9c4';
                el.style.borderBottom = '2px solid #fbc02d';
            }
        };

        window.processAdminQuestion = function () {
            const previewSection = document.getElementById('admin-preview-section');
            const previewContent = document.getElementById('admin-preview-content');
            const category = document.getElementById('admin-category').value;
            
            if (window.adminBlocks.length === 0) {
                alert("Please add some content blocks first!");
                return;
            }
            
            previewSection.classList.remove('hidden');

            let mainHtml = '';
            let afterAnswerHtml = '';
            
            window.adminBlocks.forEach(block => {
                if (block.type === 'text' && block.value) {
                    mainHtml += `<div style="margin-bottom: 1.5rem; color: var(--main-text); font-size: 1.1rem;">${block.value.replace(/\n/g, '<br>')}</div>`;
                } else if (block.type === 'answer' && block.value) {
                    const words = block.value.split(/\s+/);
                    const wrappedWords = words.map(word => `<span class="admin-word" onclick="toggleBlank(this)" style="cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: all 0.2s;">${word}</span>`).join(' ');
                    mainHtml += `<div class="cer-segment" style="margin-bottom: 1.5rem; line-height: 2;">${wrappedWords}</div>`;
                } else if (block.type === 'explanation' && block.value) {
                    // Explanation goes after the answer/MCQ options
                    afterAnswerHtml += `<div class="explanation-box" style="margin-top: 1.5rem; padding: 1.5rem; background: #f0f4ff; border-left: 4px solid #007bff; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 0.8rem; color: #007bff; display: flex; align-items: center; gap: 8px;"> Explanation</h4>
                                <div style="color: #444; line-height: 1.6;">${block.value.replace(/\n/g, '<br>')}</div>
                             </div>`;
                } else if (block.type === 'image' && block.value) {
                    const imageUrl = convertDropboxUrl(block.value);
                    mainHtml += `<img src="${imageUrl}" style="max-width: 100%; border-radius: 8px; margin-bottom: 1.5rem; display: block; margin-left: auto; margin-right: auto;" onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<p style=\\'color:#dc3545;\\'> Image failed to load. Check URL.</p>');">`;
                } else if (block.type === 'video' && block.value) {
                    // Video goes after the answer/MCQ options
                    let videoUrl = block.value;
                    if (videoUrl.includes('dropbox.com')) {
                        videoUrl = videoUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?raw=1', '');
                    } else if (videoUrl.includes('youtube.com/watch?v=')) {
                        videoUrl = videoUrl.replace('watch?v=', 'embed/');
                    } else if (videoUrl.includes('youtu.be/')) {
                        videoUrl = videoUrl.replace('youtu.be/', 'youtube.com/embed/');
                    }
                    afterAnswerHtml += `<div class="video-container hidden-until-answered" style="margin-top: 1.5rem; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none;">
                                <iframe src="${videoUrl}" style="width: 100%; height: 315px; border: none;" allowfullscreen></iframe>
                             </div>`;
                } else if (block.type === 'table' && block.value) {
                    // Render table for preview with merge support
                    const tableData = block.value;
                    
                    // Build hidden cells map
                    const hiddenCells = new Set();
                    const mergeMap = {};
                    if (tableData.mergedCells) {
                        tableData.mergedCells.forEach(merge => {
                            for (let r = merge.startRow; r <= merge.endRow; r++) {
                                for (let c = merge.startCol; c <= merge.endCol; c++) {
                                    if (r !== merge.startRow || c !== merge.startCol) {
                                        hiddenCells.add(`${r}-${c}`);
                                    }
                                }
                            }
                            mergeMap[`${merge.startRow}-${merge.startCol}`] = {
                                colspan: merge.endCol - merge.startCol + 1,
                                rowspan: merge.endRow - merge.startRow + 1
                            };
                        });
                    }
                    
                    let tableHtml = `<table class="question-table" style="width: 100%; border-collapse: collapse; font-family: 'Century Gothic', 'Segoe UI', sans-serif; margin-bottom: 1.5rem;">`;
                    
                    for (let r = 0; r < tableData.rows; r++) {
                        const rowHeightStyle = tableData.rowHeights && tableData.rowHeights[r] ? `height: ${tableData.rowHeights[r]}px;` : '';
                        tableHtml += `<tr style="${rowHeightStyle}">`;
                        for (let c = 0; c < tableData.cols; c++) {
                            // Skip hidden cells
                            if (hiddenCells.has(`${r}-${c}`)) continue;
                            
                            const cell = tableData.cells[r][c];
                            const tag = (r === 0 && tableData.headerRow) ? 'th' : 'td';
                            const fontWeight = (r === 0 && tableData.headerRow) ? 'font-weight: 600;' : '';
                            const colWidthStyle = tableData.colWidths && tableData.colWidths[c] ? `width: ${tableData.colWidths[c]}px;` : '';
                            
                            // Check for merge attributes
                            const mergeInfo = mergeMap[`${r}-${c}`];
                            const colspanAttr = mergeInfo && mergeInfo.colspan > 1 ? `colspan="${mergeInfo.colspan}"` : '';
                            const rowspanAttr = mergeInfo && mergeInfo.rowspan > 1 ? `rowspan="${mergeInfo.rowspan}"` : '';
                            
                            tableHtml += `<${tag} ${colspanAttr} ${rowspanAttr} style="border: 1px solid #bbb; padding: 10px 14px; text-align: ${cell.align}; vertical-align: ${cell.vAlign || 'middle'}; background-color: ${cell.bgColor}; ${fontWeight} ${colWidthStyle}">${cell.content}</${tag}>`;
                        }
                        tableHtml += '</tr>';
                    }
                    
                    tableHtml += '</table>';
                    mainHtml += tableHtml;
                }
            });

            // Build final HTML: main content first, then MCQ options (if MCQ), then after-answer content
            let html = mainHtml;
            
            if (category === 'mcq') {
                const opts = [
                    document.getElementById('mcq-opt-1').value,
                    document.getElementById('mcq-opt-2').value,
                    document.getElementById('mcq-opt-3').value,
                    document.getElementById('mcq-opt-4').value
                ];
                const correct = document.getElementById('mcq-correct').value;
                html += `<div class="mcq-container" style="margin-top: 1rem;">`;
                opts.forEach((opt, i) => {
                    if (opt) {
                        html += `
                            <label class="mcq-option">
                                <input type="radio" name="temp-mcq-preview" value="${i + 1}" data-correct="${correct == i + 1}">
                                <span>${opt}</span>
                            </label>
                        `;
                    }
                });
                html += `</div>`;
            }
            
            // Add explanation and video at the end (after MCQ options / answer areas)
            html += afterAnswerHtml;

            previewContent.innerHTML = html;
            previewSection.scrollIntoView({ behavior: 'smooth' });
        };

        window.saveAdminQuestion = async function () {
            // Set flag to prevent any auto-refresh during save
            window.isSavingQuestion = true;
            
            if (!window.auth || !window.auth.currentUser) {
                window.isSavingQuestion = false;
                alert("You must be logged in to save.");
                return;
            }
            
            const title = document.getElementById('admin-title').value.trim();
            if (!title) {
                window.isSavingQuestion = false;
                alert("Please enter a question title.");
                document.getElementById('admin-title').focus();
                return;
            }
            
            if (window.adminBlocks.length === 0) {
                window.isSavingQuestion = false;
                alert("Please add some content blocks before saving.");
                return;
            }

            try {
                const category = document.getElementById('admin-category').value;
                const level = document.getElementById('admin-level').value;

                let topic = document.getElementById('admin-topic').value;
                if (topic === 'new-topic') {
                    topic = document.getElementById('admin-new-topic').value.trim().toLowerCase().replace(/\s+/g, '-');
                    if (!topic) {
                        alert("Please enter a name for the new topic.");
                        return;
                    }
                }

                // Check if preview has been generated
                const previewContent = document.getElementById('admin-preview-content');
                let finalHtml = '';
                
                if (previewContent.innerHTML.trim()) {
                    // Use preview content (with blanks selected)
                    const clone = previewContent.cloneNode(true);
                    
                    // Remove any controls that might be in the preview
                    clone.querySelectorAll('.controls, button.submit-btn, button.next-btn, button.print-btn, button.btn-primary').forEach(el => el.remove());
                    
                    // Ensure explanation boxes are hidden by default
                    clone.querySelectorAll('.explanation-box').forEach(el => {
                        el.style.display = 'none';
                    });
                    
                    // Ensure video containers are hidden by default
                    clone.querySelectorAll('.video-container').forEach(el => {
                        el.style.display = 'none';
                        el.classList.add('hidden-until-answered');
                    });
                    
                    const selectedWords = clone.querySelectorAll('.admin-word.is-blank');
                    selectedWords.forEach(word => {
                        const answer = word.textContent.trim().replace(/[.,!?;:]/g, '');
                        const calcWidth = Math.max(90, (answer.length * 1.5) * 10);
                        word.outerHTML = `<input type="text" class="answer-input" data-answer="${answer}" placeholder="..." style="width: ${calcWidth}px;">`;
                    });

                    // Convert non-blank words back to plain text
                    clone.querySelectorAll('.admin-word:not(.is-blank)').forEach(word => {
                        word.outerHTML = word.textContent;
                    });

                    clone.querySelectorAll('.cer-segment').forEach(seg => {
                        if (!seg.querySelector('.feedback-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'feedback-icon';
                            seg.appendChild(icon);
                        }
                    });
                    
                    finalHtml = clone.innerHTML;
                } else {
                    // Build HTML directly from blocks (no preview)
                    // Separate main content from after-answer content
                    let mainHtml = '';
                    let afterAnswerHtml = '';
                    
                    window.adminBlocks.forEach(block => {
                        if (block.type === 'text' && block.value) {
                            mainHtml += `<div style="margin-bottom: 1.5rem; color: var(--main-text); font-size: 1.1rem;">${block.value.replace(/\n/g, '<br>')}</div>`;
                        } else if (block.type === 'answer' && block.value) {
                            // Parse [word] as blanks
                            let answerHtml = block.value.replace(/\[([^\]]+)\]/g, (match, answer) => {
                                const calcWidth = Math.max(90, (answer.length * 1.5) * 10);
                                return `<input type="text" class="answer-input" data-answer="${answer.trim()}" placeholder="..." style="width: ${calcWidth}px;">`;
                            });
                            mainHtml += `<div class="cer-segment" style="margin-bottom: 1.5rem; line-height: 2;">${answerHtml}<span class="feedback-icon"></span></div>`;
                        } else if (block.type === 'explanation' && block.value) {
                            // Explanation goes after MCQ/answer section
                            afterAnswerHtml += `<div class="explanation-box" style="margin-top: 1.5rem; padding: 1.5rem; background: #f0f4ff; border-left: 4px solid #007bff; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 0.8rem; color: #007bff; display: flex; align-items: center; gap: 8px;"> Explanation</h4>
                                <div style="color: #444; line-height: 1.6;">${block.value.replace(/\n/g, '<br>')}</div>
                             </div>`;
                        } else if (block.type === 'image' && block.value) {
                            const imageUrl = convertDropboxUrl(block.value);
                            mainHtml += `<img src="${imageUrl}" class="question-diagram" style="max-width: 100%; border-radius: 8px; margin-bottom: 1.5rem; display: block; margin-left: auto; margin-right: auto;">`;
                        } else if (block.type === 'video' && block.value) {
                            // Video goes after MCQ/answer section
                            let videoUrl = block.value;
                            if (videoUrl.includes('dropbox.com')) {
                                videoUrl = videoUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?raw=1', '');
                            } else if (videoUrl.includes('youtube.com/watch?v=')) {
                                videoUrl = videoUrl.replace('watch?v=', 'embed/');
                            } else if (videoUrl.includes('youtu.be/')) {
                                videoUrl = videoUrl.replace('youtu.be/', 'youtube.com/embed/');
                            }
                            afterAnswerHtml += `<div class="video-container hidden-until-answered" style="margin-top: 1.5rem; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none;">
                                <iframe src="${videoUrl}" style="width: 100%; height: 315px; border: none;" allowfullscreen></iframe>
                             </div>`;
                        } else if (block.type === 'table' && block.value) {
                            // Generate table HTML for saving with merge support
                            const tableData = block.value;
                            
                            // Build hidden cells map
                            const hiddenCells = new Set();
                            const mergeMap = {};
                            if (tableData.mergedCells) {
                                tableData.mergedCells.forEach(merge => {
                                    for (let r = merge.startRow; r <= merge.endRow; r++) {
                                        for (let c = merge.startCol; c <= merge.endCol; c++) {
                                            if (r !== merge.startRow || c !== merge.startCol) {
                                                hiddenCells.add(`${r}-${c}`);
                                            }
                                        }
                                    }
                                    mergeMap[`${merge.startRow}-${merge.startCol}`] = {
                                        colspan: merge.endCol - merge.startCol + 1,
                                        rowspan: merge.endRow - merge.startRow + 1
                                    };
                                });
                            }
                            
                            let tableHtml = `<table class="question-table" style="width: 100%; border-collapse: collapse; font-family: 'Century Gothic', 'Segoe UI', sans-serif; margin-bottom: 1.5rem;">`;
                            
                            for (let r = 0; r < tableData.rows; r++) {
                                const rowHeightStyle = tableData.rowHeights && tableData.rowHeights[r] ? `height: ${tableData.rowHeights[r]}px;` : '';
                                tableHtml += `<tr style="${rowHeightStyle}">`;
                                for (let c = 0; c < tableData.cols; c++) {
                                    // Skip hidden cells
                                    if (hiddenCells.has(`${r}-${c}`)) continue;
                                    
                                    const cell = tableData.cells[r][c];
                                    const tag = (r === 0 && tableData.headerRow) ? 'th' : 'td';
                                    const fontWeight = (r === 0 && tableData.headerRow) ? 'font-weight: 600;' : '';
                                    const colWidthStyle = tableData.colWidths && tableData.colWidths[c] ? `width: ${tableData.colWidths[c]}px;` : '';
                                    
                                    // Check for merge attributes
                                    const mergeInfo = mergeMap[`${r}-${c}`];
                                    const colspanAttr = mergeInfo && mergeInfo.colspan > 1 ? `colspan="${mergeInfo.colspan}"` : '';
                                    const rowspanAttr = mergeInfo && mergeInfo.rowspan > 1 ? `rowspan="${mergeInfo.rowspan}"` : '';
                                    
                                    tableHtml += `<${tag} ${colspanAttr} ${rowspanAttr} style="border: 1px solid #bbb; padding: 10px 14px; text-align: ${cell.align}; vertical-align: ${cell.vAlign || 'middle'}; background-color: ${cell.bgColor}; ${fontWeight} ${colWidthStyle}">${cell.content}</${tag}>`;
                                }
                                tableHtml += '</tr>';
                            }
                            
                            tableHtml += '</table>';
                            mainHtml += tableHtml;
                        }
                    });

                    // Start with main content
                    finalHtml = mainHtml;

                    // Add MCQ options if MCQ category
                    if (category === 'mcq') {
                        const opts = [
                            document.getElementById('mcq-opt-1').value,
                            document.getElementById('mcq-opt-2').value,
                            document.getElementById('mcq-opt-3').value,
                            document.getElementById('mcq-opt-4').value
                        ];
                        const correct = document.getElementById('mcq-correct').value;
                        finalHtml += `<div class="mcq-container" style="margin-top: 1rem;">`;
                        opts.forEach((opt, i) => {
                            if (opt) {
                                finalHtml += `
                                    <label class="mcq-option">
                                        <input type="radio" name="mcq-answer" value="${i + 1}" data-correct="${correct == i + 1}">
                                        <span>${opt}</span>
                                    </label>
                                `;
                            }
                        });
                        finalHtml += `</div>`;
                    }
                    
                    // Add explanation and video at the very end
                    finalHtml += afterAnswerHtml;
                }

                const { doc, setDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Determine if updating existing or creating new
                const isEditing = window.editingQuestionId && window.editingQuestionId.startsWith('q-custom-');
                const questionId = isEditing 
                    ? window.editingQuestionId.replace('q-', '') 
                    : "custom-" + Date.now();
                
                const questionData = {
                    title: title,
                    html: finalHtml,
                    updatedBy: window.auth.currentUser.email,
                    updatedAt: new Date().toISOString(),
                    category: category,
                    level: level,
                    topic: topic,
                    type: 'custom'
                };
                
                if (!isEditing) {
                    questionData.createdBy = window.auth.currentUser.email;
                    questionData.createdAt = new Date().toISOString();
                }
                
                await setDoc(doc(window.db_fs, "custom_questions", questionId), questionData, { merge: true });
                
                const actionText = isEditing ? "updated" : "added";
                alert(`Question successfully ${actionText}!`);
                
                // Clear the form but preserve category/level/topic settings
                window.editingQuestionId = null;
                window.clearAdminForm(true, true); // force clear, preserve settings
                
                // Reset the loaded flag so questions can be reloaded
                window.customQuestionsLoaded = false;
                
                // Remove existing custom questions from DOM to prevent duplicates
                document.querySelectorAll('.custom-question').forEach(el => el.remove());
                
                // Reload the custom questions from database
                if (window.loadCustomQuestions) {
                    await window.loadCustomQuestions();
                }
                
                // Update tab counts after adding new question
                if (window.updateTabCounts) {
                    setTimeout(() => updateTabCounts(), 100);
                }
                
                // Scroll to title and focus for next question entry
                const titleInput = document.getElementById('admin-title');
                if (titleInput) {
                    titleInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => titleInput.focus(), 300);
                }
                
                // Reset the saving flag
                window.isSavingQuestion = false;
                
            } catch (e) {
                window.isSavingQuestion = false;
                console.error("Save Error:", e);
                alert("Error saving: " + e.message);
            }
        };

        // Cancel editing and clear form
        window.cancelEditing = function() {
            if (window.adminBlocks.length > 0 && !confirm("Cancel editing? Unsaved changes will be lost.")) return;
            window.editingQuestionId = null;
            window.clearAdminForm(true, true); // force clear, preserve settings
            updateEditingIndicator();
        };
        
        // Update the editing indicator
        window.updateEditingIndicator = function() {
            const indicator = document.getElementById('editing-indicator');
            const nameSpan = document.getElementById('editing-question-name');
            const titleInput = document.getElementById('admin-title');
            
            if (window.editingQuestionId) {
                indicator.classList.remove('hidden');
                indicator.style.display = 'flex';
                nameSpan.textContent = titleInput.value || window.editingQuestionId;
            } else {
                indicator.classList.add('hidden');
                indicator.style.display = 'none';
            }
        };

        // Clear admin form
        window.clearAdminForm = function(force = false, preserveSettings = false) {
            if (!force && window.adminBlocks.length > 0 && !confirm("Clear all content? This cannot be undone.")) return;
            
            // Save current settings if preserving
            let savedCategory, savedLevel, savedTopic;
            if (preserveSettings) {
                savedCategory = document.getElementById('admin-category').value;
                savedLevel = document.getElementById('admin-level')?.value;
                savedTopic = document.getElementById('admin-topic').value;
            }
            
            window.adminBlocks = [];
            window.editingQuestionId = null;
            renderAdminBlocks();
            
            document.getElementById('admin-title').value = '';
            document.getElementById('admin-new-topic').value = '';
            document.getElementById('admin-new-topic').classList.add('hidden');
            document.getElementById('mcq-opt-1').value = '';
            document.getElementById('mcq-opt-2').value = '';
            document.getElementById('mcq-opt-3').value = '';
            document.getElementById('mcq-opt-4').value = '';
            document.getElementById('mcq-correct').value = '1';
            
            if (preserveSettings && savedCategory) {
                // Restore saved settings
                document.getElementById('admin-category').value = savedCategory;
                handleCategoryChange(savedCategory);
                
                if (savedCategory === 'mcq' && savedLevel) {
                    document.getElementById('admin-level').value = savedLevel;
                    updateAdminTopicsByLevel(savedLevel);
                }
                
                // Restore topic after a small delay to ensure options are populated
                setTimeout(() => {
                    const topicSelect = document.getElementById('admin-topic');
                    const topicExists = Array.from(topicSelect.options).some(opt => opt.value === savedTopic);
                    if (topicExists) {
                        topicSelect.value = savedTopic;
                    }
                }, 50);
            } else {
                // Reset to defaults
                document.getElementById('admin-category').value = 'cer';
                document.getElementById('admin-topic').value = 'heat';
                handleCategoryChange('cer');
            }
            
            document.getElementById('admin-preview-section').classList.add('hidden');
            document.getElementById('admin-preview-content').innerHTML = '';
            
            updateEditingIndicator();
        };

        // Convert Dropbox URL to displayable format
        window.convertDropboxUrl = function(url) {
            if (!url) return url;
            
            // Handle new Dropbox format: /scl/fi/xxx/file.jpg?rlkey=xxx&dl=0
            if (url.includes('dropbox.com/scl/')) {
                // Replace dl=0 or dl=1 with raw=1
                url = url.replace(/[?&]dl=[01]/, '&raw=1');
                if (!url.includes('raw=1')) {
                    url += (url.includes('?') ? '&' : '?') + 'raw=1';
                }
                return url;
            }
            
            // Handle old Dropbox format
            if (url.includes('dropbox.com')) {
                return url.replace('www.dropbox.com', 'dl.dropboxusercontent.com')
                          .replace('?dl=0', '')
                          .replace('?dl=1', '');
            }
            
            return url;
        };

        function editQuestion(btn, isDuplicate = false) {
            const container = btn.closest('.question-container');
            const titleEl = container.querySelector('h3');
            
            // Extract title from h3 - this works for both custom and built-in questions
            let title = "";
            if (titleEl) {
                title = titleEl.innerText.trim();
            }
            
            // If h3 is generic like "Question 1" for built-in questions, try question-title paragraph
            if (!title || (/^Question\s*\d*$/i.test(title) && !container.classList.contains('custom-question') && !container.id.includes('custom'))) {
                const questionTitleEl = container.querySelector('.question-title, p.question-title');
                if (questionTitleEl) {
                    const fullText = questionTitleEl.textContent.trim();
                    title = fullText.length > 60 ? fullText.substring(0, 57) + '...' : fullText;
                }
            }
            
            // Fallback if still no title
            if (!title) {
                title = "Untitled Question";
            }

            // Detect category from container location
            let category = 'cer';
            let detectedTopic = 'heat';
            
            if (container.closest('#view-cer') || container.closest('[id^="topic-heat"]') || container.closest('[id^="topic-light"]') || container.closest('[id^="topic-materials"]')) {
                category = 'cer';
            } else if (container.closest('#view-definition')) {
                category = 'definition';
            } else if (container.closest('#view-single-relationship')) {
                category = 'single-relationship';
            } else if (container.id.includes('mcq') || container.closest('[id^="topic-mcq-"]')) {
                category = 'mcq';
            }
            
            // Try to detect topic from container ID
            const containerId = container.closest('[id^="topic-"]')?.id || '';
            if (containerId) {
                const topicMatch = containerId.match(/topic-(?:mcq-)?(.+)/);
                if (topicMatch) {
                    detectedTopic = topicMatch[1];
                }
            }

            // Store the question ID if editing (not duplicating) - do this BEFORE setTimeout
            if (!isDuplicate && container.id) {
                window.editingQuestionId = container.id;
            } else {
                window.editingQuestionId = null;
            }
            
            // Store the title for later use
            const finalTitle = isDuplicate ? title + " (Copy)" : title;

            // Switch to admin tab
            switchTab('admin', document.getElementById('btn-sidebar-admin'));

            // Set form values with a small delay to ensure DOM is ready
            setTimeout(() => {
                // Set category
                document.getElementById('admin-category').value = category;
                handleCategoryChange(category);
                
                // Set the title explicitly
                document.getElementById('admin-title').value = finalTitle;
                
                // Try to set the topic
                const topicSelect = document.getElementById('admin-topic');
                const topicExists = Array.from(topicSelect.options).some(opt => opt.value === detectedTopic);
                if (topicExists) {
                    topicSelect.value = detectedTopic;
                }
                
                // Try to detect MCQ level from topic container
                if (category === 'mcq') {
                    // Check which level's topics include this topic
                    for (const [level, topics] of Object.entries(window.mcqCurriculum)) {
                        const normalizedTopics = topics.map(t => t.toLowerCase().replace(/\s+/g, '-'));
                        if (normalizedTopics.includes(detectedTopic)) {
                            document.getElementById('admin-level').value = level;
                            updateAdminTopicsByLevel(level);
                            // Re-set the topic after updating options
                            setTimeout(() => {
                                const topicSelect = document.getElementById('admin-topic');
                                const topicExists = Array.from(topicSelect.options).some(opt => opt.value === detectedTopic);
                                if (topicExists) {
                                    topicSelect.value = detectedTopic;
                                }
                                // Re-set title again after MCQ updates to be sure
                                document.getElementById('admin-title').value = finalTitle;
                            }, 100);
                            break;
                        }
                    }
                }
                
                // Update editing indicator after title is set
                updateEditingIndicator();
            }, 100);

            window.adminBlocks = [];
            
            // ========== EXTRACT CONTENT IN DOM ORDER ==========
            // Find the question body container
            const questionBody = container.querySelector('.question-body, .answer-template, .mcq-body') || container;
            
            // Get all direct children and walk through them in order
            const processElement = (element, blockIdOffset) => {
                if (!element || element.classList?.contains('controls')) return;
                
                const tagName = element.tagName?.toLowerCase();
                
                // Skip certain elements
                if (element.classList?.contains('feedback-icon')) return;
                if (element.classList?.contains('mcq-option')) return; // MCQ options handled separately
                if (element.classList?.contains('mcq-container')) return; // MCQ container handled separately
                if (tagName === 'button') return;
                if (tagName === 'h3') return; // Title is handled separately
                
                // Check for explanation box
                if (element.classList?.contains('explanation-box')) {
                    const contentDiv = element.querySelector('div:last-child') || element.querySelector('div');
                    let explainText = '';
                    if (contentDiv) {
                        explainText = contentDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '').trim();
                    } else {
                        explainText = element.textContent.replace(/\s*Explanation/i, '').trim();
                    }
                    if (explainText) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'explanation', 
                            value: explainText
                        });
                    }
                    return;
                }
                
                // Check for video container
                if (element.classList?.contains('video-container')) {
                    const iframe = element.querySelector('iframe');
                    if (iframe && iframe.src) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'video', 
                            value: iframe.src
                        });
                    }
                    return;
                }
                
                // Check for standalone iframe (video)
                if (tagName === 'iframe' && (element.src?.includes('youtube') || element.src?.includes('dropbox'))) {
                    window.adminBlocks.push({ 
                        id: Date.now() + blockIdOffset, 
                        type: 'video', 
                        value: element.src
                    });
                    return;
                }
                
                // Check for image
                if (tagName === 'img' && element.src && !element.src.includes('data:')) {
                    window.adminBlocks.push({ 
                        id: Date.now() + blockIdOffset, 
                        type: 'image', 
                        value: element.src 
                    });
                    return;
                }
                
                // Check for table
                if (tagName === 'table') {
                    // Extract table data with merge support
                    const rows = element.querySelectorAll('tr');
                    
                    // First pass: determine actual grid dimensions and collect merge info
                    let maxCols = 0;
                    const mergedCells = [];
                    
                    // Create a grid to track which cells are occupied
                    const occupiedGrid = {};
                    
                    rows.forEach((row, rowIdx) => {
                        let colIdx = 0;
                        row.querySelectorAll('th, td').forEach((cell) => {
                            // Skip already occupied positions
                            while (occupiedGrid[`${rowIdx}-${colIdx}`]) {
                                colIdx++;
                            }
                            
                            const colspan = parseInt(cell.getAttribute('colspan'), 10) || 1;
                            const rowspan = parseInt(cell.getAttribute('rowspan'), 10) || 1;
                            
                            // Mark cells as occupied
                            for (let r = 0; r < rowspan; r++) {
                                for (let c = 0; c < colspan; c++) {
                                    occupiedGrid[`${rowIdx + r}-${colIdx + c}`] = {
                                        content: cell.textContent.trim(),
                                        align: cell.style.textAlign || 'left',
                                        vAlign: cell.style.verticalAlign || 'middle',
                                        bgColor: cell.style.backgroundColor || '#FFFFFF',
                                        isOrigin: r === 0 && c === 0,
                                        originRow: rowIdx,
                                        originCol: colIdx
                                    };
                                }
                            }
                            
                            // Record merge info if this is a merged cell
                            if (colspan > 1 || rowspan > 1) {
                                mergedCells.push({
                                    startRow: rowIdx,
                                    startCol: colIdx,
                                    endRow: rowIdx + rowspan - 1,
                                    endCol: colIdx + colspan - 1
                                });
                            }
                            
                            maxCols = Math.max(maxCols, colIdx + colspan);
                            colIdx += colspan;
                        });
                    });
                    
                    const numRows = rows.length;
                    const numCols = maxCols;
                    
                    // Build cell data array
                    const tableData = {
                        rows: numRows,
                        cols: numCols,
                        cells: [],
                        headerRow: !!rows[0]?.querySelector('th'),
                        colWidths: [],
                        rowHeights: []
                    };
                    
                    // Add merged cells data if any
                    if (mergedCells.length > 0) {
                        tableData.mergedCells = mergedCells;
                    }
                    
                    // Build cells array from occupied grid
                    for (let r = 0; r < numRows; r++) {
                        const rowData = [];
                        for (let c = 0; c < numCols; c++) {
                            const cellInfo = occupiedGrid[`${r}-${c}`];
                            if (cellInfo) {
                                rowData.push({
                                    content: cellInfo.isOrigin ? cellInfo.content : '',
                                    align: cellInfo.align,
                                    vAlign: cellInfo.vAlign || 'middle',
                                    bgColor: cellInfo.bgColor
                                });
                            } else {
                                rowData.push({
                                    content: '',
                                    align: 'left',
                                    vAlign: 'middle',
                                    bgColor: '#FFFFFF'
                                });
                            }
                        }
                        tableData.cells.push(rowData);
                        
                        // Extract row height
                        const rowHeight = parseInt(rows[r].style.height, 10) || null;
                        if (rowHeight) {
                            tableData.rowHeights[r] = rowHeight;
                        }
                    }
                    
                    // Extract column widths from first row cells
                    let colIdx = 0;
                    rows[0]?.querySelectorAll('th, td').forEach((cell) => {
                        while (occupiedGrid[`0-${colIdx}`] && !occupiedGrid[`0-${colIdx}`].isOrigin) {
                            colIdx++;
                        }
                        const colWidth = parseInt(cell.style.width, 10) || null;
                        if (colWidth) {
                            tableData.colWidths[colIdx] = colWidth;
                        }
                        const colspan = parseInt(cell.getAttribute('colspan'), 10) || 1;
                        colIdx += colspan;
                    });
                    
                    // Clean up empty arrays
                    if (tableData.colWidths.length === 0 || tableData.colWidths.every(w => !w)) {
                        delete tableData.colWidths;
                    }
                    if (tableData.rowHeights.length === 0 || tableData.rowHeights.every(h => !h)) {
                        delete tableData.rowHeights;
                    }
                    
                    if (tableData.rows > 0 && tableData.cols > 0) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'table', 
                            value: tableData
                        });
                    }
                    return;
                }
                
                // Check for CER segment (fill-in-blank)
                if (element.classList?.contains('cer-segment')) {
                    let segText = '';
                    const label = element.getAttribute('data-label') || '';
                    
                    // Walk through all nodes to build the text with blanks marked
                    const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT);
                    let node;
                    while (node = walker.nextNode()) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            segText += node.textContent;
                        } else if (node.nodeType === Node.ELEMENT_NODE) {
                            if (node.classList?.contains('answer-input') || node.tagName === 'INPUT') {
                                const answer = node.dataset?.answer || node.value || '';
                                if (answer) {
                                    segText += `[${answer}]`;
                                }
                            }
                        }
                    }
                    
                    segText = segText.replace(/\s+/g, ' ').trim();
                    // Remove feedback icons text
                    segText = segText.replace(/[]/g, '').trim();
                    
                    if (segText) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'answer', 
                            value: (label ? `(${label}) ` : '') + segText
                        });
                    }
                    return;
                }
                
                // Check for div with text content (but not containers)
                if (tagName === 'div') {
                    // Skip if it's a container div with children that we'll process
                    const hasProcessableChildren = element.querySelector('img, table, iframe, .cer-segment, .explanation-box, .video-container');
                    if (hasProcessableChildren) {
                        // Process children instead
                        Array.from(element.children).forEach((child, idx) => {
                            processElement(child, blockIdOffset + idx * 10);
                        });
                        return;
                    }
                    
                    // It's a text div
                    const text = element.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '').trim();
                    if (text && text.length > 0) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'text', 
                            value: text
                        });
                    }
                    return;
                }
                
                // Check for paragraph
                if (tagName === 'p') {
                    // Skip if inside mcq-option or explanation
                    if (element.closest('.mcq-option') || element.closest('.explanation-box')) return;
                    
                    const text = element.textContent.trim();
                    if (text) {
                        // Check if this is a question-title
                        if (element.classList?.contains('question-title')) {
                            window.adminBlocks.push({ 
                                id: Date.now() + blockIdOffset, 
                                type: 'text', 
                                value: text
                            });
                        } else {
                            window.adminBlocks.push({ 
                                id: Date.now() + blockIdOffset, 
                                type: 'text', 
                                value: text
                            });
                        }
                    }
                    return;
                }
            };
            
            // Process all children of the question body in order
            let blockOffset = 0;
            Array.from(questionBody.children).forEach((child, idx) => {
                processElement(child, blockOffset);
                blockOffset += 100;
            });
            
            // If no blocks were extracted, try a simpler approach for older question formats
            if (window.adminBlocks.length === 0) {
                // Get text content
                const allText = [];
                container.querySelectorAll('p:not(.question-title), div[style*="margin-bottom"]').forEach(el => {
                    if (!el.closest('.mcq-option') && !el.closest('.explanation-box') && !el.closest('.controls')) {
                        const text = el.textContent.trim();
                        if (text) allText.push(text);
                    }
                });
                if (allText.length > 0) {
                    window.adminBlocks.push({ 
                        id: Date.now(), 
                        type: 'text', 
                        value: allText.join('\n\n')
                    });
                }
                
                // Get images
                container.querySelectorAll('img').forEach((img, idx) => {
                    if (img.src && !img.src.includes('data:') && !img.closest('.explanation-box')) {
                        window.adminBlocks.push({ 
                            id: Date.now() + idx + 100, 
                            type: 'image', 
                            value: img.src
                        });
                    }
                });
                
                // Get explanation
                const explanation = container.querySelector('.explanation-box');
                if (explanation) {
                    const contentDiv = explanation.querySelector('div:last-child') || explanation.querySelector('div');
                    let explainText = contentDiv ? contentDiv.textContent.trim() : explanation.textContent.replace(/\s*Explanation/i, '').trim();
                    if (explainText) {
                        window.adminBlocks.push({ 
                            id: Date.now() + 500, 
                            type: 'explanation', 
                            value: explainText
                        });
                    }
                }
                
                // Get video
                const video = container.querySelector('iframe[src*="youtube"], iframe[src*="dropbox"], .video-container iframe');
                if (video && video.src) {
                    window.adminBlocks.push({ 
                        id: Date.now() + 600, 
                        type: 'video', 
                        value: video.src
                    });
                }
            }
            
            // Handle MCQ specific content - fill in the option fields
            if (category === 'mcq') {
                const mcqOptions = container.querySelectorAll('.mcq-option');
                mcqOptions.forEach((opt, idx) => {
                    const input = opt.querySelector('input[type="radio"]');
                    const span = opt.querySelector('span');
                    if (span && idx < 4) {
                        let optText = span.textContent.trim();
                        optText = optText.replace(/^\d+\.\s*/, '');
                        setTimeout(() => {
                            document.getElementById(`mcq-opt-${idx + 1}`).value = optText;
                            if (input && input.dataset.correct === 'true') {
                                document.getElementById('mcq-correct').value = (idx + 1).toString();
                            }
                        }, 150);
                    }
                });
            }

            renderAdminBlocks();
            
            // Hide preview section when loading new content
            document.getElementById('admin-preview-section').classList.add('hidden');
            
            // Final safety: set title again after everything is done
            setTimeout(() => {
                document.getElementById('admin-title').value = finalTitle;
                updateEditingIndicator();
            }, 200);
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // =====================================================
        // QUESTION FORM SETUP
        // =====================================================

        function setupQuestionForm(formId) {
            const form = document.getElementById(formId);
            if (!form) return;
            const questionContainer = form.closest('.question-container');
            if (!questionContainer) return;
            const submitBtn = questionContainer.querySelector('.submit-btn');
            const nextBtn = questionContainer.querySelector('.next-btn');
            const segments = form.querySelectorAll('.cer-segment');

            if (!submitBtn) return;

            submitBtn.addEventListener('click', () => {
                let allCorrect = true;
                
                segments.forEach(segment => {
                    const inputs = segment.querySelectorAll('.answer-input');
                    const icon = segment.querySelector('.feedback-icon');
                    let isGroupCorrect = true;
                    inputs.forEach(input => {
                        const userAnswer = input.value.trim().toLowerCase();
                        const answerString = input.dataset.answer.toLowerCase();
                        const validAnswers = answerString.split('|').map(a => a.trim());

                        if (validAnswers.includes(userAnswer)) {
                            input.style.borderBottomColor = 'var(--correct-color)';
                        } else {
                            input.style.borderBottomColor = 'var(--incorrect-color)';
                            input.value = validAnswers[0];
                            isGroupCorrect = false;
                            allCorrect = false;
                        }
                    });
                    if (icon) {
                        icon.textContent = isGroupCorrect ? '' : '';
                        icon.classList.add(isGroupCorrect ? 'correct' : 'incorrect', 'visible');
                    }
                });

                form.querySelectorAll('.answer-input').forEach(input => input.disabled = true);
                submitBtn.disabled = true;
                
                if (nextBtn) nextBtn.classList.remove('hidden');
                
                // Show explanation if it exists
                const explanationBox = form.querySelector('.explanation-box');
                if (explanationBox) {
                    explanationBox.style.display = 'block';
                }
                
                // Show video if it exists
                const videoContainer = form.querySelector('.video-container');
                if (videoContainer) {
                    videoContainer.style.display = 'block';
                }
                
                // Track OEQ answer for admin dashboard
                const questionId = questionContainer.id;
                if (questionId && window.trackQuestionAttempt) {
                    window.trackQuestionAttempt(questionId, allCorrect);
                }
            });
        }
        window.setupQuestionFormGlobal = setupQuestionForm;

        // =====================================================
        // ADD CONTROLS TO QUESTIONS
        // =====================================================

        function addControlsToQuestion(container) {
            // Add worksheet button if not exists
            if (!container.querySelector('.worksheet-control-bar')) {
                const bar = document.createElement('div');
                bar.className = 'worksheet-control-bar';
                bar.style.display = 'flex';
                bar.style.gap = '10px';
                bar.style.flexWrap = 'wrap';

                const qId = container.id;
                const isInWorksheet = qId && window.worksheetItems.some(item => item.id === qId);

                bar.innerHTML = `
                    <button class="btn-worksheet-add ${isInWorksheet ? 'added' : ''}" onclick="toggleWorksheetItem(this)">${isInWorksheet ? ' Added' : ' Worksheet'}</button>
                    <button class="consult-btn" onclick="showConsultModal(this)"> Ask Mr Chung</button>
                    <button class="print-question-btn" onclick="printSingleQuestion(this.closest('.question-container'))"> Print</button>
                    <button class="flag-question-btn" onclick="showFlagModal(this.closest('.question-container'))"> Flag</button>
                `;
                container.appendChild(bar);
            } else {
                // Add consult button if missing
                const bar = container.querySelector('.worksheet-control-bar');
                if (bar && !bar.querySelector('.consult-btn')) {
                    const consultBtn = document.createElement('button');
                    consultBtn.className = 'consult-btn';
                    consultBtn.onclick = function() { showConsultModal(this); };
                    consultBtn.innerHTML = ' Ask Mr Chung';
                    bar.appendChild(consultBtn);
                }
                // Add print button if missing
                if (bar && !bar.querySelector('.print-question-btn')) {
                    const printBtn = document.createElement('button');
                    printBtn.className = 'print-question-btn';
                    printBtn.onclick = function() { printSingleQuestion(this.closest('.question-container')); };
                    printBtn.innerHTML = ' Print';
                    bar.appendChild(printBtn);
                }
                // Add flag button if missing
                if (bar && !bar.querySelector('.flag-question-btn')) {
                    const flagBtn = document.createElement('button');
                    flagBtn.className = 'flag-question-btn';
                    flagBtn.onclick = function() { showFlagModal(this.closest('.question-container')); };
                    flagBtn.innerHTML = ' Flag';
                    bar.appendChild(flagBtn);
                }
            }

            // Add admin controls if admin
            if (window.isAdminUser && !container.querySelector('.admin-controls')) {
                const controls = document.createElement('div');
                controls.className = 'admin-controls';
                
                const isCustomQuestion = container.classList.contains('custom-question') || container.id.includes('custom');
                
                let controlsHtml = `
                    <button class="admin-edit-btn" onclick="editQuestion(this)"> Edit</button>
                    <button class="admin-duplicate-btn" onclick="editQuestion(this, true)"> Duplicate</button>
                `;
                
                if (isCustomQuestion) {
                    controlsHtml += `<button class="admin-delete-btn" onclick="deleteQuestion(this)" style="background: #ffeae8; color: #dc3545; border: 1px solid #dc3545;"> Delete</button>`;
                }
                
                controls.innerHTML = controlsHtml;
                container.appendChild(controls);
            }
        }

        // Delete a custom question
        window.deleteQuestion = async function(btn) {
            if (!confirm("Are you sure you want to delete this question? This cannot be undone.")) return;
            
            const container = btn.closest('.question-container');
            if (!container || !container.id) {
                alert("Cannot identify question to delete.");
                return;
            }
            
            try {
                const questionId = container.id.replace('q-', '');
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                await deleteDoc(doc(window.db_fs, "custom_questions", questionId));
                
                alert("Question deleted successfully!");
                container.remove();
            } catch (e) {
                console.error("Delete Error:", e);
                alert("Error deleting question: " + e.message);
            }
        };

        window.updateAllControls = function () {
            document.querySelectorAll('.question-container').forEach(addControlsToQuestion);
        };

        // =====================================================
        // PRINT FUNCTIONS
        // =====================================================

        window.printQuestion = function (btn) {
            const container = btn.closest('.question-container');
            container.classList.add('printing');
            document.body.classList.add('print-single');
            window.print();
            document.body.classList.remove('print-single');
            container.classList.remove('printing');
        };

        window.printAll = function () {
            document.body.classList.add('print-all');
            window.print();
            document.body.classList.remove('print-all');
        };

        // =====================================================
        // TOPIC SWITCHING
        // =====================================================

        function switchTopic(topic) {
            const navButtons = {
                heat: document.getElementById('btn-heat'),
                light: document.getElementById('btn-light'),
                materials: document.getElementById('btn-materials')
            };
            const topics = {
                heat: document.getElementById('topic-heat'),
                light: document.getElementById('topic-light'),
                materials: document.getElementById('topic-materials')
            };

            Object.values(navButtons).forEach(btn => btn?.classList.remove('active'));
            Object.values(topics).forEach(t => t?.classList.add('hidden'));

            if (navButtons[topic]) navButtons[topic].classList.add('active');
            if (topics[topic]) topics[topic].classList.remove('hidden');
        }

        // =====================================================
        // MOBILE SIDEBAR TOGGLE
        // =====================================================
        
        window.toggleMobileSidebar = function() {
            const sidebar = document.querySelector('.app-body > .sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const toggleBtn = document.getElementById('mobile-menu-toggle');
            const icon = document.getElementById('mobile-menu-icon');
            
            if (sidebar && overlay) {
                const isOpen = sidebar.classList.contains('mobile-open');
                
                if (isOpen) {
                    closeMobileSidebar();
                } else {
                    sidebar.classList.add('mobile-open');
                    overlay.classList.add('active');
                    toggleBtn.classList.add('active');
                    icon.textContent = '';
                    document.body.style.overflow = 'hidden';
                    
                    // Ensure sidebar is clickable
                    sidebar.style.pointerEvents = 'auto';
                    sidebar.style.zIndex = '10000';
                    
                    // Prevent overlay from blocking sidebar clicks
                    overlay.style.zIndex = '9998';
                }
            }
        };

        window.closeMobileSidebar = function() {
            const sidebar = document.querySelector('.app-body > .sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const toggleBtn = document.getElementById('mobile-menu-toggle');
            const icon = document.getElementById('mobile-menu-icon');
            
            if (sidebar) {
                sidebar.classList.remove('mobile-open');
            }
            if (overlay) {
                overlay.classList.remove('active');
            }
            if (toggleBtn) {
                toggleBtn.classList.remove('active');
            }
            if (icon) {
                icon.textContent = '';
            }
            document.body.style.overflow = '';
        };
        
        // Prevent sidebar clicks from closing the sidebar (only overlay should close it)
        // Also ensure sidebar buttons are clickable
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.querySelector('.app-body > .sidebar');
            if (sidebar) {
                // Stop clicks on sidebar background from bubbling to overlay
                // But allow all interactive elements to work normally
                sidebar.addEventListener('click', function(e) {
                    // Check if the click is on an interactive element
                    const isInteractive = e.target.closest('button') || 
                                        e.target.closest('a') || 
                                        e.target.closest('input') || 
                                        e.target.closest('select') ||
                                        e.target.closest('.ios-toggle') ||
                                        e.target.closest('.exam-mode-toggle') ||
                                        e.target.closest('.ios-toggle-track') ||
                                        e.target.closest('.ios-toggle-thumb') ||
                                        e.target.closest('.exam-mode-track') ||
                                        e.target.closest('.exam-mode-thumb');
                    
                    // Only stop propagation for non-interactive elements (sidebar background)
                    // This prevents overlay from closing sidebar, but allows buttons to work
                    if (!isInteractive && e.target === sidebar) {
                        e.stopPropagation();
                    }
                }, false); // Use bubble phase, not capture
            }
        });

        // Close sidebar when clicking a sidebar button on mobile
        window.handleSidebarButtonClick = function(callback) {
            return function(e) {
                // Close mobile sidebar if open
                if (window.innerWidth <= 768) {
                    closeMobileSidebar();
                }
                // Execute the original callback
                if (callback) callback(e);
            };
        };

        // Handle orientation change
        window.addEventListener('orientationchange', function() {
            // Close mobile sidebar on orientation change
            closeMobileSidebar();
            
            // Delay to let the browser settle
            setTimeout(() => {
                // Scroll to top to reset view
                window.scrollTo(0, 0);
            }, 100);
        });

        // Handle resize - close sidebar if switching from mobile to desktop
        let lastWidth = window.innerWidth;
        window.addEventListener('resize', function() {
            const currentWidth = window.innerWidth;
            
            // If crossing the 768px threshold, close mobile sidebar
            if (lastWidth <= 768 && currentWidth > 768) {
                closeMobileSidebar();
            }
            
            lastWidth = currentWidth;
        });

        // Prevent body scroll when sidebar is open (iOS fix)
        document.addEventListener('touchmove', function(e) {
            const sidebar = document.querySelector('.app-body > .sidebar');
            if (sidebar && sidebar.classList.contains('mobile-open')) {
                // Allow scrolling and clicking within the sidebar
                // Only prevent scroll on the overlay/background
                if (!sidebar.contains(e.target)) {
                    e.preventDefault();
                }
            }
        }, { passive: false });

        // =====================================================
        // DOM CONTENT LOADED
        // =====================================================

        document.addEventListener('DOMContentLoaded', () => {
            // Load worksheet from storage
            loadWorksheetFromStorage();

            // Setup topic navigation
            const topicButtons = ['heat', 'light', 'materials'];
            topicButtons.forEach(topic => {
                const btn = document.getElementById(`btn-${topic}`);
                if (btn) {
                    btn.addEventListener('click', () => switchTopic(topic));
                }
            });

            // Setup next buttons
            document.querySelectorAll('.next-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const currentQuestion = button.closest('.question-container');
                    const nextQuestion = currentQuestion?.nextElementSibling;
                    if (nextQuestion && nextQuestion.classList.contains('question-container')) {
                        nextQuestion.classList.remove('hidden');
                        nextQuestion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });

            // Setup all question forms
            document.querySelectorAll('.answer-template').forEach(form => {
                if (form.id) setupQuestionForm(form.id);
            });

            // Initialize with heat topic
            switchTopic('heat');

            // Initialize OEQ/MCQ toggle label
            const oeqLabel = document.querySelector('.ios-toggle-label:first-of-type');
            if (oeqLabel) oeqLabel.classList.add('active');

            // Initialize level selection
            initLevel();

            // Initialize Exam Mode (Colour/Monochrome)
            initExamMode();

            // Initialize header tabs with question counts
            renderOeqHeaderTabs('cer');

            // Update worksheet UI
            updateWorksheetUI();
        });
    </script>

    <!-- Firebase Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, getDocs, query, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAUSI3Uh28IeqASEp0JhH4QPaVt-O3meBo",
            authDomain: "mathgen--app.firebaseapp.com",
            projectId: "mathgen--app",
            storageBucket: "mathgen--app.firebasestorage.app",
            messagingSenderId: "165654161198",
            appId: "1:165654161198:web:16c8bd60eb3a2aa7edbcbf",
            measurementId: "G-0MWZFG211D"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth;
        const db_fs = getFirestore(app);
        window.db_fs = db_fs;
        const googleProvider = new GoogleAuthProvider();

        let isSignUpMode = false;

        window.toggleAuthMode = () => {
            isSignUpMode = !isSignUpMode;
            document.querySelector('.toggle-link').innerText = isSignUpMode ? "Already have an account? Login" : "New here? Create an Account";
            document.getElementById('reg-fields').style.display = isSignUpMode ? "block" : "none";
            document.getElementById('legal-box').style.display = isSignUpMode ? "block" : "none";
            document.getElementById('btn-google').style.display = isSignUpMode ? "none" : "flex";
            document.getElementById('auth-title').innerText = isSignUpMode ? "Create New Account" : "Welcome Back!";
            document.getElementById('auth-subtitle').innerText = isSignUpMode ? "Register to start your learning journey" : "Sign in to continue your learning journey";
            document.getElementById('btn-login').innerText = isSignUpMode ? "Create Account" : "Login";
            document.getElementById('forgot-password-link').style.display = isSignUpMode ? "none" : "block";
            
            // Show/hide password confirmation
            document.getElementById('auth-pass-confirm').style.display = isSignUpMode ? "block" : "none";
            document.getElementById('auth-pass').placeholder = isSignUpMode ? "Create Password" : "Password";
            
            // Clear error
            document.getElementById('auth-error').innerText = "";
        };

        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errorMsg = document.getElementById('auth-error');
            errorMsg.style.color = "#dc3545";
            
            if (!email || !pass) { errorMsg.innerText = "Fields cannot be empty."; return; }

            try {
                if (isSignUpMode) {
                    // Validate password confirmation
                    const passConfirm = document.getElementById('auth-pass-confirm').value;
                    if (pass !== passConfirm) {
                        errorMsg.innerText = "Passwords do not match.";
                        return;
                    }
                    if (pass.length < 6) {
                        errorMsg.innerText = "Password must be at least 6 characters.";
                        return;
                    }
                    
                    const pName = document.getElementById('parent-name').value;
                    const students = getStudentsData();
                    
                    if (!pName) {
                        errorMsg.innerText = "Please enter parent's name."; 
                        return;
                    }
                    if (students.length === 0) {
                        errorMsg.innerText = "Please add at least one student with name and level."; 
                        return;
                    }
                    if (!document.getElementById('legal-agree').checked) {
                        errorMsg.innerText = "Please agree to the terms and conditions."; 
                        return;
                    }
                    
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db_fs, "users", cred.user.uid), {
                        email, 
                        parentName: pName, 
                        students: students,
                        studentName: students[0].name, // Backwards compatibility
                        level: students[0].level, // Backwards compatibility
                        loginDays: 1, 
                        lastLoginDate: new Date().toDateString(), 
                        agreedToTerms: true,
                        createdAt: new Date()
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (e) {
                console.error("Auth Error:", e);
                if (e.code === 'auth/email-already-in-use') {
                    errorMsg.innerText = "This email is already registered. Please login instead.";
                } else if (e.code === 'auth/weak-password') {
                    errorMsg.innerText = "Password must be at least 6 characters.";
                } else if (e.code === 'auth/invalid-email') {
                    errorMsg.innerText = "Please enter a valid email address.";
                } else if (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') {
                    errorMsg.innerText = "Invalid email or password.";
                } else {
                    errorMsg.innerText = "Error: " + e.message;
                }
            }
        };

        window.handleForgotPassword = async () => {
            const email = document.getElementById('auth-email').value;
            const errorMsg = document.getElementById('auth-error');
            if (!email) {
                errorMsg.innerText = "Please enter your email address first.";
                errorMsg.style.color = "#dc3545";
                return;
            }

            try {
                await sendPasswordResetEmail(auth, email);
                errorMsg.innerText = "Password reset email sent! Check your inbox.";
                errorMsg.style.color = "#28a745";
            } catch (e) {
                console.error("Reset Error:", e);
                errorMsg.innerText = "Error sending reset email: " + e.message;
                errorMsg.style.color = "#dc3545";
            }
        };

        window.handleGoogleLogin = async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                // Check if first-time Google user
                const userRef = doc(db_fs, "users", result.user.uid);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists() || !userSnap.data().students || userSnap.data().students.length === 0) {
                    // First-time Google user - show setup modal
                    window.pendingGoogleUser = result.user;
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('google-setup-modal').classList.add('visible');
                } else {
                    await trackLoginDays(result.user);
                }
            } catch (e) {
                document.getElementById('auth-error').innerText = "Google Error: " + e.message;
            }
        };

        // Add student entry for Google setup
        window.addGoogleStudentEntry = function() {
            const container = document.getElementById('google-students-container');
            const entries = container.querySelectorAll('.google-student-entry');
            const newIndex = entries.length;
            
            const entryDiv = document.createElement('div');
            entryDiv.className = 'google-student-entry';
            entryDiv.dataset.studentIndex = newIndex;
            entryDiv.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" class="auth-input google-student-name" placeholder="Student's Name" style="flex: 1; margin-bottom: 0;">
                    <select class="auth-input google-student-level" style="width: 100px; margin-bottom: 0;">
                        <option value="">Level</option>
                        <option value="P3">P3</option>
                        <option value="P4">P4</option>
                        <option value="P5">P5</option>
                        <option value="P6">P6</option>
                    </select>
                    <button type="button" onclick="this.parentElement.parentElement.remove()" style="background: #ffebee; border: none; border-radius: 8px; width: 40px; color: #f44336; font-size: 1.2rem; cursor: pointer;"></button>
                </div>
            `;
            container.appendChild(entryDiv);
        };

        // Get students data from Google setup modal
        window.getGoogleStudentsData = function() {
            const students = [];
            document.querySelectorAll('.google-student-entry').forEach(entry => {
                const name = entry.querySelector('.google-student-name').value.trim();
                const level = entry.querySelector('.google-student-level').value;
                if (name && level) {
                    students.push({ name, level });
                }
            });
            return students;
        };

        // Complete Google setup
        window.completeGoogleSetup = async function() {
            const errorMsg = document.getElementById('google-setup-error');
            errorMsg.style.color = "#dc3545";
            
            const parentName = document.getElementById('google-parent-name').value.trim();
            const students = getGoogleStudentsData();
            
            if (!parentName) {
                errorMsg.innerText = "Please enter parent's name.";
                return;
            }
            if (students.length === 0) {
                errorMsg.innerText = "Please add at least one student with name and level.";
                return;
            }
            if (!document.getElementById('google-legal-agree').checked) {
                errorMsg.innerText = "Please agree to the terms and conditions.";
                return;
            }
            
            try {
                const user = window.pendingGoogleUser;
                if (!user) {
                    errorMsg.innerText = "Session expired. Please try again.";
                    return;
                }
                
                await setDoc(doc(db_fs, "users", user.uid), {
                    email: user.email,
                    parentName: parentName,
                    students: students,
                    studentName: students[0].name, // Backwards compatibility
                    level: students[0].level, // Backwards compatibility
                    loginDays: 1,
                    lastLoginDate: new Date().toDateString(),
                    agreedToTerms: true,
                    createdAt: new Date(),
                    authProvider: 'google'
                });
                
                // Hide modal and continue
                document.getElementById('google-setup-modal').classList.remove('visible');
                window.pendingGoogleUser = null;
                
                // Reload page to complete login
                window.location.reload();
            } catch (e) {
                console.error("Setup Error:", e);
                errorMsg.innerText = "Error saving details: " + e.message;
            }
        };

        async function trackLoginDays(user) {
            const userRef = doc(db_fs, "users", user.uid);
            const today = new Date().toDateString();
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                const data = userSnap.data();
                
                // Check if Google user without student setup
                if ((!data.students || data.students.length === 0) && !window.isAdminUser) {
                    // Show setup modal
                    window.pendingGoogleUser = user;
                    document.getElementById('google-setup-modal').classList.add('visible');
                    return;
                }
                
                if (data.lastLoginDate !== today) {
                    await updateDoc(userRef, { loginDays: increment(1), lastLoginDate: today });
                }
                const display = document.getElementById('login-days-display');
                if (display) display.innerText = ` Day ${data.loginDays || 1} streak!`;
            } else {
                // New user via Google - minimal record, setup modal will be shown
                await setDoc(userRef, { 
                    email: user.email, 
                    studentName: user.displayName || "Student", 
                    loginDays: 1, 
                    lastLoginDate: today,
                    createdAt: new Date()
                });
                
                // Show setup modal for first-time Google users
                if (!window.isAdminUser) {
                    window.pendingGoogleUser = user;
                    document.getElementById('google-setup-modal').classList.add('visible');
                }
            }
        }

        window.handleLogout = () => signOut(auth).then(() => {
            // Clear all session data on logout
            sessionStorage.clear();
            localStorage.removeItem('server_file_version');
            window.location.href = window.location.origin + window.location.pathname + '?r=' + Date.now();
        });

        onAuthStateChanged(auth, (user) => {
            const overlay = document.getElementById('auth-overlay');
            if (user) {
                overlay.style.display = 'none';
                trackLoginDays(user);

                window.loadCustomQuestions = async function() {
                    if (window.customQuestionsLoaded) return;
                    window.customQuestionsLoaded = true;

                    try {
                        const qSnapshot = await getDocs(query(collection(db_fs, "custom_questions")));
                        qSnapshot.forEach((docSnap) => {
                            const data = docSnap.data();
                            const category = data.category;
                            const topic = data.topic || 'general';
                            const topicId = topic.toLowerCase().replace(/\s+/g, '-');

                            // If MCQ, attach to the main content area topics instead of being inside view-cer
                            const mainContentArea = document.getElementById('main-content-area');
                            const targetView = category === 'mcq' ? null : document.getElementById(`view-${category}`);

                            let containerId = category === 'mcq' ? `topic-mcq-${topicId}` : `topic-${topicId}`;
                            let topicContainer = document.getElementById(containerId);

                            if (!topicContainer) {
                                topicContainer = document.createElement('div');
                                topicContainer.id = containerId;
                                topicContainer.className = 'topic-content hidden';
                                if (category === 'mcq') {
                                    mainContentArea.appendChild(topicContainer);
                                } else if (targetView) {
                                    // Try to find main-content, if not found, append directly to view
                                    const targetContent = targetView.querySelector('.main-content');
                                    if (targetContent) {
                                        targetContent.appendChild(topicContainer);
                                    } else {
                                        targetView.appendChild(topicContainer);
                                    }
                                }
                            }

                            if (topicContainer) {
                                const qId = "q-" + docSnap.id;
                                const div = document.createElement('div');
                                div.className = 'question-container custom-question';
                                div.id = qId;
                                div.style.borderLeft = '4px solid #fbc02d';
                                
                                // Convert any Dropbox URLs in the saved HTML
                                let processedHtml = data.html;
                                // Fix Dropbox image URLs
                                processedHtml = processedHtml.replace(/src="(https:\/\/www\.dropbox\.com\/scl\/[^"]+)"/g, (match, url) => {
                                    let fixedUrl = url.replace(/[?&]dl=[01]/, '&raw=1');
                                    if (!fixedUrl.includes('raw=1')) {
                                        fixedUrl += (fixedUrl.includes('?') ? '&' : '?') + 'raw=1';
                                    }
                                    return `src="${fixedUrl}"`;
                                });
                                
                                // Remove any existing controls/buttons from saved HTML to prevent duplicates
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = processedHtml;
                                tempDiv.querySelectorAll('.controls').forEach(el => el.remove());
                                // Also remove any stray buttons that might be outside controls
                                tempDiv.querySelectorAll('button.submit-btn, button.next-btn, button.print-btn, button.btn-primary').forEach(el => el.remove());
                                // Remove any divs that only contain "Check Answer" text
                                tempDiv.querySelectorAll('div').forEach(div => {
                                    const text = div.textContent.trim();
                                    if (text === 'Check Answer' || text === 'Submit') {
                                        div.remove();
                                    }
                                });
                                // Remove mcq-option labels that contain "Check Answer"
                                tempDiv.querySelectorAll('.mcq-option, label').forEach(el => {
                                    if (el.textContent.trim().includes('Check Answer')) {
                                        el.remove();
                                    }
                                });
                                // Ensure explanation boxes are hidden by default
                                tempDiv.querySelectorAll('.explanation-box').forEach(el => {
                                    el.style.display = 'none';
                                });
                                // Ensure video containers are hidden by default
                                tempDiv.querySelectorAll('.video-container').forEach(el => {
                                    el.style.display = 'none';
                                    el.classList.add('hidden-until-answered');
                                });
                                processedHtml = tempDiv.innerHTML;
                                
                                div.innerHTML = `
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                            <h3 style="margin: 0; color: var(--primary-blue);">${data.title || 'Custom Question'}</h3>
                                            <span style="font-size: 0.7rem; background: #fff9c4; padding: 2px 8px; border-radius: 4px; color: #fbc02d; font-weight: bold;">USER CONTRIBUTED (${topic.toUpperCase()})</span>
                                        </div>
                                        <div id="${qId}-body" class="question-body ${category === 'mcq' ? 'mcq-body' : 'answer-template'}" style="background: rgba(251, 192, 45, 0.05); padding: 1.5rem; border-radius: 8px;">
                                            ${processedHtml}
                                            <div class="controls" style="margin-top: 2rem;">
                                                <button class="btn btn-primary submit-btn" ${category === 'mcq' ? `onclick="checkMcq('${qId}-body')"` : ''} style="background: #fbc02d; border-color: #fbc02d;">Check Answer</button>
                                            </div>
                                        </div>
                                    `;
                                topicContainer.appendChild(div);
                                if (category !== 'mcq' && window.setupQuestionFormGlobal) {
                                    window.setupQuestionFormGlobal(`${qId}-body`);
                                }
                            }
                        });

                        if (window.currentMode === 'mcq') window.renderMcqQuestionList();

                        // Update all controls after loading custom questions
                        setTimeout(() => {
                            window.updateAllControls();
                        }, 100);

                    } catch (e) {
                        console.error("Error loading custom questions:", e);
                    }
                }

                // =====================================================
                // FLAGGED QUESTIONS FIREBASE FUNCTIONS
                // =====================================================
                
                // Submit flag to Firebase
                window.submitFlagToFirebase = async function(flagData) {
                    try {
                        const flagId = `flag-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                        await setDoc(doc(db, "flagged_questions", flagId), {
                            ...flagData,
                            id: flagId,
                            userEmail: user.email,
                            userId: user.uid,
                            status: 'pending',
                            createdAt: new Date(),
                            updatedAt: new Date()
                        });
                        alert('Thank you for reporting this issue! An admin will review it soon.');
                    } catch (e) {
                        console.error("Error submitting flag:", e);
                        alert("Error submitting flag. Please try again.");
                    }
                };

                // Load flagged questions from Firebase (admin only)
                window.loadFlaggedQuestionsFromFirebase = async function() {
                    try {
                        const flagsRef = collection(db, "flagged_questions");
                        const snapshot = await getDocs(flagsRef);
                        
                        window.flaggedQuestions = [];
                        snapshot.forEach(doc => {
                            window.flaggedQuestions.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Sort by createdAt descending
                        window.flaggedQuestions.sort((a, b) => {
                            const dateA = a.createdAt?.seconds || 0;
                            const dateB = b.createdAt?.seconds || 0;
                            return dateB - dateA;
                        });
                        
                        window.updateFlaggedCount();
                    } catch (e) {
                        console.error("Error loading flagged questions:", e);
                    }
                };

                // Update flag status in Firebase
                window.updateFlagStatusInFirebase = async function(flagId, status) {
                    try {
                        await updateDoc(doc(db, "flagged_questions", flagId), {
                            status: status,
                            updatedAt: new Date(),
                            resolvedBy: status === 'resolved' ? user.email : null
                        });
                    } catch (e) {
                        console.error("Error updating flag status:", e);
                        alert("Error updating flag. Please try again.");
                    }
                };

                // Delete flag from Firebase
                window.deleteFlagFromFirebase = async function(flagId) {
                    try {
                        await deleteDoc(doc(db, "flagged_questions", flagId));
                    } catch (e) {
                        console.error("Error deleting flag:", e);
                        alert("Error deleting flag. Please try again.");
                    }
                };

                // Check admin status
                const emailParts = user.email.toLowerCase().split('@');
                const handle = emailParts[1] === 'gmail.com' ? emailParts[0].replace(/\./g, '') : emailParts[0];
                const adminHandles = ['zhikaichung', 'chungzhikai'];
                const isAdmin = adminHandles.includes(handle) || user.email.toLowerCase().includes('admin');

                if (isAdmin) {
                    console.log("Admin identified:", user.email);
                    window.isAdminUser = true;
                    document.getElementById('btn-sidebar-admin').classList.remove('hidden');
                    document.getElementById('btn-sidebar-progress').classList.remove('hidden');
                    document.getElementById('header-flagged-btn').classList.remove('hidden');
                    
                    // Load flagged questions count for admin
                    if (window.loadFlaggedQuestionsFromFirebase) {
                        window.loadFlaggedQuestionsFromFirebase().then(() => {
                            window.updateFlaggedCount();
                        });
                    }
                } else {
                    window.isAdminUser = false;
                    document.getElementById('btn-sidebar-admin').classList.add('hidden');
                    document.getElementById('btn-sidebar-progress').classList.add('hidden');
                    document.getElementById('header-flagged-btn').classList.add('hidden');
                }

                window.loadCustomQuestions();

                // Add controls to all questions
                setTimeout(() => {
                    window.updateAllControls();
                    window.updateWorksheetUI();
                    window.addConsultButtons();
                    window.updateUnreadCount();
                    
                    // Update tab counts after questions are loaded
                    if (window.updateTabCounts) {
                        window.updateTabCounts();
                    }
                    
                    // Initialize tooltips
                    if (window.initTooltips) {
                        initTooltips();
                    }
                    
                    // Start checking for updates
                    window.startUpdateChecker();
                    
                    // Track login and show welcome modal with new questions notification (for all users)
                    window.trackLoginAndShowWelcome(user);
                }, 200);
            } else {
                overlay.style.display = 'flex';
            }
        });

        // =====================================================
        // PREMIUM NAVIGATION DROPDOWNS
        // =====================================================

        // Update worksheet count in header badge
        function updateWorksheetCountHeader() {
            const count = window.worksheetItems ? window.worksheetItems.length : 0;
            const headerBadge = document.getElementById('worksheet-count-header');
            if (headerBadge) {
                headerBadge.textContent = count;
                headerBadge.style.display = count > 0 ? 'inline-block' : 'none';
            }
        }

        // Close all dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.nav-group') && !e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown').forEach(dropdown => {
                    dropdown.style.opacity = '0';
                    dropdown.style.transform = 'translateY(-10px)';
                    dropdown.style.pointerEvents = 'none';
                });
                document.querySelectorAll('.nav-arrow').forEach(arrow => {
                    arrow.style.transform = 'rotate(0deg)';
                });
            }
        });

        // Enhanced hover handling with mouseenter/mouseleave for better control
        document.querySelectorAll('.nav-group').forEach(group => {
            let hoverTimeout;
            
            group.addEventListener('mouseenter', () => {
                clearTimeout(hoverTimeout);
                const dropdown = group.querySelector('.nav-dropdown');
                const arrow = group.querySelector('.nav-arrow');
                if (dropdown && arrow) {
                    dropdown.style.opacity = '1';
                    dropdown.style.transform = 'translateY(0)';
                    dropdown.style.pointerEvents = 'all';
                    arrow.style.transform = 'rotate(180deg)';
                }
            });
            
            group.addEventListener('mouseleave', (e) => {
                // Check if we're moving to the dropdown
                const relatedTarget = e.relatedTarget;
                const dropdown = group.querySelector('.nav-dropdown');
                
                if (!relatedTarget || !dropdown || !dropdown.contains(relatedTarget)) {
                    hoverTimeout = setTimeout(() => {
                        const dropdown = group.querySelector('.nav-dropdown');
                        const arrow = group.querySelector('.nav-arrow');
                        if (dropdown && arrow) {
                            dropdown.style.opacity = '0';
                            dropdown.style.transform = 'translateY(-10px)';
                            dropdown.style.pointerEvents = 'none';
                            arrow.style.transform = 'rotate(0deg)';
                        }
                    }, 150); // Small delay to allow cursor movement
                }
            });
            
            // Also handle dropdown hover
            const dropdown = group.querySelector('.nav-dropdown');
            if (dropdown) {
                dropdown.addEventListener('mouseenter', () => {
                    clearTimeout(hoverTimeout);
                });
                
                dropdown.addEventListener('mouseleave', () => {
                    hoverTimeout = setTimeout(() => {
                        const arrow = group.querySelector('.nav-arrow');
                        if (dropdown && arrow) {
                            dropdown.style.opacity = '0';
                            dropdown.style.transform = 'translateY(-10px)';
                            dropdown.style.pointerEvents = 'none';
                            arrow.style.transform = 'rotate(0deg)';
                        }
                    }, 150);
                });
            }
        });

        // Initialize navigation groups - run after auth loads
        function initNavigationGroups() {
            // Update worksheet count
            updateWorksheetCountHeader();
        }

        // Initialize on DOM ready and after auth
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initNavigationGroups);
        } else {
            initNavigationGroups();
        }

        // Also initialize after auth loads
        setTimeout(() => {
            initNavigationGroups();
        }, 500);

        // Scroll to top function for questions interface
        function scrollToTop(sectionId) {
            const section = document.querySelector('.' + sectionId);
            if (section) {
                // Scroll the section header into view
                const header = section.querySelector('h3');
                if (header) {
                    header.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } else {
                // Fallback: scroll to top of page
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Scroll to bottom function for questions interface
        function scrollToBottom(sectionId) {
            const section = document.querySelector('.' + sectionId);
            if (section) {
                const questionsList = section.querySelector('#lesson-questions-list');
                if (questionsList) {
                    // Scroll to the last question in the list
                    const lastQuestion = questionsList.lastElementChild;
                    if (lastQuestion) {
                        lastQuestion.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    } else {
                        // If no questions yet, scroll to bottom of section
                        section.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }
                } else {
                    section.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
            } else {
                // Fallback: scroll to bottom of page
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }
        }

        // =====================================================
        // TUTORIAL SYSTEM
        // =====================================================

        window.tutorialState = {
            currentStep: 0,
            steps: []
        };

        // Define all tutorial steps
        const tutorialSteps = [
            {
                title: "Welcome to the Tutorial! ",
                content: "Welcome! This tutorial will guide you through all the features of the Polymath Science App. You can navigate using the Previous and Next buttons, or skip the tutorial anytime.",
                highlight: null,
                action: null
            },
            {
                title: "Navigation Sidebar ",
                content: "The sidebar on the left contains all the main features. You can access different sections like Leaderboard, My Progress, Worksheet, and more. Each button takes you to a different part of the app.",
                highlight: ".sidebar-nav-section",
                action: null
            },
            {
                title: "Answering Questions - MCQ ",
                content: "For Multiple Choice Questions (MCQ): 1) Read the question carefully, 2) Click on one of the answer options (A, B, C, or D), 3) Click 'Check Answer' to see if you're correct. The correct answer will be highlighted in green, and incorrect answers in red.",
                highlight: ".mcq-container",
                action: () => {
                    // Try to find an MCQ question to highlight
                    const mcqContainer = document.querySelector('.mcq-container');
                    if (mcqContainer) {
                        mcqContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Answering Questions - OEQ ",
                content: "For Open-Ended Questions (OEQ): 1) Read the question and instructions, 2) Type your answer in the text input fields provided, 3) Click 'Submit' to check your answer. You'll see feedback showing which parts are correct.",
                highlight: ".answer-template",
                action: () => {
                    const oeqContainer = document.querySelector('.answer-template');
                    if (oeqContainer) {
                        oeqContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Adding Questions to Worksheet ",
                content: "You can add questions to your worksheet for practice: 1) Find a question you want to practice, 2) Click the ' Add to Worksheet' button on the question, 3) The question will be saved to your worksheet. You can add multiple questions and practice them all together.",
                highlight: ".btn-worksheet-add",
                action: () => {
                    const addBtn = document.querySelector('.btn-worksheet-add');
                    if (addBtn) {
                        addBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "My Worksheet ",
                content: "Your worksheet is where you collect questions to practice. Click ' My Worksheet' in the sidebar to view all your added questions. You can: print your worksheet, save it, or remove questions. The badge shows how many questions you have.",
                highlight: "#btn-sidebar-worksheet",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-worksheet');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "My Progress ",
                content: "Track your learning progress! Click ' My Progress' to see: your overall success rate, topic mastery percentages, questions that need more practice, and your rating. This helps you identify areas to focus on.",
                highlight: "#btn-sidebar-my-progress",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-my-progress');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Leaderboard ",
                content: "See how you rank among other students! The leaderboard shows: student rankings by rating, improvement scores, total attempts, and top performers. Admins can click on student names to view their detailed progress.",
                highlight: "#btn-sidebar-leaderboard",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-leaderboard');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Question Library ",
                content: "Browse all available questions in the Question Library! Features include: sortable columns (click headers to sort), filters by topic and level, search functionality, checkboxes to select multiple questions, and 'Add to Worksheet' button for bulk adding.",
                highlight: "#btn-sidebar-question-list",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-question-list');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Saved Worksheets ",
                content: "Access your previously saved worksheets! Click ' Saved Worksheets' to view all your saved practice sets. You can reload them, share them, or delete old ones. This is great for revisiting past practice sessions.",
                highlight: "#btn-sidebar-saved-worksheets",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-saved-worksheets');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Lessons ",
                content: "Learn from video lessons! Click ' Lessons' to access educational videos with practice questions. Each lesson includes: a video explanation, related practice questions, and progress tracking. Complete lessons to improve your understanding.",
                highlight: "#btn-sidebar-lessons",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-lessons');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Rating System ",
                content: "Your performance affects your rating! The app uses an Elo-style rating system: answering correctly increases your rating, answering incorrectly decreases it, questions are matched to your skill level, and your rating helps track improvement over time.",
                highlight: null,
                action: null
            },
            {
                title: "Topic Navigation ",
                content: "Navigate between different topics easily! Use the topic buttons in the sidebar to jump to specific topics. Topics are organized by level (P3-P6) and subject area. Click any topic to see all related questions.",
                highlight: ".sidebar-nav",
                action: null
            },
            {
                title: "Level Selection ",
                content: "Choose your difficulty level! Use the level selector in the header to filter questions by Primary level (P3, P4, P5, or P6). This helps you practice at the right difficulty for your grade level.",
                highlight: "#header-level-select",
                action: () => {
                    const select = document.getElementById('header-level-select');
                    if (select) {
                        select.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Mode Toggle ",
                content: "Switch between question types! Use the toggle in the header to switch between OEQ (Open-Ended Questions) and MCQ (Multiple Choice Questions) modes. Each mode has different question types and answering methods.",
                highlight: "#mode-toggle",
                action: () => {
                    const toggle = document.getElementById('mode-toggle');
                    if (toggle) {
                        toggle.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Printing Worksheets ",
                content: "Print your worksheets for offline practice! In your worksheet view, click the 'Print' button to generate a printable version. This is perfect for practicing without a device or sharing with teachers.",
                highlight: null,
                action: null
            },
            {
                title: "Question Filtering & Search ",
                content: "Find questions quickly! In the Question Library, you can: filter by topic using the dropdown, filter by level (P3-P6), search by typing keywords in the search box, and sort by clicking column headers. This makes it easy to find exactly what you need!",
                highlight: null,
                action: null
            },
            {
                title: "Progress Tracking ",
                content: "Monitor your learning journey! The progress page shows: which topics you've mastered, which questions need more practice, your overall success rate, and improvement over time. Use this to focus your study efforts!",
                highlight: null,
                action: null
            },
            {
                title: "Tutorial Complete! ",
                content: "Congratulations! You've learned about all the main features. Remember: you can always click the ' Tutorial' button in the sidebar to review this tutorial again. Happy learning and good luck with your studies!",
                highlight: "#btn-sidebar-tutorial",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-tutorial');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
        ];

        // Initialize tutorial
        window.tutorialState.steps = tutorialSteps;

        // Start tutorial - shows all functions
        window.startTutorial = function() {
            window.tutorialState.steps = tutorialSteps;
            window.tutorialState.currentStep = 0;
            showTutorialStep(0);
        };

        // Show tutorial step
        function showTutorialStep(stepIndex) {
            const tutorialStepsList = window.tutorialState.steps || tutorialSteps;
            if (stepIndex < 0 || stepIndex >= tutorialStepsList.length) return;

            const step = tutorialStepsList[stepIndex];
            window.tutorialState.currentStep = stepIndex;

            // Remove existing tutorial overlay
            const existing = document.getElementById('tutorial-overlay');
            if (existing) existing.remove();

            // Create tutorial container (no backdrop, positioned top right)
            const overlay = document.createElement('div');
            overlay.id = 'tutorial-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 100000;
                max-width: 400px;
                width: calc(100% - 40px);
                pointer-events: none;
            `;

            // Create tutorial box
            const tutorialBox = document.createElement('div');
            tutorialBox.style.cssText = `
                background: rgba(255, 255, 255, 0.85);
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                border-radius: 16px;
                padding: 1.5rem;
                width: 100%;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.3) inset;
                position: relative;
                pointer-events: all;
                border: 1px solid rgba(255, 255, 255, 0.5);
                font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif;
            `;
            tutorialBox.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0; color: #000000; font-size: 1.2rem; font-weight: 600; font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif;">${step.title}</h2>
                    <button onclick="closeTutorial()" style="background: rgba(0, 0, 0, 0.1); border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 1rem; color: #000000; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif;" onmouseover="this.style.background='rgba(0, 0, 0, 0.2)'" onmouseout="this.style.background='rgba(0, 0, 0, 0.1)'"></button>
                </div>
                <div style="font-size: 0.9rem; line-height: 1.6; color: #000000; margin-bottom: 1.5rem; max-height: 200px; overflow-y: auto; font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif;">
                    ${step.content}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 0.8rem; color: #000000; font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif;">
                        Step ${stepIndex + 1} of ${tutorialStepsList.length}
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="previousTutorialStep()" 
                                style="padding: 0.5rem 1rem; background: rgba(0, 0, 0, 0.1); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #000000; font-size: 0.85rem; transition: all 0.2s; font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif; ${stepIndex === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
                                ${stepIndex === 0 ? 'disabled' : ''}
                                onmouseover="if(!this.disabled) this.style.background='rgba(0, 0, 0, 0.2)'"
                                onmouseout="if(!this.disabled) this.style.background='rgba(0, 0, 0, 0.1)'">
                            
                        </button>
                        <button onclick="nextTutorialStep()" 
                                style="padding: 0.5rem 1rem; background: rgba(0, 0, 0, 0.8); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #ffffff; font-size: 0.85rem; transition: all 0.2s; font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif;"
                                onmouseover="this.style.background='rgba(0, 0, 0, 0.95)'"
                                onmouseout="this.style.background='rgba(0, 0, 0, 0.8)'">
                            ${stepIndex === tutorialStepsList.length - 1 ? 'Done' : ''}
                        </button>
                    </div>
                </div>
            `;

            overlay.appendChild(tutorialBox);
            document.body.appendChild(overlay);

            // Highlight element if specified
            if (step.highlight) {
                setTimeout(() => {
                    highlightElement(step.highlight);
                }, 100);
            }

            // Execute action if specified
            if (step.action) {
                setTimeout(() => {
                    step.action();
                }, 300);
            }
        }

        // Highlight an element
        function highlightElement(selector) {
            // Remove existing highlights
            document.querySelectorAll('.tutorial-highlight').forEach(el => {
                el.style.outline = '';
                el.style.outlineOffset = '';
                el.classList.remove('tutorial-highlight');
            });

            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
                el.classList.add('tutorial-highlight');
                el.style.outline = '4px solid #667eea';
                el.style.outlineOffset = '4px';
                el.style.transition = 'outline 0.3s ease';
                el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
            });
        }

        // Navigate to next step
        window.nextTutorialStep = function() {
            const tutorialStepsList = window.tutorialState.steps || tutorialSteps;
            const nextStep = window.tutorialState.currentStep + 1;
            if (nextStep < tutorialStepsList.length) {
                showTutorialStep(nextStep);
            } else {
                closeTutorial();
            }
        };

        // Navigate to previous step
        window.previousTutorialStep = function() {
            const prevStep = window.tutorialState.currentStep - 1;
            if (prevStep >= 0) {
                showTutorialStep(prevStep);
            }
        };

        // Close tutorial
        window.closeTutorial = function() {
            const overlay = document.getElementById('tutorial-overlay');
            if (overlay) overlay.remove();
            
            // Remove highlights
            document.querySelectorAll('.tutorial-highlight').forEach(el => {
                el.style.outline = '';
                el.style.outlineOffset = '';
                el.classList.remove('tutorial-highlight');
            });
        };

        // Add CSS for tutorial highlight
        const tutorialStyle = document.createElement('style');
        tutorialStyle.textContent = `
            .tutorial-highlight {
                position: relative;
                z-index: 100001 !important;
            }
            #tutorial-overlay button:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }
            #tutorial-overlay button:active {
                transform: translateY(0);
            }
        `;
        document.head.appendChild(tutorialStyle);

        // =====================================================
        // TOOLTIP SYSTEM
        // =====================================================

        // Tooltip descriptions for buttons
        const tooltipDescriptions = {
            'header-tutorial-btn': 'Click to view a comprehensive tutorial covering all features of the app',
            'header-inbox-btn': 'View messages and notifications from teachers',
            'header-flagged-btn': 'View questions that have been flagged for review (Admin only)',
            'header-settings-btn': 'Access account settings and preferences',
            'print-btn': 'Print the current page or worksheet',
            'btn-sidebar-practice': 'Enter practice mode to work through questions at your own pace',
            'mode-toggle': 'Switch between OEQ (Open-Ended Questions) and MCQ (Multiple Choice Questions) modes',
            'exam-mode-toggle': 'Toggle exam mode for a distraction-free testing environment',
            'btn-sidebar-admin': 'Access admin panel to manage questions and view student data (Admin only)',
            'btn-sidebar-progress': 'View detailed progress for all students (Admin only)',
            'btn-sidebar-leaderboard': 'See rankings and compare your performance with other students',
            'btn-sidebar-my-progress': 'Track your learning progress, mastery percentages, and improvement over time',
            'btn-sidebar-worksheet': 'View and manage your collection of practice questions',
            'btn-sidebar-saved-worksheets': 'Access previously saved worksheets for review',
            'btn-sidebar-lessons': 'Browse video lessons with practice questions',
            'btn-sidebar-question-list': 'Browse and search all available questions in the library',
            'logout-btn': 'Sign out of your account',
            'practice': 'Practice mode - work through questions at your own pace',
            'worksheet': 'My Worksheet - view and manage your practice questions',
            'saved-worksheets': 'Access your previously saved worksheets',
            'question-list': 'Question Library - browse and search all available questions',
            'my-progress': 'View your learning progress and mastery statistics',
            'leaderboard': 'See how you rank among other students',
            'lessons': 'Watch video lessons and complete practice questions'
        };

        // Initialize tooltips
        window.initTooltips = function() {
            // Add tooltips to all buttons with data-tooltip or matching IDs
            document.querySelectorAll('button, .nav-group-btn, .nav-dropdown-item, .tab-btn').forEach(button => {
                const id = button.id;
                const text = button.textContent.trim();
                const onclick = button.getAttribute('onclick');
                
                // Get tooltip text
                let tooltipText = tooltipDescriptions[id];
                
                // Check for navigation items
                if (!tooltipText && onclick) {
                    if (onclick.includes("switchTab('practice'")) tooltipText = tooltipDescriptions['practice'];
                    else if (onclick.includes("switchTab('worksheet'")) tooltipText = tooltipDescriptions['worksheet'];
                    else if (onclick.includes("switchTab('saved-worksheets'")) tooltipText = tooltipDescriptions['saved-worksheets'];
                    else if (onclick.includes("switchTab('question-list'")) tooltipText = tooltipDescriptions['question-list'];
                    else if (onclick.includes("switchTab('my-progress'")) tooltipText = tooltipDescriptions['my-progress'];
                    else if (onclick.includes("switchTab('leaderboard'")) tooltipText = tooltipDescriptions['leaderboard'];
                    else if (onclick.includes("switchTab('lessons'")) tooltipText = tooltipDescriptions['lessons'];
                }
                
                // Check for mode toggle
                if (!tooltipText && (id === 'mode-toggle' || onclick?.includes('toggleMode'))) {
                    tooltipText = tooltipDescriptions['mode-toggle'];
                }
                
                // Check for exam mode toggle
                if (!tooltipText && (id === 'exam-mode-toggle' || onclick?.includes('toggleExamMode'))) {
                    tooltipText = tooltipDescriptions['exam-mode-toggle'];
                }
                
                if (tooltipText) {
                    button.setAttribute('data-tooltip', tooltipText);
                    button.classList.add('tooltip-container');
                }
            });
        }

        // Show tooltip
        function showTooltip(element, text) {
            // Remove existing tooltip
            const existing = document.querySelector('.tooltip');
            if (existing) {
                existing.remove();
            }

            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = text;
            tooltip.style.position = 'fixed';
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '0';

            document.body.appendChild(tooltip);

            // Get dimensions after adding to DOM
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            // Check if element is in sidebar (left side of screen, less than 350px from left)
            const isInSidebar = rect.left < 350;

            let position = 'top';
            let top, left;

            // For sidebar elements, prefer right positioning
            if (isInSidebar && rect.right + tooltipRect.width + 20 < viewportWidth) {
                position = 'right';
                left = rect.right + 12;
                top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
            }
            // If not enough space on top, try bottom
            else if (rect.top < tooltipRect.height + 20) {
                position = 'bottom';
                left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                top = rect.bottom + 12;
            }
            // If tooltip would overflow right edge, use left positioning
            else if (rect.left + (rect.width / 2) + (tooltipRect.width / 2) > viewportWidth - 20) {
                position = 'left';
                left = rect.left - tooltipRect.width - 12;
                top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
            }
            // Default: top position
            else {
                position = 'top';
                left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                top = rect.top - tooltipRect.height - 12;
            }

            // Ensure tooltip doesn't overflow viewport edges
            if (left < 10) left = 10;
            if (left + tooltipRect.width > viewportWidth - 10) {
                left = viewportWidth - tooltipRect.width - 10;
            }
            if (top < 10) top = 10;
            if (top + tooltipRect.height > viewportHeight - 10) {
                top = viewportHeight - tooltipRect.height - 10;
            }

            // Apply position
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.style.transform = 'none'; // Reset any CSS transforms

            // Add position class for arrow
            tooltip.classList.add('tooltip-' + position);

            // Position the arrow based on element position relative to tooltip
            if (position === 'right') {
                const arrowTop = rect.top + (rect.height / 2) - top;
                tooltip.style.setProperty('--arrow-top', arrowTop + 'px');
            } else if (position === 'left') {
                const arrowTop = rect.top + (rect.height / 2) - top;
                tooltip.style.setProperty('--arrow-top', arrowTop + 'px');
            } else if (position === 'top' || position === 'bottom') {
                const arrowLeft = rect.left + (rect.width / 2) - left;
                tooltip.style.setProperty('--arrow-left', arrowLeft + 'px');
            }

            tooltip.style.visibility = 'visible';

            // Show with animation after a brief delay
            setTimeout(() => {
                tooltip.classList.add('show');
            }, 50);
        }

        // Hide tooltip
        function hideTooltip() {
            const tooltip = document.querySelector('.tooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
                setTimeout(() => {
                    tooltip.remove();
                }, 200);
            }
        }

        // Add tooltip event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initTooltips();
            
            let tooltipTimeout;
            
            document.addEventListener('mouseenter', (e) => {
                const element = e.target.closest('[data-tooltip]');
                if (element) {
                    const text = element.getAttribute('data-tooltip');
                    if (text) {
                        // 1 second delay before showing tooltip
                        tooltipTimeout = setTimeout(() => {
                            showTooltip(element, text);
                        }, 1000);
                    }
                }
            }, true);
            
            document.addEventListener('mouseleave', (e) => {
                const element = e.target.closest('[data-tooltip]');
                if (element) {
                    clearTimeout(tooltipTimeout);
                    hideTooltip();
                }
            }, true);
        });

        // Re-initialize tooltips after dynamic content loads
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(...args) {
            const result = originalSwitchTab.apply(this, args);
            setTimeout(() => {
                initTooltips();
            }, 100);
            return result;
        };
    </script>

    <!-- PowerPoint-style Table Grid Selector (positioned fixed, outside all containers) -->
    <div id="table-grid-selector" class="table-grid-selector">
        <h4 style="margin: 0 0 12px 0; font-size: 1rem; color: #2e7d32; font-weight: 600; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.2rem;"></span> Insert Table
        </h4>
        <p style="margin: 0 0 10px 0; font-size: 0.8rem; color: #666;">Hover to select size, click to insert</p>
        <div class="table-grid" id="table-grid"></div>
        <div class="grid-size-label" id="grid-size-label" style="text-align: center; margin-top: 12px; font-size: 0.95rem; color: #2e7d32; font-weight: 600; min-height: 20px;">Select size</div>
    </div>

</body>

</html>
