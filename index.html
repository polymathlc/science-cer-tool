<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- AGGRESSIVE CACHE PREVENTION -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <title>CER Interactive Questions</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --main-text: #333;
            --light-text: #555;
            --peach: #fcece3;
            --teal: #d7eded;
            --blue-light: #e7f5ff;
            --border-color: #dee2e6;
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --primary-blue: #007bff;
            --secondary-blue: #6c757d;
            --disabled-grey: #b0b8c0;
            --label-color: #aab5c0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--main-text);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            background: transparent;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            padding: 0;
        }

        .sidebar {
            width: 250px;
            padding: 2rem;
            background-color: #fdfdfd;
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .sidebar h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .sidebar-nav button {
            display: block;
            width: 100%;
            padding: 0.9rem 1.5rem;
            margin-bottom: 1rem;
            border-radius: 50px;
            border: 2px solid var(--border-color);
            background-color: transparent;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
        }

        .sidebar-nav button.active {
            background-color: var(--teal);
            border-color: #bedbdb;
            color: #000;
            font-weight: 600;
        }

        .sidebar-nav button:hover {
            background-color: var(--blue-light);
            border-color: var(--primary-blue);
        }

        .main-content,
        .view-content,
        .topic-content {
            flex-grow: 1;
            padding: 2.5rem 3rem;
        }

        .question-container {
            margin-bottom: 3rem;
            position: relative;
            padding: 1.5rem;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .main-content p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            color: var(--light-text);
            line-height: 1.8;
        }

        .question-diagram {
            width: 100%;
            max-width: 600px;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .results-table {
            width: 100%;
            max-width: 700px;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .results-table th,
        .results-table td {
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .results-table thead {
            background-color: var(--peach);
        }

        .question-title {
            font-weight: 600;
            font-size: 1.15rem;
            color: var(--main-text);
        }

        .answer-box {
            background-color: var(--blue-light);
            padding: 2.5rem;
            border-radius: 12px;
            margin-top: 2rem;
        }

        .answer-template {
            font-size: 1.1rem;
            line-height: 2.2;
            color: var(--main-text);
        }

        .answer-blank {
            display: inline-flex;
            align-items: center;
            margin: 0 0.2rem;
        }

        .answer-input {
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            border: none;
            border-bottom: 2px solid var(--main-text);
            background: transparent;
            width: auto;
            min-width: 80px;
            text-align: center;
            padding: 0.1rem 0.5rem;
            margin: 0 4px;
        }

        .answer-input:focus {
            outline: none;
            border-bottom-color: var(--primary-blue);
        }

        .feedback-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            margin-left: 0.5rem;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 14px;
            transform: scale(0);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .feedback-icon.visible.correct,
        .feedback-icon.visible.incorrect {
            transform: scale(1);
            opacity: 1;
            animation: circle-pop 0.4s ease-out;
        }

        .feedback-icon.correct {
            background-color: var(--correct-color);
        }

        .feedback-icon.incorrect {
            background-color: var(--incorrect-color);
        }

        /* Explanation box - hidden by default, shown after answering */
        .explanation-box {
            display: none;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #f0f4ff;
            border-left: 4px solid #007bff;
            border-radius: 8px;
        }
        
        .explanation-box.visible {
            display: block;
        }

        /* Video container - hidden by default, shown after answering */
        .video-container.hidden-until-answered {
            display: none;
        }

        /* Draggable admin blocks */
        .admin-block {
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
        }
        
        .admin-block:not(.no-drag) {
            cursor: grab;
        }
        
        .admin-block:not(.no-drag):active {
            cursor: grabbing;
        }
        
        .admin-block.no-drag {
            cursor: default;
            opacity: 0.95;
        }
        
        .admin-block.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .admin-block.drag-over {
            border-top: 3px solid #007bff !important;
            margin-top: -3px;
        }
        
        .admin-block .drag-handle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: grab;
            color: #999;
            font-size: 1.2rem;
            padding: 5px;
            user-select: none;
        }
        
        .admin-block .drag-handle:hover {
            color: #666;
        }
        
        .admin-block .drag-handle:active {
            cursor: grabbing;
        }

        @keyframes circle-pop {
            0% {
                transform: scale(0);
            }

            60% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .cer-segment {
            position: relative;
            display: block;
            padding: 1.5rem 1.5rem 2.5rem 1.5rem;
            border: 1.5px solid var(--label-color);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .cer-segment:last-of-type {
            margin-bottom: 0;
        }

        .cer-segment::after {
            content: attr(data-label);
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--blue-light);
            padding: 0 0.5rem;
            font-size: 0.9rem;
            font-style: italic;
            color: var(--light-text);
            font-weight: 500;
        }

        .controls {
            margin-top: 2rem;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn {
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Worksheet Styles */
        .worksheet-badge {
            background: #ff4757;
            color: white;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 0.7rem;
            margin-left: 5px;
            vertical-align: middle;
        }

        .btn-worksheet-add {
            background: #f1f2f6;
            color: #2f3542;
            border: 1px solid #dfe4ea;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .btn-worksheet-add:hover {
            background: #2ed573;
            color: white;
            border-color: #2ed573;
        }

        .btn-worksheet-add.added {
            background: #2ed573;
            color: white;
            border-color: #2ed573;
        }

        .btn-worksheet-remove {
            background: #ffeae8;
            color: #dc3545;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-worksheet-remove:hover {
            background: #dc3545;
            color: white;
        }

        .submit-btn {
            background-color: var(--primary-blue);
            color: #fff;
        }

        .submit-btn:disabled {
            background-color: var(--disabled-grey);
            cursor: not-allowed;
        }

        .next-btn {
            background-color: var(--secondary-blue);
            color: #fff;
        }

        .hidden {
            display: none !important;
        }

        /* Top Navigation Tabs */
        .app-header {
            padding: 0.8rem 1rem 0;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            background: #f8f9fa;
        }

        /* Colored line below header that changes with tabs */
        .header-color-line {
            height: 5px;
            background: linear-gradient(90deg, #4a90d9 0%, #6ba3e0 100%);
            transition: background 0.4s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        #header-tabs-container {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            margin: 0;
            padding: 0;
        }

        .app-logo {
            height: 50px;
            margin-right: 0;
            margin-bottom: 0;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            transition: transform 0.3s ease;
        }

        .app-logo:hover {
            transform: scale(1.05) rotate(-2deg);
        }

        .tab-btn {
            padding: 0.45rem 0.9rem;
            border: 1px solid #ccc;
            border-bottom: none;
            background-color: #e8e8e8;
            font-family: 'Poppins', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            color: #555;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            transition: all 0.15s ease;
            position: relative;
            margin: 0;
            margin-left: -1px;
            opacity: 0.9;
        }

        .tab-btn:first-child {
            margin-left: 0;
        }

        .tab-btn:hover {
            opacity: 1;
            z-index: 2;
        }

        .tab-btn.active {
            opacity: 1;
            border-color: #aaa;
            z-index: 3;
            font-weight: 600;
            color: #333;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.08);
        }

        /* Specific Pastel Colors for Tabs */
        .tab-btn[data-type="cer"] {
            background-color: #AEC6CF;
        }

        .tab-btn[data-type="single-relationship"] {
            background-color: #FFB7B2;
        }

        .tab-btn[data-type="double-relationship"] {
            background-color: #FFDAC1;
        }

        .tab-btn[data-type="fairness"] {
            background-color: #E2F0CB;
        }

        .tab-btn[data-type="reliability"] {
            background-color: #C7CEEA;
        }

        .tab-btn[data-type="accuracy"] {
            background-color: #FDFD96;
        }

        .tab-btn[data-type="constant-variable"] {
            background-color: #B5EAD7;
        }

        .tab-btn[data-type="explanation"] {
            background-color: #FF9AA2;
        }

        .tab-btn[data-type="control-setup"] {
            background-color: #E0BBE4;
        }

        .tab-btn[data-type="definition"] {
            background-color: #ADD8E6;
        }

        .app-body {
            display: none;
            flex-grow: 1;
            background: #fff;
            border-top: none;
            position: relative;
            z-index: 15;
        }

        .app-body.active {
            display: flex;
        }

        .app-body>.sidebar {
            border-right: 1px solid var(--border-color);
            background: #fdfdfd;
        }

        .placeholder-content {
            padding: 3rem;
            text-align: center;
            width: 100%;
        }

        /* Variable Labels & Tooltips */
        .answer-group {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: bottom;
            margin: 0 0.2rem;
            position: relative;
            top: 10px;
        }

        .answer-group .answer-blank {
            margin: 0;
        }

        .variable-label {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
            border-bottom: 1px dotted #ccc;
            cursor: help;
            position: relative;
        }

        .variable-label:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            width: 220px;
            text-align: center;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            line-height: 1.4;
        }

        .variable-label:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
        }

        .print-btn {
            background-color: #ffda9e;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #555;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-family: 'Poppins', sans-serif;
        }

        .print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: #ffc978;
        }

        /* Auth Overlay */
        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .auth-box {
            background: white;
            padding: 3rem;
            border-radius: 24px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.15);
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.05);
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .auth-logo {
            height: 70px;
            margin-bottom: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .auth-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .auth-subtitle {
            color: #666;
            margin-bottom: 2.5rem;
            font-size: 1.1rem;
        }

        .auth-input {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 16px;
            border: 2px solid #f0f0f0;
            border-radius: 14px;
            font-size: 1rem;
            transition: all 0.2s;
            font-family: inherit;
            background: #fafafa;
        }

        .auth-input:focus {
            border-color: var(--primary-blue);
            background: #fff;
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
            font-family: inherit;
        }

        .auth-btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
            box-shadow: 0 10px 20px rgba(0, 123, 255, 0.2);
        }

        .btn-primary:hover {
            box-shadow: 0 15px 30px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-google {
            background: white;
            border: 2px solid #eee;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .btn-google:hover {
            background: #fafafa;
            border-color: #ddd;
        }

        .toggle-link {
            color: var(--primary-blue);
            cursor: pointer;
            font-size: 0.95rem;
            margin-top: 20px;
            display: inline-block;
            font-weight: 500;
        }

        .toggle-link:hover {
            text-decoration: underline;
        }

        .error-msg {
            color: #dc3545;
            font-size: 0.95rem;
            margin-bottom: 20px;
            min-height: 24px;
            font-weight: 500;
        }

        .legal-check {
            text-align: left;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
        }

        .legal-check input {
            margin-top: 4px;
        }

        /* Streak Display */
        #login-days-display {
            background: linear-gradient(135deg, #e7f5ff 0%, #d7eded 100%);
            color: #007bff;
            padding: 15px;
            border-radius: 14px;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
            font-size: 1.05rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
        }

        /* Admin Edit Buttons */
        .admin-controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 50;
        }

        .admin-edit-btn,
        .admin-duplicate-btn,
        .admin-delete-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .admin-edit-btn:hover {
            background: #e7f5ff;
            border-color: #007bff;
            color: #007bff;
        }

        .admin-duplicate-btn:hover {
            background: #fdfdfd;
            border-color: #555;
        }

        .admin-delete-btn:hover {
            background: #dc3545 !important;
            color: white !important;
            border-color: #dc3545 !important;
        }

        /* Worksheet Control Bar */
        .worksheet-control-bar {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 50;
        }

        /* Worksheet Question Card */
        .worksheet-question-card {
            background: #fff;
            border: 2px solid #e3f2fd;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .worksheet-question-card .question-number {
            position: absolute;
            top: -12px;
            left: 20px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 4px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .worksheet-question-card .remove-btn-wrapper {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        /* MCQ Option Styles */
        .mcq-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: white;
            border: 2px solid #eee;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mcq-option:hover {
            border-color: var(--primary-blue);
            background: var(--blue-light);
        }

        .mcq-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* MCQ Correct Answer Dropdown Fix */
        #mcq-correct {
            line-height: normal;
            padding-top: 5px;
            padding-bottom: 5px;
            appearance: auto;
        }

        /* Logout Button */
        .logout-btn {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #ffeae8;
            color: #dc3545;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #dc3545;
            color: white;
        }

        /* Mode Switcher */
        .mode-switcher {
            display: flex;
            gap: 5px;
            margin-bottom: 1.5rem;
            background: #eee;
            padding: 4px;
            border-radius: 30px;
        }

        .mode-switcher .btn {
            flex: 1;
            font-size: 0.8rem;
            padding: 8px;
            border-radius: 25px;
            background: transparent;
            color: #666;
        }

        .mode-switcher .btn.active {
            background: white;
            color: var(--primary-blue);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Version indicator (for debugging) */
        .version-indicator {
            position: fixed;
            bottom: 5px;
            right: 5px;
            font-size: 10px;
            color: #ccc;
            z-index: 9999;
        }

        /* Table Grid Selector (PowerPoint-style) */
        .table-grid-selector {
            position: fixed;
            background: white;
            border: 2px solid #81c784;
            border-radius: 12px;
            padding: 15px 18px 18px 18px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25), 0 0 0 4px rgba(129, 199, 132, 0.2);
            z-index: 10000;
            visibility: hidden;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }

        .table-grid-selector.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        /* Arrow pointing down to the button */
        .table-grid-selector::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 10px 10px 0 10px;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }
        
        .table-grid-selector::before {
            content: '';
            position: absolute;
            bottom: -13px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 12px 12px 0 12px;
            border-style: solid;
            border-color: #81c784 transparent transparent transparent;
        }

        .table-grid-selector h4 {
            margin: 0 0 12px 0;
            font-size: 0.95rem;
            color: #333;
            font-weight: 600;
        }

        .table-grid {
            display: grid;
            grid-template-columns: repeat(8, 28px);
            grid-template-rows: repeat(8, 28px);
            gap: 3px;
            background: #f5f5f5;
            padding: 5px;
            border-radius: 6px;
        }

        .table-grid-cell {
            width: 28px;
            height: 28px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .table-grid-cell.selected {
            background: #81c784;
            border-color: #4caf50;
        }

        .table-grid-cell:hover {
            border-color: #4caf50;
        }

        .grid-size-label {
            text-align: center;
            margin-top: 12px;
            font-size: 0.9rem;
            color: #007bff;
            font-weight: 600;
        }

        /* Admin Table Editor */
        .admin-table-wrapper {
            margin-top: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .admin-table-container {
            overflow-x: auto;
            padding: 10px;
            background: white;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Century Gothic', 'Segoe UI', 'Poppins', sans-serif;
            font-size: 0.95rem;
        }

        .admin-table td,
        .admin-table th {
            border: 1px solid #bbb;
            padding: 10px 14px;
            min-width: 100px;
            position: relative;
            vertical-align: middle;
        }

        .admin-table td[contenteditable="true"],
        .admin-table th[contenteditable="true"] {
            outline: none;
            cursor: text;
        }

        .admin-table td[contenteditable="true"]:focus,
        .admin-table th[contenteditable="true"]:focus {
            box-shadow: inset 0 0 0 2px #007bff;
            background: #f8fbff !important;
        }

        .admin-table th {
            background: #e8e8e8;
            font-weight: 600;
        }

        .admin-table td.selected-cell,
        .admin-table th.selected-cell {
            outline: 3px solid #007bff;
            outline-offset: -3px;
        }

        /* Table Toolbar */
        .table-toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #ddd;
            align-items: center;
        }

        .table-toolbar-group {
            display: flex;
            gap: 5px;
            align-items: center;
            padding-right: 12px;
            border-right: 1px solid #ccc;
        }

        .table-toolbar-group:last-child {
            border-right: none;
        }

        .table-toolbar-group label {
            font-size: 0.75rem;
            color: #555;
            margin-right: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-toolbar button {
            padding: 7px 12px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .table-toolbar button:hover {
            background: #e7f5ff;
            border-color: #007bff;
            transform: translateY(-1px);
        }

        .table-toolbar button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .table-toolbar button.danger {
            color: #dc3545;
        }

        .table-toolbar button.danger:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        /* Pastel Color Palette */
        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 28px);
            gap: 5px;
        }

        .color-swatch {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .color-swatch:hover {
            transform: scale(1.15);
            border-color: #555;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .color-swatch.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }

        /* Color picker dropdown */
        .color-picker-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.18);
            z-index: 1002;
            display: none;
        }

        .color-picker-dropdown.visible {
            display: block;
        }

        .color-picker-dropdown h5 {
            margin: 0 0 10px 0;
            font-size: 0.8rem;
            color: #555;
            font-weight: 600;
        }

        /* Row/Column highlight on hover */
        .admin-table tr:hover td {
            background-color: rgba(0, 123, 255, 0.05);
        }

        /* Add Table Button */
        .add-block-btn.table-btn {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #81c784;
            color: #2e7d32;
        }

        .add-block-btn.table-btn:hover {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            border-color: #66bb6a;
        }

        /* Table Grid Selector (PowerPoint-style) */
        .table-grid-selector {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }

        .table-grid-selector.visible {
            display: block;
        }

        .table-grid-selector h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: #555;
        }

        .table-grid {
            display: grid;
            grid-template-columns: repeat(8, 24px);
            grid-template-rows: repeat(8, 24px);
            gap: 2px;
        }

        .table-grid-cell {
            width: 24px;
            height: 24px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.1s;
        }

        .table-grid-cell.selected {
            background: #AEC6CF;
            border-color: #8eb3be;
        }

        .table-grid-cell:hover {
            background: #d7eded;
        }

        .grid-size-label {
            text-align: center;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        /* Admin Table Editor */
        .admin-table-container {
            margin-top: 10px;
            overflow-x: auto;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Century Gothic', 'Poppins', sans-serif;
        }

        .admin-table td,
        .admin-table th {
            border: 1px solid #ccc;
            padding: 8px 12px;
            min-width: 80px;
            position: relative;
        }

        .admin-table td[contenteditable="true"],
        .admin-table th[contenteditable="true"] {
            outline: none;
        }

        .admin-table td[contenteditable="true"]:focus,
        .admin-table th[contenteditable="true"]:focus {
            box-shadow: inset 0 0 0 2px #007bff;
        }

        .admin-table th {
            background: #f0f0f0;
            font-weight: 600;
        }

        /* Table Toolbar */
        .table-toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            align-items: center;
        }

        .table-toolbar-group {
            display: flex;
            gap: 4px;
            align-items: center;
            padding-right: 10px;
            border-right: 1px solid #ddd;
        }

        .table-toolbar-group:last-child {
            border-right: none;
        }

        .table-toolbar-group label {
            font-size: 0.75rem;
            color: #666;
            margin-right: 5px;
        }

        .table-toolbar button {
            padding: 6px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .table-toolbar button:hover {
            background: #e7f5ff;
            border-color: #007bff;
        }

        .table-toolbar button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Pastel Color Palette */
        .color-palette {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            max-width: 200px;
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            border-color: #333;
        }

        .color-swatch.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }

        /* Row/Column Selection */
        .admin-table tr.row-selected td,
        .admin-table tr.row-selected th {
            outline: 2px solid #007bff;
            outline-offset: -2px;
        }

        .admin-table td.col-selected,
        .admin-table th.col-selected {
            outline: 2px solid #28a745;
            outline-offset: -2px;
        }

        /* Color picker dropdown */
        .color-picker-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 1001;
            display: none;
        }

        .color-picker-dropdown.visible {
            display: block;
        }

        .color-picker-dropdown h5 {
            margin: 0 0 8px 0;
            font-size: 0.8rem;
            color: #555;
        }

        /* --- PRINT STYLES --- */
        @media print {

            /* Hide all UI elements */
            .app-header,
            .sidebar,
            .controls,
            .admin-controls,
            .btn-worksheet-add,
            .worksheet-control-bar,
            .worksheet-actions,
            .print-btn,
            .next-btn,
            .submit-btn,
            .variable-label,
            .logout-btn,
            .mode-switcher,
            #tab-admin,
            #auth-overlay,
            .remove-btn-wrapper,
            .btn-worksheet-remove,
            .version-indicator {
                display: none !important;
            }

            /* Reset body */
            body {
                padding: 0 !important;
                background: white !important;
                margin: 0 !important;
                color: black !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Reset containers */
            .app-container,
            .app-body,
            #main-content-area {
                display: block !important;
                overflow: visible !important;
                height: auto !important;
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                position: static !important;
                background: white !important;
            }

            /* Hide all views by default */
            .view-content {
                display: none !important;
            }

            /* Show ONLY the worksheet view when printing worksheet */
            body.print-worksheet #view-worksheet {
                display: block !important;
                visibility: visible !important;
                padding: 20px !important;
            }

            body.print-worksheet #view-worksheet * {
                visibility: visible !important;
            }

            /* Hide worksheet header in non-print, show in print */
            #worksheet-header {
                display: none;
            }

            body.print-worksheet #worksheet-header {
                display: block !important;
                visibility: visible !important;
                margin-bottom: 2rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid #000;
            }

            /* Question container print styles */
            .worksheet-question-card {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                margin-bottom: 2rem !important;
                padding: 1.5rem !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                background: white !important;
            }

            .worksheet-question-card .question-number {
                background: #333 !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Answer box print styles */
            .answer-box {
                background: #f9f9f9 !important;
                border: 1px solid #ddd !important;
                padding: 1.5rem !important;
                margin-top: 1rem !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Answer input lines for handwriting */
            .answer-input {
                border: none !important;
                border-bottom: 1.5px solid #000 !important;
                background: transparent !important;
                min-width: 150px !important;
                height: 25px !important;
                padding: 0 !important;
                display: inline-block !important;
            }

            /* CER segments print */
            .cer-segment {
                border: 1px solid #ccc !important;
                margin-bottom: 1rem !important;
                padding: 1rem !important;
                background: white !important;
            }

            .cer-segment::after {
                background: white !important;
                color: #666 !important;
            }

            /* Table print styles */
            .results-table {
                width: 100% !important;
                border-collapse: collapse !important;
            }

            .results-table th {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .results-table th,
            .results-table td {
                border: 1px solid #333 !important;
                padding: 8px !important;
            }

            /* Images print */
            .question-diagram {
                max-width: 400px !important;
                page-break-inside: avoid !important;
            }

            /* MCQ print styles */
            .mcq-option {
                border: none !important;
                background: transparent !important;
                padding: 8px 0 !important;
                display: block !important;
                page-break-inside: avoid;
            }

            .mcq-option input {
                display: none !important;
            }

            .mcq-option span::before {
                content: "‚óã ";
                font-size: 1.2rem;
            }

            /* Hide empty placeholder */
            #worksheet-empty-msg {
                display: none !important;
            }

            /* Print all questions mode */
            body.print-all .view-content.active {
                display: block !important;
            }

            body.print-all .topic-content:not(.hidden) {
                display: block !important;
            }

            body.print-all .question-container {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                margin-bottom: 2rem !important;
                padding: 1.5rem !important;
                border: 1px solid #ddd !important;
            }

            /* Single question print */
            body.print-single .question-container:not(.printing) {
                display: none !important;
            }

            body.print-single .question-container.printing {
                display: block !important;
                break-inside: avoid !important;
            }
        }
    </style>
</head>

<body>

    <!-- Version Indicator for debugging -->
    <div class="version-indicator" id="version-display"></div>

    <!-- Auth Overlay -->
    <div id="auth-overlay">
        <div class="auth-box">
            <img src="https://www.dropbox.com/scl/fi/h40yjlyg8ldefwfaa3dib/polymath-logo-sticker.png?rlkey=o1ra4taqy79gt9t8u096v82zj&raw=1"
                alt="Polymath Logo" class="auth-logo">
            <h2 id="auth-title" class="auth-title">Welcome Back!</h2>
            <p class="auth-subtitle">Sign in to continue your learning journey</p>

            <div class="error-msg" id="auth-error"></div>

            <input type="email" id="auth-email" class="auth-input" placeholder="Email Address">
            <input type="password" id="auth-pass" class="auth-input" placeholder="Password">

            <div id="forgot-password-link" style="text-align: right; margin-bottom: 20px; margin-top: -10px;">
                <span class="toggle-link" onclick="handleForgotPassword()" style="font-size: 0.85rem;">Forgot
                    Password?</span>
            </div>

            <!-- Registration Fields (Hidden by default) -->
            <div id="reg-fields" style="display: none;">
                <input type="text" id="parent-name" class="auth-input" placeholder="Parent's Name">
                <input type="text" id="student-name" class="auth-input" placeholder="Student's Name">
            </div>

            <div id="legal-box" class="legal-check" style="display: none;">
                <input type="checkbox" id="legal-agree">
                <label for="legal-agree">I agree to the Terms of Service and Privacy Policy. I confirm I am a
                    parent/guardian registering for my child.</label>
            </div>

            <button onclick="handleLogin()" id="btn-login" class="auth-btn btn-primary">Login</button>
            <button onclick="handleGoogleLogin()" id="btn-google" class="auth-btn btn-google">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Sign in with
                Google
            </button>

            <span class="toggle-link" onclick="toggleAuthMode()">New here? Create an Account</span>
        </div>
    </div>

    <div class="app-container">
        <header class="app-header">
            <div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.3rem;">
                <img src="https://www.dropbox.com/scl/fi/h40yjlyg8ldefwfaa3dib/polymath-logo-sticker.png?rlkey=o1ra4taqy79gt9t8u096v82zj&raw=1"
                    alt="Polymath Logo" class="app-logo">
                <button class="print-btn" onclick="printAll()">üñ®Ô∏è Print All</button>
            </div>
            <div id="header-tabs-container">
                <button class="tab-btn active" data-type="cer" onclick="switchTab('cer', this)">CER</button><button class="tab-btn" data-type="definition"
                    onclick="switchTab('definition', this)">Definition</button><button class="tab-btn" data-type="single-relationship"
                    onclick="switchTab('single-relationship', this)">Single Relationship</button><button class="tab-btn" data-type="double-relationship"
                    onclick="switchTab('double-relationship', this)">Double Relationship</button><button class="tab-btn" data-type="fairness" onclick="switchTab('fairness', this)">Fairness</button><button class="tab-btn" data-type="reliability"
                    onclick="switchTab('reliability', this)">Reliability</button><button class="tab-btn" data-type="accuracy" onclick="switchTab('accuracy', this)">Accuracy</button><button class="tab-btn" data-type="constant-variable"
                    onclick="switchTab('constant-variable', this)">Constant Variable</button><button class="tab-btn" data-type="explanation"
                    onclick="switchTab('explanation', this)">Explanation</button><button class="tab-btn" data-type="control-setup" onclick="switchTab('control-setup', this)">Control Set-up</button>
            </div>
        </header>
        
        <!-- Colored line that changes based on active tab -->
        <div class="header-color-line" id="header-color-line" style="background: linear-gradient(90deg, #AEC6CF 0%, #c4d6dd 50%, #AEC6CF 100%);"></div>

        <div class="app-body active" style="display: flex;">
            <aside class="sidebar">
                <div id="login-days-display">üìÖ Loading Streak...</div>
                <button onclick="handleLogout()" class="logout-btn">Logout</button>

                <button id="btn-sidebar-admin" class="hidden" onclick="switchTab('admin', this)"
                    style="width: 100%; border-radius: 10px; margin-bottom: 10px; background: #ffd1dc; color: #d81b60; border: none; padding: 10px; cursor: pointer; font-weight: 600;">üõ†Ô∏è
                    Admin Mode</button>

                <button id="btn-sidebar-worksheet" onclick="switchTab('worksheet', this)"
                    style="width: 100%; border-radius: 10px; margin-bottom: 20px; background: #e3f2fd; color: #1976d2; border: none; padding: 10px; cursor: pointer; font-weight: 600;">üìù
                    My Worksheet <span id="worksheet-count" class="worksheet-badge">0</span></button>

                <div class="mode-switcher">
                    <button onclick="switchMode('oeq')" id="mode-oeq" class="btn active">OEQ</button>
                    <button onclick="switchMode('mcq')" id="mode-mcq" class="btn">MCQ</button>
                </div>

                <div id="oeq-sidebar-content">
                    <h2 id="oeq-title">OEQ Questions</h2>
                    <nav class="sidebar-nav">
                        <button id="btn-heat">Heat</button>
                        <button id="btn-light">Light</button>
                        <button id="btn-materials">Materials</button>
                    </nav>
                </div>

                <div id="mcq-sidebar-content" class="hidden">
                    <h2 style="margin-bottom: 0.5rem;">MCQ Level</h2>
                    <select id="mcq-level-select" onchange="window.currentMcqLevel = this.value; renderMcqHeaders();"
                        class="auth-input"
                        style="height: 40px; margin-bottom: 1rem; border-radius: 8px; padding: 5px 10px; font-size: 0.9rem;">
                        <option value="P3">Primary 3</option>
                        <option value="P4">Primary 4</option>
                        <option value="P5">Primary 5</option>
                        <option value="P6">Primary 6</option>
                    </select>
                    <h2 id="mcq-topic-label" style="font-size: 1rem; color: #666; margin-bottom: 1rem;">Questions</h2>
                    <nav id="mcq-question-nav" class="sidebar-nav">
                        <!-- Dynamic Question Buttons (Q1, Q2...) -->
                    </nav>
                </div>
            </aside>

            <main id="main-content-area" style="flex: 1; overflow-y: auto;">

                <!-- View: CER (Existing - Part of OEQ) -->
                <div id="view-cer" class="view-content active">
                    <!-- TOPIC: HEAT -->
                    <div id="topic-heat" class="topic-content hidden">
                        <!-- Question 1: Heat -->
                        <div id="heat-question-1" class="question-container">
                            <h3>Question 1</h3>
                            <p>Peter conducted an experiment to find out how the materials of bowls affect the time
                                taken for the water in them to cool down. He measured the temperature of the water in
                                the three bowls every two minutes and recorded it in the table.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2" style="vertical-align: middle;">Time (min)</th>
                                        <th colspan="3">Temperature of Water (¬∞C)</th>
                                    </tr>
                                    <tr>
                                        <th>Bowl A</th>
                                        <th>Bowl B</th>
                                        <th>Bowl C</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>0</td>
                                        <td>80</td>
                                        <td>80</td>
                                        <td>80</td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>79</td>
                                        <td>74</td>
                                        <td>78</td>
                                    </tr>
                                    <tr>
                                        <td>4</td>
                                        <td>78</td>
                                        <td>68</td>
                                        <td>74</td>
                                    </tr>
                                    <tr>
                                        <td>6</td>
                                        <td>78</td>
                                        <td>61</td>
                                        <td>72</td>
                                    </tr>
                                    <tr>
                                        <td>8</td>
                                        <td>76</td>
                                        <td>55</td>
                                        <td>69</td>
                                    </tr>
                                    <tr>
                                        <td>10</td>
                                        <td>74</td>
                                        <td>49</td>
                                        <td>66</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Which bowl is the most suitable for storing frozen ice-cream?
                                Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="heat-form-1">
                                    <div class="cer-segment" data-label="claim">Bowl<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="A"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The temperature of water in bowl A
                                        decreased by the<div class="answer-blank"><input type="text"
                                                class="answer-input" data-answer="least"></div> amount,<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that bowl A is the poorest
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                style="width: 120px;" data-answer="conductor"></div>of<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="heat"></div>, allowing the ice-cream to<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="gain"></div>heat from the warmer surrounding air slowest to
                                        melt the slowest.<span class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)">üñ®Ô∏è Print</button>
                                    <button class="next-btn btn hidden">Next Question</button>
                                </div>
                            </div>
                        </div>

                        <!-- Question 2: Heat -->
                        <div id="heat-question-2" class="question-container">
                            <h3>Question 2</h3>
                            <p>Warren conducted an experiment on three solid blocks made of materials, A, B and C, of
                                the same size and thickness. He heated the three materials and measured the time taken
                                for each to increase from 30¬∞C to 50¬∞C. The table below shows his results.</p>
                            <img src="https://www.dropbox.com/scl/fi/tsjlvlar0etwnhd3wyple/Screenshot-2025-10-18-at-8.42.36-AM.png?rlkey=l15xphdym7bmg352669a8ykt1&raw=1"
                                alt="Cooler Box Experiment Diagram" class="question-diagram">
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Materials</th>
                                        <th>Time taken for the experiment (second)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>A</td>
                                        <td>50</td>
                                    </tr>
                                    <tr>
                                        <td>B</td>
                                        <td>80</td>
                                    </tr>
                                    <tr>
                                        <td>C</td>
                                        <td>35</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Which material A, B or C, should Warren choose to keep the ice
                                cold for the longest time? Explain why.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="heat-form-2">
                                    <div class="cer-segment" data-label="claim">Material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="B"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The time taken for the temperature of
                                        the block made of material B to increase from 30¬∞C to 50¬∞C is the<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="longest"></div>,<span class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that material B is the
                                        poorest<div class="answer-blank"><input type="text" class="answer-input"
                                                style="width: 120px;" data-answer="conductor"></div>of<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="heat"></div>, allowing the ice in the ice box to<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="gain"></div>heat from the warmer surrounding air<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="slowest"></div>to melt<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="slowest"></div>.<span
                                            class="feedback-icon"></span></div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)">üñ®Ô∏è Print</button>
                                    <button class="next-btn btn hidden">Next Question</button>
                                </div>
                            </div>
                        </div>

                        <!-- Question 3: Heat (Jarrell/Double-Glazed) -->
                        <div id="heat-question-3" class="question-container">
                            <h3>Question 3</h3>
                            <p>Jarrell wanted to investigate which glass, A or B, keeps water cold for a longer time.
                                Both glasses were made of the same material.</p>
                            <p>He measured the temperature of water in each glass at the start of the experiment and
                                every 10 minutes for 50 minutes. He plotted the results in the graph.</p>
                            <div style="display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-start;">
                                <img src="https://www.dropbox.com/scl/fi/6k92e3bl2ypvtoj2z3vgh/Screenshot-2026-01-01-at-1.23.56-AM.png?rlkey=sod3j1qoo1luvqt9of4vsfbak&raw=1"
                                    alt="Glasses Diagram (A: Double vs B: Single)" class="question-diagram"
                                    style="max-width: 45%; border: 1px dashed #ccc; min-height: 150px; background: #f9f9f9;">
                                <img src="https://www.dropbox.com/scl/fi/qlxcbhuj6m9awgtd3xb2z/Screenshot-2026-01-01-at-1.27.47-AM.png?rlkey=cd4cwykuja7k335j2qwymavmn&raw=1"
                                    alt="Graph Diagram (Line X vs Line Y)" class="question-diagram"
                                    style="max-width: 45%; border: 1px dashed #ccc; min-height: 150px; background: #f9f9f9;">
                            </div>
                            <p>The table shows the daily average temperature for Singapore during the day.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Average temperature (¬∞C) in the day</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Inside the house</td>
                                        <td>28¬∞C</td>
                                    </tr>
                                    <tr>
                                        <td>Outside the house</td>
                                        <td>32¬∞C</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Are double-layered or single-layered glass windows more suitable
                                for houses in Singapore, so that it is cooler inside the house? Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="heat-form-3">
                                    <div class="cer-segment" data-label="claim">
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                style="width: 150px;" data-answer="Double-layered"></div>glass windows
                                        are more suitable.<span class="feedback-icon"></span>
                                    </div>
                                    <div class="cer-segment" data-label="evidence">The temperature of water increases
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="slower"></div> for glass <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="A"></div> when compared to
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="B"></div> over 50 minutes.<span
                                            class="feedback-icon"></span>
                                    </div>
                                    <div class="cer-segment" data-label="reasoning">The layer of <div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="air"></div> trapped between the glass layer is a <div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="poor"></div> conductor of <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="heat"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="link">This <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="reduces"></div> the heat
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="gained"></div> from the <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="warmer"></div> surrounding
                                        air outside the house into the inside of the house, thus, keeping the inside of
                                        the house <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="cooler"></div>.<span class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)">üñ®Ô∏è Print</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TOPIC: LIGHT -->
                    <div id="topic-light" class="topic-content hidden">
                        <div id="light-question-1" class="question-container">
                            <h3>Question 1</h3>
                            <p>Jeremy conducted an experiment in a dark room to investigate the properties of materials
                                P, Q, R and S. He placed different materials at positions 1 and 2 respectively each
                                time.</p>
                            <img src="https://www.dropbox.com/scl/fi/m72szjzburi7sqf8u9vcj/Screenshot-2025-10-18-at-8.06.48-AM.png?rlkey=h2pcg2ig894ot07xjx7bld0fn&raw=1"
                                alt="Light Experiment Diagram" class="question-diagram">
                            <p>The amount of light detected by the light sensor was recorded as shown in the table.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Material at position 1</th>
                                        <th>Material at position 2</th>
                                        <th>Amount of light detected (lux)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>P</td>
                                        <td>Q</td>
                                        <td>2000</td>
                                    </tr>
                                    <tr>
                                        <td>Q</td>
                                        <td>R</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>R</td>
                                        <td>S</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>S</td>
                                        <td>P</td>
                                        <td>300</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Which material would be most suitable to make a bedroom curtain
                                that keeps the room totally dark? Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="light-form-1">
                                    <div class="cer-segment" data-label="claim">Material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="R"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The amount of light detected is<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="0"></div>lux when material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="R"></div>is placed in
                                        either position 1 or position 2,<span class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that material R is the only
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="opaque"></div>material, allowing the curtain to block<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="all"></div>light and keep the room totally dark.<span
                                            class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)">üñ®Ô∏è Print</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TOPIC: MATERIALS -->
                    <div id="topic-materials" class="topic-content hidden">
                        <div id="materials-question-1" class="question-container">
                            <h3>Question 1</h3>
                            <p>Tony set up an experiment to compare the property of four strips, A, B, C and D, made of
                                different materials but of the same thickness.</p>
                            <img src="https://www.dropbox.com/scl/fi/jsxkxtz7ryrm3s4i04x49/Screenshot-2025-10-18-at-2.29.33-AM.png?rlkey=cib9nnrvpxta2imuncs4j9ugw&raw=1"
                                alt="Flexibility Experiment Diagram" class="question-diagram">
                            <p>He recorded the distance, x, in the table below.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Distance x (cm)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>A</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>B</td>
                                        <td>9</td>
                                    </tr>
                                    <tr>
                                        <td>C</td>
                                        <td>30</td>
                                    </tr>
                                    <tr>
                                        <td>D</td>
                                        <td>10</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Based on the results, which strip is most suitable for making a
                                belt? Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="materials-form-1">
                                    <div class="cer-segment" data-label="claim">Material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="C"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="distance"></div>X for
                                        material<div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="C"></div>is the<div class="answer-blank"><input type="text"
                                                class="answer-input" data-answer="greatest"></div>,<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that material<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="C"></div>is the most<div class="answer-blank"><input
                                                type="text" class="answer-input" style="width: 120px;"
                                                data-answer="flexible"></div>material, allowing a belt made of it to
                                        wrap around a person's waist most easily.<span class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)">üñ®Ô∏è Print</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TOPIC: MCQ CONTENT (Dynamic) -->
                <div id="topic-mcq-living-and-non-living-things" class="topic-content hidden"></div>
                <div id="topic-mcq-materials" class="topic-content hidden"></div>
                <div id="topic-mcq-life-cycles" class="topic-content hidden"></div>
                <div id="topic-mcq-magnets" class="topic-content hidden"></div>
                <div id="topic-mcq-plant-systems" class="topic-content hidden"></div>
                <div id="topic-mcq-human-body-systems" class="topic-content hidden"></div>
                <div id="topic-mcq-matter-and-its-3-states" class="topic-content hidden"></div>
                <div id="topic-mcq-light" class="topic-content hidden"></div>
                <div id="topic-mcq-heat" class="topic-content hidden"></div>
                <div id="topic-mcq-water-and-its-3-states" class="topic-content hidden"></div>
                <div id="topic-mcq-plant-reproduction" class="topic-content hidden"></div>
                <div id="topic-mcq-human-and-plant-reproduction" class="topic-content hidden"></div>
                <div id="topic-mcq-human-and-plant-transport" class="topic-content hidden"></div>
                <div id="topic-mcq-electrical-systems" class="topic-content hidden"></div>
                <div id="topic-mcq-forces" class="topic-content hidden"></div>
                <div id="topic-mcq-energy-in-food" class="topic-content hidden"></div>
                <div id="topic-mcq-energy-conversion" class="topic-content hidden"></div>
                <div id="topic-mcq-living-together" class="topic-content hidden"></div>
                <div id="topic-mcq-food-chains-and-webs" class="topic-content hidden"></div>
                <div id="topic-mcq-humans-and-the-environment" class="topic-content hidden"></div>

                <!-- View: Single Relationship -->
                <div id="view-single-relationship" class="view-content hidden">
                    <div class="sidebar">
                        <h2>Single Relationship</h2>
                        <nav class="sidebar-nav">
                            <button id="btn-sr-forces" class="active">Forces</button>
                        </nav>
                    </div>
                    <div class="main-content">
                        <!-- TOPIC: FORCES -->
                        <div id="topic-sr-forces" class="topic-content">
                            <div id="sr-forces-question-1" class="question-container">
                                <h3>Question 1</h3>
                                <p>Meiling conducted an experiment by placing a 1 kg block on a flat surface and
                                    measured the amount of force needed to pull it along the surface using a spring
                                    balance.</p>
                                <img src="https://www.dropbox.com/scl/fi/xvhgx31uk82s32edfv6a6/spring-block.jpg?rlkey=8aejaocw35svctiogmy9mbbwt&raw=1"
                                    alt="Spring Block Diagram" class="question-diagram">
                                <p>She repeated the experiment using three similar blocks that are of different masses
                                    and recorded the results in the graph.</p>
                                <img src="https://www.dropbox.com/scl/fi/j1kumnl75vervdk5he9p7/graph-app.jpg?rlkey=4gqp7teop1dy2wa38yr20iu2n&raw=1"
                                    alt="Force Graph Diagram" class="question-diagram">
                                <p class="question-title">State what Meiling could conclude based on the results of her
                                    experiment.</p>
                                <div class="answer-box">
                                    <div class="answer-template" id="sr-forces-form-1">
                                        <div class="cer-segment" style="border:none; padding:0; margin-bottom:0;"
                                            data-label="">
                                            As the
                                            <div class="answer-group">
                                                <div class="answer-blank"><input type="text" class="answer-input"
                                                        style="width: 200px;" data-answer="mass of the block|mass">
                                                </div>
                                                <span class="variable-label"
                                                    data-tooltip="The variable that is changed or controlled in a scientific experiment to test the effects on the dependent variable.">independent
                                                    variable</span>
                                            </div>
                                            increases, the
                                            <div class="answer-group">
                                                <div class="answer-blank"><input type="text" class="answer-input"
                                                        style="width: 350px;"
                                                        data-answer="amount of force needed to pull it along the surface|amount of force|force">
                                                </div>
                                                <span class="variable-label"
                                                    data-tooltip="The variable being tested and measured in a scientific experiment.">dependent
                                                    variable</span>
                                            </div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="increases"></div>.
                                            <span class="feedback-icon" style="margin-left: 10px;"></span>
                                        </div>
                                    </div>
                                    <div class="controls">
                                        <button class="submit-btn btn">Submit</button>
                                        <button class="print-btn" onclick="printQuestion(this)">üñ®Ô∏è Print</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-double-relationship" class="view-content hidden">
                    <div class="placeholder-content">
                        <h2>Double Relationship Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-definition" class="view-content hidden">
                    <div class="sidebar">
                        <h2>Definition</h2>
                        <nav class="sidebar-nav">
                            <button id="btn-def-evap" class="active">Evaporation</button>
                        </nav>
                    </div>
                    <div class="main-content">
                        <div id="topic-def-evap" class="topic-content">
                            <div id="def-evap-question-1" class="question-container">
                                <h3>Question 1</h3>
                                <p class="question-title">Define evaporation.</p>
                                <div class="answer-box">
                                    <div class="answer-template" id="def-form-1"
                                        style="font-size: 1.2rem; line-height: 2;">
                                        <div class="cer-segment" data-label="definition">
                                            Evaporation is a process where a <div class="answer-blank"><input
                                                    type="text" class="answer-input" data-answer="liquid"></div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="gains"></div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="heat"></div> from a heat source to become <div
                                                class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="gas"></div> at <div class="answer-blank"><input
                                                    type="text" class="answer-input" data-answer="any"></div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    style="width: 150px;" data-answer="temperature"></div>.
                                            <span class="feedback-icon"></span>
                                        </div>
                                    </div>
                                    <div class="controls">
                                        <button class="submit-btn btn">Submit</button>
                                        <button class="print-btn" onclick="printQuestion(this)">üñ®Ô∏è Print</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-fairness" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Fairness Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-reliability" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Reliability Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-accuracy" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Accuracy Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-constant-variable" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Constant Variable Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-explanation" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Explanation Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-control-setup" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Control Set-up Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-admin" class="view-content hidden" style="flex: 1;">
                    <main style="max-width: 900px; margin: 0 auto; padding-top: 2rem;">
                        <h2 style="margin-bottom: 1rem; color: var(--main-text);">Question Creator (Admin)</h2>
                        <div id="editing-indicator" class="hidden" style="background: #fff3cd; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; color: #856404; display: flex; justify-content: space-between; align-items: center;">
                            <span>‚úèÔ∏è <strong>Editing:</strong> <span id="editing-question-name"></span></span>
                            <button onclick="cancelEditing()" style="background: #856404; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Cancel Edit</button>
                        </div>
                        <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.9rem; color: #2e7d32;">
                            <strong>üìù How to create a question:</strong>
                            <ol style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
                                <li>Fill in the <strong>Title</strong> and select <strong>Category/Topic</strong></li>
                                <li>Add <strong>Text blocks</strong> for question content and <strong>Answer blocks</strong> for fill-in-the-blank sections</li>
                                <li>Click <strong>"Preview & Select Blanks"</strong> to see your question and click words to turn them into blanks</li>
                                <li>Click <strong>"Save Question"</strong> when done</li>
                            </ol>
                            <p style="margin-top: 0.5rem; font-size: 0.85rem;"><em>üí° Tip: In Answer blocks, wrap words in [brackets] to automatically make them blanks (e.g., "The answer is [correct]")</em></p>
                        </div>
                        <div id="admin-editor" class="answer-box"
                            style="background: #fff; border: 1px solid var(--border-color);">
                            <div id="admin-basic-meta"
                                style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-top-left-radius: 8px; border-top-right-radius: 8px;">
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="flex: 1;">
                                        <label for="admin-category"
                                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Category:</label>
                                        <select id="admin-category" class="auth-input"
                                            style="width: 100%; height: 50px; cursor: pointer;"
                                            onchange="handleCategoryChange(this.value)">
                                            <option value="cer">CER (Open Ended)</option>
                                            <option value="definition">Definition</option>
                                            <option value="single-relationship">Single Relationship</option>
                                            <option value="double-relationship">Double Relationship</option>
                                            <option value="mcq">Multiple Choice (MCQ)</option>
                                            <option value="fairness">Fairness</option>
                                            <option value="reliability">Reliability</option>
                                            <option value="accuracy">Accuracy</option>
                                            <option value="constant-variable">Constant Variable</option>
                                            <option value="explanation">Explanation</option>
                                            <option value="control-setup">Control Set-up</option>
                                        </select>
                                    </div>
                                    <div id="admin-level-container" class="hidden" style="flex: 1;">
                                        <label for="admin-level"
                                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Level:</label>
                                        <select id="admin-level" class="auth-input"
                                            style="width: 100%; height: 50px; cursor: pointer;"
                                            onchange="updateAdminTopicsByLevel(this.value)">
                                            <option value="P3">Primary 3</option>
                                            <option value="P4">Primary 4</option>
                                            <option value="P5">Primary 5</option>
                                            <option value="P6">Primary 6</option>
                                        </select>
                                    </div>
                                </div>
                                <label for="admin-title"
                                    style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Question
                                    Title:</label>
                                <input type="text" id="admin-title" class="auth-input"
                                    style="width: 100%; height: 50px; margin-bottom: 1rem;"
                                    placeholder="e.g., Bird Life Cycle">
                                <label for="admin-topic"
                                    style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Topic:</label>
                                <select id="admin-topic" class="auth-input"
                                    style="width: 100%; height: 50px; cursor: pointer; margin-bottom: 0.5rem;"
                                    onchange="handleTopicChange(this.value)">
                                    <option value="heat">Heat</option>
                                    <option value="light">Light</option>
                                    <option value="materials">Materials</option>
                                    <option value="air">Air</option>
                                    <option value="water">Water</option>
                                    <option value="new-topic">-- Add Custom Topic --</option>
                                </select>
                                <input type="text" id="admin-new-topic" class="auth-input hidden"
                                    style="width: 100%; height: 50px;" placeholder="Enter new topic name...">
                                <!-- MCQ Options (Hidden by default) -->
                                <div id="mcq-options-container" class="hidden"
                                    style="margin-top: 1rem; padding: 1rem; background: #eee; border-radius: 8px;">
                                    <p style="font-weight: 600; margin-bottom: 0.5rem;">Enter Options:</p>
                                    <input type="text" id="mcq-opt-1" class="auth-input" placeholder="Option 1"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <input type="text" id="mcq-opt-2" class="auth-input" placeholder="Option 2"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <input type="text" id="mcq-opt-3" class="auth-input" placeholder="Option 3"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <input type="text" id="mcq-opt-4" class="auth-input" placeholder="Option 4"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <p style="font-weight: 600; margin-top: 0.5rem;">Correct Answer:</p>
                                    <select id="mcq-correct" class="auth-input" style="height: 40px;">
                                        <option value="1">Option 1</option>
                                        <option value="2">Option 2</option>
                                        <option value="3">Option 3</option>
                                        <option value="4">Option 4</option>
                                    </select>
                                </div>
                            </div>
                            <div id="admin-blocks"></div>
                            <div
                                style="display: flex; gap: 0.8rem; margin-top: 2rem; border-top: 2px dashed #eee; padding-top: 1.5rem; flex-wrap: wrap; justify-content: center;">
                                <button class="btn" onclick="addAdminBlock('text')"
                                    style="background: #e7f5ff; color: #007bff; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+ Add Text</button>
                                <button class="btn" onclick="addAdminBlock('answer')"
                                    style="background: #fff9c4; color: #f9a825; border: 1px solid #fbc02d; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+
                                    Add Answer</button>
                                <button class="btn" onclick="addAdminBlock('explanation')"
                                    style="background: #f0f4ff; color: #007bff; border: 1px solid #007bff; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+
                                    Add Explanation</button>
                                <button class="btn" onclick="addAdminBlock('video')"
                                    style="background: #fff5f5; color: #dc3545; border: 1px solid #dc3545; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+
                                    Add Video URL</button>
                                <button class="btn" onclick="addAdminBlock('image')"
                                    style="background: #fdfdfd; border: 1px solid #ddd; color: #555; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+ Add
                                    Image URL</button>
                                <button class="btn" onclick="event.stopPropagation(); showTableGridSelector(this)" id="add-table-btn"
                                    style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 1px solid #81c784; color: #2e7d32; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+ Add
                                    Table</button>
                            </div>
                            <div id="admin-actions" class="controls"
                                style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #eee;">
                                <button id="admin-clear-btn" class="btn" onclick="clearAdminForm()"
                                    style="background: #dc3545; color: white;">üóëÔ∏è Clear All</button>
                                <button id="admin-process-btn" class="btn" onclick="processAdminQuestion()"
                                    style="background: #28a745; color: white;">üëÅÔ∏è Preview & Select Blanks</button>
                                <button id="save-question-btn" class="btn" onclick="saveAdminQuestion()"
                                    style="background: var(--primary-blue); color: white;">üíæ Save Question</button>
                            </div>
                        </div>
                        <div id="admin-preview-section" class="hidden" style="margin-top: 4rem;">
                            <h3 style="margin-bottom: 1.5rem;">Interactive Preview</h3>
                            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">Click the words you want
                                to turn into blanks. Yellow words will become questions.</p>
                            <div id="admin-preview-content" class="answer-template"
                                style="background: var(--blue-light); padding: 2rem; border-radius: 12px;"></div>
                        </div>
                    </main>
                </div>

                <!-- WORKSHEET VIEW -->
                <div id="view-worksheet" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div class="worksheet-actions"
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0;">üìù My Worksheet</h2>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" style="background: #28a745; color: white;"
                                    onclick="exportWorksheet()">üñ®Ô∏è Export PDF</button>
                                <button class="btn" style="background: #dc3545; color: white;"
                                    onclick="clearWorksheet()">üóëÔ∏è Clear All</button>
                            </div>
                        </div>

                        <div id="worksheet-header"
                            style="display: none; border-bottom: 2px solid #000; padding-bottom: 1rem; margin-bottom: 2rem;">
                            <div
                                style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem;">
                                <span>Name: __________________________</span>
                                <span>Score: ________ / ________</span>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">Date: ________________</div>
                        </div>

                        <div id="worksheet-questions-container">
                            <div class="placeholder-content" id="worksheet-empty-msg">
                                <p style="font-size: 1.2rem; color: #666;">No questions added to your worksheet yet.</p>
                                <p style="font-size: 0.95rem; margin-top: 10px; color: #888;">Browse questions and click
                                    the <strong style="color: #2ed573;">‚ûï Worksheet</strong> button to add them here.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // =====================================================
        // FORCE FRESH CONTENT - AGGRESSIVE CACHE BUSTING
        // =====================================================
        (function() {
            'use strict';
            
            // Generate unique version based on current timestamp
            const currentTimestamp = Date.now();
            const storedTimestamp = sessionStorage.getItem('page_load_time');
            
            // Display version for debugging (can be removed in production)
            const versionDisplay = document.getElementById('version-display');
            if (versionDisplay) {
                versionDisplay.textContent = 'v' + currentTimestamp;
            }
            
            // Method 1: Force reload if this is a new browser session
            if (!storedTimestamp) {
                sessionStorage.setItem('page_load_time', currentTimestamp);
                
                // Check if URL already has cache buster
                const urlParams = new URLSearchParams(window.location.search);
                if (!urlParams.has('_cb')) {
                    // Add cache buster to URL and reload
                    const newUrl = window.location.pathname + '?_cb=' + currentTimestamp + window.location.hash;
                    window.location.replace(newUrl);
                    return; // Stop execution
                }
            }
            
            // Method 2: Fetch the page with no-cache headers to check for updates
            fetch(window.location.pathname, {
                method: 'HEAD',
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            }).then(response => {
                const serverLastModified = response.headers.get('Last-Modified');
                const serverETag = response.headers.get('ETag');
                const serverVersion = serverLastModified || serverETag || '';
                
                const cachedVersion = localStorage.getItem('server_file_version');
                
                if (cachedVersion && serverVersion && cachedVersion !== serverVersion) {
                    // Server file has changed - force hard reload
                    console.log('New version detected! Reloading...');
                    localStorage.setItem('server_file_version', serverVersion);
                    
                    // Clear all caches
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                        });
                    }
                    
                    // Force reload bypassing cache
                    window.location.href = window.location.pathname + '?_cb=' + Date.now();
                } else if (!cachedVersion && serverVersion) {
                    localStorage.setItem('server_file_version', serverVersion);
                }
            }).catch(err => {
                console.log('Version check failed:', err);
            });
            
            // Method 3: Clear service worker caches if present
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => {
                        registration.unregister();
                    });
                });
            }
        })();

        // =====================================================
        // GLOBAL STATE & UTILITIES
        // =====================================================
        window.adminBlocks = [];
        window.isAdminUser = false;
        window.worksheetItems = [];
        window.currentActiveTab = 'cer';
        window.currentMode = 'oeq';
        window.currentMcqLevel = 'P3';
        window.currentMcqTopic = '';
        window.editingQuestionId = null;

        window.mcqCurriculum = {
            'P3': ['Living and non-living things', 'Materials', 'Life Cycles', 'Magnets'],
            'P4': ['Plant Systems', 'Human Body Systems', 'Matter and its 3 States', 'Light', 'Heat'],
            'P5': ['Water and its 3 States', 'Plant Reproduction', 'Human and Plant Reproduction', 'Human and Plant Transport', 'Electrical Systems'],
            'P6': ['Forces', 'Energy in Food', 'Energy Conversion', 'Living Together', 'Food Chains and Webs', 'Humans and the Environment']
        };

        window.typeColors = {
            'cer': '#AEC6CF',
            'definition': '#ADD8E6',
            'single-relationship': '#FFB7B2',
            'double-relationship': '#FFDAC1',
            'fairness': '#E2F0CB',
            'reliability': '#C7CEEA',
            'accuracy': '#FDFD96',
            'constant-variable': '#B5EAD7',
            'explanation': '#FF9AA2',
            'control-setup': '#E0BBE4',
            'admin': '#ffd1dc',
            'worksheet': '#e3f2fd',
            // MCQ level colors
            'mcq-P3': '#FFB3BA',
            'mcq-P4': '#BAFFC9',
            'mcq-P5': '#BAE1FF',
            'mcq-P6': '#FFFFBA'
        };

        // =====================================================
        // WORKSHEET FUNCTIONALITY - FIXED
        // =====================================================

        // Load worksheet from localStorage on page load
        function loadWorksheetFromStorage() {
            try {
                const stored = localStorage.getItem('worksheetItems');
                if (stored) {
                    window.worksheetItems = JSON.parse(stored);
                } else {
                    window.worksheetItems = [];
                }
            } catch (e) {
                console.error('Error loading worksheet:', e);
                window.worksheetItems = [];
            }
        }

        // Save worksheet to localStorage
        function saveWorksheetToStorage() {
            try {
                localStorage.setItem('worksheetItems', JSON.stringify(window.worksheetItems));
            } catch (e) {
                console.error('Error saving worksheet:', e);
            }
        }

        // Toggle question in/out of worksheet
        window.toggleWorksheetItem = function (btn) {
            const container = btn.closest('.question-container');
            if (!container) {
                alert("Could not find question container.");
                return;
            }

            // Get or create a unique ID for this question
            let qId = container.id;
            if (!qId) {
                qId = 'q-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                container.id = qId;
            }

            const existingIndex = window.worksheetItems.findIndex(item => item.id === qId);

            if (existingIndex > -1) {
                // Remove from worksheet
                window.worksheetItems.splice(existingIndex, 1);
                btn.innerHTML = '‚ûï Worksheet';
                btn.classList.remove('added');
            } else {
                // Add to worksheet - capture the full question content
                const questionTitle = container.querySelector('h3')?.textContent || 'Question';

                // Clone the container to capture its content
                const clone = container.cloneNode(true);

                // Remove UI elements from the clone
                clone.querySelectorAll('.admin-controls, .worksheet-control-bar, .controls, .feedback-icon').forEach(el => el.remove());

                // Reset any input states in the clone
                clone.querySelectorAll('.answer-input').forEach(input => {
                    input.disabled = false;
                    input.value = '';
                    input.style.borderBottomColor = '';
                });

                // Get the cleaned HTML
                const cleanedHtml = clone.innerHTML;

                window.worksheetItems.push({
                    id: qId,
                    title: questionTitle,
                    html: cleanedHtml,
                    addedAt: new Date().toISOString()
                });

                btn.innerHTML = '‚úÖ Added';
                btn.classList.add('added');
            }

            saveWorksheetToStorage();
            updateWorksheetUI();
        };

        // Update worksheet display
        window.updateWorksheetUI = function () {
            const countBadge = document.getElementById('worksheet-count');
            const container = document.getElementById('worksheet-questions-container');
            const emptyMsg = document.getElementById('worksheet-empty-msg');

            if (!container) return;

            const count = window.worksheetItems.length;

            // Update badge count
            if (countBadge) {
                countBadge.textContent = count;
            }

            // Clear existing question cards (keep empty message)
            const existingCards = container.querySelectorAll('.worksheet-question-card');
            existingCards.forEach(card => card.remove());

            if (count === 0) {
                if (emptyMsg) emptyMsg.style.display = 'block';
            } else {
                if (emptyMsg) emptyMsg.style.display = 'none';

                // Render each worksheet item
                window.worksheetItems.forEach((item, idx) => {
                    const card = document.createElement('div');
                    card.className = 'worksheet-question-card';
                    card.setAttribute('data-worksheet-id', item.id);

                    card.innerHTML = `
                        <span class="question-number">Question ${idx + 1}</span>
                        <div class="remove-btn-wrapper">
                            <button class="btn-worksheet-remove" onclick="removeFromWorksheet('${item.id}')">‚úï Remove</button>
                        </div>
                        <div class="worksheet-question-content" style="margin-top: 1rem;">
                            ${item.html}
                        </div>
                    `;

                    container.appendChild(card);
                });
            }

            // Update all add/remove buttons in main content
            syncWorksheetButtons();
        };

        // Sync worksheet buttons with current state
        function syncWorksheetButtons() {
            document.querySelectorAll('.question-container').forEach(container => {
                const qId = container.id;
                const btn = container.querySelector('.btn-worksheet-add');
                if (btn && qId) {
                    const isInWorksheet = window.worksheetItems.some(item => item.id === qId);
                    if (isInWorksheet) {
                        btn.innerHTML = '‚úÖ Added';
                        btn.classList.add('added');
                    } else {
                        btn.innerHTML = '‚ûï Worksheet';
                        btn.classList.remove('added');
                    }
                }
            });
        }

        // Remove question from worksheet
        window.removeFromWorksheet = function (qId) {
            window.worksheetItems = window.worksheetItems.filter(item => item.id !== qId);
            saveWorksheetToStorage();
            updateWorksheetUI();
        };

        // Clear all worksheet items
        window.clearWorksheet = function () {
            if (!confirm("Are you sure you want to clear all questions from your worksheet?")) return;
            window.worksheetItems = [];
            saveWorksheetToStorage();
            updateWorksheetUI();
        };

        // Export worksheet as PDF
        window.exportWorksheet = function () {
            if (window.worksheetItems.length === 0) {
                alert("Your worksheet is empty! Add some questions first.");
                return;
            }

            // Add print class to body
            document.body.classList.add('print-worksheet');

            // Show worksheet header
            const header = document.getElementById('worksheet-header');
            if (header) header.style.display = 'block';

            // Trigger print
            window.print();

            // Clean up after print
            setTimeout(() => {
                document.body.classList.remove('print-worksheet');
                if (header) header.style.display = 'none';
            }, 100);
        };

        // =====================================================
        // TAB & VIEW SWITCHING
        // =====================================================

        window.switchTab = function (type, btn) {
            window.currentActiveTab = type;

            // Update button states
            const allBtns = document.querySelectorAll('.tab-btn, #btn-sidebar-admin, #btn-sidebar-worksheet');
            allBtns.forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            // Hide all views
            const mainContentArea = document.getElementById('main-content-area');
            mainContentArea.querySelectorAll('.view-content').forEach(el => {
                el.classList.add('hidden');
            });

            // Show target view
            const target = document.getElementById(`view-${type}`);
            if (target) {
                target.classList.remove('hidden');
            }

            // Handle specific view logic
            if (type === 'cer') {
                const heatBtn = document.getElementById('btn-heat');
                if (heatBtn) heatBtn.click();
            }

            // Update border color and header line color
            const appBody = document.querySelector('.app-body');
            const headerLine = document.getElementById('header-color-line');
            if (window.typeColors[type]) {
                const color = window.typeColors[type];
                if (appBody) {
                    appBody.style.borderTopColor = color;
                }
                if (headerLine) {
                    // Create a gradient effect for the line
                    const lighterColor = adjustColorBrightness(color, 20);
                    headerLine.style.background = `linear-gradient(90deg, ${color} 0%, ${lighterColor} 50%, ${color} 100%)`;
                }
            }

            // Refresh worksheet UI when switching to worksheet tab
            if (type === 'worksheet') {
                updateWorksheetUI();
            }
        };
        
        // Helper function to adjust color brightness
        function adjustColorBrightness(hex, percent) {
            // Remove # if present
            hex = hex.replace('#', '');
            
            // Parse the hex color
            let r = parseInt(hex.substring(0, 2), 16);
            let g = parseInt(hex.substring(2, 4), 16);
            let b = parseInt(hex.substring(4, 6), 16);
            
            // Adjust brightness
            r = Math.min(255, Math.floor(r + (255 - r) * (percent / 100)));
            g = Math.min(255, Math.floor(g + (255 - g) * (percent / 100)));
            b = Math.min(255, Math.floor(b + (255 - b) * (percent / 100)));
            
            // Convert back to hex
            return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        // =====================================================
        // MODE SWITCHING (OEQ/MCQ)
        // =====================================================

        window.switchMode = function (mode) {
            window.currentMode = mode;
            const oeqSidebar = document.getElementById('oeq-sidebar-content');
            const mcqSidebar = document.getElementById('mcq-sidebar-content');
            const container = document.getElementById('header-tabs-container');

            document.getElementById('mode-oeq').classList.remove('active');
            document.getElementById('mode-mcq').classList.remove('active');
            document.getElementById('mode-' + mode).classList.add('active');

            if (mode === 'mcq') {
                oeqSidebar.classList.add('hidden');
                mcqSidebar.classList.remove('hidden');
                document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                renderMcqHeaders();
            } else {
                oeqSidebar.classList.remove('hidden');
                mcqSidebar.classList.add('hidden');
                container.innerHTML = `<button class="tab-btn active" data-type="cer" onclick="switchTab('cer', this)">CER</button><button class="tab-btn" data-type="definition" onclick="switchTab('definition', this)">Definition</button><button class="tab-btn" data-type="single-relationship" onclick="switchTab('single-relationship', this)">Single Relationship</button><button class="tab-btn" data-type="double-relationship" onclick="switchTab('double-relationship', this)">Double Relationship</button><button class="tab-btn" data-type="fairness" onclick="switchTab('fairness', this)">Fairness</button><button class="tab-btn" data-type="reliability" onclick="switchTab('reliability', this)">Reliability</button><button class="tab-btn" data-type="accuracy" onclick="switchTab('accuracy', this)">Accuracy</button><button class="tab-btn" data-type="constant-variable" onclick="switchTab('constant-variable', this)">Constant Variable</button><button class="tab-btn" data-type="explanation" onclick="switchTab('explanation', this)">Explanation</button><button class="tab-btn" data-type="control-setup" onclick="switchTab('control-setup', this)">Control Set-up</button>`;
                switchTab('cer', document.querySelector('.tab-btn[data-type="cer"]'));
                if (window.isAdminUser) document.getElementById('btn-sidebar-admin').classList.remove('hidden');
            }
        };

        // =====================================================
        // MCQ FUNCTIONALITY
        // =====================================================

        window.renderMcqHeaders = function () {
            const container = document.getElementById('header-tabs-container');
            const topics = window.mcqCurriculum[window.currentMcqLevel] || [];
            const pastelColors = ['#AEC6CF', '#FFB7B2', '#FFDAC1', '#E2F0CB', '#C7CEEA', '#FDFD96', '#B5EAD7', '#FF9AA2', '#E0BBE4', '#ADD8E6'];

            container.innerHTML = topics.map((t, i) => {
                const topicId = t.toLowerCase().replace(/\s+/g, '-');
                const activeClass = i === 0 ? 'active' : '';
                const color = pastelColors[i % pastelColors.length];
                if (i === 0) window.currentMcqTopic = topicId;
                return `<button class="tab-btn ${activeClass}" onclick="switchMcqTopicAndTab('${topicId}', this)" style="background-color: ${color};">${t}</button>`;
            }).join('');

            // Set initial header line color to first topic's color
            const headerLine = document.getElementById('header-color-line');
            if (headerLine && topics.length > 0) {
                const firstColor = pastelColors[0];
                const lighterColor = adjustColorBrightness(firstColor, 20);
                headerLine.style.background = `linear-gradient(90deg, ${firstColor} 0%, ${lighterColor} 50%, ${firstColor} 100%)`;
            }

            renderMcqQuestionList();
        };

        window.switchMcqTopicAndTab = function (topicId, btn) {
            document.querySelectorAll('#header-tabs-container .tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            window.currentMcqTopic = topicId;
            
            // Update header line color based on the button's background color
            const headerLine = document.getElementById('header-color-line');
            if (headerLine && btn) {
                const btnColor = btn.style.backgroundColor || '#AEC6CF';
                // Convert rgb to hex if needed
                let hexColor = btnColor;
                if (btnColor.startsWith('rgb')) {
                    const rgb = btnColor.match(/\d+/g);
                    if (rgb) {
                        hexColor = '#' + ((1 << 24) + (parseInt(rgb[0]) << 16) + (parseInt(rgb[1]) << 8) + parseInt(rgb[2])).toString(16).slice(1);
                    }
                }
                const lighterColor = adjustColorBrightness(hexColor, 20);
                headerLine.style.background = `linear-gradient(90deg, ${hexColor} 0%, ${lighterColor} 50%, ${hexColor} 100%)`;
            }
            
            renderMcqQuestionList();
        };

        window.renderMcqQuestionList = function () {
            const nav = document.getElementById('mcq-question-nav');
            if (!nav) return;

            const topicId = `topic-mcq-${window.currentMcqTopic}`;
            const container = document.getElementById(topicId);
            const questions = container ? container.querySelectorAll('.question-container') : [];

            nav.innerHTML = Array.from(questions).map((q, i) => {
                const qId = q.id;
                return `<button onclick="scrollToMcqQuestion('${qId}', this)">Question ${i + 1}</button>`;
            }).join('');

            document.querySelectorAll('.topic-content').forEach(t => t.classList.add('hidden'));
            if (container) container.classList.remove('hidden');
        };

        window.scrollToMcqQuestion = function (qId, btn) {
            document.querySelectorAll('#mcq-question-nav button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const q = document.getElementById(qId);
            if (q) q.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        window.checkMcq = function (containerId) {
            const container = document.getElementById(containerId);
            const selected = container.querySelector('input[type="radio"]:checked');
            if (!selected) return alert("Please select an option!");

            const allOptions = container.querySelectorAll('.mcq-option');
            allOptions.forEach(opt => {
                const radio = opt.querySelector('input');
                if (radio.dataset.correct === 'true') {
                    opt.style.borderColor = 'var(--correct-color)';
                    opt.style.background = '#e8f5e9';
                } else if (radio.checked) {
                    opt.style.borderColor = 'var(--incorrect-color)';
                    opt.style.background = '#ffebee';
                }
                radio.disabled = true;
            });
            container.querySelector('.submit-btn').disabled = true;
            
            // Show explanation if it exists
            const explanationBox = container.querySelector('.explanation-box');
            if (explanationBox) {
                explanationBox.style.display = 'block';
            }
            
            // Show video if it exists
            const videoContainer = container.querySelector('.video-container');
            if (videoContainer) {
                videoContainer.style.display = 'block';
            }
        };

        // =====================================================
        // ADMIN FUNCTIONALITY
        // =====================================================

        window.handleTopicChange = function (value) {
            const newTopicInput = document.getElementById('admin-new-topic');
            if (value === 'new-topic') {
                newTopicInput.classList.remove('hidden');
            } else {
                newTopicInput.classList.add('hidden');
            }
        };

        window.updateAdminTopicsByLevel = function (level) {
            const topicSelect = document.getElementById('admin-topic');
            const topics = window.mcqCurriculum[level] || [];
            let html = topics.map(t => `<option value="${t.toLowerCase().replace(/\s+/g, '-')}">${t}</option>`).join('');
            html += `<option value="new-topic">-- Add Custom Topic --</option>`;
            topicSelect.innerHTML = html;
        };

        window.handleCategoryChange = function (value) {
            const mcqOptions = document.getElementById('mcq-options-container');
            const levelContainer = document.getElementById('admin-level-container');
            const previewInstructions = document.querySelector('#admin-preview-section p');
            const processBtn = document.getElementById('admin-process-btn');

            if (value === 'mcq') {
                mcqOptions.classList.remove('hidden');
                levelContainer.classList.remove('hidden');
                if (processBtn) processBtn.classList.add('hidden');
                updateAdminTopicsByLevel(document.getElementById('admin-level').value);
                if (previewInstructions) previewInstructions.classList.add('hidden');
            } else {
                mcqOptions.classList.add('hidden');
                levelContainer.classList.add('hidden');
                if (processBtn) processBtn.classList.remove('hidden');
                const topicSelect = document.getElementById('admin-topic');
                topicSelect.innerHTML = `
                    <option value="heat">Heat</option>
                    <option value="light">Light</option>
                    <option value="materials">Materials</option>
                    <option value="air">Air</option>
                    <option value="water">Water</option>
                    <option value="new-topic">-- Add Custom Topic --</option>
                `;
                if (previewInstructions) previewInstructions.classList.remove('hidden');
            }
        };

        function addAdminBlock(type) {
            const id = Date.now();
            const block = { id, type, value: '' };
            
            // Video and explanation should always be at the end
            if (type === 'video' || type === 'explanation') {
                window.adminBlocks.push(block);
            } else {
                // Insert before any video/explanation blocks
                const lastContentIndex = window.adminBlocks.findIndex(b => b.type === 'video' || b.type === 'explanation');
                if (lastContentIndex === -1) {
                    window.adminBlocks.push(block);
                } else {
                    window.adminBlocks.splice(lastContentIndex, 0, block);
                }
            }
            renderAdminBlocks();
        }

        function renderAdminBlocks() {
            const container = document.getElementById('admin-blocks');
            if (!container) return;
            
            let html = '';
            let addedSeparator = false;
            
            window.adminBlocks.forEach((block, index) => {
                // Add separator before first video/explanation block
                if (!addedSeparator && (block.type === 'video' || block.type === 'explanation')) {
                    html += `<div style="margin: 1.5rem 0; padding: 0.8rem; background: linear-gradient(90deg, #e3f2fd 0%, #f5f5f5 50%, #e3f2fd 100%); border-radius: 8px; text-align: center;">
                        <span style="color: #666; font-size: 0.85rem; font-weight: 500;">üìå Shown after students answer (drag blocks above to reorder)</span>
                    </div>`;
                    addedSeparator = true;
                }
                
                // Handle table blocks specially
                if (block.type === 'table') {
                    html += renderTableBlock(block);
                    return;
                }
                
                let inputHtml = '';
                if (block.type === 'text' || block.type === 'answer' || block.type === 'explanation') {
                    const placeholders = {
                        'answer': 'Enter text to be blanked... Use [brackets] around words to make them blanks.',
                        'explanation': 'Enter step-by-step explanation...',
                        'text': 'Enter question text...'
                    };
                    inputHtml = `<textarea class="auth-input" style="height: 100px; margin-top: 10px;" oninput="updateBlockValue(${block.id}, this.value)" placeholder="${placeholders[block.type]}">${block.value}</textarea>`;
                } else if (block.type === 'image') {
                    const previewUrl = convertDropboxUrl(block.value);
                    inputHtml = `
                        <input type="text" class="auth-input" style="margin-top: 10px;" oninput="updateBlockValue(${block.id}, this.value); updateImagePreview(${block.id})" value="${block.value}" placeholder="Enter image URL (Dropbox, Imgur, etc.)...">
                        <div id="img-preview-${block.id}" style="margin-top: 10px; text-align: center;">
                            ${block.value ? `<img src="${previewUrl}" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #ddd;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><span style="display: none; color: #dc3545; font-size: 0.85rem;">‚ö†Ô∏è Image failed to load</span>` : '<span style="color: #888; font-size: 0.85rem;">Image preview will appear here</span>'}
                        </div>
                    `;
                } else if (block.type === 'video') {
                    inputHtml = `<input type="text" class="auth-input" style="margin-top: 10px;" oninput="updateBlockValue(${block.id}, this.value)" value="${block.value}" placeholder="Enter Video URL (Dropbox or YouTube)...">`;
                }

                const typeColors = {
                    'answer': 'background: #fffdf0; border-color: #fbc02d;',
                    'explanation': 'background: #f0f4ff; border-color: #007bff;',
                    'video': 'background: #fdf2f2; border-color: #dc3545;',
                    'image': 'background: #f5f5f5; border-color: #9e9e9e;',
                    'text': ''
                };
                
                const typeLabels = {
                    'text': 'üìù TEXT BLOCK',
                    'answer': '‚úèÔ∏è ANSWER BLOCK (fill-in-blank)',
                    'explanation': 'üí° EXPLANATION (shown after answer)',
                    'video': 'üé¨ VIDEO (shown after answer, optional)',
                    'image': 'üñºÔ∏è IMAGE BLOCK'
                };
                
                // Only text, image, answer, and table blocks are draggable
                // Video and explanation are fixed at the end
                const isDraggable = ['text', 'image', 'answer', 'table'].includes(block.type);
                const dragAttrs = isDraggable ? `draggable="true" 
                             ondragstart="handleDragStart(event, ${block.id})" 
                             ondragend="handleDragEnd(event)"
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)"
                             ondrop="handleDrop(event, ${block.id})"` : '';
                const dragHandle = isDraggable ? `<span class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>` : '';
                const leftPadding = isDraggable ? '40px' : '1rem';

                html += `
                        <div class="admin-block ${isDraggable ? '' : 'no-drag'}" data-block-id="${block.id}" ${dragAttrs}
                             style="margin-bottom: 1rem; position: relative; padding: 1rem 1rem 1rem ${leftPadding}; border: 1px solid #eee; border-radius: 8px; ${typeColors[block.type] || ''}">
                            ${dragHandle}
                            <span style="font-size: 0.8rem; color: #666; font-weight: 600;">${typeLabels[block.type] || block.type.toUpperCase()}</span>
                            <button onclick="removeAdminBlock(${block.id})" style="position: absolute; right: 10px; top: 10px; border: none; background: none; cursor: pointer; color: #dc3545; font-size: 1.2rem;">‚úï</button>
                            ${inputHtml}
                        </div>
                    `;
            });
            
            container.innerHTML = html;
            
            // Re-attach any event listeners if needed
            initDragAndDrop();
        }
        
        // ==================== DRAG AND DROP FUNCTIONS ====================
        
        window.draggedBlockId = null;
        
        window.initDragAndDrop = function() {
            // Initialize is called after render, nothing special needed here
            // All handlers are inline in the HTML
        };
        
        window.handleDragStart = function(event, blockId) {
            window.draggedBlockId = blockId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', blockId);
        };
        
        window.handleDragEnd = function(event) {
            event.target.classList.remove('dragging');
            // Remove drag-over class from all blocks
            document.querySelectorAll('.admin-block').forEach(block => {
                block.classList.remove('drag-over');
            });
            window.draggedBlockId = null;
        };
        
        window.handleDragOver = function(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const block = event.target.closest('.admin-block');
            if (block && !block.classList.contains('dragging')) {
                // Remove drag-over from other blocks
                document.querySelectorAll('.admin-block').forEach(b => {
                    if (b !== block) b.classList.remove('drag-over');
                });
                block.classList.add('drag-over');
            }
        };
        
        window.handleDragLeave = function(event) {
            const block = event.target.closest('.admin-block');
            if (block) {
                block.classList.remove('drag-over');
            }
        };
        
        window.handleDrop = function(event, targetBlockId) {
            event.preventDefault();
            const block = event.target.closest('.admin-block');
            if (block) {
                block.classList.remove('drag-over');
            }
            
            if (window.draggedBlockId === null || window.draggedBlockId === targetBlockId) return;
            
            // Find the blocks
            const draggedBlock = window.adminBlocks.find(b => b.id === window.draggedBlockId);
            const targetBlock = window.adminBlocks.find(b => b.id === targetBlockId);
            
            // Don't allow dragging video/explanation blocks
            if (draggedBlock && (draggedBlock.type === 'video' || draggedBlock.type === 'explanation')) {
                window.draggedBlockId = null;
                return;
            }
            
            // Don't allow dropping onto video/explanation blocks
            if (targetBlock && (targetBlock.type === 'video' || targetBlock.type === 'explanation')) {
                window.draggedBlockId = null;
                return;
            }
            
            // Find indices
            const fromIndex = window.adminBlocks.findIndex(b => b.id === window.draggedBlockId);
            const toIndex = window.adminBlocks.findIndex(b => b.id === targetBlockId);
            
            if (fromIndex === -1 || toIndex === -1) return;
            
            // Reorder the array
            const [movedBlock] = window.adminBlocks.splice(fromIndex, 1);
            window.adminBlocks.splice(toIndex, 0, movedBlock);
            
            // Re-render
            renderAdminBlocks();
            
            window.draggedBlockId = null;
        };
        
        // ==================== END DRAG AND DROP ====================
        
        // Update image preview when URL changes
        window.updateImagePreview = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            const previewDiv = document.getElementById(`img-preview-${blockId}`);
            if (block && previewDiv) {
                const previewUrl = convertDropboxUrl(block.value);
                if (block.value) {
                    previewDiv.innerHTML = `<img src="${previewUrl}" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #ddd;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><span style="display: none; color: #dc3545; font-size: 0.85rem;">‚ö†Ô∏è Image failed to load</span>`;
                } else {
                    previewDiv.innerHTML = '<span style="color: #888; font-size: 0.85rem;">Image preview will appear here</span>';
                }
            }
        };

        // ==================== TABLE EDITOR FUNCTIONS ====================
        
        // Pastel colors for table
        const pastelColors = [
            '#FFFFFF', '#F5F5F5', '#E8E8E8',  // Whites/Grays
            '#FFB3BA', '#FFDFBA', '#FFFFBA',  // Light Pink, Peach, Yellow
            '#BAFFC9', '#BAE1FF', '#E0BBE4',  // Mint, Sky Blue, Lavender
            '#FFC6D9', '#C9FFE5', '#D4F0F0',  // Rose, Seafoam, Aqua
            '#FCE4EC', '#E8F5E9', '#E3F2FD',  // Pale Pink, Pale Green, Pale Blue
            '#FFF8E1', '#F3E5F5', '#ECEFF1'   // Cream, Pale Purple, Blue Gray
        ];

        // Initialize table grid selector
        window.initTableGridSelector = function() {
            const grid = document.getElementById('table-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'table-grid-cell';
                    cell.dataset.row = row + 1;
                    cell.dataset.col = col + 1;
                    cell.addEventListener('mouseenter', handleGridHover);
                    cell.addEventListener('click', handleGridClick);
                    grid.appendChild(cell);
                }
            }
        };

        function handleGridHover(e) {
            const targetRow = parseInt(e.target.dataset.row);
            const targetCol = parseInt(e.target.dataset.col);
            const cells = document.querySelectorAll('.table-grid-cell');
            
            cells.forEach(cell => {
                const cellRow = parseInt(cell.dataset.row);
                const cellCol = parseInt(cell.dataset.col);
                if (cellRow <= targetRow && cellCol <= targetCol) {
                    cell.classList.add('selected');
                } else {
                    cell.classList.remove('selected');
                }
            });
            
            document.getElementById('grid-size-label').innerHTML = `<strong>${targetCol} √ó ${targetRow}</strong> table`;
        }

        function handleGridClick(e) {
            const rows = parseInt(e.target.dataset.row);
            const cols = parseInt(e.target.dataset.col);
            createTableBlock(rows, cols);
            hideTableGridSelector();
        }

        window.showTableGridSelector = function(btn) {
            const selector = document.getElementById('table-grid-selector');
            if (!selector) {
                console.error('Table grid selector not found');
                return;
            }
            
            // Toggle - if already visible, hide it
            if (selector.classList.contains('visible')) {
                hideTableGridSelector();
                return;
            }
            
            // Initialize grid if needed
            if (!document.querySelector('.table-grid-cell')) {
                initTableGridSelector();
            }
            
            // Position the selector ABOVE the button
            const rect = btn.getBoundingClientRect();
            const selectorHeight = 320; // approximate height of the selector
            
            // Position above the button, centered horizontally on the button
            let top = rect.top - selectorHeight - 10;
            let left = rect.left + (rect.width / 2) - 140; // center it (selector is ~280px wide)
            
            // Make sure it doesn't go off the left edge
            if (left < 10) {
                left = 10;
            }
            
            // Make sure it doesn't go off the right edge
            if (left + 280 > window.innerWidth) {
                left = window.innerWidth - 290;
            }
            
            // If not enough space above, show below instead
            if (top < 10) {
                top = rect.bottom + 10;
            }
            
            selector.style.top = top + 'px';
            selector.style.left = left + 'px';
            selector.classList.add('visible');
            
            // Reset grid selection
            document.querySelectorAll('.table-grid-cell').forEach(c => c.classList.remove('selected'));
            document.getElementById('grid-size-label').innerHTML = '<span style="color: #888;">Hover to select</span>';
            
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeGridSelectorOnClickOutside, true);
            }, 100);
        };

        function hideTableGridSelector() {
            const selector = document.getElementById('table-grid-selector');
            if (selector) {
                selector.classList.remove('visible');
            }
            document.removeEventListener('click', closeGridSelectorOnClickOutside, true);
        }

        function closeGridSelectorOnClickOutside(e) {
            const selector = document.getElementById('table-grid-selector');
            const btn = document.getElementById('add-table-btn');
            if (selector && !selector.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
                hideTableGridSelector();
            }
        }

        function createTableBlock(rows, cols) {
            // Create table data structure
            const tableData = {
                rows: rows,
                cols: cols,
                cells: [],
                headerRow: true,
                colWidths: Array(cols).fill('auto')
            };
            
            // Initialize cells with empty content
            for (let r = 0; r < rows; r++) {
                const rowData = [];
                for (let c = 0; c < cols; c++) {
                    rowData.push({
                        content: r === 0 ? `Header ${c + 1}` : '',
                        align: 'left',
                        bgColor: r === 0 ? '#E8E8E8' : '#FFFFFF'
                    });
                }
                tableData.cells.push(rowData);
            }
            
            const blockId = Date.now();
            window.adminBlocks.push({
                id: blockId,
                type: 'table',
                value: tableData
            });
            
            renderAdminBlocks();
            
            // Scroll to the new table
            setTimeout(() => {
                const tableBlock = document.getElementById(`table-block-${blockId}`);
                if (tableBlock) {
                    tableBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        // Render table in admin blocks
        window.renderTableBlock = function(block) {
            const tableData = block.value;
            const blockId = block.id;
            
            let tableHtml = `<table class="admin-table" id="admin-table-${blockId}">`;
            
            for (let r = 0; r < tableData.rows; r++) {
                tableHtml += `<tr data-row="${r}">`;
                for (let c = 0; c < tableData.cols; c++) {
                    const cell = tableData.cells[r][c];
                    const tag = (r === 0 && tableData.headerRow) ? 'th' : 'td';
                    tableHtml += `<${tag} 
                        contenteditable="true" 
                        data-row="${r}" 
                        data-col="${c}" 
                        data-block="${blockId}"
                        style="text-align: ${cell.align}; background-color: ${cell.bgColor};"
                        onfocus="selectTableCell(this)"
                        onblur="updateTableCell(this)"
                        oninput="updateTableCell(this)"
                    >${cell.content}</${tag}>`;
                }
                tableHtml += '</tr>';
            }
            
            tableHtml += '</table>';
            
            return `
                <div class="admin-block" id="table-block-${blockId}" data-block-id="${blockId}" draggable="true"
                     ondragstart="handleDragStart(event, ${blockId})" 
                     ondragend="handleDragEnd(event)"
                     ondragover="handleDragOver(event)" 
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event, ${blockId})"
                     style="margin-bottom: 1rem; position: relative; padding: 1rem 1rem 1rem 40px; border: 1px solid #81c784; border-radius: 8px; background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);">
                    <span class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
                    <span style="font-size: 0.8rem; color: #2e7d32; font-weight: 600;">üìä TABLE BLOCK</span>
                    <button onclick="removeAdminBlock(${blockId})" style="position: absolute; right: 10px; top: 10px; border: none; background: none; cursor: pointer; color: #dc3545; font-size: 1.2rem;">‚úï</button>
                    
                    <div class="admin-table-wrapper" style="margin-top: 10px;">
                        <div class="table-toolbar">
                            <div class="table-toolbar-group">
                                <label>Align:</label>
                                <button onclick="setTableAlignment(${blockId}, 'left')" title="Align Left">‚¨Ö</button>
                                <button onclick="setTableAlignment(${blockId}, 'center')" title="Align Center">‚¨å</button>
                                <button onclick="setTableAlignment(${blockId}, 'right')" title="Align Right">‚û°</button>
                                <button onclick="setTableAlignment(${blockId}, 'justify')" title="Justify">‚ò∞</button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Color:</label>
                                <button onclick="showColorPicker(${blockId}, 'row')" title="Color Row">üé® Row</button>
                                <button onclick="showColorPicker(${blockId}, 'col')" title="Color Column">üé® Col</button>
                                <button onclick="showColorPicker(${blockId}, 'cell')" title="Color Cell">üé® Cell</button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Rows:</label>
                                <button onclick="addTableRow(${blockId})" title="Add Row">+ Row</button>
                                <button onclick="deleteTableRow(${blockId})" class="danger" title="Delete Row">‚àí Row</button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Cols:</label>
                                <button onclick="addTableColumn(${blockId})" title="Add Column">+ Col</button>
                                <button onclick="deleteTableColumn(${blockId})" class="danger" title="Delete Column">‚àí Col</button>
                            </div>
                        </div>
                        <div class="admin-table-container">
                            ${tableHtml}
                        </div>
                    </div>
                    
                    <!-- Color Picker Dropdown -->
                    <div id="color-picker-${blockId}" class="color-picker-dropdown">
                        <h5 id="color-picker-title-${blockId}">Select Color</h5>
                        <div class="color-palette">
                            ${pastelColors.map(color => `
                                <div class="color-swatch" 
                                    style="background-color: ${color};" 
                                    onclick="applyTableColor(${blockId}, '${color}')"
                                    title="${color}">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        };

        // Track selected cell for operations
        window.selectedTableCell = null;
        window.colorPickerMode = null; // 'row', 'col', or 'cell'
        window.colorPickerBlockId = null;

        window.selectTableCell = function(cell) {
            // Remove previous selection
            document.querySelectorAll('.admin-table td.selected-cell, .admin-table th.selected-cell').forEach(c => {
                c.classList.remove('selected-cell');
            });
            
            cell.classList.add('selected-cell');
            window.selectedTableCell = cell;
        };

        window.updateTableCell = function(cell) {
            const blockId = parseInt(cell.dataset.block);
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (block && block.type === 'table') {
                block.value.cells[row][col].content = cell.textContent;
            }
        };

        window.setTableAlignment = function(blockId, alignment) {
            if (!window.selectedTableCell || parseInt(window.selectedTableCell.dataset.block) !== blockId) {
                alert('Please click on a cell first to select it.');
                return;
            }
            
            const cell = window.selectedTableCell;
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            
            cell.style.textAlign = alignment;
            
            // Update the block data
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (block && block.type === 'table') {
                block.value.cells[row][col].align = alignment;
            }
        };

        window.showColorPicker = function(blockId, mode) {
            const picker = document.getElementById(`color-picker-${blockId}`);
            const title = document.getElementById(`color-picker-title-${blockId}`);
            
            if (!window.selectedTableCell || parseInt(window.selectedTableCell.dataset.block) !== blockId) {
                alert('Please click on a cell first to select it.');
                return;
            }
            
            window.colorPickerMode = mode;
            window.colorPickerBlockId = blockId;
            
            const modeLabels = {
                'row': 'Select Row Color',
                'col': 'Select Column Color',
                'cell': 'Select Cell Color'
            };
            title.textContent = modeLabels[mode];
            
            picker.classList.add('visible');
            
            // Position near the selected cell
            const cellRect = window.selectedTableCell.getBoundingClientRect();
            const pickerRect = picker.getBoundingClientRect();
            const parentRect = picker.parentElement.getBoundingClientRect();
            
            picker.style.top = (cellRect.bottom - parentRect.top + 10) + 'px';
            picker.style.left = Math.max(0, cellRect.left - parentRect.left) + 'px';
            
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeColorPicker(e) {
                    if (!picker.contains(e.target) && !e.target.textContent.includes('üé®')) {
                        picker.classList.remove('visible');
                        document.removeEventListener('click', closeColorPicker);
                    }
                });
            }, 10);
        };

        window.applyTableColor = function(blockId, color) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table' || !window.selectedTableCell) return;
            
            const row = parseInt(window.selectedTableCell.dataset.row);
            const col = parseInt(window.selectedTableCell.dataset.col);
            const table = document.getElementById(`admin-table-${blockId}`);
            
            if (window.colorPickerMode === 'cell') {
                // Color single cell
                window.selectedTableCell.style.backgroundColor = color;
                block.value.cells[row][col].bgColor = color;
            } 
            else if (window.colorPickerMode === 'row') {
                // Color entire row
                const rowCells = table.querySelectorAll(`tr[data-row="${row}"] td, tr[data-row="${row}"] th`);
                rowCells.forEach((cell, c) => {
                    cell.style.backgroundColor = color;
                    block.value.cells[row][c].bgColor = color;
                });
            } 
            else if (window.colorPickerMode === 'col') {
                // Color entire column
                for (let r = 0; r < block.value.rows; r++) {
                    const cell = table.querySelector(`[data-row="${r}"][data-col="${col}"]`);
                    if (cell) {
                        cell.style.backgroundColor = color;
                        block.value.cells[r][col].bgColor = color;
                    }
                }
            }
            
            // Hide color picker
            document.getElementById(`color-picker-${blockId}`).classList.remove('visible');
        };

        window.addTableRow = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            const newRow = [];
            for (let c = 0; c < block.value.cols; c++) {
                newRow.push({
                    content: '',
                    align: 'left',
                    bgColor: '#FFFFFF'
                });
            }
            
            block.value.cells.push(newRow);
            block.value.rows++;
            
            renderAdminBlocks();
        };

        window.deleteTableRow = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table' || block.value.rows <= 1) {
                alert('Table must have at least one row.');
                return;
            }
            
            let rowToDelete = block.value.rows - 1; // Default to last row
            
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block) === blockId) {
                rowToDelete = parseInt(window.selectedTableCell.dataset.row);
            }
            
            block.value.cells.splice(rowToDelete, 1);
            block.value.rows--;
            
            window.selectedTableCell = null;
            renderAdminBlocks();
        };

        window.addTableColumn = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            for (let r = 0; r < block.value.rows; r++) {
                block.value.cells[r].push({
                    content: r === 0 && block.value.headerRow ? `Header ${block.value.cols + 1}` : '',
                    align: 'left',
                    bgColor: r === 0 && block.value.headerRow ? '#E8E8E8' : '#FFFFFF'
                });
            }
            
            block.value.cols++;
            
            renderAdminBlocks();
        };

        window.deleteTableColumn = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table' || block.value.cols <= 1) {
                alert('Table must have at least one column.');
                return;
            }
            
            let colToDelete = block.value.cols - 1; // Default to last column
            
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block) === blockId) {
                colToDelete = parseInt(window.selectedTableCell.dataset.col);
            }
            
            for (let r = 0; r < block.value.rows; r++) {
                block.value.cells[r].splice(colToDelete, 1);
            }
            
            block.value.cols--;
            
            window.selectedTableCell = null;
            renderAdminBlocks();
        };

        // ==================== END TABLE EDITOR FUNCTIONS ====================

        window.removeAdminBlock = function (id) {
            window.adminBlocks = window.adminBlocks.filter(b => b.id !== id);
            renderAdminBlocks();
        };

        window.updateBlockValue = function (id, value) {
            const block = window.adminBlocks.find(b => b.id === id);
            if (block) block.value = value;
        };

        window.toggleBlank = function (el) {
            if (el.classList.contains('is-blank')) {
                el.classList.remove('is-blank');
                el.style.backgroundColor = 'transparent';
                el.style.borderBottom = 'none';
            } else {
                el.classList.add('is-blank');
                el.style.backgroundColor = '#fff9c4';
                el.style.borderBottom = '2px solid #fbc02d';
            }
        };

        window.processAdminQuestion = function () {
            const previewSection = document.getElementById('admin-preview-section');
            const previewContent = document.getElementById('admin-preview-content');
            const category = document.getElementById('admin-category').value;
            
            if (window.adminBlocks.length === 0) {
                alert("Please add some content blocks first!");
                return;
            }
            
            previewSection.classList.remove('hidden');

            let mainHtml = '';
            let afterAnswerHtml = '';
            
            window.adminBlocks.forEach(block => {
                if (block.type === 'text' && block.value) {
                    mainHtml += `<div style="margin-bottom: 1.5rem; color: var(--main-text); font-size: 1.1rem;">${block.value.replace(/\n/g, '<br>')}</div>`;
                } else if (block.type === 'answer' && block.value) {
                    const words = block.value.split(/\s+/);
                    const wrappedWords = words.map(word => `<span class="admin-word" onclick="toggleBlank(this)" style="cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: all 0.2s;">${word}</span>`).join(' ');
                    mainHtml += `<div class="cer-segment" style="margin-bottom: 1.5rem; line-height: 2;">${wrappedWords}</div>`;
                } else if (block.type === 'explanation' && block.value) {
                    // Explanation goes after the answer/MCQ options
                    afterAnswerHtml += `<div class="explanation-box" style="margin-top: 1.5rem; padding: 1.5rem; background: #f0f4ff; border-left: 4px solid #007bff; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 0.8rem; color: #007bff; display: flex; align-items: center; gap: 8px;">üí° Explanation</h4>
                                <div style="color: #444; line-height: 1.6;">${block.value.replace(/\n/g, '<br>')}</div>
                             </div>`;
                } else if (block.type === 'image' && block.value) {
                    const imageUrl = convertDropboxUrl(block.value);
                    mainHtml += `<img src="${imageUrl}" style="max-width: 100%; border-radius: 8px; margin-bottom: 1.5rem; display: block; margin-left: auto; margin-right: auto;" onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<p style=\\'color:#dc3545;\\'>‚ö†Ô∏è Image failed to load. Check URL.</p>');">`;
                } else if (block.type === 'video' && block.value) {
                    // Video goes after the answer/MCQ options
                    let videoUrl = block.value;
                    if (videoUrl.includes('dropbox.com')) {
                        videoUrl = videoUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?raw=1', '');
                    } else if (videoUrl.includes('youtube.com/watch?v=')) {
                        videoUrl = videoUrl.replace('watch?v=', 'embed/');
                    } else if (videoUrl.includes('youtu.be/')) {
                        videoUrl = videoUrl.replace('youtu.be/', 'youtube.com/embed/');
                    }
                    afterAnswerHtml += `<div class="video-container hidden-until-answered" style="margin-top: 1.5rem; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none;">
                                <iframe src="${videoUrl}" style="width: 100%; height: 315px; border: none;" allowfullscreen></iframe>
                             </div>`;
                } else if (block.type === 'table' && block.value) {
                    // Render table for preview
                    const tableData = block.value;
                    let tableHtml = `<table class="question-table" style="width: 100%; border-collapse: collapse; font-family: 'Century Gothic', 'Segoe UI', sans-serif; margin-bottom: 1.5rem;">`;
                    
                    for (let r = 0; r < tableData.rows; r++) {
                        tableHtml += '<tr>';
                        for (let c = 0; c < tableData.cols; c++) {
                            const cell = tableData.cells[r][c];
                            const tag = (r === 0 && tableData.headerRow) ? 'th' : 'td';
                            const fontWeight = (r === 0 && tableData.headerRow) ? 'font-weight: 600;' : '';
                            tableHtml += `<${tag} style="border: 1px solid #bbb; padding: 10px 14px; text-align: ${cell.align}; background-color: ${cell.bgColor}; ${fontWeight}">${cell.content}</${tag}>`;
                        }
                        tableHtml += '</tr>';
                    }
                    
                    tableHtml += '</table>';
                    mainHtml += tableHtml;
                }
            });

            // Build final HTML: main content first, then MCQ options (if MCQ), then after-answer content
            let html = mainHtml;
            
            if (category === 'mcq') {
                const opts = [
                    document.getElementById('mcq-opt-1').value,
                    document.getElementById('mcq-opt-2').value,
                    document.getElementById('mcq-opt-3').value,
                    document.getElementById('mcq-opt-4').value
                ];
                const correct = document.getElementById('mcq-correct').value;
                html += `<div class="mcq-container" style="margin-top: 1rem;">`;
                opts.forEach((opt, i) => {
                    if (opt) {
                        html += `
                            <label class="mcq-option">
                                <input type="radio" name="temp-mcq-preview" value="${i + 1}" data-correct="${correct == i + 1}">
                                <span>${i + 1}. ${opt}</span>
                            </label>
                        `;
                    }
                });
                html += `</div>`;
            }
            
            // Add explanation and video at the end (after MCQ options / answer areas)
            html += afterAnswerHtml;

            previewContent.innerHTML = html;
            previewSection.scrollIntoView({ behavior: 'smooth' });
        };

        window.saveAdminQuestion = async function () {
            if (!window.auth || !window.auth.currentUser) {
                alert("You must be logged in to save.");
                return;
            }
            
            const title = document.getElementById('admin-title').value.trim();
            if (!title) {
                alert("Please enter a question title.");
                document.getElementById('admin-title').focus();
                return;
            }
            
            if (window.adminBlocks.length === 0) {
                alert("Please add some content blocks before saving.");
                return;
            }

            try {
                const category = document.getElementById('admin-category').value;
                const level = document.getElementById('admin-level').value;

                let topic = document.getElementById('admin-topic').value;
                if (topic === 'new-topic') {
                    topic = document.getElementById('admin-new-topic').value.trim().toLowerCase().replace(/\s+/g, '-');
                    if (!topic) {
                        alert("Please enter a name for the new topic.");
                        return;
                    }
                }

                // Check if preview has been generated
                const previewContent = document.getElementById('admin-preview-content');
                let finalHtml = '';
                
                if (previewContent.innerHTML.trim()) {
                    // Use preview content (with blanks selected)
                    const clone = previewContent.cloneNode(true);
                    
                    // Remove any controls that might be in the preview
                    clone.querySelectorAll('.controls, button.submit-btn, button.next-btn, button.print-btn, button.btn-primary').forEach(el => el.remove());
                    
                    // Ensure explanation boxes are hidden by default
                    clone.querySelectorAll('.explanation-box').forEach(el => {
                        el.style.display = 'none';
                    });
                    
                    // Ensure video containers are hidden by default
                    clone.querySelectorAll('.video-container').forEach(el => {
                        el.style.display = 'none';
                        el.classList.add('hidden-until-answered');
                    });
                    
                    const selectedWords = clone.querySelectorAll('.admin-word.is-blank');
                    selectedWords.forEach(word => {
                        const answer = word.textContent.trim().replace(/[.,!?;:]/g, '');
                        const calcWidth = Math.max(90, (answer.length * 1.5) * 10);
                        word.outerHTML = `<input type="text" class="answer-input" data-answer="${answer}" placeholder="..." style="width: ${calcWidth}px;">`;
                    });

                    // Convert non-blank words back to plain text
                    clone.querySelectorAll('.admin-word:not(.is-blank)').forEach(word => {
                        word.outerHTML = word.textContent;
                    });

                    clone.querySelectorAll('.cer-segment').forEach(seg => {
                        if (!seg.querySelector('.feedback-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'feedback-icon';
                            seg.appendChild(icon);
                        }
                    });
                    
                    finalHtml = clone.innerHTML;
                } else {
                    // Build HTML directly from blocks (no preview)
                    // Separate main content from after-answer content
                    let mainHtml = '';
                    let afterAnswerHtml = '';
                    
                    window.adminBlocks.forEach(block => {
                        if (block.type === 'text' && block.value) {
                            mainHtml += `<div style="margin-bottom: 1.5rem; color: var(--main-text); font-size: 1.1rem;">${block.value.replace(/\n/g, '<br>')}</div>`;
                        } else if (block.type === 'answer' && block.value) {
                            // Parse [word] as blanks
                            let answerHtml = block.value.replace(/\[([^\]]+)\]/g, (match, answer) => {
                                const calcWidth = Math.max(90, (answer.length * 1.5) * 10);
                                return `<input type="text" class="answer-input" data-answer="${answer.trim()}" placeholder="..." style="width: ${calcWidth}px;">`;
                            });
                            mainHtml += `<div class="cer-segment" style="margin-bottom: 1.5rem; line-height: 2;">${answerHtml}<span class="feedback-icon"></span></div>`;
                        } else if (block.type === 'explanation' && block.value) {
                            // Explanation goes after MCQ/answer section
                            afterAnswerHtml += `<div class="explanation-box" style="margin-top: 1.5rem; padding: 1.5rem; background: #f0f4ff; border-left: 4px solid #007bff; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 0.8rem; color: #007bff; display: flex; align-items: center; gap: 8px;">üí° Explanation</h4>
                                <div style="color: #444; line-height: 1.6;">${block.value.replace(/\n/g, '<br>')}</div>
                             </div>`;
                        } else if (block.type === 'image' && block.value) {
                            const imageUrl = convertDropboxUrl(block.value);
                            mainHtml += `<img src="${imageUrl}" class="question-diagram" style="max-width: 100%; border-radius: 8px; margin-bottom: 1.5rem; display: block; margin-left: auto; margin-right: auto;">`;
                        } else if (block.type === 'video' && block.value) {
                            // Video goes after MCQ/answer section
                            let videoUrl = block.value;
                            if (videoUrl.includes('dropbox.com')) {
                                videoUrl = videoUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?raw=1', '');
                            } else if (videoUrl.includes('youtube.com/watch?v=')) {
                                videoUrl = videoUrl.replace('watch?v=', 'embed/');
                            } else if (videoUrl.includes('youtu.be/')) {
                                videoUrl = videoUrl.replace('youtu.be/', 'youtube.com/embed/');
                            }
                            afterAnswerHtml += `<div class="video-container hidden-until-answered" style="margin-top: 1.5rem; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none;">
                                <iframe src="${videoUrl}" style="width: 100%; height: 315px; border: none;" allowfullscreen></iframe>
                             </div>`;
                        } else if (block.type === 'table' && block.value) {
                            // Generate table HTML for saving
                            const tableData = block.value;
                            let tableHtml = `<table class="question-table" style="width: 100%; border-collapse: collapse; font-family: 'Century Gothic', 'Segoe UI', sans-serif; margin-bottom: 1.5rem;">`;
                            
                            for (let r = 0; r < tableData.rows; r++) {
                                tableHtml += '<tr>';
                                for (let c = 0; c < tableData.cols; c++) {
                                    const cell = tableData.cells[r][c];
                                    const tag = (r === 0 && tableData.headerRow) ? 'th' : 'td';
                                    const fontWeight = (r === 0 && tableData.headerRow) ? 'font-weight: 600;' : '';
                                    tableHtml += `<${tag} style="border: 1px solid #bbb; padding: 10px 14px; text-align: ${cell.align}; background-color: ${cell.bgColor}; ${fontWeight}">${cell.content}</${tag}>`;
                                }
                                tableHtml += '</tr>';
                            }
                            
                            tableHtml += '</table>';
                            mainHtml += tableHtml;
                        }
                    });

                    // Start with main content
                    finalHtml = mainHtml;

                    // Add MCQ options if MCQ category
                    if (category === 'mcq') {
                        const opts = [
                            document.getElementById('mcq-opt-1').value,
                            document.getElementById('mcq-opt-2').value,
                            document.getElementById('mcq-opt-3').value,
                            document.getElementById('mcq-opt-4').value
                        ];
                        const correct = document.getElementById('mcq-correct').value;
                        finalHtml += `<div class="mcq-container" style="margin-top: 1rem;">`;
                        opts.forEach((opt, i) => {
                            if (opt) {
                                finalHtml += `
                                    <label class="mcq-option">
                                        <input type="radio" name="mcq-answer" value="${i + 1}" data-correct="${correct == i + 1}">
                                        <span>${i + 1}. ${opt}</span>
                                    </label>
                                `;
                            }
                        });
                        finalHtml += `</div>`;
                    }
                    
                    // Add explanation and video at the very end
                    finalHtml += afterAnswerHtml;
                }

                const { doc, setDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Determine if updating existing or creating new
                const isEditing = window.editingQuestionId && window.editingQuestionId.startsWith('q-custom-');
                const questionId = isEditing 
                    ? window.editingQuestionId.replace('q-', '') 
                    : "custom-" + Date.now();
                
                const questionData = {
                    title: title,
                    html: finalHtml,
                    updatedBy: window.auth.currentUser.email,
                    updatedAt: new Date().toISOString(),
                    category: category,
                    level: level,
                    topic: topic,
                    type: 'custom'
                };
                
                if (!isEditing) {
                    questionData.createdBy = window.auth.currentUser.email;
                    questionData.createdAt = new Date().toISOString();
                }
                
                await setDoc(doc(window.db_fs, "custom_questions", questionId), questionData, { merge: true });
                
                const actionText = isEditing ? "updated" : "added";
                alert(`Question successfully ${actionText}!`);
                
                // Clear the form (force without confirmation since we just saved)
                window.editingQuestionId = null;
                window.clearAdminForm(true);
                
                // Reload to show changes
                location.reload();
            } catch (e) {
                console.error("Save Error:", e);
                alert("Error saving: " + e.message);
            }
        };

        // Cancel editing and clear form
        window.cancelEditing = function() {
            if (window.adminBlocks.length > 0 && !confirm("Cancel editing? Unsaved changes will be lost.")) return;
            window.editingQuestionId = null;
            window.clearAdminForm(true); // force clear without confirmation
            updateEditingIndicator();
        };
        
        // Update the editing indicator
        window.updateEditingIndicator = function() {
            const indicator = document.getElementById('editing-indicator');
            const nameSpan = document.getElementById('editing-question-name');
            const titleInput = document.getElementById('admin-title');
            
            if (window.editingQuestionId) {
                indicator.classList.remove('hidden');
                indicator.style.display = 'flex';
                nameSpan.textContent = titleInput.value || window.editingQuestionId;
            } else {
                indicator.classList.add('hidden');
                indicator.style.display = 'none';
            }
        };

        // Clear admin form
        window.clearAdminForm = function(force = false) {
            if (!force && window.adminBlocks.length > 0 && !confirm("Clear all content? This cannot be undone.")) return;
            
            window.adminBlocks = [];
            window.editingQuestionId = null;
            renderAdminBlocks();
            
            document.getElementById('admin-title').value = '';
            document.getElementById('admin-category').value = 'cer';
            document.getElementById('admin-topic').value = 'heat';
            document.getElementById('admin-new-topic').value = '';
            document.getElementById('admin-new-topic').classList.add('hidden');
            document.getElementById('mcq-opt-1').value = '';
            document.getElementById('mcq-opt-2').value = '';
            document.getElementById('mcq-opt-3').value = '';
            document.getElementById('mcq-opt-4').value = '';
            document.getElementById('mcq-correct').value = '1';
            
            handleCategoryChange('cer');
            
            document.getElementById('admin-preview-section').classList.add('hidden');
            document.getElementById('admin-preview-content').innerHTML = '';
            
            updateEditingIndicator();
        };

        // Convert Dropbox URL to displayable format
        window.convertDropboxUrl = function(url) {
            if (!url) return url;
            
            // Handle new Dropbox format: /scl/fi/xxx/file.jpg?rlkey=xxx&dl=0
            if (url.includes('dropbox.com/scl/')) {
                // Replace dl=0 or dl=1 with raw=1
                url = url.replace(/[?&]dl=[01]/, '&raw=1');
                if (!url.includes('raw=1')) {
                    url += (url.includes('?') ? '&' : '?') + 'raw=1';
                }
                return url;
            }
            
            // Handle old Dropbox format
            if (url.includes('dropbox.com')) {
                return url.replace('www.dropbox.com', 'dl.dropboxusercontent.com')
                          .replace('?dl=0', '')
                          .replace('?dl=1', '');
            }
            
            return url;
        };

        function editQuestion(btn, isDuplicate = false) {
            const container = btn.closest('.question-container');
            const titleEl = container.querySelector('h3');
            
            // Extract title from h3 - this works for both custom and built-in questions
            let title = "";
            if (titleEl) {
                title = titleEl.innerText.trim();
            }
            
            // If h3 is generic like "Question 1" for built-in questions, try question-title paragraph
            if (!title || (/^Question\s*\d*$/i.test(title) && !container.classList.contains('custom-question') && !container.id.includes('custom'))) {
                const questionTitleEl = container.querySelector('.question-title, p.question-title');
                if (questionTitleEl) {
                    const fullText = questionTitleEl.textContent.trim();
                    title = fullText.length > 60 ? fullText.substring(0, 57) + '...' : fullText;
                }
            }
            
            // Fallback if still no title
            if (!title) {
                title = "Untitled Question";
            }

            // Detect category from container location
            let category = 'cer';
            let detectedTopic = 'heat';
            
            if (container.closest('#view-cer') || container.closest('[id^="topic-heat"]') || container.closest('[id^="topic-light"]') || container.closest('[id^="topic-materials"]')) {
                category = 'cer';
            } else if (container.closest('#view-definition')) {
                category = 'definition';
            } else if (container.closest('#view-single-relationship')) {
                category = 'single-relationship';
            } else if (container.id.includes('mcq') || container.closest('[id^="topic-mcq-"]')) {
                category = 'mcq';
            }
            
            // Try to detect topic from container ID
            const containerId = container.closest('[id^="topic-"]')?.id || '';
            if (containerId) {
                const topicMatch = containerId.match(/topic-(?:mcq-)?(.+)/);
                if (topicMatch) {
                    detectedTopic = topicMatch[1];
                }
            }

            // Store the question ID if editing (not duplicating) - do this BEFORE setTimeout
            if (!isDuplicate && container.id) {
                window.editingQuestionId = container.id;
            } else {
                window.editingQuestionId = null;
            }
            
            // Store the title for later use
            const finalTitle = isDuplicate ? title + " (Copy)" : title;

            // Switch to admin tab
            switchTab('admin', document.getElementById('btn-sidebar-admin'));

            // Set form values with a small delay to ensure DOM is ready
            setTimeout(() => {
                // Set category
                document.getElementById('admin-category').value = category;
                handleCategoryChange(category);
                
                // Set the title explicitly
                document.getElementById('admin-title').value = finalTitle;
                
                // Try to set the topic
                const topicSelect = document.getElementById('admin-topic');
                const topicExists = Array.from(topicSelect.options).some(opt => opt.value === detectedTopic);
                if (topicExists) {
                    topicSelect.value = detectedTopic;
                }
                
                // Try to detect MCQ level from topic container
                if (category === 'mcq') {
                    // Check which level's topics include this topic
                    for (const [level, topics] of Object.entries(window.mcqCurriculum)) {
                        const normalizedTopics = topics.map(t => t.toLowerCase().replace(/\s+/g, '-'));
                        if (normalizedTopics.includes(detectedTopic)) {
                            document.getElementById('admin-level').value = level;
                            updateAdminTopicsByLevel(level);
                            // Re-set the topic after updating options
                            setTimeout(() => {
                                const topicSelect = document.getElementById('admin-topic');
                                const topicExists = Array.from(topicSelect.options).some(opt => opt.value === detectedTopic);
                                if (topicExists) {
                                    topicSelect.value = detectedTopic;
                                }
                                // Re-set title again after MCQ updates to be sure
                                document.getElementById('admin-title').value = finalTitle;
                            }, 100);
                            break;
                        }
                    }
                }
                
                // Update editing indicator after title is set
                updateEditingIndicator();
            }, 100);

            window.adminBlocks = [];
            
            // ========== EXTRACT CONTENT IN DOM ORDER ==========
            // Find the question body container
            const questionBody = container.querySelector('.question-body, .answer-template, .mcq-body') || container;
            
            // Get all direct children and walk through them in order
            const processElement = (element, blockIdOffset) => {
                if (!element || element.classList?.contains('controls')) return;
                
                const tagName = element.tagName?.toLowerCase();
                
                // Skip certain elements
                if (element.classList?.contains('feedback-icon')) return;
                if (element.classList?.contains('mcq-option')) return; // MCQ options handled separately
                if (element.classList?.contains('mcq-container')) return; // MCQ container handled separately
                if (tagName === 'button') return;
                if (tagName === 'h3') return; // Title is handled separately
                
                // Check for explanation box
                if (element.classList?.contains('explanation-box')) {
                    const contentDiv = element.querySelector('div:last-child') || element.querySelector('div');
                    let explainText = '';
                    if (contentDiv) {
                        explainText = contentDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '').trim();
                    } else {
                        explainText = element.textContent.replace(/üí°\s*Explanation/i, '').trim();
                    }
                    if (explainText) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'explanation', 
                            value: explainText
                        });
                    }
                    return;
                }
                
                // Check for video container
                if (element.classList?.contains('video-container')) {
                    const iframe = element.querySelector('iframe');
                    if (iframe && iframe.src) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'video', 
                            value: iframe.src
                        });
                    }
                    return;
                }
                
                // Check for standalone iframe (video)
                if (tagName === 'iframe' && (element.src?.includes('youtube') || element.src?.includes('dropbox'))) {
                    window.adminBlocks.push({ 
                        id: Date.now() + blockIdOffset, 
                        type: 'video', 
                        value: element.src
                    });
                    return;
                }
                
                // Check for image
                if (tagName === 'img' && element.src && !element.src.includes('data:')) {
                    window.adminBlocks.push({ 
                        id: Date.now() + blockIdOffset, 
                        type: 'image', 
                        value: element.src 
                    });
                    return;
                }
                
                // Check for table
                if (tagName === 'table') {
                    // Extract table data
                    const rows = element.querySelectorAll('tr');
                    const tableData = {
                        rows: rows.length,
                        cols: rows[0]?.querySelectorAll('th, td').length || 0,
                        cells: [],
                        headerRow: !!rows[0]?.querySelector('th')
                    };
                    
                    rows.forEach(row => {
                        const rowData = [];
                        row.querySelectorAll('th, td').forEach(cell => {
                            rowData.push({
                                content: cell.textContent.trim(),
                                align: cell.style.textAlign || 'left',
                                bgColor: cell.style.backgroundColor || '#FFFFFF'
                            });
                        });
                        tableData.cells.push(rowData);
                    });
                    
                    if (tableData.rows > 0 && tableData.cols > 0) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'table', 
                            value: tableData
                        });
                    }
                    return;
                }
                
                // Check for CER segment (fill-in-blank)
                if (element.classList?.contains('cer-segment')) {
                    let segText = '';
                    const label = element.getAttribute('data-label') || '';
                    
                    // Walk through all nodes to build the text with blanks marked
                    const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT);
                    let node;
                    while (node = walker.nextNode()) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            segText += node.textContent;
                        } else if (node.nodeType === Node.ELEMENT_NODE) {
                            if (node.classList?.contains('answer-input') || node.tagName === 'INPUT') {
                                const answer = node.dataset?.answer || node.value || '';
                                if (answer) {
                                    segText += `[${answer}]`;
                                }
                            }
                        }
                    }
                    
                    segText = segText.replace(/\s+/g, ' ').trim();
                    // Remove feedback icons text
                    segText = segText.replace(/[‚úî‚úñ]/g, '').trim();
                    
                    if (segText) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'answer', 
                            value: (label ? `(${label}) ` : '') + segText
                        });
                    }
                    return;
                }
                
                // Check for div with text content (but not containers)
                if (tagName === 'div') {
                    // Skip if it's a container div with children that we'll process
                    const hasProcessableChildren = element.querySelector('img, table, iframe, .cer-segment, .explanation-box, .video-container');
                    if (hasProcessableChildren) {
                        // Process children instead
                        Array.from(element.children).forEach((child, idx) => {
                            processElement(child, blockIdOffset + idx * 10);
                        });
                        return;
                    }
                    
                    // It's a text div
                    const text = element.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '').trim();
                    if (text && text.length > 0) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'text', 
                            value: text
                        });
                    }
                    return;
                }
                
                // Check for paragraph
                if (tagName === 'p') {
                    // Skip if inside mcq-option or explanation
                    if (element.closest('.mcq-option') || element.closest('.explanation-box')) return;
                    
                    const text = element.textContent.trim();
                    if (text) {
                        // Check if this is a question-title
                        if (element.classList?.contains('question-title')) {
                            window.adminBlocks.push({ 
                                id: Date.now() + blockIdOffset, 
                                type: 'text', 
                                value: text
                            });
                        } else {
                            window.adminBlocks.push({ 
                                id: Date.now() + blockIdOffset, 
                                type: 'text', 
                                value: text
                            });
                        }
                    }
                    return;
                }
            };
            
            // Process all children of the question body in order
            let blockOffset = 0;
            Array.from(questionBody.children).forEach((child, idx) => {
                processElement(child, blockOffset);
                blockOffset += 100;
            });
            
            // If no blocks were extracted, try a simpler approach for older question formats
            if (window.adminBlocks.length === 0) {
                // Get text content
                const allText = [];
                container.querySelectorAll('p:not(.question-title), div[style*="margin-bottom"]').forEach(el => {
                    if (!el.closest('.mcq-option') && !el.closest('.explanation-box') && !el.closest('.controls')) {
                        const text = el.textContent.trim();
                        if (text) allText.push(text);
                    }
                });
                if (allText.length > 0) {
                    window.adminBlocks.push({ 
                        id: Date.now(), 
                        type: 'text', 
                        value: allText.join('\n\n')
                    });
                }
                
                // Get images
                container.querySelectorAll('img').forEach((img, idx) => {
                    if (img.src && !img.src.includes('data:') && !img.closest('.explanation-box')) {
                        window.adminBlocks.push({ 
                            id: Date.now() + idx + 100, 
                            type: 'image', 
                            value: img.src
                        });
                    }
                });
                
                // Get explanation
                const explanation = container.querySelector('.explanation-box');
                if (explanation) {
                    const contentDiv = explanation.querySelector('div:last-child') || explanation.querySelector('div');
                    let explainText = contentDiv ? contentDiv.textContent.trim() : explanation.textContent.replace(/üí°\s*Explanation/i, '').trim();
                    if (explainText) {
                        window.adminBlocks.push({ 
                            id: Date.now() + 500, 
                            type: 'explanation', 
                            value: explainText
                        });
                    }
                }
                
                // Get video
                const video = container.querySelector('iframe[src*="youtube"], iframe[src*="dropbox"], .video-container iframe');
                if (video && video.src) {
                    window.adminBlocks.push({ 
                        id: Date.now() + 600, 
                        type: 'video', 
                        value: video.src
                    });
                }
            }
            
            // Handle MCQ specific content - fill in the option fields
            if (category === 'mcq') {
                const mcqOptions = container.querySelectorAll('.mcq-option');
                mcqOptions.forEach((opt, idx) => {
                    const input = opt.querySelector('input[type="radio"]');
                    const span = opt.querySelector('span');
                    if (span && idx < 4) {
                        let optText = span.textContent.trim();
                        optText = optText.replace(/^\d+\.\s*/, '');
                        setTimeout(() => {
                            document.getElementById(`mcq-opt-${idx + 1}`).value = optText;
                            if (input && input.dataset.correct === 'true') {
                                document.getElementById('mcq-correct').value = (idx + 1).toString();
                            }
                        }, 150);
                    }
                });
            }

            renderAdminBlocks();
            
            // Hide preview section when loading new content
            document.getElementById('admin-preview-section').classList.add('hidden');
            
            // Final safety: set title again after everything is done
            setTimeout(() => {
                document.getElementById('admin-title').value = finalTitle;
                updateEditingIndicator();
            }, 200);
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // =====================================================
        // QUESTION FORM SETUP
        // =====================================================

        function setupQuestionForm(formId) {
            const form = document.getElementById(formId);
            if (!form) return;
            const questionContainer = form.closest('.question-container');
            if (!questionContainer) return;
            const submitBtn = questionContainer.querySelector('.submit-btn');
            const nextBtn = questionContainer.querySelector('.next-btn');
            const segments = form.querySelectorAll('.cer-segment');

            if (!submitBtn) return;

            submitBtn.addEventListener('click', () => {
                segments.forEach(segment => {
                    const inputs = segment.querySelectorAll('.answer-input');
                    const icon = segment.querySelector('.feedback-icon');
                    let isGroupCorrect = true;
                    inputs.forEach(input => {
                        const userAnswer = input.value.trim().toLowerCase();
                        const answerString = input.dataset.answer.toLowerCase();
                        const validAnswers = answerString.split('|').map(a => a.trim());

                        if (validAnswers.includes(userAnswer)) {
                            input.style.borderBottomColor = 'var(--correct-color)';
                        } else {
                            input.style.borderBottomColor = 'var(--incorrect-color)';
                            input.value = validAnswers[0];
                            isGroupCorrect = false;
                        }
                    });
                    if (icon) {
                        icon.textContent = isGroupCorrect ? '‚úî' : '‚úñ';
                        icon.classList.add(isGroupCorrect ? 'correct' : 'incorrect', 'visible');
                    }
                });

                form.querySelectorAll('.answer-input').forEach(input => input.disabled = true);
                submitBtn.disabled = true;
                if (nextBtn) nextBtn.classList.remove('hidden');
                
                // Show explanation if it exists
                const explanationBox = form.querySelector('.explanation-box');
                if (explanationBox) {
                    explanationBox.style.display = 'block';
                }
                
                // Show video if it exists
                const videoContainer = form.querySelector('.video-container');
                if (videoContainer) {
                    videoContainer.style.display = 'block';
                }
            });
        }
        window.setupQuestionFormGlobal = setupQuestionForm;

        // =====================================================
        // ADD CONTROLS TO QUESTIONS
        // =====================================================

        function addControlsToQuestion(container) {
            // Add worksheet button if not exists
            if (!container.querySelector('.worksheet-control-bar')) {
                const bar = document.createElement('div');
                bar.className = 'worksheet-control-bar';

                const qId = container.id;
                const isInWorksheet = qId && window.worksheetItems.some(item => item.id === qId);

                bar.innerHTML = `<button class="btn-worksheet-add ${isInWorksheet ? 'added' : ''}" onclick="toggleWorksheetItem(this)">${isInWorksheet ? '‚úÖ Added' : '‚ûï Worksheet'}</button>`;
                container.appendChild(bar);
            }

            // Add admin controls if admin
            if (window.isAdminUser && !container.querySelector('.admin-controls')) {
                const controls = document.createElement('div');
                controls.className = 'admin-controls';
                
                const isCustomQuestion = container.classList.contains('custom-question') || container.id.includes('custom');
                
                let controlsHtml = `
                    <button class="admin-edit-btn" onclick="editQuestion(this)">‚úèÔ∏è Edit</button>
                    <button class="admin-duplicate-btn" onclick="editQuestion(this, true)">üìã Duplicate</button>
                `;
                
                if (isCustomQuestion) {
                    controlsHtml += `<button class="admin-delete-btn" onclick="deleteQuestion(this)" style="background: #ffeae8; color: #dc3545; border: 1px solid #dc3545;">üóëÔ∏è Delete</button>`;
                }
                
                controls.innerHTML = controlsHtml;
                container.appendChild(controls);
            }
        }

        // Delete a custom question
        window.deleteQuestion = async function(btn) {
            if (!confirm("Are you sure you want to delete this question? This cannot be undone.")) return;
            
            const container = btn.closest('.question-container');
            if (!container || !container.id) {
                alert("Cannot identify question to delete.");
                return;
            }
            
            try {
                const questionId = container.id.replace('q-', '');
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                await deleteDoc(doc(window.db_fs, "custom_questions", questionId));
                
                alert("Question deleted successfully!");
                container.remove();
            } catch (e) {
                console.error("Delete Error:", e);
                alert("Error deleting question: " + e.message);
            }
        };

        window.updateAllControls = function () {
            document.querySelectorAll('.question-container').forEach(addControlsToQuestion);
        };

        // =====================================================
        // PRINT FUNCTIONS
        // =====================================================

        window.printQuestion = function (btn) {
            const container = btn.closest('.question-container');
            container.classList.add('printing');
            document.body.classList.add('print-single');
            window.print();
            document.body.classList.remove('print-single');
            container.classList.remove('printing');
        };

        window.printAll = function () {
            document.body.classList.add('print-all');
            window.print();
            document.body.classList.remove('print-all');
        };

        // =====================================================
        // TOPIC SWITCHING
        // =====================================================

        function switchTopic(topic) {
            const navButtons = {
                heat: document.getElementById('btn-heat'),
                light: document.getElementById('btn-light'),
                materials: document.getElementById('btn-materials')
            };
            const topics = {
                heat: document.getElementById('topic-heat'),
                light: document.getElementById('topic-light'),
                materials: document.getElementById('topic-materials')
            };

            Object.values(navButtons).forEach(btn => btn?.classList.remove('active'));
            Object.values(topics).forEach(t => t?.classList.add('hidden'));

            if (navButtons[topic]) navButtons[topic].classList.add('active');
            if (topics[topic]) topics[topic].classList.remove('hidden');
        }

        // =====================================================
        // DOM CONTENT LOADED
        // =====================================================

        document.addEventListener('DOMContentLoaded', () => {
            // Load worksheet from storage
            loadWorksheetFromStorage();

            // Setup topic navigation
            const topicButtons = ['heat', 'light', 'materials'];
            topicButtons.forEach(topic => {
                const btn = document.getElementById(`btn-${topic}`);
                if (btn) {
                    btn.addEventListener('click', () => switchTopic(topic));
                }
            });

            // Setup next buttons
            document.querySelectorAll('.next-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const currentQuestion = button.closest('.question-container');
                    const nextQuestion = currentQuestion?.nextElementSibling;
                    if (nextQuestion && nextQuestion.classList.contains('question-container')) {
                        nextQuestion.classList.remove('hidden');
                        nextQuestion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });

            // Setup all question forms
            document.querySelectorAll('.answer-template').forEach(form => {
                if (form.id) setupQuestionForm(form.id);
            });

            // Initialize with heat topic
            switchTopic('heat');

            // Update worksheet UI
            updateWorksheetUI();
        });
    </script>

    <!-- Firebase Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAUSI3Uh28IeqASEp0JhH4QPaVt-O3meBo",
            authDomain: "mathgen--app.firebaseapp.com",
            projectId: "mathgen--app",
            storageBucket: "mathgen--app.firebasestorage.app",
            messagingSenderId: "165654161198",
            appId: "1:165654161198:web:16c8bd60eb3a2aa7edbcbf",
            measurementId: "G-0MWZFG211D"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth;
        const db_fs = getFirestore(app);
        window.db_fs = db_fs;
        const googleProvider = new GoogleAuthProvider();

        let isSignUpMode = false;

        window.toggleAuthMode = () => {
            isSignUpMode = !isSignUpMode;
            document.getElementById('reg-fields').style.display = isSignUpMode ? "block" : "none";
            document.getElementById('legal-box').style.display = isSignUpMode ? "block" : "none";
            document.getElementById('btn-google').style.display = isSignUpMode ? "none" : "flex";
            document.getElementById('auth-title').innerText = isSignUpMode ? "Register Student Account" : "Welcome Back!";
            document.getElementById('btn-login').innerText = isSignUpMode ? "Confirm Registration" : "Login";
        };

        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errorMsg = document.getElementById('auth-error');
            if (!email || !pass) { errorMsg.innerText = "Fields cannot be empty."; return; }

            try {
                if (isSignUpMode) {
                    const pName = document.getElementById('parent-name').value;
                    const sName = document.getElementById('student-name').value;
                    if (!pName || !sName || !document.getElementById('legal-agree').checked) {
                        errorMsg.innerText = "Fill all fields and agree to terms."; return;
                    }
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db_fs, "users", cred.user.uid), {
                        email, parentName: pName, studentName: sName, loginDays: 1, lastLoginDate: new Date().toDateString(), agreedToTerms: true
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (e) {
                console.error("Auth Error:", e);
                errorMsg.innerText = "Invalid email or password";
            }
        };

        window.handleForgotPassword = async () => {
            const email = document.getElementById('auth-email').value;
            const errorMsg = document.getElementById('auth-error');
            if (!email) {
                errorMsg.innerText = "Please enter your email address first.";
                errorMsg.style.color = "#dc3545";
                return;
            }

            try {
                await sendPasswordResetEmail(auth, email);
                errorMsg.innerText = "Password reset email sent! Check your inbox.";
                errorMsg.style.color = "#28a745";
            } catch (e) {
                console.error("Reset Error:", e);
                errorMsg.innerText = "Error sending reset email: " + e.message;
                errorMsg.style.color = "#dc3545";
            }
        };

        window.handleGoogleLogin = async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                await trackLoginDays(result.user);
            } catch (e) {
                document.getElementById('auth-error').innerText = "Google Error: " + e.message;
            }
        };

        async function trackLoginDays(user) {
            const userRef = doc(db_fs, "users", user.uid);
            const today = new Date().toDateString();
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                const data = userSnap.data();
                if (data.lastLoginDate !== today) {
                    await updateDoc(userRef, { loginDays: increment(1), lastLoginDate: today });
                }
                const display = document.getElementById('login-days-display');
                if (display) display.innerText = `üìÖ Day ${data.loginDays || 1} streak!`;
            } else {
                await setDoc(userRef, { email: user.email, studentName: user.displayName || "Student", loginDays: 1, lastLoginDate: today });
            }
        }

        window.handleLogout = () => signOut(auth).then(() => {
            // Clear all session data on logout
            sessionStorage.clear();
            localStorage.removeItem('server_file_version');
            window.location.href = window.location.origin + window.location.pathname + '?r=' + Date.now();
        });

        onAuthStateChanged(auth, (user) => {
            const overlay = document.getElementById('auth-overlay');
            if (user) {
                overlay.style.display = 'none';
                trackLoginDays(user);

                async function loadCustomQuestions() {
                    if (window.customQuestionsLoaded) return;
                    window.customQuestionsLoaded = true;

                    try {
                        const qSnapshot = await getDocs(query(collection(db_fs, "custom_questions")));
                        qSnapshot.forEach((docSnap) => {
                            const data = docSnap.data();
                            const category = data.category;
                            const topic = data.topic || 'general';
                            const topicId = topic.toLowerCase().replace(/\s+/g, '-');

                            // If MCQ, attach to the main content area topics instead of being inside view-cer
                            const mainContentArea = document.getElementById('main-content-area');
                            const targetView = category === 'mcq' ? null : document.getElementById(`view-${category}`);

                            let containerId = category === 'mcq' ? `topic-mcq-${topicId}` : `topic-${topicId}`;
                            let topicContainer = document.getElementById(containerId);

                            if (!topicContainer) {
                                topicContainer = document.createElement('div');
                                topicContainer.id = containerId;
                                topicContainer.className = 'topic-content hidden';
                                if (category === 'mcq') {
                                    mainContentArea.appendChild(topicContainer);
                                } else if (targetView) {
                                    const targetContent = targetView.querySelector('.main-content');
                                    if (targetContent) targetContent.appendChild(topicContainer);
                                }
                            }

                            if (topicContainer) {
                                const qId = "q-" + docSnap.id;
                                const div = document.createElement('div');
                                div.className = 'question-container custom-question';
                                div.id = qId;
                                div.style.borderLeft = '4px solid #fbc02d';
                                
                                // Convert any Dropbox URLs in the saved HTML
                                let processedHtml = data.html;
                                // Fix Dropbox image URLs
                                processedHtml = processedHtml.replace(/src="(https:\/\/www\.dropbox\.com\/scl\/[^"]+)"/g, (match, url) => {
                                    let fixedUrl = url.replace(/[?&]dl=[01]/, '&raw=1');
                                    if (!fixedUrl.includes('raw=1')) {
                                        fixedUrl += (fixedUrl.includes('?') ? '&' : '?') + 'raw=1';
                                    }
                                    return `src="${fixedUrl}"`;
                                });
                                
                                // Remove any existing controls/buttons from saved HTML to prevent duplicates
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = processedHtml;
                                tempDiv.querySelectorAll('.controls').forEach(el => el.remove());
                                // Also remove any stray buttons that might be outside controls
                                tempDiv.querySelectorAll('button.submit-btn, button.next-btn, button.print-btn, button.btn-primary').forEach(el => el.remove());
                                // Remove any divs that only contain "Check Answer" text
                                tempDiv.querySelectorAll('div').forEach(div => {
                                    const text = div.textContent.trim();
                                    if (text === 'Check Answer' || text === 'Submit') {
                                        div.remove();
                                    }
                                });
                                // Remove mcq-option labels that contain "Check Answer"
                                tempDiv.querySelectorAll('.mcq-option, label').forEach(el => {
                                    if (el.textContent.trim().includes('Check Answer')) {
                                        el.remove();
                                    }
                                });
                                // Ensure explanation boxes are hidden by default
                                tempDiv.querySelectorAll('.explanation-box').forEach(el => {
                                    el.style.display = 'none';
                                });
                                // Ensure video containers are hidden by default
                                tempDiv.querySelectorAll('.video-container').forEach(el => {
                                    el.style.display = 'none';
                                    el.classList.add('hidden-until-answered');
                                });
                                processedHtml = tempDiv.innerHTML;
                                
                                div.innerHTML = `
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                            <h3 style="margin: 0; color: var(--primary-blue);">${data.title || 'Custom Question'}</h3>
                                            <span style="font-size: 0.7rem; background: #fff9c4; padding: 2px 8px; border-radius: 4px; color: #fbc02d; font-weight: bold;">USER CONTRIBUTED (${topic.toUpperCase()})</span>
                                        </div>
                                        <div id="${qId}-body" class="question-body ${category === 'mcq' ? 'mcq-body' : 'answer-template'}" style="background: rgba(251, 192, 45, 0.05); padding: 1.5rem; border-radius: 8px;">
                                            ${processedHtml}
                                            <div class="controls" style="margin-top: 2rem;">
                                                <button class="btn btn-primary submit-btn" ${category === 'mcq' ? `onclick="checkMcq('${qId}-body')"` : ''} style="background: #fbc02d; border-color: #fbc02d;">Check Answer</button>
                                            </div>
                                        </div>
                                    `;
                                topicContainer.appendChild(div);
                                if (category !== 'mcq' && window.setupQuestionFormGlobal) {
                                    window.setupQuestionFormGlobal(`${qId}-body`);
                                }
                            }
                        });

                        if (window.currentMode === 'mcq') window.renderMcqQuestionList();

                        // Update all controls after loading custom questions
                        setTimeout(() => {
                            window.updateAllControls();
                        }, 100);

                    } catch (e) {
                        console.error("Error loading custom questions:", e);
                    }
                }

                // Check admin status
                const emailParts = user.email.toLowerCase().split('@');
                const handle = emailParts[1] === 'gmail.com' ? emailParts[0].replace(/\./g, '') : emailParts[0];
                const adminHandles = ['zhikaichung', 'chungzhikai'];
                const isAdmin = adminHandles.includes(handle) || user.email.toLowerCase().includes('admin');

                if (isAdmin) {
                    console.log("Admin identified:", user.email);
                    window.isAdminUser = true;
                    document.getElementById('btn-sidebar-admin').classList.remove('hidden');
                } else {
                    window.isAdminUser = false;
                    document.getElementById('btn-sidebar-admin').classList.add('hidden');
                }

                loadCustomQuestions();

                // Add controls to all questions
                setTimeout(() => {
                    window.updateAllControls();
                    window.updateWorksheetUI();
                }, 200);
            } else {
                overlay.style.display = 'flex';
            }
        });
    </script>

    <!-- PowerPoint-style Table Grid Selector (positioned fixed, outside all containers) -->
    <div id="table-grid-selector" class="table-grid-selector">
        <h4 style="margin: 0 0 12px 0; font-size: 1rem; color: #2e7d32; font-weight: 600; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.2rem;">üìä</span> Insert Table
        </h4>
        <p style="margin: 0 0 10px 0; font-size: 0.8rem; color: #666;">Hover to select size, click to insert</p>
        <div class="table-grid" id="table-grid"></div>
        <div class="grid-size-label" id="grid-size-label" style="text-align: center; margin-top: 12px; font-size: 0.95rem; color: #2e7d32; font-weight: 600; min-height: 20px;">Select size</div>
    </div>

</body>

</html>
