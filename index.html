<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <!-- AGGRESSIVE CACHE PREVENTION -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <title>CER Interactive Questions</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --main-text: #333;
            --light-text: #555;
            --peach: #fcece3;
            --teal: #d7eded;
            --blue-light: #e7f5ff;
            --border-color: #dee2e6;
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --primary-blue: #007bff;
            --secondary-blue: #6c757d;
            --disabled-grey: #b0b8c0;
            --label-color: #aab5c0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--main-text);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            background: transparent;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            padding: 0;
        }

        .sidebar {
            width: 250px;
            padding: 2rem;
            background-color: #fdfdfd;
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .sidebar h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .sidebar-nav button {
            display: block;
            width: 100%;
            padding: 0.9rem 1.5rem;
            margin-bottom: 1rem;
            border-radius: 50px;
            border: 2px solid var(--border-color);
            background-color: transparent;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
        }

        .sidebar-nav button.active {
            background-color: var(--teal);
            border-color: #bedbdb;
            color: #000;
            font-weight: 600;
        }

        .sidebar-nav button:hover {
            background-color: var(--blue-light);
            border-color: var(--primary-blue);
        }

        .main-content,
        .view-content,
        .topic-content {
            flex-grow: 1;
            padding: 2.5rem 3rem;
        }

        .question-container {
            margin-bottom: 3rem;
            position: relative;
            padding: 1.5rem;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .main-content p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            color: var(--light-text);
            line-height: 1.8;
        }

        .question-diagram {
            width: 100%;
            max-width: 600px;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .results-table {
            width: 100%;
            max-width: 700px;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .results-table th,
        .results-table td {
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .results-table thead {
            background-color: var(--peach);
        }

        .question-title {
            font-weight: 600;
            font-size: 1.15rem;
            color: var(--main-text);
        }

        .answer-box {
            background-color: var(--blue-light);
            padding: 2.5rem;
            border-radius: 12px;
            margin-top: 2rem;
        }

        .answer-template {
            font-size: 1.1rem;
            line-height: 2.2;
            color: var(--main-text);
        }

        .answer-blank {
            display: inline-flex;
            align-items: center;
            margin: 0 0.2rem;
        }

        .answer-input {
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            border: none;
            border-bottom: 2px solid var(--main-text);
            background: transparent;
            width: auto;
            min-width: 80px;
            text-align: center;
            padding: 0.1rem 0.5rem;
            margin: 0 4px;
        }

        .answer-input:focus {
            outline: none;
            border-bottom-color: var(--primary-blue);
        }

        .feedback-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            margin-left: 0.5rem;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 14px;
            transform: scale(0);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .feedback-icon.visible.correct,
        .feedback-icon.visible.incorrect {
            transform: scale(1);
            opacity: 1;
            animation: circle-pop 0.4s ease-out;
        }

        .feedback-icon.correct {
            background-color: var(--correct-color);
        }

        .feedback-icon.incorrect {
            background-color: var(--incorrect-color);
        }

        /* Answer feedback icon next to submit button */
        .answer-feedback-icon {
            display: inline-block;
            font-size: 1.5rem;
            font-weight: bold;
            margin-left: 12px;
            vertical-align: middle;
            animation: feedbackPop 0.3s ease-out;
        }

        @keyframes feedbackPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Explanation box - hidden by default, shown after answering */
        .explanation-box {
            display: none;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #f0f4ff;
            border-left: 4px solid #007bff;
            border-radius: 8px;
        }
        
        .explanation-box.visible {
            display: block;
        }

        /* Video container - hidden by default, shown after answering */
        .video-container.hidden-until-answered {
            display: none;
        }

        /* Draggable admin blocks */
        .admin-block {
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
        }
        
        .admin-block:not(.no-drag) {
            cursor: grab;
        }
        
        .admin-block:not(.no-drag):active {
            cursor: grabbing;
        }
        
        .admin-block.no-drag {
            cursor: default;
            opacity: 0.95;
        }
        
        .admin-block.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .admin-block.drag-over {
            border-top: 3px solid #007bff !important;
            margin-top: -3px;
        }
        
        .admin-block .drag-handle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: grab;
            color: #999;
            font-size: 1.2rem;
            padding: 5px;
            user-select: none;
        }
        
        .admin-block .drag-handle:hover {
            color: #666;
        }
        
        .admin-block .drag-handle:active {
            cursor: grabbing;
        }

        @keyframes circle-pop {
            0% {
                transform: scale(0);
            }

            60% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .cer-segment {
            position: relative;
            display: block;
            padding: 1.5rem 1.5rem 2.5rem 1.5rem;
            border: 1.5px solid var(--label-color);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .cer-segment:last-of-type {
            margin-bottom: 0;
        }

        .cer-segment::after {
            content: attr(data-label);
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--blue-light);
            padding: 0 0.5rem;
            font-size: 0.9rem;
            font-style: italic;
            color: var(--light-text);
            font-weight: 500;
        }

        .controls {
            margin-top: 2rem;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn {
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Worksheet Styles */
        .worksheet-badge {
            background: #ff4757;
            color: white;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 0.7rem;
            margin-left: 5px;
            vertical-align: middle;
        }

        .btn-worksheet-add {
            background: #f1f2f6;
            color: #2f3542;
            border: 1px solid #dfe4ea;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .btn-worksheet-add:hover {
            background: #2ed573;
            color: white;
            border-color: #2ed573;
        }

        .btn-worksheet-add.added {
            background: #2ed573;
            color: white;
            border-color: #2ed573;
        }

        .btn-worksheet-remove {
            background: #ffeae8;
            color: #dc3545;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-worksheet-remove:hover {
            background: #dc3545;
            color: white;
        }

        .submit-btn {
            background-color: var(--primary-blue);
            color: #fff;
        }

        .submit-btn:disabled {
            background-color: var(--disabled-grey);
            cursor: not-allowed;
        }

        .next-btn {
            background-color: var(--secondary-blue);
            color: #fff;
        }

        .hidden {
            display: none !important;
        }

        /* Top Navigation Tabs */
        .app-header {
            padding: 0.8rem 1rem 0;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            background: #f8f9fa;
        }

        /* Colored line below header that changes with tabs */
        .header-color-line {
            height: 5px;
            background: linear-gradient(90deg, #4a90d9 0%, #6ba3e0 100%);
            transition: background 0.4s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        #header-tabs-container {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            margin: 0;
            padding: 0;
        }

        .app-logo {
            height: 50px;
            margin-right: 0;
            margin-bottom: 0;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            transition: transform 0.3s ease;
        }

        .app-logo:hover {
            transform: scale(1.05) rotate(-2deg);
        }

        .tab-btn {
            padding: 0.45rem 0.9rem;
            border: 1px solid #ccc;
            border-bottom: none;
            background-color: #e8e8e8;
            font-family: 'Poppins', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            color: #555;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            transition: all 0.15s ease;
            position: relative;
            margin: 0;
            margin-left: -1px;
            opacity: 0.9;
        }

        .tab-btn:first-child {
            margin-left: 0;
        }

        .tab-btn:hover {
            opacity: 1;
            z-index: 2;
        }

        .tab-btn.active {
            opacity: 1;
            border-color: #aaa;
            z-index: 3;
            font-weight: 600;
            color: #333;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.08);
        }

        /* Specific Pastel Colors for Tabs */
        .tab-btn[data-type="cer"] {
            background-color: #AEC6CF;
        }

        .tab-btn[data-type="single-relationship"] {
            background-color: #FFB7B2;
        }

        .tab-btn[data-type="double-relationship"] {
            background-color: #FFDAC1;
        }

        .tab-btn[data-type="fairness"] {
            background-color: #E2F0CB;
        }

        .tab-btn[data-type="reliability"] {
            background-color: #C7CEEA;
        }

        .tab-btn[data-type="accuracy"] {
            background-color: #FDFD96;
        }

        .tab-btn[data-type="constant-variable"] {
            background-color: #B5EAD7;
        }

        .tab-btn[data-type="explanation"] {
            background-color: #FF9AA2;
        }

        .tab-btn[data-type="control-setup"] {
            background-color: #E0BBE4;
        }

        .tab-btn[data-type="definition"] {
            background-color: #ADD8E6;
        }

        .app-body {
            display: none;
            flex-grow: 1;
            background: #fff;
            border-top: none;
            position: relative;
            z-index: 15;
        }

        .app-body.active {
            display: flex;
        }

        .app-body>.sidebar {
            border-right: 1px solid var(--border-color);
            background: #fdfdfd;
        }

        .placeholder-content {
            padding: 3rem;
            text-align: center;
            width: 100%;
        }

        /* Variable Labels & Tooltips */
        .answer-group {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: bottom;
            margin: 0 0.2rem;
            position: relative;
            top: 10px;
        }

        .answer-group .answer-blank {
            margin: 0;
        }

        .variable-label {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
            border-bottom: 1px dotted #ccc;
            cursor: help;
            position: relative;
        }

        .variable-label:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            width: 220px;
            text-align: center;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            line-height: 1.4;
        }

        .variable-label:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
        }

        .print-btn {
            background-color: #ffda9e;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #555;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-family: 'Poppins', sans-serif;
        }

        .print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: #ffc978;
        }

        /* Auth Overlay */
        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .auth-box {
            background: white;
            padding: 3rem;
            border-radius: 24px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.15);
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.05);
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .auth-logo {
            height: 70px;
            margin-bottom: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .auth-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .auth-subtitle {
            color: #666;
            margin-bottom: 2.5rem;
            font-size: 1.1rem;
        }

        .auth-input {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 16px;
            border: 2px solid #f0f0f0;
            border-radius: 14px;
            font-size: 1rem;
            transition: all 0.2s;
            font-family: inherit;
            background: #fafafa;
        }

        .auth-input:focus {
            border-color: var(--primary-blue);
            background: #fff;
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
            font-family: inherit;
        }

        .auth-btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
            box-shadow: 0 10px 20px rgba(0, 123, 255, 0.2);
        }

        .btn-primary:hover {
            box-shadow: 0 15px 30px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-google {
            background: white;
            border: 2px solid #eee;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .btn-google:hover {
            background: #fafafa;
            border-color: #ddd;
        }

        .toggle-link {
            color: var(--primary-blue);
            cursor: pointer;
            font-size: 0.95rem;
            margin-top: 20px;
            display: inline-block;
            font-weight: 500;
        }

        .toggle-link:hover {
            text-decoration: underline;
        }

        .error-msg {
            color: #dc3545;
            font-size: 0.95rem;
            margin-bottom: 20px;
            min-height: 24px;
            font-weight: 500;
        }

        .legal-check {
            text-align: left;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
        }

        .legal-check input {
            margin-top: 4px;
        }

        /* Streak Display */
        #login-days-display {
            background: linear-gradient(135deg, #e7f5ff 0%, #d7eded 100%);
            color: #007bff;
            padding: 15px;
            border-radius: 14px;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
            font-size: 1.05rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
        }

        /* Admin Edit Buttons */
        .admin-controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 50;
        }

        .admin-edit-btn,
        .admin-duplicate-btn,
        .admin-delete-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .admin-edit-btn:hover {
            background: #e7f5ff;
            border-color: #007bff;
            color: #007bff;
        }

        .admin-duplicate-btn:hover {
            background: #fdfdfd;
            border-color: #555;
        }

        .admin-delete-btn:hover {
            background: #dc3545 !important;
            color: white !important;
            border-color: #dc3545 !important;
        }

        /* Worksheet Control Bar */
        .worksheet-control-bar {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 50;
        }

        /* Worksheet Question Card */
        .worksheet-question-card {
            background: #fff;
            border: 2px solid #e3f2fd;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .worksheet-question-card .question-number {
            position: absolute;
            top: -12px;
            left: 20px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 4px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .worksheet-question-card .remove-btn-wrapper {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        /* MCQ Option Styles */
        .mcq-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: white;
            border: 2px solid #eee;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mcq-option:hover {
            border-color: var(--primary-blue);
            background: var(--blue-light);
        }

        .mcq-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* MCQ Correct Answer Dropdown Fix */
        #mcq-correct {
            line-height: normal;
            padding-top: 5px;
            padding-bottom: 5px;
            appearance: auto;
        }

        /* Logout Button */
        .logout-btn {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #ffeae8;
            color: #dc3545;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #dc3545;
            color: white;
        }

        /* Mode Switcher */
        .mode-switcher {
            display: flex;
            gap: 5px;
            margin-bottom: 1.5rem;
            background: #eee;
            padding: 4px;
            border-radius: 30px;
        }

        .mode-switcher .btn {
            flex: 1;
            font-size: 0.8rem;
            padding: 8px;
            border-radius: 25px;
            background: transparent;
            color: #666;
        }

        .mode-switcher .btn.active {
            background: white;
            color: var(--primary-blue);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Version indicator (for debugging) */
        .version-indicator {
            position: fixed;
            bottom: 5px;
            right: 5px;
            font-size: 10px;
            color: #ccc;
            z-index: 9999;
        }

        /* Table Grid Selector (PowerPoint-style) */
        .table-grid-selector {
            position: fixed;
            background: white;
            border: 2px solid #81c784;
            border-radius: 12px;
            padding: 15px 18px 18px 18px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25), 0 0 0 4px rgba(129, 199, 132, 0.2);
            z-index: 10000;
            visibility: hidden;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }

        .table-grid-selector.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        /* Arrow pointing down to the button (default, when selector is above) */
        .table-grid-selector.arrow-down::after {
            content: '';
            position: absolute;
            bottom: -10px;
            top: auto;
            left: 50%;
            transform: translateX(-50%);
            border-width: 10px 10px 0 10px;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }
        
        .table-grid-selector.arrow-down::before {
            content: '';
            position: absolute;
            bottom: -13px;
            top: auto;
            left: 50%;
            transform: translateX(-50%);
            border-width: 12px 12px 0 12px;
            border-style: solid;
            border-color: #81c784 transparent transparent transparent;
        }
        
        /* Arrow pointing up to the button (when selector is below) */
        .table-grid-selector.arrow-up::after {
            content: '';
            position: absolute;
            top: -10px;
            bottom: auto;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 10px 10px 10px;
            border-style: solid;
            border-color: transparent transparent white transparent;
        }
        
        .table-grid-selector.arrow-up::before {
            content: '';
            position: absolute;
            top: -13px;
            bottom: auto;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 12px 12px 12px;
            border-style: solid;
            border-color: transparent transparent #81c784 transparent;
        }

        .table-grid-selector h4 {
            margin: 0 0 12px 0;
            font-size: 0.95rem;
            color: #333;
            font-weight: 600;
        }

        .table-grid {
            display: grid;
            grid-template-columns: repeat(8, 28px);
            grid-template-rows: repeat(8, 28px);
            gap: 3px;
            background: #f5f5f5;
            padding: 5px;
            border-radius: 6px;
        }

        .table-grid-cell {
            width: 28px;
            height: 28px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .table-grid-cell.selected {
            background: #81c784;
            border-color: #4caf50;
        }

        .table-grid-cell:hover {
            border-color: #4caf50;
        }

        .grid-size-label {
            text-align: center;
            margin-top: 12px;
            font-size: 0.9rem;
            color: #007bff;
            font-weight: 600;
        }

        /* Admin Table Editor */
        .admin-table-wrapper {
            margin-top: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .admin-table-container {
            overflow-x: auto;
            padding: 10px;
            background: white;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Century Gothic', 'Segoe UI', 'Poppins', sans-serif;
            font-size: 0.95rem;
        }

        .admin-table td,
        .admin-table th {
            border: 1px solid #bbb;
            padding: 10px 14px;
            min-width: 60px;
            position: relative;
            vertical-align: middle;
            word-wrap: break-word;
        }
        
        /* Multi-cell selection highlight */
        .admin-table td.cell-selected,
        .admin-table th.cell-selected {
            background-color: #bbdefb !important;
            outline: 2px solid #1976d2;
            outline-offset: -2px;
        }
        
        /* Selection styles */
        .admin-table td.selected-row,
        .admin-table th.selected-row {
            background-color: #e3f2fd !important;
            outline: 2px solid #2196f3;
            outline-offset: -2px;
        }
        
        .admin-table td.selected-col,
        .admin-table th.selected-col {
            background-color: #e8f5e9 !important;
            outline: 2px solid #4caf50;
            outline-offset: -2px;
        }
        
        .admin-table.selected-all td,
        .admin-table.selected-all th {
            background-color: #fff3e0 !important;
            outline: 2px solid #ff9800;
            outline-offset: -2px;
        }
        
        /* Merged cell indicator */
        .admin-table td.merged-cell,
        .admin-table th.merged-cell {
            background: linear-gradient(135deg, transparent 0%, transparent 95%, #1976d2 95%, #1976d2 100%);
        }
        
        /* Hidden cells (covered by merge) */
        .admin-table td.hidden-by-merge,
        .admin-table th.hidden-by-merge {
            display: none;
        }
        
        /* Resize overlay to capture mouse during drag */
        .table-resize-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 99999;
            cursor: col-resize;
        }
        
        .table-resize-overlay.row-resize {
            cursor: row-resize;
        }
        
        /* Selection overlay for drag selection */
        .table-selection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 99998;
            cursor: crosshair;
        }

        .admin-table td[contenteditable="true"],
        .admin-table th[contenteditable="true"] {
            outline: none;
            cursor: text;
        }

        .admin-table td[contenteditable="true"]:focus,
        .admin-table th[contenteditable="true"]:focus {
            box-shadow: inset 0 0 0 2px #007bff;
            background: #f8fbff !important;
        }

        .admin-table th {
            background: #e8e8e8;
            font-weight: 600;
        }

        .admin-table td.selected-cell,
        .admin-table th.selected-cell {
            outline: 3px solid #007bff;
            outline-offset: -3px;
        }

        /* Table Toolbar */
        .table-toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #ddd;
            align-items: center;
        }

        .table-toolbar-group {
            display: flex;
            gap: 5px;
            align-items: center;
            padding-right: 12px;
            border-right: 1px solid #ccc;
        }

        .table-toolbar-group:last-child {
            border-right: none;
        }

        .table-toolbar-group label {
            font-size: 0.75rem;
            color: #555;
            margin-right: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-toolbar button {
            padding: 7px 12px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .table-toolbar button:hover {
            background: #e7f5ff;
            border-color: #007bff;
            transform: translateY(-1px);
        }

        .table-toolbar button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .table-toolbar button.danger {
            color: #dc3545;
        }

        .table-toolbar button.danger:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        /* Pastel Color Palette */
        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 28px);
            gap: 5px;
        }

        .color-swatch {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .color-swatch:hover {
            transform: scale(1.15);
            border-color: #555;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .color-swatch.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }

        /* Color picker dropdown */
        .color-picker-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.18);
            z-index: 1002;
            display: none;
        }

        .color-picker-dropdown.visible {
            display: block;
        }

        .color-picker-dropdown h5 {
            margin: 0 0 10px 0;
            font-size: 0.8rem;
            color: #555;
            font-weight: 600;
        }

        /* Row/Column highlight on hover */
        .admin-table tr:hover td {
            background-color: rgba(0, 123, 255, 0.05);
        }

        /* Add Table Button */
        .add-block-btn.table-btn {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #81c784;
            color: #2e7d32;
        }

        .add-block-btn.table-btn:hover {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            border-color: #66bb6a;
        }

        .table-grid {
            display: grid;
            grid-template-columns: repeat(8, 24px);
            grid-template-rows: repeat(8, 24px);
            gap: 2px;
        }

        .table-grid-cell {
            width: 24px;
            height: 24px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.1s;
        }

        .table-grid-cell.selected {
            background: #AEC6CF;
            border-color: #8eb3be;
        }

        .table-grid-cell:hover {
            background: #d7eded;
        }

        .grid-size-label {
            text-align: center;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        /* Admin Table Editor */
        .admin-table-container {
            margin-top: 10px;
            overflow-x: auto;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Century Gothic', 'Poppins', sans-serif;
        }

        .admin-table td,
        .admin-table th {
            border: 1px solid #ccc;
            padding: 8px 12px;
            min-width: 80px;
            position: relative;
        }

        .admin-table td[contenteditable="true"],
        .admin-table th[contenteditable="true"] {
            outline: none;
        }

        .admin-table td[contenteditable="true"]:focus,
        .admin-table th[contenteditable="true"]:focus {
            box-shadow: inset 0 0 0 2px #007bff;
        }

        .admin-table th {
            background: #f0f0f0;
            font-weight: 600;
        }

        /* Table Toolbar */
        .table-toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            align-items: center;
        }

        .table-toolbar-group {
            display: flex;
            gap: 4px;
            align-items: center;
            padding-right: 10px;
            border-right: 1px solid #ddd;
        }

        .table-toolbar-group:last-child {
            border-right: none;
        }

        .table-toolbar-group label {
            font-size: 0.75rem;
            color: #666;
            margin-right: 5px;
        }

        .table-toolbar button {
            padding: 6px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .table-toolbar button:hover {
            background: #e7f5ff;
            border-color: #007bff;
        }

        .table-toolbar button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Pastel Color Palette */
        .color-palette {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            max-width: 200px;
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            border-color: #333;
        }

        .color-swatch.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }

        /* Row/Column Selection */
        .admin-table tr.row-selected td,
        .admin-table tr.row-selected th {
            outline: 2px solid #007bff;
            outline-offset: -2px;
        }

        .admin-table td.col-selected,
        .admin-table th.col-selected {
            outline: 2px solid #28a745;
            outline-offset: -2px;
        }

        /* Color picker dropdown */
        .color-picker-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 1001;
            display: none;
        }

        .color-picker-dropdown.visible {
            display: block;
        }

        .color-picker-dropdown h5 {
            margin: 0 0 8px 0;
            font-size: 0.8rem;
            color: #555;
        }

        /* --- PRINT STYLES --- */
        @media print {

            /* Hide all UI elements */
            .app-header,
            .sidebar,
            .controls,
            .admin-controls,
            .btn-worksheet-add,
            .worksheet-control-bar,
            .worksheet-actions,
            .print-btn,
            .next-btn,
            .submit-btn,
            .variable-label,
            .logout-btn,
            .mode-switcher,
            #tab-admin,
            #auth-overlay,
            .remove-btn-wrapper,
            .btn-worksheet-remove,
            .version-indicator {
                display: none !important;
            }

            /* Reset body */
            body {
                padding: 0 !important;
                background: white !important;
                margin: 0 !important;
                color: black !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Reset containers */
            .app-container,
            .app-body,
            #main-content-area {
                display: block !important;
                overflow: visible !important;
                height: auto !important;
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                position: static !important;
                background: white !important;
            }

            /* Hide all views by default */
            .view-content {
                display: none !important;
            }

            /* Show ONLY the worksheet view when printing worksheet */
            body.print-worksheet #view-worksheet {
                display: block !important;
                visibility: visible !important;
                padding: 20px !important;
            }

            body.print-worksheet #view-worksheet * {
                visibility: visible !important;
            }

            /* Hide worksheet header in non-print, show in print */
            #worksheet-header {
                display: none;
            }

            body.print-worksheet #worksheet-header {
                display: block !important;
                visibility: visible !important;
                margin-bottom: 2rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid #000;
            }

            /* Question container print styles */
            .worksheet-question-card {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                margin-bottom: 2rem !important;
                padding: 1.5rem !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                background: white !important;
            }

            .worksheet-question-card .question-number {
                background: #333 !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Answer box print styles */
            .answer-box {
                background: #f9f9f9 !important;
                border: 1px solid #ddd !important;
                padding: 1.5rem !important;
                margin-top: 1rem !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Answer input lines for handwriting */
            .answer-input {
                border: none !important;
                border-bottom: 1.5px solid #000 !important;
                background: transparent !important;
                min-width: 150px !important;
                height: 25px !important;
                padding: 0 !important;
                display: inline-block !important;
            }

            /* CER segments print */
            .cer-segment {
                border: 1px solid #ccc !important;
                margin-bottom: 1rem !important;
                padding: 1rem !important;
                background: white !important;
            }

            .cer-segment::after {
                background: white !important;
                color: #666 !important;
            }

            /* Table print styles */
            .results-table {
                width: 100% !important;
                border-collapse: collapse !important;
            }

            .results-table th {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .results-table th,
            .results-table td {
                border: 1px solid #333 !important;
                padding: 8px !important;
            }

            /* Images print */
            .question-diagram {
                max-width: 400px !important;
                page-break-inside: avoid !important;
            }

            /* MCQ print styles */
            .mcq-option {
                border: none !important;
                background: transparent !important;
                padding: 8px 0 !important;
                display: block !important;
                page-break-inside: avoid;
            }

            .mcq-option input {
                display: none !important;
            }

            .mcq-option span::before {
                content: "â—‹ ";
                font-size: 1.2rem;
            }

            /* Hide empty placeholder */
            #worksheet-empty-msg {
                display: none !important;
            }

            /* Print all questions mode */
            body.print-all .view-content.active {
                display: block !important;
            }

            body.print-all .topic-content:not(.hidden) {
                display: block !important;
            }

            body.print-all .question-container {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                margin-bottom: 2rem !important;
                padding: 1.5rem !important;
                border: 1px solid #ddd !important;
            }

            /* Single question print */
            body.print-single .question-container:not(.printing) {
                display: none !important;
            }

            body.print-single .question-container.printing {
                display: block !important;
                break-inside: avoid !important;
            }
        }

        /* Save Worksheet Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-box {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.visible .modal-box {
            transform: translateY(0);
        }

        .modal-box h3 {
            margin: 0 0 1.5rem;
            color: var(--primary-blue);
            font-size: 1.4rem;
        }

        .modal-box .form-group {
            margin-bottom: 1.5rem;
        }

        .modal-box label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .modal-box input, .modal-box textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .modal-box input:focus, .modal-box textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .modal-box .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .modal-box .btn-cancel {
            background: #f5f5f5;
            color: #666;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .modal-box .btn-save {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .modal-box .btn-save:hover {
            background: #1565c0;
        }

        /* Saved Worksheet Card */
        .saved-worksheet-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #388e3c;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .saved-worksheet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .saved-worksheet-card h4 {
            margin: 0 0 0.5rem;
            color: #333;
            font-size: 1.2rem;
        }

        .saved-worksheet-card .meta {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .saved-worksheet-card .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Lesson Card */
        .lesson-card {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #f57c00;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .lesson-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .lesson-card h4 {
            margin: 0 0 0.5rem;
            color: #e65100;
            font-size: 1.3rem;
        }

        .lesson-card .meta {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .lesson-card .description {
            color: #444;
            font-size: 0.95rem;
        }

        .lesson-card .badge {
            display: inline-block;
            background: #f57c00;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        /* Lesson Detail */
        .lesson-video-container {
            margin-bottom: 2rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .lesson-video-container iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .lesson-questions-section {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .lesson-questions-section h3 {
            margin: 0 0 1.5rem;
            color: #333;
        }

        /* Student Entry Styles */
        .student-entry {
            transition: all 0.3s ease;
        }

        .add-student-btn:hover {
            background: #bbdefb !important;
        }

        /* Practice Mode Styles */
        #practice-question-content .question-container {
            margin-bottom: 0;
            box-shadow: none;
            border: none;
            padding: 0;
        }

        #practice-question-content .mcq-option,
        #practice-question-content label {
            transition: all 0.2s ease;
        }

        .practice-progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .practice-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7b1fa2, #9c27b0);
            transition: width 0.3s ease;
        }

        /* Inbox Badge */
        .inbox-badge {
            background: #dc3545;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: bold;
        }

        /* Inbox Tabs */
        .inbox-tab {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .inbox-tab:hover {
            border-color: #0288d1;
        }

        .inbox-tab.active {
            background: #0288d1;
            color: white;
            border-color: #0288d1;
        }

        /* Message Card */
        .message-card {
            background: white;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #0288d1;
        }

        .message-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .message-card.unread {
            background: #e3f2fd;
            border-left-color: #f57c00;
        }

        .message-card .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .message-card .message-from {
            font-weight: 600;
            color: #333;
        }

        .message-card .message-date {
            font-size: 0.8rem;
            color: #888;
        }

        .message-card .message-subject {
            font-weight: 600;
            color: #0288d1;
            margin-bottom: 0.3rem;
        }

        .message-card .message-preview {
            color: #666;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .message-card .unread-dot {
            width: 10px;
            height: 10px;
            background: #f57c00;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        /* Inbox Empty State */
        .inbox-empty {
            text-align: center;
            padding: 3rem;
            color: #888;
        }

        /* Consult Button */
        .consult-btn {
            background: linear-gradient(135deg, #0288d1, #03a9f4);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .consult-btn:hover {
            background: linear-gradient(135deg, #0277bd, #0288d1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(2, 136, 209, 0.3);
        }

        /* View Message Modal Content */
        .view-message-header {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .view-message-body {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 8px;
            min-height: 100px;
            white-space: pre-wrap;
        }

        .view-message-question {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #0288d1;
            font-size: 0.9rem;
        }

        /* =====================================================
           MOBILE MENU TOGGLE BUTTON
           ===================================================== */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1976d2, #2196f3);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .mobile-menu-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5);
        }

        .mobile-menu-toggle.active {
            background: linear-gradient(135deg, #d32f2f, #f44336);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
        }

        /* =====================================================
           TABLET STYLES (768px - 1024px)
           ===================================================== */
        @media screen and (max-width: 1024px) {
            body {
                padding: 1rem;
            }

            .app-container {
                max-width: 100%;
            }

            .sidebar {
                width: 220px;
                padding: 1.5rem;
            }

            .main-content,
            .view-content,
            .topic-content {
                padding: 1.5rem 2rem;
            }

            .tab-btn {
                padding: 0.4rem 0.7rem;
                font-size: 0.75rem;
            }

            .app-logo {
                height: 40px;
            }

            .question-container {
                padding: 1.25rem;
                margin-bottom: 2rem;
            }

            .answer-box {
                padding: 1.5rem;
            }

            .modal-box {
                width: 95%;
                max-width: 600px;
                padding: 1.5rem;
            }
        }

        /* =====================================================
           MOBILE STYLES (max-width: 768px)
           ===================================================== */
        @media screen and (max-width: 768px) {
            body {
                padding: 0;
                align-items: stretch;
            }

            .app-container {
                border-radius: 0;
                box-shadow: none;
                min-height: 100vh;
            }

            /* Show mobile menu toggle */
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .sidebar-overlay {
                display: block;
                pointer-events: none;
            }

            .sidebar-overlay.active {
                pointer-events: auto;
            }

            /* Sidebar - slide in from left */
            .app-body > .sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                width: 280px;
                height: 100vh;
                z-index: 9999;
                padding: 1.5rem;
                padding-top: 2rem;
                overflow-y: auto;
                transition: left 0.3s ease;
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            }

            .app-body > .sidebar.mobile-open {
                left: 0;
            }

            /* Show close button in mobile sidebar */
            .app-body > .sidebar .mobile-sidebar-close {
                display: block !important;
            }

            /* Header adjustments */
            .app-header {
                padding: 0.5rem 0.75rem 0;
            }

            .app-logo {
                height: 35px;
            }

            #header-tabs-container {
                overflow-x: auto;
                overflow-y: hidden;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                padding-bottom: 2px;
            }

            #header-tabs-container::-webkit-scrollbar {
                display: none;
            }

            .tab-btn {
                padding: 0.35rem 0.6rem;
                font-size: 0.7rem;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Main content area */
            .app-body {
                flex-direction: column;
            }

            .main-content,
            .view-content,
            .topic-content {
                padding: 1rem;
            }

            /* Question container */
            .question-container {
                padding: 1rem;
                margin-bottom: 1.5rem;
                border-radius: 10px;
            }

            .question-container h3 {
                font-size: 1rem;
            }

            .main-content p,
            .question-container p {
                font-size: 0.95rem;
                line-height: 1.6;
            }

            /* Answer box */
            .answer-box {
                padding: 1rem;
                border-radius: 10px;
            }

            .answer-template {
                font-size: 0.95rem;
                line-height: 1.8;
            }

            .answer-input {
                font-size: 0.95rem;
                min-width: 60px;
            }

            /* Buttons */
            .btn, .submit-btn, .next-btn {
                padding: 12px 20px;
                font-size: 0.95rem;
                min-height: 44px;
            }

            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .controls button {
                width: 100%;
            }

            /* Worksheet control bar */
            .worksheet-control-bar {
                flex-direction: column;
                gap: 8px;
            }

            .worksheet-control-bar button {
                width: 100%;
            }

            /* MCQ Options */
            .mcq-option, .mcq-container label {
                padding: 12px 15px;
                font-size: 0.95rem;
                min-height: 48px;
            }

            /* Tables - horizontal scroll */
            .results-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .results-table th,
            .results-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
                white-space: nowrap;
            }

            /* Images */
            .question-diagram {
                max-width: 100%;
            }

            /* Modal - full screen on mobile */
            .modal-overlay {
                padding: 0;
            }

            .modal-box {
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
                padding: 1rem;
                overflow-y: auto;
            }

            .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .modal-buttons button {
                width: 100%;
            }

            /* Auth box */
            .auth-box {
                width: 95%;
                padding: 1.5rem;
                border-radius: 16px;
            }

            .auth-input {
                padding: 14px 16px;
                font-size: 1rem;
            }

            .auth-btn {
                padding: 14px;
                font-size: 1rem;
            }

            /* Sidebar buttons */
            .sidebar button,
            .sidebar-nav button {
                padding: 12px 16px;
                font-size: 0.95rem;
            }

            /* Practice mode stats */
            #practice-stats {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Inbox */
            .message-card {
                padding: 1rem;
            }

            .message-header {
                flex-direction: column;
                gap: 5px;
            }

            .inbox-tab {
                padding: 8px 16px;
                font-size: 0.9rem;
            }

            /* Admin form */
            .admin-form-section {
                padding: 1rem;
            }

            .admin-form-section input,
            .admin-form-section select,
            .admin-form-section textarea {
                font-size: 1rem;
            }

            /* Lesson cards */
            .lesson-card {
                padding: 1rem;
            }

            .lesson-video-container iframe {
                height: 250px;
            }

            /* Login days display */
            #login-days-display {
                font-size: 0.9rem;
                padding: 8px;
            }

            /* Mode switcher */
            .mode-switcher {
                flex-direction: row;
            }

            .mode-switcher button {
                flex: 1;
                padding: 10px;
            }

            /* Saved worksheets */
            .saved-worksheet-card .actions {
                flex-direction: column;
            }

            .saved-worksheet-card .actions button {
                width: 100%;
            }

            /* Explanation box */
            .explanation-box {
                padding: 1rem;
                font-size: 0.9rem;
            }

            /* CER segments */
            .cer-segment {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .segment-title {
                font-size: 0.95rem;
            }

            /* OEQ Sidebar Content */
            #oeq-sidebar-content h2,
            #mcq-sidebar-content h2 {
                font-size: 1.1rem;
            }

            /* Student entry in registration */
            .student-entry > div {
                flex-direction: column !important;
            }

            .student-entry .auth-input {
                width: 100% !important;
            }

            /* Version indicator */
            .version-indicator {
                font-size: 0.6rem;
                padding: 2px 6px;
            }
        }

        /* =====================================================
           SMALL MOBILE STYLES (max-width: 480px)
           ===================================================== */
        @media screen and (max-width: 480px) {
            .tab-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.65rem;
            }

            .app-logo {
                height: 30px;
            }

            .question-container {
                padding: 0.75rem;
            }

            .answer-box {
                padding: 0.75rem;
            }

            .answer-template {
                font-size: 0.9rem;
            }

            .answer-input {
                font-size: 0.9rem;
                min-width: 50px;
            }

            #practice-stats {
                grid-template-columns: 1fr 1fr !important;
                gap: 0.5rem;
            }

            #practice-stats > div {
                padding: 0.75rem;
            }

            #practice-stats > div > div:first-child {
                font-size: 1.5rem;
            }

            .modal-box {
                padding: 0.75rem;
            }

            .modal-box h3 {
                font-size: 1.1rem;
            }

            .auth-box {
                padding: 1rem;
            }

            .auth-logo {
                width: 60px;
                height: 60px;
            }

            .auth-title {
                font-size: 1.3rem;
            }

            .legal-check label {
                font-size: 0.75rem;
            }
        }

        /* =====================================================
           LANDSCAPE ORIENTATION FIXES
           ===================================================== */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .modal-box {
                max-height: 95vh;
                overflow-y: auto;
            }

            .auth-box {
                max-height: 95vh;
                overflow-y: auto;
            }
        }

        /* =====================================================
           IPAD SPECIFIC STYLES
           ===================================================== */
        @media screen and (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            .sidebar {
                width: 200px;
            }

            .main-content,
            .view-content,
            .topic-content {
                padding: 1.5rem;
            }

            #practice-stats {
                grid-template-columns: repeat(4, 1fr) !important;
            }
        }

        @media screen and (min-width: 1024px) and (max-width: 1366px) and (orientation: landscape) {
            /* iPad Pro landscape */
            .sidebar {
                width: 230px;
            }
        }

        /* =====================================================
           TOUCH DEVICE OPTIMIZATIONS
           ===================================================== */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            .btn, button, .tab-btn, .sidebar-nav button {
                min-height: 44px;
            }

            .mcq-option, .mcq-container label {
                min-height: 48px;
            }

            /* Remove hover effects that don't work well on touch */
            .tab-btn:hover,
            .sidebar-nav button:hover,
            .btn:hover {
                transform: none;
            }

            /* Better tap feedback */
            .btn:active, button:active {
                transform: scale(0.98);
                opacity: 0.9;
            }

            /* Prevent text selection on buttons */
            button, .btn, .tab-btn {
                -webkit-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
            }

            /* Improve scrolling */
            .main-content, .view-content, .topic-content {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* =====================================================
           SAFE AREA INSETS (for notched devices)
           ===================================================== */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }

            .mobile-menu-toggle {
                bottom: max(20px, calc(env(safe-area-inset-bottom) + 10px));
                right: max(20px, calc(env(safe-area-inset-right) + 10px));
            }

            .app-body > .sidebar {
                padding-bottom: max(1.5rem, calc(env(safe-area-inset-bottom) + 1rem));
            }
        }

        /* =====================================================
           ADDITIONAL MOBILE FIXES
           ===================================================== */
        @media screen and (max-width: 768px) {
            /* Fix for iOS input zoom */
            input, select, textarea {
                font-size: 16px !important;
            }

            /* Ensure forms don't overflow */
            .form-group input,
            .form-group select,
            .form-group textarea,
            .auth-input {
                max-width: 100%;
                box-sizing: border-box;
            }

            /* Fix horizontal scroll issues */
            html, body {
                overflow-x: hidden;
                width: 100%;
            }

            .app-container {
                overflow-x: hidden;
            }

            /* Better table display on mobile */
            table {
                font-size: 0.85rem;
            }

            /* Improve question text readability */
            .question-container p {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            /* Fix image overflow */
            img {
                max-width: 100%;
                height: auto;
            }

            /* Admin controls layout */
            .admin-controls {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .admin-controls button {
                flex: 1 1 auto;
                min-width: 100px;
            }

            /* OEQ segment inputs */
            .segment-input, .cer-textarea {
                font-size: 16px;
                min-height: 80px;
            }

            /* Topic buttons in sidebar */
            #oeq-sidebar-content .topic-link,
            #mcq-sidebar-content .topic-link {
                padding: 12px;
                font-size: 0.9rem;
            }

            /* Header tabs scrollable indicator */
            #header-tabs-container::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to right, transparent, #f8f9fa);
                pointer-events: none;
            }

            /* Question popup modal fix */
            #question-popup-modal .modal-box {
                max-height: calc(100vh - 20px);
            }

            /* Consult modal fix */
            #consult-modal .modal-box,
            #new-message-modal .modal-box,
            #view-message-modal .modal-box {
                max-height: calc(100vh - 20px);
                overflow-y: auto;
            }
        }

        /* =====================================================
           IPAD PRO AND LARGE TABLET STYLES
           ===================================================== */
        @media screen and (min-width: 1024px) and (max-width: 1400px) {
            .sidebar {
                width: 240px;
            }

            .main-content,
            .view-content,
            .topic-content {
                padding: 2rem;
            }

            .tab-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.78rem;
            }
        }

        /* =====================================================
           PREVENT PULL-TO-REFRESH ON MOBILE
           ===================================================== */
        body {
            overscroll-behavior-y: contain;
        }

        /* =====================================================
           FIX FOR 100VH ON MOBILE BROWSERS
           ===================================================== */
        @media screen and (max-width: 768px) {
            .modal-overlay {
                height: 100%;
                height: -webkit-fill-available;
            }

            .auth-overlay {
                min-height: 100%;
                min-height: -webkit-fill-available;
            }
        }

        /* =====================================================
           PRINT STYLES - HIDE MOBILE ELEMENTS
           ===================================================== */
        @media print {
            .mobile-menu-toggle,
            .sidebar-overlay {
                display: none !important;
            }
        }
    </style>
</head>

<body>

    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" onclick="toggleMobileSidebar()">
        <span id="mobile-menu-icon">â˜°</span>
    </button>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeMobileSidebar()"></div>

    <!-- Version Indicator for debugging -->
    <div class="version-indicator" id="version-display"></div>

    <!-- Auth Overlay -->
    <div id="auth-overlay">
        <div class="auth-box">
            <img src="https://www.dropbox.com/scl/fi/h40yjlyg8ldefwfaa3dib/polymath-logo-sticker.png?rlkey=o1ra4taqy79gt9t8u096v82zj&raw=1"
                alt="Polymath Logo" class="auth-logo">
            <h2 id="auth-title" class="auth-title">Welcome Back!</h2>
            <p class="auth-subtitle">Sign in to continue your learning journey</p>

            <div class="error-msg" id="auth-error"></div>

            <input type="email" id="auth-email" class="auth-input" placeholder="Email Address">
            <input type="password" id="auth-pass" class="auth-input" placeholder="Password">

            <div id="forgot-password-link" style="text-align: right; margin-bottom: 20px; margin-top: -10px;">
                <span class="toggle-link" onclick="handleForgotPassword()" style="font-size: 0.85rem;">Forgot
                    Password?</span>
            </div>

            <!-- Registration Fields (Hidden by default) -->
            <div id="reg-fields" style="display: none;">
                <input type="text" id="parent-name" class="auth-input" placeholder="Parent's Name">
                
                <div id="students-container">
                    <div class="student-entry" data-student-index="0">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" class="auth-input student-name" placeholder="Student's Name" style="flex: 1; margin-bottom: 0;">
                            <select class="auth-input student-level" style="width: 100px; margin-bottom: 0;">
                                <option value="">Level</option>
                                <option value="P3">P3</option>
                                <option value="P4">P4</option>
                                <option value="P5">P5</option>
                                <option value="P6">P6</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button type="button" onclick="addStudentEntry()" class="add-student-btn" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #e3f2fd; border: 2px dashed #1976d2; border-radius: 8px; color: #1976d2; font-weight: 600; cursor: pointer;">
                    âž• Add Another Student
                </button>
            </div>

            <div id="legal-box" class="legal-check" style="display: none;">
                <input type="checkbox" id="legal-agree">
                <label for="legal-agree" style="font-size: 0.85rem; line-height: 1.4;">
                    By registering, logging in, and using this system, I confirm that I am a parent/guardian and agree to be liable for the tuition fees of the current month or whichever period is applicable. I acknowledge that Polymath Learning Centre reserves the right to change any aspect of this system at any time and may remove access to any student without prior notice at any time.
                </label>
            </div>

            <button onclick="handleLogin()" id="btn-login" class="auth-btn btn-primary">Login</button>
            <button onclick="handleGoogleLogin()" id="btn-google" class="auth-btn btn-google">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Sign in with
                Google
            </button>

            <span class="toggle-link" onclick="toggleAuthMode()">New here? Create an Account</span>
        </div>
    </div>

    <div class="app-container">
        <header class="app-header">
            <div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.3rem;">
                <img src="https://www.dropbox.com/scl/fi/h40yjlyg8ldefwfaa3dib/polymath-logo-sticker.png?rlkey=o1ra4taqy79gt9t8u096v82zj&raw=1"
                    alt="Polymath Logo" class="app-logo">
                <button class="print-btn" onclick="printAll()">ðŸ–¨ï¸ Print All</button>
            </div>
            <div id="header-tabs-container">
                <button class="tab-btn active" data-type="cer" onclick="switchTab('cer', this)">CER</button><button class="tab-btn" data-type="definition"
                    onclick="switchTab('definition', this)">Definition</button><button class="tab-btn" data-type="single-relationship"
                    onclick="switchTab('single-relationship', this)">Single Relationship</button><button class="tab-btn" data-type="double-relationship"
                    onclick="switchTab('double-relationship', this)">Double Relationship</button><button class="tab-btn" data-type="fairness" onclick="switchTab('fairness', this)">Fairness</button><button class="tab-btn" data-type="reliability"
                    onclick="switchTab('reliability', this)">Reliability</button><button class="tab-btn" data-type="accuracy" onclick="switchTab('accuracy', this)">Accuracy</button><button class="tab-btn" data-type="constant-variable"
                    onclick="switchTab('constant-variable', this)">Constant Variable</button><button class="tab-btn" data-type="explanation"
                    onclick="switchTab('explanation', this)">Explanation</button><button class="tab-btn" data-type="control-setup" onclick="switchTab('control-setup', this)">Control Set-up</button>
            </div>
        </header>
        
        <!-- Colored line that changes based on active tab -->
        <div class="header-color-line" id="header-color-line" style="background: linear-gradient(90deg, #AEC6CF 0%, #c4d6dd 50%, #AEC6CF 100%);"></div>

        <!-- Save Worksheet Modal -->
        <div id="save-worksheet-modal" class="modal-overlay">
            <div class="modal-box">
                <h3 id="save-worksheet-modal-title">ðŸ’¾ Save Worksheet</h3>
                <div class="form-group">
                    <label for="worksheet-name-input">Worksheet Name *</label>
                    <input type="text" id="worksheet-name-input" placeholder="e.g., Heat Chapter Review">
                </div>
                <div class="form-group">
                    <label for="worksheet-description-input">Description (optional)</label>
                    <textarea id="worksheet-description-input" rows="2" placeholder="Brief description of this worksheet..."></textarea>
                </div>
                <div id="admin-lesson-fields" class="hidden">
                    <div class="form-group">
                        <label for="lesson-video-input">ðŸ“¹ Video Link (YouTube) *</label>
                        <input type="text" id="lesson-video-input" placeholder="https://youtube.com/watch?v=...">
                    </div>
                    <div class="form-group" style="background: #fff3e0; padding: 10px; border-radius: 8px; border-left: 4px solid #f57c00;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="share-as-lesson-checkbox" style="width: auto; margin: 0;">
                            <span>ðŸŽ“ Share as Lesson (visible to all students)</span>
                        </label>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="hideSaveWorksheetModal()">Cancel</button>
                    <button class="btn-save" onclick="saveWorksheet()">Save</button>
                </div>
            </div>
        </div>

        <div class="app-body active" style="display: flex;">
            <aside class="sidebar">
                <button class="mobile-sidebar-close" onclick="closeMobileSidebar()" style="display: none; position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.2rem; cursor: pointer; z-index: 10;">âœ•</button>
                <div id="login-days-display">ðŸ“… Loading Streak...</div>
                <button onclick="handleLogout()" class="logout-btn">Logout</button>

                <button id="btn-sidebar-admin" class="hidden" onclick="switchTab('admin', this)"
                    style="width: 100%; border-radius: 10px; margin-bottom: 10px; background: #ffd1dc; color: #d81b60; border: none; padding: 10px; cursor: pointer; font-weight: 600;">ðŸ› ï¸
                    Admin Mode</button>

                <button id="btn-sidebar-worksheet" onclick="switchTab('worksheet', this)"
                    style="width: 100%; border-radius: 10px; margin-bottom: 10px; background: #e3f2fd; color: #1976d2; border: none; padding: 10px; cursor: pointer; font-weight: 600;">ðŸ“
                    My Worksheet <span id="worksheet-count" class="worksheet-badge">0</span></button>

                <button id="btn-sidebar-saved-worksheets" onclick="switchTab('saved-worksheets', this)"
                    style="width: 100%; border-radius: 10px; margin-bottom: 10px; background: #e8f5e9; color: #388e3c; border: none; padding: 10px; cursor: pointer; font-weight: 600;">ðŸ“š
                    Saved Worksheets</button>

                <button id="btn-sidebar-practice" onclick="switchTab('practice', this)"
                    style="width: 100%; border-radius: 10px; margin-bottom: 10px; background: #f3e5f5; color: #7b1fa2; border: none; padding: 10px; cursor: pointer; font-weight: 600;">ðŸŽ¯
                    Practice Mode</button>

                <button id="btn-sidebar-inbox" onclick="switchTab('inbox', this)"
                    style="width: 100%; border-radius: 10px; margin-bottom: 10px; background: #e1f5fe; color: #0288d1; border: none; padding: 10px; cursor: pointer; font-weight: 600; position: relative;">ðŸ“¬
                    Inbox <span id="inbox-badge" class="inbox-badge" style="display: none;">0</span></button>

                <button id="btn-sidebar-lessons" onclick="switchTab('lessons', this)"
                    style="width: 100%; border-radius: 10px; margin-bottom: 20px; background: #fff3e0; color: #f57c00; border: none; padding: 10px; cursor: pointer; font-weight: 600;">ðŸŽ“
                    Lessons</button>

                <div class="mode-switcher">
                    <button onclick="switchMode('oeq')" id="mode-oeq" class="btn active">OEQ</button>
                    <button onclick="switchMode('mcq')" id="mode-mcq" class="btn">MCQ</button>
                </div>

                <div id="oeq-sidebar-content">
                    <h2 id="oeq-title">OEQ Questions</h2>
                    <nav id="oeq-topic-nav" class="sidebar-nav">
                        <!-- Dynamic topic buttons will be populated here -->
                    </nav>
                </div>

                <div id="mcq-sidebar-content" class="hidden">
                    <h2 style="margin-bottom: 0.5rem;">MCQ Level</h2>
                    <select id="mcq-level-select" onchange="window.currentMcqLevel = this.value; renderMcqHeaders();"
                        class="auth-input"
                        style="height: 40px; margin-bottom: 1rem; border-radius: 8px; padding: 5px 10px; font-size: 0.9rem;">
                        <option value="P3">Primary 3</option>
                        <option value="P4">Primary 4</option>
                        <option value="P5">Primary 5</option>
                        <option value="P6">Primary 6</option>
                    </select>
                    <h2 id="mcq-topic-label" style="font-size: 1rem; color: #666; margin-bottom: 1rem;">Questions</h2>
                    <nav id="mcq-question-nav" class="sidebar-nav">
                        <!-- Dynamic Question Buttons (Q1, Q2...) -->
                    </nav>
                </div>
            </aside>

            <main id="main-content-area" style="flex: 1; overflow-y: auto;">

                <!-- View: CER (Existing - Part of OEQ) -->
                <div id="view-cer" class="view-content active">
                    <!-- TOPIC: HEAT -->
                    <div id="topic-heat" class="topic-content hidden">
                        <!-- Question 1: Heat -->
                        <div id="heat-question-1" class="question-container">
                            <h3>Question 1</h3>
                            <p>Peter conducted an experiment to find out how the materials of bowls affect the time
                                taken for the water in them to cool down. He measured the temperature of the water in
                                the three bowls every two minutes and recorded it in the table.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2" style="vertical-align: middle;">Time (min)</th>
                                        <th colspan="3">Temperature of Water (Â°C)</th>
                                    </tr>
                                    <tr>
                                        <th>Bowl A</th>
                                        <th>Bowl B</th>
                                        <th>Bowl C</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>0</td>
                                        <td>80</td>
                                        <td>80</td>
                                        <td>80</td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>79</td>
                                        <td>74</td>
                                        <td>78</td>
                                    </tr>
                                    <tr>
                                        <td>4</td>
                                        <td>78</td>
                                        <td>68</td>
                                        <td>74</td>
                                    </tr>
                                    <tr>
                                        <td>6</td>
                                        <td>78</td>
                                        <td>61</td>
                                        <td>72</td>
                                    </tr>
                                    <tr>
                                        <td>8</td>
                                        <td>76</td>
                                        <td>55</td>
                                        <td>69</td>
                                    </tr>
                                    <tr>
                                        <td>10</td>
                                        <td>74</td>
                                        <td>49</td>
                                        <td>66</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Which bowl is the most suitable for storing frozen ice-cream?
                                Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="heat-form-1">
                                    <div class="cer-segment" data-label="claim">Bowl<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="A"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The temperature of water in bowl A
                                        decreased by the<div class="answer-blank"><input type="text"
                                                class="answer-input" data-answer="least"></div> amount,<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that bowl A is the poorest
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                style="width: 120px;" data-answer="conductor"></div>of<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="heat"></div>, allowing the ice-cream to<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="gain"></div>heat from the warmer surrounding air slowest to
                                        melt the slowest.<span class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)">ðŸ–¨ï¸ Print</button>
                                    <button class="next-btn btn hidden">Next Question</button>
                                </div>
                            </div>
                        </div>

                        <!-- Question 2: Heat -->
                        <div id="heat-question-2" class="question-container">
                            <h3>Question 2</h3>
                            <p>Warren conducted an experiment on three solid blocks made of materials, A, B and C, of
                                the same size and thickness. He heated the three materials and measured the time taken
                                for each to increase from 30Â°C to 50Â°C. The table below shows his results.</p>
                            <img src="https://www.dropbox.com/scl/fi/tsjlvlar0etwnhd3wyple/Screenshot-2025-10-18-at-8.42.36-AM.png?rlkey=l15xphdym7bmg352669a8ykt1&raw=1"
                                alt="Cooler Box Experiment Diagram" class="question-diagram">
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Materials</th>
                                        <th>Time taken for the experiment (second)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>A</td>
                                        <td>50</td>
                                    </tr>
                                    <tr>
                                        <td>B</td>
                                        <td>80</td>
                                    </tr>
                                    <tr>
                                        <td>C</td>
                                        <td>35</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Which material A, B or C, should Warren choose to keep the ice
                                cold for the longest time? Explain why.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="heat-form-2">
                                    <div class="cer-segment" data-label="claim">Material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="B"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The time taken for the temperature of
                                        the block made of material B to increase from 30Â°C to 50Â°C is the<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="longest"></div>,<span class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that material B is the
                                        poorest<div class="answer-blank"><input type="text" class="answer-input"
                                                style="width: 120px;" data-answer="conductor"></div>of<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="heat"></div>, allowing the ice in the ice box to<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="gain"></div>heat from the warmer surrounding air<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="slowest"></div>to melt<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="slowest"></div>.<span
                                            class="feedback-icon"></span></div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)">ðŸ–¨ï¸ Print</button>
                                    <button class="next-btn btn hidden">Next Question</button>
                                </div>
                            </div>
                        </div>

                        <!-- Question 3: Heat (Jarrell/Double-Glazed) -->
                        <div id="heat-question-3" class="question-container">
                            <h3>Question 3</h3>
                            <p>Jarrell wanted to investigate which glass, A or B, keeps water cold for a longer time.
                                Both glasses were made of the same material.</p>
                            <p>He measured the temperature of water in each glass at the start of the experiment and
                                every 10 minutes for 50 minutes. He plotted the results in the graph.</p>
                            <div style="display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-start;">
                                <img src="https://www.dropbox.com/scl/fi/6k92e3bl2ypvtoj2z3vgh/Screenshot-2026-01-01-at-1.23.56-AM.png?rlkey=sod3j1qoo1luvqt9of4vsfbak&raw=1"
                                    alt="Glasses Diagram (A: Double vs B: Single)" class="question-diagram"
                                    style="max-width: 45%; border: 1px dashed #ccc; min-height: 150px; background: #f9f9f9;">
                                <img src="https://www.dropbox.com/scl/fi/qlxcbhuj6m9awgtd3xb2z/Screenshot-2026-01-01-at-1.27.47-AM.png?rlkey=cd4cwykuja7k335j2qwymavmn&raw=1"
                                    alt="Graph Diagram (Line X vs Line Y)" class="question-diagram"
                                    style="max-width: 45%; border: 1px dashed #ccc; min-height: 150px; background: #f9f9f9;">
                            </div>
                            <p>The table shows the daily average temperature for Singapore during the day.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Average temperature (Â°C) in the day</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Inside the house</td>
                                        <td>28Â°C</td>
                                    </tr>
                                    <tr>
                                        <td>Outside the house</td>
                                        <td>32Â°C</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Are double-layered or single-layered glass windows more suitable
                                for houses in Singapore, so that it is cooler inside the house? Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="heat-form-3">
                                    <div class="cer-segment" data-label="claim">
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                style="width: 150px;" data-answer="Double-layered"></div>glass windows
                                        are more suitable.<span class="feedback-icon"></span>
                                    </div>
                                    <div class="cer-segment" data-label="evidence">The temperature of water increases
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="slower"></div> for glass <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="A"></div> when compared to
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="B"></div> over 50 minutes.<span
                                            class="feedback-icon"></span>
                                    </div>
                                    <div class="cer-segment" data-label="reasoning">The layer of <div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="air"></div> trapped between the glass layer is a <div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="poor"></div> conductor of <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="heat"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="link">This <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="reduces"></div> the heat
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="gained"></div> from the <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="warmer"></div> surrounding
                                        air outside the house into the inside of the house, thus, keeping the inside of
                                        the house <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="cooler"></div>.<span class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)">ðŸ–¨ï¸ Print</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TOPIC: LIGHT -->
                    <div id="topic-light" class="topic-content hidden">
                        <div id="light-question-1" class="question-container">
                            <h3>Question 1</h3>
                            <p>Jeremy conducted an experiment in a dark room to investigate the properties of materials
                                P, Q, R and S. He placed different materials at positions 1 and 2 respectively each
                                time.</p>
                            <img src="https://www.dropbox.com/scl/fi/m72szjzburi7sqf8u9vcj/Screenshot-2025-10-18-at-8.06.48-AM.png?rlkey=h2pcg2ig894ot07xjx7bld0fn&raw=1"
                                alt="Light Experiment Diagram" class="question-diagram">
                            <p>The amount of light detected by the light sensor was recorded as shown in the table.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Material at position 1</th>
                                        <th>Material at position 2</th>
                                        <th>Amount of light detected (lux)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>P</td>
                                        <td>Q</td>
                                        <td>2000</td>
                                    </tr>
                                    <tr>
                                        <td>Q</td>
                                        <td>R</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>R</td>
                                        <td>S</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>S</td>
                                        <td>P</td>
                                        <td>300</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Which material would be most suitable to make a bedroom curtain
                                that keeps the room totally dark? Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="light-form-1">
                                    <div class="cer-segment" data-label="claim">Material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="R"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The amount of light detected is<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="0"></div>lux when material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="R"></div>is placed in
                                        either position 1 or position 2,<span class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that material R is the only
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="opaque"></div>material, allowing the curtain to block<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="all"></div>light and keep the room totally dark.<span
                                            class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)">ðŸ–¨ï¸ Print</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TOPIC: MATERIALS -->
                    <div id="topic-materials" class="topic-content hidden">
                        <div id="materials-question-1" class="question-container">
                            <h3>Question 1</h3>
                            <p>Tony set up an experiment to compare the property of four strips, A, B, C and D, made of
                                different materials but of the same thickness.</p>
                            <img src="https://www.dropbox.com/scl/fi/jsxkxtz7ryrm3s4i04x49/Screenshot-2025-10-18-at-2.29.33-AM.png?rlkey=cib9nnrvpxta2imuncs4j9ugw&raw=1"
                                alt="Flexibility Experiment Diagram" class="question-diagram">
                            <p>He recorded the distance, x, in the table below.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Distance x (cm)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>A</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>B</td>
                                        <td>9</td>
                                    </tr>
                                    <tr>
                                        <td>C</td>
                                        <td>30</td>
                                    </tr>
                                    <tr>
                                        <td>D</td>
                                        <td>10</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Based on the results, which strip is most suitable for making a
                                belt? Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="materials-form-1">
                                    <div class="cer-segment" data-label="claim">Material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="C"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="distance"></div>X for
                                        material<div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="C"></div>is the<div class="answer-blank"><input type="text"
                                                class="answer-input" data-answer="greatest"></div>,<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that material<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="C"></div>is the most<div class="answer-blank"><input
                                                type="text" class="answer-input" style="width: 120px;"
                                                data-answer="flexible"></div>material, allowing a belt made of it to
                                        wrap around a person's waist most easily.<span class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)">ðŸ–¨ï¸ Print</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TOPIC: MCQ CONTENT (Dynamic) -->
                <div id="topic-mcq-living-and-non-living-things" class="topic-content hidden"></div>
                <div id="topic-mcq-materials" class="topic-content hidden"></div>
                <div id="topic-mcq-life-cycles" class="topic-content hidden"></div>
                <div id="topic-mcq-magnets" class="topic-content hidden"></div>
                <div id="topic-mcq-plant-systems" class="topic-content hidden"></div>
                <div id="topic-mcq-human-body-systems" class="topic-content hidden"></div>
                <div id="topic-mcq-matter-and-its-3-states" class="topic-content hidden"></div>
                <div id="topic-mcq-light" class="topic-content hidden"></div>
                <div id="topic-mcq-heat" class="topic-content hidden"></div>
                <div id="topic-mcq-water-and-its-3-states" class="topic-content hidden"></div>
                <div id="topic-mcq-plant-reproduction" class="topic-content hidden"></div>
                <div id="topic-mcq-human-and-plant-reproduction" class="topic-content hidden"></div>
                <div id="topic-mcq-human-and-plant-transport" class="topic-content hidden"></div>
                <div id="topic-mcq-electrical-systems" class="topic-content hidden"></div>
                <div id="topic-mcq-forces" class="topic-content hidden"></div>
                <div id="topic-mcq-energy-in-food" class="topic-content hidden"></div>
                <div id="topic-mcq-energy-conversion" class="topic-content hidden"></div>
                <div id="topic-mcq-living-together" class="topic-content hidden"></div>
                <div id="topic-mcq-food-chains-and-webs" class="topic-content hidden"></div>
                <div id="topic-mcq-humans-and-the-environment" class="topic-content hidden"></div>

                <!-- View: Single Relationship -->
                <div id="view-single-relationship" class="view-content hidden">
                    <!-- TOPIC: FORCES -->
                    <div id="topic-sr-forces" class="topic-content">
                        <div id="sr-forces-question-1" class="question-container">
                                <h3>Question 1</h3>
                                <p>Meiling conducted an experiment by placing a 1 kg block on a flat surface and
                                    measured the amount of force needed to pull it along the surface using a spring
                                    balance.</p>
                                <img src="https://www.dropbox.com/scl/fi/xvhgx31uk82s32edfv6a6/spring-block.jpg?rlkey=8aejaocw35svctiogmy9mbbwt&raw=1"
                                    alt="Spring Block Diagram" class="question-diagram">
                                <p>She repeated the experiment using three similar blocks that are of different masses
                                    and recorded the results in the graph.</p>
                                <img src="https://www.dropbox.com/scl/fi/j1kumnl75vervdk5he9p7/graph-app.jpg?rlkey=4gqp7teop1dy2wa38yr20iu2n&raw=1"
                                    alt="Force Graph Diagram" class="question-diagram">
                                <p class="question-title">State what Meiling could conclude based on the results of her
                                    experiment.</p>
                                <div class="answer-box">
                                    <div class="answer-template" id="sr-forces-form-1">
                                        <div class="cer-segment" style="border:none; padding:0; margin-bottom:0;"
                                            data-label="">
                                            As the
                                            <div class="answer-group">
                                                <div class="answer-blank"><input type="text" class="answer-input"
                                                        style="width: 200px;" data-answer="mass of the block|mass">
                                                </div>
                                                <span class="variable-label"
                                                    data-tooltip="The variable that is changed or controlled in a scientific experiment to test the effects on the dependent variable.">independent
                                                    variable</span>
                                            </div>
                                            increases, the
                                            <div class="answer-group">
                                                <div class="answer-blank"><input type="text" class="answer-input"
                                                        style="width: 350px;"
                                                        data-answer="amount of force needed to pull it along the surface|amount of force|force">
                                                </div>
                                                <span class="variable-label"
                                                    data-tooltip="The variable being tested and measured in a scientific experiment.">dependent
                                                    variable</span>
                                            </div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="increases"></div>.
                                            <span class="feedback-icon" style="margin-left: 10px;"></span>
                                        </div>
                                    </div>
                                    <div class="controls">
                                        <button class="submit-btn btn">Submit</button>
                                        <button class="print-btn" onclick="printQuestion(this)">ðŸ–¨ï¸ Print</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>

                <div id="view-double-relationship" class="view-content hidden">
                    <div class="placeholder-content">
                        <h2>Double Relationship Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-definition" class="view-content hidden">
                    <div id="topic-def-evap" class="topic-content">
                        <div id="def-evap-question-1" class="question-container">
                                <h3>Question 1</h3>
                                <p class="question-title">Define evaporation.</p>
                                <div class="answer-box">
                                    <div class="answer-template" id="def-form-1"
                                        style="font-size: 1.2rem; line-height: 2;">
                                        <div class="cer-segment" data-label="definition">
                                            Evaporation is a process where a <div class="answer-blank"><input
                                                    type="text" class="answer-input" data-answer="liquid"></div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="gains"></div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="heat"></div> from a heat source to become <div
                                                class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="gas"></div> at <div class="answer-blank"><input
                                                    type="text" class="answer-input" data-answer="any"></div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    style="width: 150px;" data-answer="temperature"></div>.
                                            <span class="feedback-icon"></span>
                                        </div>
                                    </div>
                                    <div class="controls">
                                        <button class="submit-btn btn">Submit</button>
                                        <button class="print-btn" onclick="printQuestion(this)">ðŸ–¨ï¸ Print</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>

                <div id="view-fairness" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Fairness Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-reliability" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Reliability Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-accuracy" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Accuracy Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-constant-variable" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Constant Variable Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-explanation" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Explanation Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-control-setup" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Control Set-up Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-admin" class="view-content hidden" style="flex: 1;">
                    <main style="max-width: 900px; margin: 0 auto; padding-top: 2rem;">
                        <h2 style="margin-bottom: 1rem; color: var(--main-text);">Question Creator (Admin)</h2>
                        <div id="editing-indicator" class="hidden" style="background: #fff3cd; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; color: #856404; display: flex; justify-content: space-between; align-items: center;">
                            <span>âœï¸ <strong>Editing:</strong> <span id="editing-question-name"></span></span>
                            <button onclick="cancelEditing()" style="background: #856404; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Cancel Edit</button>
                        </div>
                        <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.9rem; color: #2e7d32;">
                            <strong>ðŸ“ How to create a question:</strong>
                            <ol style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
                                <li>Fill in the <strong>Title</strong> and select <strong>Category/Topic</strong></li>
                                <li>Add <strong>Text blocks</strong> for question content and <strong>Answer blocks</strong> for fill-in-the-blank sections</li>
                                <li>Click <strong>"Preview & Select Blanks"</strong> to see your question and click words to turn them into blanks</li>
                                <li>Click <strong>"Save Question"</strong> when done</li>
                            </ol>
                            <p style="margin-top: 0.5rem; font-size: 0.85rem;"><em>ðŸ’¡ Tip: In Answer blocks, wrap words in [brackets] to automatically make them blanks (e.g., "The answer is [correct]")</em></p>
                        </div>
                        <div id="admin-editor" class="answer-box"
                            style="background: #fff; border: 1px solid var(--border-color);">
                            <div id="admin-basic-meta"
                                style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-top-left-radius: 8px; border-top-right-radius: 8px;">
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="flex: 1;">
                                        <label for="admin-category"
                                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Category:</label>
                                        <select id="admin-category" class="auth-input"
                                            style="width: 100%; height: 50px; cursor: pointer;"
                                            onchange="handleCategoryChange(this.value)">
                                            <option value="cer">CER (Open Ended)</option>
                                            <option value="definition">Definition</option>
                                            <option value="single-relationship">Single Relationship</option>
                                            <option value="double-relationship">Double Relationship</option>
                                            <option value="mcq">Multiple Choice (MCQ)</option>
                                            <option value="fairness">Fairness</option>
                                            <option value="reliability">Reliability</option>
                                            <option value="accuracy">Accuracy</option>
                                            <option value="constant-variable">Constant Variable</option>
                                            <option value="explanation">Explanation</option>
                                            <option value="control-setup">Control Set-up</option>
                                        </select>
                                    </div>
                                    <div id="admin-level-container" class="hidden" style="flex: 1;">
                                        <label for="admin-level"
                                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Level:</label>
                                        <select id="admin-level" class="auth-input"
                                            style="width: 100%; height: 50px; cursor: pointer;"
                                            onchange="updateAdminTopicsByLevel(this.value)">
                                            <option value="P3">Primary 3</option>
                                            <option value="P4">Primary 4</option>
                                            <option value="P5">Primary 5</option>
                                            <option value="P6">Primary 6</option>
                                        </select>
                                    </div>
                                </div>
                                <label for="admin-title"
                                    style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Question
                                    Title:</label>
                                <input type="text" id="admin-title" class="auth-input"
                                    style="width: 100%; height: 50px; margin-bottom: 1rem;"
                                    placeholder="e.g., Bird Life Cycle">
                                <label for="admin-topic"
                                    style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Topic:</label>
                                <select id="admin-topic" class="auth-input"
                                    style="width: 100%; height: 50px; cursor: pointer; margin-bottom: 0.5rem;"
                                    onchange="handleTopicChange(this.value)">
                                    <option value="heat">Heat</option>
                                    <option value="light">Light</option>
                                    <option value="materials">Materials</option>
                                    <option value="air">Air</option>
                                    <option value="water">Water</option>
                                    <option value="new-topic">-- Add Custom Topic --</option>
                                </select>
                                <input type="text" id="admin-new-topic" class="auth-input hidden"
                                    style="width: 100%; height: 50px;" placeholder="Enter new topic name...">
                                <!-- MCQ Options (Hidden by default) -->
                                <div id="mcq-options-container" class="hidden"
                                    style="margin-top: 1rem; padding: 1rem; background: #eee; border-radius: 8px;">
                                    <p style="font-weight: 600; margin-bottom: 0.5rem;">Enter Options:</p>
                                    <input type="text" id="mcq-opt-1" class="auth-input" placeholder="Option 1"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <input type="text" id="mcq-opt-2" class="auth-input" placeholder="Option 2"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <input type="text" id="mcq-opt-3" class="auth-input" placeholder="Option 3"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <input type="text" id="mcq-opt-4" class="auth-input" placeholder="Option 4"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <p style="font-weight: 600; margin-top: 0.5rem;">Correct Answer:</p>
                                    <select id="mcq-correct" class="auth-input" style="height: 40px;">
                                        <option value="1">Option 1</option>
                                        <option value="2">Option 2</option>
                                        <option value="3">Option 3</option>
                                        <option value="4">Option 4</option>
                                    </select>
                                </div>
                            </div>
                            <div id="admin-blocks"></div>
                            <div
                                style="display: flex; gap: 0.8rem; margin-top: 2rem; border-top: 2px dashed #eee; padding-top: 1.5rem; flex-wrap: wrap; justify-content: center;">
                                <button class="btn" onclick="addAdminBlock('text')"
                                    style="background: #e7f5ff; color: #007bff; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+ Add Text</button>
                                <button class="btn" onclick="addAdminBlock('answer')"
                                    style="background: #fff9c4; color: #f9a825; border: 1px solid #fbc02d; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+
                                    Add Answer</button>
                                <button class="btn" onclick="addAdminBlock('explanation')"
                                    style="background: #f0f4ff; color: #007bff; border: 1px solid #007bff; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+
                                    Add Explanation</button>
                                <button class="btn" onclick="addAdminBlock('video')"
                                    style="background: #fff5f5; color: #dc3545; border: 1px solid #dc3545; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+
                                    Add Video URL</button>
                                <button class="btn" onclick="addAdminBlock('image')"
                                    style="background: #fdfdfd; border: 1px solid #ddd; color: #555; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+ Add
                                    Image URL</button>
                                <button class="btn" onclick="event.stopPropagation(); showTableGridSelector(this)" id="add-table-btn"
                                    style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 1px solid #81c784; color: #2e7d32; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+ Add
                                    Table</button>
                            </div>
                            <div id="admin-actions" class="controls"
                                style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #eee;">
                                <button id="admin-clear-btn" class="btn" onclick="clearAdminForm(false, true)"
                                    style="background: #dc3545; color: white;">ðŸ—‘ï¸ Clear Form</button>
                                <button id="admin-process-btn" class="btn" onclick="processAdminQuestion()"
                                    style="background: #28a745; color: white;">ðŸ‘ï¸ Preview & Select Blanks</button>
                                <button id="save-question-btn" class="btn" onclick="saveAdminQuestion()"
                                    style="background: var(--primary-blue); color: white;">ðŸ’¾ Save Question</button>
                            </div>
                        </div>
                        <div id="admin-preview-section" class="hidden" style="margin-top: 4rem;">
                            <h3 style="margin-bottom: 1.5rem;">Interactive Preview</h3>
                            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">Click the words you want
                                to turn into blanks. Yellow words will become questions.</p>
                            <div id="admin-preview-content" class="answer-template"
                                style="background: var(--blue-light); padding: 2rem; border-radius: 12px;"></div>
                        </div>
                    </main>
                </div>

                <!-- WORKSHEET VIEW -->
                <div id="view-worksheet" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div class="worksheet-actions"
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0;">ðŸ“ My Worksheet</h2>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn" style="background: #1976d2; color: white;"
                                    onclick="showSaveWorksheetModal()">ðŸ’¾ Save Worksheet</button>
                                <button class="btn" style="background: #28a745; color: white;"
                                    onclick="exportWorksheet()">ðŸ–¨ï¸ Export PDF</button>
                                <button class="btn" style="background: #dc3545; color: white;"
                                    onclick="clearWorksheet()">ðŸ—‘ï¸ Clear All</button>
                            </div>
                        </div>

                        <div id="worksheet-header"
                            style="display: none; border-bottom: 2px solid #000; padding-bottom: 1rem; margin-bottom: 2rem;">
                            <div
                                style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem;">
                                <span>Name: __________________________</span>
                                <span>Score: ________ / ________</span>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">Date: ________________</div>
                        </div>

                        <div id="worksheet-questions-container">
                            <div class="placeholder-content" id="worksheet-empty-msg">
                                <p style="font-size: 1.2rem; color: #666;">No questions added to your worksheet yet.</p>
                                <p style="font-size: 0.95rem; margin-top: 10px; color: #888;">Browse questions and click
                                    the <strong style="color: #2ed573;">âž• Worksheet</strong> button to add them here.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SAVED WORKSHEETS VIEW -->
                <div id="view-saved-worksheets" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0;">ðŸ“š My Saved Worksheets</h2>
                            <button class="btn" style="background: #dc3545; color: white;" onclick="refreshSavedWorksheets()">ðŸ”„ Refresh</button>
                        </div>
                        <div id="saved-worksheets-container">
                            <div class="placeholder-content" id="saved-worksheets-empty-msg">
                                <p style="font-size: 1.2rem; color: #666;">No saved worksheets yet.</p>
                                <p style="font-size: 0.95rem; margin-top: 10px; color: #888;">
                                    Create a worksheet and click <strong style="color: #1976d2;">ðŸ’¾ Save Worksheet</strong> to save it here.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SHARED LESSONS VIEW -->
                <div id="view-lessons" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0;">ðŸŽ“ Lessons</h2>
                            <button class="btn" style="background: #f57c00; color: white;" onclick="refreshSharedLessons()">ðŸ”„ Refresh</button>
                        </div>
                        <div id="lessons-container">
                            <div class="placeholder-content" id="lessons-empty-msg">
                                <p style="font-size: 1.2rem; color: #666;">No lessons available yet.</p>
                                <p style="font-size: 0.95rem; margin-top: 10px; color: #888;">
                                    Check back later for new lessons from your teacher!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LESSON DETAIL VIEW -->
                <div id="view-lesson-detail" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <button class="btn" style="background: #666; color: white; margin-bottom: 1.5rem;" onclick="switchTab('lessons')">â† Back to Lessons</button>
                        <div id="lesson-detail-content"></div>
                    </div>
                </div>

                <!-- PRACTICE MODE VIEW -->
                <div id="view-practice" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h2 style="margin: 0; color: #7b1fa2;">ðŸŽ¯ Practice Mode</h2>
                                <p style="margin: 0.5rem 0 0; color: #666;" id="practice-student-info">Select a student to start practicing</p>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="practice-student-select" style="height: 45px; margin: 0; border-radius: 8px; min-width: 250px; padding: 0 15px; font-size: 1rem; border: 2px solid #e0e0e0; background: #fafafa; cursor: pointer;" onchange="selectPracticeStudent()">
                                    <option value="">-- Select Student --</option>
                                </select>
                            </div>
                        </div>

                        <!-- Practice Stats -->
                        <div id="practice-stats" class="hidden" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: #e8f5e9; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #28a745;" id="stat-correct">0</div>
                                <div style="color: #666; font-size: 0.9rem;">Correct</div>
                            </div>
                            <div style="background: #ffebee; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #dc3545;" id="stat-wrong">0</div>
                                <div style="color: #666; font-size: 0.9rem;">Wrong</div>
                            </div>
                            <div style="background: #e3f2fd; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #1976d2;" id="stat-remaining">0</div>
                                <div style="color: #666; font-size: 0.9rem;">Remaining</div>
                            </div>
                            <div style="background: #f3e5f5; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #7b1fa2;" id="stat-streak">0</div>
                                <div style="color: #666; font-size: 0.9rem;">Streak ðŸ”¥</div>
                            </div>
                        </div>

                        <!-- Start Practice Button -->
                        <div id="practice-start-container" style="text-align: center; padding: 3rem;">
                            <button id="btn-start-practice" class="btn" style="background: #7b1fa2; color: white; font-size: 1.2rem; padding: 15px 40px;" onclick="startPractice()" disabled>
                                ðŸš€ Start Practice
                            </button>
                            <p style="color: #888; margin-top: 1rem; font-size: 0.9rem;">Questions will be served based on your level, starting with unanswered questions.</p>
                        </div>

                        <!-- Current Question Container -->
                        <div id="practice-question-container" class="hidden">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span style="background: #f3e5f5; color: #7b1fa2; padding: 5px 15px; border-radius: 20px; font-weight: 600;" id="practice-question-level">P6</span>
                                <span style="color: #888; font-size: 0.9rem;" id="practice-question-topic">Topic: Forces</span>
                            </div>
                            <div id="practice-question-content" style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
                            <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;">
                                <button class="btn" style="background: #7b1fa2; color: white;" onclick="nextPracticeQuestion()">Next Question â†’</button>
                                <button class="btn" style="background: #666; color: white;" onclick="endPractice()">End Practice</button>
                            </div>
                        </div>

                        <!-- Practice Complete -->
                        <div id="practice-complete" class="hidden" style="text-align: center; padding: 3rem;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸŽ‰</div>
                            <h3 style="color: #7b1fa2;">Practice Complete!</h3>
                            <p style="color: #666;" id="practice-summary">Great job!</p>
                            <button class="btn" style="background: #7b1fa2; color: white; margin-top: 1rem;" onclick="restartPractice()">Practice Again</button>
                        </div>
                    </div>
                </div>

                <!-- INBOX VIEW -->
                <div id="view-inbox" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h2 style="margin: 0; color: #0288d1;">ðŸ“¬ Inbox</h2>
                                <p style="margin: 0.5rem 0 0; color: #666;">Messages between you and Mr Chung</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" style="background: #0288d1; color: white;" onclick="refreshInbox()">ðŸ”„ Refresh</button>
                                <button id="btn-new-message" class="btn" style="background: #28a745; color: white;" onclick="showNewMessageModal()">âœ‰ï¸ New Message</button>
                            </div>
                        </div>

                        <!-- Message Tabs -->
                        <div style="display: flex; gap: 10px; margin-bottom: 1.5rem;">
                            <button id="inbox-tab-received" class="inbox-tab active" onclick="switchInboxTab('received')">ðŸ“¥ Received</button>
                            <button id="inbox-tab-sent" class="inbox-tab" onclick="switchInboxTab('sent')">ðŸ“¤ Sent</button>
                        </div>

                        <!-- Messages Container -->
                        <div id="inbox-messages-container">
                            <div class="inbox-empty" id="inbox-empty-msg">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“­</div>
                                <p>No messages yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Consult Mr Chung Modal -->
    <div id="consult-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 600px;">
            <h3 style="color: #0288d1; margin-bottom: 1rem;">ðŸ’¬ Ask Mr Chung</h3>
            <div id="consult-question-preview" style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; max-height: 150px; overflow-y: auto; font-size: 0.9rem; border-left: 4px solid #0288d1;">
                <!-- Question preview will be inserted here -->
            </div>
            <div class="form-group">
                <label for="consult-message">Your Question / Message *</label>
                <textarea id="consult-message" rows="4" placeholder="Type your question here..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideConsultModal()">Cancel</button>
                <button class="btn-save" style="background: #0288d1;" onclick="sendConsultMessage()">ðŸ“¤ Send Message</button>
            </div>
        </div>
    </div>

    <!-- New Message Modal (for admin to message students) -->
    <div id="new-message-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 600px;">
            <h3 style="color: #0288d1; margin-bottom: 1rem;">âœ‰ï¸ New Message</h3>
            <div class="form-group" id="recipient-select-group">
                <label for="message-recipient">To *</label>
                <select id="message-recipient" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    <option value="">-- Select Recipient --</option>
                    <option value="admin">Mr Chung (Teacher)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="new-message-subject">Subject *</label>
                <input type="text" id="new-message-subject" placeholder="Subject..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
            </div>
            <div class="form-group">
                <label for="new-message-content">Message *</label>
                <textarea id="new-message-content" rows="5" placeholder="Type your message here..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideNewMessageModal()">Cancel</button>
                <button class="btn-save" style="background: #0288d1;" onclick="sendNewMessage()">ðŸ“¤ Send</button>
            </div>
        </div>
    </div>

    <!-- View Message Modal -->
    <div id="view-message-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 650px;">
            <div id="view-message-content"></div>
            <div class="modal-buttons" style="margin-top: 1.5rem;">
                <button class="btn-cancel" onclick="hideViewMessageModal()">Close</button>
                <button id="btn-reply-message" class="btn-save" style="background: #0288d1;" onclick="replyToMessage()">â†©ï¸ Reply</button>
            </div>
        </div>
    </div>

    <!-- Question Popup Modal -->
    <div id="question-popup-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 1rem;">
                <h3 style="margin: 0; color: #1976d2;">ðŸ“‹ Original Question</h3>
                <button class="btn" style="background: #666; color: white; padding: 8px 16px;" onclick="hideQuestionPopup()">âœ• Close</button>
            </div>
            <div id="question-popup-content" style="padding: 1rem 0;"></div>
        </div>
    </div>

    <script>
        // =====================================================
        // FORCE FRESH CONTENT - AGGRESSIVE CACHE BUSTING
        // =====================================================
        (function() {
            'use strict';
            
            // Generate unique version based on current timestamp
            const currentTimestamp = Date.now();
            const storedTimestamp = sessionStorage.getItem('page_load_time');
            
            // Display version for debugging (can be removed in production)
            const versionDisplay = document.getElementById('version-display');
            if (versionDisplay) {
                versionDisplay.textContent = 'v' + currentTimestamp;
            }
            
            // Method 1: Force reload if this is a new browser session
            if (!storedTimestamp) {
                sessionStorage.setItem('page_load_time', currentTimestamp);
                
                // Check if URL already has cache buster
                const urlParams = new URLSearchParams(window.location.search);
                if (!urlParams.has('_cb')) {
                    // Add cache buster to URL and reload
                    const newUrl = window.location.pathname + '?_cb=' + currentTimestamp + window.location.hash;
                    window.location.replace(newUrl);
                    return; // Stop execution
                }
            }
            
            // Method 2: Fetch the page with no-cache headers to check for updates
            // BUT skip if user is in admin mode (editing questions)
            fetch(window.location.pathname, {
                method: 'HEAD',
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            }).then(response => {
                const serverLastModified = response.headers.get('Last-Modified');
                const serverETag = response.headers.get('ETag');
                const serverVersion = serverLastModified || serverETag || '';
                
                const cachedVersion = localStorage.getItem('server_file_version');
                
                if (cachedVersion && serverVersion && cachedVersion !== serverVersion) {
                    // Check if user is in admin mode - don't auto-reload if they're working on a question
                    const isInAdminMode = document.getElementById('view-admin') && 
                                          !document.getElementById('view-admin').classList.contains('hidden');
                    const hasUnsavedWork = window.adminBlocks && window.adminBlocks.length > 0;
                    const isSaving = window.isSavingQuestion;
                    
                    if (isInAdminMode || hasUnsavedWork || isSaving) {
                        console.log('New version available but user is in admin mode - skipping auto-reload');
                        localStorage.setItem('server_file_version', serverVersion);
                        return;
                    }
                    
                    // Server file has changed - force hard reload
                    console.log('New version detected! Reloading...');
                    localStorage.setItem('server_file_version', serverVersion);
                    
                    // Clear all caches
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                        });
                    }
                    
                    // Force reload bypassing cache
                    window.location.href = window.location.pathname + '?_cb=' + Date.now();
                } else if (!cachedVersion && serverVersion) {
                    localStorage.setItem('server_file_version', serverVersion);
                }
            }).catch(err => {
                console.log('Version check failed:', err);
            });
            
            // Method 3: Clear service worker caches if present
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => {
                        registration.unregister();
                    });
                });
            }
        })();

        // =====================================================
        // GLOBAL STATE & UTILITIES
        // =====================================================
        window.adminBlocks = [];
        window.isAdminUser = false;
        window.worksheetItems = [];
        window.currentActiveTab = 'cer';
        window.currentMode = 'oeq';
        window.currentMcqLevel = 'P3';
        window.currentMcqTopic = '';
        window.editingQuestionId = null;

        window.mcqCurriculum = {
            'P3': ['Living and non-living things', 'Materials', 'Life Cycles', 'Magnets'],
            'P4': ['Plant Systems', 'Human Body Systems', 'Matter and its 3 States', 'Light', 'Heat'],
            'P5': ['Water and its 3 States', 'Plant Reproduction', 'Human and Plant Reproduction', 'Human and Plant Transport', 'Electrical Systems'],
            'P6': ['Forces', 'Energy in Food', 'Energy Conversion', 'Living Together', 'Food Chains and Webs', 'Humans and the Environment']
        };

        window.typeColors = {
            'cer': '#AEC6CF',
            'definition': '#ADD8E6',
            'single-relationship': '#FFB7B2',
            'double-relationship': '#FFDAC1',
            'fairness': '#E2F0CB',
            'reliability': '#C7CEEA',
            'accuracy': '#FDFD96',
            'constant-variable': '#B5EAD7',
            'explanation': '#FF9AA2',
            'control-setup': '#E0BBE4',
            'admin': '#ffd1dc',
            'worksheet': '#e3f2fd',
            'saved-worksheets': '#e8f5e9',
            'practice': '#f3e5f5',
            'inbox': '#e1f5fe',
            'lessons': '#fff3e0',
            'lesson-detail': '#fff3e0',
            // MCQ level colors
            'mcq-P3': '#FFB3BA',
            'mcq-P4': '#BAFFC9',
            'mcq-P5': '#BAE1FF',
            'mcq-P6': '#FFFFBA'
        };

        // =====================================================
        // OEQ TOPICS BY TAB TYPE
        // =====================================================
        // Maps tab type to array of {name, id} objects
        window.oeqTopics = {
            'cer': [
                {name: 'Heat', id: 'heat'},
                {name: 'Light', id: 'light'},
                {name: 'Materials', id: 'materials'}
            ],
            'definition': [
                {name: 'Evaporation', id: 'def-evap'}
            ],
            'single-relationship': [
                {name: 'Forces', id: 'sr-forces'}
            ],
            'double-relationship': [],
            'fairness': [],
            'reliability': [],
            'accuracy': [],
            'constant-variable': [],
            'explanation': [],
            'control-setup': []
        };

        window.currentOeqTab = 'cer';
        window.currentOeqTopic = 'heat';

        // Update OEQ sidebar topics based on current tab
        window.updateOeqSidebar = function(tabType) {
            const nav = document.getElementById('oeq-topic-nav');
            const title = document.getElementById('oeq-title');
            if (!nav) return;

            const topics = window.oeqTopics[tabType] || [];
            const tabNames = {
                'cer': 'CER Questions',
                'definition': 'Definition',
                'single-relationship': 'Single Relationship',
                'double-relationship': 'Double Relationship',
                'fairness': 'Fairness',
                'reliability': 'Reliability',
                'accuracy': 'Accuracy',
                'constant-variable': 'Constant Variable',
                'explanation': 'Explanation',
                'control-setup': 'Control Set-up'
            };

            if (title) {
                title.textContent = tabNames[tabType] || 'OEQ Questions';
            }

            if (topics.length === 0) {
                nav.innerHTML = '<p style="color: #888; font-size: 0.9rem;">Coming Soon</p>';
                return;
            }

            nav.innerHTML = topics.map((topic, idx) => {
                const activeClass = idx === 0 ? 'active' : '';
                return `<button id="btn-${topic.id}" class="${activeClass}" onclick="selectOeqTopic('${tabType}', '${topic.id}', this)">${topic.name}</button>`;
            }).join('');

            // Select first topic by default
            if (topics.length > 0) {
                selectOeqTopic(tabType, topics[0].id, nav.querySelector('button'));
            }
        };

        // Select an OEQ topic and show its content
        window.selectOeqTopic = function(tabType, topicId, btn) {
            window.currentOeqTopic = topicId;

            // Update button states
            const nav = document.getElementById('oeq-topic-nav');
            if (nav) {
                nav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                if (btn) btn.classList.add('active');
            }

            // Hide all topic contents within the current view
            const viewContainer = document.getElementById(`view-${tabType}`);
            if (viewContainer) {
                viewContainer.querySelectorAll('.topic-content').forEach(tc => {
                    tc.classList.add('hidden');
                });

                // Show the selected topic - try multiple ID patterns
                let targetTopic = viewContainer.querySelector(`#topic-${topicId}`);
                if (targetTopic) {
                    targetTopic.classList.remove('hidden');
                }
            }
        };

        // =====================================================
        // WORKSHEET FUNCTIONALITY - FIXED
        // =====================================================

        // Load worksheet from localStorage on page load
        function loadWorksheetFromStorage() {
            try {
                const stored = localStorage.getItem('worksheetItems');
                if (stored) {
                    window.worksheetItems = JSON.parse(stored);
                } else {
                    window.worksheetItems = [];
                }
            } catch (e) {
                console.error('Error loading worksheet:', e);
                window.worksheetItems = [];
            }
        }

        // Save worksheet to localStorage
        function saveWorksheetToStorage() {
            try {
                localStorage.setItem('worksheetItems', JSON.stringify(window.worksheetItems));
            } catch (e) {
                console.error('Error saving worksheet:', e);
            }
        }

        // Toggle question in/out of worksheet
        window.toggleWorksheetItem = function (btn) {
            const container = btn.closest('.question-container');
            if (!container) {
                alert("Could not find question container.");
                return;
            }

            // Get or create a unique ID for this question
            let qId = container.id;
            if (!qId) {
                qId = 'q-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                container.id = qId;
            }

            const existingIndex = window.worksheetItems.findIndex(item => item.id === qId);

            if (existingIndex > -1) {
                // Remove from worksheet
                window.worksheetItems.splice(existingIndex, 1);
                btn.innerHTML = 'âž• Worksheet';
                btn.classList.remove('added');
            } else {
                // Add to worksheet - capture the full question content
                const questionTitle = container.querySelector('h3')?.textContent || 'Question';

                // Clone the container to capture its content
                const clone = container.cloneNode(true);

                // Remove UI elements from the clone
                clone.querySelectorAll('.admin-controls, .worksheet-control-bar, .controls, .feedback-icon').forEach(el => el.remove());

                // Reset any input states in the clone
                clone.querySelectorAll('.answer-input').forEach(input => {
                    input.disabled = false;
                    input.value = '';
                    input.style.borderBottomColor = '';
                });

                // Get the cleaned HTML
                const cleanedHtml = clone.innerHTML;

                window.worksheetItems.push({
                    id: qId,
                    title: questionTitle,
                    html: cleanedHtml,
                    addedAt: new Date().toISOString()
                });

                btn.innerHTML = 'âœ… Added';
                btn.classList.add('added');
            }

            saveWorksheetToStorage();
            updateWorksheetUI();
        };

        // Update worksheet display
        window.updateWorksheetUI = function () {
            const countBadge = document.getElementById('worksheet-count');
            const container = document.getElementById('worksheet-questions-container');
            const emptyMsg = document.getElementById('worksheet-empty-msg');

            if (!container) return;

            const count = window.worksheetItems.length;

            // Update badge count
            if (countBadge) {
                countBadge.textContent = count;
            }

            // Clear existing question cards (keep empty message)
            const existingCards = container.querySelectorAll('.worksheet-question-card');
            existingCards.forEach(card => card.remove());

            if (count === 0) {
                if (emptyMsg) emptyMsg.style.display = 'block';
            } else {
                if (emptyMsg) emptyMsg.style.display = 'none';

                // Render each worksheet item
                window.worksheetItems.forEach((item, idx) => {
                    const card = document.createElement('div');
                    card.className = 'worksheet-question-card';
                    card.setAttribute('data-worksheet-id', item.id);

                    card.innerHTML = `
                        <span class="question-number">Question ${idx + 1}</span>
                        <div class="remove-btn-wrapper">
                            <button class="btn-worksheet-remove" onclick="removeFromWorksheet('${item.id}')">âœ• Remove</button>
                        </div>
                        <div class="worksheet-question-content" style="margin-top: 1rem;">
                            ${item.html}
                        </div>
                    `;

                    container.appendChild(card);
                });
            }

            // Update all add/remove buttons in main content
            syncWorksheetButtons();
        };

        // Sync worksheet buttons with current state
        function syncWorksheetButtons() {
            document.querySelectorAll('.question-container').forEach(container => {
                const qId = container.id;
                const btn = container.querySelector('.btn-worksheet-add');
                if (btn && qId) {
                    const isInWorksheet = window.worksheetItems.some(item => item.id === qId);
                    if (isInWorksheet) {
                        btn.innerHTML = 'âœ… Added';
                        btn.classList.add('added');
                    } else {
                        btn.innerHTML = 'âž• Worksheet';
                        btn.classList.remove('added');
                    }
                }
            });
        }

        // Remove question from worksheet
        window.removeFromWorksheet = function (qId) {
            window.worksheetItems = window.worksheetItems.filter(item => item.id !== qId);
            saveWorksheetToStorage();
            updateWorksheetUI();
        };

        // Clear all worksheet items
        window.clearWorksheet = function () {
            if (!confirm("Are you sure you want to clear all questions from your worksheet?")) return;
            window.worksheetItems = [];
            saveWorksheetToStorage();
            updateWorksheetUI();
        };

        // Export worksheet as PDF
        window.exportWorksheet = function () {
            if (window.worksheetItems.length === 0) {
                alert("Your worksheet is empty! Add some questions first.");
                return;
            }

            // Add print class to body
            document.body.classList.add('print-worksheet');

            // Show worksheet header
            const header = document.getElementById('worksheet-header');
            if (header) header.style.display = 'block';

            // Trigger print
            window.print();

            // Clean up after print
            setTimeout(() => {
                document.body.classList.remove('print-worksheet');
                if (header) header.style.display = 'none';
            }, 100);
        };

        // =====================================================
        // WORKSHEET SAVE/LOAD SYSTEM
        // =====================================================

        window.showSaveWorksheetModal = function() {
            if (window.worksheetItems.length === 0) {
                alert("Your worksheet is empty! Add some questions first.");
                return;
            }

            const modal = document.getElementById('save-worksheet-modal');
            const adminFields = document.getElementById('admin-lesson-fields');
            const title = document.getElementById('save-worksheet-modal-title');
            
            // Show admin fields if admin user
            if (window.isAdminUser) {
                adminFields.classList.remove('hidden');
                title.textContent = 'ðŸ’¾ Save Worksheet / Create Lesson';
            } else {
                adminFields.classList.add('hidden');
                title.textContent = 'ðŸ’¾ Save Worksheet';
            }
            
            // Clear previous inputs
            document.getElementById('worksheet-name-input').value = '';
            document.getElementById('worksheet-description-input').value = '';
            document.getElementById('lesson-video-input').value = '';
            document.getElementById('share-as-lesson-checkbox').checked = false;
            
            modal.classList.add('visible');
            document.getElementById('worksheet-name-input').focus();
            
            // Close when clicking outside modal box
            modal.onclick = function(e) {
                if (e.target === modal) {
                    hideSaveWorksheetModal();
                }
            };
        };

        window.hideSaveWorksheetModal = function() {
            document.getElementById('save-worksheet-modal').classList.remove('visible');
        };

        window.saveWorksheet = async function() {
            const name = document.getElementById('worksheet-name-input').value.trim();
            const description = document.getElementById('worksheet-description-input').value.trim();
            
            if (!name) {
                alert("Please enter a name for your worksheet.");
                document.getElementById('worksheet-name-input').focus();
                return;
            }
            
            const isAdmin = window.isAdminUser;
            const shareAsLesson = isAdmin && document.getElementById('share-as-lesson-checkbox').checked;
            const videoUrl = document.getElementById('lesson-video-input').value.trim();
            
            if (shareAsLesson && !videoUrl) {
                alert("Please provide a video link for the lesson.");
                document.getElementById('lesson-video-input').focus();
                return;
            }
            
            try {
                const { doc, setDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const worksheetId = 'ws_' + Date.now();
                const user = window.auth.currentUser;
                
                // Prepare question data (store question IDs and HTML)
                const questionsData = window.worksheetItems.map(item => ({
                    id: item.id,
                    title: item.title,
                    html: item.html
                }));
                
                if (shareAsLesson) {
                    // Save as shared lesson (visible to all)
                    const lessonData = {
                        name: name,
                        description: description,
                        videoUrl: convertYoutubeUrl(videoUrl),
                        questions: questionsData,
                        questionCount: questionsData.length,
                        createdBy: user.email,
                        createdAt: new Date().toISOString(),
                        type: 'lesson'
                    };
                    
                    await setDoc(doc(window.db_fs, "shared_lessons", worksheetId), lessonData);
                    alert("Lesson created and shared with all students! ðŸŽ“");
                } else {
                    // Save as personal worksheet
                    const worksheetData = {
                        name: name,
                        description: description,
                        questions: questionsData,
                        questionCount: questionsData.length,
                        userId: user.uid,
                        userEmail: user.email,
                        createdAt: new Date().toISOString(),
                        type: 'worksheet'
                    };
                    
                    await setDoc(doc(window.db_fs, "user_worksheets", worksheetId), worksheetData);
                    alert("Worksheet saved successfully! ðŸ“š");
                }
                
                hideSaveWorksheetModal();
                
                // Optionally clear the current worksheet
                if (confirm("Would you like to clear your current worksheet?")) {
                    window.worksheetItems = [];
                    saveWorksheetToStorage();
                    updateWorksheetUI();
                }
                
            } catch (e) {
                console.error("Save worksheet error:", e);
                alert("Error saving worksheet: " + e.message);
            }
        };

        // Convert YouTube URL to embed format
        window.convertYoutubeUrl = function(url) {
            if (!url) return url;
            if (url.includes('youtube.com/watch?v=')) {
                return url.replace('watch?v=', 'embed/');
            } else if (url.includes('youtu.be/')) {
                return url.replace('youtu.be/', 'youtube.com/embed/');
            }
            return url;
        };

        // Load user's saved worksheets
        window.loadSavedWorksheets = async function() {
            const container = document.getElementById('saved-worksheets-container');
            const emptyMsg = document.getElementById('saved-worksheets-empty-msg');
            
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const user = window.auth.currentUser;
                if (!user) return;
                
                // Fetch all worksheets and filter client-side
                const snapshot = await getDocs(collection(window.db_fs, "user_worksheets"));
                
                const worksheets = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId === user.uid) {
                        worksheets.push({ id: doc.id, ...data });
                    }
                });
                
                if (worksheets.length === 0) {
                    container.innerHTML = '';
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'inbox-empty';
                    emptyDiv.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“‚</div>
                        <p>No saved worksheets yet</p>
                    `;
                    container.appendChild(emptyDiv);
                    return;
                }
                
                container.innerHTML = '';
                
                // Sort by date descending
                worksheets.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                worksheets.forEach(ws => {
                    const date = new Date(ws.createdAt).toLocaleDateString();
                    const card = document.createElement('div');
                    card.className = 'saved-worksheet-card';
                    card.innerHTML = `
                        <h4>ðŸ“‹ ${ws.name}</h4>
                        <div class="meta">${ws.questionCount} questions â€¢ Saved on ${date}</div>
                        ${ws.description ? `<p style="color: #666; margin-bottom: 1rem;">${ws.description}</p>` : ''}
                        <div class="actions">
                            <button class="btn" style="background: #1976d2; color: white;" onclick="loadWorksheetToActive('${ws.id}')">ðŸ“¥ Load</button>
                            <button class="btn" style="background: #28a745; color: white;" onclick="viewSavedWorksheet('${ws.id}')">ðŸ‘ï¸ View</button>
                            <button class="btn" style="background: #dc3545; color: white;" onclick="deleteSavedWorksheet('${ws.id}')">ðŸ—‘ï¸ Delete</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
                
            } catch (e) {
                console.error("Load worksheets error:", e);
                container.innerHTML = '<p style="color: #dc3545;">Error loading worksheets. Please try again.</p>';
            }
        };

        window.refreshSavedWorksheets = function() {
            loadSavedWorksheets();
        };

        // Load a saved worksheet into the active worksheet
        window.loadWorksheetToActive = async function(worksheetId) {
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const docRef = doc(window.db_fs, "user_worksheets", worksheetId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert("Worksheet not found.");
                    return;
                }
                
                const data = docSnap.data();
                
                if (window.worksheetItems.length > 0) {
                    if (!confirm(`This will replace your current worksheet (${window.worksheetItems.length} items). Continue?`)) {
                        return;
                    }
                }
                
                window.worksheetItems = data.questions.map(q => ({
                    id: q.id,
                    title: q.title,
                    html: q.html
                }));
                
                saveWorksheetToStorage();
                updateWorksheetUI();
                
                alert(`Loaded "${data.name}" with ${data.questions.length} questions!`);
                switchTab('worksheet');
                
            } catch (e) {
                console.error("Load worksheet error:", e);
                alert("Error loading worksheet: " + e.message);
            }
        };

        // View a saved worksheet (read-only)
        window.viewSavedWorksheet = async function(worksheetId) {
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const docRef = doc(window.db_fs, "user_worksheets", worksheetId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert("Worksheet not found.");
                    return;
                }
                
                const data = docSnap.data();
                
                // Open in new window for viewing/printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${data.name}</title>
                        <style>
                            body { font-family: 'Segoe UI', sans-serif; padding: 2rem; max-width: 900px; margin: 0 auto; }
                            h1 { color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 10px; }
                            .question { background: #f5f5f5; padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid #1976d2; }
                            .question h3 { margin-top: 0; color: #333; }
                            .header-info { display: flex; justify-content: space-between; margin-bottom: 2rem; }
                            .answer-input { border: none; border-bottom: 2px solid #333; background: transparent; min-width: 100px; }
                            @media print { button { display: none; } }
                        </style>
                    </head>
                    <body>
                        <h1>ðŸ“‹ ${data.name}</h1>
                        <div class="header-info">
                            <span>Name: _______________________</span>
                            <span>Date: _______________</span>
                            <span>Score: _____ / ${data.questionCount}</span>
                        </div>
                        ${data.questions.map((q, i) => `
                            <div class="question">
                                <h3>Question ${i + 1}: ${q.title}</h3>
                                <div>${q.html}</div>
                            </div>
                        `).join('')}
                        <button onclick="window.print()" style="margin-top: 2rem; padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer;">ðŸ–¨ï¸ Print</button>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
            } catch (e) {
                console.error("View worksheet error:", e);
                alert("Error viewing worksheet: " + e.message);
            }
        };

        // Delete a saved worksheet
        window.deleteSavedWorksheet = async function(worksheetId) {
            if (!confirm("Are you sure you want to delete this worksheet? This cannot be undone.")) {
                return;
            }
            
            try {
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                await deleteDoc(doc(window.db_fs, "user_worksheets", worksheetId));
                
                alert("Worksheet deleted.");
                loadSavedWorksheets();
                
            } catch (e) {
                console.error("Delete worksheet error:", e);
                alert("Error deleting worksheet: " + e.message);
            }
        };

        // =====================================================
        // SHARED LESSONS SYSTEM
        // =====================================================

        window.loadSharedLessons = async function() {
            const container = document.getElementById('lessons-container');
            const emptyMsg = document.getElementById('lessons-empty-msg');
            
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const snapshot = await getDocs(collection(window.db_fs, "shared_lessons"));
                
                if (snapshot.empty) {
                    container.innerHTML = '';
                    container.appendChild(emptyMsg);
                    emptyMsg.style.display = 'block';
                    return;
                }
                
                emptyMsg.style.display = 'none';
                container.innerHTML = '';
                
                const lessons = [];
                snapshot.forEach(doc => {
                    lessons.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by date descending
                lessons.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                lessons.forEach(lesson => {
                    const date = new Date(lesson.createdAt).toLocaleDateString();
                    const card = document.createElement('div');
                    card.className = 'lesson-card';
                    card.onclick = () => openLesson(lesson.id);
                    card.innerHTML = `
                        <h4>ðŸŽ“ ${lesson.name}</h4>
                        <div class="meta">ðŸ“¹ Video Lesson â€¢ ${lesson.questionCount} practice questions</div>
                        ${lesson.description ? `<p class="description">${lesson.description}</p>` : ''}
                        <span class="badge">ðŸ“… ${date}</span>
                        ${window.isAdminUser ? `<button class="btn" style="margin-left: 10px; background: #dc3545; color: white; padding: 3px 10px; font-size: 0.75rem;" onclick="event.stopPropagation(); deleteSharedLesson('${lesson.id}')">ðŸ—‘ï¸ Delete</button>` : ''}
                    `;
                    container.appendChild(card);
                });
                
            } catch (e) {
                console.error("Load lessons error:", e);
                container.innerHTML = '<p style="color: #dc3545;">Error loading lessons. Please try again.</p>';
            }
        };

        window.refreshSharedLessons = function() {
            loadSharedLessons();
        };

        window.openLesson = async function(lessonId) {
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const docRef = doc(window.db_fs, "shared_lessons", lessonId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert("Lesson not found.");
                    return;
                }
                
                const lesson = docSnap.data();
                const container = document.getElementById('lesson-detail-content');
                
                container.innerHTML = `
                    <h2 style="margin: 0 0 1rem; color: #e65100;">ðŸŽ“ ${lesson.name}</h2>
                    ${lesson.description ? `<p style="color: #666; margin-bottom: 1.5rem;">${lesson.description}</p>` : ''}
                    
                    <div class="lesson-video-container">
                        <iframe src="${lesson.videoUrl}" allowfullscreen></iframe>
                    </div>
                    
                    <div class="lesson-questions-section">
                        <h3>ðŸ“ Practice Questions (${lesson.questionCount})</h3>
                        <div id="lesson-questions-list"></div>
                    </div>
                `;
                
                const questionsList = document.getElementById('lesson-questions-list');
                lesson.questions.forEach((q, i) => {
                    const qDiv = document.createElement('div');
                    qDiv.className = 'question-container';
                    qDiv.style.marginBottom = '1.5rem';
                    qDiv.style.background = 'white';
                    qDiv.style.padding = '1.5rem';
                    qDiv.style.borderRadius = '8px';
                    qDiv.style.borderLeft = '4px solid #f57c00';
                    qDiv.innerHTML = `
                        <h4 style="margin: 0 0 1rem; color: #333;">Question ${i + 1}: ${q.title}</h4>
                        <div class="question-body answer-template">${q.html}</div>
                    `;
                    questionsList.appendChild(qDiv);
                    
                    // Setup question functionality
                    if (window.setupQuestionFormGlobal) {
                        const bodyDiv = qDiv.querySelector('.question-body');
                        if (bodyDiv && bodyDiv.id) {
                            window.setupQuestionFormGlobal(bodyDiv.id);
                        }
                    }
                });
                
                // Add controls to lesson questions
                setTimeout(() => {
                    questionsList.querySelectorAll('.question-body').forEach(body => {
                        // Find MCQ containers and add check functionality
                        const mcqContainer = body.querySelector('.mcq-container');
                        if (mcqContainer) {
                            const existingBtn = body.querySelector('.submit-btn');
                            if (!existingBtn) {
                                const btn = document.createElement('button');
                                btn.className = 'btn btn-primary submit-btn';
                                btn.style.marginTop = '1rem';
                                btn.textContent = 'Check Answer';
                                btn.onclick = function() {
                                    const selected = mcqContainer.querySelector('input[type="radio"]:checked');
                                    if (!selected) {
                                        alert('Please select an answer.');
                                        return;
                                    }
                                    const isCorrect = selected.dataset.correct === 'true';
                                    
                                    // Show correct answer highlighting with icons inside options
                                    mcqContainer.querySelectorAll('label, .mcq-option').forEach(opt => {
                                        const radio = opt.querySelector('input');
                                        opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());
                                        
                                        if (radio && radio.dataset.correct === 'true') {
                                            opt.style.background = '#d4edda';
                                            opt.style.borderColor = '#28a745';
                                            const icon = document.createElement('span');
                                            icon.className = 'option-feedback-icon';
                                            icon.textContent = 'âœ”';
                                            icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #28a745; margin-left: auto; padding-left: 10px;';
                                            opt.style.display = 'flex';
                                            opt.style.alignItems = 'center';
                                            opt.appendChild(icon);
                                        } else if (radio && radio.checked && !isCorrect) {
                                            opt.style.background = '#f8d7da';
                                            opt.style.borderColor = '#dc3545';
                                            const icon = document.createElement('span');
                                            icon.className = 'option-feedback-icon';
                                            icon.textContent = 'âœ˜';
                                            icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #dc3545; margin-left: auto; padding-left: 10px;';
                                            opt.style.display = 'flex';
                                            opt.style.alignItems = 'center';
                                            opt.appendChild(icon);
                                        }
                                    });
                                    
                                    // Disable all radios
                                    mcqContainer.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);
                                    btn.disabled = true;
                                    
                                    // Show explanation if exists
                                    const explanationBox = body.querySelector('.explanation-box');
                                    if (explanationBox) {
                                        explanationBox.style.display = 'block';
                                    }
                                };
                                body.appendChild(btn);
                            }
                        }
                    });
                }, 100);
                
                switchTab('lesson-detail');
                
            } catch (e) {
                console.error("Open lesson error:", e);
                alert("Error opening lesson: " + e.message);
            }
        };

        window.deleteSharedLesson = async function(lessonId) {
            if (!confirm("Are you sure you want to delete this lesson? This will remove it for all students.")) {
                return;
            }
            
            try {
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                await deleteDoc(doc(window.db_fs, "shared_lessons", lessonId));
                
                alert("Lesson deleted.");
                loadSharedLessons();
                
            } catch (e) {
                console.error("Delete lesson error:", e);
                alert("Error deleting lesson: " + e.message);
            }
        };

        // =====================================================
        // MULTI-STUDENT REGISTRATION
        // =====================================================
        
        window.studentEntryCount = 1;
        
        window.addStudentEntry = function() {
            const container = document.getElementById('students-container');
            const index = window.studentEntryCount++;
            
            const entry = document.createElement('div');
            entry.className = 'student-entry';
            entry.dataset.studentIndex = index;
            entry.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <input type="text" class="auth-input student-name" placeholder="Student's Name" style="flex: 1; margin-bottom: 0;">
                    <select class="auth-input student-level" style="width: 100px; margin-bottom: 0;">
                        <option value="">Level</option>
                        <option value="P3">P3</option>
                        <option value="P4">P4</option>
                        <option value="P5">P5</option>
                        <option value="P6">P6</option>
                    </select>
                    <button type="button" onclick="removeStudentEntry(${index})" style="background: #dc3545; color: white; border: none; border-radius: 8px; width: 35px; height: 35px; cursor: pointer; font-size: 1.2rem;">Ã—</button>
                </div>
            `;
            container.appendChild(entry);
        };
        
        window.removeStudentEntry = function(index) {
            const entry = document.querySelector(`.student-entry[data-student-index="${index}"]`);
            if (entry) entry.remove();
        };
        
        window.getStudentsData = function() {
            const students = [];
            document.querySelectorAll('.student-entry').forEach(entry => {
                const name = entry.querySelector('.student-name').value.trim();
                const level = entry.querySelector('.student-level').value;
                if (name && level) {
                    students.push({ name, level });
                }
            });
            return students;
        };

        // =====================================================
        // PRACTICE MODE
        // =====================================================
        
        window.practiceState = {
            currentStudent: null,
            questions: [],
            currentIndex: 0,
            correct: 0,
            wrong: 0,
            streak: 0,
            answeredQuestions: new Set()
        };

        window.loadPracticeMode = async function() {
            const select = document.getElementById('practice-student-select');
            select.innerHTML = '<option value="">-- Select Student --</option>';
            
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    let students = data.students || [];
                    
                    // Backwards compatibility: if no students array, create one from old format
                    if (students.length === 0 && data.studentName) {
                        students.push({ name: data.studentName, level: data.level || 'P6' });
                    }
                    
                    // If admin user and no students, add default P6 student for testing
                    if (window.isAdminUser && students.length === 0) {
                        students.push({ name: 'Admin', level: 'P6' });
                    }
                    
                    // If admin user, also add an "Admin (P6)" option at the top for testing
                    if (window.isAdminUser) {
                        const adminOption = document.createElement('option');
                        adminOption.value = 'admin';
                        adminOption.textContent = 'Admin Test Mode (P6)';
                        adminOption.dataset.name = 'Admin';
                        adminOption.dataset.level = 'P6';
                        select.appendChild(adminOption);
                    }
                    
                    students.forEach((student, idx) => {
                        const option = document.createElement('option');
                        option.value = idx;
                        option.textContent = `${student.name} (${student.level})`;
                        option.dataset.name = student.name;
                        option.dataset.level = student.level;
                        select.appendChild(option);
                    });
                    
                    window.userStudents = students;
                } else if (window.isAdminUser) {
                    // Admin without user doc - still allow practice as P6
                    const adminOption = document.createElement('option');
                    adminOption.value = 'admin';
                    adminOption.textContent = 'Admin Test Mode (P6)';
                    adminOption.dataset.name = 'Admin';
                    adminOption.dataset.level = 'P6';
                    select.appendChild(adminOption);
                    
                    window.userStudents = [{ name: 'Admin', level: 'P6' }];
                }
            } catch (e) {
                console.error("Error loading students:", e);
                
                // Fallback for admin if error occurs
                if (window.isAdminUser) {
                    const adminOption = document.createElement('option');
                    adminOption.value = 'admin';
                    adminOption.textContent = 'Admin Test Mode (P6)';
                    adminOption.dataset.name = 'Admin';
                    adminOption.dataset.level = 'P6';
                    select.appendChild(adminOption);
                    
                    window.userStudents = [{ name: 'Admin', level: 'P6' }];
                }
            }
        };

        window.selectPracticeStudent = function() {
            const select = document.getElementById('practice-student-select');
            const selectedOption = select.options[select.selectedIndex];
            const startBtn = document.getElementById('btn-start-practice');
            
            if (select.value && selectedOption.dataset.name) {
                window.practiceState.currentStudent = {
                    index: parseInt(select.value),
                    name: selectedOption.dataset.name,
                    level: selectedOption.dataset.level
                };
                document.getElementById('practice-student-info').textContent = 
                    `Student: ${selectedOption.dataset.name} | Level: ${selectedOption.dataset.level}`;
                startBtn.disabled = false;
            } else {
                window.practiceState.currentStudent = null;
                document.getElementById('practice-student-info').textContent = 'Select a student to start practicing';
                startBtn.disabled = true;
            }
        };

        window.startPractice = async function() {
            if (!window.practiceState.currentStudent) {
                alert("Please select a student first.");
                return;
            }
            
            const student = window.practiceState.currentStudent;
            const level = student.level;
            
            // Reset state
            window.practiceState.questions = [];
            window.practiceState.currentIndex = 0;
            window.practiceState.correct = 0;
            window.practiceState.wrong = 0;
            window.practiceState.streak = 0;
            
            // Load answered questions from storage
            await loadAnsweredQuestions();
            
            // Collect questions from current level and one level down
            const levels = ['P3', 'P4', 'P5', 'P6'];
            const currentLevelIndex = levels.indexOf(level);
            const targetLevels = [level];
            if (currentLevelIndex > 0) {
                targetLevels.push(levels[currentLevelIndex - 1]);
            }
            
            // Gather MCQ questions from the DOM
            const allQuestions = [];
            
            targetLevels.forEach(lvl => {
                const topics = window.mcqCurriculum[lvl] || [];
                topics.forEach(topic => {
                    const topicId = topic.toLowerCase().replace(/\s+/g, '-');
                    const container = document.getElementById(`topic-mcq-${topicId}`);
                    if (container) {
                        container.querySelectorAll('.question-container').forEach(q => {
                            const qId = q.id;
                            const isAnswered = window.practiceState.answeredQuestions.has(qId);
                            allQuestions.push({
                                id: qId,
                                level: lvl,
                                topic: topic,
                                element: q,
                                answered: isAnswered,
                                priority: lvl === level ? 0 : 1 // Current level first
                            });
                        });
                    }
                });
            });
            
            // Sort: unanswered first, then by priority (current level first)
            allQuestions.sort((a, b) => {
                if (a.answered !== b.answered) return a.answered ? 1 : -1;
                return a.priority - b.priority;
            });
            
            window.practiceState.questions = allQuestions;
            
            // Update UI
            document.getElementById('practice-start-container').classList.add('hidden');
            document.getElementById('practice-stats').classList.remove('hidden');
            document.getElementById('practice-stats').style.display = 'grid';
            document.getElementById('practice-question-container').classList.remove('hidden');
            document.getElementById('practice-complete').classList.add('hidden');
            
            updatePracticeStats();
            showCurrentPracticeQuestion();
        };

        window.showCurrentPracticeQuestion = function() {
            const state = window.practiceState;
            if (state.currentIndex >= state.questions.length) {
                endPractice();
                return;
            }
            
            const question = state.questions[state.currentIndex];
            const container = document.getElementById('practice-question-content');
            
            // Clone the question
            const clone = question.element.cloneNode(true);
            clone.id = 'practice-q-' + question.id;
            
            // Reset any answered state
            clone.querySelectorAll('input[type="radio"]').forEach(r => {
                r.checked = false;
                r.disabled = false;
                r.name = 'practice-mcq-' + state.currentIndex; // Unique name for this question
            });
            clone.querySelectorAll('.mcq-option, label').forEach(opt => {
                opt.style.borderColor = '';
                opt.style.background = '';
                opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());
            });
            clone.querySelectorAll('.explanation-box').forEach(e => e.style.display = 'none');
            clone.querySelectorAll('.submit-btn').forEach(b => b.disabled = false);
            
            // Update submit button to use practice check
            const submitBtn = clone.querySelector('.submit-btn');
            if (submitBtn) {
                submitBtn.onclick = () => checkPracticeAnswer();
            }
            
            container.innerHTML = '';
            container.appendChild(clone);
            
            // Update level and topic display
            document.getElementById('practice-question-level').textContent = question.level;
            document.getElementById('practice-question-topic').textContent = `Topic: ${question.topic}`;
            
            updatePracticeStats();
        };

        window.checkPracticeAnswer = function() {
            const state = window.practiceState;
            const question = state.questions[state.currentIndex];
            const container = document.getElementById('practice-question-content');
            
            const selected = container.querySelector('input[type="radio"]:checked');
            if (!selected) {
                alert("Please select an answer!");
                return;
            }
            
            const isCorrect = selected.dataset.correct === 'true';
            
            // Show feedback on options
            container.querySelectorAll('.mcq-option, label').forEach(opt => {
                const radio = opt.querySelector('input');
                opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());
                
                if (radio && radio.dataset.correct === 'true') {
                    opt.style.background = '#d4edda';
                    opt.style.borderColor = '#28a745';
                    const icon = document.createElement('span');
                    icon.className = 'option-feedback-icon';
                    icon.textContent = 'âœ”';
                    icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #28a745; margin-left: auto; padding-left: 10px;';
                    opt.style.display = 'flex';
                    opt.style.alignItems = 'center';
                    opt.appendChild(icon);
                } else if (radio && radio.checked && !isCorrect) {
                    opt.style.background = '#f8d7da';
                    opt.style.borderColor = '#dc3545';
                    const icon = document.createElement('span');
                    icon.className = 'option-feedback-icon';
                    icon.textContent = 'âœ˜';
                    icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #dc3545; margin-left: auto; padding-left: 10px;';
                    opt.style.display = 'flex';
                    opt.style.alignItems = 'center';
                    opt.appendChild(icon);
                }
            });
            
            // Disable radios
            container.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);
            
            // Show explanation
            const explanation = container.querySelector('.explanation-box');
            if (explanation) explanation.style.display = 'block';
            
            // Update stats
            if (isCorrect) {
                state.correct++;
                state.streak++;
            } else {
                state.wrong++;
                state.streak = 0;
            }
            
            // Mark as answered
            state.answeredQuestions.add(question.id);
            saveAnsweredQuestions();
            
            // Disable submit button
            container.querySelectorAll('.submit-btn').forEach(b => b.disabled = true);
            
            updatePracticeStats();
        };

        window.nextPracticeQuestion = function() {
            window.practiceState.currentIndex++;
            showCurrentPracticeQuestion();
        };

        window.endPractice = function() {
            const state = window.practiceState;
            
            document.getElementById('practice-question-container').classList.add('hidden');
            document.getElementById('practice-complete').classList.remove('hidden');
            
            const total = state.correct + state.wrong;
            const percentage = total > 0 ? Math.round((state.correct / total) * 100) : 0;
            
            document.getElementById('practice-summary').textContent = 
                `You got ${state.correct} out of ${total} correct (${percentage}%)!`;
        };

        window.restartPractice = function() {
            document.getElementById('practice-complete').classList.add('hidden');
            document.getElementById('practice-start-container').classList.remove('hidden');
            document.getElementById('practice-stats').classList.add('hidden');
            document.getElementById('practice-question-container').classList.add('hidden');
        };

        window.updatePracticeStats = function() {
            const state = window.practiceState;
            document.getElementById('stat-correct').textContent = state.correct;
            document.getElementById('stat-wrong').textContent = state.wrong;
            document.getElementById('stat-remaining').textContent = 
                Math.max(0, state.questions.length - state.currentIndex - 1);
            document.getElementById('stat-streak').textContent = state.streak;
        };

        window.loadAnsweredQuestions = async function() {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const studentIndex = window.practiceState.currentStudent?.index || 0;
                const key = `answered_${user.uid}_${studentIndex}`;
                const stored = localStorage.getItem(key);
                
                if (stored) {
                    window.practiceState.answeredQuestions = new Set(JSON.parse(stored));
                } else {
                    window.practiceState.answeredQuestions = new Set();
                }
            } catch (e) {
                console.error("Error loading answered questions:", e);
                window.practiceState.answeredQuestions = new Set();
            }
        };

        window.saveAnsweredQuestions = function() {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const studentIndex = window.practiceState.currentStudent?.index || 0;
                const key = `answered_${user.uid}_${studentIndex}`;
                const data = Array.from(window.practiceState.answeredQuestions);
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error("Error saving answered questions:", e);
            }
        };

        // Track answer for practice mode (called from checkMcq)
        window.trackAnswerForPractice = function(questionId, isCorrect) {
            // This can be expanded to track performance over time
            console.log(`Question ${questionId}: ${isCorrect ? 'Correct' : 'Wrong'}`);
        };

        // =====================================================
        // MESSAGING SYSTEM
        // =====================================================
        
        // Admin email (hidden from users, used internally)
        const ADMIN_EMAIL = 'chungzhikai@gmail.com';
        
        window.currentInboxTab = 'received';
        window.currentViewingMessage = null;

        // Load inbox messages
        window.loadInbox = async function() {
            const container = document.getElementById('inbox-messages-container');
            const emptyMsg = document.getElementById('inbox-empty-msg');
            
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Fetch all messages and filter client-side (avoids need for composite indexes)
                const snapshot = await getDocs(collection(window.db_fs, "messages"));
                
                // Filter messages based on current tab
                let messages = [];
                snapshot.forEach(doc => {
                    const msg = { id: doc.id, ...doc.data() };
                    if (window.currentInboxTab === 'received') {
                        if (msg.recipientId === user.uid) {
                            messages.push(msg);
                        }
                    } else {
                        if (msg.senderId === user.uid) {
                            messages.push(msg);
                        }
                    }
                });
                
                // Sort by date descending (client-side)
                messages.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return dateB - dateA;
                });
                
                if (messages.length === 0) {
                    container.innerHTML = '';
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'inbox-empty';
                    emptyDiv.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“­</div>
                        <p>No messages yet</p>
                    `;
                    container.appendChild(emptyDiv);
                    return;
                }
                
                container.innerHTML = '';
                
                messages.forEach(msg => {
                    const date = msg.createdAt ? new Date(msg.createdAt.toDate ? msg.createdAt.toDate() : msg.createdAt).toLocaleString() : 'Unknown';
                    const isUnread = !msg.read && window.currentInboxTab === 'received';
                    
                    // Format sender display with level if available
                    let senderDisplay = msg.senderName || 'Unknown';
                    if (msg.senderLevel) {
                        senderDisplay = `${msg.senderName} (${msg.senderLevel})`;
                    }
                    
                    const card = document.createElement('div');
                    card.className = `message-card ${isUnread ? 'unread' : ''}`;
                    card.onclick = () => viewMessage(msg.id);
                    card.innerHTML = `
                        <div class="message-header">
                            <span class="message-from">
                                ${isUnread ? '<span class="unread-dot"></span>' : ''}
                                ${window.currentInboxTab === 'received' ? senderDisplay : `To: ${msg.recipientName || 'Mr Chung'}`}
                            </span>
                            <span class="message-date">${date}</span>
                        </div>
                        <div class="message-subject">${msg.subject || 'No Subject'}</div>
                        <div class="message-preview">${(msg.message || '').substring(0, 100)}${msg.message?.length > 100 ? '...' : ''}</div>
                        ${msg.questionId ? '<span style="font-size: 0.75rem; background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 4px; margin-top: 5px; display: inline-block;">ðŸ“‹ Has Question</span>' : ''}
                    `;
                    container.appendChild(card);
                });
                
                // Update unread count
                updateUnreadCount();
                
            } catch (e) {
                console.error("Error loading inbox:", e);
                container.innerHTML = '<p style="color: #dc3545; text-align: center;">Error loading messages. Please try again.</p>';
            }
        };

        window.refreshInbox = function() {
            loadInbox();
        };

        window.switchInboxTab = function(tab) {
            window.currentInboxTab = tab;
            document.getElementById('inbox-tab-received').classList.toggle('active', tab === 'received');
            document.getElementById('inbox-tab-sent').classList.toggle('active', tab === 'sent');
            loadInbox();
        };

        // Update unread message count
        window.updateUnreadCount = async function() {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Fetch all messages and count unread client-side (avoids composite index)
                const snapshot = await getDocs(collection(window.db_fs, "messages"));
                let count = 0;
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    if (msg.recipientId === user.uid && msg.read === false) {
                        count++;
                    }
                });
                
                const badge = document.getElementById('inbox-badge');
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'inline' : 'none';
                }
            } catch (e) {
                console.error("Error updating unread count:", e);
            }
        };

        // View a single message
        window.viewMessage = async function(messageId) {
            try {
                const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const msgRef = doc(window.db_fs, "messages", messageId);
                const msgSnap = await getDoc(msgRef);
                
                if (!msgSnap.exists()) {
                    alert("Message not found.");
                    return;
                }
                
                const msg = { id: msgSnap.id, ...msgSnap.data() };
                window.currentViewingMessage = msg;
                
                // Mark as read if recipient
                const user = window.auth?.currentUser;
                if (user && msg.recipientId === user.uid && !msg.read) {
                    await updateDoc(msgRef, { read: true });
                    updateUnreadCount();
                }
                
                const date = msg.createdAt ? new Date(msg.createdAt.toDate ? msg.createdAt.toDate() : msg.createdAt).toLocaleString() : 'Unknown';
                const isReceived = msg.recipientId === user?.uid;
                
                // Format sender display with level
                let senderDisplay = msg.senderName || 'Unknown';
                if (msg.senderLevel) {
                    senderDisplay = `${msg.senderName} (${msg.senderLevel})`;
                }
                
                const content = document.getElementById('view-message-content');
                content.innerHTML = `
                    <div class="view-message-header">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                            ${isReceived ? 'From' : 'To'}: <strong>${isReceived ? senderDisplay : (msg.recipientName || 'Mr Chung')}</strong>
                            ${isReceived && msg.senderLevel ? `<span style="background: #e8f5e9; color: #388e3c; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 8px;">${msg.senderLevel}</span>` : ''}
                        </div>
                        <div style="font-size: 0.85rem; color: #888;">${date}</div>
                        <h3 style="margin: 0.5rem 0; color: #0288d1;">${msg.subject || 'No Subject'}</h3>
                    </div>
                    ${msg.questionContext ? `
                        <div class="view-message-question">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <strong>ðŸ“‹ Related Question:</strong>
                                ${msg.questionId ? `<button class="btn" style="background: #1976d2; color: white; padding: 5px 12px; font-size: 0.8rem;" onclick="viewOriginalQuestion('${msg.questionId}')">ðŸ‘ï¸ View Full Question</button>` : ''}
                            </div>
                            <div style="color: #555;">${msg.questionContext}</div>
                        </div>
                    ` : ''}
                    <div class="view-message-body">${msg.message || ''}</div>
                `;
                
                // Show/hide reply button based on whether this is a received message
                document.getElementById('btn-reply-message').style.display = isReceived ? 'inline-block' : 'none';
                
                document.getElementById('view-message-modal').classList.add('visible');
                
            } catch (e) {
                console.error("Error viewing message:", e);
                alert("Error loading message.");
            }
        };

        // View original question from message
        window.viewOriginalQuestion = function(questionId) {
            const questionElement = document.getElementById(questionId);
            
            if (questionElement) {
                // Clone the question for the popup
                const clone = questionElement.cloneNode(true);
                clone.id = 'popup-question-clone';
                
                // Remove controls from clone
                clone.querySelectorAll('.worksheet-control-bar, .admin-controls').forEach(el => el.remove());
                
                // Show in a popup modal
                const popupContent = document.getElementById('question-popup-content');
                popupContent.innerHTML = '';
                popupContent.appendChild(clone);
                
                document.getElementById('question-popup-modal').classList.add('visible');
            } else {
                alert("Question not found. It may have been deleted or moved.");
            }
        };

        window.hideQuestionPopup = function() {
            document.getElementById('question-popup-modal').classList.remove('visible');
        };

        window.hideViewMessageModal = function() {
            document.getElementById('view-message-modal').classList.remove('visible');
            window.currentViewingMessage = null;
            loadInbox(); // Refresh inbox to update read status
        };

        // Reply to a message
        window.replyToMessage = function() {
            if (!window.currentViewingMessage) return;
            
            const msg = window.currentViewingMessage;
            hideViewMessageModal();
            
            // Open new message modal with pre-filled info
            document.getElementById('new-message-modal').classList.add('visible');
            document.getElementById('new-message-subject').value = `Re: ${msg.subject || 'No Subject'}`;
            document.getElementById('new-message-content').value = '';
            
            // Store the recipient info for sending
            window.replyToRecipient = {
                id: msg.senderId,
                name: msg.senderName,
                email: msg.senderEmail
            };
            
            // Hide recipient select for replies
            document.getElementById('recipient-select-group').style.display = 'none';
        };

        // Show new message modal
        window.showNewMessageModal = async function() {
            window.replyToRecipient = null;
            document.getElementById('recipient-select-group').style.display = 'block';
            document.getElementById('new-message-subject').value = '';
            document.getElementById('new-message-content').value = '';
            
            // If admin, load all students as potential recipients
            const select = document.getElementById('message-recipient');
            select.innerHTML = '<option value="">-- Select Recipient --</option>';
            
            if (window.isAdminUser) {
                // Admin can message any student
                try {
                    const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                    const usersSnap = await getDocs(collection(window.db_fs, "users"));
                    
                    const students = [];
                    usersSnap.forEach(doc => {
                        const userData = doc.data();
                        if (userData.email !== ADMIN_EMAIL) {
                            const studentName = userData.studentName || userData.parentName || 'Student';
                            const level = userData.level || (userData.students && userData.students[0]?.level) || '';
                            students.push({
                                id: doc.id,
                                email: userData.email,
                                name: studentName,
                                level: level,
                                displayName: level ? `${studentName} (${level})` : studentName
                            });
                        }
                    });
                    
                    // Sort by level then name
                    students.sort((a, b) => {
                        if (a.level && b.level) {
                            if (a.level !== b.level) return a.level.localeCompare(b.level);
                        }
                        return a.name.localeCompare(b.name);
                    });
                    
                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.dataset.email = student.email;
                        option.dataset.name = student.name;
                        option.dataset.level = student.level;
                        option.textContent = student.displayName;
                        select.appendChild(option);
                    });
                    
                    // Add "All Students" option for broadcast
                    const allOption = document.createElement('option');
                    allOption.value = 'all';
                    allOption.textContent = 'ðŸ“¢ All Students (Broadcast)';
                    select.insertBefore(allOption, select.options[1]);
                    
                } catch (e) {
                    console.error("Error loading students:", e);
                }
            } else {
                // Students can only message admin
                const option = document.createElement('option');
                option.value = 'admin';
                option.textContent = 'Mr Chung (Teacher)';
                select.appendChild(option);
            }
            
            document.getElementById('new-message-modal').classList.add('visible');
        };

        window.hideNewMessageModal = function() {
            document.getElementById('new-message-modal').classList.remove('visible');
            window.replyToRecipient = null;
        };

        // Send a new message
        window.sendNewMessage = async function() {
            const subject = document.getElementById('new-message-subject').value.trim();
            const message = document.getElementById('new-message-content').value.trim();
            
            if (!subject || !message) {
                alert("Please fill in subject and message.");
                return;
            }
            
            try {
                const user = window.auth?.currentUser;
                if (!user) {
                    alert("Please login first.");
                    return;
                }
                
                const { collection, addDoc, getDocs, query, where, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get sender info
                const senderDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                const senderData = senderDoc.exists() ? senderDoc.data() : {};
                const senderName = senderData.studentName || senderData.parentName || user.email;
                
                let recipients = [];
                
                if (window.replyToRecipient) {
                    // Reply to specific person
                    recipients.push(window.replyToRecipient);
                } else {
                    // New message - check recipient select
                    const select = document.getElementById('message-recipient');
                    const selectedValue = select.value;
                    const selectedOption = select.options[select.selectedIndex];
                    
                    if (!selectedValue) {
                        alert("Please select a recipient.");
                        return;
                    }
                    
                    if (selectedValue === 'admin') {
                        // Find admin user ID by fetching all users and filtering
                        const usersSnap = await getDocs(collection(window.db_fs, "users"));
                        let adminFound = false;
                        usersSnap.forEach(adminDoc => {
                            if (adminDoc.data().email === ADMIN_EMAIL) {
                                recipients.push({
                                    id: adminDoc.id,
                                    email: ADMIN_EMAIL,
                                    name: 'Mr Chung'
                                });
                                adminFound = true;
                            }
                        });
                        if (!adminFound) {
                            // Create placeholder if admin hasn't logged in yet
                            recipients.push({
                                id: 'admin_placeholder',
                                email: ADMIN_EMAIL,
                                name: 'Mr Chung'
                            });
                        }
                    } else if (selectedValue === 'all') {
                        // Broadcast to all students
                        const usersSnap = await getDocs(collection(window.db_fs, "users"));
                        usersSnap.forEach(userDoc => {
                            const userData = userDoc.data();
                            if (userData.email !== ADMIN_EMAIL && userDoc.id !== user.uid) {
                                recipients.push({
                                    id: userDoc.id,
                                    email: userData.email,
                                    name: userData.studentName || userData.parentName || 'Student'
                                });
                            }
                        });
                    } else {
                        // Specific student
                        recipients.push({
                            id: selectedValue,
                            email: selectedOption.dataset.email,
                            name: selectedOption.dataset.name
                        });
                    }
                }
                
                // Send message to each recipient
                for (const recipient of recipients) {
                    await addDoc(collection(window.db_fs, "messages"), {
                        senderId: user.uid,
                        senderEmail: user.email,
                        senderName: senderName,
                        recipientId: recipient.id,
                        recipientEmail: recipient.email,
                        recipientName: recipient.name,
                        subject: subject,
                        message: message,
                        read: false,
                        createdAt: new Date()
                    });
                }
                
                alert(`Message sent successfully${recipients.length > 1 ? ` to ${recipients.length} recipients` : ''}!`);
                hideNewMessageModal();
                loadInbox();
                
            } catch (e) {
                console.error("Error sending message:", e);
                alert("Error sending message: " + e.message);
            }
        };

        // =====================================================
        // CONSULT MR CHUNG FUNCTIONALITY
        // =====================================================

        window.currentConsultQuestion = null;

        window.showConsultModal = function(questionElement) {
            // Get question content
            const questionContainer = questionElement.closest('.question-container');
            if (!questionContainer) {
                alert("Could not find question.");
                return;
            }
            
            // Get question title and content
            const title = questionContainer.querySelector('h3')?.textContent || 'Question';
            const questionText = questionContainer.querySelector('p')?.textContent || '';
            
            // Store for sending
            window.currentConsultQuestion = {
                id: questionContainer.id,
                title: title,
                preview: `${title}: ${questionText.substring(0, 200)}${questionText.length > 200 ? '...' : ''}`
            };
            
            // Show preview
            document.getElementById('consult-question-preview').innerHTML = `
                <strong>ðŸ“‹ Question Reference:</strong><br>
                ${window.currentConsultQuestion.preview}
            `;
            
            document.getElementById('consult-message').value = '';
            document.getElementById('consult-modal').classList.add('visible');
        };

        window.hideConsultModal = function() {
            document.getElementById('consult-modal').classList.remove('visible');
            window.currentConsultQuestion = null;
        };

        window.sendConsultMessage = async function() {
            const message = document.getElementById('consult-message').value.trim();
            
            if (!message) {
                alert("Please enter your question or message.");
                return;
            }
            
            try {
                const user = window.auth?.currentUser;
                if (!user) {
                    alert("Please login first.");
                    return;
                }
                
                const { collection, addDoc, getDocs, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get sender info including level
                const senderDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                const senderData = senderDoc.exists() ? senderDoc.data() : {};
                const senderName = senderData.studentName || senderData.parentName || user.email;
                const senderLevel = senderData.level || (senderData.students && senderData.students[0]?.level) || '';
                
                // Find admin user ID by fetching all users and filtering
                let adminId = 'admin_placeholder';
                const usersSnap = await getDocs(collection(window.db_fs, "users"));
                usersSnap.forEach(adminDoc => {
                    if (adminDoc.data().email === ADMIN_EMAIL) {
                        adminId = adminDoc.id;
                    }
                });
                
                // Create message with student info
                await addDoc(collection(window.db_fs, "messages"), {
                    senderId: user.uid,
                    senderEmail: user.email,
                    senderName: senderName,
                    senderLevel: senderLevel,
                    recipientId: adminId,
                    recipientEmail: ADMIN_EMAIL,
                    recipientName: 'Mr Chung',
                    subject: `Question about: ${window.currentConsultQuestion?.title || 'Practice Question'}`,
                    message: message,
                    questionContext: window.currentConsultQuestion?.preview || '',
                    questionId: window.currentConsultQuestion?.id || '',
                    read: false,
                    createdAt: new Date()
                });
                
                alert("Message sent to Mr Chung! You will receive a reply in your inbox.");
                hideConsultModal();
                updateUnreadCount();
                
            } catch (e) {
                console.error("Error sending message:", e);
                alert("Error sending message: " + e.message);
            }
        };

        // Add Consult button to all question containers
        window.addConsultButtons = function() {
            document.querySelectorAll('.question-container').forEach(container => {
                // Check if button already exists
                if (container.querySelector('.consult-btn')) return;
                
                // Find the controls div or create button placement
                const controls = container.querySelector('.controls');
                if (controls) {
                    // Check if add-to-worksheet button exists
                    const addBtn = controls.querySelector('.add-to-worksheet-btn, button[onclick*="addToWorksheet"]');
                    
                    const consultBtn = document.createElement('button');
                    consultBtn.className = 'consult-btn';
                    consultBtn.type = 'button';
                    consultBtn.innerHTML = 'ðŸ’¬ Ask Mr Chung';
                    consultBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        showConsultModal(this);
                    };
                    
                    if (addBtn) {
                        addBtn.insertAdjacentElement('afterend', consultBtn);
                    } else {
                        controls.insertBefore(consultBtn, controls.firstChild);
                    }
                }
            });
        };

        // =====================================================
        // TAB & VIEW SWITCHING
        // =====================================================

        window.switchTab = function (type, btn) {
            window.currentActiveTab = type;

            // Close mobile sidebar if open
            if (window.innerWidth <= 768) {
                closeMobileSidebar();
            }

            // Update button states
            const allBtns = document.querySelectorAll('.tab-btn, #btn-sidebar-admin, #btn-sidebar-worksheet, #btn-sidebar-saved-worksheets, #btn-sidebar-practice, #btn-sidebar-inbox, #btn-sidebar-lessons');
            allBtns.forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            // Hide all views
            const mainContentArea = document.getElementById('main-content-area');
            mainContentArea.querySelectorAll('.view-content').forEach(el => {
                el.classList.add('hidden');
            });

            // Show target view
            const target = document.getElementById(`view-${type}`);
            if (target) {
                target.classList.remove('hidden');
            }

            // Handle sidebar visibility
            const oeqSidebarContent = document.getElementById('oeq-sidebar-content');
            const mcqSidebarContent = document.getElementById('mcq-sidebar-content');
            
            // List of all OEQ tabs
            const oeqTabs = ['cer', 'definition', 'single-relationship', 'double-relationship', 'fairness', 'reliability', 'accuracy', 'constant-variable', 'explanation', 'control-setup'];
            // List of special tabs (admin, worksheet, etc)
            const specialTabs = ['admin', 'worksheet', 'saved-worksheets', 'practice', 'inbox', 'lessons', 'lesson-detail'];
            
            if (oeqSidebarContent && mcqSidebarContent) {
                if (oeqTabs.includes(type)) {
                    // Show OEQ sidebar for all OEQ tabs and update topics
                    oeqSidebarContent.classList.remove('hidden');
                    mcqSidebarContent.classList.add('hidden');
                    window.currentOeqTab = type;
                    updateOeqSidebar(type);
                } else if (specialTabs.includes(type)) {
                    // Hide both sidebars for special tabs
                    oeqSidebarContent.classList.add('hidden');
                    mcqSidebarContent.classList.add('hidden');
                }
            }

            // Update border color and header line color
            const appBody = document.querySelector('.app-body');
            const headerLine = document.getElementById('header-color-line');
            if (window.typeColors[type]) {
                const color = window.typeColors[type];
                if (appBody) {
                    appBody.style.borderTopColor = color;
                }
                if (headerLine) {
                    // Create a gradient effect for the line
                    const lighterColor = adjustColorBrightness(color, 20);
                    headerLine.style.background = `linear-gradient(90deg, ${color} 0%, ${lighterColor} 50%, ${color} 100%)`;
                }
            }

            // Refresh worksheet UI when switching to worksheet tab
            if (type === 'worksheet') {
                updateWorksheetUI();
            }
            
            // Load saved worksheets when switching to that tab
            if (type === 'saved-worksheets') {
                loadSavedWorksheets();
            }
            
            // Load shared lessons when switching to lessons tab
            if (type === 'lessons') {
                loadSharedLessons();
            }
            
            // Load practice mode when switching to practice tab
            if (type === 'practice') {
                loadPracticeMode();
            }
            
            // Load inbox when switching to inbox tab
            if (type === 'inbox') {
                loadInbox();
            }
        };
        
        // Helper function to adjust color brightness
        function adjustColorBrightness(hex, percent) {
            // Remove # if present
            hex = hex.replace('#', '');
            
            // Parse the hex color
            let r = parseInt(hex.substring(0, 2), 16);
            let g = parseInt(hex.substring(2, 4), 16);
            let b = parseInt(hex.substring(4, 6), 16);
            
            // Adjust brightness
            r = Math.min(255, Math.floor(r + (255 - r) * (percent / 100)));
            g = Math.min(255, Math.floor(g + (255 - g) * (percent / 100)));
            b = Math.min(255, Math.floor(b + (255 - b) * (percent / 100)));
            
            // Convert back to hex
            return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        // =====================================================
        // MODE SWITCHING (OEQ/MCQ)
        // =====================================================

        window.switchMode = function (mode) {
            window.currentMode = mode;
            const oeqSidebar = document.getElementById('oeq-sidebar-content');
            const mcqSidebar = document.getElementById('mcq-sidebar-content');
            const container = document.getElementById('header-tabs-container');

            document.getElementById('mode-oeq').classList.remove('active');
            document.getElementById('mode-mcq').classList.remove('active');
            document.getElementById('mode-' + mode).classList.add('active');

            if (mode === 'mcq') {
                oeqSidebar.classList.add('hidden');
                mcqSidebar.classList.remove('hidden');
                document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                renderMcqHeaders();
            } else {
                oeqSidebar.classList.remove('hidden');
                mcqSidebar.classList.add('hidden');
                container.innerHTML = `<button class="tab-btn active" data-type="cer" onclick="switchTab('cer', this)">CER</button><button class="tab-btn" data-type="definition" onclick="switchTab('definition', this)">Definition</button><button class="tab-btn" data-type="single-relationship" onclick="switchTab('single-relationship', this)">Single Relationship</button><button class="tab-btn" data-type="double-relationship" onclick="switchTab('double-relationship', this)">Double Relationship</button><button class="tab-btn" data-type="fairness" onclick="switchTab('fairness', this)">Fairness</button><button class="tab-btn" data-type="reliability" onclick="switchTab('reliability', this)">Reliability</button><button class="tab-btn" data-type="accuracy" onclick="switchTab('accuracy', this)">Accuracy</button><button class="tab-btn" data-type="constant-variable" onclick="switchTab('constant-variable', this)">Constant Variable</button><button class="tab-btn" data-type="explanation" onclick="switchTab('explanation', this)">Explanation</button><button class="tab-btn" data-type="control-setup" onclick="switchTab('control-setup', this)">Control Set-up</button>`;
                switchTab('cer', document.querySelector('.tab-btn[data-type="cer"]'));
                if (window.isAdminUser) document.getElementById('btn-sidebar-admin').classList.remove('hidden');
            }
        };

        // =====================================================
        // MCQ FUNCTIONALITY
        // =====================================================

        window.renderMcqHeaders = function () {
            const container = document.getElementById('header-tabs-container');
            const topics = window.mcqCurriculum[window.currentMcqLevel] || [];
            const pastelColors = ['#AEC6CF', '#FFB7B2', '#FFDAC1', '#E2F0CB', '#C7CEEA', '#FDFD96', '#B5EAD7', '#FF9AA2', '#E0BBE4', '#ADD8E6'];

            container.innerHTML = topics.map((t, i) => {
                const topicId = t.toLowerCase().replace(/\s+/g, '-');
                const activeClass = i === 0 ? 'active' : '';
                const color = pastelColors[i % pastelColors.length];
                if (i === 0) window.currentMcqTopic = topicId;
                return `<button class="tab-btn ${activeClass}" onclick="switchMcqTopicAndTab('${topicId}', this)" style="background-color: ${color};">${t}</button>`;
            }).join('');

            // Set initial header line color to first topic's color
            const headerLine = document.getElementById('header-color-line');
            if (headerLine && topics.length > 0) {
                const firstColor = pastelColors[0];
                const lighterColor = adjustColorBrightness(firstColor, 20);
                headerLine.style.background = `linear-gradient(90deg, ${firstColor} 0%, ${lighterColor} 50%, ${firstColor} 100%)`;
            }

            renderMcqQuestionList();
        };

        window.switchMcqTopicAndTab = function (topicId, btn) {
            document.querySelectorAll('#header-tabs-container .tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            window.currentMcqTopic = topicId;
            
            // Update header line color based on the button's background color
            const headerLine = document.getElementById('header-color-line');
            if (headerLine && btn) {
                const btnColor = btn.style.backgroundColor || '#AEC6CF';
                // Convert rgb to hex if needed
                let hexColor = btnColor;
                if (btnColor.startsWith('rgb')) {
                    const rgb = btnColor.match(/\d+/g);
                    if (rgb) {
                        hexColor = '#' + ((1 << 24) + (parseInt(rgb[0]) << 16) + (parseInt(rgb[1]) << 8) + parseInt(rgb[2])).toString(16).slice(1);
                    }
                }
                const lighterColor = adjustColorBrightness(hexColor, 20);
                headerLine.style.background = `linear-gradient(90deg, ${hexColor} 0%, ${lighterColor} 50%, ${hexColor} 100%)`;
            }
            
            renderMcqQuestionList();
        };

        window.renderMcqQuestionList = function () {
            const nav = document.getElementById('mcq-question-nav');
            if (!nav) return;

            const topicId = `topic-mcq-${window.currentMcqTopic}`;
            const container = document.getElementById(topicId);
            const questions = container ? container.querySelectorAll('.question-container') : [];

            nav.innerHTML = Array.from(questions).map((q, i) => {
                const qId = q.id;
                return `<button onclick="scrollToMcqQuestion('${qId}', this)">Question ${i + 1}</button>`;
            }).join('');

            document.querySelectorAll('.topic-content').forEach(t => t.classList.add('hidden'));
            if (container) container.classList.remove('hidden');
        };

        window.scrollToMcqQuestion = function (qId, btn) {
            document.querySelectorAll('#mcq-question-nav button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const q = document.getElementById(qId);
            if (q) q.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        window.checkMcq = function (containerId) {
            const container = document.getElementById(containerId);
            const selected = container.querySelector('input[type="radio"]:checked');
            if (!selected) return alert("Please select an option!");

            const isCorrect = selected.dataset.correct === 'true';
            
            const allOptions = container.querySelectorAll('.mcq-option');
            allOptions.forEach(opt => {
                const radio = opt.querySelector('input');
                // Remove any existing feedback icons
                opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());
                
                if (radio.dataset.correct === 'true') {
                    opt.style.borderColor = 'var(--correct-color)';
                    opt.style.background = '#e8f5e9';
                    // Add checkmark inside the correct answer option
                    const icon = document.createElement('span');
                    icon.className = 'option-feedback-icon';
                    icon.textContent = 'âœ”';
                    icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #28a745; margin-left: auto; padding-left: 10px;';
                    opt.style.display = 'flex';
                    opt.style.alignItems = 'center';
                    opt.appendChild(icon);
                } else if (radio.checked) {
                    opt.style.borderColor = 'var(--incorrect-color)';
                    opt.style.background = '#ffebee';
                    // Add cross inside the wrong selected option
                    const icon = document.createElement('span');
                    icon.className = 'option-feedback-icon';
                    icon.textContent = 'âœ˜';
                    icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #dc3545; margin-left: auto; padding-left: 10px;';
                    opt.style.display = 'flex';
                    opt.style.alignItems = 'center';
                    opt.appendChild(icon);
                }
                radio.disabled = true;
            });
            
            const submitBtn = container.querySelector('.submit-btn');
            submitBtn.disabled = true;
            
            // Show explanation if it exists
            const explanationBox = container.querySelector('.explanation-box');
            if (explanationBox) {
                explanationBox.style.display = 'block';
            }
            
            // Show video if it exists
            const videoContainer = container.querySelector('.video-container');
            if (videoContainer) {
                videoContainer.style.display = 'block';
            }
            
            // Track answer for practice mode
            if (window.trackAnswerForPractice) {
                const questionId = container.closest('.question-container')?.id;
                if (questionId) {
                    window.trackAnswerForPractice(questionId, isCorrect);
                }
            }
        };

        // =====================================================
        // ADMIN FUNCTIONALITY
        // =====================================================

        window.handleTopicChange = function (value) {
            const newTopicInput = document.getElementById('admin-new-topic');
            if (value === 'new-topic') {
                newTopicInput.classList.remove('hidden');
            } else {
                newTopicInput.classList.add('hidden');
            }
        };

        window.updateAdminTopicsByLevel = function (level) {
            const topicSelect = document.getElementById('admin-topic');
            const topics = window.mcqCurriculum[level] || [];
            let html = topics.map(t => `<option value="${t.toLowerCase().replace(/\s+/g, '-')}">${t}</option>`).join('');
            html += `<option value="new-topic">-- Add Custom Topic --</option>`;
            topicSelect.innerHTML = html;
        };

        window.handleCategoryChange = function (value) {
            const mcqOptions = document.getElementById('mcq-options-container');
            const levelContainer = document.getElementById('admin-level-container');
            const previewInstructions = document.querySelector('#admin-preview-section p');
            const processBtn = document.getElementById('admin-process-btn');

            if (value === 'mcq') {
                mcqOptions.classList.remove('hidden');
                levelContainer.classList.remove('hidden');
                if (processBtn) processBtn.classList.add('hidden');
                updateAdminTopicsByLevel(document.getElementById('admin-level').value);
                if (previewInstructions) previewInstructions.classList.add('hidden');
            } else {
                mcqOptions.classList.add('hidden');
                levelContainer.classList.add('hidden');
                if (processBtn) processBtn.classList.remove('hidden');
                const topicSelect = document.getElementById('admin-topic');
                topicSelect.innerHTML = `
                    <option value="heat">Heat</option>
                    <option value="light">Light</option>
                    <option value="materials">Materials</option>
                    <option value="air">Air</option>
                    <option value="water">Water</option>
                    <option value="new-topic">-- Add Custom Topic --</option>
                `;
                if (previewInstructions) previewInstructions.classList.remove('hidden');
            }
        };

        function addAdminBlock(type) {
            const id = Date.now();
            const block = { id, type, value: '' };
            
            // Video and explanation should always be at the end
            if (type === 'video' || type === 'explanation') {
                window.adminBlocks.push(block);
            } else {
                // Insert before any video/explanation blocks
                const lastContentIndex = window.adminBlocks.findIndex(b => b.type === 'video' || b.type === 'explanation');
                if (lastContentIndex === -1) {
                    window.adminBlocks.push(block);
                } else {
                    window.adminBlocks.splice(lastContentIndex, 0, block);
                }
            }
            renderAdminBlocks();
        }

        function renderAdminBlocks() {
            const container = document.getElementById('admin-blocks');
            if (!container) return;
            
            let html = '';
            let addedSeparator = false;
            
            window.adminBlocks.forEach((block, index) => {
                // Add separator before first video/explanation block
                if (!addedSeparator && (block.type === 'video' || block.type === 'explanation')) {
                    html += `<div style="margin: 1.5rem 0; padding: 0.8rem; background: linear-gradient(90deg, #e3f2fd 0%, #f5f5f5 50%, #e3f2fd 100%); border-radius: 8px; text-align: center;">
                        <span style="color: #666; font-size: 0.85rem; font-weight: 500;">ðŸ“Œ Shown after students answer (drag blocks above to reorder)</span>
                    </div>`;
                    addedSeparator = true;
                }
                
                // Handle table blocks specially
                if (block.type === 'table') {
                    html += renderTableBlock(block);
                    return;
                }
                
                let inputHtml = '';
                if (block.type === 'text' || block.type === 'answer' || block.type === 'explanation') {
                    const placeholders = {
                        'answer': 'Enter text to be blanked... Use [brackets] around words to make them blanks.',
                        'explanation': 'Enter step-by-step explanation...',
                        'text': 'Enter question text...'
                    };
                    inputHtml = `<textarea class="auth-input" style="height: 100px; margin-top: 10px;" oninput="updateBlockValue(${block.id}, this.value)" placeholder="${placeholders[block.type]}">${block.value}</textarea>`;
                } else if (block.type === 'image') {
                    const previewUrl = convertDropboxUrl(block.value);
                    inputHtml = `
                        <input type="text" class="auth-input" style="margin-top: 10px;" oninput="updateBlockValue(${block.id}, this.value); updateImagePreview(${block.id})" value="${block.value}" placeholder="Enter image URL (Dropbox, Imgur, etc.)...">
                        <div id="img-preview-${block.id}" style="margin-top: 10px; text-align: center;">
                            ${block.value ? `<img src="${previewUrl}" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #ddd;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><span style="display: none; color: #dc3545; font-size: 0.85rem;">âš ï¸ Image failed to load</span>` : '<span style="color: #888; font-size: 0.85rem;">Image preview will appear here</span>'}
                        </div>
                    `;
                } else if (block.type === 'video') {
                    inputHtml = `<input type="text" class="auth-input" style="margin-top: 10px;" oninput="updateBlockValue(${block.id}, this.value)" value="${block.value}" placeholder="Enter Video URL (Dropbox or YouTube)...">`;
                }

                const typeColors = {
                    'answer': 'background: #fffdf0; border-color: #fbc02d;',
                    'explanation': 'background: #f0f4ff; border-color: #007bff;',
                    'video': 'background: #fdf2f2; border-color: #dc3545;',
                    'image': 'background: #f5f5f5; border-color: #9e9e9e;',
                    'text': ''
                };
                
                const typeLabels = {
                    'text': 'ðŸ“ TEXT BLOCK',
                    'answer': 'âœï¸ ANSWER BLOCK (fill-in-blank)',
                    'explanation': 'ðŸ’¡ EXPLANATION (shown after answer)',
                    'video': 'ðŸŽ¬ VIDEO (shown after answer, optional)',
                    'image': 'ðŸ–¼ï¸ IMAGE BLOCK'
                };
                
                // Only text, image, answer, and table blocks are draggable
                // Video and explanation are fixed at the end
                const isDraggable = ['text', 'image', 'answer', 'table'].includes(block.type);
                const dragAttrs = isDraggable ? `draggable="true" 
                             ondragstart="handleDragStart(event, ${block.id})" 
                             ondragend="handleDragEnd(event)"
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)"
                             ondrop="handleDrop(event, ${block.id})"` : '';
                const dragHandle = isDraggable ? `<span class="drag-handle" title="Drag to reorder">â‹®â‹®</span>` : '';
                const leftPadding = isDraggable ? '40px' : '1rem';

                html += `
                        <div class="admin-block ${isDraggable ? '' : 'no-drag'}" data-block-id="${block.id}" ${dragAttrs}
                             style="margin-bottom: 1rem; position: relative; padding: 1rem 1rem 1rem ${leftPadding}; border: 1px solid #eee; border-radius: 8px; ${typeColors[block.type] || ''}">
                            ${dragHandle}
                            <span style="font-size: 0.8rem; color: #666; font-weight: 600;">${typeLabels[block.type] || block.type.toUpperCase()}</span>
                            <button onclick="removeAdminBlock(${block.id})" style="position: absolute; right: 10px; top: 10px; border: none; background: none; cursor: pointer; color: #dc3545; font-size: 1.2rem;">âœ•</button>
                            ${inputHtml}
                        </div>
                    `;
            });
            
            container.innerHTML = html;
            
            // Re-attach any event listeners if needed
            initDragAndDrop();
        }
        
        // ==================== DRAG AND DROP FUNCTIONS ====================
        
        window.draggedBlockId = null;
        
        window.initDragAndDrop = function() {
            // Initialize is called after render, nothing special needed here
            // All handlers are inline in the HTML
        };
        
        window.handleDragStart = function(event, blockId) {
            window.draggedBlockId = blockId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', blockId);
        };
        
        window.handleDragEnd = function(event) {
            event.target.classList.remove('dragging');
            // Remove drag-over class from all blocks
            document.querySelectorAll('.admin-block').forEach(block => {
                block.classList.remove('drag-over');
            });
            window.draggedBlockId = null;
        };
        
        window.handleDragOver = function(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const block = event.target.closest('.admin-block');
            if (block && !block.classList.contains('dragging')) {
                // Remove drag-over from other blocks
                document.querySelectorAll('.admin-block').forEach(b => {
                    if (b !== block) b.classList.remove('drag-over');
                });
                block.classList.add('drag-over');
            }
        };
        
        window.handleDragLeave = function(event) {
            const block = event.target.closest('.admin-block');
            if (block) {
                block.classList.remove('drag-over');
            }
        };
        
        window.handleDrop = function(event, targetBlockId) {
            event.preventDefault();
            const block = event.target.closest('.admin-block');
            if (block) {
                block.classList.remove('drag-over');
            }
            
            if (window.draggedBlockId === null || window.draggedBlockId === targetBlockId) return;
            
            // Find the blocks
            const draggedBlock = window.adminBlocks.find(b => b.id === window.draggedBlockId);
            const targetBlock = window.adminBlocks.find(b => b.id === targetBlockId);
            
            // Don't allow dragging video/explanation blocks
            if (draggedBlock && (draggedBlock.type === 'video' || draggedBlock.type === 'explanation')) {
                window.draggedBlockId = null;
                return;
            }
            
            // Don't allow dropping onto video/explanation blocks
            if (targetBlock && (targetBlock.type === 'video' || targetBlock.type === 'explanation')) {
                window.draggedBlockId = null;
                return;
            }
            
            // Find indices
            const fromIndex = window.adminBlocks.findIndex(b => b.id === window.draggedBlockId);
            const toIndex = window.adminBlocks.findIndex(b => b.id === targetBlockId);
            
            if (fromIndex === -1 || toIndex === -1) return;
            
            // Reorder the array
            const [movedBlock] = window.adminBlocks.splice(fromIndex, 1);
            window.adminBlocks.splice(toIndex, 0, movedBlock);
            
            // Re-render
            renderAdminBlocks();
            
            window.draggedBlockId = null;
        };
        
        // ==================== END DRAG AND DROP ====================
        
        // Update image preview when URL changes
        window.updateImagePreview = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            const previewDiv = document.getElementById(`img-preview-${blockId}`);
            if (block && previewDiv) {
                const previewUrl = convertDropboxUrl(block.value);
                if (block.value) {
                    previewDiv.innerHTML = `<img src="${previewUrl}" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #ddd;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><span style="display: none; color: #dc3545; font-size: 0.85rem;">âš ï¸ Image failed to load</span>`;
                } else {
                    previewDiv.innerHTML = '<span style="color: #888; font-size: 0.85rem;">Image preview will appear here</span>';
                }
            }
        };

        // ==================== TABLE EDITOR FUNCTIONS ====================
        
        // Pastel colors for table
        const pastelColors = [
            '#FFFFFF', '#F5F5F5', '#E8E8E8',  // Whites/Grays
            '#FFB3BA', '#FFDFBA', '#FFFFBA',  // Light Pink, Peach, Yellow
            '#BAFFC9', '#BAE1FF', '#E0BBE4',  // Mint, Sky Blue, Lavender
            '#FFC6D9', '#C9FFE5', '#D4F0F0',  // Rose, Seafoam, Aqua
            '#FCE4EC', '#E8F5E9', '#E3F2FD',  // Pale Pink, Pale Green, Pale Blue
            '#FFF8E1', '#F3E5F5', '#ECEFF1'   // Cream, Pale Purple, Blue Gray
        ];

        // Initialize table grid selector
        window.initTableGridSelector = function() {
            const grid = document.getElementById('table-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'table-grid-cell';
                    cell.dataset.row = row + 1;
                    cell.dataset.col = col + 1;
                    cell.addEventListener('mouseenter', handleGridHover);
                    cell.addEventListener('click', handleGridClick);
                    grid.appendChild(cell);
                }
            }
        };

        function handleGridHover(e) {
            const targetRow = parseInt(e.target.dataset.row);
            const targetCol = parseInt(e.target.dataset.col);
            const cells = document.querySelectorAll('.table-grid-cell');
            
            cells.forEach(cell => {
                const cellRow = parseInt(cell.dataset.row);
                const cellCol = parseInt(cell.dataset.col);
                if (cellRow <= targetRow && cellCol <= targetCol) {
                    cell.classList.add('selected');
                } else {
                    cell.classList.remove('selected');
                }
            });
            
            document.getElementById('grid-size-label').innerHTML = `<strong>${targetCol} Ã— ${targetRow}</strong> table`;
        }

        function handleGridClick(e) {
            const rows = parseInt(e.target.dataset.row);
            const cols = parseInt(e.target.dataset.col);
            createTableBlock(rows, cols);
            hideTableGridSelector();
        }

        window.showTableGridSelector = function(btn) {
            const selector = document.getElementById('table-grid-selector');
            if (!selector) {
                console.error('Table grid selector not found');
                return;
            }
            
            // Toggle - if already visible, hide it
            if (selector.classList.contains('visible')) {
                hideTableGridSelector();
                return;
            }
            
            // Initialize grid if needed
            if (!document.querySelector('.table-grid-cell')) {
                initTableGridSelector();
            }
            
            // Get button position relative to viewport
            const rect = btn.getBoundingClientRect();
            const selectorWidth = 280;
            const selectorHeight = 320;
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            const padding = 15;
            
            let top, left;
            let showAbove = true;
            
            // Calculate horizontal position (centered on button)
            left = rect.left + (rect.width / 2) - (selectorWidth / 2);
            
            // Keep within horizontal bounds
            if (left < padding) {
                left = padding;
            } else if (left + selectorWidth > viewportWidth - padding) {
                left = viewportWidth - selectorWidth - padding;
            }
            
            // Determine vertical position
            const spaceAbove = rect.top;
            const spaceBelow = viewportHeight - rect.bottom;
            
            if (spaceAbove >= selectorHeight + padding) {
                // Enough space above - show above
                top = rect.top - selectorHeight - 10;
                showAbove = true;
            } else if (spaceBelow >= selectorHeight + padding) {
                // Not enough above but enough below - show below
                top = rect.bottom + 10;
                showAbove = false;
            } else {
                // Not enough space either way - center in viewport
                top = Math.max(padding, (viewportHeight - selectorHeight) / 2);
                showAbove = spaceAbove > spaceBelow; // Arrow points to closer edge
            }
            
            // Apply position
            selector.style.top = top + 'px';
            selector.style.left = left + 'px';
            
            // Update arrow direction
            if (showAbove) {
                selector.classList.remove('arrow-up');
                selector.classList.add('arrow-down');
            } else {
                selector.classList.remove('arrow-down');
                selector.classList.add('arrow-up');
            }
            
            selector.classList.add('visible');
            
            // Reset grid selection
            document.querySelectorAll('.table-grid-cell').forEach(c => c.classList.remove('selected'));
            document.getElementById('grid-size-label').innerHTML = '<span style="color: #888;">Hover to select</span>';
            
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeGridSelectorOnClickOutside, true);
            }, 100);
        };

        function hideTableGridSelector() {
            const selector = document.getElementById('table-grid-selector');
            if (selector) {
                selector.classList.remove('visible');
            }
            document.removeEventListener('click', closeGridSelectorOnClickOutside, true);
        }

        function closeGridSelectorOnClickOutside(e) {
            const selector = document.getElementById('table-grid-selector');
            const btn = document.getElementById('add-table-btn');
            if (selector && !selector.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
                hideTableGridSelector();
            }
        }

        function createTableBlock(rows, cols) {
            // Create table data structure
            const tableData = {
                rows: rows,
                cols: cols,
                cells: [],
                headerRow: true,
                colWidths: Array(cols).fill('auto')
            };
            
            // Initialize cells with empty content
            for (let r = 0; r < rows; r++) {
                const rowData = [];
                for (let c = 0; c < cols; c++) {
                    rowData.push({
                        content: r === 0 ? `Header ${c + 1}` : '',
                        align: 'left',
                        vAlign: 'middle',
                        bgColor: r === 0 ? '#E8E8E8' : '#FFFFFF'
                    });
                }
                tableData.cells.push(rowData);
            }
            
            const blockId = Date.now();
            window.adminBlocks.push({
                id: blockId,
                type: 'table',
                value: tableData
            });
            
            renderAdminBlocks();
            
            // Scroll to the new table
            setTimeout(() => {
                const tableBlock = document.getElementById(`table-block-${blockId}`);
                if (tableBlock) {
                    tableBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        // Render table in admin blocks
        window.renderTableBlock = function(block) {
            const tableData = block.value;
            const blockId = block.id;
            
            // Build a map of cells that are hidden due to merging
            const hiddenCells = new Set();
            if (tableData.mergedCells) {
                tableData.mergedCells.forEach(merge => {
                    for (let r = merge.startRow; r <= merge.endRow; r++) {
                        for (let c = merge.startCol; c <= merge.endCol; c++) {
                            if (r !== merge.startRow || c !== merge.startCol) {
                                hiddenCells.add(`${r}-${c}`);
                            }
                        }
                    }
                });
            }
            
            // Build a map of merge info for cells that start a merge
            const mergeMap = {};
            if (tableData.mergedCells) {
                tableData.mergedCells.forEach(merge => {
                    mergeMap[`${merge.startRow}-${merge.startCol}`] = {
                        colspan: merge.endCol - merge.startCol + 1,
                        rowspan: merge.endRow - merge.startRow + 1
                    };
                });
            }
            
            let tableHtml = `<table class="admin-table" id="admin-table-${blockId}">`;
            
            for (let r = 0; r < tableData.rows; r++) {
                tableHtml += `<tr data-row="${r}">`;
                for (let c = 0; c < tableData.cols; c++) {
                    // Skip hidden cells
                    if (hiddenCells.has(`${r}-${c}`)) {
                        continue;
                    }
                    
                    const cell = tableData.cells[r][c];
                    const tag = (r === 0 && tableData.headerRow) ? 'th' : 'td';
                    const colWidth = tableData.colWidths && tableData.colWidths[c] ? `width: ${tableData.colWidths[c]}px;` : '';
                    const rowHeight = tableData.rowHeights && tableData.rowHeights[r] ? `height: ${tableData.rowHeights[r]}px;` : '';
                    
                    // Check for merge attributes
                    const mergeInfo = mergeMap[`${r}-${c}`];
                    const colspanAttr = mergeInfo && mergeInfo.colspan > 1 ? `colspan="${mergeInfo.colspan}"` : '';
                    const rowspanAttr = mergeInfo && mergeInfo.rowspan > 1 ? `rowspan="${mergeInfo.rowspan}"` : '';
                    const mergedClass = mergeInfo ? 'merged-cell' : '';
                    
                    tableHtml += `<${tag} 
                        contenteditable="true" 
                        data-row="${r}" 
                        data-col="${c}" 
                        data-block="${blockId}"
                        ${colspanAttr}
                        ${rowspanAttr}
                        class="${mergedClass}"
                        style="text-align: ${cell.align}; vertical-align: ${cell.vAlign || 'middle'}; background-color: ${cell.bgColor}; ${colWidth} ${rowHeight}"
                        onclick="selectTableCell(this, event)"
                        onblur="updateTableCell(this)"
                        oninput="updateTableCell(this)"
                        onmousedown="handleTableCellMouseDown(event, ${blockId}, ${r}, ${c})"
                    >${cell.content}</${tag}>`;
                }
                tableHtml += '</tr>';
            }
            
            tableHtml += '</table>';
            
            return `
                <div class="admin-block" id="table-block-${blockId}" data-block-id="${blockId}" draggable="true"
                     ondragstart="handleDragStart(event, ${blockId})" 
                     ondragend="handleDragEnd(event)"
                     ondragover="handleDragOver(event)" 
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event, ${blockId})"
                     style="margin-bottom: 1rem; position: relative; padding: 1rem 1rem 1rem 40px; border: 1px solid #81c784; border-radius: 8px; background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);">
                    <span class="drag-handle" title="Drag to reorder">â‹®â‹®</span>
                    <span style="font-size: 0.8rem; color: #2e7d32; font-weight: 600;">ðŸ“Š TABLE BLOCK</span>
                    <button onclick="removeAdminBlock(${blockId})" style="position: absolute; right: 10px; top: 10px; border: none; background: none; cursor: pointer; color: #dc3545; font-size: 1.2rem;">âœ•</button>
                    
                    <div class="admin-table-wrapper" style="margin-top: 10px;">
                        <div class="table-toolbar">
                            <div class="table-toolbar-group">
                                <label>Select:</label>
                                <button onclick="selectTableRow(${blockId})" title="Select Entire Row">â˜° Row</button>
                                <button onclick="selectTableColumn(${blockId})" title="Select Entire Column">â•‘ Col</button>
                                <button onclick="selectEntireTable(${blockId})" title="Select Entire Table">â–£ All</button>
                                <button onclick="clearCellSelection(${blockId})" title="Clear Selection">âœ•</button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Merge:</label>
                                <button onclick="mergeCells(${blockId})" title="Merge Selected Cells">âŠž Merge</button>
                                <button onclick="unmergeCells(${blockId})" title="Unmerge Cell">âŠŸ Unmerge</button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Align:</label>
                                <button onclick="setTableAlignment(${blockId}, 'left')" title="Align Left">â¬…</button>
                                <button onclick="setTableAlignment(${blockId}, 'center')" title="Align Center">â¬Œ</button>
                                <button onclick="setTableAlignment(${blockId}, 'right')" title="Align Right">âž¡</button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>V-Align:</label>
                                <button onclick="setTableVerticalAlignment(${blockId}, 'top')" title="Align Top">â¬†</button>
                                <button onclick="setTableVerticalAlignment(${blockId}, 'middle')" title="Align Middle">â¬</button>
                                <button onclick="setTableVerticalAlignment(${blockId}, 'bottom')" title="Align Bottom">â¬‡</button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Color:</label>
                                <button onclick="showColorPicker(${blockId}, 'selection')" title="Color Selection">ðŸŽ¨</button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Rows:</label>
                                <button onclick="addTableRow(${blockId})" title="Add Row">+</button>
                                <button onclick="deleteTableRow(${blockId})" class="danger" title="Delete Row">âˆ’</button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Cols:</label>
                                <button onclick="addTableColumn(${blockId})" title="Add Column">+</button>
                                <button onclick="deleteTableColumn(${blockId})" class="danger" title="Delete Column">âˆ’</button>
                            </div>
                        </div>
                        <p style="font-size: 0.75rem; color: #666; margin: 5px 0; padding: 0 15px;">ðŸ’¡ Shift+Click or Ctrl+Click to select multiple cells for merging</p>
                        <div class="admin-table-container">
                            ${tableHtml}
                        </div>
                    </div>
                    
                    <!-- Color Picker Dropdown -->
                    <div id="color-picker-${blockId}" class="color-picker-dropdown">
                        <h5 id="color-picker-title-${blockId}">Select Color</h5>
                        <div class="color-palette">
                            ${pastelColors.map(color => `
                                <div class="color-swatch" 
                                    style="background-color: ${color};" 
                                    onclick="applyTableColor(${blockId}, '${color}')"
                                    title="${color}">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        };

        // Track selected cell for operations
        window.selectedTableCell = null;
        window.selectedCells = []; // Array of {row, col, blockId} for multi-select
        window.colorPickerMode = null; // 'row', 'col', or 'cell'
        window.colorPickerBlockId = null;

        window.selectTableCell = function(cell, event) {
            const blockId = parseInt(cell.dataset.block);
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            
            // Check for Shift or Ctrl key for multi-selection
            if (event && (event.shiftKey || event.ctrlKey || event.metaKey)) {
                // Multi-select mode
                const cellKey = `${row}-${col}`;
                const existingIndex = window.selectedCells.findIndex(c => 
                    c.row === row && c.col === col && c.blockId === blockId
                );
                
                if (event.shiftKey && window.selectedCells.length > 0) {
                    // Shift+Click: Select range from last selected to current
                    const lastCell = window.selectedCells[window.selectedCells.length - 1];
                    if (lastCell.blockId === blockId) {
                        const startRow = Math.min(lastCell.row, row);
                        const endRow = Math.max(lastCell.row, row);
                        const startCol = Math.min(lastCell.col, col);
                        const endCol = Math.max(lastCell.col, col);
                        
                        // Clear existing selection and select range
                        window.selectedCells = [];
                        for (let r = startRow; r <= endRow; r++) {
                            for (let c = startCol; c <= endCol; c++) {
                                window.selectedCells.push({ row: r, col: c, blockId });
                            }
                        }
                    }
                } else if (existingIndex >= 0) {
                    // Ctrl+Click on already selected: deselect
                    window.selectedCells.splice(existingIndex, 1);
                } else {
                    // Ctrl+Click on new cell: add to selection
                    window.selectedCells.push({ row, col, blockId });
                }
                
                // Update visual selection
                updateCellSelectionVisual(blockId);
            } else {
                // Single selection mode - clear multi-select
                window.selectedCells = [{ row, col, blockId }];
                
                // Remove all previous selections
                document.querySelectorAll('.admin-table td.selected-cell, .admin-table th.selected-cell').forEach(c => {
                    c.classList.remove('selected-cell');
                });
                document.querySelectorAll('.admin-table td.cell-selected, .admin-table th.cell-selected').forEach(c => {
                    c.classList.remove('cell-selected');
                });
                
                cell.classList.add('selected-cell');
            }
            
            window.selectedTableCell = cell;
        };
        
        window.updateCellSelectionVisual = function(blockId) {
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Clear existing selection visual
            table.querySelectorAll('.cell-selected').forEach(c => c.classList.remove('cell-selected'));
            table.querySelectorAll('.selected-cell').forEach(c => c.classList.remove('selected-cell'));
            
            // Apply selection visual to all selected cells
            window.selectedCells.forEach(sel => {
                if (sel.blockId === blockId) {
                    const cell = table.querySelector(`[data-row="${sel.row}"][data-col="${sel.col}"]`);
                    if (cell) {
                        cell.classList.add('cell-selected');
                    }
                }
            });
        };
        
        window.clearCellSelection = function(blockId) {
            window.selectedCells = [];
            window.selectedTableCell = null;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (table) {
                table.querySelectorAll('.cell-selected, .selected-cell, .selected-row, .selected-col').forEach(c => {
                    c.classList.remove('cell-selected', 'selected-cell', 'selected-row', 'selected-col');
                });
                table.classList.remove('selected-all');
            }
            
            // Also clear table selection
            window.tableSelection = { blockId: null, type: null, row: null, col: null };
        };
        
        // ==================== MERGE CELLS FUNCTIONS ====================
        
        window.mergeCells = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            // Get selected cells for this block
            const selectedForBlock = window.selectedCells.filter(c => c.blockId === blockId);
            
            if (selectedForBlock.length < 2) {
                alert('Please select at least 2 cells to merge. Use Shift+Click or Ctrl+Click to select multiple cells.');
                return;
            }
            
            // Find the bounding rectangle of selected cells
            const rows = selectedForBlock.map(c => c.row);
            const cols = selectedForBlock.map(c => c.col);
            const startRow = Math.min(...rows);
            const endRow = Math.max(...rows);
            const startCol = Math.min(...cols);
            const endCol = Math.max(...cols);
            
            // Check if selection forms a complete rectangle
            const expectedCount = (endRow - startRow + 1) * (endCol - startCol + 1);
            if (selectedForBlock.length !== expectedCount) {
                alert('Please select a rectangular area of cells to merge.');
                return;
            }
            
            // Check if any of the selected cells are already part of a merge
            if (!block.value.mergedCells) {
                block.value.mergedCells = [];
            }
            
            for (const merge of block.value.mergedCells) {
                for (let r = startRow; r <= endRow; r++) {
                    for (let c = startCol; c <= endCol; c++) {
                        if (r >= merge.startRow && r <= merge.endRow && 
                            c >= merge.startCol && c <= merge.endCol) {
                            alert('Cannot merge: some selected cells are already part of a merged region. Unmerge them first.');
                            return;
                        }
                    }
                }
            }
            
            // Combine content from all cells into the top-left cell
            let combinedContent = '';
            for (let r = startRow; r <= endRow; r++) {
                for (let c = startCol; c <= endCol; c++) {
                    const cellContent = block.value.cells[r][c].content.trim();
                    if (cellContent) {
                        if (combinedContent) combinedContent += ' ';
                        combinedContent += cellContent;
                    }
                }
            }
            block.value.cells[startRow][startCol].content = combinedContent;
            
            // Add the merge info
            block.value.mergedCells.push({
                startRow, endRow, startCol, endCol
            });
            
            // Clear selection and re-render
            window.selectedCells = [];
            renderAdminBlocks();
        };
        
        window.unmergeCells = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table' || !block.value.mergedCells) return;
            
            // Find which merge the selected cell belongs to
            if (!window.selectedTableCell || parseInt(window.selectedTableCell.dataset.block) !== blockId) {
                alert('Please click on a merged cell to unmerge it.');
                return;
            }
            
            const row = parseInt(window.selectedTableCell.dataset.row);
            const col = parseInt(window.selectedTableCell.dataset.col);
            
            // Find the merge that contains this cell
            const mergeIndex = block.value.mergedCells.findIndex(merge => 
                row >= merge.startRow && row <= merge.endRow &&
                col >= merge.startCol && col <= merge.endCol
            );
            
            if (mergeIndex === -1) {
                alert('This cell is not part of a merged region.');
                return;
            }
            
            // Remove the merge
            block.value.mergedCells.splice(mergeIndex, 1);
            
            // Clean up empty array
            if (block.value.mergedCells.length === 0) {
                delete block.value.mergedCells;
            }
            
            renderAdminBlocks();
        };
        
        // ==================== END MERGE CELLS FUNCTIONS ====================

        window.updateTableCell = function(cell) {
            const blockId = parseInt(cell.dataset.block);
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (block && block.type === 'table') {
                block.value.cells[row][col].content = cell.textContent;
            }
        };

        window.setTableAlignment = function(blockId, alignment) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Check for table selection first (row/col/all)
            if (window.tableSelection.blockId === blockId && window.tableSelection.type) {
                const sel = window.tableSelection;
                
                if (sel.type === 'all') {
                    // Align entire table
                    for (let r = 0; r < block.value.rows; r++) {
                        for (let c = 0; c < block.value.cols; c++) {
                            const cell = table.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            if (cell) {
                                cell.style.textAlign = alignment;
                                block.value.cells[r][c].align = alignment;
                            }
                        }
                    }
                } else if (sel.type === 'row') {
                    // Align selected row
                    const row = sel.row;
                    for (let c = 0; c < block.value.cols; c++) {
                        const cell = table.querySelector(`[data-row="${row}"][data-col="${c}"]`);
                        if (cell) {
                            cell.style.textAlign = alignment;
                            block.value.cells[row][c].align = alignment;
                        }
                    }
                } else if (sel.type === 'col') {
                    // Align selected column
                    const col = sel.col;
                    for (let r = 0; r < block.value.rows; r++) {
                        const cell = table.querySelector(`[data-row="${r}"][data-col="${col}"]`);
                        if (cell) {
                            cell.style.textAlign = alignment;
                            block.value.cells[r][col].align = alignment;
                        }
                    }
                }
                return;
            }
            
            // Check for multi-cell selection
            const selectedForBlock = window.selectedCells.filter(c => c.blockId === blockId);
            if (selectedForBlock.length > 0) {
                selectedForBlock.forEach(sel => {
                    const cell = table.querySelector(`[data-row="${sel.row}"][data-col="${sel.col}"]`);
                    if (cell) {
                        cell.style.textAlign = alignment;
                        block.value.cells[sel.row][sel.col].align = alignment;
                    }
                });
                return;
            }
            
            // Fall back to single cell
            if (!window.selectedTableCell || parseInt(window.selectedTableCell.dataset.block) !== blockId) {
                alert('Please select a cell, row, column, or table first.');
                return;
            }
            
            const cell = window.selectedTableCell;
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            
            cell.style.textAlign = alignment;
            block.value.cells[row][col].align = alignment;
        };
        
        window.setTableVerticalAlignment = function(blockId, vAlign) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Check for table selection first (row/col/all)
            if (window.tableSelection.blockId === blockId && window.tableSelection.type) {
                const sel = window.tableSelection;
                
                if (sel.type === 'all') {
                    for (let r = 0; r < block.value.rows; r++) {
                        for (let c = 0; c < block.value.cols; c++) {
                            const cell = table.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            if (cell) {
                                cell.style.verticalAlign = vAlign;
                                block.value.cells[r][c].vAlign = vAlign;
                            }
                        }
                    }
                } else if (sel.type === 'row') {
                    const row = sel.row;
                    for (let c = 0; c < block.value.cols; c++) {
                        const cell = table.querySelector(`[data-row="${row}"][data-col="${c}"]`);
                        if (cell) {
                            cell.style.verticalAlign = vAlign;
                            block.value.cells[row][c].vAlign = vAlign;
                        }
                    }
                } else if (sel.type === 'col') {
                    const col = sel.col;
                    for (let r = 0; r < block.value.rows; r++) {
                        const cell = table.querySelector(`[data-row="${r}"][data-col="${col}"]`);
                        if (cell) {
                            cell.style.verticalAlign = vAlign;
                            block.value.cells[r][col].vAlign = vAlign;
                        }
                    }
                }
                return;
            }
            
            // Check for multi-cell selection
            const selectedForBlock = window.selectedCells.filter(c => c.blockId === blockId);
            if (selectedForBlock.length > 0) {
                selectedForBlock.forEach(sel => {
                    const cell = table.querySelector(`[data-row="${sel.row}"][data-col="${sel.col}"]`);
                    if (cell) {
                        cell.style.verticalAlign = vAlign;
                        block.value.cells[sel.row][sel.col].vAlign = vAlign;
                    }
                });
                return;
            }
            
            // Fall back to single cell
            if (!window.selectedTableCell || parseInt(window.selectedTableCell.dataset.block) !== blockId) {
                alert('Please select a cell, row, column, or table first.');
                return;
            }
            
            const cell = window.selectedTableCell;
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            
            cell.style.verticalAlign = vAlign;
            block.value.cells[row][col].vAlign = vAlign;
        };

        window.showColorPicker = function(blockId, mode) {
            const picker = document.getElementById(`color-picker-${blockId}`);
            const title = document.getElementById(`color-picker-title-${blockId}`);
            
            // Check if we have a selection or selected cell
            const hasTableSelection = window.tableSelection.blockId === blockId && window.tableSelection.type;
            const hasMultiSelect = window.selectedCells.filter(c => c.blockId === blockId).length > 0;
            const hasCell = window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block) === blockId;
            
            if (!hasTableSelection && !hasMultiSelect && !hasCell) {
                alert('Please select a cell, row, column, or table first.');
                return;
            }
            
            window.colorPickerMode = mode;
            window.colorPickerBlockId = blockId;
            
            // Determine title based on selection type
            let titleText = 'Select Color';
            if (hasTableSelection) {
                const typeLabels = { 'row': 'Row', 'col': 'Column', 'all': 'Table' };
                titleText = `Color ${typeLabels[window.tableSelection.type] || 'Selection'}`;
            } else if (hasMultiSelect && window.selectedCells.length > 1) {
                titleText = `Color ${window.selectedCells.length} Cells`;
            } else {
                titleText = 'Color Cell';
            }
            title.textContent = titleText;
            
            picker.classList.add('visible');
            
            // Position picker
            const table = document.getElementById(`admin-table-${blockId}`);
            if (table) {
                const tableRect = table.getBoundingClientRect();
                const parentRect = picker.parentElement.getBoundingClientRect();
                picker.style.top = (tableRect.bottom - parentRect.top + 10) + 'px';
                picker.style.left = '0px';
            }
            
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeColorPicker(e) {
                    if (!picker.contains(e.target) && !e.target.textContent.includes('ðŸŽ¨')) {
                        picker.classList.remove('visible');
                        document.removeEventListener('click', closeColorPicker);
                    }
                });
            }, 10);
        };

        window.applyTableColor = function(blockId, color) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Check for table selection first (row/col/all)
            if (window.tableSelection.blockId === blockId && window.tableSelection.type) {
                const sel = window.tableSelection;
                
                if (sel.type === 'all') {
                    // Color entire table
                    for (let r = 0; r < block.value.rows; r++) {
                        for (let c = 0; c < block.value.cols; c++) {
                            const cell = table.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            if (cell) {
                                cell.style.backgroundColor = color;
                                block.value.cells[r][c].bgColor = color;
                            }
                        }
                    }
                } else if (sel.type === 'row') {
                    // Color selected row
                    const row = sel.row;
                    for (let c = 0; c < block.value.cols; c++) {
                        const cell = table.querySelector(`[data-row="${row}"][data-col="${c}"]`);
                        if (cell) {
                            cell.style.backgroundColor = color;
                            block.value.cells[row][c].bgColor = color;
                        }
                    }
                } else if (sel.type === 'col') {
                    // Color selected column
                    const col = sel.col;
                    for (let r = 0; r < block.value.rows; r++) {
                        const cell = table.querySelector(`[data-row="${r}"][data-col="${col}"]`);
                        if (cell) {
                            cell.style.backgroundColor = color;
                            block.value.cells[r][col].bgColor = color;
                        }
                    }
                }
                
                // Clear selection visual after applying
                clearTableSelection(blockId);
            }
            // Check for multi-cell selection
            else {
                const selectedForBlock = window.selectedCells.filter(c => c.blockId === blockId);
                if (selectedForBlock.length > 0) {
                    selectedForBlock.forEach(sel => {
                        const cell = table.querySelector(`[data-row="${sel.row}"][data-col="${sel.col}"]`);
                        if (cell) {
                            cell.style.backgroundColor = color;
                            block.value.cells[sel.row][sel.col].bgColor = color;
                        }
                    });
                }
                // Fall back to single cell
                else if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block) === blockId) {
                    const row = parseInt(window.selectedTableCell.dataset.row);
                    const col = parseInt(window.selectedTableCell.dataset.col);
                    window.selectedTableCell.style.backgroundColor = color;
                    block.value.cells[row][col].bgColor = color;
                }
            }
            
            // Hide color picker
            document.getElementById(`color-picker-${blockId}`).classList.remove('visible');
        };

        window.addTableRow = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            const newRow = [];
            for (let c = 0; c < block.value.cols; c++) {
                newRow.push({
                    content: '',
                    align: 'left',
                    vAlign: 'middle',
                    bgColor: '#FFFFFF'
                });
            }
            
            block.value.cells.push(newRow);
            block.value.rows++;
            
            // Add default height for new row if rowHeights exists
            if (block.value.rowHeights) {
                block.value.rowHeights.push(40);
            }
            
            renderAdminBlocks();
        };

        window.deleteTableRow = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table' || block.value.rows <= 1) {
                alert('Table must have at least one row.');
                return;
            }
            
            let rowToDelete = block.value.rows - 1; // Default to last row
            
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block) === blockId) {
                rowToDelete = parseInt(window.selectedTableCell.dataset.row);
            }
            
            block.value.cells.splice(rowToDelete, 1);
            block.value.rows--;
            
            // Also remove row height if stored
            if (block.value.rowHeights) {
                block.value.rowHeights.splice(rowToDelete, 1);
            }
            
            window.selectedTableCell = null;
            renderAdminBlocks();
        };

        window.addTableColumn = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            for (let r = 0; r < block.value.rows; r++) {
                block.value.cells[r].push({
                    content: r === 0 && block.value.headerRow ? `Header ${block.value.cols + 1}` : '',
                    align: 'left',
                    vAlign: 'middle',
                    bgColor: r === 0 && block.value.headerRow ? '#E8E8E8' : '#FFFFFF'
                });
            }
            
            block.value.cols++;
            
            // Add default width for new column if colWidths exists
            if (block.value.colWidths) {
                block.value.colWidths.push(100);
            }
            
            renderAdminBlocks();
        };

        window.deleteTableColumn = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table' || block.value.cols <= 1) {
                alert('Table must have at least one column.');
                return;
            }
            
            let colToDelete = block.value.cols - 1; // Default to last column
            
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block) === blockId) {
                colToDelete = parseInt(window.selectedTableCell.dataset.col);
            }
            
            for (let r = 0; r < block.value.rows; r++) {
                block.value.cells[r].splice(colToDelete, 1);
            }
            
            block.value.cols--;
            
            // Also remove column width if stored
            if (block.value.colWidths) {
                block.value.colWidths.splice(colToDelete, 1);
            }
            
            window.selectedTableCell = null;
            renderAdminBlocks();
        };
        
        // ==================== TABLE SELECTION FUNCTIONS ====================
        
        window.tableSelection = {
            blockId: null,
            type: null, // 'cell', 'row', 'col', 'all'
            row: null,
            col: null
        };
        
        window.selectTableRow = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            // Use currently selected cell's row, or default to first row
            let rowIndex = 0;
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block) === blockId) {
                rowIndex = parseInt(window.selectedTableCell.dataset.row);
            }
            
            window.tableSelection = { blockId, type: 'row', row: rowIndex, col: null };
            
            // Clear previous selection
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            table.classList.remove('selected-all');
            table.querySelectorAll('.selected-row, .selected-col').forEach(c => {
                c.classList.remove('selected-row', 'selected-col');
            });
            
            // Highlight row
            table.querySelectorAll(`td[data-row="${rowIndex}"], th[data-row="${rowIndex}"]`).forEach(c => {
                c.classList.add('selected-row');
            });
        };
        
        window.selectTableColumn = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            // Use currently selected cell's column, or default to first column
            let colIndex = 0;
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block) === blockId) {
                colIndex = parseInt(window.selectedTableCell.dataset.col);
            }
            
            window.tableSelection = { blockId, type: 'col', row: null, col: colIndex };
            
            // Clear previous selection
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            table.classList.remove('selected-all');
            table.querySelectorAll('.selected-row, .selected-col').forEach(c => {
                c.classList.remove('selected-row', 'selected-col');
            });
            
            // Highlight column
            table.querySelectorAll(`td[data-col="${colIndex}"], th[data-col="${colIndex}"]`).forEach(c => {
                c.classList.add('selected-col');
            });
        };
        
        window.selectEntireTable = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            window.tableSelection = { blockId, type: 'all', row: null, col: null };
            
            // Clear previous selection
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            table.querySelectorAll('.selected-row, .selected-col').forEach(c => {
                c.classList.remove('selected-row', 'selected-col');
            });
            
            // Highlight entire table
            table.classList.add('selected-all');
        };
        
        window.clearTableSelection = function(blockId) {
            window.tableSelection = { blockId: null, type: null, row: null, col: null };
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            table.classList.remove('selected-all');
            table.querySelectorAll('.selected-row, .selected-col').forEach(c => {
                c.classList.remove('selected-row', 'selected-col');
            });
        };
        
        // Add mousemove listener for cursor changes on table cells
        document.addEventListener('mousemove', function(event) {
            const cell = event.target.closest('.admin-table td, .admin-table th');
            if (!cell) return;
            
            const rect = cell.getBoundingClientRect();
            const edgeThreshold = 8;
            
            const isRightEdge = event.clientX >= rect.right - edgeThreshold;
            const isBottomEdge = event.clientY >= rect.bottom - edgeThreshold;
            
            const blockId = parseInt(cell.dataset.block);
            const col = parseInt(cell.dataset.col);
            const row = parseInt(cell.dataset.row);
            const block = window.adminBlocks?.find(b => b.id === blockId);
            
            if (!block) return;
            
            // Not last column and on right edge
            if (isRightEdge && col < block.value.cols - 1) {
                cell.style.cursor = 'col-resize';
            }
            // Not last row and on bottom edge
            else if (isBottomEdge && row < block.value.rows - 1) {
                cell.style.cursor = 'row-resize';
            }
            // Normal text cursor
            else {
                cell.style.cursor = 'text';
            }
        });
        
        // ==================== TABLE RESIZE FUNCTIONS ====================
        
        window.tableResizeState = {
            isResizing: false,
            type: null, // 'col' or 'row'
            blockId: null,
            index: null,
            startX: 0,
            startY: 0,
            startSize: 0,
            overlay: null
        };
        
        // Handle mousedown on table cell to detect edge clicks for resizing
        window.handleTableCellMouseDown = function(event, blockId, row, col) {
            const cell = event.target.closest('td, th');
            if (!cell) return;
            
            const rect = cell.getBoundingClientRect();
            const edgeThreshold = 8; // pixels from edge to trigger resize
            
            const isRightEdge = event.clientX >= rect.right - edgeThreshold;
            const isBottomEdge = event.clientY >= rect.bottom - edgeThreshold;
            
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            // Check if on right edge (column resize) - not for last column
            if (isRightEdge && col < block.value.cols - 1) {
                event.preventDefault();
                startColResize(event, blockId, col);
                return;
            }
            
            // Check if on bottom edge (row resize) - not for last row
            if (isBottomEdge && row < block.value.rows - 1) {
                event.preventDefault();
                startRowResize(event, blockId, row);
                return;
            }
            
            // Normal cell selection - clear any table selections
            clearTableSelection(blockId);
        };
        
        window.startColResize = function(event, blockId, colIndex) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Get current column width
            const firstRowCells = table.querySelectorAll('tr:first-child th, tr:first-child td');
            const cell = firstRowCells[colIndex];
            const startWidth = cell ? cell.offsetWidth : 100;
            
            // Initialize colWidths array if not exists
            if (!block.value.colWidths) {
                block.value.colWidths = [];
                firstRowCells.forEach((c, idx) => {
                    block.value.colWidths[idx] = c.offsetWidth;
                });
            }
            
            window.tableResizeState = {
                isResizing: true,
                type: 'col',
                blockId: blockId,
                index: colIndex,
                startX: event.clientX,
                startY: 0,
                startSize: startWidth,
                overlay: null
            };
            
            // Add overlay to capture mouse
            const overlay = document.createElement('div');
            overlay.className = 'table-resize-overlay';
            document.body.appendChild(overlay);
            window.tableResizeState.overlay = overlay;
            
            document.addEventListener('mousemove', handleTableResize);
            document.addEventListener('mouseup', stopTableResize);
        };
        
        window.startRowResize = function(event, blockId, rowIndex) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Get current row height
            const rows = table.querySelectorAll('tr');
            const row = rows[rowIndex];
            const startHeight = row ? row.offsetHeight : 40;
            
            // Initialize rowHeights array if not exists
            if (!block.value.rowHeights) {
                block.value.rowHeights = [];
                rows.forEach((r, idx) => {
                    block.value.rowHeights[idx] = r.offsetHeight;
                });
            }
            
            window.tableResizeState = {
                isResizing: true,
                type: 'row',
                blockId: blockId,
                index: rowIndex,
                startX: 0,
                startY: event.clientY,
                startSize: startHeight,
                overlay: null
            };
            
            // Add overlay to capture mouse
            const overlay = document.createElement('div');
            overlay.className = 'table-resize-overlay row-resize';
            document.body.appendChild(overlay);
            window.tableResizeState.overlay = overlay;
            
            document.addEventListener('mousemove', handleTableResize);
            document.addEventListener('mouseup', stopTableResize);
        };
        
        function handleTableResize(event) {
            if (!window.tableResizeState.isResizing) return;
            
            const state = window.tableResizeState;
            const block = window.adminBlocks.find(b => b.id === state.blockId);
            if (!block) return;
            
            const table = document.getElementById(`admin-table-${state.blockId}`);
            if (!table) return;
            
            if (state.type === 'col') {
                const deltaX = event.clientX - state.startX;
                const newWidth = Math.max(40, state.startSize + deltaX);
                
                // Update all cells in this column
                const cells = table.querySelectorAll(`td[data-col="${state.index}"], th[data-col="${state.index}"]`);
                cells.forEach(cell => {
                    cell.style.width = newWidth + 'px';
                });
                
                // Store width
                if (!block.value.colWidths) block.value.colWidths = [];
                block.value.colWidths[state.index] = newWidth;
                
            } else if (state.type === 'row') {
                const deltaY = event.clientY - state.startY;
                const newHeight = Math.max(25, state.startSize + deltaY);
                
                // Update all cells in this row
                const cells = table.querySelectorAll(`td[data-row="${state.index}"], th[data-row="${state.index}"]`);
                cells.forEach(cell => {
                    cell.style.height = newHeight + 'px';
                });
                
                // Store height
                if (!block.value.rowHeights) block.value.rowHeights = [];
                block.value.rowHeights[state.index] = newHeight;
            }
        }
        
        function stopTableResize(event) {
            if (!window.tableResizeState.isResizing) return;
            
            // Remove overlay
            if (window.tableResizeState.overlay) {
                window.tableResizeState.overlay.remove();
            }
            
            window.tableResizeState.isResizing = false;
            document.removeEventListener('mousemove', handleTableResize);
            document.removeEventListener('mouseup', stopTableResize);
        }
        
        // ==================== END TABLE RESIZE FUNCTIONS ====================

        // ==================== END TABLE EDITOR FUNCTIONS ====================

        window.removeAdminBlock = function (id) {
            window.adminBlocks = window.adminBlocks.filter(b => b.id !== id);
            renderAdminBlocks();
        };

        window.updateBlockValue = function (id, value) {
            const block = window.adminBlocks.find(b => b.id === id);
            if (block) block.value = value;
        };

        window.toggleBlank = function (el) {
            if (el.classList.contains('is-blank')) {
                el.classList.remove('is-blank');
                el.style.backgroundColor = 'transparent';
                el.style.borderBottom = 'none';
            } else {
                el.classList.add('is-blank');
                el.style.backgroundColor = '#fff9c4';
                el.style.borderBottom = '2px solid #fbc02d';
            }
        };

        window.processAdminQuestion = function () {
            const previewSection = document.getElementById('admin-preview-section');
            const previewContent = document.getElementById('admin-preview-content');
            const category = document.getElementById('admin-category').value;
            
            if (window.adminBlocks.length === 0) {
                alert("Please add some content blocks first!");
                return;
            }
            
            previewSection.classList.remove('hidden');

            let mainHtml = '';
            let afterAnswerHtml = '';
            
            window.adminBlocks.forEach(block => {
                if (block.type === 'text' && block.value) {
                    mainHtml += `<div style="margin-bottom: 1.5rem; color: var(--main-text); font-size: 1.1rem;">${block.value.replace(/\n/g, '<br>')}</div>`;
                } else if (block.type === 'answer' && block.value) {
                    const words = block.value.split(/\s+/);
                    const wrappedWords = words.map(word => `<span class="admin-word" onclick="toggleBlank(this)" style="cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: all 0.2s;">${word}</span>`).join(' ');
                    mainHtml += `<div class="cer-segment" style="margin-bottom: 1.5rem; line-height: 2;">${wrappedWords}</div>`;
                } else if (block.type === 'explanation' && block.value) {
                    // Explanation goes after the answer/MCQ options
                    afterAnswerHtml += `<div class="explanation-box" style="margin-top: 1.5rem; padding: 1.5rem; background: #f0f4ff; border-left: 4px solid #007bff; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 0.8rem; color: #007bff; display: flex; align-items: center; gap: 8px;">ðŸ’¡ Explanation</h4>
                                <div style="color: #444; line-height: 1.6;">${block.value.replace(/\n/g, '<br>')}</div>
                             </div>`;
                } else if (block.type === 'image' && block.value) {
                    const imageUrl = convertDropboxUrl(block.value);
                    mainHtml += `<img src="${imageUrl}" style="max-width: 100%; border-radius: 8px; margin-bottom: 1.5rem; display: block; margin-left: auto; margin-right: auto;" onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<p style=\\'color:#dc3545;\\'>âš ï¸ Image failed to load. Check URL.</p>');">`;
                } else if (block.type === 'video' && block.value) {
                    // Video goes after the answer/MCQ options
                    let videoUrl = block.value;
                    if (videoUrl.includes('dropbox.com')) {
                        videoUrl = videoUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?raw=1', '');
                    } else if (videoUrl.includes('youtube.com/watch?v=')) {
                        videoUrl = videoUrl.replace('watch?v=', 'embed/');
                    } else if (videoUrl.includes('youtu.be/')) {
                        videoUrl = videoUrl.replace('youtu.be/', 'youtube.com/embed/');
                    }
                    afterAnswerHtml += `<div class="video-container hidden-until-answered" style="margin-top: 1.5rem; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none;">
                                <iframe src="${videoUrl}" style="width: 100%; height: 315px; border: none;" allowfullscreen></iframe>
                             </div>`;
                } else if (block.type === 'table' && block.value) {
                    // Render table for preview with merge support
                    const tableData = block.value;
                    
                    // Build hidden cells map
                    const hiddenCells = new Set();
                    const mergeMap = {};
                    if (tableData.mergedCells) {
                        tableData.mergedCells.forEach(merge => {
                            for (let r = merge.startRow; r <= merge.endRow; r++) {
                                for (let c = merge.startCol; c <= merge.endCol; c++) {
                                    if (r !== merge.startRow || c !== merge.startCol) {
                                        hiddenCells.add(`${r}-${c}`);
                                    }
                                }
                            }
                            mergeMap[`${merge.startRow}-${merge.startCol}`] = {
                                colspan: merge.endCol - merge.startCol + 1,
                                rowspan: merge.endRow - merge.startRow + 1
                            };
                        });
                    }
                    
                    let tableHtml = `<table class="question-table" style="width: 100%; border-collapse: collapse; font-family: 'Century Gothic', 'Segoe UI', sans-serif; margin-bottom: 1.5rem;">`;
                    
                    for (let r = 0; r < tableData.rows; r++) {
                        const rowHeightStyle = tableData.rowHeights && tableData.rowHeights[r] ? `height: ${tableData.rowHeights[r]}px;` : '';
                        tableHtml += `<tr style="${rowHeightStyle}">`;
                        for (let c = 0; c < tableData.cols; c++) {
                            // Skip hidden cells
                            if (hiddenCells.has(`${r}-${c}`)) continue;
                            
                            const cell = tableData.cells[r][c];
                            const tag = (r === 0 && tableData.headerRow) ? 'th' : 'td';
                            const fontWeight = (r === 0 && tableData.headerRow) ? 'font-weight: 600;' : '';
                            const colWidthStyle = tableData.colWidths && tableData.colWidths[c] ? `width: ${tableData.colWidths[c]}px;` : '';
                            
                            // Check for merge attributes
                            const mergeInfo = mergeMap[`${r}-${c}`];
                            const colspanAttr = mergeInfo && mergeInfo.colspan > 1 ? `colspan="${mergeInfo.colspan}"` : '';
                            const rowspanAttr = mergeInfo && mergeInfo.rowspan > 1 ? `rowspan="${mergeInfo.rowspan}"` : '';
                            
                            tableHtml += `<${tag} ${colspanAttr} ${rowspanAttr} style="border: 1px solid #bbb; padding: 10px 14px; text-align: ${cell.align}; vertical-align: ${cell.vAlign || 'middle'}; background-color: ${cell.bgColor}; ${fontWeight} ${colWidthStyle}">${cell.content}</${tag}>`;
                        }
                        tableHtml += '</tr>';
                    }
                    
                    tableHtml += '</table>';
                    mainHtml += tableHtml;
                }
            });

            // Build final HTML: main content first, then MCQ options (if MCQ), then after-answer content
            let html = mainHtml;
            
            if (category === 'mcq') {
                const opts = [
                    document.getElementById('mcq-opt-1').value,
                    document.getElementById('mcq-opt-2').value,
                    document.getElementById('mcq-opt-3').value,
                    document.getElementById('mcq-opt-4').value
                ];
                const correct = document.getElementById('mcq-correct').value;
                html += `<div class="mcq-container" style="margin-top: 1rem;">`;
                opts.forEach((opt, i) => {
                    if (opt) {
                        html += `
                            <label class="mcq-option">
                                <input type="radio" name="temp-mcq-preview" value="${i + 1}" data-correct="${correct == i + 1}">
                                <span>${opt}</span>
                            </label>
                        `;
                    }
                });
                html += `</div>`;
            }
            
            // Add explanation and video at the end (after MCQ options / answer areas)
            html += afterAnswerHtml;

            previewContent.innerHTML = html;
            previewSection.scrollIntoView({ behavior: 'smooth' });
        };

        window.saveAdminQuestion = async function () {
            // Set flag to prevent any auto-refresh during save
            window.isSavingQuestion = true;
            
            if (!window.auth || !window.auth.currentUser) {
                window.isSavingQuestion = false;
                alert("You must be logged in to save.");
                return;
            }
            
            const title = document.getElementById('admin-title').value.trim();
            if (!title) {
                window.isSavingQuestion = false;
                alert("Please enter a question title.");
                document.getElementById('admin-title').focus();
                return;
            }
            
            if (window.adminBlocks.length === 0) {
                window.isSavingQuestion = false;
                alert("Please add some content blocks before saving.");
                return;
            }

            try {
                const category = document.getElementById('admin-category').value;
                const level = document.getElementById('admin-level').value;

                let topic = document.getElementById('admin-topic').value;
                if (topic === 'new-topic') {
                    topic = document.getElementById('admin-new-topic').value.trim().toLowerCase().replace(/\s+/g, '-');
                    if (!topic) {
                        alert("Please enter a name for the new topic.");
                        return;
                    }
                }

                // Check if preview has been generated
                const previewContent = document.getElementById('admin-preview-content');
                let finalHtml = '';
                
                if (previewContent.innerHTML.trim()) {
                    // Use preview content (with blanks selected)
                    const clone = previewContent.cloneNode(true);
                    
                    // Remove any controls that might be in the preview
                    clone.querySelectorAll('.controls, button.submit-btn, button.next-btn, button.print-btn, button.btn-primary').forEach(el => el.remove());
                    
                    // Ensure explanation boxes are hidden by default
                    clone.querySelectorAll('.explanation-box').forEach(el => {
                        el.style.display = 'none';
                    });
                    
                    // Ensure video containers are hidden by default
                    clone.querySelectorAll('.video-container').forEach(el => {
                        el.style.display = 'none';
                        el.classList.add('hidden-until-answered');
                    });
                    
                    const selectedWords = clone.querySelectorAll('.admin-word.is-blank');
                    selectedWords.forEach(word => {
                        const answer = word.textContent.trim().replace(/[.,!?;:]/g, '');
                        const calcWidth = Math.max(90, (answer.length * 1.5) * 10);
                        word.outerHTML = `<input type="text" class="answer-input" data-answer="${answer}" placeholder="..." style="width: ${calcWidth}px;">`;
                    });

                    // Convert non-blank words back to plain text
                    clone.querySelectorAll('.admin-word:not(.is-blank)').forEach(word => {
                        word.outerHTML = word.textContent;
                    });

                    clone.querySelectorAll('.cer-segment').forEach(seg => {
                        if (!seg.querySelector('.feedback-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'feedback-icon';
                            seg.appendChild(icon);
                        }
                    });
                    
                    finalHtml = clone.innerHTML;
                } else {
                    // Build HTML directly from blocks (no preview)
                    // Separate main content from after-answer content
                    let mainHtml = '';
                    let afterAnswerHtml = '';
                    
                    window.adminBlocks.forEach(block => {
                        if (block.type === 'text' && block.value) {
                            mainHtml += `<div style="margin-bottom: 1.5rem; color: var(--main-text); font-size: 1.1rem;">${block.value.replace(/\n/g, '<br>')}</div>`;
                        } else if (block.type === 'answer' && block.value) {
                            // Parse [word] as blanks
                            let answerHtml = block.value.replace(/\[([^\]]+)\]/g, (match, answer) => {
                                const calcWidth = Math.max(90, (answer.length * 1.5) * 10);
                                return `<input type="text" class="answer-input" data-answer="${answer.trim()}" placeholder="..." style="width: ${calcWidth}px;">`;
                            });
                            mainHtml += `<div class="cer-segment" style="margin-bottom: 1.5rem; line-height: 2;">${answerHtml}<span class="feedback-icon"></span></div>`;
                        } else if (block.type === 'explanation' && block.value) {
                            // Explanation goes after MCQ/answer section
                            afterAnswerHtml += `<div class="explanation-box" style="margin-top: 1.5rem; padding: 1.5rem; background: #f0f4ff; border-left: 4px solid #007bff; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 0.8rem; color: #007bff; display: flex; align-items: center; gap: 8px;">ðŸ’¡ Explanation</h4>
                                <div style="color: #444; line-height: 1.6;">${block.value.replace(/\n/g, '<br>')}</div>
                             </div>`;
                        } else if (block.type === 'image' && block.value) {
                            const imageUrl = convertDropboxUrl(block.value);
                            mainHtml += `<img src="${imageUrl}" class="question-diagram" style="max-width: 100%; border-radius: 8px; margin-bottom: 1.5rem; display: block; margin-left: auto; margin-right: auto;">`;
                        } else if (block.type === 'video' && block.value) {
                            // Video goes after MCQ/answer section
                            let videoUrl = block.value;
                            if (videoUrl.includes('dropbox.com')) {
                                videoUrl = videoUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?raw=1', '');
                            } else if (videoUrl.includes('youtube.com/watch?v=')) {
                                videoUrl = videoUrl.replace('watch?v=', 'embed/');
                            } else if (videoUrl.includes('youtu.be/')) {
                                videoUrl = videoUrl.replace('youtu.be/', 'youtube.com/embed/');
                            }
                            afterAnswerHtml += `<div class="video-container hidden-until-answered" style="margin-top: 1.5rem; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none;">
                                <iframe src="${videoUrl}" style="width: 100%; height: 315px; border: none;" allowfullscreen></iframe>
                             </div>`;
                        } else if (block.type === 'table' && block.value) {
                            // Generate table HTML for saving with merge support
                            const tableData = block.value;
                            
                            // Build hidden cells map
                            const hiddenCells = new Set();
                            const mergeMap = {};
                            if (tableData.mergedCells) {
                                tableData.mergedCells.forEach(merge => {
                                    for (let r = merge.startRow; r <= merge.endRow; r++) {
                                        for (let c = merge.startCol; c <= merge.endCol; c++) {
                                            if (r !== merge.startRow || c !== merge.startCol) {
                                                hiddenCells.add(`${r}-${c}`);
                                            }
                                        }
                                    }
                                    mergeMap[`${merge.startRow}-${merge.startCol}`] = {
                                        colspan: merge.endCol - merge.startCol + 1,
                                        rowspan: merge.endRow - merge.startRow + 1
                                    };
                                });
                            }
                            
                            let tableHtml = `<table class="question-table" style="width: 100%; border-collapse: collapse; font-family: 'Century Gothic', 'Segoe UI', sans-serif; margin-bottom: 1.5rem;">`;
                            
                            for (let r = 0; r < tableData.rows; r++) {
                                const rowHeightStyle = tableData.rowHeights && tableData.rowHeights[r] ? `height: ${tableData.rowHeights[r]}px;` : '';
                                tableHtml += `<tr style="${rowHeightStyle}">`;
                                for (let c = 0; c < tableData.cols; c++) {
                                    // Skip hidden cells
                                    if (hiddenCells.has(`${r}-${c}`)) continue;
                                    
                                    const cell = tableData.cells[r][c];
                                    const tag = (r === 0 && tableData.headerRow) ? 'th' : 'td';
                                    const fontWeight = (r === 0 && tableData.headerRow) ? 'font-weight: 600;' : '';
                                    const colWidthStyle = tableData.colWidths && tableData.colWidths[c] ? `width: ${tableData.colWidths[c]}px;` : '';
                                    
                                    // Check for merge attributes
                                    const mergeInfo = mergeMap[`${r}-${c}`];
                                    const colspanAttr = mergeInfo && mergeInfo.colspan > 1 ? `colspan="${mergeInfo.colspan}"` : '';
                                    const rowspanAttr = mergeInfo && mergeInfo.rowspan > 1 ? `rowspan="${mergeInfo.rowspan}"` : '';
                                    
                                    tableHtml += `<${tag} ${colspanAttr} ${rowspanAttr} style="border: 1px solid #bbb; padding: 10px 14px; text-align: ${cell.align}; vertical-align: ${cell.vAlign || 'middle'}; background-color: ${cell.bgColor}; ${fontWeight} ${colWidthStyle}">${cell.content}</${tag}>`;
                                }
                                tableHtml += '</tr>';
                            }
                            
                            tableHtml += '</table>';
                            mainHtml += tableHtml;
                        }
                    });

                    // Start with main content
                    finalHtml = mainHtml;

                    // Add MCQ options if MCQ category
                    if (category === 'mcq') {
                        const opts = [
                            document.getElementById('mcq-opt-1').value,
                            document.getElementById('mcq-opt-2').value,
                            document.getElementById('mcq-opt-3').value,
                            document.getElementById('mcq-opt-4').value
                        ];
                        const correct = document.getElementById('mcq-correct').value;
                        finalHtml += `<div class="mcq-container" style="margin-top: 1rem;">`;
                        opts.forEach((opt, i) => {
                            if (opt) {
                                finalHtml += `
                                    <label class="mcq-option">
                                        <input type="radio" name="mcq-answer" value="${i + 1}" data-correct="${correct == i + 1}">
                                        <span>${opt}</span>
                                    </label>
                                `;
                            }
                        });
                        finalHtml += `</div>`;
                    }
                    
                    // Add explanation and video at the very end
                    finalHtml += afterAnswerHtml;
                }

                const { doc, setDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Determine if updating existing or creating new
                const isEditing = window.editingQuestionId && window.editingQuestionId.startsWith('q-custom-');
                const questionId = isEditing 
                    ? window.editingQuestionId.replace('q-', '') 
                    : "custom-" + Date.now();
                
                const questionData = {
                    title: title,
                    html: finalHtml,
                    updatedBy: window.auth.currentUser.email,
                    updatedAt: new Date().toISOString(),
                    category: category,
                    level: level,
                    topic: topic,
                    type: 'custom'
                };
                
                if (!isEditing) {
                    questionData.createdBy = window.auth.currentUser.email;
                    questionData.createdAt = new Date().toISOString();
                }
                
                await setDoc(doc(window.db_fs, "custom_questions", questionId), questionData, { merge: true });
                
                const actionText = isEditing ? "updated" : "added";
                alert(`Question successfully ${actionText}!`);
                
                // Clear the form but preserve category/level/topic settings
                window.editingQuestionId = null;
                window.clearAdminForm(true, true); // force clear, preserve settings
                
                // Reset the loaded flag so questions can be reloaded
                window.customQuestionsLoaded = false;
                
                // Remove existing custom questions from DOM to prevent duplicates
                document.querySelectorAll('.custom-question').forEach(el => el.remove());
                
                // Reload the custom questions from database
                if (window.loadCustomQuestions) {
                    await window.loadCustomQuestions();
                }
                
                // Scroll to title and focus for next question entry
                const titleInput = document.getElementById('admin-title');
                if (titleInput) {
                    titleInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => titleInput.focus(), 300);
                }
                
                // Reset the saving flag
                window.isSavingQuestion = false;
                
            } catch (e) {
                window.isSavingQuestion = false;
                console.error("Save Error:", e);
                alert("Error saving: " + e.message);
            }
        };

        // Cancel editing and clear form
        window.cancelEditing = function() {
            if (window.adminBlocks.length > 0 && !confirm("Cancel editing? Unsaved changes will be lost.")) return;
            window.editingQuestionId = null;
            window.clearAdminForm(true, true); // force clear, preserve settings
            updateEditingIndicator();
        };
        
        // Update the editing indicator
        window.updateEditingIndicator = function() {
            const indicator = document.getElementById('editing-indicator');
            const nameSpan = document.getElementById('editing-question-name');
            const titleInput = document.getElementById('admin-title');
            
            if (window.editingQuestionId) {
                indicator.classList.remove('hidden');
                indicator.style.display = 'flex';
                nameSpan.textContent = titleInput.value || window.editingQuestionId;
            } else {
                indicator.classList.add('hidden');
                indicator.style.display = 'none';
            }
        };

        // Clear admin form
        window.clearAdminForm = function(force = false, preserveSettings = false) {
            if (!force && window.adminBlocks.length > 0 && !confirm("Clear all content? This cannot be undone.")) return;
            
            // Save current settings if preserving
            let savedCategory, savedLevel, savedTopic;
            if (preserveSettings) {
                savedCategory = document.getElementById('admin-category').value;
                savedLevel = document.getElementById('admin-level')?.value;
                savedTopic = document.getElementById('admin-topic').value;
            }
            
            window.adminBlocks = [];
            window.editingQuestionId = null;
            renderAdminBlocks();
            
            document.getElementById('admin-title').value = '';
            document.getElementById('admin-new-topic').value = '';
            document.getElementById('admin-new-topic').classList.add('hidden');
            document.getElementById('mcq-opt-1').value = '';
            document.getElementById('mcq-opt-2').value = '';
            document.getElementById('mcq-opt-3').value = '';
            document.getElementById('mcq-opt-4').value = '';
            document.getElementById('mcq-correct').value = '1';
            
            if (preserveSettings && savedCategory) {
                // Restore saved settings
                document.getElementById('admin-category').value = savedCategory;
                handleCategoryChange(savedCategory);
                
                if (savedCategory === 'mcq' && savedLevel) {
                    document.getElementById('admin-level').value = savedLevel;
                    updateAdminTopicsByLevel(savedLevel);
                }
                
                // Restore topic after a small delay to ensure options are populated
                setTimeout(() => {
                    const topicSelect = document.getElementById('admin-topic');
                    const topicExists = Array.from(topicSelect.options).some(opt => opt.value === savedTopic);
                    if (topicExists) {
                        topicSelect.value = savedTopic;
                    }
                }, 50);
            } else {
                // Reset to defaults
                document.getElementById('admin-category').value = 'cer';
                document.getElementById('admin-topic').value = 'heat';
                handleCategoryChange('cer');
            }
            
            document.getElementById('admin-preview-section').classList.add('hidden');
            document.getElementById('admin-preview-content').innerHTML = '';
            
            updateEditingIndicator();
        };

        // Convert Dropbox URL to displayable format
        window.convertDropboxUrl = function(url) {
            if (!url) return url;
            
            // Handle new Dropbox format: /scl/fi/xxx/file.jpg?rlkey=xxx&dl=0
            if (url.includes('dropbox.com/scl/')) {
                // Replace dl=0 or dl=1 with raw=1
                url = url.replace(/[?&]dl=[01]/, '&raw=1');
                if (!url.includes('raw=1')) {
                    url += (url.includes('?') ? '&' : '?') + 'raw=1';
                }
                return url;
            }
            
            // Handle old Dropbox format
            if (url.includes('dropbox.com')) {
                return url.replace('www.dropbox.com', 'dl.dropboxusercontent.com')
                          .replace('?dl=0', '')
                          .replace('?dl=1', '');
            }
            
            return url;
        };

        function editQuestion(btn, isDuplicate = false) {
            const container = btn.closest('.question-container');
            const titleEl = container.querySelector('h3');
            
            // Extract title from h3 - this works for both custom and built-in questions
            let title = "";
            if (titleEl) {
                title = titleEl.innerText.trim();
            }
            
            // If h3 is generic like "Question 1" for built-in questions, try question-title paragraph
            if (!title || (/^Question\s*\d*$/i.test(title) && !container.classList.contains('custom-question') && !container.id.includes('custom'))) {
                const questionTitleEl = container.querySelector('.question-title, p.question-title');
                if (questionTitleEl) {
                    const fullText = questionTitleEl.textContent.trim();
                    title = fullText.length > 60 ? fullText.substring(0, 57) + '...' : fullText;
                }
            }
            
            // Fallback if still no title
            if (!title) {
                title = "Untitled Question";
            }

            // Detect category from container location
            let category = 'cer';
            let detectedTopic = 'heat';
            
            if (container.closest('#view-cer') || container.closest('[id^="topic-heat"]') || container.closest('[id^="topic-light"]') || container.closest('[id^="topic-materials"]')) {
                category = 'cer';
            } else if (container.closest('#view-definition')) {
                category = 'definition';
            } else if (container.closest('#view-single-relationship')) {
                category = 'single-relationship';
            } else if (container.id.includes('mcq') || container.closest('[id^="topic-mcq-"]')) {
                category = 'mcq';
            }
            
            // Try to detect topic from container ID
            const containerId = container.closest('[id^="topic-"]')?.id || '';
            if (containerId) {
                const topicMatch = containerId.match(/topic-(?:mcq-)?(.+)/);
                if (topicMatch) {
                    detectedTopic = topicMatch[1];
                }
            }

            // Store the question ID if editing (not duplicating) - do this BEFORE setTimeout
            if (!isDuplicate && container.id) {
                window.editingQuestionId = container.id;
            } else {
                window.editingQuestionId = null;
            }
            
            // Store the title for later use
            const finalTitle = isDuplicate ? title + " (Copy)" : title;

            // Switch to admin tab
            switchTab('admin', document.getElementById('btn-sidebar-admin'));

            // Set form values with a small delay to ensure DOM is ready
            setTimeout(() => {
                // Set category
                document.getElementById('admin-category').value = category;
                handleCategoryChange(category);
                
                // Set the title explicitly
                document.getElementById('admin-title').value = finalTitle;
                
                // Try to set the topic
                const topicSelect = document.getElementById('admin-topic');
                const topicExists = Array.from(topicSelect.options).some(opt => opt.value === detectedTopic);
                if (topicExists) {
                    topicSelect.value = detectedTopic;
                }
                
                // Try to detect MCQ level from topic container
                if (category === 'mcq') {
                    // Check which level's topics include this topic
                    for (const [level, topics] of Object.entries(window.mcqCurriculum)) {
                        const normalizedTopics = topics.map(t => t.toLowerCase().replace(/\s+/g, '-'));
                        if (normalizedTopics.includes(detectedTopic)) {
                            document.getElementById('admin-level').value = level;
                            updateAdminTopicsByLevel(level);
                            // Re-set the topic after updating options
                            setTimeout(() => {
                                const topicSelect = document.getElementById('admin-topic');
                                const topicExists = Array.from(topicSelect.options).some(opt => opt.value === detectedTopic);
                                if (topicExists) {
                                    topicSelect.value = detectedTopic;
                                }
                                // Re-set title again after MCQ updates to be sure
                                document.getElementById('admin-title').value = finalTitle;
                            }, 100);
                            break;
                        }
                    }
                }
                
                // Update editing indicator after title is set
                updateEditingIndicator();
            }, 100);

            window.adminBlocks = [];
            
            // ========== EXTRACT CONTENT IN DOM ORDER ==========
            // Find the question body container
            const questionBody = container.querySelector('.question-body, .answer-template, .mcq-body') || container;
            
            // Get all direct children and walk through them in order
            const processElement = (element, blockIdOffset) => {
                if (!element || element.classList?.contains('controls')) return;
                
                const tagName = element.tagName?.toLowerCase();
                
                // Skip certain elements
                if (element.classList?.contains('feedback-icon')) return;
                if (element.classList?.contains('mcq-option')) return; // MCQ options handled separately
                if (element.classList?.contains('mcq-container')) return; // MCQ container handled separately
                if (tagName === 'button') return;
                if (tagName === 'h3') return; // Title is handled separately
                
                // Check for explanation box
                if (element.classList?.contains('explanation-box')) {
                    const contentDiv = element.querySelector('div:last-child') || element.querySelector('div');
                    let explainText = '';
                    if (contentDiv) {
                        explainText = contentDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '').trim();
                    } else {
                        explainText = element.textContent.replace(/ðŸ’¡\s*Explanation/i, '').trim();
                    }
                    if (explainText) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'explanation', 
                            value: explainText
                        });
                    }
                    return;
                }
                
                // Check for video container
                if (element.classList?.contains('video-container')) {
                    const iframe = element.querySelector('iframe');
                    if (iframe && iframe.src) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'video', 
                            value: iframe.src
                        });
                    }
                    return;
                }
                
                // Check for standalone iframe (video)
                if (tagName === 'iframe' && (element.src?.includes('youtube') || element.src?.includes('dropbox'))) {
                    window.adminBlocks.push({ 
                        id: Date.now() + blockIdOffset, 
                        type: 'video', 
                        value: element.src
                    });
                    return;
                }
                
                // Check for image
                if (tagName === 'img' && element.src && !element.src.includes('data:')) {
                    window.adminBlocks.push({ 
                        id: Date.now() + blockIdOffset, 
                        type: 'image', 
                        value: element.src 
                    });
                    return;
                }
                
                // Check for table
                if (tagName === 'table') {
                    // Extract table data with merge support
                    const rows = element.querySelectorAll('tr');
                    
                    // First pass: determine actual grid dimensions and collect merge info
                    let maxCols = 0;
                    const mergedCells = [];
                    
                    // Create a grid to track which cells are occupied
                    const occupiedGrid = {};
                    
                    rows.forEach((row, rowIdx) => {
                        let colIdx = 0;
                        row.querySelectorAll('th, td').forEach((cell) => {
                            // Skip already occupied positions
                            while (occupiedGrid[`${rowIdx}-${colIdx}`]) {
                                colIdx++;
                            }
                            
                            const colspan = parseInt(cell.getAttribute('colspan')) || 1;
                            const rowspan = parseInt(cell.getAttribute('rowspan')) || 1;
                            
                            // Mark cells as occupied
                            for (let r = 0; r < rowspan; r++) {
                                for (let c = 0; c < colspan; c++) {
                                    occupiedGrid[`${rowIdx + r}-${colIdx + c}`] = {
                                        content: cell.textContent.trim(),
                                        align: cell.style.textAlign || 'left',
                                        vAlign: cell.style.verticalAlign || 'middle',
                                        bgColor: cell.style.backgroundColor || '#FFFFFF',
                                        isOrigin: r === 0 && c === 0,
                                        originRow: rowIdx,
                                        originCol: colIdx
                                    };
                                }
                            }
                            
                            // Record merge info if this is a merged cell
                            if (colspan > 1 || rowspan > 1) {
                                mergedCells.push({
                                    startRow: rowIdx,
                                    startCol: colIdx,
                                    endRow: rowIdx + rowspan - 1,
                                    endCol: colIdx + colspan - 1
                                });
                            }
                            
                            maxCols = Math.max(maxCols, colIdx + colspan);
                            colIdx += colspan;
                        });
                    });
                    
                    const numRows = rows.length;
                    const numCols = maxCols;
                    
                    // Build cell data array
                    const tableData = {
                        rows: numRows,
                        cols: numCols,
                        cells: [],
                        headerRow: !!rows[0]?.querySelector('th'),
                        colWidths: [],
                        rowHeights: []
                    };
                    
                    // Add merged cells data if any
                    if (mergedCells.length > 0) {
                        tableData.mergedCells = mergedCells;
                    }
                    
                    // Build cells array from occupied grid
                    for (let r = 0; r < numRows; r++) {
                        const rowData = [];
                        for (let c = 0; c < numCols; c++) {
                            const cellInfo = occupiedGrid[`${r}-${c}`];
                            if (cellInfo) {
                                rowData.push({
                                    content: cellInfo.isOrigin ? cellInfo.content : '',
                                    align: cellInfo.align,
                                    vAlign: cellInfo.vAlign || 'middle',
                                    bgColor: cellInfo.bgColor
                                });
                            } else {
                                rowData.push({
                                    content: '',
                                    align: 'left',
                                    vAlign: 'middle',
                                    bgColor: '#FFFFFF'
                                });
                            }
                        }
                        tableData.cells.push(rowData);
                        
                        // Extract row height
                        const rowHeight = parseInt(rows[r].style.height) || null;
                        if (rowHeight) {
                            tableData.rowHeights[r] = rowHeight;
                        }
                    }
                    
                    // Extract column widths from first row cells
                    let colIdx = 0;
                    rows[0]?.querySelectorAll('th, td').forEach((cell) => {
                        while (occupiedGrid[`0-${colIdx}`] && !occupiedGrid[`0-${colIdx}`].isOrigin) {
                            colIdx++;
                        }
                        const colWidth = parseInt(cell.style.width) || null;
                        if (colWidth) {
                            tableData.colWidths[colIdx] = colWidth;
                        }
                        const colspan = parseInt(cell.getAttribute('colspan')) || 1;
                        colIdx += colspan;
                    });
                    
                    // Clean up empty arrays
                    if (tableData.colWidths.length === 0 || tableData.colWidths.every(w => !w)) {
                        delete tableData.colWidths;
                    }
                    if (tableData.rowHeights.length === 0 || tableData.rowHeights.every(h => !h)) {
                        delete tableData.rowHeights;
                    }
                    
                    if (tableData.rows > 0 && tableData.cols > 0) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'table', 
                            value: tableData
                        });
                    }
                    return;
                }
                
                // Check for CER segment (fill-in-blank)
                if (element.classList?.contains('cer-segment')) {
                    let segText = '';
                    const label = element.getAttribute('data-label') || '';
                    
                    // Walk through all nodes to build the text with blanks marked
                    const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT);
                    let node;
                    while (node = walker.nextNode()) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            segText += node.textContent;
                        } else if (node.nodeType === Node.ELEMENT_NODE) {
                            if (node.classList?.contains('answer-input') || node.tagName === 'INPUT') {
                                const answer = node.dataset?.answer || node.value || '';
                                if (answer) {
                                    segText += `[${answer}]`;
                                }
                            }
                        }
                    }
                    
                    segText = segText.replace(/\s+/g, ' ').trim();
                    // Remove feedback icons text
                    segText = segText.replace(/[âœ”âœ–]/g, '').trim();
                    
                    if (segText) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'answer', 
                            value: (label ? `(${label}) ` : '') + segText
                        });
                    }
                    return;
                }
                
                // Check for div with text content (but not containers)
                if (tagName === 'div') {
                    // Skip if it's a container div with children that we'll process
                    const hasProcessableChildren = element.querySelector('img, table, iframe, .cer-segment, .explanation-box, .video-container');
                    if (hasProcessableChildren) {
                        // Process children instead
                        Array.from(element.children).forEach((child, idx) => {
                            processElement(child, blockIdOffset + idx * 10);
                        });
                        return;
                    }
                    
                    // It's a text div
                    const text = element.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '').trim();
                    if (text && text.length > 0) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'text', 
                            value: text
                        });
                    }
                    return;
                }
                
                // Check for paragraph
                if (tagName === 'p') {
                    // Skip if inside mcq-option or explanation
                    if (element.closest('.mcq-option') || element.closest('.explanation-box')) return;
                    
                    const text = element.textContent.trim();
                    if (text) {
                        // Check if this is a question-title
                        if (element.classList?.contains('question-title')) {
                            window.adminBlocks.push({ 
                                id: Date.now() + blockIdOffset, 
                                type: 'text', 
                                value: text
                            });
                        } else {
                            window.adminBlocks.push({ 
                                id: Date.now() + blockIdOffset, 
                                type: 'text', 
                                value: text
                            });
                        }
                    }
                    return;
                }
            };
            
            // Process all children of the question body in order
            let blockOffset = 0;
            Array.from(questionBody.children).forEach((child, idx) => {
                processElement(child, blockOffset);
                blockOffset += 100;
            });
            
            // If no blocks were extracted, try a simpler approach for older question formats
            if (window.adminBlocks.length === 0) {
                // Get text content
                const allText = [];
                container.querySelectorAll('p:not(.question-title), div[style*="margin-bottom"]').forEach(el => {
                    if (!el.closest('.mcq-option') && !el.closest('.explanation-box') && !el.closest('.controls')) {
                        const text = el.textContent.trim();
                        if (text) allText.push(text);
                    }
                });
                if (allText.length > 0) {
                    window.adminBlocks.push({ 
                        id: Date.now(), 
                        type: 'text', 
                        value: allText.join('\n\n')
                    });
                }
                
                // Get images
                container.querySelectorAll('img').forEach((img, idx) => {
                    if (img.src && !img.src.includes('data:') && !img.closest('.explanation-box')) {
                        window.adminBlocks.push({ 
                            id: Date.now() + idx + 100, 
                            type: 'image', 
                            value: img.src
                        });
                    }
                });
                
                // Get explanation
                const explanation = container.querySelector('.explanation-box');
                if (explanation) {
                    const contentDiv = explanation.querySelector('div:last-child') || explanation.querySelector('div');
                    let explainText = contentDiv ? contentDiv.textContent.trim() : explanation.textContent.replace(/ðŸ’¡\s*Explanation/i, '').trim();
                    if (explainText) {
                        window.adminBlocks.push({ 
                            id: Date.now() + 500, 
                            type: 'explanation', 
                            value: explainText
                        });
                    }
                }
                
                // Get video
                const video = container.querySelector('iframe[src*="youtube"], iframe[src*="dropbox"], .video-container iframe');
                if (video && video.src) {
                    window.adminBlocks.push({ 
                        id: Date.now() + 600, 
                        type: 'video', 
                        value: video.src
                    });
                }
            }
            
            // Handle MCQ specific content - fill in the option fields
            if (category === 'mcq') {
                const mcqOptions = container.querySelectorAll('.mcq-option');
                mcqOptions.forEach((opt, idx) => {
                    const input = opt.querySelector('input[type="radio"]');
                    const span = opt.querySelector('span');
                    if (span && idx < 4) {
                        let optText = span.textContent.trim();
                        optText = optText.replace(/^\d+\.\s*/, '');
                        setTimeout(() => {
                            document.getElementById(`mcq-opt-${idx + 1}`).value = optText;
                            if (input && input.dataset.correct === 'true') {
                                document.getElementById('mcq-correct').value = (idx + 1).toString();
                            }
                        }, 150);
                    }
                });
            }

            renderAdminBlocks();
            
            // Hide preview section when loading new content
            document.getElementById('admin-preview-section').classList.add('hidden');
            
            // Final safety: set title again after everything is done
            setTimeout(() => {
                document.getElementById('admin-title').value = finalTitle;
                updateEditingIndicator();
            }, 200);
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // =====================================================
        // QUESTION FORM SETUP
        // =====================================================

        function setupQuestionForm(formId) {
            const form = document.getElementById(formId);
            if (!form) return;
            const questionContainer = form.closest('.question-container');
            if (!questionContainer) return;
            const submitBtn = questionContainer.querySelector('.submit-btn');
            const nextBtn = questionContainer.querySelector('.next-btn');
            const segments = form.querySelectorAll('.cer-segment');

            if (!submitBtn) return;

            submitBtn.addEventListener('click', () => {
                let allCorrect = true;
                
                segments.forEach(segment => {
                    const inputs = segment.querySelectorAll('.answer-input');
                    const icon = segment.querySelector('.feedback-icon');
                    let isGroupCorrect = true;
                    inputs.forEach(input => {
                        const userAnswer = input.value.trim().toLowerCase();
                        const answerString = input.dataset.answer.toLowerCase();
                        const validAnswers = answerString.split('|').map(a => a.trim());

                        if (validAnswers.includes(userAnswer)) {
                            input.style.borderBottomColor = 'var(--correct-color)';
                        } else {
                            input.style.borderBottomColor = 'var(--incorrect-color)';
                            input.value = validAnswers[0];
                            isGroupCorrect = false;
                            allCorrect = false;
                        }
                    });
                    if (icon) {
                        icon.textContent = isGroupCorrect ? 'âœ”' : 'âœ–';
                        icon.classList.add(isGroupCorrect ? 'correct' : 'incorrect', 'visible');
                    }
                });

                form.querySelectorAll('.answer-input').forEach(input => input.disabled = true);
                submitBtn.disabled = true;
                
                if (nextBtn) nextBtn.classList.remove('hidden');
                
                // Show explanation if it exists
                const explanationBox = form.querySelector('.explanation-box');
                if (explanationBox) {
                    explanationBox.style.display = 'block';
                }
                
                // Show video if it exists
                const videoContainer = form.querySelector('.video-container');
                if (videoContainer) {
                    videoContainer.style.display = 'block';
                }
            });
        }
        window.setupQuestionFormGlobal = setupQuestionForm;

        // =====================================================
        // ADD CONTROLS TO QUESTIONS
        // =====================================================

        function addControlsToQuestion(container) {
            // Add worksheet button if not exists
            if (!container.querySelector('.worksheet-control-bar')) {
                const bar = document.createElement('div');
                bar.className = 'worksheet-control-bar';
                bar.style.display = 'flex';
                bar.style.gap = '10px';
                bar.style.flexWrap = 'wrap';

                const qId = container.id;
                const isInWorksheet = qId && window.worksheetItems.some(item => item.id === qId);

                bar.innerHTML = `
                    <button class="btn-worksheet-add ${isInWorksheet ? 'added' : ''}" onclick="toggleWorksheetItem(this)">${isInWorksheet ? 'âœ… Added' : 'âž• Worksheet'}</button>
                    <button class="consult-btn" onclick="showConsultModal(this)">ðŸ’¬ Ask Mr Chung</button>
                `;
                container.appendChild(bar);
            } else {
                // Add consult button if missing
                const bar = container.querySelector('.worksheet-control-bar');
                if (bar && !bar.querySelector('.consult-btn')) {
                    const consultBtn = document.createElement('button');
                    consultBtn.className = 'consult-btn';
                    consultBtn.onclick = function() { showConsultModal(this); };
                    consultBtn.innerHTML = 'ðŸ’¬ Ask Mr Chung';
                    bar.appendChild(consultBtn);
                }
            }

            // Add admin controls if admin
            if (window.isAdminUser && !container.querySelector('.admin-controls')) {
                const controls = document.createElement('div');
                controls.className = 'admin-controls';
                
                const isCustomQuestion = container.classList.contains('custom-question') || container.id.includes('custom');
                
                let controlsHtml = `
                    <button class="admin-edit-btn" onclick="editQuestion(this)">âœï¸ Edit</button>
                    <button class="admin-duplicate-btn" onclick="editQuestion(this, true)">ðŸ“‹ Duplicate</button>
                `;
                
                if (isCustomQuestion) {
                    controlsHtml += `<button class="admin-delete-btn" onclick="deleteQuestion(this)" style="background: #ffeae8; color: #dc3545; border: 1px solid #dc3545;">ðŸ—‘ï¸ Delete</button>`;
                }
                
                controls.innerHTML = controlsHtml;
                container.appendChild(controls);
            }
        }

        // Delete a custom question
        window.deleteQuestion = async function(btn) {
            if (!confirm("Are you sure you want to delete this question? This cannot be undone.")) return;
            
            const container = btn.closest('.question-container');
            if (!container || !container.id) {
                alert("Cannot identify question to delete.");
                return;
            }
            
            try {
                const questionId = container.id.replace('q-', '');
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                await deleteDoc(doc(window.db_fs, "custom_questions", questionId));
                
                alert("Question deleted successfully!");
                container.remove();
            } catch (e) {
                console.error("Delete Error:", e);
                alert("Error deleting question: " + e.message);
            }
        };

        window.updateAllControls = function () {
            document.querySelectorAll('.question-container').forEach(addControlsToQuestion);
        };

        // =====================================================
        // PRINT FUNCTIONS
        // =====================================================

        window.printQuestion = function (btn) {
            const container = btn.closest('.question-container');
            container.classList.add('printing');
            document.body.classList.add('print-single');
            window.print();
            document.body.classList.remove('print-single');
            container.classList.remove('printing');
        };

        window.printAll = function () {
            document.body.classList.add('print-all');
            window.print();
            document.body.classList.remove('print-all');
        };

        // =====================================================
        // TOPIC SWITCHING
        // =====================================================

        function switchTopic(topic) {
            const navButtons = {
                heat: document.getElementById('btn-heat'),
                light: document.getElementById('btn-light'),
                materials: document.getElementById('btn-materials')
            };
            const topics = {
                heat: document.getElementById('topic-heat'),
                light: document.getElementById('topic-light'),
                materials: document.getElementById('topic-materials')
            };

            Object.values(navButtons).forEach(btn => btn?.classList.remove('active'));
            Object.values(topics).forEach(t => t?.classList.add('hidden'));

            if (navButtons[topic]) navButtons[topic].classList.add('active');
            if (topics[topic]) topics[topic].classList.remove('hidden');
        }

        // =====================================================
        // MOBILE SIDEBAR TOGGLE
        // =====================================================
        
        window.toggleMobileSidebar = function() {
            const sidebar = document.querySelector('.app-body > .sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const toggleBtn = document.getElementById('mobile-menu-toggle');
            const icon = document.getElementById('mobile-menu-icon');
            
            if (sidebar && overlay) {
                const isOpen = sidebar.classList.contains('mobile-open');
                
                if (isOpen) {
                    closeMobileSidebar();
                } else {
                    sidebar.classList.add('mobile-open');
                    overlay.classList.add('active');
                    toggleBtn.classList.add('active');
                    icon.textContent = 'âœ•';
                    document.body.style.overflow = 'hidden';
                }
            }
        };

        window.closeMobileSidebar = function() {
            const sidebar = document.querySelector('.app-body > .sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const toggleBtn = document.getElementById('mobile-menu-toggle');
            const icon = document.getElementById('mobile-menu-icon');
            
            if (sidebar) {
                sidebar.classList.remove('mobile-open');
            }
            if (overlay) {
                overlay.classList.remove('active');
            }
            if (toggleBtn) {
                toggleBtn.classList.remove('active');
            }
            if (icon) {
                icon.textContent = 'â˜°';
            }
            document.body.style.overflow = '';
        };

        // Close sidebar when clicking a sidebar button on mobile
        window.handleSidebarButtonClick = function(callback) {
            return function(e) {
                // Close mobile sidebar if open
                if (window.innerWidth <= 768) {
                    closeMobileSidebar();
                }
                // Execute the original callback
                if (callback) callback(e);
            };
        };

        // Handle orientation change
        window.addEventListener('orientationchange', function() {
            // Close mobile sidebar on orientation change
            closeMobileSidebar();
            
            // Delay to let the browser settle
            setTimeout(() => {
                // Scroll to top to reset view
                window.scrollTo(0, 0);
            }, 100);
        });

        // Handle resize - close sidebar if switching from mobile to desktop
        let lastWidth = window.innerWidth;
        window.addEventListener('resize', function() {
            const currentWidth = window.innerWidth;
            
            // If crossing the 768px threshold, close mobile sidebar
            if (lastWidth <= 768 && currentWidth > 768) {
                closeMobileSidebar();
            }
            
            lastWidth = currentWidth;
        });

        // Prevent body scroll when sidebar is open (iOS fix)
        document.addEventListener('touchmove', function(e) {
            const sidebar = document.querySelector('.app-body > .sidebar');
            if (sidebar && sidebar.classList.contains('mobile-open')) {
                // Allow scrolling within the sidebar
                if (!sidebar.contains(e.target)) {
                    e.preventDefault();
                }
            }
        }, { passive: false });

        // =====================================================
        // DOM CONTENT LOADED
        // =====================================================

        document.addEventListener('DOMContentLoaded', () => {
            // Load worksheet from storage
            loadWorksheetFromStorage();

            // Setup topic navigation
            const topicButtons = ['heat', 'light', 'materials'];
            topicButtons.forEach(topic => {
                const btn = document.getElementById(`btn-${topic}`);
                if (btn) {
                    btn.addEventListener('click', () => switchTopic(topic));
                }
            });

            // Setup next buttons
            document.querySelectorAll('.next-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const currentQuestion = button.closest('.question-container');
                    const nextQuestion = currentQuestion?.nextElementSibling;
                    if (nextQuestion && nextQuestion.classList.contains('question-container')) {
                        nextQuestion.classList.remove('hidden');
                        nextQuestion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });

            // Setup all question forms
            document.querySelectorAll('.answer-template').forEach(form => {
                if (form.id) setupQuestionForm(form.id);
            });

            // Initialize with heat topic
            switchTopic('heat');

            // Update worksheet UI
            updateWorksheetUI();
        });
    </script>

    <!-- Firebase Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAUSI3Uh28IeqASEp0JhH4QPaVt-O3meBo",
            authDomain: "mathgen--app.firebaseapp.com",
            projectId: "mathgen--app",
            storageBucket: "mathgen--app.firebasestorage.app",
            messagingSenderId: "165654161198",
            appId: "1:165654161198:web:16c8bd60eb3a2aa7edbcbf",
            measurementId: "G-0MWZFG211D"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth;
        const db_fs = getFirestore(app);
        window.db_fs = db_fs;
        const googleProvider = new GoogleAuthProvider();

        let isSignUpMode = false;

        window.toggleAuthMode = () => {
            isSignUpMode = !isSignUpMode;
            document.getElementById('reg-fields').style.display = isSignUpMode ? "block" : "none";
            document.getElementById('legal-box').style.display = isSignUpMode ? "block" : "none";
            document.getElementById('btn-google').style.display = isSignUpMode ? "none" : "flex";
            document.getElementById('auth-title').innerText = isSignUpMode ? "Register Student Account" : "Welcome Back!";
            document.getElementById('btn-login').innerText = isSignUpMode ? "Confirm Registration" : "Login";
        };

        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errorMsg = document.getElementById('auth-error');
            if (!email || !pass) { errorMsg.innerText = "Fields cannot be empty."; return; }

            try {
                if (isSignUpMode) {
                    const pName = document.getElementById('parent-name').value;
                    const students = getStudentsData();
                    
                    if (!pName || students.length === 0 || !document.getElementById('legal-agree').checked) {
                        errorMsg.innerText = "Please fill parent name, at least one student with level, and agree to terms."; 
                        return;
                    }
                    
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db_fs, "users", cred.user.uid), {
                        email, 
                        parentName: pName, 
                        students: students,
                        studentName: students[0].name, // Backwards compatibility
                        level: students[0].level, // Backwards compatibility
                        loginDays: 1, 
                        lastLoginDate: new Date().toDateString(), 
                        agreedToTerms: true
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (e) {
                console.error("Auth Error:", e);
                errorMsg.innerText = "Invalid email or password";
            }
        };

        window.handleForgotPassword = async () => {
            const email = document.getElementById('auth-email').value;
            const errorMsg = document.getElementById('auth-error');
            if (!email) {
                errorMsg.innerText = "Please enter your email address first.";
                errorMsg.style.color = "#dc3545";
                return;
            }

            try {
                await sendPasswordResetEmail(auth, email);
                errorMsg.innerText = "Password reset email sent! Check your inbox.";
                errorMsg.style.color = "#28a745";
            } catch (e) {
                console.error("Reset Error:", e);
                errorMsg.innerText = "Error sending reset email: " + e.message;
                errorMsg.style.color = "#dc3545";
            }
        };

        window.handleGoogleLogin = async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                await trackLoginDays(result.user);
            } catch (e) {
                document.getElementById('auth-error').innerText = "Google Error: " + e.message;
            }
        };

        async function trackLoginDays(user) {
            const userRef = doc(db_fs, "users", user.uid);
            const today = new Date().toDateString();
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                const data = userSnap.data();
                if (data.lastLoginDate !== today) {
                    await updateDoc(userRef, { loginDays: increment(1), lastLoginDate: today });
                }
                const display = document.getElementById('login-days-display');
                if (display) display.innerText = `ðŸ“… Day ${data.loginDays || 1} streak!`;
            } else {
                await setDoc(userRef, { email: user.email, studentName: user.displayName || "Student", loginDays: 1, lastLoginDate: today });
            }
        }

        window.handleLogout = () => signOut(auth).then(() => {
            // Clear all session data on logout
            sessionStorage.clear();
            localStorage.removeItem('server_file_version');
            window.location.href = window.location.origin + window.location.pathname + '?r=' + Date.now();
        });

        onAuthStateChanged(auth, (user) => {
            const overlay = document.getElementById('auth-overlay');
            if (user) {
                overlay.style.display = 'none';
                trackLoginDays(user);

                window.loadCustomQuestions = async function() {
                    if (window.customQuestionsLoaded) return;
                    window.customQuestionsLoaded = true;

                    try {
                        const qSnapshot = await getDocs(query(collection(db_fs, "custom_questions")));
                        qSnapshot.forEach((docSnap) => {
                            const data = docSnap.data();
                            const category = data.category;
                            const topic = data.topic || 'general';
                            const topicId = topic.toLowerCase().replace(/\s+/g, '-');

                            // If MCQ, attach to the main content area topics instead of being inside view-cer
                            const mainContentArea = document.getElementById('main-content-area');
                            const targetView = category === 'mcq' ? null : document.getElementById(`view-${category}`);

                            let containerId = category === 'mcq' ? `topic-mcq-${topicId}` : `topic-${topicId}`;
                            let topicContainer = document.getElementById(containerId);

                            if (!topicContainer) {
                                topicContainer = document.createElement('div');
                                topicContainer.id = containerId;
                                topicContainer.className = 'topic-content hidden';
                                if (category === 'mcq') {
                                    mainContentArea.appendChild(topicContainer);
                                } else if (targetView) {
                                    // Try to find main-content, if not found, append directly to view
                                    const targetContent = targetView.querySelector('.main-content');
                                    if (targetContent) {
                                        targetContent.appendChild(topicContainer);
                                    } else {
                                        targetView.appendChild(topicContainer);
                                    }
                                }
                            }

                            if (topicContainer) {
                                const qId = "q-" + docSnap.id;
                                const div = document.createElement('div');
                                div.className = 'question-container custom-question';
                                div.id = qId;
                                div.style.borderLeft = '4px solid #fbc02d';
                                
                                // Convert any Dropbox URLs in the saved HTML
                                let processedHtml = data.html;
                                // Fix Dropbox image URLs
                                processedHtml = processedHtml.replace(/src="(https:\/\/www\.dropbox\.com\/scl\/[^"]+)"/g, (match, url) => {
                                    let fixedUrl = url.replace(/[?&]dl=[01]/, '&raw=1');
                                    if (!fixedUrl.includes('raw=1')) {
                                        fixedUrl += (fixedUrl.includes('?') ? '&' : '?') + 'raw=1';
                                    }
                                    return `src="${fixedUrl}"`;
                                });
                                
                                // Remove any existing controls/buttons from saved HTML to prevent duplicates
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = processedHtml;
                                tempDiv.querySelectorAll('.controls').forEach(el => el.remove());
                                // Also remove any stray buttons that might be outside controls
                                tempDiv.querySelectorAll('button.submit-btn, button.next-btn, button.print-btn, button.btn-primary').forEach(el => el.remove());
                                // Remove any divs that only contain "Check Answer" text
                                tempDiv.querySelectorAll('div').forEach(div => {
                                    const text = div.textContent.trim();
                                    if (text === 'Check Answer' || text === 'Submit') {
                                        div.remove();
                                    }
                                });
                                // Remove mcq-option labels that contain "Check Answer"
                                tempDiv.querySelectorAll('.mcq-option, label').forEach(el => {
                                    if (el.textContent.trim().includes('Check Answer')) {
                                        el.remove();
                                    }
                                });
                                // Ensure explanation boxes are hidden by default
                                tempDiv.querySelectorAll('.explanation-box').forEach(el => {
                                    el.style.display = 'none';
                                });
                                // Ensure video containers are hidden by default
                                tempDiv.querySelectorAll('.video-container').forEach(el => {
                                    el.style.display = 'none';
                                    el.classList.add('hidden-until-answered');
                                });
                                processedHtml = tempDiv.innerHTML;
                                
                                div.innerHTML = `
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                            <h3 style="margin: 0; color: var(--primary-blue);">${data.title || 'Custom Question'}</h3>
                                            <span style="font-size: 0.7rem; background: #fff9c4; padding: 2px 8px; border-radius: 4px; color: #fbc02d; font-weight: bold;">USER CONTRIBUTED (${topic.toUpperCase()})</span>
                                        </div>
                                        <div id="${qId}-body" class="question-body ${category === 'mcq' ? 'mcq-body' : 'answer-template'}" style="background: rgba(251, 192, 45, 0.05); padding: 1.5rem; border-radius: 8px;">
                                            ${processedHtml}
                                            <div class="controls" style="margin-top: 2rem;">
                                                <button class="btn btn-primary submit-btn" ${category === 'mcq' ? `onclick="checkMcq('${qId}-body')"` : ''} style="background: #fbc02d; border-color: #fbc02d;">Check Answer</button>
                                            </div>
                                        </div>
                                    `;
                                topicContainer.appendChild(div);
                                if (category !== 'mcq' && window.setupQuestionFormGlobal) {
                                    window.setupQuestionFormGlobal(`${qId}-body`);
                                }
                            }
                        });

                        if (window.currentMode === 'mcq') window.renderMcqQuestionList();

                        // Update all controls after loading custom questions
                        setTimeout(() => {
                            window.updateAllControls();
                        }, 100);

                    } catch (e) {
                        console.error("Error loading custom questions:", e);
                    }
                }

                // Check admin status
                const emailParts = user.email.toLowerCase().split('@');
                const handle = emailParts[1] === 'gmail.com' ? emailParts[0].replace(/\./g, '') : emailParts[0];
                const adminHandles = ['zhikaichung', 'chungzhikai'];
                const isAdmin = adminHandles.includes(handle) || user.email.toLowerCase().includes('admin');

                if (isAdmin) {
                    console.log("Admin identified:", user.email);
                    window.isAdminUser = true;
                    document.getElementById('btn-sidebar-admin').classList.remove('hidden');
                } else {
                    window.isAdminUser = false;
                    document.getElementById('btn-sidebar-admin').classList.add('hidden');
                }

                window.loadCustomQuestions();

                // Add controls to all questions
                setTimeout(() => {
                    window.updateAllControls();
                    window.updateWorksheetUI();
                    window.addConsultButtons();
                    window.updateUnreadCount();
                }, 200);
            } else {
                overlay.style.display = 'flex';
            }
        });
    </script>

    <!-- PowerPoint-style Table Grid Selector (positioned fixed, outside all containers) -->
    <div id="table-grid-selector" class="table-grid-selector">
        <h4 style="margin: 0 0 12px 0; font-size: 1rem; color: #2e7d32; font-weight: 600; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.2rem;">ðŸ“Š</span> Insert Table
        </h4>
        <p style="margin: 0 0 10px 0; font-size: 0.8rem; color: #666;">Hover to select size, click to insert</p>
        <div class="table-grid" id="table-grid"></div>
        <div class="grid-size-label" id="grid-size-label" style="text-align: center; margin-top: 12px; font-size: 0.95rem; color: #2e7d32; font-weight: 600; min-height: 20px;">Select size</div>
    </div>

</body>

</html>
