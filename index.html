<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <!-- AGGRESSIVE CACHE PREVENTION -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <!-- APP VERSION - Update this when making changes -->
    <meta name="app-version" content="2026.01.13.3">
    <title>CER Interactive Questions</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --main-text: #333;
            --light-text: #555;
            --peach: #fcece3;
            --teal: #d7eded;
            --blue-light: #e7f5ff;
            --border-color: #dee2e6;
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --primary-blue: #007bff;
            --secondary-blue: #6c757d;
            --disabled-grey: #b0b8c0;
            --label-color: #aab5c0;
            --card-bg: #ffffff;
            --sidebar-bg: #fdfdfd;
            --input-bg: #ffffff;
            --modal-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.15);
        }

        /* Dark Mode Colors */
        [data-theme="dark"] {
            --bg-color: #1a1a2e;
            --main-text: #e8e8e8;
            --light-text: #b0b0b0;
            --peach: #3d2e2e;
            --teal: #2e3d3d;
            --blue-light: #1e2d3d;
            --border-color: #3a3a4a;
            --correct-color: #4caf50;
            --incorrect-color: #f44336;
            --primary-blue: #5c9eff;
            --secondary-blue: #8a8a9a;
            --disabled-grey: #5a5a6a;
            --label-color: #7a7a8a;
            --card-bg: #252538;
            --sidebar-bg: #1e1e30;
            --input-bg: #2a2a3e;
            --modal-bg: #252538;
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        /* System preference dark mode */
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                --bg-color: #1a1a2e;
                --main-text: #e8e8e8;
                --light-text: #b0b0b0;
                --peach: #3d2e2e;
                --teal: #2e3d3d;
                --blue-light: #1e2d3d;
                --border-color: #3a3a4a;
                --correct-color: #4caf50;
                --incorrect-color: #f44336;
                --primary-blue: #5c9eff;
                --secondary-blue: #8a8a9a;
                --disabled-grey: #5a5a6a;
                --label-color: #7a7a8a;
                --card-bg: #252538;
                --sidebar-bg: #1e1e30;
                --input-bg: #2a2a3e;
                --modal-bg: #252538;
                --shadow-color: rgba(0, 0, 0, 0.4);
            }
        }

        /* Skip link for accessibility - shows on focus */
        .skip-link:focus {
            top: 0 !important;
            outline: 3px solid #FFD700;
            outline-offset: 2px;
        }

        /* Focus visible improvements for accessibility */
        *:focus-visible {
            outline: 3px solid var(--primary-blue);
            outline-offset: 2px;
        }

        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 3px solid var(--primary-blue);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.25);
        }

        /* Reduce motion for users who prefer it */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--main-text);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 40px var(--shadow-color);
            overflow: hidden;
            padding: 0;
        }

        .sidebar {
            width: 250px;
            padding: 2rem;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .sidebar h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .sidebar-nav button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0.9rem 1.5rem;
            margin-bottom: 1rem;
            border-radius: 50px;
            border: 2px solid var(--border-color);
            background-color: transparent;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
        }

        .sidebar-nav button.active {
            background-color: var(--teal);
            border-color: #bedbdb;
            color: #000;
            font-weight: 600;
        }

        .sidebar-nav button:hover {
            background-color: var(--blue-light);
            border-color: var(--primary-blue);
        }

        /* Sidebar Topic Count Badge */
        .sidebar-topic-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.5);
            background: rgba(0, 0, 0, 0.08);
            margin-left: auto;
        }

        .sidebar-nav button.active .sidebar-topic-badge {
            background: rgba(0, 0, 0, 0.12);
            color: rgba(0, 0, 0, 0.65);
        }

        .sidebar-nav button:hover .sidebar-topic-badge {
            background: rgba(0, 123, 255, 0.15);
            color: var(--primary-blue);
        }

        .main-content,
        .view-content,
        .topic-content {
            flex-grow: 1;
            padding: 2.5rem 3rem;
        }

        /* Premium Navigation Group Styles */
        .main-nav-groups {
            position: relative;
            z-index: 100;
        }

        .nav-group {
            position: relative;
            z-index: 100;
        }

        .nav-group:hover {
            z-index: 9999;
        }

        .nav-group-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-group:hover .nav-group-btn {
            background: rgba(0, 123, 255, 0.08) !important;
            color: var(--primary-blue) !important;
        }

        .nav-group:hover .nav-dropdown {
            opacity: 1 !important;
            transform: translateY(0) !important;
            pointer-events: all !important;
            z-index: 9999 !important;
        }

        .nav-group:hover .nav-arrow {
            transform: rotate(180deg) !important;
        }

        /* Create invisible bridge between button and dropdown to maintain hover */
        .nav-group::after {
            content: '';
            position: absolute;
            top: 100%;
            left: -20px;
            right: -20px;
            height: 12px;
            background: transparent;
            z-index: 9998;
        }

        .nav-dropdown {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 9999 !important;
        }

        .nav-dropdown-item {
            position: relative;
            overflow: hidden;
        }

        .nav-dropdown-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary-blue);
            transform: scaleY(0);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-dropdown-item:hover {
            background: rgba(0, 123, 255, 0.08) !important;
            transform: translateX(4px);
        }

        .nav-dropdown-item:hover::before {
            transform: scaleY(1);
        }

        .nav-dropdown-item:active {
            transform: translateX(4px) scale(0.98);
        }

        /* Tutorial Help Button */
        .tutorial-help-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tutorial-help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4) !important;
            background: #0056b3 !important;
        }

        .tutorial-help-btn:active {
            transform: scale(0.95);
        }

        /* ==================== LIQUID GLASS TOOLTIP SYSTEM ==================== */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip {
            position: absolute;
            /* Liquid Glass Effect */
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.9) 0%,
                rgba(255, 255, 255, 0.7) 50%,
                rgba(240, 248, 255, 0.85) 100%
            );
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            color: #1a1a2e;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.9) translateY(-8px);
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            /* Glass border and shadow */
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.12),
                0 2px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -1px 0 rgba(0, 0, 0, 0.05);
            max-width: 280px;
            white-space: normal;
            line-height: 1.5;
            letter-spacing: 0.01em;
        }

        /* Glass shimmer effect on hover */
        .tooltip::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.4) 50%,
                transparent 100%
            );
            border-radius: 16px;
            pointer-events: none;
        }

        .tooltip.show::after {
            animation: glassShimmer 0.8s ease-out forwards;
        }

        @keyframes glassShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Tooltip positioning - arrows with CSS custom properties for dynamic positioning */
        .tooltip-top::before {
            content: '';
            position: absolute;
            top: 100%;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: rgba(255, 255, 255, 0.9);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .tooltip-bottom::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-bottom-color: rgba(255, 255, 255, 0.9);
            filter: drop-shadow(0 -2px 4px rgba(0, 0, 0, 0.1));
        }

        .tooltip-left::before {
            content: '';
            position: absolute;
            left: 100%;
            top: var(--arrow-top, 50%);
            transform: translateY(-50%);
            border: 8px solid transparent;
            border-left-color: rgba(255, 255, 255, 0.9);
            filter: drop-shadow(2px 0 4px rgba(0, 0, 0, 0.1));
        }

        .tooltip-right::before {
            content: '';
            position: absolute;
            right: 100%;
            top: var(--arrow-top, 50%);
            transform: translateY(-50%);
            border: 8px solid transparent;
            border-right-color: rgba(255, 255, 255, 0.9);
            filter: drop-shadow(-2px 0 4px rgba(0, 0, 0, 0.1));
        }

        /* Show animations for fixed positioning */
        .tooltip.show {
            opacity: 1 !important;
        }

        .tooltip-top.show {
            animation: liquidGlassAppearTop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .tooltip-bottom.show {
            animation: liquidGlassAppearBottom 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .tooltip-right.show {
            animation: liquidGlassAppearRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .tooltip-left.show {
            animation: liquidGlassAppearLeft 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes liquidGlassAppearTop {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(-8px);
                backdrop-filter: blur(0px);
            }
            60% {
                transform: scale(1.02) translateY(2px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
                backdrop-filter: blur(20px);
            }
        }

        @keyframes liquidGlassAppearBottom {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(8px);
                backdrop-filter: blur(0px);
            }
            60% {
                transform: scale(1.02) translateY(-2px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
                backdrop-filter: blur(20px);
            }
        }

        @keyframes liquidGlassAppearRight {
            0% {
                opacity: 0;
                transform: scale(0.9) translateX(8px);
                backdrop-filter: blur(0px);
            }
            60% {
                transform: scale(1.02) translateX(-2px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateX(0);
                backdrop-filter: blur(20px);
            }
        }

        @keyframes liquidGlassAppearLeft {
            0% {
                opacity: 0;
                transform: scale(0.9) translateX(-8px);
                backdrop-filter: blur(0px);
            }
            60% {
                transform: scale(1.02) translateX(2px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateX(0);
                backdrop-filter: blur(20px);
            }
        }

        /* Liquid glass tooltip title styling */
        .tooltip-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: #0a0a1a;
            margin-bottom: 4px;
            display: block;
        }

        .tooltip-desc {
            font-weight: 400;
            font-size: 0.8rem;
            color: #3a3a5a;
            line-height: 1.45;
        }

        /* Dark mode support for liquid glass */
        @media (prefers-color-scheme: dark) {
            .tooltip {
                background: linear-gradient(
                    135deg,
                    rgba(40, 40, 60, 0.85) 0%,
                    rgba(30, 30, 50, 0.75) 50%,
                    rgba(45, 45, 70, 0.8) 100%
                );
                color: #e8e8f0;
                border: 1px solid rgba(255, 255, 255, 0.15);
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.4),
                    0 2px 8px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            }

            .tooltip::before {
                border-top-color: rgba(40, 40, 60, 0.85);
            }

            .tooltip-top::before {
                border-top-color: rgba(40, 40, 60, 0.85);
            }

            .tooltip-bottom::before {
                border-bottom-color: rgba(40, 40, 60, 0.85);
            }

            .tooltip-title {
                color: #ffffff;
            }

            .tooltip-desc {
                color: #c8c8e0;
            }
        }
        /* ==================== END LIQUID GLASS TOOLTIP SYSTEM ==================== */

        .question-container {
            margin-bottom: 3rem;
            position: relative;
            padding: 1.5rem;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .main-content p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            color: var(--light-text);
            line-height: 1.8;
        }

        .question-diagram {
            width: 100%;
            max-width: 600px;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .results-table {
            width: 100%;
            max-width: 700px;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .results-table th,
        .results-table td {
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .results-table thead {
            background-color: var(--peach);
        }

        .question-title {
            font-weight: 600;
            font-size: 1.15rem;
            color: var(--main-text);
        }

        .answer-box {
            background-color: var(--blue-light);
            padding: 2.5rem;
            border-radius: 12px;
            margin-top: 2rem;
        }

        .answer-template {
            font-size: 1.1rem;
            line-height: 2.2;
            color: var(--main-text);
        }

        .answer-blank {
            display: inline-flex;
            align-items: center;
            margin: 0 0.2rem;
        }

        .answer-input {
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            border: none;
            border-bottom: 2px solid var(--main-text);
            background: transparent;
            width: auto;
            min-width: 80px;
            text-align: center;
            padding: 0.1rem 0.5rem;
            margin: 0 4px;
        }

        .answer-input:focus {
            outline: none;
            border-bottom-color: var(--primary-blue);
        }

        .feedback-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            margin-left: 0.5rem;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 14px;
            transform: scale(0);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .feedback-icon.visible.correct,
        .feedback-icon.visible.incorrect {
            transform: scale(1);
            opacity: 1;
            animation: circle-pop 0.4s ease-out;
        }

        .feedback-icon.correct {
            background-color: var(--correct-color);
        }

        .feedback-icon.incorrect {
            background-color: var(--incorrect-color);
        }

        /* Answer feedback icon next to submit button */
        .answer-feedback-icon {
            display: inline-block;
            font-size: 1.5rem;
            font-weight: bold;
            margin-left: 12px;
            vertical-align: middle;
            animation: feedbackPop 0.3s ease-out;
        }

        @keyframes feedbackPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Explanation box - hidden by default, shown after answering */
        .explanation-box {
            display: none;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #f0f4ff;
            border-left: 4px solid #007bff;
            border-radius: 8px;
        }
        
        .explanation-box.visible {
            display: block;
        }

        /* Video container - hidden by default, shown after answering */
        .video-container.hidden-until-answered {
            display: none;
        }

        /* Draggable admin blocks */
        .admin-block {
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
        }
        
        .admin-block:not(.no-drag) {
            cursor: grab;
        }
        
        .admin-block:not(.no-drag):active {
            cursor: grabbing;
        }
        
        .admin-block.no-drag {
            cursor: default;
            opacity: 0.95;
        }
        
        .admin-block.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .admin-block.drag-over {
            border-top: 3px solid #007bff !important;
            margin-top: -3px;
        }
        
        .admin-block .drag-handle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: grab;
            color: #999;
            font-size: 1.2rem;
            padding: 5px;
            user-select: none;
        }
        
        .admin-block .drag-handle:hover {
            color: #666;
        }
        
        .admin-block .drag-handle:active {
            cursor: grabbing;
        }

        /* Rich Text Editor Styles */
        .text-formatting-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 8px;
            padding: 8px 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }

        .toolbar-group {
            display: flex;
            gap: 2px;
            padding: 0 8px;
            border-right: 1px solid #dee2e6;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-group:first-child {
            padding-left: 0;
        }

        .format-btn {
            width: 34px;
            height: 34px;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            color: #495057;
        }

        .format-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            transform: translateY(-1px);
        }

        .format-btn:active {
            background: #dee2e6;
            transform: translateY(0);
        }

        .format-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .rich-text-editor {
            min-height: 120px;
            padding: 14px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            outline: none;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.7;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .rich-text-editor:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }

        .rich-text-editor:empty:before {
            content: attr(data-placeholder);
            color: #adb5bd;
            pointer-events: none;
        }

        .rich-text-editor ol {
            padding-left: 2em;
            margin: 0.5em 0;
        }

        .rich-text-editor ul {
            padding-left: 2em;
            margin: 0.5em 0;
        }

        .rich-text-editor li {
            margin: 0.3em 0;
        }

        /* List type dropdown */
        .list-type-select {
            height: 34px;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0 8px;
            color: #495057;
            transition: all 0.15s ease;
        }

        .list-type-select:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .list-type-select:focus {
            outline: none;
            border-color: #007bff;
        }

        /* Parenthesis list styles using CSS counters */
        .rich-text-editor ol.paren-list {
            list-style: none;
            counter-reset: paren-counter;
        }

        .rich-text-editor ol.paren-list li {
            counter-increment: paren-counter;
        }

        .rich-text-editor ol.paren-list li::before {
            content: counter(paren-counter) ") ";
            margin-right: 0.3em;
        }

        .rich-text-editor ol.paren-list[data-list-type="lower-alpha"] li::before {
            content: counter(paren-counter, lower-alpha) ") ";
        }

        .rich-text-editor ol.paren-list[data-list-type="upper-alpha"] li::before {
            content: counter(paren-counter, upper-alpha) ") ";
        }

        .rich-text-editor ol.paren-list[data-list-type="decimal"] li::before {
            content: counter(paren-counter, decimal) ") ";
        }

        @keyframes circle-pop {
            0% {
                transform: scale(0);
            }

            60% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .cer-segment {
            position: relative;
            display: block;
            padding: 1.5rem 1.5rem 2.5rem 1.5rem;
            border: 1.5px solid var(--label-color);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .cer-segment:last-of-type {
            margin-bottom: 0;
        }

        .cer-segment::after {
            content: attr(data-label);
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--blue-light);
            padding: 0 0.5rem;
            font-size: 0.9rem;
            font-style: italic;
            color: var(--light-text);
            font-weight: 500;
        }

        .controls {
            margin-top: 2rem;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn {
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer !important;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            pointer-events: auto !important;
            position: relative;
            z-index: 1;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Worksheet Styles */
        .worksheet-badge {
            background: #ff4757;
            color: white;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 0.7rem;
            margin-left: 5px;
            vertical-align: middle;
        }

        .btn-worksheet-add {
            background: #f1f2f6;
            color: #2f3542;
            border: 1px solid #dfe4ea;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .btn-worksheet-add:hover {
            background: #2ed573;
            color: white;
            border-color: #2ed573;
        }

        .btn-worksheet-add.added {
            background: #2ed573;
            color: white;
            border-color: #2ed573;
        }

        .btn-worksheet-remove {
            background: #ffeae8;
            color: #dc3545;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-worksheet-remove:hover {
            background: #dc3545;
            color: white;
        }

        .submit-btn {
            background-color: var(--primary-blue);
            color: #fff;
        }

        .submit-btn:disabled {
            background-color: var(--disabled-grey);
            cursor: not-allowed;
        }

        .next-btn {
            background-color: var(--secondary-blue);
            color: #fff;
        }

        .hidden {
            display: none !important;
        }

        /* Top Navigation Tabs */
        .app-header {
            padding: 0.8rem 1rem 0;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            background: #f8f9fa;
        }

        /* Colored line below header that changes with tabs */
        .header-color-line {
            height: 5px;
            background: linear-gradient(90deg, #4a90d9 0%, #6ba3e0 100%);
            transition: background 0.4s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        /* Header Tabs Row with Level Selector */
        .header-tabs-row {
            display: flex;
            align-items: flex-end;
            gap: 0;
        }

        .level-selector-container {
            display: flex;
            align-items: center;
            gap: 0;
            position: relative;
            background: linear-gradient(135deg, #FFCBA4 0%, #FFB07C 100%);
            border-radius: 12px 12px 0 0;
            padding: 6px 12px 8px 12px;
            margin-right: 20px;
            box-shadow:
                0 -2px 10px rgba(255, 176, 124, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            animation: levelSelectorPulse 3s ease-in-out infinite;
            cursor: pointer;
        }

        @keyframes levelSelectorPulse {
            0%, 100% {
                box-shadow:
                    0 -2px 10px rgba(255, 176, 124, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }
            50% {
                box-shadow:
                    0 -2px 20px rgba(255, 176, 124, 0.5),
                    0 0 30px rgba(255, 203, 164, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
        }

        .level-selector-container:hover {
            animation: none;
            box-shadow:
                0 -4px 20px rgba(255, 176, 124, 0.5),
                0 0 30px rgba(255, 203, 164, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .level-selector-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #5D4037;
            margin-right: 8px;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
            white-space: nowrap;
        }

        .level-selector-badge {
            position: absolute;
            top: -8px;
            right: -5px;
            background: linear-gradient(135deg, #FF6B6B 0%, #ee5a24 100%);
            color: white;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(238, 90, 36, 0.4);
            animation: badgeBounce 2s ease-in-out infinite;
        }

        @keyframes badgeBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-2px) scale(1.05); }
        }

        .level-select {
            padding: 0.4rem 1.8rem 0.4rem 0.7rem;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            font-weight: 800;
            color: #5D4037;
            background: linear-gradient(135deg, #ffffff 0%, #FFF5EE 100%);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            cursor: pointer;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            min-width: 65px;
            text-align: center;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.2s ease;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23CC7A4A' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
            background-size: 12px;
        }

        .level-select:hover {
            background: linear-gradient(135deg, #ffffff 0%, #FFE8D6 100%);
            transform: scale(1.02);
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        .level-select:focus {
            box-shadow:
                0 0 0 3px rgba(255, 176, 124, 0.3),
                0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .level-select option {
            background: white;
            color: #333;
            font-weight: 700;
            padding: 12px;
        }

        #header-tabs-container {
            display: flex;
            flex-wrap: wrap-reverse;
            align-items: flex-end;
            align-content: flex-end;
            margin: 0;
            padding: 0;
            flex: 1;
        }

        .app-logo {
            height: 50px;
            margin-right: 0;
            margin-bottom: 0;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            transition: transform 0.3s ease;
        }

        .app-logo:hover {
            transform: scale(1.05) rotate(-2deg);
        }

        .tab-btn {
            padding: 0.45rem 0.9rem;
            border: 1px solid #ccc;
            border-bottom: none;
            background-color: #e8e8e8;
            font-family: 'Poppins', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            color: #555;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            transition: all 0.15s ease;
            position: relative;
            margin: 0;
            margin-left: -1px;
            opacity: 0.9;
        }

        .tab-btn:first-child {
            margin-left: 0;
        }

        .tab-btn:hover {
            opacity: 1;
            z-index: 2;
        }

        .tab-btn.active {
            opacity: 1;
            border-color: #aaa;
            z-index: 3;
            font-weight: 600;
            color: #333;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.08);
        }

        /* Specific Pastel Colors for Tabs */
        .tab-btn[data-type="cer"] {
            background-color: #AEC6CF;
        }

        .tab-btn[data-type="single-relationship"] {
            background-color: #FFB7B2;
        }

        .tab-btn[data-type="double-relationship"] {
            background-color: #FFDAC1;
        }

        .tab-btn[data-type="fairness"] {
            background-color: #E2F0CB;
        }

        .tab-btn[data-type="reliability"] {
            background-color: #C7CEEA;
        }

        .tab-btn[data-type="accuracy"] {
            background-color: #FDFD96;
        }

        .tab-btn[data-type="constant-variable"] {
            background-color: #B5EAD7;
        }

        .tab-btn[data-type="explanation"] {
            background-color: #FF9AA2;
        }

        .tab-btn[data-type="control-setup"] {
            background-color: #E0BBE4;
        }

        .tab-btn[data-type="definition"] {
            background-color: #ADD8E6;
        }

        /* Tab Question Count Badge */
        .tab-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            margin-left: 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.6);
            background: rgba(0, 0, 0, 0.12);
            vertical-align: middle;
        }

        .tab-btn.active .tab-count-badge {
            background: rgba(0, 0, 0, 0.18);
            color: rgba(0, 0, 0, 0.7);
        }

        .tab-btn[data-type="definition"] {
            background-color: #ADD8E6;
        }

        .app-body {
            display: none;
            flex-grow: 1;
            background: #fff;
            border-top: none;
            position: relative;
            z-index: 15;
        }

        .app-body.active {
            display: flex;
        }

        .app-body>.sidebar {
            border-right: 1px solid var(--border-color);
            background: #fdfdfd;
        }

        .placeholder-content {
            padding: 3rem;
            text-align: center;
            width: 100%;
        }

        /* Variable Labels & Tooltips */
        .answer-group {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: bottom;
            margin: 0 0.2rem;
            position: relative;
            top: 10px;
        }

        .answer-group .answer-blank {
            margin: 0;
        }

        .variable-label {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
            border-bottom: 1px dotted #ccc;
            cursor: help;
            position: relative;
        }

        .variable-label:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            /* Liquid Glass Effect */
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.92) 0%,
                rgba(255, 255, 255, 0.75) 50%,
                rgba(240, 248, 255, 0.88) 100%
            );
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            color: #1a1a2e;
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 0.8rem;
            font-weight: 500;
            width: 220px;
            text-align: center;
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.12),
                0 2px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            pointer-events: none;
            line-height: 1.45;
            animation: liquidGlassAppear 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .variable-label:hover::before {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: rgba(255, 255, 255, 0.9);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .print-btn {
            background-color: #ffda9e;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #555;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-family: 'Poppins', sans-serif;
        }

        .print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: #ffc978;
        }

        /* Auth Overlay */
        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .auth-box {
            background: white;
            padding: 3rem;
            border-radius: 24px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.15);
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.05);
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .auth-logo {
            height: 70px;
            margin-bottom: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .auth-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .auth-subtitle {
            color: #666;
            margin-bottom: 2.5rem;
            font-size: 1.1rem;
        }

        .auth-input {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 16px;
            border: 2px solid var(--border-color);
            border-radius: 14px;
            font-size: 1rem;
            transition: all 0.2s;
            font-family: inherit;
            background: var(--input-bg);
            color: var(--main-text);
        }

        .auth-input:focus {
            border-color: var(--primary-blue);
            background: var(--card-bg);
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.15);
        }

        .auth-input::placeholder {
            color: var(--label-color);
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
            font-family: inherit;
        }

        .auth-btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
            box-shadow: 0 10px 20px rgba(0, 123, 255, 0.2);
        }

        .btn-primary:hover {
            box-shadow: 0 15px 30px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-google {
            background: white;
            border: 2px solid #eee;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .btn-google:hover {
            background: #fafafa;
            border-color: #ddd;
        }

        .toggle-link {
            color: var(--primary-blue);
            cursor: pointer;
            font-size: 0.95rem;
            margin-top: 20px;
            display: inline-block;
            font-weight: 500;
        }

        .toggle-link:hover {
            text-decoration: underline;
        }

        .error-msg {
            color: #dc3545;
            font-size: 0.95rem;
            margin-bottom: 20px;
            min-height: 24px;
            font-weight: 500;
        }

        .legal-check {
            text-align: left;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
        }

        .legal-check input {
            margin-top: 4px;
        }

        /* Streak Display */
        #login-days-display {
            background: linear-gradient(135deg, #e7f5ff 0%, #d7eded 100%);
            color: #007bff;
            padding: 15px;
            border-radius: 14px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.05rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
        }

        /* Animated Practice Mode Button */
        .practice-btn-animated {
            width: 100%;
            padding: 14px 16px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            color: white;
            font-family: 'Poppins', sans-serif;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3);
            animation: practiceGradient 3s ease infinite, practicePulse 2s ease-in-out infinite;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .practice-btn-animated:hover {
            transform: scale(1.03) translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5), 0 0 40px rgba(118, 75, 162, 0.4);
        }

        .practice-btn-animated:active {
            transform: scale(0.98);
        }

        .practice-btn-animated::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: practiceShine 3s ease-in-out infinite;
        }

        .practice-btn-icon {
            font-size: 1.3rem;
            animation: practiceBounce 1s ease-in-out infinite;
        }

        .practice-btn-text {
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .practice-btn-sparkle {
            font-size: 1rem;
            animation: practiceSparkle 1.5s ease-in-out infinite;
        }

        @keyframes practiceGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes practicePulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(102, 126, 234, 0.6), 0 0 45px rgba(118, 75, 162, 0.5); }
        }

        @keyframes practiceShine {
            0% { left: -50%; opacity: 0; }
            20% { opacity: 1; }
            50% { left: 100%; opacity: 0; }
            100% { left: 100%; opacity: 0; }
        }

        @keyframes practiceBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        @keyframes practiceSparkle {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
            25% { transform: scale(1.2) rotate(10deg); opacity: 0.8; }
            50% { transform: scale(0.8) rotate(-10deg); opacity: 1; }
            75% { transform: scale(1.1) rotate(5deg); opacity: 0.9; }
        }

        .practice-btn-animated.active {
            background: linear-gradient(135deg, #4c5fd5 0%, #5d3d8a 50%, #d87de8 100%);
        }

        /* Admin Edit Buttons */
        .admin-controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 50;
        }

        .admin-edit-btn,
        .admin-duplicate-btn,
        .admin-delete-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .admin-edit-btn:hover {
            background: #e7f5ff;
            border-color: #007bff;
            color: #007bff;
        }

        .admin-duplicate-btn:hover {
            background: #fdfdfd;
            border-color: #555;
        }

        .admin-delete-btn:hover {
            background: #dc3545 !important;
            color: white !important;
            border-color: #dc3545 !important;
        }

        /* Worksheet Control Bar */
        .worksheet-control-bar {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 50;
        }

        /* Worksheet Question Card */
        .worksheet-question-card {
            background: #fff;
            border: 2px solid #e3f2fd;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .worksheet-question-card .question-number {
            position: absolute;
            top: -12px;
            left: 20px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 4px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .worksheet-question-card .remove-btn-wrapper {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        /* MCQ Option Styles */
        .mcq-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: white;
            border: 2px solid #eee;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mcq-option:hover {
            border-color: var(--primary-blue);
            background: var(--blue-light);
        }

        .mcq-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* MCQ Correct Answer Dropdown Fix */
        #mcq-correct {
            line-height: normal;
            padding-top: 5px;
            padding-bottom: 5px;
            appearance: auto;
        }

        /* Logout Button */
        .logout-btn {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #ffeae8;
            color: #dc3545;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #dc3545;
            color: white;
        }

        /* Sidebar Sections */
        .sidebar-top-section {
            padding-bottom: 15px;
        }

        .sidebar-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #ddd, transparent);
            margin: 15px 0;
            position: relative;
        }

        .sidebar-divider::before {
            content: '  ';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #fdfdfd;
            padding: 0 10px;
            color: #bbb;
            font-size: 0.7rem;
            letter-spacing: 3px;
        }

        .sidebar-nav-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .sidebar-nav-btn {
            width: 100%;
            border-radius: 10px;
            border: none;
            padding: 12px 15px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            text-align: left;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-nav-btn:hover {
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sidebar-nav-btn.admin-btn {
            background: #ffd1dc;
            color: #d81b60;
        }

        .sidebar-nav-btn.worksheet-btn {
            background: #e3f2fd;
            color: #1976d2;
        }

        .sidebar-nav-btn.saved-btn {
            background: #e8f5e9;
            color: #388e3c;
        }

        .sidebar-nav-btn.lessons-btn {
            background: #fff3e0;
            color: #f57c00;
        }

        .sidebar-nav-btn.progress-btn {
            background: linear-gradient(135deg, #e8eaf6, #c5cae9);
            color: #3f51b5;
        }

        /* iOS-Style Toggle Switch */
        .ios-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            border-radius: 16px;
            margin-bottom: 5px;
        }

        .ios-toggle-label {
            font-size: 0.9rem;
            font-weight: 700;
            color: #666;
            min-width: 35px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .ios-toggle-label.active {
            color: #007AFF;
            transform: scale(1.1);
        }

        .ios-toggle {
            position: relative;
            width: 60px;
            height: 32px;
            cursor: pointer;
        }

        .ios-toggle-track {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #34C759 0%, #30D158 100%);
            border-radius: 16px;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 8px rgba(52, 199, 89, 0.3);
        }

        .ios-toggle.mcq-active .ios-toggle-track {
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .ios-toggle-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2), 0 1px 2px rgba(0,0,0,0.1);
        }

        .ios-toggle.mcq-active .ios-toggle-thumb {
            left: 30px;
        }

        .ios-toggle:hover .ios-toggle-thumb {
            transform: scale(1.05);
        }

        .ios-toggle:active .ios-toggle-thumb {
            width: 34px;
        }

        .ios-toggle.mcq-active:active .ios-toggle-thumb {
            left: 24px;
        }

        /* Exam Mode Toggle (Colour/Monochrome) */
        .exam-mode-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
            border-radius: 12px;
            margin-top: 8px;
        }

        .exam-mode-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #888;
            min-width: 50px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .exam-mode-label:first-of-type {
            text-align: right;
        }

        .exam-mode-label:last-of-type {
            text-align: left;
        }

        .exam-mode-toggle-container .exam-mode-label:first-of-type {
            color: #4CAF50;
            font-weight: 700;
        }

        .exam-mode-toggle-container.exam-active .exam-mode-label:first-of-type {
            color: #888;
            font-weight: 600;
        }

        .exam-mode-toggle-container.exam-active .exam-mode-label:last-of-type {
            color: #616161;
            font-weight: 700;
        }

        .exam-mode-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            cursor: pointer;
        }

        .exam-mode-track {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #4CAF50 0%, #81C784 100%);
            border-radius: 13px;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .exam-mode-toggle-container.exam-active .exam-mode-track {
            background: linear-gradient(135deg, #616161 0%, #9E9E9E 100%);
        }

        .exam-mode-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .exam-mode-toggle-container.exam-active .exam-mode-thumb {
            left: 26px;
        }

        /* Exam Mode (Monochrome) Styles for Questions */
        body.exam-mode .question-container,
        body.exam-mode .question-body,
        body.exam-mode .answer-template,
        body.exam-mode .answer-box {
            filter: grayscale(100%);
            -webkit-filter: grayscale(100%);
        }

        body.exam-mode .question-container img,
        body.exam-mode .question-body img,
        body.exam-mode .answer-template img,
        body.exam-mode .answer-box img {
            filter: grayscale(100%) contrast(1.1);
            -webkit-filter: grayscale(100%) contrast(1.1);
        }

        body.exam-mode .question-container {
            background: #fff !important;
            border-color: #333 !important;
        }

        body.exam-mode .question-container h3 {
            color: #000 !important;
        }

        body.exam-mode .cer-segment {
            background: #f5f5f5 !important;
            border-color: #999 !important;
        }

        body.exam-mode .answer-input {
            border-bottom-color: #333 !important;
        }

        /* Keep buttons and controls coloured for usability */
        body.exam-mode .controls,
        body.exam-mode .worksheet-control-bar,
        body.exam-mode .admin-controls,
        body.exam-mode button,
        body.exam-mode .btn {
            filter: none !important;
            -webkit-filter: none !important;
        }

        /* Toggle animation glow */
        .ios-toggle::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.3), rgba(48, 209, 88, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .ios-toggle:hover::after {
            opacity: 1;
        }

        .ios-toggle.mcq-active::after {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.3), rgba(88, 86, 214, 0.1));
        }

        /* Logout Button Update */
        .logout-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            margin-top: 5px;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #ff5252, #e04848);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(238, 90, 90, 0.3);
        }

        /* Version indicator (for debugging) */
        .version-indicator {
            position: fixed;
            bottom: 5px;
            right: 5px;
            font-size: 10px;
            color: #ccc;
            z-index: 9999;
        }

        /* Update notification banner */
        .update-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 100000;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            animation: slideDown 0.5s ease;
            flex-wrap: wrap;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .update-banner-text {
            font-size: 0.95rem;
            font-weight: 500;
        }

        .update-banner-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .update-banner-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .update-banner-dismiss {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .update-banner-dismiss:hover {
            background: rgba(255,255,255,0.1);
            border-color: white;
        }

        /* Table Grid Selector (PowerPoint-style) */
        .table-grid-selector {
            position: fixed;
            background: white;
            border: 2px solid #81c784;
            border-radius: 12px;
            padding: 15px 18px 18px 18px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25), 0 0 0 4px rgba(129, 199, 132, 0.2);
            z-index: 10000;
            visibility: hidden;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }

        .table-grid-selector.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        /* Arrow pointing down to the button (default, when selector is above) */
        .table-grid-selector.arrow-down::after {
            content: '';
            position: absolute;
            bottom: -10px;
            top: auto;
            left: 50%;
            transform: translateX(-50%);
            border-width: 10px 10px 0 10px;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }
        
        .table-grid-selector.arrow-down::before {
            content: '';
            position: absolute;
            bottom: -13px;
            top: auto;
            left: 50%;
            transform: translateX(-50%);
            border-width: 12px 12px 0 12px;
            border-style: solid;
            border-color: #81c784 transparent transparent transparent;
        }
        
        /* Arrow pointing up to the button (when selector is below) */
        .table-grid-selector.arrow-up::after {
            content: '';
            position: absolute;
            top: -10px;
            bottom: auto;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 10px 10px 10px;
            border-style: solid;
            border-color: transparent transparent white transparent;
        }
        
        .table-grid-selector.arrow-up::before {
            content: '';
            position: absolute;
            top: -13px;
            bottom: auto;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 12px 12px 12px;
            border-style: solid;
            border-color: transparent transparent #81c784 transparent;
        }

        .table-grid-selector h4 {
            margin: 0 0 12px 0;
            font-size: 0.95rem;
            color: #333;
            font-weight: 600;
        }

        .table-grid {
            display: grid;
            grid-template-columns: repeat(8, 28px);
            grid-template-rows: repeat(8, 28px);
            gap: 3px;
            background: #f5f5f5;
            padding: 5px;
            border-radius: 6px;
        }

        .table-grid-cell {
            width: 28px;
            height: 28px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .table-grid-cell.selected {
            background: #81c784;
            border-color: #4caf50;
        }

        .table-grid-cell:hover {
            border-color: #4caf50;
        }

        .grid-size-label {
            text-align: center;
            margin-top: 12px;
            font-size: 0.9rem;
            color: #007bff;
            font-weight: 600;
        }

        /* Admin Table Editor */
        .admin-table-wrapper {
            margin-top: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .admin-table-container {
            overflow-x: auto;
            padding: 10px;
            background: white;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Century Gothic', 'Segoe UI', 'Poppins', sans-serif;
            font-size: 0.95rem;
        }

        .admin-table td,
        .admin-table th {
            border: 1px solid #bbb;
            padding: 10px 14px;
            min-width: 60px;
            position: relative;
            vertical-align: middle;
            word-wrap: break-word;
        }
        
        /* Multi-cell selection highlight */
        .admin-table td.cell-selected,
        .admin-table th.cell-selected {
            background-color: #bbdefb !important;
            outline: 2px solid #1976d2;
            outline-offset: -2px;
        }
        
        /* Selection styles */
        .admin-table td.selected-row,
        .admin-table th.selected-row {
            background-color: #e3f2fd !important;
            outline: 2px solid #2196f3;
            outline-offset: -2px;
        }
        
        .admin-table td.selected-col,
        .admin-table th.selected-col {
            background-color: #e8f5e9 !important;
            outline: 2px solid #4caf50;
            outline-offset: -2px;
        }
        
        .admin-table.selected-all td,
        .admin-table.selected-all th {
            background-color: #fff3e0 !important;
            outline: 2px solid #ff9800;
            outline-offset: -2px;
        }
        
        /* Merged cell indicator */
        .admin-table td.merged-cell,
        .admin-table th.merged-cell {
            background: linear-gradient(135deg, transparent 0%, transparent 95%, #1976d2 95%, #1976d2 100%);
        }
        
        /* Hidden cells (covered by merge) */
        .admin-table td.hidden-by-merge,
        .admin-table th.hidden-by-merge {
            display: none;
        }
        
        /* Resize overlay to capture mouse during drag */
        .table-resize-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 99999;
            cursor: col-resize;
        }
        
        .table-resize-overlay.row-resize {
            cursor: row-resize;
        }
        
        /* Selection overlay for drag selection */
        .table-selection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 99998;
            cursor: crosshair;
        }

        .admin-table td[contenteditable="true"],
        .admin-table th[contenteditable="true"] {
            outline: none;
            cursor: text;
        }

        .admin-table td[contenteditable="true"]:focus,
        .admin-table th[contenteditable="true"]:focus {
            box-shadow: inset 0 0 0 2px #007bff;
            background: #f8fbff !important;
        }

        .admin-table th {
            background: #e8e8e8;
            font-weight: 600;
        }

        .admin-table td.selected-cell,
        .admin-table th.selected-cell {
            outline: 3px solid #007bff;
            outline-offset: -3px;
        }

        /* Table Toolbar */
        .table-toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #ddd;
            align-items: center;
        }

        .table-toolbar-group {
            display: flex;
            gap: 5px;
            align-items: center;
            padding-right: 12px;
            border-right: 1px solid #ccc;
        }

        .table-toolbar-group:last-child {
            border-right: none;
        }

        .table-toolbar-group label {
            font-size: 0.75rem;
            color: #555;
            margin-right: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-toolbar button {
            padding: 7px 12px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .table-toolbar button:hover {
            background: #e7f5ff;
            border-color: #007bff;
            transform: translateY(-1px);
        }

        .table-toolbar button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .table-toolbar button.danger {
            color: #dc3545;
        }

        .table-toolbar button.danger:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        /* Pastel Color Palette */
        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 28px);
            gap: 5px;
        }

        .color-swatch {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .color-swatch:hover {
            transform: scale(1.15);
            border-color: #555;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .color-swatch.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }

        /* Color picker dropdown */
        .color-picker-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.18);
            z-index: 1002;
            display: none;
        }

        .color-picker-dropdown.visible {
            display: block;
        }

        .color-picker-dropdown h5 {
            margin: 0 0 10px 0;
            font-size: 0.8rem;
            color: #555;
            font-weight: 600;
        }

        /* Row/Column highlight on hover */
        .admin-table tr:hover td {
            background-color: rgba(0, 123, 255, 0.05);
        }

        /* Add Table Button */
        .add-block-btn.table-btn {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #81c784;
            color: #2e7d32;
        }

        .add-block-btn.table-btn:hover {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            border-color: #66bb6a;
        }

        .table-grid {
            display: grid;
            grid-template-columns: repeat(8, 24px);
            grid-template-rows: repeat(8, 24px);
            gap: 2px;
        }

        .table-grid-cell {
            width: 24px;
            height: 24px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.1s;
        }

        .table-grid-cell.selected {
            background: #AEC6CF;
            border-color: #8eb3be;
        }

        .table-grid-cell:hover {
            background: #d7eded;
        }

        .grid-size-label {
            text-align: center;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        /* Admin Table Editor */
        .admin-table-container {
            margin-top: 10px;
            overflow-x: auto;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Century Gothic', 'Poppins', sans-serif;
        }

        .admin-table td,
        .admin-table th {
            border: 1px solid #ccc;
            padding: 8px 12px;
            min-width: 80px;
            position: relative;
        }

        .admin-table td[contenteditable="true"],
        .admin-table th[contenteditable="true"] {
            outline: none;
        }

        .admin-table td[contenteditable="true"]:focus,
        .admin-table th[contenteditable="true"]:focus {
            box-shadow: inset 0 0 0 2px #007bff;
        }

        .admin-table th {
            background: #f0f0f0;
            font-weight: 600;
        }

        /* Table Toolbar */
        .table-toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            align-items: center;
        }

        .table-toolbar-group {
            display: flex;
            gap: 4px;
            align-items: center;
            padding-right: 10px;
            border-right: 1px solid #ddd;
        }

        .table-toolbar-group:last-child {
            border-right: none;
        }

        .table-toolbar-group label {
            font-size: 0.75rem;
            color: #666;
            margin-right: 5px;
        }

        .table-toolbar button {
            padding: 6px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .table-toolbar button:hover {
            background: #e7f5ff;
            border-color: #007bff;
        }

        .table-toolbar button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Pastel Color Palette */
        .color-palette {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            max-width: 200px;
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            border-color: #333;
        }

        .color-swatch.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }

        /* Row/Column Selection */
        .admin-table tr.row-selected td,
        .admin-table tr.row-selected th {
            outline: 2px solid #007bff;
            outline-offset: -2px;
        }

        .admin-table td.col-selected,
        .admin-table th.col-selected {
            outline: 2px solid #28a745;
            outline-offset: -2px;
        }

        /* Color picker dropdown */
        .color-picker-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 1001;
            display: none;
        }

        .color-picker-dropdown.visible {
            display: block;
        }

        .color-picker-dropdown h5 {
            margin: 0 0 8px 0;
            font-size: 0.8rem;
            color: #555;
        }

        /* --- PRINT STYLES --- */
        @media print {

            /* Hide all UI elements */
            .app-header,
            .sidebar,
            .controls,
            .admin-controls,
            .btn-worksheet-add,
            .worksheet-control-bar,
            .worksheet-actions,
            .print-btn,
            .next-btn,
            .submit-btn,
            .variable-label,
            .logout-btn,
            .mode-switcher,
            #tab-admin,
            #auth-overlay,
            .remove-btn-wrapper,
            .btn-worksheet-remove,
            .version-indicator {
                display: none !important;
            }

            /* Reset body */
            body {
                padding: 0 !important;
                background: white !important;
                margin: 0 !important;
                color: black !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Reset containers */
            .app-container,
            .app-body,
            #main-content-area {
                display: block !important;
                overflow: visible !important;
                height: auto !important;
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                position: static !important;
                background: white !important;
            }

            /* Hide all views by default */
            .view-content {
                display: none !important;
            }

            /* Show ONLY the worksheet view when printing worksheet */
            body.print-worksheet #view-worksheet {
                display: block !important;
                visibility: visible !important;
                padding: 20px !important;
            }

            body.print-worksheet #view-worksheet * {
                visibility: visible !important;
            }

            /* Worksheet summary page styles */
            #worksheet-summary-page {
                display: block !important;
                visibility: visible !important;
                page-break-after: always !important;
                break-after: page !important;
                margin-bottom: 2rem;
            }

            body.print-worksheet #worksheet-summary-page {
                display: block !important;
                visibility: visible !important;
            }

            #worksheet-summary-page table {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            #worksheet-summary-page th,
            #worksheet-summary-page td {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Hide worksheet header in non-print, show in print */
            #worksheet-header {
                display: none;
            }

            body.print-worksheet #worksheet-header {
                display: block !important;
                visibility: visible !important;
                margin-bottom: 2rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid #000;
            }

            /* Question container print styles */
            .worksheet-question-card {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                margin-bottom: 2rem !important;
                padding: 1.5rem !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                background: white !important;
            }

            .worksheet-question-card .question-number {
                background: #333 !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Answer box print styles */
            .answer-box {
                background: #f9f9f9 !important;
                border: 1px solid #ddd !important;
                padding: 1.5rem !important;
                margin-top: 1rem !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Answer input lines for handwriting */
            .answer-input {
                border: none !important;
                border-bottom: 1.5px solid #000 !important;
                background: transparent !important;
                min-width: 150px !important;
                height: 25px !important;
                padding: 0 !important;
                display: inline-block !important;
            }

            /* CER segments print */
            .cer-segment {
                border: 1px solid #ccc !important;
                margin-bottom: 1rem !important;
                padding: 1rem !important;
                background: white !important;
            }

            .cer-segment::after {
                background: white !important;
                color: #666 !important;
            }

            /* Table print styles */
            .results-table {
                width: 100% !important;
                border-collapse: collapse !important;
            }

            .results-table th {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .results-table th,
            .results-table td {
                border: 1px solid #333 !important;
                padding: 8px !important;
            }

            /* Images print */
            .question-diagram {
                max-width: 400px !important;
                page-break-inside: avoid !important;
            }

            /* MCQ print styles */
            .mcq-option {
                border: none !important;
                background: transparent !important;
                padding: 8px 0 !important;
                display: block !important;
                page-break-inside: avoid;
            }

            .mcq-option input {
                display: none !important;
            }

            .mcq-option span::before {
                content: " ";
                font-size: 1.2rem;
            }

            /* Hide empty placeholder */
            #worksheet-empty-msg {
                display: none !important;
            }

            /* Print all questions mode */
            body.print-all .view-content.active {
                display: block !important;
            }

            body.print-all .topic-content:not(.hidden) {
                display: block !important;
            }

            body.print-all .question-container {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                margin-bottom: 2rem !important;
                padding: 1.5rem !important;
                border: 1px solid #ddd !important;
            }

            /* Single question print */
            body.print-single .question-container:not(.printing) {
                display: none !important;
            }

            body.print-single .question-container.printing {
                display: block !important;
                break-inside: avoid !important;
            }

            /* Page settings */
            @page {
                size: A4;
                margin: 2cm 1.5cm;
            }

            @page :first {
                margin-top: 1cm;
            }

            /* Print header with student info */
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 1.5rem;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid #333;
            }

            .print-header h1 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }

            .print-header .student-info {
                display: flex;
                justify-content: space-between;
                font-size: 0.9rem;
            }

            /* Score section at bottom */
            .print-score-section {
                display: block !important;
                margin-top: 2rem;
                padding: 1rem;
                border: 2px solid #333;
                page-break-inside: avoid;
            }

            .print-score-section .score-row {
                display: flex;
                justify-content: space-between;
                padding: 0.5rem 0;
                border-bottom: 1px dashed #999;
            }

            /* Better question formatting */
            .worksheet-question-card h4 {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }

            /* Writing lines for answers */
            .writing-lines {
                display: block !important;
                border-bottom: 1px solid #333;
                margin: 0.5rem 0;
                height: 2rem;
            }
        }

        /* Save Worksheet Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-box {
            background: var(--modal-bg);
            color: var(--main-text);
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px var(--shadow-color);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.visible .modal-box {
            transform: translateY(0);
        }

        .modal-box h3 {
            margin: 0 0 1.5rem;
            color: var(--primary-blue);
            font-size: 1.4rem;
        }

        .modal-box .form-group {
            margin-bottom: 1.5rem;
        }

        .modal-box label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .modal-box input, .modal-box textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .modal-box input:focus, .modal-box textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .modal-box .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .modal-box .btn-cancel {
            background: #f5f5f5;
            color: #666;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .modal-box .btn-save {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .modal-box .btn-save:hover {
            background: #1565c0;
        }

        /* Saved Worksheet Card */
        .saved-worksheet-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #388e3c;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .saved-worksheet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .saved-worksheet-card h4 {
            margin: 0 0 0.5rem;
            color: #333;
            font-size: 1.2rem;
        }

        .saved-worksheet-card .meta {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .saved-worksheet-card .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Lesson Card */
        .lesson-card {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #f57c00;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .lesson-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .lesson-card h4 {
            margin: 0 0 0.5rem;
            color: #e65100;
            font-size: 1.3rem;
        }

        .lesson-card .meta {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .lesson-card .description {
            color: #444;
            font-size: 0.95rem;
        }

        .lesson-card .badge {
            display: inline-block;
            background: #f57c00;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        /* Lesson Detail */
        .lesson-video-container {
            margin-bottom: 2rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .lesson-video-container iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .lesson-questions-section {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .lesson-questions-section h3 {
            margin: 0 0 1.5rem;
            color: #333;
        }

        .scroll-buttons-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            justify-content: flex-end;
        }

        .scroll-btn {
            background: #f57c00;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .scroll-btn:hover {
            background: #e65100;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(245, 124, 0, 0.3);
        }

        .scroll-btn:active {
            transform: translateY(0);
        }

        /* Student Entry Styles */
        .student-entry {
            transition: all 0.3s ease;
        }

        .add-student-btn:hover {
            background: #bbdefb !important;
        }

        /* Practice Mode Styles */
        #practice-question-content .question-container {
            margin-bottom: 0;
            box-shadow: none;
            border: none;
            padding: 0;
        }

        #practice-question-content .mcq-option,
        #practice-question-content label {
            transition: all 0.2s ease;
        }

        .practice-progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .practice-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7b1fa2, #9c27b0);
            transition: width 0.3s ease;
        }

        /* Inbox Badge */
        .inbox-badge {
            background: #dc3545;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: bold;
        }

        /* Header Icons (Inbox, Settings) */
        .header-icons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-icon-btn {
            position: relative;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid #e0e0e0;
            background: white;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-icon-btn:hover {
            background: #e3f2fd;
            border-color: #1976d2;
            transform: scale(1.05);
        }

        .header-icon-btn.active {
            background: #e3f2fd;
            border-color: #1976d2;
        }

        .header-icon-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            font-size: 0.65rem;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
        }

        /* Inbox Tabs */
        .inbox-tab {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .inbox-tab:hover {
            border-color: #0288d1;
        }

        .inbox-tab.active {
            background: #0288d1;
            color: white;
            border-color: #0288d1;
        }

        /* Message Card */
        .message-card {
            background: white;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #0288d1;
        }

        .message-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .message-card.unread {
            background: #e3f2fd;
            border-left-color: #f57c00;
        }

        .message-card .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .message-card .message-from {
            font-weight: 600;
            color: #333;
        }

        .message-card .message-date {
            font-size: 0.8rem;
            color: #888;
        }

        .message-card .message-subject {
            font-weight: 600;
            color: #0288d1;
            margin-bottom: 0.3rem;
        }

        .message-card .message-preview {
            color: #666;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .message-card .unread-dot {
            width: 10px;
            height: 10px;
            background: #f57c00;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        /* Inbox Empty State */
        .inbox-empty {
            text-align: center;
            padding: 3rem;
            color: #888;
        }

        /* Consult Button */
        .consult-btn {
            background: linear-gradient(135deg, #0288d1, #03a9f4);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .consult-btn:hover {
            background: linear-gradient(135deg, #0277bd, #0288d1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(2, 136, 209, 0.3);
        }

        .print-question-btn {
            background: linear-gradient(135deg, #5c6bc0, #7986cb);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .print-question-btn:hover {
            background: linear-gradient(135deg, #3f51b5, #5c6bc0);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(92, 107, 192, 0.3);
        }

        /* Flag Question Button */
        .flag-question-btn {
            background: linear-gradient(135deg, #ff9800, #ffc107);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .flag-question-btn:hover {
            background: linear-gradient(135deg, #f57c00, #ff9800);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }

        .flag-question-btn.flagged {
            background: linear-gradient(135deg, #f44336, #e91e63);
        }

        .flag-question-btn.flagged:hover {
            background: linear-gradient(135deg, #d32f2f, #c2185b);
        }

        /* Flag Modal */
        .flag-modal-content {
            max-width: 450px;
        }

        .flag-modal-content h3 {
            color: #ff9800;
            margin-bottom: 1rem;
        }

        .flag-modal-content textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .flag-modal-content textarea:focus {
            border-color: #ff9800;
            outline: none;
        }

        .flag-question-preview {
            background: #fff3e0;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #ff9800;
            font-size: 0.9rem;
        }

        /* Flagged Questions View */
        .flagged-question-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #ff9800;
        }

        .flagged-question-card.resolved {
            border-left-color: #4CAF50;
            opacity: 0.7;
        }

        .flagged-question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .flagged-question-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .flagged-question-meta {
            font-size: 0.8rem;
            color: #888;
        }

        .flagged-question-comment {
            background: #f5f5f5;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-style: italic;
            color: #555;
        }

        .flagged-question-comment::before {
            content: '"';
            font-size: 1.5rem;
            color: #ff9800;
            margin-right: 5px;
        }

        .flagged-question-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .flagged-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .flagged-status-badge.pending {
            background: #fff3e0;
            color: #e65100;
        }

        .flagged-status-badge.resolved {
            background: #e8f5e9;
            color: #2e7d32;
        }

        /* Ratings Dashboard Table */
        #ratings-table-body tr:hover {
            background-color: #f3e5f5 !important;
        }

        #ratings-table-body tr:hover td {
            color: #7b1fa2;
        }

        #ratings-table-body tr:hover td span[style*="underline"] {
            color: #4a148c;
        }

        /* Activity Dashboard Table */
        #activity-table-body tr:hover {
            background-color: #e3f2fd !important;
        }

        #activity-table-body tr:hover td {
            color: #1565c0;
        }

        /* Welcome Back Modal Animation */
        #welcome-back-modal .modal-box {
            animation: welcomeBounce 0.5s ease-out;
        }

        @keyframes welcomeBounce {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        #new-questions-info {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(76, 175, 80, 0.2); }
        }

        /* View Message Modal Content */
        .view-message-header {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .view-message-body {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 8px;
            min-height: 100px;
            white-space: pre-wrap;
        }

        .view-message-question {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #0288d1;
            font-size: 0.9rem;
        }

        /* =====================================================
           MOBILE MENU TOGGLE BUTTON
           ===================================================== */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1976d2, #2196f3);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .mobile-menu-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5);
        }

        .mobile-menu-toggle.active {
            background: linear-gradient(135deg, #d32f2f, #f44336);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* =====================================================
           TABLET STYLES (768px - 1024px)
           ===================================================== */
        @media screen and (max-width: 1024px) {
            body {
                padding: 1rem;
            }

            .app-container {
                max-width: 100%;
            }

            .sidebar {
                width: 220px;
                padding: 1.5rem;
            }

            .main-content,
            .view-content,
            .topic-content {
                padding: 1.5rem 2rem;
            }

            .tab-btn {
                padding: 0.4rem 0.7rem;
                font-size: 0.75rem;
            }

            .app-logo {
                height: 40px;
            }

            .question-container {
                padding: 1.25rem;
                margin-bottom: 2rem;
            }

            .answer-box {
                padding: 1.5rem;
            }

            .modal-box {
                width: 95%;
                max-width: 600px;
                padding: 1.5rem;
            }
        }

        /* =====================================================
           MOBILE STYLES (max-width: 768px)
           ===================================================== */
        @media screen and (max-width: 768px) {
            body {
                padding: 0;
                align-items: stretch;
            }

            .app-container {
                border-radius: 0;
                box-shadow: none;
                min-height: 100vh;
            }

            /* Header icons on mobile */
            .header-icons {
                gap: 5px;
            }

            .header-icon-btn {
                width: 38px;
                height: 38px;
                font-size: 1.1rem;
            }

            .header-icon-badge {
                top: -4px;
                right: -4px;
                min-width: 16px;
                height: 16px;
                font-size: 0.6rem;
            }

            /* Show mobile menu toggle */
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .sidebar-overlay {
                display: block;
                pointer-events: none;
            }

            .sidebar-overlay.active {
                pointer-events: auto;
            }
            
            /* Ensure sidebar is always above overlay and clickable */
            .app-body > .sidebar.mobile-open {
                pointer-events: auto !important;
            }
            

            /* Sidebar - slide in from left */
            .app-body > .sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                width: 280px;
                height: 100vh;
                z-index: 10000;
                padding: 1.5rem;
                padding-top: 2rem;
                overflow-y: auto;
                transition: left 0.3s ease;
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
                pointer-events: auto;
                background: white;
            }

            .app-body > .sidebar.mobile-open {
                left: 0;
                pointer-events: auto;
            }

            /* Ensure all interactive elements in sidebar are clickable */
            .app-body > .sidebar.mobile-open button,
            .app-body > .sidebar.mobile-open a,
            .app-body > .sidebar.mobile-open input,
            .app-body > .sidebar.mobile-open select,
            .app-body > .sidebar.mobile-open .ios-toggle,
            .app-body > .sidebar.mobile-open .exam-mode-toggle,
            .app-body > .sidebar.mobile-open .ios-toggle-track,
            .app-body > .sidebar.mobile-open .ios-toggle-thumb,
            .app-body > .sidebar.mobile-open .exam-mode-track,
            .app-body > .sidebar.mobile-open .exam-mode-thumb {
                pointer-events: auto !important;
                position: relative;
                z-index: 10001;
            }

            /* Show close button in mobile sidebar */
            .app-body > .sidebar .mobile-sidebar-close {
                display: block !important;
                z-index: 10001;
                pointer-events: auto !important;
            }

            /* Header adjustments */
            .app-header {
                padding: 0.5rem 0.75rem 0;
            }

            .app-logo {
                height: 35px;
            }

            #header-tabs-container {
                overflow-x: auto;
                overflow-y: hidden;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                padding-bottom: 2px;
            }

            #header-tabs-container::-webkit-scrollbar {
                display: none;
            }

            /* Level selector mobile */
            .header-tabs-row {
                flex-wrap: nowrap;
            }

            .level-selector-container {
                padding: 4px 8px 6px 8px;
                border-radius: 10px 10px 0 0;
                margin-right: 12px;
            }

            .level-selector-label {
                font-size: 0.7rem;
                margin-right: 4px;
            }

            .level-selector-badge {
                font-size: 0.5rem;
                padding: 1px 4px;
                top: -6px;
                right: -3px;
            }

            .level-select {
                padding: 0.3rem 1.4rem 0.3rem 0.5rem;
                font-size: 0.8rem;
                min-width: 50px;
                border-radius: 6px;
            }

            .tab-btn {
                padding: 0.35rem 0.6rem;
                font-size: 0.7rem;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Main content area */
            .app-body {
                flex-direction: column;
            }

            .main-content,
            .view-content,
            .topic-content {
                padding: 1rem;
            }

            /* Question container */
            .question-container {
                padding: 1rem;
                margin-bottom: 1.5rem;
                border-radius: 10px;
            }

            .question-container h3 {
                font-size: 1rem;
            }

            .main-content p,
            .question-container p {
                font-size: 0.95rem;
                line-height: 1.6;
            }

            /* Answer box */
            .answer-box {
                padding: 1rem;
                border-radius: 10px;
            }

            .answer-template {
                font-size: 0.95rem;
                line-height: 1.8;
            }

            .answer-input {
                font-size: 0.95rem;
                min-width: 60px;
            }

            /* Buttons */
            .btn, .submit-btn, .next-btn {
                padding: 12px 20px;
                font-size: 0.95rem;
                min-height: 44px;
            }

            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .controls button {
                width: 100%;
            }

            /* Worksheet control bar */
            .worksheet-control-bar {
                flex-direction: column;
                gap: 8px;
            }

            .worksheet-control-bar button {
                width: 100%;
            }

            /* MCQ Options */
            .mcq-option, .mcq-container label {
                padding: 12px 15px;
                font-size: 0.95rem;
                min-height: 48px;
            }

            /* Tables - horizontal scroll */
            .results-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .results-table th,
            .results-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
                white-space: nowrap;
            }

            /* Images */
            .question-diagram {
                max-width: 100%;
            }

            /* Modal - full screen on mobile */
            .modal-overlay {
                padding: 0;
            }

            .modal-box {
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
                padding: 1rem;
                overflow-y: auto;
            }

            .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .modal-buttons button {
                width: 100%;
            }

            /* Auth box */
            .auth-box {
                width: 95%;
                padding: 1.5rem;
                border-radius: 16px;
            }

            .auth-input {
                padding: 14px 16px;
                font-size: 1rem;
            }

            .auth-btn {
                padding: 14px;
                font-size: 1rem;
            }

            /* Sidebar buttons */
            .sidebar button,
            .sidebar-nav button {
                padding: 12px 16px;
                font-size: 0.95rem;
            }

            /* Sidebar topic badges on mobile */
            .sidebar-topic-badge {
                min-width: 22px;
                height: 22px;
                font-size: 0.7rem;
                padding: 0 6px;
            }

            /* Tab count badges on mobile */
            .tab-count-badge {
                min-width: 18px;
                height: 18px;
                font-size: 0.65rem;
                padding: 0 5px;
                margin-left: 4px;
            }

            /* Practice mode stats */
            #practice-stats {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Inbox */
            .message-card {
                padding: 1rem;
            }

            .message-header {
                flex-direction: column;
                gap: 5px;
            }

            .inbox-tab {
                padding: 8px 16px;
                font-size: 0.9rem;
            }

            /* Consult, Print, and Flag buttons on mobile */
            .consult-btn,
            .print-question-btn,
            .flag-question-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }

            /* Admin form */
            .admin-form-section {
                padding: 1rem;
            }

            .admin-form-section input,
            .admin-form-section select,
            .admin-form-section textarea {
                font-size: 1rem;
            }

            /* Lesson cards */
            .lesson-card {
                padding: 1rem;
            }

            .lesson-video-container iframe {
                height: 250px;
            }

            /* Login days display */
            #login-days-display {
                font-size: 0.9rem;
                padding: 8px;
            }

            /* iOS Toggle mobile */
            .ios-toggle-container {
                padding: 10px;
                border-radius: 12px;
            }

            .ios-toggle-label {
                font-size: 0.85rem;
                min-width: 30px;
            }

            .ios-toggle {
                width: 52px;
                height: 28px;
            }

            .ios-toggle-thumb {
                width: 24px;
                height: 24px;
            }

            .ios-toggle.mcq-active .ios-toggle-thumb {
                left: 26px;
            }

            /* Exam Mode Toggle mobile */
            .exam-mode-toggle-container {
                padding: 8px;
                gap: 6px;
            }

            .exam-mode-label {
                font-size: 0.7rem;
                min-width: 40px;
            }

            .exam-mode-toggle {
                width: 44px;
                height: 22px;
            }

            .exam-mode-thumb {
                width: 18px;
                height: 18px;
            }

            .exam-mode-toggle-container.exam-active .exam-mode-thumb {
                left: 24px;
            }

            /* Sidebar sections on mobile */
            .sidebar-nav-btn {
                padding: 10px 12px;
                font-size: 0.85rem;
            }

            .sidebar-divider {
                margin: 12px 0;
            }

            /* Text formatting toolbar on mobile */
            .text-formatting-toolbar {
                padding: 6px;
                gap: 3px;
            }

            .toolbar-group {
                padding: 0 4px;
            }

            .format-btn {
                width: 30px;
                height: 30px;
                font-size: 0.8rem;
            }

            .list-type-select {
                height: 30px;
                font-size: 0.7rem;
                padding: 0 4px;
            }

            .rich-text-editor {
                min-height: 100px;
                padding: 10px;
                font-size: 0.95rem;
            }

            /* Saved worksheets */
            .saved-worksheet-card .actions {
                flex-direction: column;
            }

            .saved-worksheet-card .actions button {
                width: 100%;
            }

            /* Explanation box */
            .explanation-box {
                padding: 1rem;
                font-size: 0.9rem;
            }

            /* CER segments */
            .cer-segment {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .segment-title {
                font-size: 0.95rem;
            }

            /* OEQ Sidebar Content */
            #oeq-sidebar-content h2,
            #mcq-sidebar-content h2 {
                font-size: 1.1rem;
            }

            /* Student entry in registration */
            .student-entry > div {
                flex-direction: column !important;
            }

            .student-entry .auth-input {
                width: 100% !important;
            }

            /* Version indicator */
            .version-indicator {
                font-size: 0.6rem;
                padding: 2px 6px;
            }

            /* Enhanced touch targets - minimum 44px */
            button, a, select, input[type="checkbox"], input[type="radio"] {
                min-height: 44px;
            }

            /* Better touch feedback */
            button:active, .tab-btn:active, .sidebar-nav-btn:active {
                transform: scale(0.97);
                opacity: 0.9;
            }

            /* Toast notifications on mobile */
            #toast-notification {
                left: 10px !important;
                right: 10px !important;
                bottom: 10px !important;
                max-width: none !important;
            }

            /* Main navigation groups on mobile */
            .main-nav-groups {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                gap: 16px !important;
                padding-left: 4px !important;
                padding-right: 4px !important;
            }

            .main-nav-groups::-webkit-scrollbar {
                display: none;
            }

            .nav-group-btn {
                font-size: 12px !important;
                padding: 6px 10px !important;
            }

            .nav-dropdown {
                min-width: 180px !important;
            }

            /* Better spacing for question cards */
            .question-container {
                margin-bottom: 1rem;
            }

            /* Full-width worksheet items */
            .worksheet-item {
                flex-direction: column;
            }

            .worksheet-item .actions {
                width: 100%;
                margin-top: 10px;
            }
        }

        /* =====================================================
           SMALL MOBILE STYLES (max-width: 480px)
           ===================================================== */
        @media screen and (max-width: 480px) {
            .tab-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.65rem;
            }

            .app-logo {
                height: 30px;
            }

            .question-container {
                padding: 0.75rem;
            }

            .answer-box {
                padding: 0.75rem;
            }

            .answer-template {
                font-size: 0.9rem;
            }

            .answer-input {
                font-size: 0.9rem;
                min-width: 50px;
            }

            #practice-stats {
                grid-template-columns: 1fr 1fr !important;
                gap: 0.5rem;
            }

            #practice-stats > div {
                padding: 0.75rem;
            }

            #practice-stats > div > div:first-child {
                font-size: 1.5rem;
            }

            .modal-box {
                padding: 0.75rem;
            }

            .modal-box h3 {
                font-size: 1.1rem;
            }

            .auth-box {
                padding: 1rem;
            }

            .auth-logo {
                width: 60px;
                height: 60px;
            }

            .auth-title {
                font-size: 1.3rem;
            }

            .legal-check label {
                font-size: 0.75rem;
            }
        }

        /* =====================================================
           LANDSCAPE ORIENTATION FIXES
           ===================================================== */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .modal-box {
                max-height: 95vh;
                overflow-y: auto;
            }

            .auth-box {
                max-height: 95vh;
                overflow-y: auto;
            }
        }

        /* =====================================================
           IPAD SPECIFIC STYLES
           ===================================================== */
        @media screen and (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            .sidebar {
                width: 200px;
            }

            .main-content,
            .view-content,
            .topic-content {
                padding: 1.5rem;
            }

            #practice-stats {
                grid-template-columns: repeat(4, 1fr) !important;
            }
        }

        @media screen and (min-width: 1024px) and (max-width: 1366px) and (orientation: landscape) {
            /* iPad Pro landscape */
            .sidebar {
                width: 230px;
            }
        }

        /* =====================================================
           TOUCH DEVICE OPTIMIZATIONS
           ===================================================== */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            .btn, button, .tab-btn, .sidebar-nav button {
                min-height: 44px;
            }

            .mcq-option, .mcq-container label {
                min-height: 48px;
            }

            /* Remove hover effects that don't work well on touch */
            .tab-btn:hover,
            .sidebar-nav button:hover,
            .btn:hover {
                transform: none;
            }

            /* Better tap feedback */
            .btn:active, button:active {
                transform: scale(0.98);
                opacity: 0.9;
            }

            /* Prevent text selection on buttons */
            button, .btn, .tab-btn {
                -webkit-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
            }

            /* Improve scrolling */
            .main-content, .view-content, .topic-content {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* =====================================================
           SAFE AREA INSETS (for notched devices)
           ===================================================== */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }

            .mobile-menu-toggle {
                bottom: max(20px, calc(env(safe-area-inset-bottom) + 10px));
                right: max(20px, calc(env(safe-area-inset-right) + 10px));
            }

            .app-body > .sidebar {
                padding-bottom: max(1.5rem, calc(env(safe-area-inset-bottom) + 1rem));
            }
        }

        /* =====================================================
           ADDITIONAL MOBILE FIXES
           ===================================================== */
        @media screen and (max-width: 768px) {
            /* Fix for iOS input zoom */
            input, select, textarea {
                font-size: 16px !important;
            }

            /* Ensure forms don't overflow */
            .form-group input,
            .form-group select,
            .form-group textarea,
            .auth-input {
                max-width: 100%;
                box-sizing: border-box;
            }

            /* Fix horizontal scroll issues */
            html, body {
                overflow-x: hidden;
                width: 100%;
            }

            .app-container {
                overflow-x: hidden;
            }

            /* Better table display on mobile */
            table {
                font-size: 0.85rem;
            }

            /* Improve question text readability */
            .question-container p {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            /* Fix image overflow */
            img {
                max-width: 100%;
                height: auto;
            }

            /* Admin controls layout */
            .admin-controls {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .admin-controls button {
                flex: 1 1 auto;
                min-width: 100px;
            }

            /* OEQ segment inputs */
            .segment-input, .cer-textarea {
                font-size: 16px;
                min-height: 80px;
            }

            /* Topic buttons in sidebar */
            #oeq-sidebar-content .topic-link,
            #mcq-sidebar-content .topic-link {
                padding: 12px;
                font-size: 0.9rem;
            }

            /* Header tabs scrollable indicator */
            #header-tabs-container::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to right, transparent, #f8f9fa);
                pointer-events: none;
            }

            /* Question popup modal fix */
            #question-popup-modal .modal-box {
                max-height: calc(100vh - 20px);
            }

            /* Consult modal fix */
            #consult-modal .modal-box,
            #new-message-modal .modal-box,
            #view-message-modal .modal-box {
                max-height: calc(100vh - 20px);
                overflow-y: auto;
            }
        }

        /* =====================================================
           IPAD PRO AND LARGE TABLET STYLES
           ===================================================== */
        @media screen and (min-width: 1024px) and (max-width: 1400px) {
            .sidebar {
                width: 240px;
            }

            .main-content,
            .view-content,
            .topic-content {
                padding: 2rem;
            }

            .tab-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.78rem;
            }
        }

        /* =====================================================
           PREVENT PULL-TO-REFRESH ON MOBILE
           ===================================================== */
        body {
            overscroll-behavior-y: contain;
        }

        /* =====================================================
           FIX FOR 100VH ON MOBILE BROWSERS
           ===================================================== */
        @media screen and (max-width: 768px) {
            .modal-overlay {
                height: 100%;
                height: -webkit-fill-available;
            }

            .auth-overlay {
                min-height: 100%;
                min-height: -webkit-fill-available;
            }
        }

        /* =====================================================
           PRINT STYLES - HIDE MOBILE ELEMENTS
           ===================================================== */
        @media print {
            .mobile-menu-toggle,
            .sidebar-overlay {
                display: none !important;
            }
        }

        /* =====================================================
           GAMIFICATION SYSTEM STYLES
           ===================================================== */

        /* XP Bar in Sidebar */
        .xp-progress-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 1rem;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .xp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .xp-level {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .xp-level-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .xp-level-title {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .xp-points {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .xp-bar-outer {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            position: relative;
        }

        .xp-bar-inner {
            background: linear-gradient(90deg, #FFD700, #FFA500);
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .xp-bar-inner::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: xpShimmer 2s infinite;
        }

        @keyframes xpShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Daily Challenge Card */
        .daily-challenge-card {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 1rem;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .daily-challenge-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .daily-challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .daily-challenge-title {
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .daily-challenge-timer {
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .daily-challenge-task {
            font-size: 0.9rem;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .daily-challenge-progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
        }

        .daily-challenge-progress-bar {
            background: #FFD700;
            height: 100%;
            border-radius: 8px;
            transition: width 0.5s ease;
        }

        .daily-challenge-reward {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Achievement Badge Styles */
        .achievements-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            width: 100%;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .achievements-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .achievements-modal {
            max-width: 600px;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            padding: 16px 0;
        }

        .achievement-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .achievement-card.unlocked {
            border-color: #FFD700;
            background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
        }

        .achievement-card.locked {
            opacity: 0.6;
            filter: grayscale(0.5);
        }

        .achievement-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .achievement-card.locked .achievement-icon {
            filter: grayscale(1);
        }

        .achievement-name {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 4px;
            color: var(--main-text);
        }

        .achievement-desc {
            font-size: 0.75rem;
            color: var(--light-text);
            line-height: 1.3;
        }

        .achievement-xp {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 8px;
            display: inline-block;
        }

        /* Celebration Effects */
        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }

        @keyframes confettiFall {
            0% {
                opacity: 1;
                transform: translateY(-100px) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(100vh) rotate(720deg);
            }
        }

        /* XP Popup Animation */
        .xp-popup {
            position: fixed;
            font-weight: 700;
            font-size: 1.5rem;
            color: #FFD700;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 215, 0, 0.5);
            pointer-events: none;
            z-index: 10001;
            animation: xpFloat 1.5s ease-out forwards;
        }

        @keyframes xpFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(-30px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(0.8);
            }
        }

        /* Level Up Modal */
        .level-up-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            z-index: 10002;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: levelUpAppear 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes levelUpAppear {
            0% { transform: translate(-50%, -50%) scale(0); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .level-up-modal h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .level-up-modal .new-level {
            font-size: 4rem;
            font-weight: 800;
            margin: 20px 0;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .level-up-modal .level-title {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .level-up-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-up-close-btn:hover {
            background: white;
            color: #667eea;
        }

        /* Streak Fire Animation */
        .streak-fire {
            animation: fireGlow 1s ease-in-out infinite alternate;
        }

        @keyframes fireGlow {
            0% { text-shadow: 0 0 5px #FF6B00, 0 0 10px #FF6B00; }
            100% { text-shadow: 0 0 10px #FF6B00, 0 0 20px #FF6B00, 0 0 30px #FF4500; }
        }

        /* Quick Start Wizard Styles */
        .quickstart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10003;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .quickstart-modal {
            background: white;
            border-radius: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .quickstart-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .quickstart-header h2 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .quickstart-header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .quickstart-content {
            padding: 30px;
        }

        .quickstart-step {
            display: none;
        }

        .quickstart-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .quickstart-step-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quickstart-step-content {
            color: #555;
            line-height: 1.6;
            font-size: 1rem;
        }

        .quickstart-feature-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .quickstart-feature-list li {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .quickstart-feature-list li:last-child {
            border-bottom: none;
        }

        .quickstart-feature-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .quickstart-footer {
            padding: 20px 30px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quickstart-dots {
            display: flex;
            gap: 8px;
        }

        .quickstart-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.3s ease;
        }

        .quickstart-dot.active {
            background: #667eea;
            width: 24px;
            border-radius: 5px;
        }

        .quickstart-nav-btn {
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .quickstart-nav-btn.prev {
            background: #f0f0f0;
            color: #666;
        }

        .quickstart-nav-btn.next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .quickstart-nav-btn:hover {
            transform: scale(1.05);
        }

        .quickstart-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Skeleton Loading Styles */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes skeletonShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
            width: 80%;
        }

        .skeleton-text.short {
            width: 40%;
        }

        .skeleton-text.medium {
            width: 60%;
        }

        .skeleton-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .skeleton-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }

        /* Smart Recommendation Card */
        .recommendation-card {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 1rem;
            color: white;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .recommendation-content {
            font-size: 0.9rem;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .recommendation-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .recommendation-btn:hover {
            background: white;
            color: #11998e;
        }

        /* Streak Bonus Display */
        .streak-bonus-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 1rem;
            color: white;
            text-align: center;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        .streak-bonus-flame {
            font-size: 2.5rem;
            animation: flamePulse 0.5s ease-in-out infinite alternate;
        }

        @keyframes flamePulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .streak-bonus-count {
            font-size: 2rem;
            font-weight: 800;
            margin: 5px 0;
        }

        .streak-bonus-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .streak-bonus-multiplier {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-top: 10px;
            display: inline-block;
        }

        /* Sound Toggle */
        .sound-toggle-btn {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .sound-toggle-btn.active {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .sound-toggle-btn:hover {
            transform: scale(1.02);
        }

        /* Dark Mode Gamification Adjustments */
        [data-theme="dark"] .achievement-card {
            background: var(--card-bg);
        }

        [data-theme="dark"] .achievement-card.unlocked {
            background: linear-gradient(135deg, #3d3d1a 0%, #4a4a2a 100%);
            border-color: #FFD700;
        }

        [data-theme="dark"] .quickstart-modal {
            background: var(--modal-bg);
        }

        [data-theme="dark"] .quickstart-step-title {
            color: var(--main-text);
        }

        [data-theme="dark"] .quickstart-step-content {
            color: var(--light-text);
        }

        [data-theme="dark"] .quickstart-feature-list li {
            border-color: var(--border-color);
        }

        [data-theme="dark"] .quickstart-footer {
            border-color: var(--border-color);
        }

        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, #2a2a3e 25%, #353548 50%, #2a2a3e 75%);
            background-size: 200% 100%;
        }

        /* Topic Mastery Progress Styles */
        .topic-mastery-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        .topic-mastery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--main-text);
        }

        .topic-mastery-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .topic-mastery-item:last-child {
            margin-bottom: 0;
        }

        .topic-mastery-name {
            font-size: 0.8rem;
            color: var(--light-text);
            width: 80px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .topic-mastery-bar {
            flex: 1;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .topic-mastery-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .topic-mastery-fill.low { background: linear-gradient(90deg, #f44336, #ff5722); }
        .topic-mastery-fill.medium { background: linear-gradient(90deg, #ff9800, #ffc107); }
        .topic-mastery-fill.high { background: linear-gradient(90deg, #8bc34a, #4caf50); }
        .topic-mastery-fill.mastered { background: linear-gradient(90deg, #4caf50, #2e7d32); }

        .topic-mastery-percent {
            font-size: 0.75rem;
            font-weight: 600;
            width: 35px;
            text-align: right;
            color: var(--main-text);
        }

        .focus-practice-btn {
            background: linear-gradient(135deg, #f44336, #e91e63);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .focus-practice-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }

        /* Loading Optimization Styles */
        .lazy-load-placeholder {
            background: var(--card-bg);
            border-radius: 12px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--light-text);
        }

        .content-loading-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 20px;
            color: var(--light-text);
        }

        .loading-spinner-small {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Focused Practice Mode Banner */
        .focus-mode-banner {
            background: linear-gradient(135deg, #f44336, #e91e63);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .focus-mode-text {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .focus-mode-exit {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Avatar/Profile Customization Styles */
        .avatar-selector-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalPop {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            transition: all 0.3s ease;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            border-color: #667eea;
        }

        .avatar-option.selected {
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #667eea20, #764ba220);
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .profile-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .profile-title {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Social Sharing Styles */
        .share-achievement-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            z-index: 10007;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .share-preview-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            margin: 20px 0;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .share-btn:hover {
            transform: scale(1.05);
        }

        .share-btn.copy {
            background: #4CAF50;
            color: white;
        }

        .share-btn.download {
            background: #2196F3;
            color: white;
        }

        /* Quest/Storyline Styles */
        .quest-card {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 1rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quest-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
        }

        .quest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .quest-title {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quest-chapter {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .quest-description {
            font-size: 0.9rem;
            opacity: 0.95;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .quest-objectives {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 12px;
        }

        .quest-objective {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
            font-size: 0.85rem;
        }

        .quest-objective.completed {
            opacity: 0.7;
            text-decoration: line-through;
        }

        .quest-objective-check {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .quest-objective.completed .quest-objective-check {
            background: #4CAF50;
        }

        /* Keyboard Shortcuts Guide */
        .shortcuts-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .shortcut-list {
            margin: 20px 0;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .shortcut-item:last-child {
            border-bottom: none;
        }

        .shortcut-action {
            color: #333;
            font-size: 0.95rem;
        }

        .shortcut-keys {
            display: flex;
            gap: 6px;
        }

        .key {
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            padding: 6px 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            font-weight: 600;
            color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 1px 0 0 #fff inset;
            border: 1px solid #ccc;
        }

        /* Enhanced Confetti */
        @keyframes confettiBurst {
            0% {
                opacity: 1;
                transform: translate(0, 0) rotate(0deg) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--x), var(--y)) rotate(720deg) scale(0.5);
            }
        }

        .confetti-burst {
            position: fixed;
            pointer-events: none;
            z-index: 10010;
            font-size: 1.5rem;
            animation: confettiBurst 1.5s ease-out forwards;
        }

        .epic-achievement-burst {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10011;
            overflow: hidden;
        }

        /* Auto-save Indicator */
        .autosave-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.95);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 9999;
            animation: fadeInUp 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .autosave-indicator.saving {
            background: rgba(33, 150, 243, 0.95);
        }

        /* Bookmark Button Styles */
        .bookmark-btn {
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px;
            border-radius: 50%;
        }

        .bookmark-btn:hover {
            transform: scale(1.2);
            background: rgba(255, 193, 7, 0.1);
        }

        .bookmark-btn.bookmarked {
            color: #FFC107;
            animation: bookmarkPop 0.4s ease;
        }

        @keyframes bookmarkPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .bookmarks-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.15);
            z-index: 10004;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .bookmarks-panel.open {
            right: 0;
        }

        .bookmarks-header {
            padding: 20px;
            background: linear-gradient(135deg, #FFC107, #FF9800);
            color: white;
        }

        .bookmarks-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .bookmark-item {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #FFC107;
        }

        .bookmark-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Pet Companion Styles */
        .pet-companion {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #FFE0B2, #FFCC80);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            cursor: pointer;
            z-index: 9998;
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
            transition: all 0.3s ease;
            animation: petBounce 2s ease-in-out infinite;
        }

        .pet-companion:hover {
            transform: scale(1.1);
        }

        @keyframes petBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .pet-speech-bubble {
            position: fixed;
            bottom: 190px;
            right: 20px;
            background: white;
            padding: 12px 18px;
            border-radius: 18px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 220px;
            z-index: 9999;
            animation: bubbleAppear 0.4s ease;
        }

        .pet-speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 30px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid white;
        }

        @keyframes bubbleAppear {
            from { opacity: 0; transform: scale(0.8) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .pet-speech-text {
            font-size: 0.9rem;
            color: #333;
            line-height: 1.4;
        }

        /* Mini Celebration Styles */
        .mini-celebration {
            position: fixed;
            pointer-events: none;
            z-index: 10012;
            font-size: 2rem;
            animation: miniCelebrate 1s ease-out forwards;
        }

        @keyframes miniCelebrate {
            0% {
                opacity: 1;
                transform: scale(0.5) translateY(0);
            }
            50% {
                opacity: 1;
                transform: scale(1.2) translateY(-30px);
            }
            100% {
                opacity: 0;
                transform: scale(1) translateY(-50px);
            }
        }

        /* Better Error Feedback */
        .error-feedback {
            background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
            border: 1px solid #EF9A9A;
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 10px;
            animation: shakeError 0.5s ease;
        }

        @keyframes shakeError {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }

        .error-feedback-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #C62828;
            margin-bottom: 8px;
        }

        .error-feedback-hint {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .success-feedback {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            border: 1px solid #A5D6A7;
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 10px;
            animation: successPulse 0.5s ease;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* Lucky Wheel Styles */
        .lucky-wheel-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 30px;
            z-index: 10010;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            text-align: center;
            animation: modalPop 0.4s ease;
        }

        .wheel-wrapper {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 20px auto;
        }

        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 8px solid #667eea;
            position: relative;
            overflow: hidden;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
        }

        .wheel-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            left: 0;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: white;
        }

        .wheel-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #667eea;
            z-index: 1;
        }

        .spin-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .spin-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .spin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Daily Login Rewards */
        .login-rewards-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            z-index: 10009;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            animation: modalPop 0.4s ease;
        }

        .rewards-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin: 20px 0;
        }

        .reward-day {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .reward-day.claimed {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
        }

        .reward-day.today {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            animation: pulse 2s infinite;
        }

        .reward-day.locked {
            opacity: 0.5;
        }

        .reward-day-num {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .reward-day-prize {
            font-size: 1.2rem;
        }

        /* Sound Toggle */
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            z-index: 9997;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .sound-toggle:hover {
            transform: scale(1.1);
            border-color: #667eea;
        }

        .sound-toggle.muted {
            opacity: 0.6;
        }

        /* Lazy Loading */
        .lazy-image {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .lazy-image.loaded {
            opacity: 1;
        }

        .image-placeholder {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Contextual Help Tooltip */
        .help-tooltip {
            position: absolute;
            background: linear-gradient(135deg, #2196F3, #03A9F4);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.85rem;
            max-width: 250px;
            z-index: 10013;
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
            animation: tooltipAppear 0.3s ease;
        }

        .help-tooltip::after {
            content: '';
            position: absolute;
            border: 8px solid transparent;
        }

        .help-tooltip.top::after {
            bottom: -16px;
            left: 50%;
            transform: translateX(-50%);
            border-top-color: #2196F3;
        }

        .help-tooltip.bottom::after {
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            border-bottom-color: #03A9F4;
        }

        @keyframes tooltipAppear {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .help-highlight {
            position: relative;
        }

        .help-highlight::before {
            content: '?';
            position: absolute;
            top: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            z-index: 1;
        }

        /* Collectible Badges System */
        .badges-collection {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
        }

        .badge-card {
            background: linear-gradient(145deg, #f5f5f5, #e0e0e0);
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .badge-card.unlocked {
            background: linear-gradient(145deg, #E3F2FD, #BBDEFB);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
        }

        .badge-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .badge-card:hover {
            transform: translateY(-3px);
        }

        .badge-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .badge-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: #333;
            margin-bottom: 4px;
        }

        .badge-rarity {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }

        .badge-rarity.common { background: #9E9E9E; color: white; }
        .badge-rarity.rare { background: #2196F3; color: white; }
        .badge-rarity.epic { background: #9C27B0; color: white; }
        .badge-rarity.legendary { background: linear-gradient(135deg, #FFD700, #FF8C00); color: white; }

        /* Session Progress Indicator */
        .session-progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            z-index: 10020;
            transition: width 0.3s ease;
        }

        .session-stats-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            background: white;
            border-radius: 16px;
            padding: 15px 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            z-index: 9996;
            min-width: 200px;
        }

        .session-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .session-stat-item:last-child {
            border-bottom: none;
        }

        /* Focus Timer Mode */
        .focus-timer {
            position: fixed;
            bottom: 100px;
            left: 20px;
            background: linear-gradient(135deg, #FF5722, #E64A19);
            color: white;
            padding: 15px 20px;
            border-radius: 16px;
            z-index: 9997;
            box-shadow: 0 8px 25px rgba(255, 87, 34, 0.3);
            animation: pulseGlow 2s infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 8px 25px rgba(255, 87, 34, 0.3); }
            50% { box-shadow: 0 8px 35px rgba(255, 87, 34, 0.5); }
        }

        .focus-timer-display {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: monospace;
            text-align: center;
        }

        .focus-timer-label {
            font-size: 0.8rem;
            opacity: 0.9;
            text-align: center;
            margin-top: 5px;
        }

        /* Answer History */
        .history-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.15);
            z-index: 10004;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .history-panel.open {
            right: 0;
        }

        .history-header {
            padding: 20px;
            background: linear-gradient(135deg, #9C27B0, #673AB7);
            color: white;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .history-item {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #ddd;
        }

        .history-item.correct {
            border-left-color: #4CAF50;
            background: #E8F5E9;
        }

        .history-item.incorrect {
            border-left-color: #F44336;
            background: #FFEBEE;
        }

        /* Quick Practice Shortcuts */
        .quick-actions-fab {
            position: fixed;
            bottom: 20px;
            right: 100px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 9998;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
            transition: all 0.3s ease;
        }

        .quick-actions-fab:hover {
            transform: scale(1.1);
        }

        .quick-actions-menu {
            position: fixed;
            bottom: 90px;
            right: 85px;
            background: white;
            border-radius: 16px;
            padding: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: none;
        }

        .quick-actions-menu.open {
            display: block;
            animation: fadeInUp 0.3s ease;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 10px;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.2s ease;
        }

        .quick-action-btn:hover {
            background: #f5f5f5;
        }

        /* Welcome Back Message */
        .welcome-banner {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 30px;
            border-radius: 20px;
            z-index: 10015;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
            max-width: 400px;
            text-align: center;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .welcome-banner-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            opacity: 0.7;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Difficulty Indicator */
        .difficulty-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .difficulty-badge.easy { background: #C8E6C9; color: #2E7D32; }
        .difficulty-badge.medium { background: #FFF9C4; color: #F57F17; }
        .difficulty-badge.hard { background: #FFCDD2; color: #C62828; }
        .difficulty-badge.expert { background: #E1BEE7; color: #6A1B9A; }

        .difficulty-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .difficulty-option {
            flex: 1;
            min-width: 80px;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .difficulty-option:hover {
            border-color: #667eea;
        }

        .difficulty-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea10, #764ba210);
        }

        /* Motivational Quotes */
        .quote-display {
            background: linear-gradient(135deg, #E8EAF6, #C5CAE9);
            border-left: 4px solid #3F51B5;
            padding: 15px 20px;
            border-radius: 0 12px 12px 0;
            margin: 15px 0;
            font-style: italic;
            color: #333;
        }

        .quote-author {
            font-style: normal;
            font-weight: 600;
            color: #3F51B5;
            margin-top: 8px;
            font-size: 0.85rem;
        }

        /* Streak Multiplier */
        .streak-multiplier {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #FF5722, #FF9800);
            color: white;
            padding: 12px 18px;
            border-radius: 25px;
            z-index: 9995;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 6px 20px rgba(255, 87, 34, 0.4);
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Quick Topic Selector */
        .topic-quick-select {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .topic-chip {
            padding: 8px 16px;
            border-radius: 20px;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .topic-chip:hover {
            background: #e0e0e0;
        }

        .topic-chip.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }

        .topic-chip.hot {
            animation: hotTopic 1s ease infinite;
        }

        @keyframes hotTopic {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 87, 34, 0.5); }
            50% { box-shadow: 0 0 15px rgba(255, 87, 34, 0.8); }
        }

        /* Comeback Notification */
        .comeback-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #E91E63, #9C27B0);
            color: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            z-index: 10020;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            animation: modalPop 0.5s ease;
        }

        .comeback-gift {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: giftBounce 1s ease infinite;
        }

        @keyframes giftBounce {
            0%, 100% { transform: scale(1) rotate(-5deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        /* Progress Summary Card */
        .progress-summary-card {
            background: linear-gradient(135deg, #00BCD4, #009688);
            color: white;
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
        }

        .progress-summary-stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .progress-summary-stat:last-child {
            border-bottom: none;
        }

        .progress-summary-label {
            opacity: 0.9;
        }

        .progress-summary-value {
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* Seasonal Event Banner */
        .seasonal-banner {
            background: linear-gradient(135deg, var(--seasonal-color-1), var(--seasonal-color-2));
            color: white;
            padding: 15px 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: seasonalPulse 3s ease infinite;
        }

        @keyframes seasonalPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .seasonal-icon {
            font-size: 2rem;
        }

        .seasonal-info {
            flex: 1;
        }

        .seasonal-title {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .seasonal-bonus {
            font-size: 0.85rem;
            opacity: 0.95;
            margin-top: 3px;
        }

        /* Practice Reminder Toast */
        .reminder-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #FF5722, #FF9800);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10016;
            box-shadow: 0 8px 30px rgba(255, 87, 34, 0.4);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Encouragement Banner */
        .encouragement-banner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            padding: 25px 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 10017;
            box-shadow: 0 15px 50px rgba(76, 175, 80, 0.4);
            animation: encouragePop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes encouragePop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Mini-Game Container */
        .mini-game-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            z-index: 10018;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            animation: modalPop 0.4s ease;
        }

        .emoji-slots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .emoji-slot {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            animation: slotSpin 0.3s ease;
        }

        @keyframes slotSpin {
            0% { transform: translateY(-20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* Goal Completion Celebration */
        .goal-complete-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FFD700, #FF8C00);
            color: white;
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            z-index: 10019;
            box-shadow: 0 25px 80px rgba(255, 215, 0, 0.4);
            animation: goalPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes goalPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0); }
        }

        .goal-trophy {
            font-size: 5rem;
            animation: trophyBounce 1s ease infinite;
        }

        @keyframes trophyBounce {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg) scale(1.1); }
        }

        /* Batch 14: Science Facts, Streak Calendar, Flashcards */

        /* Science Fact Card */
        .science-fact-card {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            max-width: 320px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .science-fact-card.show {
            transform: translateX(0);
        }

        .science-fact-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .science-fact-category {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .science-fact-text {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .science-fact-dismiss {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Streak Calendar */
        .streak-calendar-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 400px;
            width: 95%;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            animation: modalPop 0.3s ease;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 15px;
        }

        .calendar-day-header {
            font-size: 0.7rem;
            color: #888;
            text-align: center;
            padding: 5px;
            font-weight: 600;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            background: #f5f5f5;
            transition: all 0.2s ease;
        }

        .calendar-day.active {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            font-weight: 600;
        }

        .calendar-day.today {
            border: 2px solid #2196F3;
        }

        .calendar-day.future {
            background: #fafafa;
            color: #ccc;
        }

        .calendar-day-fire {
            font-size: 0.6rem;
            margin-top: 2px;
        }

        /* Flashcard Mode */
        .flashcard-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 450px;
            z-index: 10006;
            perspective: 1000px;
        }

        .flashcard {
            width: 100%;
            height: 280px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s ease;
            cursor: pointer;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
        }

        .flashcard-front {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
        }

        .flashcard-back {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            transform: rotateY(180deg);
        }

        .flashcard-topic {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .flashcard-question {
            font-size: 1.3rem;
            text-align: center;
            font-weight: 600;
            line-height: 1.4;
        }

        .flashcard-answer {
            font-size: 1.2rem;
            text-align: center;
            line-height: 1.5;
        }

        .flashcard-hint {
            margin-top: 20px;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .flashcard-controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
        }

        .flashcard-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .flashcard-btn:hover {
            transform: translateY(-2px);
        }

        .flashcard-progress {
            text-align: center;
            margin-top: 15px;
            color: white;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* Batch 15: Achievements Timeline, Learning Roadmap, Weekly Challenges */

        /* Achievements Timeline */
        .achievements-timeline-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 500px;
            width: 95%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .timeline-container {
            position: relative;
            padding-left: 30px;
        }

        .timeline-container::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #4CAF50, #8BC34A);
            border-radius: 3px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 20px;
            width: 16px;
            height: 16px;
            background: white;
            border: 3px solid #4CAF50;
            border-radius: 50%;
        }

        .timeline-item.milestone::before {
            background: linear-gradient(135deg, #FFD700, #FF8C00);
            border-color: #FFD700;
            width: 20px;
            height: 20px;
            left: -28px;
        }

        .timeline-date {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 5px;
        }

        .timeline-title {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeline-desc {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        /* Learning Roadmap */
        .roadmap-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 600px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .roadmap-path {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .roadmap-node {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .roadmap-node:hover {
            background: #f0f0f0;
        }

        .roadmap-node.completed {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            border-left: 4px solid #4CAF50;
        }

        .roadmap-node.current {
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            border-left: 4px solid #2196F3;
            box-shadow: 0 5px 20px rgba(33, 150, 243, 0.2);
        }

        .roadmap-node.locked {
            opacity: 0.5;
            filter: grayscale(0.5);
        }

        .roadmap-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .roadmap-info {
            flex: 1;
        }

        .roadmap-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .roadmap-desc {
            font-size: 0.8rem;
            color: #666;
        }

        .roadmap-progress {
            width: 60px;
            text-align: center;
        }

        .roadmap-progress-ring {
            width: 45px;
            height: 45px;
        }

        /* Weekly Challenges */
        .weekly-challenges-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 450px;
            width: 95%;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .weekly-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .weekly-timer {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 10px;
        }

        .challenge-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .challenge-card.completed {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
        }

        .challenge-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .challenge-info {
            flex: 1;
        }

        .challenge-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .challenge-progress-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }

        .challenge-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .challenge-reward {
            font-size: 0.85rem;
            font-weight: 600;
            color: #FF6B6B;
        }

        /* Batch 16: Subject Mastery, Stats Dashboard, Tips */

        /* Subject Mastery Cards */
        .mastery-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 500px;
            width: 95%;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .mastery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .mastery-card {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .mastery-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .mastery-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .mastery-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .mastery-level {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 10px;
        }

        .mastery-ring {
            width: 70px;
            height: 70px;
            margin: 0 auto;
            position: relative;
        }

        .mastery-ring svg {
            transform: rotate(-90deg);
        }

        .mastery-ring-bg {
            fill: none;
            stroke: #e0e0e0;
            stroke-width: 6;
        }

        .mastery-ring-progress {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .mastery-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 0.9rem;
        }

        /* Stats Dashboard */
        .stats-dashboard-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 550px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .stats-chart {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 16px;
        }

        .chart-bar-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .chart-label {
            width: 60px;
            font-size: 0.8rem;
            color: #666;
        }

        .chart-bar-wrapper {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .chart-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .chart-value {
            width: 40px;
            text-align: right;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Tip of the Day */
        .tip-of-day {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 16px;
            padding: 15px 20px;
            max-width: 300px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 998;
            transform: translateY(150%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-left: 4px solid #4CAF50;
        }

        .tip-of-day.show {
            transform: translateY(0);
        }

        .tip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: 600;
            color: #4CAF50;
        }

        .tip-text {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
        }

        .tip-dismiss {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Batch 17: Shortcuts Help, Focus Mode, Quick Nav */

        /* Keyboard Shortcuts Modal */
        .shortcuts-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 500px;
            width: 95%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .shortcut-row:last-child {
            border-bottom: none;
        }

        .shortcut-desc {
            color: #555;
        }

        .shortcut-keys {
            display: flex;
            gap: 5px;
        }

        .key {
            background: linear-gradient(180deg, #f8f9fa, #e9ecef);
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 5px 10px;
            font-family: monospace;
            font-size: 0.85rem;
            box-shadow: 0 2px 0 #ccc;
            min-width: 30px;
            text-align: center;
        }

        /* Focus Mode */
        .focus-mode-active {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9998;
        }

        .focus-mode-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 30px;
            max-width: 700px;
            width: 95%;
            z-index: 9999;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
        }

        .focus-mode-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .focus-timer-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
            font-family: monospace;
        }

        .focus-progress {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .focus-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 1s linear;
        }

        /* Quick Navigation Menu */
        .quick-nav-trigger {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 8px;
            border-radius: 10px 0 0 10px;
            cursor: pointer;
            z-index: 997;
            transition: all 0.3s ease;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .quick-nav-trigger:hover {
            padding-right: 15px;
        }

        .quick-nav-panel {
            position: fixed;
            top: 50%;
            right: -280px;
            transform: translateY(-50%);
            background: white;
            border-radius: 16px 0 0 16px;
            padding: 20px;
            width: 280px;
            max-height: 70vh;
            overflow-y: auto;
            z-index: 998;
            box-shadow: -10px 0 40px rgba(0,0,0,0.15);
            transition: right 0.3s ease;
        }

        .quick-nav-panel.open {
            right: 0;
        }

        .quick-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }

        .quick-nav-item:hover {
            background: #f5f5f5;
        }

        .quick-nav-item.active {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
        }

        .quick-nav-icon {
            font-size: 1.3rem;
        }

        .quick-nav-label {
            font-weight: 500;
            color: #333;
        }

        .quick-nav-section {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        /* Batch 18: Help Center, Theme Customization, Notifications */

        /* Help Center Modal */
        .help-center-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 600px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .faq-item {
            margin-bottom: 15px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #eee;
        }

        .faq-question {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            color: #333;
            transition: background 0.2s ease;
        }

        .faq-question:hover {
            background: #f0f0f0;
        }

        .faq-arrow {
            transition: transform 0.3s ease;
        }

        .faq-item.open .faq-arrow {
            transform: rotate(180deg);
        }

        .faq-answer {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            background: white;
        }

        .faq-item.open .faq-answer {
            padding: 15px;
            max-height: 500px;
        }

        .faq-answer-text {
            color: #666;
            line-height: 1.6;
        }

        /* Theme Customization */
        .theme-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 450px;
            width: 95%;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .theme-option {
            aspect-ratio: 1;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .theme-option:hover {
            transform: scale(1.05);
        }

        .theme-option.selected::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .theme-preview {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .theme-preview-header {
            height: 40%;
        }

        .theme-preview-body {
            flex: 1;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        /* Notification Settings */
        .settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 400px;
            width: 95%;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
        }

        .setting-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .setting-desc {
            font-size: 0.8rem;
            color: #888;
        }

        .toggle-switch {
            width: 50px;
            height: 28px;
            background: #e0e0e0;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.on {
            background: #4CAF50;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle-switch.on::after {
            left: 25px;
        }

        /* Batch 19: Session Summary, Performance Insights, Recommendations */

        /* Session Summary */
        .session-summary-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 450px;
            width: 95%;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .session-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .session-stat-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .session-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }

        .session-stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        /* Performance Insights */
        .insights-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 500px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .insight-card {
            padding: 18px;
            border-radius: 14px;
            margin-bottom: 12px;
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .insight-card.positive {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            border-left: 4px solid #4CAF50;
        }

        .insight-card.suggestion {
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            border-left: 4px solid #2196F3;
        }

        .insight-card.warning {
            background: linear-gradient(135deg, #FFF3E0, #FFE0B2);
            border-left: 4px solid #FF9800;
        }

        .insight-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .insight-content {
            flex: 1;
        }

        .insight-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .insight-text {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
        }

        /* Recommendations */
        .recommendations-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 500px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .recommendation-card {
            display: flex;
            gap: 15px;
            padding: 18px;
            background: #f8f9fa;
            border-radius: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recommendation-card:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }

        .recommendation-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .recommendation-info {
            flex: 1;
        }

        .recommendation-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .recommendation-reason {
            font-size: 0.85rem;
            color: #666;
        }

        .recommendation-priority {
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .priority-high {
            background: #FFEBEE;
            color: #D32F2F;
        }

        .priority-medium {
            background: #FFF3E0;
            color: #EF6C00;
        }

        .priority-low {
            background: #E8F5E9;
            color: #388E3C;
        }

        /* Batch 20: Accessibility, Break Reminders, Question Review */

        /* Accessibility Settings */
        .accessibility-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 450px;
            width: 95%;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .font-size-preview {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            transition: font-size 0.3s ease;
        }

        .font-size-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .font-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.4);
        }

        .contrast-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 10px;
        }

        .contrast-option:hover {
            background: #f5f5f5;
        }

        .contrast-option.selected {
            background: #E8F5E9;
            border: 2px solid #4CAF50;
        }

        .contrast-preview {
            width: 50px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Break Reminder */
        .break-reminder {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
            z-index: 10020;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .break-timer {
            font-size: 4rem;
            font-weight: 700;
            font-family: monospace;
            margin: 30px 0;
        }

        .break-activity {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .break-activity-item {
            background: rgba(255,255,255,0.2);
            padding: 15px 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .break-activity-item:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        /* Question Review */
        .review-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 550px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 10006;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .review-question {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .review-question:hover {
            transform: translateX(5px);
        }

        .review-question.correct {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            border-left: 4px solid #4CAF50;
        }

        .review-question.incorrect {
            background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
            border-left: 4px solid #F44336;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .review-status {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .review-text {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
        }

        /* High contrast mode styles */
        body.high-contrast {
            background: #000 !important;
            color: #fff !important;
        }

        body.high-contrast .main-content,
        body.high-contrast .sidebar {
            background: #000 !important;
            color: #fff !important;
        }

        body.high-contrast input,
        body.high-contrast textarea,
        body.high-contrast button {
            border: 2px solid #fff !important;
        }

        /* ========== BATCH 21: Social Sharing, Leaderboard, Study Music ========== */

        /* Social Sharing Modal */
        .social-share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .social-share-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.3s ease;
        }

        .share-achievement-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .share-achievement-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        .share-badge {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .share-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .share-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .share-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .share-btn.twitter {
            background: #1DA1F2;
            color: white;
        }

        .share-btn.facebook {
            background: #4267B2;
            color: white;
        }

        .share-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .share-btn.copy-link {
            background: #6c757d;
            color: white;
        }

        /* Leaderboard Panel */
        .leaderboard-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 380px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 30px rgba(0,0,0,0.2);
            z-index: 9999;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }

        .leaderboard-panel.open {
            right: 0;
        }

        .leaderboard-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            text-align: center;
            position: sticky;
            top: 0;
        }

        .leaderboard-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .leaderboard-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .leaderboard-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }

        .leaderboard-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .leaderboard-tab.active {
            color: #f5576c;
            border-bottom: 3px solid #f5576c;
        }

        .leaderboard-list {
            padding: 15px;
        }

        .leaderboard-entry {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .leaderboard-entry:hover {
            background: #e9ecef;
            transform: translateX(-5px);
        }

        .leaderboard-entry.current-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .leaderboard-rank {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            margin-right: 15px;
        }

        .leaderboard-rank.gold {
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            border-radius: 50%;
        }

        .leaderboard-rank.silver {
            background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%);
            color: white;
            border-radius: 50%;
        }

        .leaderboard-rank.bronze {
            background: linear-gradient(135deg, #cd7f32 0%, #8b4513 100%);
            color: white;
            border-radius: 50%;
        }

        .leaderboard-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 12px;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .leaderboard-xp {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .leaderboard-badge {
            font-size: 1.5rem;
        }

        /* Study Music Player */
        .music-player {
            position: fixed;
            bottom: 100px;
            left: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 9000;
            overflow: hidden;
            width: 320px;
            display: none;
        }

        .music-player.open {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .music-header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .music-header h3 {
            margin: 0;
            font-size: 1rem;
        }

        .music-close {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
        }

        .music-body {
            padding: 20px;
        }

        .now-playing {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .now-playing-icon {
            font-size: 2rem;
            margin-bottom: 5px;
            animation: pulse 2s infinite;
        }

        .now-playing-title {
            font-weight: 600;
            color: #333;
        }

        .music-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .music-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .music-control-btn.play-pause {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }

        .music-control-btn:hover {
            transform: scale(1.1);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .volume-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: #e0e0e0;
            border-radius: 3px;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #11998e;
            border-radius: 50%;
            cursor: pointer;
        }

        .playlist-section h4 {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 5px;
        }

        .playlist-item:hover {
            background: #f0f0f0;
        }

        .playlist-item.playing {
            background: #e8f5e9;
            border-left: 3px solid #11998e;
        }

        .playlist-item-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .playlist-item-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Floating Buttons for new features */
        .floating-share-btn {
            position: fixed;
            bottom: 340px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-share-btn:hover {
            transform: scale(1.1);
        }

        .floating-leaderboard-btn {
            position: fixed;
            bottom: 400px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-leaderboard-btn:hover {
            transform: scale(1.1);
        }

        .floating-music-btn {
            position: fixed;
            bottom: 460px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-music-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 22: Study Notes, Bookmarks, Progress Export ========== */

        /* Study Notes Panel */
        .notes-panel {
            position: fixed;
            left: -420px;
            top: 0;
            width: 400px;
            height: 100%;
            background: white;
            box-shadow: 5px 0 30px rgba(0,0,0,0.2);
            z-index: 9999;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .notes-panel.open {
            left: 0;
        }

        .notes-header {
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notes-header h2 {
            margin: 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notes-close {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .notes-toolbar {
            display: flex;
            gap: 5px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .notes-toolbar-btn {
            padding: 8px 12px;
            border: none;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .notes-toolbar-btn:hover {
            background: #e0e0e0;
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .note-card {
            background: #fffde7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #f5af19;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .note-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .note-card.selected {
            background: #fff9c4;
            border-left-color: #f12711;
        }

        .note-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
            color: #333;
        }

        .note-preview {
            font-size: 0.85rem;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .note-date {
            font-size: 0.75rem;
            color: #999;
            margin-top: 5px;
        }

        .note-editor {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            background: #fafafa;
        }

        .note-editor input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .note-editor textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: none;
            font-family: inherit;
        }

        .note-editor-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .note-save-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .note-delete-btn {
            padding: 10px 15px;
            border: none;
            background: #ff5252;
            color: white;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Bookmarks Panel */
        .bookmarks-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .bookmarks-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease;
        }

        .bookmarks-header {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bookmarks-header h2 {
            margin: 0;
        }

        .bookmarks-list {
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .bookmark-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .bookmark-item:hover {
            background: #e9ecef;
        }

        .bookmark-icon {
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .bookmark-info {
            flex: 1;
        }

        .bookmark-title {
            font-weight: 600;
            color: #333;
        }

        .bookmark-topic {
            font-size: 0.85rem;
            color: #666;
        }

        .bookmark-actions {
            display: flex;
            gap: 5px;
        }

        .bookmark-action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .bookmark-goto {
            background: #4CAF50;
            color: white;
        }

        .bookmark-remove {
            background: #ff5252;
            color: white;
        }

        /* Progress Export */
        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .export-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .export-preview {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: left;
        }

        .export-stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .export-stat:last-child {
            border-bottom: none;
        }

        .export-stat-label {
            color: #666;
        }

        .export-stat-value {
            font-weight: 700;
            color: #333;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .export-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
        }

        .export-btn.pdf {
            background: linear-gradient(135deg, #e53935 0%, #d32f2f 100%);
            color: white;
        }

        .export-btn.email {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
        }

        .export-btn.print {
            background: linear-gradient(135deg, #43a047 0%, #388e3c 100%);
            color: white;
        }

        /* Floating buttons for Batch 22 */
        .floating-notes-btn {
            position: fixed;
            bottom: 520px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(245, 175, 25, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-notes-btn:hover {
            transform: scale(1.1);
        }

        .floating-bookmarks-btn {
            position: fixed;
            bottom: 580px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(238, 9, 121, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-bookmarks-btn:hover {
            transform: scale(1.1);
        }

        .floating-export-btn {
            position: fixed;
            bottom: 640px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(33, 150, 243, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-export-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 23: Quiz Timer, Power-ups, Daily Login ========== */

        /* Quiz Timer */
        .quiz-timer {
            position: fixed;
            top: 100px;
            right: 20px;
            background: white;
            border-radius: 20px;
            padding: 15px 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 9000;
            display: none;
            text-align: center;
        }

        .quiz-timer.active {
            display: block;
            animation: timerPulse 1s ease;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .timer-display {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .timer-display.warning {
            color: #ff9800;
            animation: timerWarning 0.5s infinite;
        }

        .timer-display.danger {
            color: #f44336;
            animation: timerWarning 0.3s infinite;
        }

        @keyframes timerWarning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .timer-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .timer-progress {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .timer-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 3px;
            transition: width 1s linear;
        }

        .timer-progress-bar.warning {
            background: linear-gradient(90deg, #ff9800, #ffc107);
        }

        .timer-progress-bar.danger {
            background: linear-gradient(90deg, #f44336, #ff5722);
        }

        /* Power-ups */
        .powerups-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 30px;
            padding: 10px 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 9000;
            display: none;
            gap: 15px;
        }

        .powerups-bar.active {
            display: flex;
        }

        .powerup-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .powerup-item:hover {
            transform: translateY(-5px);
        }

        .powerup-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .powerup-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .powerup-icon.hint {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .powerup-icon.freeze {
            background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
        }

        .powerup-icon.double {
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
        }

        .powerup-icon.skip {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .powerup-icon.shield {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        }

        .powerup-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f44336;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .powerup-name {
            font-size: 0.7rem;
            margin-top: 5px;
            color: #666;
        }

        .powerup-tooltip {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .powerup-item:hover .powerup-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Daily Login Rewards */
        .login-rewards-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .login-rewards-content {
            background: white;
            border-radius: 25px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: rewardBounce 0.5s ease;
        }

        @keyframes rewardBounce {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .login-rewards-header {
            margin-bottom: 20px;
        }

        .login-rewards-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }

        .login-streak-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            margin-top: 10px;
            font-weight: 600;
        }

        .daily-rewards-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin: 20px 0;
        }

        .daily-reward-day {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 10px 5px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .daily-reward-day.claimed {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
        }

        .daily-reward-day.today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .daily-reward-day.locked {
            opacity: 0.5;
        }

        .reward-day-num {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .reward-day-icon {
            font-size: 1.3rem;
            margin: 5px 0;
        }

        .reward-day-xp {
            font-size: 0.7rem;
            font-weight: 600;
        }

        .claim-reward-btn {
            margin-top: 20px;
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .claim-reward-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .claim-reward-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Floating buttons for Batch 23 */
        .floating-timer-btn {
            position: fixed;
            bottom: 700px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-timer-btn:hover {
            transform: scale(1.1);
        }

        .floating-powerups-btn {
            position: fixed;
            bottom: 760px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(156, 39, 176, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-powerups-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 24: Learning Quests, Virtual Pet, Science Lab ========== */

        /* Learning Quests */
        .quests-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .quests-content {
            background: white;
            border-radius: 25px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
        }

        .quests-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .quests-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .quests-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }

        .quest-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
        }

        .quest-tab.active {
            color: #ee5a24;
            border-bottom: 3px solid #ee5a24;
        }

        .quests-list {
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .quest-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .quest-card.active {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ee5a24;
        }

        .quest-card.completed {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 4px solid #4CAF50;
        }

        .quest-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 2rem;
            opacity: 0.3;
        }

        .quest-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .quest-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .quest-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .quest-progress-bar {
            flex: 1;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }

        .quest-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b 0%, #ee5a24 100%);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .quest-progress-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
        }

        .quest-reward {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #fff;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #ee5a24;
        }

        /* Virtual Pet */
        .virtual-pet {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9000;
            display: none;
        }

        .virtual-pet.active {
            display: block;
        }

        .pet-container {
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            text-align: center;
            width: 150px;
        }

        .pet-avatar {
            font-size: 4rem;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .pet-avatar:hover {
            transform: scale(1.1) rotate(10deg);
        }

        .pet-avatar.happy {
            animation: petHappy 0.5s ease;
        }

        .pet-avatar.sad {
            animation: petSad 0.5s ease;
        }

        @keyframes petHappy {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.2) rotate(-10deg); }
            50% { transform: scale(1.3) rotate(10deg); }
            75% { transform: scale(1.2) rotate(-5deg); }
        }

        @keyframes petSad {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.9) translateY(5px); }
        }

        .pet-name {
            font-weight: 600;
            color: #333;
            margin: 5px 0;
        }

        .pet-mood {
            font-size: 0.8rem;
            color: #666;
        }

        .pet-stats {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .pet-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .pet-stat-icon {
            font-size: 1.2rem;
        }

        .pet-stat-bar {
            width: 30px;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 3px;
            overflow: hidden;
        }

        .pet-stat-fill {
            height: 100%;
            background: #4CAF50;
            border-radius: 3px;
        }

        .pet-message {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 15px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            white-space: nowrap;
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .pet-message.show {
            opacity: 1;
            visibility: visible;
        }

        .pet-message::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: white;
        }

        /* Science Lab */
        .lab-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .lab-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 25px;
            width: 90%;
            max-width: 700px;
            padding: 30px;
            color: white;
        }

        .lab-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .lab-header h2 {
            margin: 0;
            color: #00d4ff;
            font-size: 1.5rem;
        }

        .lab-experiment {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .experiment-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #00d4ff;
        }

        .experiment-desc {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 20px;
        }

        .experiment-animation {
            height: 200px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            font-size: 4rem;
            position: relative;
            overflow: hidden;
        }

        .beaker {
            font-size: 5rem;
            animation: beakerBubble 2s infinite;
        }

        @keyframes beakerBubble {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .bubbles {
            position: absolute;
            bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .bubble {
            width: 15px;
            height: 15px;
            background: rgba(0, 212, 255, 0.5);
            border-radius: 50%;
            animation: bubbleRise 2s infinite;
        }

        .bubble:nth-child(2) { animation-delay: 0.3s; }
        .bubble:nth-child(3) { animation-delay: 0.6s; }

        @keyframes bubbleRise {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-150px); opacity: 0; }
        }

        .experiment-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .experiment-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .experiment-btn.start {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: white;
        }

        .experiment-btn.reset {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .experiment-result {
            text-align: center;
            padding: 20px;
            background: rgba(0, 212, 255, 0.2);
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .experiment-result.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        /* Floating buttons for Batch 24 */
        .floating-quests-btn {
            position: fixed;
            bottom: 820px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(238, 90, 36, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-quests-btn:hover {
            transform: scale(1.1);
        }

        .floating-pet-btn {
            position: fixed;
            bottom: 880px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: #333;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 154, 158, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-pet-btn:hover {
            transform: scale(1.1);
        }

        .floating-lab-btn {
            position: fixed;
            bottom: 940px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #00d4ff;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-lab-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 25: Badges Gallery, Custom Avatar, Sound Effects ========== */

        /* Badges Gallery */
        .badges-gallery-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .badges-gallery-content {
            background: linear-gradient(135deg, #2c3e50 0%, #1a1a2e 100%);
            border-radius: 25px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            color: white;
        }

        .badges-gallery-header {
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            padding: 25px;
            text-align: center;
        }

        .badges-gallery-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .badges-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
        }

        .badge-stat {
            text-align: center;
        }

        .badge-stat-num {
            font-size: 2rem;
            font-weight: 700;
        }

        .badge-stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 25px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .badge-item {
            text-align: center;
            padding: 15px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .badge-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-5px);
        }

        .badge-item.locked {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .badge-item.earned {
            background: linear-gradient(135deg, rgba(245, 175, 25, 0.3) 0%, rgba(241, 39, 17, 0.3) 100%);
            border: 2px solid #f5af19;
        }

        .badge-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .badge-name {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-requirement {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Custom Avatar */
        .avatar-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .avatar-content {
            background: white;
            border-radius: 25px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            text-align: center;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            border: 4px solid #f5af19;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .avatar-section {
            margin: 20px 0;
            text-align: left;
        }

        .avatar-section h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .avatar-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .avatar-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .avatar-option:hover {
            transform: scale(1.15);
            background: #e0e0e0;
        }

        .avatar-option.selected {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .color-option {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .color-option:hover {
            transform: scale(1.2);
        }

        .color-option.selected {
            border-color: #333;
        }

        .avatar-name-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            text-align: center;
            margin-top: 10px;
        }

        .avatar-save-btn {
            margin-top: 20px;
            padding: 12px 40px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }

        /* Sound Effects */
        .sound-panel {
            position: fixed;
            bottom: 80px;
            right: 80px;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 9000;
            width: 280px;
            display: none;
        }

        .sound-panel.open {
            display: block;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sound-panel h3 {
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sound-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .sound-option:last-child {
            border-bottom: none;
        }

        .sound-label {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sound-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: #e0e0e0;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .sound-toggle.on {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }

        .sound-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .sound-toggle.on::after {
            left: 27px;
        }

        .volume-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 0;
        }

        .sound-volume-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: #e0e0e0;
            border-radius: 3px;
        }

        .sound-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            cursor: pointer;
        }

        .sound-preview-btn {
            padding: 8px 15px;
            border: none;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .sound-preview-btn:hover {
            background: #e0e0e0;
        }

        /* Floating buttons for Batch 25 */
        .floating-badges-btn {
            position: fixed;
            bottom: 1000px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(245, 175, 25, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-badges-btn:hover {
            transform: scale(1.1);
        }

        .floating-avatar-btn {
            position: fixed;
            bottom: 1060px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-avatar-btn:hover {
            transform: scale(1.1);
        }

        .floating-sound-btn {
            position: fixed;
            bottom: 1120px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-sound-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 26: Confetti, Activity Heatmap, Parent Mode ========== */

        /* Confetti Canvas */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100000;
        }

        /* Activity Heatmap */
        .heatmap-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .heatmap-content {
            background: white;
            border-radius: 25px;
            width: 90%;
            max-width: 800px;
            padding: 30px;
        }

        .heatmap-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .heatmap-header h2 {
            margin: 0;
            color: #333;
        }

        .heatmap-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: #666;
        }

        .legend-box {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 20px;
        }

        .heatmap-day-label {
            text-align: center;
            font-size: 0.7rem;
            color: #999;
            padding: 5px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            background: #ebedf0;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .heatmap-cell:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .heatmap-cell.level-1 { background: #9be9a8; }
        .heatmap-cell.level-2 { background: #40c463; }
        .heatmap-cell.level-3 { background: #30a14e; }
        .heatmap-cell.level-4 { background: #216e39; }

        .heatmap-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            margin-bottom: 5px;
        }

        .heatmap-cell:hover .heatmap-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .heatmap-summary {
            display: flex;
            justify-content: center;
            gap: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .heatmap-stat {
            text-align: center;
        }

        .heatmap-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
        }

        .heatmap-stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        /* Parent Mode */
        .parent-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .parent-content {
            background: white;
            border-radius: 25px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .parent-header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 25px;
            text-align: center;
            border-radius: 25px 25px 0 0;
        }

        .parent-header h2 {
            margin: 0;
        }

        .parent-login {
            padding: 30px;
            text-align: center;
        }

        .parent-pin-input {
            width: 200px;
            padding: 15px;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            letter-spacing: 10px;
            margin-bottom: 20px;
        }

        .parent-pin-btn {
            padding: 12px 40px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .parent-dashboard {
            padding: 25px;
            display: none;
        }

        .parent-dashboard.active {
            display: block;
        }

        .dashboard-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .dashboard-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .dashboard-stat {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .dashboard-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1976d2;
        }

        .dashboard-stat-label {
            font-size: 0.8rem;
            color: #666;
        }

        .progress-chart {
            height: 150px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(180deg, #1976d2 0%, #42a5f5 100%);
            border-radius: 5px 5px 0 0;
            min-height: 10px;
            position: relative;
        }

        .chart-bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: #666;
        }

        .parent-settings {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .parent-setting {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        /* Floating buttons for Batch 26 */
        .floating-heatmap-btn {
            position: fixed;
            bottom: 1180px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #30a14e 0%, #216e39 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(48, 161, 78, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-heatmap-btn:hover {
            transform: scale(1.1);
        }

        .floating-parent-btn {
            position: fixed;
            bottom: 1240px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(25, 118, 210, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-parent-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 27: Topic Explorer, Daily Challenge, Skill Tree ========== */

        /* Topic Explorer */
        .topic-explorer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .topic-explorer-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%);
            border-radius: 25px;
            width: 90%;
            max-width: 900px;
            padding: 30px;
            color: white;
        }

        .topic-explorer-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .topic-explorer-header h2 {
            color: #00d4ff;
            margin: 0;
        }

        .topic-map {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            padding: 20px;
        }

        .topic-node {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            border: 3px solid transparent;
        }

        .topic-node:hover {
            transform: scale(1.15);
            z-index: 10;
        }

        .topic-node.mastered {
            border-color: #4CAF50;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
        }

        .topic-node-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .topic-node-name {
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
        }

        .topic-node-progress {
            position: absolute;
            bottom: -8px;
            font-size: 0.7rem;
            background: rgba(0,0,0,0.7);
            padding: 3px 10px;
            border-radius: 10px;
        }

        .topic-connection {
            position: absolute;
            width: 50px;
            height: 3px;
            background: rgba(255,255,255,0.2);
        }

        /* Daily Challenge */
        .daily-challenge-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .daily-challenge-content {
            background: white;
            border-radius: 25px;
            width: 90%;
            max-width: 550px;
            overflow: hidden;
        }

        .challenge-header {
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }

        .challenge-header h2 {
            margin: 0;
        }

        .challenge-timer {
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .challenge-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .challenge-body {
            padding: 25px;
        }

        .challenge-question {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .challenge-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .challenge-option {
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .challenge-option:hover {
            border-color: #f5af19;
            background: #fff8e1;
        }

        .challenge-option.selected {
            border-color: #f5af19;
            background: #fff8e1;
        }

        .challenge-option.correct {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .challenge-option.incorrect {
            border-color: #f44336;
            background: #ffebee;
        }

        .challenge-option-letter {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .challenge-reward {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-top: 20px;
        }

        .challenge-reward-icon {
            font-size: 2.5rem;
        }

        .challenge-reward-text {
            font-weight: 600;
            color: #f12711;
            margin-top: 5px;
        }

        /* Skill Tree */
        .skill-tree-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .skill-tree-content {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            border-radius: 25px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 30px;
            color: white;
        }

        .skill-tree-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .skill-tree-header h2 {
            color: #00d4ff;
            margin: 0;
        }

        .skill-tree-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        .skill-tier {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .skill-node {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid rgba(255,255,255,0.2);
            position: relative;
        }

        .skill-node:hover {
            transform: scale(1.1);
            background: rgba(255,255,255,0.2);
        }

        .skill-node.unlocked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .skill-node.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .skill-node-icon {
            font-size: 1.8rem;
        }

        .skill-node-name {
            font-size: 0.65rem;
            margin-top: 3px;
            text-align: center;
        }

        .skill-connection-line {
            width: 3px;
            height: 30px;
            background: linear-gradient(180deg, #00d4ff 0%, rgba(0,212,255,0.3) 100%);
            margin: 0 auto;
        }

        .skill-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: #333;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            margin-bottom: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .skill-node:hover .skill-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Floating buttons for Batch 27 */
        .floating-explore-btn {
            position: fixed;
            bottom: 1300px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-explore-btn:hover {
            transform: scale(1.1);
        }

        .floating-challenge-btn {
            position: fixed;
            bottom: 1360px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(245, 175, 25, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-challenge-btn:hover {
            transform: scale(1.1);
        }

        .floating-skilltree-btn {
            position: fixed;
            bottom: 1420px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-skilltree-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 28: Achievement Popups, Bonus Events, Milestones ========== */

        /* Achievement Popup */
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            z-index: 100001;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .achievement-popup.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .achievement-popup-glow {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, transparent 70%);
            animation: glowPulse 2s infinite;
            z-index: -1;
        }

        @keyframes glowPulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        .achievement-popup-icon {
            font-size: 5rem;
            animation: achievementBounce 0.6s ease;
        }

        @keyframes achievementBounce {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.3) rotate(10deg); }
            70% { transform: scale(0.9) rotate(-5deg); }
            100% { transform: scale(1) rotate(0); }
        }

        .achievement-popup-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin: 15px 0 5px;
        }

        .achievement-popup-subtitle {
            color: #666;
            margin-bottom: 15px;
        }

        .achievement-popup-xp {
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            padding: 8px 25px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
        }

        .achievement-popup-close {
            margin-top: 20px;
            padding: 10px 40px;
            border: none;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Bonus Event Banner */
        .bonus-event-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, #f5af19, #f12711, #ee0979, #f5af19);
            background-size: 300% 100%;
            animation: bonusGradient 3s ease infinite;
            color: white;
            padding: 12px 20px;
            text-align: center;
            z-index: 99998;
            display: none;
        }

        .bonus-event-banner.active {
            display: block;
        }

        @keyframes bonusGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .bonus-event-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .bonus-event-icon {
            font-size: 1.5rem;
            animation: bonusPulse 1s infinite;
        }

        @keyframes bonusPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .bonus-event-text {
            font-weight: 600;
        }

        .bonus-event-timer {
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 15px;
            font-family: monospace;
        }

        .bonus-event-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 15px;
        }

        /* Learning Milestones */
        .milestone-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .milestone-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 25px;
            width: 90%;
            max-width: 600px;
            padding: 40px;
            color: white;
            text-align: center;
        }

        .milestone-badge {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            box-shadow: 0 10px 40px rgba(245, 175, 25, 0.4);
            animation: milestonePop 0.6s ease;
        }

        @keyframes milestonePop {
            0% { transform: scale(0); }
            60% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .milestone-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #f5af19, #f12711);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .milestone-description {
            color: #aaa;
            margin-bottom: 20px;
        }

        .milestone-rewards {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .milestone-reward {
            background: rgba(255,255,255,0.1);
            padding: 15px 25px;
            border-radius: 15px;
        }

        .milestone-reward-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .milestone-reward-value {
            font-weight: 600;
        }

        .milestone-progress-container {
            margin: 30px 0;
        }

        .milestone-progress-bar {
            height: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .milestone-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f5af19 0%, #f12711 100%);
            border-radius: 10px;
            transition: width 1s ease;
        }

        .milestone-progress-text {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #aaa;
        }

        /* Floating buttons for Batch 28 */
        .floating-milestone-btn {
            position: fixed;
            bottom: 1480px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(245, 175, 25, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-milestone-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 29: Study Streaks Calendar, Flash Cards, Focus Mode ========== */

        /* Study Streaks Calendar */
        .streaks-calendar-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .streaks-calendar-content {
            background: white;
            border-radius: 25px;
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .streaks-calendar-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .streaks-calendar-header h2 {
            margin: 0;
            color: #333;
        }

        .current-streak-display {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }

        .streak-stat {
            text-align: center;
            padding: 15px 25px;
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            border-radius: 15px;
            color: white;
        }

        .streak-stat-value {
            font-size: 2rem;
            font-weight: 700;
            display: block;
        }

        .streak-stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 20px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: #666;
            font-size: 0.75rem;
            padding: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: #f5f5f5;
            font-size: 0.85rem;
            color: #666;
            transition: all 0.3s ease;
        }

        .calendar-day.studied {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
            font-weight: 600;
        }

        .calendar-day.today {
            border: 2px solid #f12711;
            font-weight: 700;
        }

        .calendar-day.empty {
            background: transparent;
        }

        .streak-fire-animation {
            animation: fireFlicker 0.5s ease infinite alternate;
        }

        @keyframes fireFlicker {
            0% { transform: scale(1); filter: brightness(1); }
            100% { transform: scale(1.1); filter: brightness(1.2); }
        }

        /* Flash Cards System */
        .flashcards-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .flashcards-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 25px;
            width: 95%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            color: white;
        }

        .flashcard-deck-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .flashcard-deck-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .flashcard-deck-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .flashcard-container {
            perspective: 1000px;
            margin: 30px 0;
        }

        .flashcard {
            width: 100%;
            height: 250px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }

        .flashcard-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .flashcard-back {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            transform: rotateY(180deg);
        }

        .flashcard-question {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .flashcard-hint {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .flashcard-answer {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .flashcard-nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .flashcard-nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .flashcard-nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .flashcard-progress {
            text-align: center;
            margin-top: 15px;
            color: #aaa;
        }

        .flashcard-create-btn {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 15px;
            background: transparent;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .flashcard-create-btn:hover {
            border-color: rgba(255,255,255,0.6);
            background: rgba(255,255,255,0.1);
        }

        /* Focus Mode */
        .focus-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100000;
        }

        .focus-mode-overlay.active {
            display: flex;
        }

        .focus-timer-display {
            font-size: 6rem;
            font-weight: 200;
            color: white;
            font-family: 'Courier New', monospace;
            margin-bottom: 30px;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
        }

        .focus-timer-label {
            color: #aaa;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .focus-session-type {
            display: flex;
            gap: 15px;
            margin-bottom: 40px;
        }

        .focus-type-btn {
            padding: 12px 30px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 30px;
            background: transparent;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .focus-type-btn.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.3);
        }

        .focus-controls {
            display: flex;
            gap: 20px;
        }

        .focus-control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .focus-start-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
        }

        .focus-pause-btn {
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
        }

        .focus-stop-btn {
            background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
            color: white;
        }

        .focus-exit-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
        }

        .focus-stats {
            position: absolute;
            bottom: 30px;
            display: flex;
            gap: 40px;
        }

        .focus-stat-item {
            text-align: center;
            color: white;
        }

        .focus-stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: #667eea;
        }

        .focus-stat-label {
            font-size: 0.85rem;
            color: #aaa;
        }

        .focus-motivation {
            margin-top: 30px;
            padding: 20px 40px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            border-left: 4px solid #667eea;
        }

        .focus-motivation-text {
            color: #ddd;
            font-style: italic;
            font-size: 1.1rem;
        }

        .focus-motivation-author {
            color: #888;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* Floating buttons for Batch 29 */
        .floating-streaks-btn {
            position: fixed;
            bottom: 1540px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-streaks-btn:hover {
            transform: scale(1.1);
        }

        .floating-flashcards-btn {
            position: fixed;
            bottom: 1600px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-flashcards-btn:hover {
            transform: scale(1.1);
        }

        .floating-focus-btn {
            position: fixed;
            bottom: 1660px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            border: 2px solid #667eea;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-focus-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 30: Science Dictionary, Quiz Generator, Progress Charts ========== */

        /* Science Dictionary */
        .dictionary-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .dictionary-content {
            background: white;
            border-radius: 25px;
            width: 95%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .dictionary-search {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 30px;
            font-size: 1rem;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .dictionary-search:focus {
            border-color: #667eea;
        }

        .dictionary-categories {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .dictionary-category-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .dictionary-category-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .dictionary-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .dictionary-term {
            padding: 15px;
            border-radius: 15px;
            background: #f8f9fa;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dictionary-term:hover {
            background: #e8f4f8;
            transform: translateX(5px);
        }

        .dictionary-term-word {
            font-weight: 700;
            color: #333;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dictionary-term-category {
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 10px;
            background: #667eea;
            color: white;
        }

        .dictionary-term-definition {
            color: #666;
            margin-top: 8px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Quiz Generator */
        .quiz-generator-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .quiz-generator-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 25px;
            width: 95%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            color: white;
        }

        .quiz-setup {
            text-align: center;
        }

        .quiz-topic-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 25px 0;
        }

        .quiz-topic-card {
            padding: 20px;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .quiz-topic-card:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .quiz-topic-card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: scale(1.05);
        }

        .quiz-topic-icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 8px;
        }

        .quiz-settings {
            margin: 25px 0;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
        }

        .quiz-setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .quiz-setting-label {
            color: #aaa;
        }

        .quiz-setting-select {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
        }

        .quiz-start-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-start-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(17, 153, 142, 0.4);
        }

        .quiz-question-container {
            display: none;
        }

        .quiz-progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .quiz-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #11998e, #38ef7d);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .quiz-question-text {
            font-size: 1.3rem;
            margin-bottom: 25px;
            text-align: center;
            line-height: 1.6;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quiz-option {
            padding: 18px 25px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            background: rgba(255,255,255,0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .quiz-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .quiz-option.correct {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.3);
        }

        .quiz-option.incorrect {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.3);
        }

        .quiz-option-letter {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .quiz-results {
            display: none;
            text-align: center;
        }

        .quiz-score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0 auto 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .quiz-score-value {
            font-size: 3rem;
            font-weight: 700;
        }

        .quiz-score-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Progress Charts */
        .charts-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .charts-content {
            background: white;
            border-radius: 25px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .charts-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .chart-tab {
            padding: 10px 25px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .chart-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .chart-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            height: 200px;
            padding: 20px 0;
        }

        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .bar {
            width: 100%;
            max-width: 50px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px 8px 0 0;
            transition: height 0.5s ease;
            min-height: 5px;
        }

        .bar-label {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #666;
            text-align: center;
        }

        .bar-value {
            font-size: 0.75rem;
            color: #333;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            text-align: center;
        }

        .stat-card-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-card-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Floating buttons for Batch 30 */
        .floating-dictionary-btn {
            position: fixed;
            bottom: 1720px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-dictionary-btn:hover {
            transform: scale(1.1);
        }

        .floating-quiz-btn {
            position: fixed;
            bottom: 1780px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(245, 175, 25, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-quiz-btn:hover {
            transform: scale(1.1);
        }

        .floating-charts-btn {
            position: fixed;
            bottom: 1840px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(238, 9, 121, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-charts-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 31: Daily Science Facts, Study Goals, Wrong Answer Review ========== */

        /* Daily Science Fact */
        .science-fact-banner {
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 350px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 20px;
            color: white;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
            z-index: 998;
            display: none;
            animation: slideInLeft 0.5s ease;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .science-fact-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .science-fact-icon {
            font-size: 1.5rem;
        }

        .science-fact-title {
            font-weight: 700;
            font-size: 1rem;
        }

        .science-fact-text {
            font-size: 0.9rem;
            line-height: 1.5;
            opacity: 0.95;
        }

        .science-fact-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.7;
        }

        .science-fact-close:hover {
            opacity: 1;
        }

        .science-fact-category {
            display: inline-block;
            padding: 3px 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            font-size: 0.75rem;
            margin-top: 10px;
        }

        /* Study Goals */
        .goals-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .goals-content {
            background: white;
            border-radius: 25px;
            width: 95%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .goals-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .goals-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .goal-summary-card {
            text-align: center;
            padding: 15px;
            border-radius: 15px;
            background: #f8f9fa;
        }

        .goal-summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #667eea;
        }

        .goal-summary-label {
            font-size: 0.8rem;
            color: #666;
        }

        .goals-list {
            margin-bottom: 25px;
        }

        .goal-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .goal-item.completed {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(139, 195, 74, 0.1) 100%);
            border: 2px solid #4CAF50;
        }

        .goal-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .goal-item-title {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .goal-item-reward {
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .goal-progress-container {
            margin-bottom: 8px;
        }

        .goal-progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }

        .goal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .goal-progress-text {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        .add-goal-btn {
            width: 100%;
            padding: 15px;
            border: 2px dashed #ccc;
            border-radius: 15px;
            background: transparent;
            color: #666;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-goal-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        /* Wrong Answer Review */
        .review-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .review-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 25px;
            width: 95%;
            max-width: 650px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            color: white;
        }

        .review-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .review-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .review-stat {
            text-align: center;
            padding: 15px 25px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
        }

        .review-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .review-stat-label {
            font-size: 0.85rem;
            color: #aaa;
        }

        .review-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .review-item {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #f44336;
        }

        .review-item.mastered {
            border-left-color: #4CAF50;
            opacity: 0.6;
        }

        .review-question {
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 1.05rem;
        }

        .review-answer-row {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }

        .review-your-answer {
            padding: 8px 15px;
            background: rgba(244, 67, 54, 0.3);
            border-radius: 10px;
            flex: 1;
        }

        .review-correct-answer {
            padding: 8px 15px;
            background: rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            flex: 1;
        }

        .review-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .review-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .review-practice-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .review-mastered-btn {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .review-empty {
            text-align: center;
            padding: 50px;
            color: #aaa;
        }

        .review-empty-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        /* Floating buttons for Batch 31 */
        .floating-facts-btn {
            position: fixed;
            bottom: 1900px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-facts-btn:hover {
            transform: scale(1.1);
        }

        .floating-goals-btn {
            position: fixed;
            bottom: 1960px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-goals-btn:hover {
            transform: scale(1.1);
        }

        .floating-review-btn {
            position: fixed;
            bottom: 2020px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-review-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 32: Science Experiments, Learning Pathways, Quick Start Tutorial ========== */

        /* Science Experiments */
        .experiments-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .experiments-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 25px;
            width: 95%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            color: white;
        }

        .experiment-card {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .experiment-card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateX(5px);
        }

        .experiment-icon {
            font-size: 3rem;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
        }

        .experiment-info {
            flex: 1;
        }

        .experiment-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .experiment-desc {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .experiment-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .experiment-badge.easy {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .experiment-badge.medium {
            background: rgba(255, 193, 7, 0.3);
            color: #FFC107;
        }

        .experiment-simulation {
            display: none;
            text-align: center;
            padding: 30px 0;
        }

        .experiment-animation {
            width: 200px;
            height: 200px;
            margin: 0 auto 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            animation: experimentPulse 2s ease infinite;
        }

        @keyframes experimentPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .experiment-steps {
            text-align: left;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .experiment-step {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .experiment-step-num {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        /* Learning Pathways */
        .pathways-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .pathways-content {
            background: white;
            border-radius: 25px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .pathway-card {
            background: #f8f9fa;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid;
            transition: all 0.3s ease;
        }

        .pathway-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .pathway-card.physics { border-left-color: #667eea; }
        .pathway-card.chemistry { border-left-color: #11998e; }
        .pathway-card.biology { border-left-color: #ee0979; }
        .pathway-card.earth { border-left-color: #f5af19; }

        .pathway-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .pathway-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pathway-progress-badge {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .pathway-lessons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .pathway-lesson {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pathway-lesson.completed {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
        }

        .pathway-lesson.current {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            animation: lessonPulse 2s ease infinite;
        }

        @keyframes lessonPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
        }

        .pathway-lesson.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Quick Start Tutorial */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100002;
        }

        .tutorial-content {
            background: white;
            border-radius: 30px;
            width: 95%;
            max-width: 500px;
            padding: 40px;
            text-align: center;
        }

        .tutorial-step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 30px;
        }

        .tutorial-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s ease;
        }

        .tutorial-dot.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 30px;
            border-radius: 5px;
        }

        .tutorial-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: tutorialBounce 2s ease infinite;
        }

        @keyframes tutorialBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .tutorial-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .tutorial-text {
            color: #666;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .tutorial-nav {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .tutorial-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tutorial-btn-skip {
            background: #f0f0f0;
            color: #666;
        }

        .tutorial-btn-next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tutorial-btn-next:hover {
            transform: scale(1.05);
        }

        /* Floating buttons for Batch 32 */
        .floating-experiments-btn {
            position: fixed;
            bottom: 2080px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(156, 39, 176, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-experiments-btn:hover {
            transform: scale(1.1);
        }

        .floating-pathways-btn {
            position: fixed;
            bottom: 2140px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bcd4 0%, #009688 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 188, 212, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-pathways-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 33: Keyboard Shortcuts, Level Rewards, Celebrations ========== */

        /* Keyboard Shortcuts Help */
        .shortcuts-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .shortcuts-content {
            background: white;
            border-radius: 25px;
            width: 95%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .shortcuts-category {
            margin-bottom: 25px;
        }

        .shortcuts-category-title {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .shortcut-keys {
            display: flex;
            gap: 5px;
        }

        .shortcut-key {
            padding: 5px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .shortcut-desc {
            color: #666;
            font-size: 0.9rem;
        }

        /* Level Rewards */
        .level-reward-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 30px;
            padding: 50px;
            text-align: center;
            z-index: 100003;
            color: white;
            box-shadow: 0 30px 100px rgba(0,0,0,0.5);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .level-reward-popup.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .level-reward-glow {
            position: absolute;
            top: -50px;
            left: -50px;
            right: -50px;
            bottom: -50px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.3) 0%, transparent 70%);
            animation: rewardGlow 2s ease infinite;
            pointer-events: none;
            border-radius: 50px;
        }

        @keyframes rewardGlow {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        .level-reward-badge {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: rewardBounce 1s ease infinite;
        }

        @keyframes rewardBounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(-5deg); }
            75% { transform: translateY(-10px) rotate(5deg); }
        }

        .level-reward-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .level-reward-desc {
            color: #aaa;
            margin-bottom: 25px;
        }

        .level-reward-items {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .level-reward-item {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .level-reward-item-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .level-reward-item-value {
            font-weight: 700;
            color: #4CAF50;
        }

        .level-reward-claim-btn {
            padding: 15px 50px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-reward-claim-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(245, 175, 25, 0.4);
        }

        /* Celebration Effects */
        .celebration-firework {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 100001;
        }

        .star-burst {
            position: fixed;
            pointer-events: none;
            z-index: 100001;
            animation: starBurst 1s ease-out forwards;
        }

        @keyframes starBurst {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            100% { transform: scale(2) rotate(180deg); opacity: 0; }
        }

        .sparkle {
            position: fixed;
            font-size: 2rem;
            pointer-events: none;
            z-index: 100001;
            animation: sparkleAnim 1.5s ease-out forwards;
        }

        @keyframes sparkleAnim {
            0% { transform: translateY(0) scale(0); opacity: 0; }
            20% { transform: translateY(-20px) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0.5); opacity: 0; }
        }

        .floating-text {
            position: fixed;
            font-size: 1.5rem;
            font-weight: 700;
            color: #4CAF50;
            pointer-events: none;
            z-index: 100001;
            animation: floatUp 1.5s ease-out forwards;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.2); opacity: 0; }
        }

        .rainbow-border {
            position: relative;
        }

        .rainbow-border::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
            background-size: 400%;
            border-radius: inherit;
            z-index: -1;
            animation: rainbowBorder 3s linear infinite;
        }

        @keyframes rainbowBorder {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Floating shortcut button */
        .floating-shortcuts-btn {
            position: fixed;
            bottom: 2200px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #607d8b 0%, #455a64 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(96, 125, 139, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-shortcuts-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 34: Hint System, Stats Dashboard, Weekly Report ========== */

        /* Hint System */
        .hint-bubble {
            position: fixed;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 20px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(245, 175, 25, 0.4);
            z-index: 10000;
            display: none;
            animation: hintBounce 0.5s ease;
        }

        @keyframes hintBounce {
            0% { transform: translateX(-50%) scale(0); }
            50% { transform: translateX(-50%) scale(1.1); }
            100% { transform: translateX(-50%) scale(1); }
        }

        .hint-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .hint-text {
            font-size: 1rem;
            line-height: 1.5;
        }

        .hint-close {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.7;
        }

        .hint-close:hover {
            opacity: 1;
        }

        .hint-remaining {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        /* Stats Dashboard */
        .stats-dashboard-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .stats-dashboard-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 25px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            color: white;
        }

        .stats-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .stats-main-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stats-main-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .stats-main-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .stats-main-value {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-main-label {
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 5px;
        }

        .stats-section {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .stats-section-title {
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stats-row:last-child {
            border-bottom: none;
        }

        .stats-row-label {
            color: #aaa;
        }

        .stats-row-value {
            font-weight: 600;
        }

        /* Weekly Report */
        .weekly-report-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .weekly-report-content {
            background: white;
            border-radius: 25px;
            width: 95%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .weekly-report-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .weekly-report-grade {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: 700;
            color: white;
        }

        .weekly-report-grade.a { background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); }
        .weekly-report-grade.b { background: linear-gradient(135deg, #2196F3 0%, #03A9F4 100%); }
        .weekly-report-grade.c { background: linear-gradient(135deg, #FF9800 0%, #FFC107 100%); }
        .weekly-report-grade.d { background: linear-gradient(135deg, #f44336 0%, #E91E63 100%); }

        .weekly-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .weekly-stat-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .weekly-stat-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .weekly-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .weekly-stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        .weekly-stat-change {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .weekly-stat-change.positive { color: #4CAF50; }
        .weekly-stat-change.negative { color: #f44336; }

        .weekly-comparison {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            text-align: center;
            margin-bottom: 25px;
        }

        .weekly-comparison-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .weekly-comparison-bar {
            height: 15px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .weekly-comparison-fill {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Floating buttons for Batch 34 */
        .floating-stats-btn {
            position: fixed;
            bottom: 2260px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3f51b5 0%, #2196f3 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(63, 81, 181, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-stats-btn:hover {
            transform: scale(1.1);
        }

        .floating-report-btn {
            position: fixed;
            bottom: 2320px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63 0%, #9c27b0 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(233, 30, 99, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-report-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 35: Note-Taking, Bookmarks, Challenge Mode ========== */

        /* Note-Taking System */
        .notes-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .notes-container {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .notes-header {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notes-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .notes-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .note-item {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #ff9800;
            position: relative;
        }

        .note-item .note-title {
            font-weight: bold;
            color: #e65100;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .note-item .note-content {
            color: #5d4037;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }

        .note-item .note-date {
            font-size: 0.75rem;
            color: #8d6e63;
            margin-top: 8px;
        }

        .note-item .note-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .new-note-form {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .new-note-form input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .new-note-form textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            min-height: 100px;
            resize: vertical;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .new-note-form button {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .new-note-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }

        /* Bookmarks System */
        .bookmarks-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .bookmarks-container {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .bookmarks-header {
            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bookmarks-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .bookmarks-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .bookmark-item {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #e91e63;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bookmark-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.2);
        }

        .bookmark-info {
            flex: 1;
        }

        .bookmark-info .bookmark-title {
            font-weight: bold;
            color: #880e4f;
            margin-bottom: 5px;
        }

        .bookmark-info .bookmark-topic {
            font-size: 0.85rem;
            color: #ad1457;
        }

        .bookmark-actions button {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .bookmark-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: 2px solid #e91e63;
            color: #e91e63;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .bookmark-btn.bookmarked {
            background: #e91e63;
            color: white;
        }

        .bookmark-btn:hover {
            transform: scale(1.1);
        }

        /* Challenge Mode */
        .challenge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .challenge-container {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            border-radius: 20px;
            width: 95%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 3px solid #ffd700;
        }

        .challenge-header {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #1a237e;
            padding: 20px;
            text-align: center;
        }

        .challenge-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .challenge-timer {
            font-size: 3rem;
            color: #ffd700;
            text-align: center;
            font-family: 'Courier New', monospace;
            padding: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .challenge-timer.warning {
            color: #ff5722;
            animation: pulse 0.5s infinite;
        }

        .challenge-score {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            color: white;
        }

        .challenge-score-item {
            text-align: center;
        }

        .challenge-score-item .label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .challenge-score-item .value {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd700;
        }

        .challenge-question {
            background: rgba(255, 255, 255, 0.1);
            margin: 0 20px;
            padding: 20px;
            border-radius: 15px;
            color: white;
        }

        .challenge-question p {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .challenge-options {
            display: grid;
            gap: 10px;
        }

        .challenge-option {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
            text-align: left;
        }

        .challenge-option:hover {
            background: rgba(255, 215, 0, 0.3);
            border-color: #ffd700;
            transform: scale(1.02);
        }

        .challenge-option.correct {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .challenge-option.incorrect {
            background: #f44336;
            border-color: #f44336;
        }

        .challenge-controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .challenge-start-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #1a237e;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .challenge-start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
        }

        .challenge-quit-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .challenge-quit-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .challenge-result {
            text-align: center;
            padding: 30px;
            color: white;
        }

        .challenge-result h3 {
            font-size: 2rem;
            color: #ffd700;
            margin-bottom: 20px;
        }

        .challenge-result .final-score {
            font-size: 4rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .challenge-result .reward {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            display: inline-block;
            padding: 15px 30px;
            border-radius: 30px;
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .challenge-setup {
            padding: 20px;
            color: white;
        }

        .challenge-setup h3 {
            text-align: center;
            color: #ffd700;
            margin-bottom: 20px;
        }

        .challenge-difficulty {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .difficulty-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 20px 10px;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .difficulty-btn:hover, .difficulty-btn.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
        }

        .difficulty-btn .diff-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .difficulty-btn .diff-desc {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Floating buttons for new features */
        .floating-notes-btn {
            position: fixed;
            bottom: 2380px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 152, 0, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-notes-btn:hover {
            transform: scale(1.1);
        }

        .floating-bookmarks-btn {
            position: fixed;
            bottom: 2440px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(233, 30, 99, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-bookmarks-btn:hover {
            transform: scale(1.1);
        }

        .floating-challenge-btn {
            position: fixed;
            bottom: 2500px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: #ffd700;
            border: 2px solid #ffd700;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(26, 35, 126, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-challenge-btn:hover {
            transform: scale(1.1);
        }

        .no-bookmarks, .no-notes {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .no-bookmarks p, .no-notes p {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        /* ========== BATCH 36: Sound Effects, Parent Dashboard, Study Timer ========== */

        /* Sound Effects Toggle */
        .sound-toggle {
            position: fixed;
            bottom: 2560px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #607d8b 0%, #455a64 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(96, 125, 139, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .sound-toggle:hover {
            transform: scale(1.1);
        }

        .sound-toggle.muted {
            background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
        }

        /* Parent Dashboard */
        .parent-dashboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .parent-dashboard-container {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .parent-dashboard-header {
            background: linear-gradient(135deg, #3f51b5 0%, #5c6bc0 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .parent-dashboard-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .parent-dashboard-body {
            padding: 25px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .parent-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .parent-stat-card {
            background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #3f51b5;
        }

        .parent-stat-card .stat-label {
            color: #5c6bc0;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .parent-stat-card .stat-value {
            color: #1a237e;
            font-size: 2.2rem;
            font-weight: bold;
        }

        .parent-stat-card .stat-trend {
            font-size: 0.85rem;
            margin-top: 8px;
        }

        .parent-stat-card .stat-trend.positive {
            color: #4CAF50;
        }

        .parent-stat-card .stat-trend.negative {
            color: #f44336;
        }

        .parent-section {
            background: #f5f5f5;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .parent-section h3 {
            color: #3f51b5;
            margin: 0 0 15px 0;
            font-size: 1.2rem;
        }

        .activity-log {
            max-height: 200px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .activity-item .activity-text {
            color: #333;
        }

        .activity-item .activity-time {
            color: #999;
            font-size: 0.85rem;
        }

        .parent-progress-bar {
            background: #ddd;
            border-radius: 10px;
            height: 25px;
            overflow: hidden;
            position: relative;
        }

        .parent-progress-fill {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .parent-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Study Timer */
        .study-timer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .study-timer-container {
            background: linear-gradient(135deg, #00695c 0%, #004d40 100%);
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .study-timer-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            text-align: center;
            color: white;
        }

        .study-timer-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .study-timer-body {
            padding: 30px;
            text-align: center;
        }

        .timer-display {
            font-size: 4rem;
            color: white;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            margin-bottom: 20px;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .timer-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timer-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .timer-btn.primary {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .timer-btn.danger {
            background: #f44336;
            border-color: #f44336;
        }

        .study-stats-today {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            color: white;
        }

        .study-stats-today h4 {
            margin: 0 0 15px 0;
            opacity: 0.9;
        }

        .study-stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .study-stats-row .label {
            opacity: 0.8;
        }

        .study-stats-row .value {
            font-weight: bold;
        }

        .daily-goal-progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 15px;
            overflow: hidden;
            margin-top: 15px;
        }

        .daily-goal-fill {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .floating-parent-btn {
            position: fixed;
            bottom: 2620px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3f51b5 0%, #5c6bc0 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(63, 81, 181, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-parent-btn:hover {
            transform: scale(1.1);
        }

        .floating-timer-btn {
            position: fixed;
            bottom: 2680px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00695c 0%, #004d40 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 105, 92, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-timer-btn:hover {
            transform: scale(1.1);
        }

        .timer-running {
            animation: timerPulse 2s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { box-shadow: 0 5px 20px rgba(0, 105, 92, 0.4); }
            50% { box-shadow: 0 5px 30px rgba(0, 105, 92, 0.8); }
        }

        /* ========== BATCH 37: Motivational Messages, Topic Mastery, Science Quotes ========== */

        /* Motivational Messages */
        .motivation-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, #ff6f00 0%, #ff8f00 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 500;
            box-shadow: 0 10px 40px rgba(255, 111, 0, 0.4);
            z-index: 9999;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .motivation-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .motivation-toast .motivation-icon {
            font-size: 1.3rem;
            margin-right: 10px;
        }

        /* Topic Mastery System */
        .mastery-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .mastery-container {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .mastery-header {
            background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mastery-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .mastery-body {
            padding: 25px;
            max-height: 65vh;
            overflow-y: auto;
        }

        .mastery-topic {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #9c27b0;
        }

        .mastery-topic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .mastery-topic-name {
            font-weight: bold;
            color: #4a148c;
            font-size: 1.1rem;
        }

        .mastery-level {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mastery-stars {
            color: #ffd700;
            font-size: 1.2rem;
        }

        .mastery-percentage {
            background: #9c27b0;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .mastery-progress-bar {
            background: rgba(156, 39, 176, 0.2);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
        }

        .mastery-progress-fill {
            background: linear-gradient(135deg, #9c27b0 0%, #e91e63 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .mastery-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #7b1fa2;
        }

        /* Science Quotes */
        .quotes-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .quotes-container {
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            text-align: center;
        }

        .quotes-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            color: white;
        }

        .quotes-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .quotes-body {
            padding: 40px 30px;
        }

        .quote-text {
            color: white;
            font-size: 1.4rem;
            font-style: italic;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .quote-author {
            color: #b39ddb;
            font-size: 1.1rem;
        }

        .quote-author::before {
            content: " ";
        }

        .quotes-controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .quote-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quote-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .quote-btn.primary {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #1a237e;
            border: none;
            font-weight: bold;
        }

        /* Floating buttons */
        .floating-mastery-btn {
            position: fixed;
            bottom: 2740px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(123, 31, 162, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-mastery-btn:hover {
            transform: scale(1.1);
        }

        .floating-quotes-btn {
            position: fixed;
            bottom: 2800px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(26, 35, 126, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-quotes-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 38: Power-ups, Daily Login Reward, Quick Review ========== */

        /* Power-ups System */
        .powerups-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .powerups-container {
            background: linear-gradient(135deg, #880e4f 0%, #ad1457 100%);
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .powerups-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .powerups-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .powerups-body {
            padding: 20px;
            max-height: 65vh;
            overflow-y: auto;
        }

        .powerup-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .powerup-card:hover {
            border-color: #ffd700;
            transform: translateY(-3px);
        }

        .powerup-card.owned {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
        }

        .powerup-icon {
            font-size: 2.5rem;
            min-width: 60px;
            text-align: center;
        }

        .powerup-info {
            flex: 1;
        }

        .powerup-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .powerup-desc {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .powerup-count {
            font-size: 0.85rem;
            color: #ffd700;
        }

        .powerup-action {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .powerup-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #880e4f;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .powerup-btn:hover {
            transform: scale(1.05);
        }

        .powerup-btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }

        .powerup-cost {
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Daily Login Reward */
        .daily-reward-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .daily-reward-container {
            background: linear-gradient(135deg, #1565c0 0%, #1976d2 100%);
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            text-align: center;
            animation: rewardBounce 0.5s ease;
        }

        @keyframes rewardBounce {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .daily-reward-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            color: white;
        }

        .daily-reward-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .daily-reward-body {
            padding: 30px;
            color: white;
        }

        .daily-streak-display {
            font-size: 3rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
        }

        .daily-streak-label {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .daily-reward-box {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .reward-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
        }

        .reward-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd700;
        }

        .daily-reward-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #1565c0;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .daily-reward-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
        }

        /* Quick Review Mode */
        .quick-review-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .quick-review-container {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .quick-review-header {
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quick-review-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .quick-review-body {
            padding: 20px;
            max-height: 65vh;
            overflow-y: auto;
        }

        .review-card {
            background: #fff3f3;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #f44336;
        }

        .review-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .review-topic {
            color: #d32f2f;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .review-date {
            color: #999;
            font-size: 0.8rem;
        }

        .review-question {
            color: #333;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .review-answers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .review-answer {
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .review-answer.wrong {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }

        .review-answer.correct {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .review-empty {
            text-align: center;
            padding: 40px;
            color: #4CAF50;
        }

        .review-empty-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        /* Floating buttons */
        .floating-powerups-btn {
            position: fixed;
            bottom: 2860px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #880e4f 0%, #ad1457 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(136, 14, 79, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-powerups-btn:hover {
            transform: scale(1.1);
        }

        .floating-review-btn {
            position: fixed;
            bottom: 2920px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(211, 47, 47, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-review-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 39: Science Jokes, Mind Map, Favorite Topics ========== */

        /* Science Jokes */
        .jokes-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .jokes-container {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .jokes-header {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            color: white;
        }

        .jokes-header h2 {
            margin: 0;
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .jokes-body {
            padding: 30px;
            color: white;
        }

        .joke-setup {
            font-size: 1.3rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .joke-punchline {
            font-size: 1.5rem;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .joke-punchline.revealed {
            display: block;
            animation: punchlineReveal 0.5s ease;
        }

        @keyframes punchlineReveal {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .jokes-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .joke-btn {
            background: white;
            color: #ff6b6b;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .joke-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        /* Mind Map */
        .mindmap-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .mindmap-container {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .mindmap-header {
            background: linear-gradient(135deg, #00bcd4 0%, #26c6da 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mindmap-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .mindmap-body {
            padding: 30px;
            overflow-y: auto;
            max-height: 70vh;
        }

        .mindmap-tree {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .mindmap-root {
            background: linear-gradient(135deg, #00bcd4 0%, #26c6da 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 30px;
            font-size: 1.3rem;
            font-weight: bold;
            text-align: center;
            max-width: 300px;
            margin: 0 auto;
            box-shadow: 0 5px 20px rgba(0, 188, 212, 0.3);
        }

        .mindmap-branches {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .mindmap-branch {
            background: #e0f7fa;
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid #00bcd4;
        }

        .mindmap-branch-title {
            font-weight: bold;
            color: #00838f;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .mindmap-leaves {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .mindmap-leaf {
            background: white;
            color: #00838f;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            border: 1px solid #b2ebf2;
        }

        /* Favorite Topics */
        .favorites-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .favorites-container {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .favorites-header {
            background: linear-gradient(135deg, #ff5722 0%, #ff7043 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .favorites-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .favorites-body {
            padding: 20px;
            max-height: 65vh;
            overflow-y: auto;
        }

        .favorite-topic-card {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #ff5722;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .favorite-topic-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(255, 87, 34, 0.2);
        }

        .favorite-topic-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .favorite-topic-icon {
            font-size: 2rem;
        }

        .favorite-topic-name {
            font-weight: bold;
            color: #e64a19;
        }

        .favorite-topic-actions button {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
        }

        .add-favorite-btn {
            background: linear-gradient(135deg, #ff5722 0%, #ff7043 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: block;
            width: 100%;
            margin-top: 15px;
        }

        /* Floating buttons */
        .floating-jokes-btn {
            position: fixed;
            bottom: 2980px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-jokes-btn:hover {
            transform: scale(1.1);
        }

        .floating-mindmap-btn {
            position: fixed;
            bottom: 3040px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bcd4 0%, #26c6da 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 188, 212, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-mindmap-btn:hover {
            transform: scale(1.1);
        }

        .floating-favorites-btn {
            position: fixed;
            bottom: 3100px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff5722 0%, #ff7043 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 87, 34, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-favorites-btn:hover {
            transform: scale(1.1);
        }

        .no-favorites {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* ========== BATCH 40: Leaderboard, Confetti, Study Reminders ========== */

        /* Leaderboard */
        .leaderboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .leaderboard-container {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .leaderboard-header {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            color: white;
            text-align: center;
        }

        .leaderboard-header h2 {
            margin: 0;
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .leaderboard-body {
            padding: 20px;
            max-height: 65vh;
            overflow-y: auto;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .leaderboard-item.current-user {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
        }

        .leaderboard-rank {
            font-size: 1.5rem;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }

        .leaderboard-rank.gold { color: #ffd700; }
        .leaderboard-rank.silver { color: #c0c0c0; }
        .leaderboard-rank.bronze { color: #cd7f32; }

        .leaderboard-avatar {
            font-size: 2rem;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .leaderboard-stats {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .leaderboard-xp {
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* Confetti */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 99999;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translateY(-100px) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(100vh) rotate(720deg);
            }
        }

        /* Study Reminders */
        .reminders-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .reminders-container {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .reminders-header {
            background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reminders-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .reminders-body {
            padding: 25px;
        }

        .reminder-option {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reminder-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .reminder-icon {
            font-size: 1.5rem;
        }

        .reminder-text {
            font-weight: 500;
            color: #333;
        }

        .reminder-toggle {
            width: 50px;
            height: 26px;
            background: #ddd;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reminder-toggle.active {
            background: #9c27b0;
        }

        .reminder-toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .reminder-toggle.active::after {
            left: 26px;
        }

        .reminder-time-select {
            margin-top: 20px;
            padding: 15px;
            background: #f0e6ff;
            border-radius: 12px;
        }

        .reminder-time-select label {
            display: block;
            color: #673ab7;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .reminder-time-select input {
            width: 100%;
            padding: 12px;
            border: 2px solid #9c27b0;
            border-radius: 8px;
            font-size: 1rem;
        }

        /* Floating buttons */
        .floating-leaderboard-btn {
            position: fixed;
            bottom: 3160px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #333;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-leaderboard-btn:hover {
            transform: scale(1.1);
        }

        .floating-reminders-btn {
            position: fixed;
            bottom: 3220px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(156, 39, 176, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-reminders-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 41: Profile Customization, Difficulty Indicator, Science News ========== */

        /* Profile Customization */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .profile-container {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .profile-header {
            background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .profile-avatar-display {
            font-size: 4rem;
            margin-bottom: 10px;
        }

        .profile-name-display {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .profile-body {
            padding: 25px;
        }

        .profile-section {
            margin-bottom: 20px;
        }

        .profile-section label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .profile-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .avatar-picker {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }

        .avatar-option {
            font-size: 2rem;
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .avatar-option:hover {
            background: #e3f2fd;
        }

        .avatar-option.selected {
            border-color: #2196f3;
            background: #e3f2fd;
        }

        .profile-save-btn {
            background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        /* Difficulty Indicator */
        .difficulty-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .difficulty-badge.easy {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .difficulty-badge.medium {
            background: #fff3e0;
            color: #e65100;
        }

        .difficulty-badge.hard {
            background: #ffebee;
            color: #c62828;
        }

        .difficulty-stars {
            color: #ffd700;
        }

        /* Science News */
        .news-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .news-container {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .news-header {
            background: linear-gradient(135deg, #37474f 0%, #546e7a 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .news-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .news-body {
            padding: 20px;
            max-height: 65vh;
            overflow-y: auto;
        }

        .news-card {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #37474f;
            transition: all 0.3s ease;
        }

        .news-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .news-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .news-category {
            background: #37474f;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
        }

        .news-date {
            color: #999;
            font-size: 0.8rem;
        }

        .news-title {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .news-summary {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .news-emoji {
            font-size: 2rem;
            margin-right: 15px;
        }

        /* Floating buttons */
        .floating-profile-btn {
            position: fixed;
            bottom: 3280px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(33, 150, 243, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-profile-btn:hover {
            transform: scale(1.1);
        }

        .floating-news-btn {
            position: fixed;
            bottom: 3340px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #37474f 0%, #546e7a 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(55, 71, 79, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-news-btn:hover {
            transform: scale(1.1);
        }

        /* ========== BATCH 42: Trivia Game, Study Breaks, Progress Milestones ========== */

        /* Trivia Mini-Game */
        .trivia-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .trivia-container {
            background: linear-gradient(135deg, #6a1b9a 0%, #8e24aa 100%);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            text-align: center;
        }

        .trivia-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            color: white;
        }

        .trivia-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .trivia-body {
            padding: 25px;
            color: white;
        }

        .trivia-question {
            font-size: 1.2rem;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .trivia-options {
            display: grid;
            gap: 10px;
        }

        .trivia-option {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .trivia-option:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
        }

        .trivia-option.correct {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .trivia-option.wrong {
            background: #f44336;
            border-color: #f44336;
        }

        .trivia-score {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 15px;
        }

        .trivia-controls {
            padding: 20px;
        }

        .trivia-btn {
            background: white;
            color: #6a1b9a;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }

        /* Study Breaks */
        .break-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .break-container {
            background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .break-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            color: white;
        }

        .break-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .break-body {
            padding: 25px;
            color: white;
        }

        .break-activity {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .break-activity-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .break-activity-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .break-activity-desc {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .break-timer {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 20px 0;
            font-family: monospace;
        }

        .break-btn {
            background: white;
            color: #43a047;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }

        /* Progress Milestones */
        .milestones-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .milestones-container {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .milestones-header {
            background: linear-gradient(135deg, #f9a825 0%, #fbc02d 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .milestones-header h2 {
            margin: 0;
            font-size: 1.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .milestones-body {
            padding: 20px;
            max-height: 65vh;
            overflow-y: auto;
        }

        .milestone-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 12px;
            margin-bottom: 12px;
            position: relative;
        }

        .milestone-card.completed {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border: 2px solid #ffc107;
        }

        .milestone-card.locked {
            opacity: 0.6;
        }

        .milestone-icon {
            font-size: 2rem;
            min-width: 50px;
            text-align: center;
        }

        .milestone-info {
            flex: 1;
        }

        .milestone-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .milestone-desc {
            font-size: 0.85rem;
            color: #666;
        }

        .milestone-progress {
            background: #ddd;
            height: 8px;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .milestone-progress-fill {
            background: linear-gradient(135deg, #f9a825 0%, #fbc02d 100%);
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .milestone-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #4CAF50;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        /* Floating buttons */
        .floating-trivia-btn {
            position: fixed;
            bottom: 3400px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a1b9a 0%, #8e24aa 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(106, 27, 154, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-trivia-btn:hover {
            transform: scale(1.1);
        }

        .floating-break-btn {
            position: fixed;
            bottom: 3460px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(67, 160, 71, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-break-btn:hover {
            transform: scale(1.1);
        }

        .floating-milestones-btn {
            position: fixed;
            bottom: 3520px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f9a825 0%, #fbc02d 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(249, 168, 37, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-milestones-btn:hover {
            transform: scale(1.1);
        }

        /* ===== Batch 43 Styles: Vocabulary Builder, Experiment Simulator, Streak Bonus ===== */

        /* Vocabulary Builder */
        .vocab-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .vocab-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #4a90d9;
        }

        .vocab-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .vocab-header h2 {
            color: #4a90d9;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .vocab-category-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .vocab-tab {
            padding: 8px 15px;
            border-radius: 20px;
            background: rgba(74, 144, 217, 0.2);
            color: #4a90d9;
            border: 1px solid #4a90d9;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .vocab-tab.active {
            background: #4a90d9;
            color: white;
        }

        .vocab-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #4a90d9;
        }

        .vocab-term {
            font-size: 1.3rem;
            color: #4a90d9;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .vocab-definition {
            color: #b0b0b0;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .vocab-example {
            font-style: italic;
            color: #888;
            font-size: 0.9rem;
            padding-left: 15px;
            border-left: 2px solid #4a90d9;
        }

        .vocab-learned {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .vocab-learned input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .vocab-learned label {
            color: #aaa;
            font-size: 0.9rem;
        }

        .vocab-progress {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .vocab-progress-bar {
            height: 10px;
            background: rgba(74, 144, 217, 0.2);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .vocab-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90d9, #67b8f7);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        /* Experiment Simulator */
        .experiment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .experiment-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #9c27b0;
        }

        .experiment-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .experiment-header h2 {
            color: #9c27b0;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .experiment-list {
            display: grid;
            gap: 15px;
        }

        .experiment-card {
            background: rgba(156, 39, 176, 0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .experiment-card:hover {
            border-color: #9c27b0;
            transform: translateY(-3px);
        }

        .experiment-card.active {
            border-color: #9c27b0;
            background: rgba(156, 39, 176, 0.2);
        }

        .experiment-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .experiment-title {
            color: #ce93d8;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .experiment-desc {
            color: #aaa;
            font-size: 0.9rem;
        }

        .experiment-workspace {
            display: none;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .experiment-workspace.active {
            display: block;
        }

        .experiment-step {
            background: rgba(156, 39, 176, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #9c27b0;
        }

        .experiment-step-num {
            color: #9c27b0;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .experiment-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .experiment-btn {
            padding: 10px 20px;
            border-radius: 10px;
            background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .experiment-btn:hover {
            transform: scale(1.05);
        }

        .experiment-result {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.2) 0%, rgba(186, 104, 200, 0.2) 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-top: 15px;
            display: none;
        }

        .experiment-result.show {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        .experiment-result-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .experiment-result-text {
            color: #ce93d8;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        /* Streak Bonus Indicator */
        .streak-bonus-indicator {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            border-radius: 15px;
            padding: 15px 20px;
            z-index: 9999;
            display: none;
            animation: bounceIn 0.5s ease;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
        }

        .streak-bonus-indicator.show {
            display: block;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        .streak-bonus-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .streak-fire {
            font-size: 2rem;
            animation: fireFlicker 0.5s ease infinite alternate;
        }

        @keyframes fireFlicker {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        .streak-info h4 {
            color: white;
            margin: 0;
            font-size: 1rem;
        }

        .streak-multiplier {
            color: #ffe066;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .streak-count {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
        }

        /* Floating Buttons for Batch 43 */
        .floating-vocab-btn {
            position: fixed;
            bottom: 3580px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4a90d9 0%, #67b8f7 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(74, 144, 217, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-vocab-btn:hover {
            transform: scale(1.1);
        }

        .floating-experiment-btn {
            position: fixed;
            bottom: 3640px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(156, 39, 176, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-experiment-btn:hover {
            transform: scale(1.1);
        }

        /* ===== Batch 44 Styles: Question History, Science Calculator, Weekly Challenges ===== */

        /* Question History Modal */
        .history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .history-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #00bcd4;
        }

        .history-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .history-header h2 {
            color: #00bcd4;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .history-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .history-stat {
            background: rgba(0, 188, 212, 0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .history-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00bcd4;
        }

        .history-stat-label {
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 5px;
        }

        .history-filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .history-filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(0, 188, 212, 0.2);
            color: #00bcd4;
            border: 1px solid #00bcd4;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .history-filter-btn.active {
            background: #00bcd4;
            color: white;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #00bcd4;
        }

        .history-item.correct {
            border-left-color: #4caf50;
        }

        .history-item.incorrect {
            border-left-color: #f44336;
        }

        .history-question {
            color: #ddd;
            font-size: 0.95rem;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .history-answer-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .history-answer {
            font-size: 0.85rem;
            color: #aaa;
        }

        .history-answer span {
            font-weight: bold;
        }

        .history-answer span.correct-answer {
            color: #4caf50;
        }

        .history-answer span.wrong-answer {
            color: #f44336;
        }

        .history-date {
            font-size: 0.8rem;
            color: #888;
        }

        /* Science Calculator */
        .calculator-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .calculator-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 350px;
            width: 90%;
            position: relative;
            border: 2px solid #ff9800;
        }

        .calculator-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .calculator-header h2 {
            color: #ff9800;
            font-size: 1.5rem;
        }

        .calculator-display {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: right;
        }

        .calculator-expression {
            color: #888;
            font-size: 0.9rem;
            min-height: 20px;
        }

        .calculator-result {
            color: #ff9800;
            font-size: 2rem;
            font-weight: bold;
            word-break: break-all;
        }

        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .calc-btn {
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calc-btn.number {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .calc-btn.operator {
            background: rgba(255, 152, 0, 0.3);
            color: #ff9800;
        }

        .calc-btn.function {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .calc-btn.equals {
            background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
            color: white;
            grid-column: span 2;
        }

        .calc-btn.clear {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        .calc-btn:hover {
            transform: scale(1.05);
            filter: brightness(1.2);
        }

        .calc-btn:active {
            transform: scale(0.95);
        }

        .calculator-formulas {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .formula-title {
            color: #ff9800;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .formula-item {
            background: rgba(255, 152, 0, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .formula-item:hover {
            background: rgba(255, 152, 0, 0.2);
        }

        .formula-name {
            color: #ffc107;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .formula-equation {
            color: #aaa;
            font-size: 0.8rem;
        }

        /* Weekly Challenges */
        .weekly-challenge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .weekly-challenge-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #e91e63;
        }

        .weekly-challenge-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .weekly-challenge-header h2 {
            color: #e91e63;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .challenge-timer {
            background: rgba(233, 30, 99, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .challenge-timer-label {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .challenge-timer-value {
            color: #e91e63;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .challenge-card {
            background: rgba(233, 30, 99, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .challenge-card.active {
            border-color: #e91e63;
        }

        .challenge-card.completed {
            opacity: 0.7;
            background: rgba(76, 175, 80, 0.1);
        }

        .challenge-card.completed .challenge-badge {
            display: block;
        }

        .challenge-badge {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4caf50;
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .challenge-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .challenge-title {
            color: #f48fb1;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .challenge-desc {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .challenge-progress {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .challenge-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #e91e63, #f48fb1);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .challenge-reward {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ffc107;
            font-size: 0.9rem;
        }

        /* Floating Buttons for Batch 44 */
        .floating-history-btn {
            position: fixed;
            bottom: 3700px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bcd4 0%, #4dd0e1 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 188, 212, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-history-btn:hover {
            transform: scale(1.1);
        }

        .floating-calculator-btn {
            position: fixed;
            bottom: 3760px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 152, 0, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-calculator-btn:hover {
            transform: scale(1.1);
        }

        .floating-weekly-btn {
            position: fixed;
            bottom: 3820px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63 0%, #f48fb1 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(233, 30, 99, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-weekly-btn:hover {
            transform: scale(1.1);
        }

        /* ===== Batch 45 Styles: Science Flashcards, Learning Paths, Speed Quiz ===== */

        /* Flashcards Modal */
        .flashcards-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .flashcards-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            position: relative;
            border: 2px solid #8bc34a;
        }

        .flashcards-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .flashcards-header h2 {
            color: #8bc34a;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .flashcard-container {
            perspective: 1000px;
            margin-bottom: 20px;
        }

        .flashcard {
            width: 100%;
            height: 250px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s ease;
            cursor: pointer;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .flashcard-front {
            background: linear-gradient(135deg, #8bc34a 0%, #aed581 100%);
            color: white;
        }

        .flashcard-back {
            background: linear-gradient(135deg, #4caf50 0%, #81c784 100%);
            color: white;
            transform: rotateY(180deg);
        }

        .flashcard-category {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .flashcard-question {
            font-size: 1.3rem;
            font-weight: bold;
            text-align: center;
            line-height: 1.4;
        }

        .flashcard-answer {
            font-size: 1.2rem;
            text-align: center;
            line-height: 1.5;
        }

        .flashcard-hint {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 15px;
        }

        .flashcard-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .flashcard-btn {
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .flashcard-btn.prev {
            background: rgba(139, 195, 74, 0.2);
            color: #8bc34a;
        }

        .flashcard-btn.next {
            background: linear-gradient(135deg, #8bc34a 0%, #aed581 100%);
            color: white;
        }

        .flashcard-btn:hover {
            transform: scale(1.05);
        }

        .flashcard-progress {
            text-align: center;
            color: #aaa;
            font-size: 0.9rem;
        }

        /* Learning Paths Modal */
        .paths-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .paths-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #673ab7;
        }

        .paths-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .paths-header h2 {
            color: #673ab7;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .learning-path {
            background: rgba(103, 58, 183, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #673ab7;
        }

        .path-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .path-icon {
            font-size: 2.5rem;
        }

        .path-info h3 {
            color: #b39ddb;
            margin: 0 0 5px 0;
            font-size: 1.2rem;
        }

        .path-info p {
            color: #aaa;
            margin: 0;
            font-size: 0.85rem;
        }

        .path-steps {
            margin-top: 15px;
        }

        .path-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .path-step.completed {
            background: rgba(76, 175, 80, 0.2);
        }

        .path-step.current {
            background: rgba(103, 58, 183, 0.3);
            border: 1px solid #673ab7;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #673ab7;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .path-step.completed .step-number {
            background: #4caf50;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            color: #ddd;
            font-size: 0.95rem;
        }

        .step-status {
            font-size: 1.2rem;
        }

        .path-progress-bar {
            height: 8px;
            background: rgba(103, 58, 183, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .path-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #673ab7, #9575cd);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Speed Quiz Modal */
        .speed-quiz-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .speed-quiz-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            position: relative;
            border: 2px solid #ff5722;
        }

        .speed-quiz-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .speed-quiz-header h2 {
            color: #ff5722;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .speed-timer-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .speed-timer {
            font-size: 3rem;
            font-weight: bold;
            color: #ff5722;
            font-family: monospace;
        }

        .speed-timer.warning {
            color: #ffc107;
            animation: pulse 0.5s ease infinite;
        }

        .speed-timer.danger {
            color: #f44336;
            animation: pulse 0.3s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .speed-score {
            text-align: center;
            padding: 10px;
            background: rgba(255, 87, 34, 0.2);
            border-radius: 10px;
        }

        .speed-score-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff5722;
        }

        .speed-score-label {
            font-size: 0.85rem;
            color: #aaa;
        }

        .speed-question {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .speed-question-text {
            color: #fff;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .speed-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .speed-option {
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 87, 34, 0.1);
            color: #ff8a65;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .speed-option:hover {
            border-color: #ff5722;
            background: rgba(255, 87, 34, 0.2);
        }

        .speed-option.correct {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4caf50;
            color: #81c784;
        }

        .speed-option.incorrect {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
            color: #ef9a9a;
        }

        .speed-start-screen {
            text-align: center;
        }

        .speed-difficulty-select {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 12px 25px;
            border-radius: 10px;
            border: 2px solid #ff5722;
            background: transparent;
            color: #ff5722;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .difficulty-btn:hover, .difficulty-btn.selected {
            background: #ff5722;
            color: white;
        }

        .speed-start-btn {
            padding: 15px 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, #ff5722 0%, #ff8a65 100%);
            color: white;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .speed-start-btn:hover {
            transform: scale(1.05);
        }

        .speed-results {
            text-align: center;
            padding: 20px;
        }

        .speed-results-score {
            font-size: 3rem;
            font-weight: bold;
            color: #ff5722;
            margin: 20px 0;
        }

        .speed-results-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .speed-stat {
            background: rgba(255, 87, 34, 0.1);
            border-radius: 10px;
            padding: 15px;
        }

        .speed-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff8a65;
        }

        .speed-stat-label {
            font-size: 0.85rem;
            color: #aaa;
        }

        /* Floating Buttons for Batch 45 */
        .floating-flashcards-btn {
            position: fixed;
            bottom: 3880px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8bc34a 0%, #aed581 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(139, 195, 74, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-flashcards-btn:hover {
            transform: scale(1.1);
        }

        .floating-paths-btn {
            position: fixed;
            bottom: 3940px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #673ab7 0%, #9575cd 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(103, 58, 183, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-paths-btn:hover {
            transform: scale(1.1);
        }

        .floating-speedquiz-btn {
            position: fixed;
            bottom: 4000px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff5722 0%, #ff8a65 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 87, 34, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-speedquiz-btn:hover {
            transform: scale(1.1);
        }

        /* ===== Batch 46 Styles: Daily Facts, Quiz Battle, Topic Summaries ===== */

        /* Daily Facts Modal */
        .daily-facts-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .daily-facts-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #00acc1;
        }

        .daily-facts-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .daily-facts-header h2 {
            color: #00acc1;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .fact-of-day {
            background: linear-gradient(135deg, rgba(0, 172, 193, 0.2) 0%, rgba(0, 188, 212, 0.2) 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
        }

        .fact-date {
            color: #00acc1;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .fact-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .fact-text {
            color: #fff;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .fact-category {
            color: #80deea;
            font-size: 0.85rem;
            margin-top: 15px;
            padding: 5px 15px;
            background: rgba(0, 172, 193, 0.3);
            border-radius: 20px;
            display: inline-block;
        }

        .fact-streak {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .fact-streak-item {
            text-align: center;
        }

        .fact-streak-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00acc1;
        }

        .fact-streak-label {
            font-size: 0.8rem;
            color: #aaa;
        }

        .past-facts {
            margin-top: 25px;
        }

        .past-facts-title {
            color: #00acc1;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .past-fact-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .past-fact-item p {
            color: #ccc;
            font-size: 0.9rem;
            margin: 0;
        }

        .past-fact-date {
            color: #888;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        /* Quiz Battle Modal */
        .quiz-battle-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .quiz-battle-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            position: relative;
            border: 2px solid #d32f2f;
        }

        .quiz-battle-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .quiz-battle-header h2 {
            color: #d32f2f;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .battle-players {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .battle-player {
            text-align: center;
            flex: 1;
        }

        .battle-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d32f2f 0%, #ef5350 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin: 0 auto 10px;
        }

        .battle-avatar.opponent {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
        }

        .battle-name {
            color: #ddd;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .battle-score {
            font-size: 2rem;
            font-weight: bold;
            color: #d32f2f;
        }

        .battle-score.opponent {
            color: #1976d2;
        }

        .battle-vs {
            font-size: 1.5rem;
            color: #ffc107;
            font-weight: bold;
        }

        .battle-question {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .battle-question-text {
            color: #fff;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .battle-options {
            display: grid;
            gap: 12px;
        }

        .battle-option {
            padding: 15px;
            border-radius: 10px;
            background: rgba(211, 47, 47, 0.1);
            color: #ef9a9a;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
            text-align: left;
        }

        .battle-option:hover {
            border-color: #d32f2f;
            background: rgba(211, 47, 47, 0.2);
        }

        .battle-result {
            text-align: center;
            padding: 30px;
        }

        .battle-result-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .battle-result-text {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .battle-result-text.win {
            color: #4caf50;
        }

        .battle-result-text.lose {
            color: #f44336;
        }

        .battle-result-text.draw {
            color: #ffc107;
        }

        .battle-start-btn {
            padding: 15px 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, #d32f2f 0%, #ef5350 100%);
            color: white;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .battle-start-btn:hover {
            transform: scale(1.05);
        }

        /* Topic Summaries Modal */
        .summaries-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .summaries-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #7b1fa2;
        }

        .summaries-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .summaries-header h2 {
            color: #7b1fa2;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .summary-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .summary-tab {
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(123, 31, 162, 0.2);
            color: #ce93d8;
            border: 1px solid #7b1fa2;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .summary-tab.active {
            background: #7b1fa2;
            color: white;
        }

        .summary-card {
            background: rgba(123, 31, 162, 0.1);
            border-radius: 15px;
            padding: 25px;
            border-left: 4px solid #7b1fa2;
        }

        .summary-title {
            color: #ce93d8;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-description {
            color: #ddd;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .summary-key-points {
            margin-bottom: 20px;
        }

        .summary-key-points h4 {
            color: #ba68c8;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .key-point {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .key-point-icon {
            color: #ba68c8;
            font-size: 1rem;
        }

        .key-point-text {
            color: #ccc;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .summary-examples h4 {
            color: #ba68c8;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .example-item {
            background: rgba(186, 104, 200, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #ddd;
        }

        /* Floating Buttons for Batch 46 */
        .floating-facts-btn {
            position: fixed;
            bottom: 4060px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00acc1 0%, #00bcd4 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 172, 193, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-facts-btn:hover {
            transform: scale(1.1);
        }

        .floating-battle-btn {
            position: fixed;
            bottom: 4120px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d32f2f 0%, #ef5350 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(211, 47, 47, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-battle-btn:hover {
            transform: scale(1.1);
        }

        .floating-summaries-btn {
            position: fixed;
            bottom: 4180px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(123, 31, 162, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-summaries-btn:hover {
            transform: scale(1.1);
        }

        /* ===== Batch 47 Styles: Achievement Badges, Word Search, Topic Quizzes ===== */

        /* Achievement Badges Modal */
        .badges-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .badges-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #ffd700;
        }

        .badges-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .badges-header h2 {
            color: #ffd700;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .badges-progress {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 25px;
        }

        .badges-count {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd700;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .badge-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .badge-item.unlocked {
            background: rgba(255, 215, 0, 0.15);
            border: 2px solid #ffd700;
        }

        .badge-item.locked {
            opacity: 0.5;
            filter: grayscale(100%);
        }

        .badge-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .badge-name {
            color: #ffd700;
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .badge-desc {
            color: #aaa;
            font-size: 0.75rem;
            line-height: 1.3;
        }

        .badge-lock-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1rem;
        }

        /* Word Search Modal */
        .wordsearch-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .wordsearch-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            position: relative;
            border: 2px solid #26a69a;
        }

        .wordsearch-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .wordsearch-header h2 {
            color: #26a69a;
            font-size: 1.6rem;
            margin-bottom: 10px;
        }

        .wordsearch-grid {
            display: grid;
            gap: 3px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .wordsearch-cell {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(38, 166, 154, 0.2);
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .wordsearch-cell:hover {
            background: rgba(38, 166, 154, 0.4);
        }

        .wordsearch-cell.selected {
            background: #26a69a;
            color: white;
        }

        .wordsearch-cell.found {
            background: #4caf50;
            color: white;
        }

        .wordsearch-words {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .wordsearch-word {
            padding: 5px 12px;
            background: rgba(38, 166, 154, 0.2);
            border-radius: 15px;
            color: #80cbc4;
            font-size: 0.85rem;
        }

        .wordsearch-word.found {
            background: #4caf50;
            color: white;
            text-decoration: line-through;
        }

        .wordsearch-score {
            text-align: center;
            color: #aaa;
            font-size: 0.9rem;
        }

        .wordsearch-btn {
            padding: 12px 25px;
            border-radius: 10px;
            background: linear-gradient(135deg, #26a69a 0%, #4db6ac 100%);
            color: white;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            display: block;
            margin: 15px auto 0;
            transition: all 0.3s ease;
        }

        .wordsearch-btn:hover {
            transform: scale(1.05);
        }

        /* Topic Quiz Modal */
        .topicquiz-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .topicquiz-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #5c6bc0;
        }

        .topicquiz-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .topicquiz-header h2 {
            color: #5c6bc0;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .topic-select-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .topic-select-btn {
            padding: 20px 15px;
            border-radius: 12px;
            background: rgba(92, 107, 192, 0.15);
            color: #9fa8da;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-align: center;
        }

        .topic-select-btn:hover {
            border-color: #5c6bc0;
            background: rgba(92, 107, 192, 0.25);
        }

        .topic-select-btn.selected {
            border-color: #5c6bc0;
            background: rgba(92, 107, 192, 0.3);
        }

        .topic-select-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .topicquiz-question {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .topicquiz-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .topicquiz-question-text {
            color: #fff;
            font-size: 1.1rem;
            line-height: 1.5;
            text-align: center;
        }

        .topicquiz-options {
            display: grid;
            gap: 12px;
        }

        .topicquiz-option {
            padding: 15px;
            border-radius: 10px;
            background: rgba(92, 107, 192, 0.1);
            color: #9fa8da;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .topicquiz-option:hover {
            border-color: #5c6bc0;
            background: rgba(92, 107, 192, 0.2);
        }

        .topicquiz-result {
            text-align: center;
            padding: 25px;
        }

        .topicquiz-result-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .topicquiz-result-score {
            font-size: 2.5rem;
            font-weight: bold;
            color: #5c6bc0;
            margin-bottom: 10px;
        }

        .topicquiz-start-btn {
            padding: 15px 35px;
            border-radius: 12px;
            background: linear-gradient(135deg, #5c6bc0 0%, #7986cb 100%);
            color: white;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 20px auto 0;
        }

        .topicquiz-start-btn:hover {
            transform: scale(1.05);
        }

        /* Floating Buttons for Batch 47 */
        .floating-badges-btn {
            position: fixed;
            bottom: 4240px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffeb3b 100%);
            color: #333;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-badges-btn:hover {
            transform: scale(1.1);
        }

        .floating-wordsearch-btn {
            position: fixed;
            bottom: 4300px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #26a69a 0%, #4db6ac 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(38, 166, 154, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-wordsearch-btn:hover {
            transform: scale(1.1);
        }

        .floating-topicquiz-btn {
            position: fixed;
            bottom: 4360px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5c6bc0 0%, #7986cb 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(92, 107, 192, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-topicquiz-btn:hover {
            transform: scale(1.1);
        }

        /* ===== Batch 48 Styles: Science Riddles, Focus Mode, Quick Tips ===== */

        /* Science Riddles Modal */
        .riddles-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .riddles-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            position: relative;
            border: 2px solid #ab47bc;
        }

        .riddles-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .riddles-header h2 {
            color: #ab47bc;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .riddle-card {
            background: rgba(171, 71, 188, 0.15);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }

        .riddle-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .riddle-question {
            color: #fff;
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 20px;
            font-style: italic;
        }

        .riddle-hint {
            color: #ce93d8;
            font-size: 0.9rem;
            margin-bottom: 20px;
            display: none;
        }

        .riddle-hint.show {
            display: block;
        }

        .riddle-answer {
            background: rgba(171, 71, 188, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .riddle-answer.show {
            display: block;
        }

        .riddle-answer-label {
            color: #ce93d8;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .riddle-answer-text {
            color: #fff;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .riddle-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .riddle-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .riddle-btn.hint {
            background: rgba(171, 71, 188, 0.3);
            color: #ce93d8;
        }

        .riddle-btn.reveal {
            background: linear-gradient(135deg, #ab47bc 0%, #ce93d8 100%);
            color: white;
        }

        .riddle-btn.next {
            background: rgba(76, 175, 80, 0.3);
            color: #81c784;
        }

        .riddle-btn:hover {
            transform: scale(1.05);
        }

        .riddle-progress {
            text-align: center;
            color: #aaa;
            font-size: 0.9rem;
            margin-top: 15px;
        }

        /* Focus Mode */
        .focus-mode-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            z-index: 9998;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .focus-mode-overlay.active {
            display: flex;
        }

        .focus-mode-content {
            text-align: center;
            max-width: 600px;
            padding: 40px;
        }

        .focus-timer-display {
            font-size: 5rem;
            font-weight: bold;
            color: #58a6ff;
            font-family: monospace;
            margin-bottom: 20px;
        }

        .focus-message {
            color: #8b949e;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .focus-stats {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .focus-stat {
            text-align: center;
        }

        .focus-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #58a6ff;
        }

        .focus-stat-label {
            font-size: 0.9rem;
            color: #8b949e;
        }

        .focus-exit-btn {
            padding: 12px 30px;
            border-radius: 10px;
            background: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
            border: 1px solid #58a6ff;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .focus-exit-btn:hover {
            background: #58a6ff;
            color: white;
        }

        .focus-toggle-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 12px 20px;
            border-radius: 25px;
            background: linear-gradient(135deg, #58a6ff 0%, #79c0ff 100%);
            color: white;
            border: none;
            font-size: 0.95rem;
            cursor: pointer;
            z-index: 998;
            box-shadow: 0 5px 20px rgba(88, 166, 255, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .focus-toggle-btn:hover {
            transform: scale(1.05);
        }

        /* Quick Tips Modal */
        .tips-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .tips-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #ff7043;
        }

        .tips-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .tips-header h2 {
            color: #ff7043;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .tip-card {
            background: rgba(255, 112, 67, 0.15);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #ff7043;
        }

        .tip-category {
            color: #ffab91;
            font-size: 0.8rem;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .tip-title {
            color: #ff7043;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .tip-text {
            color: #ddd;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .tips-category-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tips-tab {
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 112, 67, 0.2);
            color: #ff7043;
            border: 1px solid #ff7043;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .tips-tab.active {
            background: #ff7043;
            color: white;
        }

        /* Floating Buttons for Batch 48 */
        .floating-riddles-btn {
            position: fixed;
            bottom: 4420px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ab47bc 0%, #ce93d8 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(171, 71, 188, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-riddles-btn:hover {
            transform: scale(1.1);
        }

        .floating-tips-btn {
            position: fixed;
            bottom: 4480px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff7043 0%, #ffab91 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 112, 67, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-tips-btn:hover {
            transform: scale(1.1);
        }

        /* ===== Batch 49 Styles: Matching Game, Progress Report, Reference Cards ===== */

        /* Matching Game Modal */
        .matching-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .matching-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            position: relative;
            border: 2px solid #ec407a;
        }

        .matching-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .matching-header h2 {
            color: #ec407a;
            font-size: 1.6rem;
            margin-bottom: 8px;
        }

        .matching-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }

        .matching-stat {
            text-align: center;
        }

        .matching-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ec407a;
        }

        .matching-stat-label {
            font-size: 0.8rem;
            color: #aaa;
        }

        .matching-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .matching-card {
            aspect-ratio: 1;
            border-radius: 10px;
            background: rgba(236, 64, 122, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.85rem;
            color: transparent;
            transition: all 0.3s ease;
            padding: 8px;
            text-align: center;
            font-weight: bold;
        }

        .matching-card.flipped {
            background: #ec407a;
            color: white;
        }

        .matching-card.matched {
            background: #4caf50;
            color: white;
            cursor: default;
        }

        .matching-btn {
            padding: 12px 25px;
            border-radius: 10px;
            background: linear-gradient(135deg, #ec407a 0%, #f48fb1 100%);
            color: white;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            display: block;
            margin: 20px auto 0;
            transition: all 0.3s ease;
        }

        .matching-btn:hover {
            transform: scale(1.05);
        }

        /* Progress Report Modal */
        .progress-report-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .progress-report-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #42a5f5;
        }

        .progress-report-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .progress-report-header h2 {
            color: #42a5f5;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .report-section {
            background: rgba(66, 165, 245, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .report-section-title {
            color: #64b5f6;
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .report-stat-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .report-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #42a5f5;
        }

        .report-stat-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
        }

        .report-chart {
            height: 150px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            gap: 8px;
            padding: 20px 10px 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-top: 15px;
        }

        .chart-bar {
            width: 30px;
            background: linear-gradient(to top, #42a5f5, #90caf9);
            border-radius: 5px 5px 0 0;
            position: relative;
            min-height: 10px;
        }

        .chart-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: #aaa;
        }

        /* Reference Cards Modal */
        .reference-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .reference-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #66bb6a;
        }

        .reference-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .reference-header h2 {
            color: #66bb6a;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .reference-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .reference-tab {
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(102, 187, 106, 0.2);
            color: #66bb6a;
            border: 1px solid #66bb6a;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .reference-tab.active {
            background: #66bb6a;
            color: white;
        }

        .reference-card {
            background: rgba(102, 187, 106, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #66bb6a;
        }

        .reference-card-title {
            color: #81c784;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .reference-formula {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 1.1rem;
            color: #a5d6a7;
            text-align: center;
        }

        .reference-explanation {
            color: #ddd;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .reference-example {
            background: rgba(102, 187, 106, 0.15);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #c8e6c9;
        }

        /* Floating Buttons for Batch 49 */
        .floating-matching-btn {
            position: fixed;
            bottom: 4540px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ec407a 0%, #f48fb1 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(236, 64, 122, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-matching-btn:hover {
            transform: scale(1.1);
        }

        .floating-report-btn {
            position: fixed;
            bottom: 4600px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #42a5f5 0%, #90caf9 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(66, 165, 245, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-report-btn:hover {
            transform: scale(1.1);
        }

        .floating-reference-btn {
            position: fixed;
            bottom: 4660px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #66bb6a 0%, #a5d6a7 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 187, 106, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-reference-btn:hover {
            transform: scale(1.1);
        }

        /* ========== Batch 50: Crossword, Mistake Review, Sound Toggle ========== */

        /* Crossword Puzzle Styles */
        .crossword-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .crossword-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 700px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .crossword-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .crossword-header h2 {
            color: #ff9800;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .crossword-grid {
            display: grid;
            gap: 2px;
            background: #333;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .crossword-cell {
            width: 35px;
            height: 35px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            text-transform: uppercase;
            border: none;
            background: #2a2a2a;
            color: #fff;
            outline: none;
        }

        .crossword-cell:focus {
            background: #ff9800;
            color: #000;
        }

        .crossword-cell.blocked {
            background: #111;
            pointer-events: none;
        }

        .crossword-cell.correct {
            background: #4caf50;
            color: white;
        }

        .crossword-cell.number {
            position: relative;
        }

        .crossword-cell::placeholder {
            color: rgba(255, 255, 255, 0.3);
            font-size: 0.7rem;
        }

        .crossword-clues {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .clues-section h3 {
            color: #ff9800;
            font-size: 1rem;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255, 152, 0, 0.3);
            padding-bottom: 5px;
        }

        .clue-item {
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clue-item:hover {
            background: rgba(255, 152, 0, 0.2);
        }

        .clue-item.solved {
            background: rgba(76, 175, 80, 0.3);
            text-decoration: line-through;
        }

        .crossword-check-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        /* Mistake Review Styles */
        .mistake-review-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .mistake-review-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .mistake-review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .mistake-review-header h2 {
            color: #f44336;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mistake-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .mistake-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .mistake-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #f44336;
        }

        .mistake-stat-label {
            font-size: 0.8rem;
            color: #999;
        }

        .mistake-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .mistake-item {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .mistake-question {
            color: #fff;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .mistake-answers {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
        }

        .mistake-your-answer {
            color: #ef5350;
        }

        .mistake-correct-answer {
            color: #66bb6a;
        }

        .mistake-practice-btn {
            background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 10px;
        }

        .no-mistakes {
            text-align: center;
            padding: 40px;
            color: #66bb6a;
        }

        .no-mistakes-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Sound Toggle Styles */
        .sound-toggle-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .sound-toggle-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 95%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(156, 39, 176, 0.3);
        }

        .sound-toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .sound-toggle-header h2 {
            color: #9c27b0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sound-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .sound-option-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sound-option-icon {
            font-size: 1.5rem;
        }

        .sound-option-label {
            color: #fff;
            font-weight: 500;
        }

        .sound-option-desc {
            color: #888;
            font-size: 0.8rem;
        }

        .sound-toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .sound-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .sound-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #444;
            transition: 0.3s;
            border-radius: 26px;
        }

        .sound-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .sound-toggle-switch input:checked + .sound-slider {
            background: #9c27b0;
        }

        .sound-toggle-switch input:checked + .sound-slider:before {
            transform: translateX(24px);
        }

        .volume-control {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .volume-label {
            color: #fff;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .volume-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #444;
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #9c27b0;
            cursor: pointer;
        }

        .sound-test-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        /* Floating Buttons for Batch 50 */
        .floating-crossword-btn {
            position: fixed;
            bottom: 4720px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 152, 0, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-crossword-btn:hover {
            transform: scale(1.1);
        }

        .floating-mistakes-btn {
            position: fixed;
            bottom: 4780px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-mistakes-btn:hover {
            transform: scale(1.1);
        }

        .floating-sound-btn {
            position: fixed;
            bottom: 4840px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(156, 39, 176, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-sound-btn:hover {
            transform: scale(1.1);
        }

        /* ========== Batch 51: Study Scheduler, Concept Map, Bookmarks ========== */

        /* Study Scheduler Styles */
        .scheduler-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .scheduler-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 550px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 188, 212, 0.3);
        }

        .scheduler-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .scheduler-header h2 {
            color: #00bcd4;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scheduler-form {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .scheduler-form label {
            display: block;
            color: #00bcd4;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .scheduler-form input,
        .scheduler-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(0, 188, 212, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .scheduler-form input:focus,
        .scheduler-form select:focus {
            outline: none;
            border-color: #00bcd4;
        }

        .add-schedule-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #00bcd4 0%, #4dd0e1 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .schedule-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .schedule-item {
            background: rgba(0, 188, 212, 0.1);
            border: 1px solid rgba(0, 188, 212, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .schedule-info {
            flex: 1;
        }

        .schedule-topic {
            color: #4dd0e1;
            font-weight: bold;
            font-size: 1rem;
        }

        .schedule-time {
            color: #888;
            font-size: 0.85rem;
        }

        .schedule-delete {
            background: rgba(244, 67, 54, 0.2);
            border: none;
            color: #ef5350;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
        }

        /* Concept Map Styles */
        .concept-map-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .concept-map-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(233, 30, 99, 0.3);
        }

        .concept-map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .concept-map-header h2 {
            color: #e91e63;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .concept-topic-select {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .concept-topic-btn {
            padding: 8px 16px;
            border: 1px solid rgba(233, 30, 99, 0.3);
            border-radius: 20px;
            background: rgba(233, 30, 99, 0.1);
            color: #f48fb1;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .concept-topic-btn.active {
            background: linear-gradient(135deg, #e91e63 0%, #f48fb1 100%);
            color: white;
        }

        .concept-map-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            min-height: 350px;
            position: relative;
        }

        .concept-node {
            display: inline-block;
            padding: 12px 20px;
            background: linear-gradient(135deg, #e91e63 0%, #f48fb1 100%);
            color: white;
            border-radius: 25px;
            font-weight: bold;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .concept-node:hover {
            transform: scale(1.1);
        }

        .concept-node.main {
            font-size: 1.2rem;
            background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
        }

        .concept-node.sub {
            font-size: 0.9rem;
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
        }

        .concept-details {
            margin-top: 20px;
            padding: 15px;
            background: rgba(233, 30, 99, 0.1);
            border-radius: 10px;
            display: none;
        }

        .concept-details.show {
            display: block;
        }

        .concept-details h4 {
            color: #f48fb1;
            margin-bottom: 10px;
        }

        .concept-details p {
            color: #ddd;
            line-height: 1.6;
        }

        /* Bookmark System Styles */
        .bookmark-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .bookmark-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 550px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .bookmark-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .bookmark-header h2 {
            color: #ffc107;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bookmark-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .bookmark-stat {
            flex: 1;
            background: rgba(255, 193, 7, 0.1);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .bookmark-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffc107;
        }

        .bookmark-stat-label {
            font-size: 0.75rem;
            color: #888;
        }

        .bookmark-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .bookmark-item {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .bookmark-question {
            color: #fff;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        .bookmark-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bookmark-topic {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .bookmark-actions {
            display: flex;
            gap: 8px;
        }

        .bookmark-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .bookmark-goto {
            background: linear-gradient(135deg, #4caf50 0%, #81c784 100%);
            color: white;
        }

        .bookmark-remove {
            background: rgba(244, 67, 54, 0.3);
            color: #ef5350;
        }

        .no-bookmarks {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .no-bookmarks-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Floating Buttons for Batch 51 */
        .floating-scheduler-btn {
            position: fixed;
            bottom: 4900px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bcd4 0%, #4dd0e1 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 188, 212, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-scheduler-btn:hover {
            transform: scale(1.1);
        }

        .floating-concept-btn {
            position: fixed;
            bottom: 4960px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63 0%, #f48fb1 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(233, 30, 99, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-concept-btn:hover {
            transform: scale(1.1);
        }

        .floating-bookmark-btn {
            position: fixed;
            bottom: 5020px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffc107 0%, #ffca28 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 193, 7, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-bookmark-btn:hover {
            transform: scale(1.1);
        }

        /* ========== Batch 52: Scoreboard, Question Timer, Motivation Quotes ========== */

        /* Scoreboard Styles */
        .scoreboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .scoreboard-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .scoreboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .scoreboard-header h2 {
            color: #ffd700;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scoreboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .scoreboard-tab {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            background: rgba(255, 215, 0, 0.1);
            color: #ffd700;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .scoreboard-tab.active {
            background: linear-gradient(135deg, #ffd700 0%, #ffeb3b 100%);
            color: #000;
            font-weight: bold;
        }

        .score-entry {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 215, 0, 0.05);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .score-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            margin-right: 15px;
        }

        .score-rank.gold {
            background: linear-gradient(135deg, #ffd700 0%, #ffeb3b 100%);
            color: #000;
        }

        .score-rank.silver {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            color: #000;
        }

        .score-rank.bronze {
            background: linear-gradient(135deg, #cd7f32 0%, #dda15e 100%);
            color: #fff;
        }

        .score-rank.normal {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .score-info {
            flex: 1;
        }

        .score-name {
            color: #fff;
            font-weight: 500;
        }

        .score-date {
            color: #666;
            font-size: 0.8rem;
        }

        .score-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffd700;
        }

        /* Question Timer Styles */
        .question-timer {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #4caf50;
            border: 3px solid #4caf50;
        }

        .question-timer.warning {
            color: #ff9800;
            border-color: #ff9800;
            animation: timer-pulse 0.5s ease-in-out infinite;
        }

        .question-timer.danger {
            color: #f44336;
            border-color: #f44336;
            animation: timer-pulse 0.3s ease-in-out infinite;
        }

        @keyframes timer-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Motivation Quotes Styles */
        .motivation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .motivation-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 95%;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .motivation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .motivation-header h2 {
            color: #4caf50;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quote-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .quote-text {
            font-size: 1.3rem;
            color: #fff;
            line-height: 1.6;
            font-style: italic;
            margin-bottom: 20px;
        }

        .quote-author {
            color: #81c784;
            font-size: 1rem;
        }

        .quote-category {
            display: inline-block;
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.85rem;
            margin-top: 15px;
        }

        .new-quote-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #4caf50 0%, #81c784 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Floating Buttons for Batch 52 */
        .floating-scoreboard-btn {
            position: fixed;
            bottom: 5080px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffeb3b 100%);
            color: #000;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-scoreboard-btn:hover {
            transform: scale(1.1);
        }

        .floating-motivation-btn {
            position: fixed;
            bottom: 5140px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4caf50 0%, #81c784 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-motivation-btn:hover {
            transform: scale(1.1);
        }

        /* ========== Batch 53: Study Notes, Hint System, Topic Progress ========== */

        /* Study Notes Styles */
        .notes-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .notes-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 183, 77, 0.3);
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .notes-header h2 {
            color: #ffb74d;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .note-editor {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 183, 77, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .note-title-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-bottom: 1px solid rgba(255, 183, 77, 0.3);
            background: transparent;
            color: #ffb74d;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .note-title-input::placeholder {
            color: rgba(255, 183, 77, 0.5);
        }

        .note-text-input {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: none;
            background: transparent;
            color: #fff;
            font-size: 0.95rem;
            resize: vertical;
            line-height: 1.5;
        }

        .note-text-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .save-note-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ffb74d 0%, #ffd54f 100%);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .notes-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .note-item {
            background: rgba(255, 183, 77, 0.1);
            border: 1px solid rgba(255, 183, 77, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .note-item-title {
            color: #ffb74d;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .note-item-text {
            color: #ddd;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .note-item-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .note-item-date {
            color: #888;
        }

        .note-delete-btn {
            background: rgba(244, 67, 54, 0.3);
            color: #ef5350;
            border: none;
            padding: 4px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* Hint System Styles */
        .hint-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #2196f3 0%, #64b5f6 100%);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        .hint-btn:hover {
            transform: scale(1.05);
        }

        .hint-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .hint-display {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }

        .hint-display.show {
            display: block;
            animation: hint-fade-in 0.3s ease;
        }

        @keyframes hint-fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hint-icon {
            font-size: 1.2rem;
            margin-right: 8px;
        }

        .hint-text {
            color: #64b5f6;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .hint-cost {
            color: #888;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        /* Topic Progress Styles */
        .progress-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .progress-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 550px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(103, 58, 183, 0.3);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .progress-header h2 {
            color: #b39ddb;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .overall-progress {
            background: rgba(103, 58, 183, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .overall-percent {
            font-size: 2.5rem;
            font-weight: bold;
            color: #b39ddb;
        }

        .overall-label {
            color: #888;
            font-size: 0.9rem;
        }

        .topic-progress-item {
            margin-bottom: 15px;
        }

        .topic-progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .topic-progress-name {
            color: #fff;
            font-weight: 500;
        }

        .topic-progress-percent {
            color: #b39ddb;
            font-weight: bold;
        }

        .topic-progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .topic-progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .topic-progress-fill.matter { background: linear-gradient(90deg, #4caf50 0%, #81c784 100%); }
        .topic-progress-fill.heat { background: linear-gradient(90deg, #ff9800 0%, #ffb74d 100%); }
        .topic-progress-fill.light { background: linear-gradient(90deg, #ffeb3b 0%, #fff176 100%); }
        .topic-progress-fill.energy { background: linear-gradient(90deg, #2196f3 0%, #64b5f6 100%); }
        .topic-progress-fill.forces { background: linear-gradient(90deg, #e91e63 0%, #f48fb1 100%); }
        .topic-progress-fill.life { background: linear-gradient(90deg, #00bcd4 0%, #4dd0e1 100%); }
        .topic-progress-fill.plants { background: linear-gradient(90deg, #8bc34a 0%, #aed581 100%); }

        /* Floating Buttons for Batch 53 */
        .floating-notes-btn {
            position: fixed;
            bottom: 5200px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffb74d 0%, #ffd54f 100%);
            color: #000;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 183, 77, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-notes-btn:hover {
            transform: scale(1.1);
        }

        .floating-progress-btn {
            position: fixed;
            bottom: 5260px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #673ab7 0%, #9575cd 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(103, 58, 183, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-progress-btn:hover {
            transform: scale(1.1);
        }

        /* ========== Batch 54: Dictionary, Practice Mode, Streak Calendar ========== */

        /* Science Dictionary Styles */
        .dictionary-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .dictionary-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 550px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 150, 136, 0.3);
        }

        .dictionary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .dictionary-header h2 {
            color: #26a69a;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dictionary-search {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(0, 150, 136, 0.3);
            border-radius: 25px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .dictionary-search:focus {
            outline: none;
            border-color: #26a69a;
        }

        .dictionary-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .dictionary-item {
            background: rgba(0, 150, 136, 0.1);
            border: 1px solid rgba(0, 150, 136, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dictionary-item:hover {
            background: rgba(0, 150, 136, 0.2);
        }

        .dictionary-term {
            color: #26a69a;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .dictionary-definition {
            color: #ddd;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .dictionary-category {
            display: inline-block;
            background: rgba(0, 150, 136, 0.3);
            color: #80cbc4;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-top: 8px;
        }

        /* Practice Mode Styles */
        .practice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .practice-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(63, 81, 181, 0.3);
        }

        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .practice-header h2 {
            color: #7986cb;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .practice-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .practice-stat {
            flex: 1;
            background: rgba(63, 81, 181, 0.1);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .practice-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #7986cb;
        }

        .practice-stat-label {
            font-size: 0.75rem;
            color: #888;
        }

        .practice-question-box {
            background: rgba(63, 81, 181, 0.1);
            border: 1px solid rgba(63, 81, 181, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .practice-question {
            color: #fff;
            font-size: 1.1rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .practice-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .practice-option {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .practice-option:hover {
            background: rgba(63, 81, 181, 0.3);
        }

        .practice-option.correct {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4caf50;
        }

        .practice-option.wrong {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
        }

        .practice-next-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3f51b5 0%, #7986cb 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }

        /* Streak Calendar Styles */
        .calendar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .calendar-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 95%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 87, 34, 0.3);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header h2 {
            color: #ff7043;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .streak-summary {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .streak-box {
            flex: 1;
            background: rgba(255, 87, 34, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .streak-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ff7043;
        }

        .streak-label {
            font-size: 0.8rem;
            color: #888;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            color: #888;
            font-size: 0.75rem;
            padding: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #666;
            background: rgba(255, 255, 255, 0.05);
        }

        .calendar-day.active {
            background: linear-gradient(135deg, #ff7043 0%, #ffab91 100%);
            color: white;
            font-weight: bold;
        }

        .calendar-day.today {
            border: 2px solid #ff7043;
        }

        .calendar-day.inactive {
            opacity: 0.3;
        }

        /* Floating Buttons for Batch 54 */
        .floating-dictionary-btn {
            position: fixed;
            bottom: 5320px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #009688 0%, #4db6ac 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 150, 136, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-dictionary-btn:hover {
            transform: scale(1.1);
        }

        .floating-practice-btn {
            position: fixed;
            bottom: 5380px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3f51b5 0%, #7986cb 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(63, 81, 181, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-practice-btn:hover {
            transform: scale(1.1);
        }

        .floating-calendar-btn {
            position: fixed;
            bottom: 5440px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff5722 0%, #ff8a65 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 87, 34, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-calendar-btn:hover {
            transform: scale(1.1);
        }

        /* ========== Batch 55: Quick Review, Answer Explanation, Parent Report ========== */

        /* Quick Review Styles */
        .quick-review-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .quick-review-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 95%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(233, 30, 99, 0.3);
        }

        .quick-review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .quick-review-header h2 {
            color: #ec407a;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .review-progress {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .review-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }

        .review-dot.done {
            background: #ec407a;
        }

        .review-dot.current {
            background: #fff;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .review-card {
            background: rgba(233, 30, 99, 0.1);
            border: 1px solid rgba(233, 30, 99, 0.3);
            border-radius: 15px;
            padding: 25px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .review-card:hover {
            transform: scale(1.02);
        }

        .review-front {
            color: #fff;
            font-size: 1.2rem;
            line-height: 1.5;
        }

        .review-back {
            display: none;
            color: #f48fb1;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .review-card.flipped .review-front {
            display: none;
        }

        .review-card.flipped .review-back {
            display: block;
        }

        .review-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .review-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .review-btn.know {
            background: linear-gradient(135deg, #4caf50 0%, #81c784 100%);
            color: white;
        }

        .review-btn.learn {
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
            color: white;
        }

        /* Answer Explanation Styles */
        .explanation-box {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .explanation-box.show {
            display: block;
            animation: explanation-fade 0.3s ease;
        }

        @keyframes explanation-fade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .explanation-title {
            color: #64b5f6;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .explanation-text {
            color: #ddd;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* Parent Report Styles */
        .report-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .report-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .report-header h2 {
            color: #81c784;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .report-section {
            background: rgba(76, 175, 80, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .report-section-title {
            color: #81c784;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .report-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .report-stat-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
        }

        .report-stat-label {
            color: #888;
            font-size: 0.8rem;
        }

        .report-stat-value {
            color: #fff;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .export-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #4caf50 0%, #81c784 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        .email-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        /* Floating Buttons for Batch 55 */
        .floating-review-btn {
            position: fixed;
            bottom: 5500px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63 0%, #f48fb1 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(233, 30, 99, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-review-btn:hover {
            transform: scale(1.1);
        }

        .floating-report-parent-btn {
            position: fixed;
            bottom: 5560px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4caf50 0%, #81c784 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-report-parent-btn:hover {
            transform: scale(1.1);
        }

        /* ========== Batch 56: Timed Challenge, Learning Reminders, Science News ========== */

        /* Timed Challenge Styles */
        .challenge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .challenge-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 550px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 64, 129, 0.3);
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .challenge-header h2 {
            color: #ff4081;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .challenge-timer-display {
            font-size: 3rem;
            font-weight: bold;
            color: #ff4081;
            text-align: center;
            margin-bottom: 20px;
        }

        .challenge-timer-display.warning {
            color: #ff9800;
            animation: timer-blink 0.5s ease-in-out infinite;
        }

        .challenge-timer-display.danger {
            color: #f44336;
            animation: timer-blink 0.3s ease-in-out infinite;
        }

        @keyframes timer-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .challenge-score {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }

        .challenge-score-item {
            text-align: center;
        }

        .challenge-score-value {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
        }

        .challenge-score-label {
            font-size: 0.85rem;
            color: #888;
        }

        .challenge-question-area {
            background: rgba(255, 64, 129, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .challenge-start-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ff4081 0%, #ff80ab 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
        }

        /* Learning Reminders Styles */
        .reminder-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .reminder-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 95%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .reminder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .reminder-header h2 {
            color: #ffb74d;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .reminder-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 152, 0, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .reminder-option-label {
            color: #fff;
            font-weight: 500;
        }

        .reminder-option-desc {
            color: #888;
            font-size: 0.8rem;
        }

        .reminder-time-select {
            padding: 8px 15px;
            border: 1px solid rgba(255, 152, 0, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 0.9rem;
        }

        .enable-reminder-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        /* Science News Styles */
        .news-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .news-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .news-header h2 {
            color: #81c784;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .news-item {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .news-category {
            display: inline-block;
            background: rgba(76, 175, 80, 0.3);
            color: #a5d6a7;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-bottom: 10px;
        }

        .news-title {
            color: #81c784;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .news-text {
            color: #ddd;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .news-source {
            color: #888;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        /* Floating Buttons for Batch 56 */
        .floating-challenge-btn {
            position: fixed;
            bottom: 5620px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff4081 0%, #ff80ab 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 64, 129, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-challenge-btn:hover {
            transform: scale(1.1);
        }

        .floating-reminder-btn {
            position: fixed;
            bottom: 5680px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 152, 0, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-reminder-btn:hover {
            transform: scale(1.1);
        }

        .floating-news-btn {
            position: fixed;
            bottom: 5740px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4caf50 0%, #81c784 100%);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .floating-news-btn:hover {
            transform: scale(1.1);
        }

        /* ===== BATCH 57: Learning Pathways, Word Scramble, Study Goals ===== */

        /* Learning Pathways Button */
        .learning-pathways-btn {
            position: fixed;
            bottom: 490px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #7b1fa2, #9c27b0);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(156, 39, 176, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .learning-pathways-btn:hover {
            transform: scale(1.1);
        }

        /* Word Scramble Button */
        .word-scramble-btn {
            position: fixed;
            bottom: 550px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #00796b, #009688);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 150, 136, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .word-scramble-btn:hover {
            transform: scale(1.1);
        }

        /* Study Goals Button */
        .study-goals-btn {
            position: fixed;
            bottom: 610px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #c62828, #e53935);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(229, 57, 53, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .study-goals-btn:hover {
            transform: scale(1.1);
        }

        /* Learning Pathways Modal */
        .learning-pathways-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .learning-pathways-modal.active {
            display: flex;
        }

        .learning-pathways-content {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .learning-pathways-header {
            background: linear-gradient(135deg, #7b1fa2, #9c27b0);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .learning-pathways-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close-learning-pathways {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .pathways-body {
            padding: 20px;
        }

        .pathway-card {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pathway-card:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 20px rgba(156, 39, 176, 0.2);
        }

        .pathway-card.completed {
            background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
        }

        .pathway-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .pathway-icon {
            font-size: 2rem;
        }

        .pathway-info h4 {
            margin: 0 0 5px 0;
            color: #7b1fa2;
        }

        .pathway-progress-bar {
            background: rgba(0, 0, 0, 0.1);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .pathway-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7b1fa2, #9c27b0);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .pathway-steps {
            margin-top: 15px;
            padding-left: 20px;
        }

        .pathway-step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
        }

        .step-status {
            font-size: 1.2rem;
        }

        .step-name {
            flex: 1;
        }

        /* Word Scramble Modal */
        .word-scramble-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .word-scramble-modal.active {
            display: flex;
        }

        .word-scramble-content {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .word-scramble-header {
            background: linear-gradient(135deg, #00796b, #009688);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .word-scramble-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close-word-scramble {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .scramble-body {
            padding: 20px;
            text-align: center;
        }

        .scramble-score {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 15px;
            background: #e0f2f1;
            border-radius: 10px;
        }

        .score-item {
            text-align: center;
        }

        .score-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00796b;
        }

        .score-label {
            font-size: 0.8rem;
            color: #666;
        }

        .scrambled-word {
            font-size: 2.5rem;
            font-weight: bold;
            letter-spacing: 10px;
            color: #009688;
            padding: 30px;
            background: linear-gradient(135deg, #e0f2f1, #b2dfdb);
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .scramble-hint {
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
            margin-bottom: 15px;
        }

        .scramble-input-container {
            margin-bottom: 20px;
        }

        .scramble-input {
            width: 80%;
            padding: 15px;
            font-size: 1.2rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 5px;
            border: 3px solid #009688;
            border-radius: 10px;
            outline: none;
        }

        .scramble-input:focus {
            border-color: #00796b;
            box-shadow: 0 0 10px rgba(0, 150, 136, 0.3);
        }

        .scramble-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #00796b, #009688);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .scramble-btn:hover {
            transform: scale(1.05);
        }

        .scramble-feedback {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: bold;
        }

        .scramble-feedback.correct {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .scramble-feedback.incorrect {
            background: #ffcdd2;
            color: #c62828;
        }

        /* Study Goals Modal */
        .study-goals-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .study-goals-modal.active {
            display: flex;
        }

        .study-goals-content {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .study-goals-header {
            background: linear-gradient(135deg, #c62828, #e53935);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .study-goals-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close-study-goals {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .goals-body {
            padding: 20px;
        }

        .goal-setter {
            background: #ffebee;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .goal-setter h4 {
            margin: 0 0 15px 0;
            color: #c62828;
        }

        .goal-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .goal-input-row select,
        .goal-input-row input {
            padding: 10px;
            border: 2px solid #ffcdd2;
            border-radius: 8px;
            flex: 1;
            min-width: 100px;
        }

        .add-goal-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #c62828, #e53935);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-goal-btn:hover {
            transform: scale(1.05);
        }

        .goals-list {
            margin-top: 20px;
        }

        .goal-card {
            background: white;
            border: 2px solid #ffcdd2;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .goal-card.completed {
            background: #c8e6c9;
            border-color: #a5d6a7;
        }

        .goal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .goal-type-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .goal-type-badge.daily {
            background: #fff3e0;
            color: #e65100;
        }

        .goal-type-badge.weekly {
            background: #e3f2fd;
            color: #1565c0;
        }

        .goal-progress-text {
            font-size: 1.2rem;
            font-weight: bold;
            color: #c62828;
        }

        .goal-description {
            font-size: 0.95rem;
            color: #333;
            margin-bottom: 10px;
        }

        .goal-progress-container {
            background: #ffcdd2;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
        }

        .goal-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #c62828, #e53935);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .goal-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .goal-action-btn {
            padding: 5px 15px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .goal-action-btn.increment {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .goal-action-btn.delete {
            background: #ffcdd2;
            color: #c62828;
        }

        .goals-summary {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .summary-stat {
            display: inline-block;
            margin: 0 20px;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: #c62828;
        }

        .summary-label {
            font-size: 0.85rem;
            color: #666;
        }

        /* ===== BATCH 58: Fill-in-Blank, Topic Summary, Study Timer ===== */

        /* Fill-in-Blank Button */
        .fill-blank-btn {
            position: fixed;
            bottom: 670px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #5d4037, #795548);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(121, 85, 72, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .fill-blank-btn:hover {
            transform: scale(1.1);
        }

        /* Topic Summary Button */
        .topic-summary-btn {
            position: fixed;
            bottom: 730px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #0288d1, #03a9f4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(3, 169, 244, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .topic-summary-btn:hover {
            transform: scale(1.1);
        }

        /* Study Timer Button */
        .study-timer-btn {
            position: fixed;
            bottom: 790px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #d32f2f, #f44336);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .study-timer-btn:hover {
            transform: scale(1.1);
        }

        /* Fill-in-Blank Modal */
        .fill-blank-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .fill-blank-modal.active {
            display: flex;
        }

        .fill-blank-content {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .fill-blank-header {
            background: linear-gradient(135deg, #5d4037, #795548);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fill-blank-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close-fill-blank {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .fill-blank-body {
            padding: 20px;
        }

        .fill-blank-score {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: #efebe9;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .blank-sentence {
            font-size: 1.3rem;
            line-height: 2;
            padding: 20px;
            background: linear-gradient(135deg, #efebe9, #d7ccc8);
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .blank-input {
            border: none;
            border-bottom: 3px solid #795548;
            background: transparent;
            width: 120px;
            font-size: 1.1rem;
            text-align: center;
            padding: 5px;
            outline: none;
        }

        .blank-input:focus {
            border-bottom-color: #5d4037;
        }

        .fill-blank-actions {
            text-align: center;
        }

        .fill-blank-btn-action {
            padding: 12px 25px;
            background: linear-gradient(135deg, #5d4037, #795548);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .fill-blank-btn-action:hover {
            transform: scale(1.05);
        }

        .fill-blank-feedback {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }

        /* Topic Summary Modal */
        .topic-summary-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .topic-summary-modal.active {
            display: flex;
        }

        .topic-summary-content {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .topic-summary-header {
            background: linear-gradient(135deg, #0288d1, #03a9f4);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .topic-summary-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close-topic-summary {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .summary-body {
            padding: 20px;
        }

        .summary-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .summary-tab {
            padding: 10px 20px;
            background: #e1f5fe;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .summary-tab.active {
            background: linear-gradient(135deg, #0288d1, #03a9f4);
            color: white;
        }

        .summary-card {
            background: linear-gradient(135deg, #e1f5fe, #b3e5fc);
            border-radius: 15px;
            padding: 20px;
        }

        .summary-card h3 {
            margin: 0 0 15px 0;
            color: #0277bd;
        }

        .summary-points {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .summary-points li {
            padding: 10px 0;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .summary-points li:last-child {
            border-bottom: none;
        }

        .summary-icon {
            font-size: 1.2rem;
        }

        /* Study Timer Modal */
        .study-timer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .study-timer-modal.active {
            display: flex;
        }

        .study-timer-content {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .study-timer-header {
            background: linear-gradient(135deg, #d32f2f, #f44336);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .study-timer-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close-study-timer {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .timer-body {
            padding: 30px;
            text-align: center;
        }

        .timer-display {
            font-size: 4rem;
            font-weight: bold;
            color: #d32f2f;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }

        .timer-label {
            font-size: 1rem;
            color: #666;
            margin-bottom: 20px;
        }

        .timer-presets {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .timer-preset {
            padding: 10px 20px;
            background: #ffebee;
            border: 2px solid #ffcdd2;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timer-preset:hover, .timer-preset.active {
            background: linear-gradient(135deg, #d32f2f, #f44336);
            color: white;
            border-color: transparent;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .timer-control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timer-control-btn.start {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
        }

        .timer-control-btn.pause {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            color: white;
        }

        .timer-control-btn.reset {
            background: linear-gradient(135deg, #9e9e9e, #bdbdbd);
            color: white;
        }

        .timer-control-btn:hover {
            transform: scale(1.1);
        }

        .timer-stats {
            margin-top: 20px;
            padding: 15px;
            background: #ffebee;
            border-radius: 10px;
        }

        .timer-stat-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .timer-xp-earned {
            color: #4caf50;
            font-weight: bold;
        }

        /* ===== BATCH 59: Memory Game, Experiment Lab, Quiz Battle ===== */

        /* Memory Game Button */
        .memory-game-btn {
            position: fixed;
            bottom: 850px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #6a1b9a, #8e24aa);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(142, 36, 170, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .memory-game-btn:hover {
            transform: scale(1.1);
        }

        /* Experiment Lab Button */
        .experiment-lab-btn {
            position: fixed;
            bottom: 910px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #1565c0, #1e88e5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(30, 136, 229, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .experiment-lab-btn:hover {
            transform: scale(1.1);
        }

        /* Quiz Battle Button */
        .quiz-battle-btn {
            position: fixed;
            bottom: 250px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #d84315, #ff5722);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 87, 34, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .quiz-battle-btn:hover {
            transform: scale(1.1);
        }

        /* Memory Game Modal */
        .memory-game-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .memory-game-modal.active {
            display: flex;
        }

        .memory-game-content {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .memory-game-header {
            background: linear-gradient(135deg, #6a1b9a, #8e24aa);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .memory-game-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close-memory-game {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .memory-body {
            padding: 20px;
        }

        .memory-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 15px;
            background: #f3e5f5;
            border-radius: 10px;
        }

        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #7b1fa2, #9c27b0);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .memory-card.flipped {
            background: #f3e5f5;
            transform: rotateY(180deg);
        }

        .memory-card.matched {
            background: #c8e6c9;
            cursor: default;
        }

        .memory-card-back {
            font-size: 2rem;
        }

        /* Experiment Lab Modal */
        .experiment-lab-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .experiment-lab-modal.active {
            display: flex;
        }

        .experiment-lab-content {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .experiment-lab-header {
            background: linear-gradient(135deg, #1565c0, #1e88e5);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .experiment-lab-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close-experiment-lab {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .experiment-body {
            padding: 20px;
        }

        .experiment-list {
            display: grid;
            gap: 15px;
        }

        .experiment-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .experiment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(30, 136, 229, 0.2);
        }

        .experiment-card h4 {
            margin: 0 0 10px 0;
            color: #1565c0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .experiment-card p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .experiment-detail {
            display: none;
        }

        .experiment-detail.active {
            display: block;
        }

        .experiment-steps {
            background: #e8f5e9;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .experiment-steps h5 {
            margin: 0 0 10px 0;
            color: #2e7d32;
        }

        .experiment-steps ol {
            margin: 0;
            padding-left: 20px;
        }

        .experiment-steps li {
            margin-bottom: 8px;
        }

        .experiment-result {
            background: #fff3e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .back-to-experiments {
            padding: 10px 20px;
            background: #1565c0;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        /* Quiz Battle Modal */
        .quiz-battle-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .quiz-battle-modal.active {
            display: flex;
        }

        .quiz-battle-content {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .quiz-battle-header {
            background: linear-gradient(135deg, #d84315, #ff5722);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quiz-battle-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close-quiz-battle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .battle-body {
            padding: 20px;
        }

        .battle-scoreboard {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 15px;
            background: #fbe9e7;
            border-radius: 10px;
        }

        .battle-player {
            text-align: center;
        }

        .battle-player-icon {
            font-size: 2.5rem;
        }

        .battle-player-score {
            font-size: 2rem;
            font-weight: bold;
            color: #d84315;
        }

        .battle-vs {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff5722;
            display: flex;
            align-items: center;
        }

        .battle-question {
            background: linear-gradient(135deg, #fbe9e7, #ffccbc);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
        }

        .battle-question-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .battle-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .battle-option {
            padding: 15px;
            background: white;
            border: 2px solid #ffccbc;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .battle-option:hover {
            border-color: #ff5722;
            background: #fff3e0;
        }

        .battle-option.correct {
            background: #c8e6c9;
            border-color: #4caf50;
        }

        .battle-option.wrong {
            background: #ffcdd2;
            border-color: #f44336;
        }

        .battle-result {
            text-align: center;
            padding: 30px;
        }

        .battle-result-icon {
            font-size: 4rem;
        }

        .start-battle-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #d84315, #ff5722);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-battle-btn:hover {
            transform: scale(1.05);
        }

        /* ===== BATCH 60: Leaderboard, Achievements, Sound Effects ===== */

        /* Leaderboard Button */
        .leaderboard-btn {
            position: fixed;
            bottom: 310px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #f9a825, #fbc02d);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(251, 192, 45, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .leaderboard-btn:hover {
            transform: scale(1.1);
        }

        /* Achievements Button */
        .achievements-btn {
            position: fixed;
            bottom: 370px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #6d4c41, #8d6e63);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(141, 110, 99, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .achievements-btn:hover {
            transform: scale(1.1);
        }

        /* Sound FX Button */
        .sound-fx-btn {
            position: fixed;
            bottom: 430px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #00838f, #00acc1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 172, 193, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .sound-fx-btn:hover {
            transform: scale(1.1);
        }

        /* Leaderboard Modal */
        .leaderboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .leaderboard-modal.active {
            display: flex;
        }

        .leaderboard-content {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .leaderboard-header {
            background: linear-gradient(135deg, #f9a825, #fbc02d);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaderboard-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close-leaderboard {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .leaderboard-body {
            padding: 20px;
        }

        .leaderboard-entry {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #fffde7;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .leaderboard-entry.you {
            background: linear-gradient(135deg, #fff9c4, #fff59d);
            border: 2px solid #fbc02d;
        }

        .leaderboard-rank {
            font-size: 1.5rem;
            font-weight: bold;
            width: 50px;
            text-align: center;
        }

        .leaderboard-rank.gold { color: #f9a825; }
        .leaderboard-rank.silver { color: #9e9e9e; }
        .leaderboard-rank.bronze { color: #8d6e63; }

        .leaderboard-info {
            flex: 1;
            margin-left: 15px;
        }

        .leaderboard-name {
            font-weight: bold;
        }

        .leaderboard-xp {
            color: #f9a825;
            font-weight: bold;
        }

        /* Achievements Modal */
        .achievements-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .achievements-modal.active {
            display: flex;
        }

        .achievements-content {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .achievements-header {
            background: linear-gradient(135deg, #6d4c41, #8d6e63);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .achievements-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close-achievements {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .achievements-body {
            padding: 20px;
        }

        .achievement-card {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #efebe9;
            border-radius: 15px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .achievement-card.unlocked {
            opacity: 1;
            background: linear-gradient(135deg, #efebe9, #d7ccc8);
        }

        .achievement-icon {
            font-size: 2.5rem;
            margin-right: 15px;
        }

        .achievement-info h4 {
            margin: 0 0 5px 0;
            color: #5d4037;
        }

        .achievement-info p {
            margin: 0;
            color: #8d6e63;
            font-size: 0.9rem;
        }

        .achievement-status {
            margin-left: auto;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .achievement-status.locked {
            background: #bdbdbd;
            color: white;
        }

        .achievement-status.unlocked {
            background: #4caf50;
            color: white;
        }

        /* Sound FX Modal */
        .sound-fx-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .sound-fx-modal.active {
            display: flex;
        }

        .sound-fx-content {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .sound-fx-header {
            background: linear-gradient(135deg, #00838f, #00acc1);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sound-fx-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close-sound-fx {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .sound-fx-body {
            padding: 20px;
        }

        .sound-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #e0f7fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .sound-option-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sound-option-icon {
            font-size: 1.5rem;
        }

        .sound-toggle {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .sound-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .sound-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #bdbdbd;
            border-radius: 26px;
            transition: 0.3s;
        }

        .sound-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .sound-toggle input:checked + .sound-slider {
            background: #00acc1;
        }

        .sound-toggle input:checked + .sound-slider:before {
            transform: translateX(24px);
        }

        .volume-control {
            margin-top: 20px;
            padding: 15px;
            background: #e0f7fa;
            border-radius: 10px;
        }

        .volume-slider {
            width: 100%;
            margin-top: 10px;
        }

        /* Batch 61: Daily Challenge */
        .daily-challenge-btn {
            position: fixed;
            left: 18px;
            bottom: 950px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff5722 0%, #e64a19 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 87, 34, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .daily-challenge-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 87, 34, 0.5);
        }

        .daily-challenge-btn.completed {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .daily-challenge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .daily-challenge-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .daily-bonus-badge {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #333;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 15px;
        }

        .daily-question-box {
            background: #fff3e0;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .daily-option {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border: 2px solid #ff5722;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 1rem;
        }

        .daily-option:hover {
            background: #fff3e0;
            transform: translateX(5px);
        }

        .daily-option.correct {
            background: #c8e6c9;
            border-color: #4caf50;
        }

        .daily-option.wrong {
            background: #ffcdd2;
            border-color: #f44336;
        }

        /* Vocabulary Builder */
        .vocab-builder-btn {
            position: fixed;
            right: 18px;
            bottom: 470px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3f51b5 0%, #303f9f 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(63, 81, 181, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .vocab-builder-btn:hover {
            transform: scale(1.1);
        }

        .vocab-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .vocab-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .flashcard {
            perspective: 1000px;
            width: 100%;
            height: 200px;
            margin: 20px 0;
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            box-sizing: border-box;
        }

        .flashcard-front {
            background: linear-gradient(135deg, #3f51b5 0%, #5c6bc0 100%);
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .flashcard-back {
            background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
            color: #333;
            transform: rotateY(180deg);
            font-size: 1.1rem;
        }

        .vocab-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .vocab-nav-btn {
            background: #3f51b5;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .vocab-nav-btn:hover {
            background: #303f9f;
            transform: scale(1.05);
        }

        .vocab-progress {
            font-size: 1rem;
            color: #666;
        }

        .vocab-category-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #3f51b5;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        /* Progress Charts */
        .progress-charts-btn {
            position: fixed;
            left: 18px;
            bottom: 990px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .progress-charts-btn:hover {
            transform: scale(1.1);
        }

        .charts-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .charts-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .chart-container {
            background: #f5f5f5;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            padding: 10px 0;
        }

        .bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .bar {
            width: 30px;
            background: linear-gradient(to top, #00bcd4 0%, #4dd0e1 100%);
            border-radius: 5px 5px 0 0;
            transition: height 0.5s ease;
            min-height: 5px;
        }

        .bar-label {
            font-size: 0.75rem;
            color: #666;
            margin-top: 8px;
            text-align: center;
        }

        .bar-value {
            font-size: 0.7rem;
            color: #333;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-ring {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(#00bcd4 0deg, #e0e0e0 0deg);
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }

        .stat-ring-inner {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-ring-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00bcd4;
        }

        .stat-ring-label {
            font-size: 0.75rem;
            color: #666;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .mini-stat {
            background: #e0f7fa;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .mini-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00838f;
        }

        .mini-stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        /* Batch 62: Study Planner */
        .study-planner-btn {
            position: fixed;
            right: 18px;
            bottom: 510px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #673ab7 0%, #512da8 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(103, 58, 183, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .study-planner-btn:hover {
            transform: scale(1.1);
        }

        .planner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .planner-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 650px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .planner-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin: 20px 0;
        }

        .planner-day {
            background: #ede7f6;
            border-radius: 10px;
            padding: 10px 5px;
            text-align: center;
            min-height: 120px;
        }

        .planner-day-header {
            font-weight: bold;
            color: #673ab7;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .planner-task {
            background: #673ab7;
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.7rem;
            margin: 3px 0;
            cursor: pointer;
        }

        .planner-task:hover {
            opacity: 0.8;
        }

        .add-task-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #673ab7;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .planner-day-select {
            padding: 10px;
            border: 2px solid #673ab7;
            border-radius: 10px;
            font-size: 1rem;
            margin-right: 10px;
        }

        /* Topic Quiz Generator */
        .topic-quiz-btn {
            position: fixed;
            left: 18px;
            bottom: 1030px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .topic-quiz-btn:hover {
            transform: scale(1.1);
        }

        .topic-quiz-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .topic-quiz-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .topic-select-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .topic-card {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
            border: 2px solid #e91e63;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(233, 30, 99, 0.3);
        }

        .topic-card.selected {
            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
            color: white;
        }

        .topic-card-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .quiz-settings {
            background: #fce4ec;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .quiz-setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }

        .quiz-count-select {
            padding: 10px 20px;
            border: 2px solid #e91e63;
            border-radius: 10px;
            font-size: 1rem;
        }

        /* Concept Map */
        .concept-map-btn {
            position: fixed;
            right: 18px;
            bottom: 550px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #009688 0%, #00796b 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 150, 136, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .concept-map-btn:hover {
            transform: scale(1.1);
        }

        .concept-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .concept-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .concept-map-area {
            background: #e0f2f1;
            border-radius: 15px;
            padding: 20px;
            min-height: 300px;
            position: relative;
        }

        .concept-node {
            position: absolute;
            background: linear-gradient(135deg, #009688 0%, #4db6ac 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 150, 136, 0.3);
        }

        .concept-node:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .concept-node.central {
            background: linear-gradient(135deg, #00796b 0%, #004d40 100%);
            font-size: 1.1rem;
        }

        .concept-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #009688;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .concept-info {
            background: #b2dfdb;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        /* Batch 63: Quick Notes */
        .quick-notes-btn {
            position: fixed;
            left: 18px;
            bottom: 1070px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .quick-notes-btn:hover {
            transform: scale(1.1);
        }

        .notes-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .notes-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .note-card {
            background: #fff8e1;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 10px 10px 0;
            position: relative;
        }

        .note-card-time {
            font-size: 0.75rem;
            color: #999;
            margin-bottom: 5px;
        }

        .note-card-text {
            color: #333;
        }

        .note-card-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .note-input-area {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #ff9800;
            border-radius: 10px;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 10px;
        }

        /* Formula Sheet */
        .formula-sheet-btn {
            position: fixed;
            right: 18px;
            bottom: 590px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #795548 0%, #5d4037 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(121, 85, 72, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .formula-sheet-btn:hover {
            transform: scale(1.1);
        }

        .formula-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .formula-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 650px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .formula-category {
            margin: 20px 0;
        }

        .formula-category-title {
            background: linear-gradient(135deg, #795548 0%, #8d6e63 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .formula-item {
            background: #efebe9;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .formula-name {
            font-weight: bold;
            color: #5d4037;
        }

        .formula-equation {
            font-family: 'Courier New', monospace;
            background: #d7ccc8;
            padding: 5px 10px;
            border-radius: 5px;
            color: #3e2723;
        }

        .formula-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #795548;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        /* Question Archive */
        .archive-btn {
            position: fixed;
            left: 18px;
            bottom: 1110px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #607d8b 0%, #455a64 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(96, 125, 139, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .archive-btn:hover {
            transform: scale(1.1);
        }

        .archive-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .archive-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .archive-question {
            background: #eceff1;
            border-radius: 12px;
            padding: 15px;
            margin: 12px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .archive-question:hover {
            background: #cfd8dc;
            transform: translateX(5px);
        }

        .archive-question-date {
            font-size: 0.8rem;
            color: #607d8b;
            margin-bottom: 8px;
        }

        .archive-question-text {
            color: #333;
            font-weight: 500;
        }

        .archive-question-status {
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .archive-question-status.correct {
            color: #4caf50;
        }

        .archive-question-status.wrong {
            color: #f44336;
        }

        .archive-question-status.unanswered {
            color: #ff9800;
        }

        /* Batch 64: Science Facts Carousel */
        .facts-carousel-btn {
            position: fixed;
            right: 18px;
            bottom: 630px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8e24aa 0%, #6a1b9a 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(142, 36, 170, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .facts-carousel-btn:hover {
            transform: scale(1.1);
        }

        .facts-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .facts-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .fact-card {
            background: linear-gradient(135deg, #e1bee7 0%, #ce93d8 100%);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .fact-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .fact-text {
            font-size: 1.1rem;
            color: #4a148c;
            line-height: 1.6;
        }

        .fact-category {
            margin-top: 15px;
            font-size: 0.85rem;
            color: #7b1fa2;
            font-weight: bold;
        }

        .fact-nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .fact-nav-btn {
            background: #8e24aa;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fact-nav-btn:hover {
            background: #6a1b9a;
            transform: scale(1.1);
        }

        /* Practice Mode */
        .practice-mode-btn {
            position: fixed;
            left: 18px;
            bottom: 1150px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00897b 0%, #00695c 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 137, 123, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .practice-mode-btn:hover {
            transform: scale(1.1);
        }

        .practice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .practice-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .difficulty-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .difficulty-card {
            padding: 20px 15px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .difficulty-card:hover {
            transform: translateY(-5px);
        }

        .difficulty-card.easy {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
        }

        .difficulty-card.medium {
            background: linear-gradient(135deg, #fff9c4 0%, #fff176 100%);
        }

        .difficulty-card.hard {
            background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%);
        }

        .difficulty-card.selected {
            border-color: #00897b;
            box-shadow: 0 4px 15px rgba(0, 137, 123, 0.4);
        }

        .difficulty-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .practice-question {
            background: #e0f2f1;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .practice-option {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border: 2px solid #00897b;
            border-radius: 10px;
            cursor: pointer;
            text-align: left;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .practice-option:hover {
            background: #e0f2f1;
        }

        /* Badge Collection */
        .badge-collection-btn {
            position: fixed;
            right: 18px;
            bottom: 670px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .badge-collection-btn:hover {
            transform: scale(1.1);
        }

        .badge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .badge-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .badge-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .badge-item {
            text-align: center;
            padding: 15px 10px;
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .badge-item.unlocked {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
        }

        .badge-item.locked {
            background: #f5f5f5;
            opacity: 0.6;
        }

        .badge-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .badge-item.locked .badge-icon {
            filter: grayscale(100%);
        }

        .badge-name {
            font-size: 0.75rem;
            font-weight: bold;
            color: #333;
        }

        .badge-item.locked .badge-name {
            color: #999;
        }

        .badge-progress {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            margin-top: 20px;
            overflow: hidden;
        }

        .badge-progress-fill {
            background: linear-gradient(90deg, #ffc107 0%, #ff8f00 100%);
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Batch 65: Speed Quiz */
        .speed-quiz-btn {
            position: fixed;
            left: 18px;
            bottom: 1190px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .speed-quiz-btn:hover {
            transform: scale(1.1);
        }

        .speed-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .speed-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .speed-timer {
            font-size: 3rem;
            font-weight: bold;
            color: #d32f2f;
            text-align: center;
            margin: 15px 0;
        }

        .speed-timer.warning {
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .speed-question {
            background: #ffebee;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .speed-option {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: white;
            border: 2px solid #d32f2f;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .speed-option:hover {
            background: #ffcdd2;
        }

        .speed-score-display {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .speed-stat {
            text-align: center;
        }

        .speed-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #d32f2f;
        }

        /* Review Mistakes */
        .review-mistakes-btn {
            position: fixed;
            right: 18px;
            bottom: 710px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .review-mistakes-btn:hover {
            transform: scale(1.1);
        }

        .mistakes-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .mistakes-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .mistake-card {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 12px 0;
            border-radius: 0 12px 12px 0;
        }

        .mistake-question {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .mistake-answers {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .your-answer {
            background: #ffcdd2;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .correct-answer {
            background: #c8e6c9;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        /* Science Jokes */
        .jokes-btn {
            position: fixed;
            left: 18px;
            bottom: 1230px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffb300 0%, #ff8f00 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 179, 0, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .jokes-btn:hover {
            transform: scale(1.1);
        }

        .jokes-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .jokes-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 480px;
            width: 90%;
        }

        .joke-card {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .joke-setup {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 20px;
        }

        .joke-punchline {
            font-size: 1.3rem;
            color: #ff8f00;
            font-weight: bold;
            display: none;
        }

        .joke-punchline.revealed {
            display: block;
        }

        .reveal-joke-btn {
            margin-top: 20px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #ffb300 0%, #ff8f00 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reveal-joke-btn:hover {
            transform: scale(1.05);
        }

        /* Batch 66: Topic Explorer */
        .topic-explorer-btn {
            position: fixed;
            right: 18px;
            bottom: 750px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(21, 101, 192, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .topic-explorer-btn:hover {
            transform: scale(1.1);
        }

        .explorer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .explorer-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .explorer-topic-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .explorer-topic-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #1565c0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .explorer-topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(21, 101, 192, 0.3);
        }

        .explorer-topic-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .topic-detail-box {
            background: #e3f2fd;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .topic-fact {
            background: white;
            padding: 12px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #1565c0;
        }

        /* Question Bank */
        .question-bank-btn {
            position: fixed;
            left: 18px;
            bottom: 1270px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5e35b1 0%, #4527a0 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(94, 53, 177, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .question-bank-btn:hover {
            transform: scale(1.1);
        }

        .bank-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .bank-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .bank-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .bank-filter-btn {
            padding: 8px 16px;
            border: 2px solid #5e35b1;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bank-filter-btn.active {
            background: #5e35b1;
            color: white;
        }

        .bank-question-card {
            background: #ede7f6;
            border-radius: 12px;
            padding: 15px;
            margin: 12px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bank-question-card:hover {
            background: #d1c4e9;
        }

        .bank-question-category {
            font-size: 0.75rem;
            color: #5e35b1;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* Study Streak Calendar */
        .streak-calendar-btn {
            position: fixed;
            right: 18px;
            bottom: 790px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(67, 160, 71, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .streak-calendar-btn:hover {
            transform: scale(1.1);
        }

        .calendar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .calendar-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin: 15px 0;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #666;
            padding: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.85rem;
            background: #f5f5f5;
        }

        .calendar-day.active {
            background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
            color: white;
            font-weight: bold;
        }

        .calendar-day.today {
            border: 3px solid #43a047;
        }

        .calendar-day.empty {
            background: transparent;
        }

        .streak-stats {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 15px;
            margin-top: 15px;
        }

        .streak-stat {
            text-align: center;
        }

        .streak-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2e7d32;
        }

        .streak-stat-label {
            font-size: 0.8rem;
            color: #666;
        }

        /* Batch 67: Hint System */
        .hint-system-btn {
            position: fixed;
            left: 18px;
            bottom: 1310px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00acc1 0%, #00838f 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 172, 193, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .hint-system-btn:hover {
            transform: scale(1.1);
        }

        .hint-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .hint-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .hint-question-box {
            background: #e0f7fa;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .hint-box {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border: 2px solid #00acc1;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .hint-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .hint-text {
            color: #00838f;
            font-size: 1.1rem;
        }

        .hint-option {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: white;
            border: 2px solid #00acc1;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .hint-option:hover {
            background: #e0f7fa;
        }

        .hint-option.eliminated {
            background: #ffebee;
            border-color: #ef9a9a;
            text-decoration: line-through;
            opacity: 0.5;
        }

        /* Revision Notes */
        .revision-notes-btn {
            position: fixed;
            right: 18px;
            bottom: 830px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7cb342 0%, #558b2f 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(124, 179, 66, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .revision-notes-btn:hover {
            transform: scale(1.1);
        }

        .revision-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .revision-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .revision-topic-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #7cb342;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .revision-card {
            background: #f1f8e9;
            border-left: 4px solid #7cb342;
            padding: 15px;
            margin: 12px 0;
            border-radius: 0 10px 10px 0;
        }

        .revision-card-title {
            font-weight: bold;
            color: #558b2f;
            margin-bottom: 8px;
        }

        .revision-card-content {
            color: #333;
            line-height: 1.6;
        }

        /* Score History */
        .score-history-btn {
            position: fixed;
            left: 18px;
            bottom: 1350px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(171, 71, 188, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .score-history-btn:hover {
            transform: scale(1.1);
        }

        .history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .history-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .history-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f3e5f5;
            border-radius: 12px;
            margin: 10px 0;
        }

        .history-entry-date {
            font-size: 0.85rem;
            color: #666;
        }

        .history-entry-type {
            font-weight: bold;
            color: #8e24aa;
        }

        .history-entry-score {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ab47bc;
        }

        .history-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 120px;
            padding: 15px 0;
            background: #fce4ec;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .history-bar {
            width: 20px;
            background: linear-gradient(to top, #ab47bc 0%, #ce93d8 100%);
            border-radius: 5px 5px 0 0;
            transition: height 0.5s ease;
        }

        /* Batch 68: Matching Game */
        .matching-game-btn {
            position: fixed;
            right: 18px;
            bottom: 870px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ec407a 0%, #d81b60 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(236, 64, 122, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .matching-game-btn:hover {
            transform: scale(1.1);
        }

        .matching-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .matching-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .matching-columns {
            display: flex;
            gap: 20px;
        }

        .matching-column {
            flex: 1;
        }

        .matching-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .matching-term {
            background: #fce4ec;
            border: 2px solid #ec407a;
        }

        .matching-term.selected {
            background: #ec407a;
            color: white;
        }

        .matching-def {
            background: #e8f5e9;
            border: 2px solid #66bb6a;
        }

        .matching-def.selected {
            background: #66bb6a;
            color: white;
        }

        .matching-item.matched {
            opacity: 0.5;
            cursor: default;
        }

        /* Random Question Generator */
        .random-question-btn {
            position: fixed;
            left: 18px;
            bottom: 1390px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #26a69a 0%, #00897b 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(38, 166, 154, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .random-question-btn:hover {
            transform: scale(1.1);
        }

        .random-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .random-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .random-question-box {
            background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        .random-question-text {
            font-size: 1.2rem;
            color: #00695c;
            margin-bottom: 20px;
        }

        .random-answer-reveal {
            background: #fff8e1;
            border: 2px solid #26a69a;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        /* Study Tips */
        .study-tips-btn {
            position: fixed;
            right: 18px;
            bottom: 910px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5c6bc0 0%, #3f51b5 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(92, 107, 192, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .study-tips-btn:hover {
            transform: scale(1.1);
        }

        .tips-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .tips-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .tip-card {
            background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .tip-number {
            background: #5c6bc0;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 10px;
        }

        .tip-title {
            font-weight: bold;
            color: #3f51b5;
            margin-bottom: 8px;
            display: inline;
        }

        .tip-description {
            color: #333;
            margin-top: 10px;
            line-height: 1.5;
        }

        /* Batch 69: Memory Card Game */
        .memory-card-btn {
            position: fixed;
            right: 18px;
            bottom: 950px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63, #f48fb1);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .memory-card-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(233, 30, 99, 0.5);
        }

        .memory-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .memory-modal.active {
            display: flex;
        }

        .memory-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow: hidden;
        }

        .memory-modal-header {
            background: linear-gradient(135deg, #e91e63, #f48fb1);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .memory-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #e91e63, #f48fb1);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }

        .memory-card.flipped {
            background: white;
            border: 2px solid #e91e63;
            color: #333;
        }

        .memory-card.matched {
            background: #4caf50;
            color: white;
            cursor: default;
        }

        .memory-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-weight: bold;
            color: #e91e63;
        }

        /* Science Glossary */
        .glossary-btn {
            position: fixed;
            left: 18px;
            bottom: 1430px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #607d8b, #90a4ae);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(96, 125, 139, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .glossary-btn:hover {
            transform: scale(1.1);
        }

        .glossary-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .glossary-modal.active {
            display: flex;
        }

        .glossary-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow: hidden;
        }

        .glossary-modal-header {
            background: linear-gradient(135deg, #607d8b, #90a4ae);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .glossary-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .glossary-search {
            width: 100%;
            padding: 12px;
            border: 2px solid #607d8b;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .glossary-list {
            max-height: 50vh;
            overflow-y: auto;
        }

        .glossary-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .glossary-item:hover {
            background: #f5f5f5;
        }

        .glossary-term {
            font-weight: bold;
            color: #607d8b;
        }

        .glossary-def {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* Achievement Progress */
        .achieve-progress-btn {
            position: fixed;
            right: 18px;
            bottom: 990px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffc107, #ffeb3b);
            color: #333;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .achieve-progress-btn:hover {
            transform: scale(1.1);
        }

        .achieve-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .achieve-modal.active {
            display: flex;
        }

        .achieve-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow: hidden;
        }

        .achieve-modal-header {
            background: linear-gradient(135deg, #ffc107, #ffeb3b);
            color: #333;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .achieve-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .achieve-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #fffde7;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .achieve-icon {
            font-size: 2rem;
        }

        .achieve-info {
            flex: 1;
        }

        .achieve-title {
            font-weight: bold;
            color: #333;
        }

        .achieve-desc {
            font-size: 0.85rem;
            color: #666;
        }

        .achieve-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .achieve-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffc107, #ff9800);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .achieve-pct {
            font-size: 0.8rem;
            color: #ff9800;
            font-weight: bold;
            margin-top: 4px;
        }

        /* Batch 70: True/False Quiz */
        .tf-quiz-btn {
            position: fixed;
            left: 18px;
            bottom: 1470px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bcd4, #4dd0e1);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .tf-quiz-btn:hover {
            transform: scale(1.1);
        }

        .tf-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .tf-modal.active {
            display: flex;
        }

        .tf-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow: hidden;
        }

        .tf-modal-header {
            background: linear-gradient(135deg, #00bcd4, #4dd0e1);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tf-modal-body {
            padding: 20px;
        }

        .tf-question {
            font-size: 1.1rem;
            text-align: center;
            padding: 20px;
            background: #e0f7fa;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .tf-buttons {
            display: flex;
            gap: 15px;
        }

        .tf-btn {
            flex: 1;
            padding: 15px;
            font-size: 1.2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .tf-btn.true {
            background: #4caf50;
            color: white;
        }

        .tf-btn.false {
            background: #f44336;
            color: white;
        }

        .tf-btn:hover {
            transform: scale(1.05);
        }

        .tf-score {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            color: #00bcd4;
        }

        /* Science News Feed */
        .news-btn {
            position: fixed;
            right: 18px;
            bottom: 1030px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #795548, #a1887f);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(121, 85, 72, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .news-btn:hover {
            transform: scale(1.1);
        }

        .news-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .news-modal.active {
            display: flex;
        }

        .news-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow: hidden;
        }

        .news-modal-header {
            background: linear-gradient(135deg, #795548, #a1887f);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .news-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .news-item {
            padding: 15px;
            background: #efebe9;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .news-title {
            font-weight: bold;
            color: #795548;
            margin-bottom: 8px;
        }

        .news-content {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
        }

        .news-category {
            display: inline-block;
            padding: 4px 10px;
            background: #795548;
            color: white;
            border-radius: 15px;
            font-size: 0.75rem;
            margin-top: 8px;
        }

        /* Study Timer (Pomodoro) */
        .pomodoro-btn {
            position: fixed;
            left: 18px;
            bottom: 1510px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff5722, #ff8a65);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 87, 34, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .pomodoro-btn:hover {
            transform: scale(1.1);
        }

        .pomodoro-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .pomodoro-modal.active {
            display: flex;
        }

        .pomodoro-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }

        .pomodoro-modal-header {
            background: linear-gradient(135deg, #ff5722, #ff8a65);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pomodoro-modal-body {
            padding: 30px;
            text-align: center;
        }

        .pomodoro-timer {
            font-size: 4rem;
            font-weight: bold;
            color: #ff5722;
            margin: 20px 0;
        }

        .pomodoro-label {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .pomodoro-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .pomodoro-control-btn {
            padding: 12px 25px;
            font-size: 1rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pomodoro-control-btn.start {
            background: #4caf50;
            color: white;
        }

        .pomodoro-control-btn.pause {
            background: #ff9800;
            color: white;
        }

        .pomodoro-control-btn.reset {
            background: #9e9e9e;
            color: white;
        }

        .pomodoro-stats {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            color: #666;
        }

        /* Batch 71: Word Scramble */
        .scramble-btn {
            position: fixed;
            right: 18px;
            bottom: 1070px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #673ab7, #9575cd);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(103, 58, 183, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .scramble-btn:hover {
            transform: scale(1.1);
        }

        .scramble-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .scramble-modal.active {
            display: flex;
        }

        .scramble-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }

        .scramble-modal-header {
            background: linear-gradient(135deg, #673ab7, #9575cd);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scramble-modal-body {
            padding: 25px;
            text-align: center;
        }

        .scramble-word {
            font-size: 2rem;
            letter-spacing: 8px;
            font-weight: bold;
            color: #673ab7;
            background: #ede7f6;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .scramble-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            border: 2px solid #673ab7;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
        }

        .scramble-hint {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .scramble-result {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        /* Science Heroes */
        .heroes-btn {
            position: fixed;
            left: 18px;
            bottom: 1550px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3f51b5, #7986cb);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(63, 81, 181, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .heroes-btn:hover {
            transform: scale(1.1);
        }

        .heroes-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .heroes-modal.active {
            display: flex;
        }

        .heroes-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow: hidden;
        }

        .heroes-modal-header {
            background: linear-gradient(135deg, #3f51b5, #7986cb);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .heroes-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .hero-card {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #e8eaf6;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .hero-avatar {
            font-size: 2.5rem;
        }

        .hero-info h4 {
            color: #3f51b5;
            margin: 0 0 5px 0;
        }

        .hero-info p {
            font-size: 0.9rem;
            color: #555;
            margin: 0;
        }

        .hero-field {
            display: inline-block;
            padding: 3px 8px;
            background: #3f51b5;
            color: white;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-top: 8px;
        }

        /* Quick Review */
        .quick-review-btn {
            position: fixed;
            right: 18px;
            bottom: 1110px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #009688, #4db6ac);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 150, 136, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .quick-review-btn:hover {
            transform: scale(1.1);
        }

        .review-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .review-modal.active {
            display: flex;
        }

        .review-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow: hidden;
        }

        .review-modal-header {
            background: linear-gradient(135deg, #009688, #4db6ac);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .review-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .review-topics {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .review-topic-btn {
            padding: 10px 15px;
            border: none;
            background: #e0f2f1;
            color: #009688;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .review-topic-btn.active {
            background: #009688;
            color: white;
        }

        .review-content {
            background: #e0f2f1;
            padding: 20px;
            border-radius: 12px;
        }

        .review-content h4 {
            color: #009688;
            margin-top: 0;
        }

        .review-content ul {
            margin: 0;
            padding-left: 20px;
        }

        .review-content li {
            margin-bottom: 10px;
            color: #333;
        }

        /* Batch 72: Fill in the Blanks */
        .blanks-btn {
            position: fixed;
            left: 18px;
            bottom: 1590px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f44336, #ef9a9a);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .blanks-btn:hover {
            transform: scale(1.1);
        }

        .blanks-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .blanks-modal.active {
            display: flex;
        }

        .blanks-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            overflow: hidden;
        }

        .blanks-modal-header {
            background: linear-gradient(135deg, #f44336, #ef9a9a);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .blanks-modal-body {
            padding: 25px;
        }

        .blanks-sentence {
            font-size: 1.1rem;
            line-height: 1.8;
            padding: 20px;
            background: #ffebee;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .blanks-input {
            padding: 5px 10px;
            border: 2px solid #f44336;
            border-radius: 5px;
            font-size: 1rem;
            width: 120px;
        }

        .blanks-result {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* Experiment Ideas */
        .experiment-btn {
            position: fixed;
            right: 18px;
            bottom: 1150px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8bc34a, #c5e1a5);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(139, 195, 74, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .experiment-btn:hover {
            transform: scale(1.1);
        }

        .experiment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .experiment-modal.active {
            display: flex;
        }

        .experiment-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow: hidden;
        }

        .experiment-modal-header {
            background: linear-gradient(135deg, #8bc34a, #c5e1a5);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .experiment-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .experiment-card {
            background: #f1f8e9;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .experiment-title {
            font-weight: bold;
            color: #558b2f;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .experiment-materials {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
        }

        .experiment-steps {
            font-size: 0.9rem;
            color: #333;
        }

        .experiment-difficulty {
            display: inline-block;
            padding: 3px 10px;
            background: #8bc34a;
            color: white;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-top: 8px;
        }

        /* Topic Progress */
        .topic-progress-btn {
            position: fixed;
            left: 18px;
            bottom: 1630px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196f3, #90caf9);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .topic-progress-btn:hover {
            transform: scale(1.1);
        }

        .progress-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .progress-modal.active {
            display: flex;
        }

        .progress-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow: hidden;
        }

        .progress-modal-header {
            background: linear-gradient(135deg, #2196f3, #90caf9);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .progress-topic {
            padding: 15px;
            background: #e3f2fd;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .progress-topic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-topic-name {
            font-weight: bold;
            color: #1976d2;
        }

        .progress-pct {
            font-weight: bold;
            color: #2196f3;
        }

        .progress-bar {
            height: 10px;
            background: #bbdefb;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2196f3, #64b5f6);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        /* Batch 73: Quiz Race */
        .race-btn {
            position: fixed;
            right: 18px;
            bottom: 1190px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff5722, #ffccbc);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 87, 34, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .race-btn:hover {
            transform: scale(1.1);
        }

        .race-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .race-modal.active {
            display: flex;
        }

        .race-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            overflow: hidden;
        }

        .race-modal-header {
            background: linear-gradient(135deg, #ff5722, #ffccbc);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .race-modal-body {
            padding: 20px;
        }

        .race-timer-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .race-timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 4px;
            transition: width 0.1s linear;
        }

        .race-question {
            font-size: 1.1rem;
            text-align: center;
            padding: 15px;
            background: #fff3e0;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .race-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .race-option {
            padding: 12px;
            border: 2px solid #ff5722;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .race-option:hover {
            background: #fff3e0;
        }

        .race-score {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            color: #ff5722;
        }

        /* Study Buddy */
        .buddy-btn {
            position: fixed;
            left: 18px;
            bottom: 1670px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63, #f8bbd9);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .buddy-btn:hover {
            transform: scale(1.1);
        }

        .buddy-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .buddy-modal.active {
            display: flex;
        }

        .buddy-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }

        .buddy-modal-header {
            background: linear-gradient(135deg, #e91e63, #f8bbd9);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .buddy-modal-body {
            padding: 25px;
            text-align: center;
        }

        .buddy-avatar {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .buddy-message {
            font-size: 1.1rem;
            color: #333;
            background: #fce4ec;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .buddy-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .buddy-action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* Quick Facts Cards */
        .facts-cards-btn {
            position: fixed;
            right: 18px;
            bottom: 1230px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9c27b0, #ce93d8);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .facts-cards-btn:hover {
            transform: scale(1.1);
        }

        .facts-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .facts-modal.active {
            display: flex;
        }

        .facts-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }

        .facts-modal-header {
            background: linear-gradient(135deg, #9c27b0, #ce93d8);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .facts-modal-body {
            padding: 20px;
        }

        .facts-card {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            padding: 30px 20px;
            border-radius: 16px;
            text-align: center;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .facts-card-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .facts-card-text {
            font-size: 1.1rem;
            color: #333;
            line-height: 1.5;
        }

        .facts-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .facts-nav-btn {
            padding: 10px 20px;
            background: #9c27b0;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }

        .facts-counter {
            color: #9c27b0;
            font-weight: bold;
        }

        /* Batch 74: Equation Builder */
        .equation-btn {
            position: fixed;
            left: 18px;
            bottom: 1710px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3f51b5, #7986cb);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(63, 81, 181, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .equation-btn:hover {
            transform: scale(1.1);
        }

        .equation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .equation-modal.active {
            display: flex;
        }

        .equation-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }

        .equation-modal-header {
            background: linear-gradient(135deg, #3f51b5, #7986cb);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .equation-modal-body {
            padding: 25px;
        }

        .equation-display {
            font-size: 1.5rem;
            text-align: center;
            padding: 20px;
            background: #e8eaf6;
            border-radius: 12px;
            margin-bottom: 15px;
            font-family: monospace;
        }

        .equation-keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .equation-key {
            padding: 15px;
            border: 2px solid #3f51b5;
            border-radius: 10px;
            background: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .equation-key:hover {
            background: #e8eaf6;
        }

        .equation-key.action {
            background: #3f51b5;
            color: white;
        }

        /* Science Riddles */
        .riddles-btn {
            position: fixed;
            right: 18px;
            bottom: 1270px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9800, #ffcc80);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .riddles-btn:hover {
            transform: scale(1.1);
        }

        .riddles-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .riddles-modal.active {
            display: flex;
        }

        .riddles-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            overflow: hidden;
        }

        .riddles-modal-header {
            background: linear-gradient(135deg, #ff9800, #ffcc80);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .riddles-modal-body {
            padding: 25px;
        }

        .riddle-box {
            background: #fff3e0;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 15px;
        }

        .riddle-question {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .riddle-hint {
            font-size: 0.9rem;
            color: #ff9800;
            cursor: pointer;
        }

        .riddle-answer-area {
            margin-top: 15px;
        }

        .riddle-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ff9800;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .riddle-result {
            font-weight: bold;
            margin-top: 10px;
        }

        /* Weekly Goals */
        .goals-btn {
            position: fixed;
            left: 18px;
            bottom: 1750px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4caf50, #a5d6a7);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .goals-btn:hover {
            transform: scale(1.1);
        }

        .goals-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .goals-modal.active {
            display: flex;
        }

        .goals-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            max-height: 85vh;
            overflow: hidden;
        }

        .goals-modal-header {
            background: linear-gradient(135deg, #4caf50, #a5d6a7);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .goals-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .goal-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .goal-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .goal-text {
            flex: 1;
        }

        .goal-text.completed {
            text-decoration: line-through;
            color: #888;
        }

        .goal-add {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .goal-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #4caf50;
            border-radius: 10px;
        }

        .goal-add-btn {
            padding: 10px 20px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        /* Batch 75: Concept Connector */
        .connector-btn {
            position: fixed;
            right: 18px;
            bottom: 1310px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bcd4, #80deea);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connector-btn:hover {
            transform: scale(1.1);
        }

        .connector-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .connector-modal.active {
            display: flex;
        }

        .connector-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow: hidden;
        }

        .connector-modal-header {
            background: linear-gradient(135deg, #00bcd4, #80deea);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .connector-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .concept-main {
            text-align: center;
            padding: 20px;
            background: #e0f7fa;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .concept-main h4 {
            color: #00bcd4;
            margin: 0 0 10px 0;
            font-size: 1.3rem;
        }

        .concept-related {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .concept-link {
            padding: 12px;
            background: #b2ebf2;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .concept-link:hover {
            background: #80deea;
        }

        /* Mini Quiz Generator */
        .miniquiz-btn {
            position: fixed;
            left: 18px;
            bottom: 1790px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #673ab7, #b39ddb);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(103, 58, 183, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .miniquiz-btn:hover {
            transform: scale(1.1);
        }

        .miniquiz-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .miniquiz-modal.active {
            display: flex;
        }

        .miniquiz-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            overflow: hidden;
        }

        .miniquiz-modal-header {
            background: linear-gradient(135deg, #673ab7, #b39ddb);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .miniquiz-modal-body {
            padding: 20px;
        }

        .miniquiz-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .miniquiz-topic {
            padding: 8px 15px;
            border: 2px solid #673ab7;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .miniquiz-topic.active {
            background: #673ab7;
            color: white;
        }

        .miniquiz-question {
            background: #ede7f6;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        .miniquiz-options {
            display: grid;
            gap: 10px;
        }

        .miniquiz-option {
            padding: 12px;
            border: 2px solid #673ab7;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .miniquiz-option:hover {
            background: #ede7f6;
        }

        /* Learning Path */
        .path-btn {
            position: fixed;
            right: 18px;
            bottom: 1350px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #009688, #80cbc4);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 150, 136, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .path-btn:hover {
            transform: scale(1.1);
        }

        .path-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .path-modal.active {
            display: flex;
        }

        .path-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            max-height: 85vh;
            overflow: hidden;
        }

        .path-modal-header {
            background: linear-gradient(135deg, #009688, #80cbc4);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .path-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .path-step {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .path-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .path-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e0f2f1;
            border: 3px solid #009688;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .path-dot.completed {
            background: #009688;
            color: white;
        }

        .path-line {
            width: 3px;
            height: 30px;
            background: #b2dfdb;
        }

        .path-content {
            flex: 1;
            padding: 10px;
            background: #e0f2f1;
            border-radius: 10px;
        }

        .path-title {
            font-weight: bold;
            color: #009688;
        }

        .path-desc {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        /* Batch 76: Diagram Viewer */
        .diagram-btn {
            position: fixed;
            left: 18px;
            bottom: 1830px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63, #f48fb1);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .diagram-btn:hover {
            transform: scale(1.1);
        }

        .diagram-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .diagram-modal.active {
            display: flex;
        }

        .diagram-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow: hidden;
        }

        .diagram-modal-header {
            background: linear-gradient(135deg, #e91e63, #f48fb1);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .diagram-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .diagram-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .diagram-tab {
            padding: 8px 15px;
            border: 2px solid #e91e63;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .diagram-tab.active {
            background: #e91e63;
            color: white;
        }

        .diagram-display {
            background: #fce4ec;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .diagram-image {
            font-size: 5rem;
            margin-bottom: 15px;
        }

        .diagram-label {
            font-weight: bold;
            color: #e91e63;
            margin-bottom: 10px;
        }

        .diagram-parts {
            font-size: 0.9rem;
            color: #666;
            text-align: left;
        }

        /* Question Bookmark */
        .bookmark-btn {
            position: fixed;
            right: 18px;
            bottom: 1390px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9800, #ffcc80);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .bookmark-btn:hover {
            transform: scale(1.1);
        }

        .bookmark-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .bookmark-modal.active {
            display: flex;
        }

        .bookmark-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            max-height: 85vh;
            overflow: hidden;
        }

        .bookmark-modal-header {
            background: linear-gradient(135deg, #ff9800, #ffcc80);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bookmark-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .bookmark-item {
            padding: 15px;
            background: #fff3e0;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .bookmark-question {
            font-weight: bold;
            color: #e65100;
            margin-bottom: 8px;
        }

        .bookmark-answer {
            font-size: 0.9rem;
            color: #666;
        }

        .bookmark-remove {
            float: right;
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Sound Toggle */
        .sound-btn {
            position: fixed;
            left: 18px;
            bottom: 1870px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #607d8b, #90a4ae);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(96, 125, 139, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sound-btn:hover {
            transform: scale(1.1);
        }

        .sound-btn.muted {
            background: linear-gradient(135deg, #9e9e9e, #bdbdbd);
        }

        /* Batch 77: Speed Reading */
        .speed-read-btn {
            position: fixed;
            left: 18px;
            bottom: 1930px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bcd4, #4dd0e1);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .speed-read-btn:hover {
            transform: scale(1.1);
        }

        .speed-read-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .speed-read-modal.active {
            display: flex;
        }

        .speed-read-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow: hidden;
        }

        .speed-read-header {
            background: linear-gradient(135deg, #00bcd4, #4dd0e1);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .speed-read-body {
            padding: 20px;
        }

        .speed-read-display {
            font-size: 2rem;
            text-align: center;
            padding: 40px 20px;
            background: #e0f7fa;
            border-radius: 12px;
            margin-bottom: 15px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #006064;
            font-weight: bold;
        }

        .speed-read-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .speed-read-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .speed-wpm-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .speed-wpm-btn {
            padding: 8px 16px;
            border: 2px solid #00bcd4;
            border-radius: 20px;
            background: white;
            color: #00bcd4;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .speed-wpm-btn.active {
            background: #00bcd4;
            color: white;
        }

        /* Formula Cards */
        .formula-btn {
            position: fixed;
            right: 18px;
            bottom: 1450px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #673ab7, #9575cd);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(103, 58, 183, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .formula-btn:hover {
            transform: scale(1.1);
        }

        .formula-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .formula-modal.active {
            display: flex;
        }

        .formula-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            max-height: 85vh;
            overflow: hidden;
        }

        .formula-header {
            background: linear-gradient(135deg, #673ab7, #9575cd);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .formula-body {
            padding: 20px;
        }

        .formula-card {
            background: linear-gradient(135deg, #ede7f6, #d1c4e9);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            margin-bottom: 15px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .formula-name {
            font-size: 1.1rem;
            color: #673ab7;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .formula-equation {
            font-size: 1.8rem;
            color: #311b92;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .formula-description {
            font-size: 0.85rem;
            color: #666;
            margin-top: 10px;
        }

        .formula-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .formula-nav button {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            background: #673ab7;
            color: white;
        }

        .formula-counter {
            text-align: center;
            color: #666;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* Daily Streak */
        .streak-btn {
            position: fixed;
            left: 18px;
            bottom: 1990px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff5722, #ff8a65);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 87, 34, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .streak-btn:hover {
            transform: scale(1.1);
        }

        .streak-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .streak-modal.active {
            display: flex;
        }

        .streak-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }

        .streak-header {
            background: linear-gradient(135deg, #ff5722, #ff8a65);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .streak-body {
            padding: 20px;
            text-align: center;
        }

        .streak-number {
            font-size: 4rem;
            font-weight: bold;
            color: #ff5722;
            margin-bottom: 10px;
        }

        .streak-label {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .streak-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .streak-day {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            background: #f5f5f5;
            color: #999;
            margin: 0 auto;
        }

        .streak-day.active {
            background: linear-gradient(135deg, #ff5722, #ff8a65);
            color: white;
        }

        .streak-day.today {
            border: 2px solid #ff5722;
        }

        .streak-message {
            padding: 15px;
            background: #fff3e0;
            border-radius: 10px;
            color: #e65100;
            font-weight: bold;
        }

        /* Batch 78: Science Crossword */
        .crossword-btn {
            position: fixed;
            right: 18px;
            bottom: 1510px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #009688, #4db6ac);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 150, 136, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .crossword-btn:hover {
            transform: scale(1.1);
        }

        .crossword-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .crossword-modal.active {
            display: flex;
        }

        .crossword-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            max-height: 90vh;
            overflow: hidden;
        }

        .crossword-header {
            background: linear-gradient(135deg, #009688, #4db6ac);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .crossword-body {
            padding: 20px;
            max-height: 75vh;
            overflow-y: auto;
        }

        .crossword-grid {
            display: grid;
            grid-template-columns: repeat(5, 40px);
            gap: 2px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .crossword-cell {
            width: 40px;
            height: 40px;
            border: 2px solid #009688;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .crossword-cell:disabled {
            background: #e0f2f1;
            border-color: #b2dfdb;
        }

        .crossword-clues {
            font-size: 0.9rem;
            color: #333;
        }

        .crossword-clue {
            padding: 8px;
            background: #e0f7fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        /* Element Quiz */
        .element-quiz-btn {
            position: fixed;
            left: 18px;
            bottom: 2050px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #795548, #a1887f);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(121, 85, 72, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .element-quiz-btn:hover {
            transform: scale(1.1);
        }

        .element-quiz-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .element-quiz-modal.active {
            display: flex;
        }

        .element-quiz-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            overflow: hidden;
        }

        .element-quiz-header {
            background: linear-gradient(135deg, #795548, #a1887f);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .element-quiz-body {
            padding: 20px;
        }

        .element-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #efebe9, #d7ccc8);
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .element-symbol {
            font-size: 4rem;
            font-weight: bold;
            color: #4e342e;
        }

        .element-number {
            font-size: 1rem;
            color: #795548;
        }

        .element-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .element-option {
            padding: 12px;
            border: 2px solid #795548;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .element-option:hover {
            background: #efebe9;
        }

        .element-option.correct {
            background: #c8e6c9;
            border-color: #4caf50;
        }

        .element-option.wrong {
            background: #ffcdd2;
            border-color: #f44336;
        }

        .element-score {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            color: #795548;
        }

        /* Study Mode */
        .study-mode-btn {
            position: fixed;
            right: 18px;
            bottom: 1570px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3f51b5, #7986cb);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(63, 81, 181, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .study-mode-btn:hover {
            transform: scale(1.1);
        }

        .study-mode-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 35, 126, 0.95);
            z-index: 10002;
            justify-content: center;
            align-items: center;
        }

        .study-mode-overlay.active {
            display: flex;
        }

        .study-mode-container {
            text-align: center;
            color: white;
            max-width: 600px;
            padding: 40px;
        }

        .study-mode-title {
            font-size: 2rem;
            margin-bottom: 30px;
        }

        .study-mode-quote {
            font-size: 1.3rem;
            font-style: italic;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .study-mode-author {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 40px;
        }

        .study-mode-timer {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .study-mode-btn-exit {
            padding: 15px 40px;
            background: white;
            color: #3f51b5;
            border: none;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }

        /* Batch 79: Science Bingo */
        .bingo-btn {
            position: fixed;
            left: 18px;
            bottom: 2110px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63, #f48fb1);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .bingo-btn:hover {
            transform: scale(1.1);
        }

        .bingo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .bingo-modal.active {
            display: flex;
        }

        .bingo-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }

        .bingo-header {
            background: linear-gradient(135deg, #e91e63, #f48fb1);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bingo-body {
            padding: 20px;
        }

        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }

        .bingo-cell {
            aspect-ratio: 1;
            border: 2px solid #e91e63;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            text-align: center;
            padding: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .bingo-cell.marked {
            background: linear-gradient(135deg, #e91e63, #f48fb1);
            color: white;
        }

        .bingo-cell.free {
            background: #fce4ec;
            font-weight: bold;
        }

        .bingo-call {
            text-align: center;
            padding: 15px;
            background: #fce4ec;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .bingo-call-term {
            font-size: 1.2rem;
            font-weight: bold;
            color: #c2185b;
        }

        /* Concept Map */
        .concept-map-btn {
            position: fixed;
            right: 18px;
            bottom: 1630px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00695c, #4db6ac);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 105, 92, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .concept-map-btn:hover {
            transform: scale(1.1);
        }

        .concept-map-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .concept-map-modal.active {
            display: flex;
        }

        .concept-map-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow: hidden;
        }

        .concept-map-header {
            background: linear-gradient(135deg, #00695c, #4db6ac);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .concept-map-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .concept-node {
            display: inline-block;
            padding: 10px 15px;
            background: linear-gradient(135deg, #e0f2f1, #b2dfdb);
            border-radius: 20px;
            margin: 5px;
            font-weight: bold;
            color: #00695c;
            border: 2px solid #00695c;
        }

        .concept-node.central {
            background: linear-gradient(135deg, #00695c, #26a69a);
            color: white;
            font-size: 1.1rem;
            border: none;
        }

        .concept-arrow {
            color: #00695c;
            font-size: 1.5rem;
            margin: 5px;
        }

        .concept-row {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        /* Progress Graph */
        .progress-graph-btn {
            position: fixed;
            left: 18px;
            bottom: 2170px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(21, 101, 192, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .progress-graph-btn:hover {
            transform: scale(1.1);
        }

        .progress-graph-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .progress-graph-modal.active {
            display: flex;
        }

        .progress-graph-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            overflow: hidden;
        }

        .progress-graph-header {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-graph-body {
            padding: 20px;
        }

        .graph-container {
            height: 200px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding: 20px 10px;
            background: #e3f2fd;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .graph-bar {
            width: 30px;
            background: linear-gradient(to top, #1565c0, #64b5f6);
            border-radius: 5px 5px 0 0;
            transition: height 0.5s ease;
            position: relative;
        }

        .graph-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: #666;
        }

        .graph-bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            font-weight: bold;
            color: #1565c0;
        }

        .graph-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .graph-stat {
            padding: 15px;
            background: #e3f2fd;
            border-radius: 10px;
            text-align: center;
        }

        .graph-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1565c0;
        }

        .graph-stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        /* Batch 80: Science Timer Challenge */
        .timer-challenge-btn {
            position: fixed;
            right: 18px;
            bottom: 1690px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d32f2f, #ef5350);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .timer-challenge-btn:hover {
            transform: scale(1.1);
        }

        .timer-challenge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .timer-challenge-modal.active {
            display: flex;
        }

        .timer-challenge-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            overflow: hidden;
        }

        .timer-challenge-header {
            background: linear-gradient(135deg, #d32f2f, #ef5350);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timer-challenge-body {
            padding: 20px;
        }

        .timer-display {
            text-align: center;
            font-size: 3rem;
            font-weight: bold;
            color: #d32f2f;
            margin-bottom: 15px;
        }

        .timer-display.warning {
            color: #ff9800;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .timer-question {
            padding: 20px;
            background: #ffebee;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
        }

        .timer-options {
            display: grid;
            gap: 10px;
        }

        .timer-option {
            padding: 15px;
            border: 2px solid #d32f2f;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .timer-option:hover {
            background: #ffebee;
        }

        .timer-score {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            color: #d32f2f;
        }

        /* Keyword Search */
        .keyword-search-btn {
            position: fixed;
            left: 18px;
            bottom: 2230px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7b1fa2, #ba68c8);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(123, 31, 162, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .keyword-search-btn:hover {
            transform: scale(1.1);
        }

        .keyword-search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .keyword-search-modal.active {
            display: flex;
        }

        .keyword-search-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow: hidden;
        }

        .keyword-search-header {
            background: linear-gradient(135deg, #7b1fa2, #ba68c8);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .keyword-search-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .keyword-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #7b1fa2;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .keyword-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .keyword-item {
            padding: 15px;
            background: #f3e5f5;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .keyword-term {
            font-weight: bold;
            color: #7b1fa2;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .keyword-definition {
            color: #666;
            font-size: 0.9rem;
        }

        /* Note Taker */
        .note-taker-btn {
            position: fixed;
            right: 18px;
            bottom: 1750px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffa000, #ffca28);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 160, 0, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .note-taker-btn:hover {
            transform: scale(1.1);
        }

        .note-taker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .note-taker-modal.active {
            display: flex;
        }

        .note-taker-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow: hidden;
        }

        .note-taker-header {
            background: linear-gradient(135deg, #ffa000, #ffca28);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-taker-body {
            padding: 20px;
        }

        .note-textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #ffa000;
            border-radius: 10px;
            font-size: 1rem;
            resize: none;
            margin-bottom: 15px;
        }

        .note-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .note-item {
            padding: 12px;
            background: #fff8e1;
            border-radius: 8px;
            margin-bottom: 8px;
            position: relative;
        }

        .note-item-text {
            font-size: 0.9rem;
            color: #333;
            padding-right: 30px;
        }

        .note-item-date {
            font-size: 0.75rem;
            color: #999;
            margin-top: 5px;
        }

        .note-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Batch 81: Science Joke */
        .joke-btn {
            position: fixed;
            left: 18px;
            bottom: 2290px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6f00, #ffb74d);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 111, 0, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .joke-btn:hover {
            transform: scale(1.1);
        }

        .joke-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .joke-modal.active {
            display: flex;
        }

        .joke-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }

        .joke-header {
            background: linear-gradient(135deg, #ff6f00, #ffb74d);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .joke-body {
            padding: 25px;
            text-align: center;
        }

        .joke-text {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .joke-punchline {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ff6f00;
            padding: 15px;
            background: #fff3e0;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* Lab Safety Quiz */
        .lab-safety-btn {
            position: fixed;
            right: 18px;
            bottom: 1810px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c62828, #ef5350);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(198, 40, 40, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .lab-safety-btn:hover {
            transform: scale(1.1);
        }

        .lab-safety-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .lab-safety-modal.active {
            display: flex;
        }

        .lab-safety-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            overflow: hidden;
        }

        .lab-safety-header {
            background: linear-gradient(135deg, #c62828, #ef5350);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lab-safety-body {
            padding: 20px;
        }

        .safety-question {
            padding: 20px;
            background: #ffebee;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 1.05rem;
        }

        .safety-options {
            display: grid;
            gap: 10px;
        }

        .safety-option {
            padding: 15px;
            border: 2px solid #c62828;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .safety-option:hover {
            background: #ffebee;
        }

        .safety-option.correct {
            background: #c8e6c9;
            border-color: #4caf50;
        }

        .safety-option.wrong {
            background: #ffcdd2;
            border-color: #f44336;
        }

        /* Quick Convert */
        .convert-btn {
            position: fixed;
            left: 18px;
            bottom: 2350px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0288d1, #4fc3f7);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(2, 136, 209, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .convert-btn:hover {
            transform: scale(1.1);
        }

        .convert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .convert-modal.active {
            display: flex;
        }

        .convert-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }

        .convert-header {
            background: linear-gradient(135deg, #0288d1, #4fc3f7);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .convert-body {
            padding: 20px;
        }

        .convert-type-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #0288d1;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .convert-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .convert-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #0288d1;
            border-radius: 10px;
            font-size: 1rem;
        }

        .convert-unit {
            padding: 12px 15px;
            background: #e1f5fe;
            border-radius: 10px;
            font-weight: bold;
            color: #0288d1;
        }

        .convert-result {
            padding: 20px;
            background: #e1f5fe;
            border-radius: 12px;
            text-align: center;
        }

        .convert-result-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0288d1;
        }

        .convert-result-unit {
            font-size: 1rem;
            color: #666;
        }

        /* Batch 82: Science Timeline */
        .timeline-btn {
            position: fixed;
            right: 18px;
            bottom: 1870px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5d4037, #8d6e63);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(93, 64, 55, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .timeline-btn:hover {
            transform: scale(1.1);
        }

        .timeline-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .timeline-modal.active {
            display: flex;
        }

        .timeline-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow: hidden;
        }

        .timeline-header {
            background: linear-gradient(135deg, #5d4037, #8d6e63);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timeline-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 15px;
        }

        .timeline-year {
            width: 60px;
            font-weight: bold;
            color: #5d4037;
            flex-shrink: 0;
        }

        .timeline-event {
            flex: 1;
            padding: 12px;
            background: #efebe9;
            border-radius: 10px;
            border-left: 4px solid #5d4037;
        }

        .timeline-title {
            font-weight: bold;
            color: #3e2723;
            margin-bottom: 5px;
        }

        .timeline-desc {
            font-size: 0.85rem;
            color: #666;
        }

        /* Lab Equipment */
        .equipment-btn {
            position: fixed;
            left: 18px;
            bottom: 2410px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #455a64, #78909c);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(69, 90, 100, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .equipment-btn:hover {
            transform: scale(1.1);
        }

        .equipment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .equipment-modal.active {
            display: flex;
        }

        .equipment-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            max-height: 85vh;
            overflow: hidden;
        }

        .equipment-header {
            background: linear-gradient(135deg, #455a64, #78909c);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .equipment-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .equipment-card {
            padding: 20px;
            background: #eceff1;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 15px;
        }

        .equipment-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .equipment-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #37474f;
            margin-bottom: 10px;
        }

        .equipment-use {
            font-size: 0.9rem;
            color: #666;
        }

        .equipment-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .equipment-nav button {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            background: #455a64;
            color: white;
        }

        /* Quick Quiz Mode */
        .quick-quiz-btn {
            position: fixed;
            right: 18px;
            bottom: 1930px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00897b, #4db6ac);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 137, 123, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .quick-quiz-btn:hover {
            transform: scale(1.1);
        }

        .quick-quiz-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .quick-quiz-modal.active {
            display: flex;
        }

        .quick-quiz-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            overflow: hidden;
        }

        .quick-quiz-header {
            background: linear-gradient(135deg, #00897b, #4db6ac);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quick-quiz-body {
            padding: 20px;
        }

        .quick-quiz-question {
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: #e0f2f1;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .quick-quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .quick-quiz-option {
            padding: 15px;
            border: 2px solid #00897b;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
        }

        .quick-quiz-option:hover {
            background: #e0f2f1;
        }

        .quick-quiz-option.correct {
            background: #c8e6c9;
            border-color: #4caf50;
        }

        .quick-quiz-option.wrong {
            background: #ffcdd2;
            border-color: #f44336;
        }

        .quick-quiz-counter {
            text-align: center;
            margin-top: 15px;
            color: #00897b;
            font-weight: bold;
        }

        /* Batch 83: Science Quote */
        .quote-btn {
            position: fixed;
            left: 18px;
            bottom: 2470px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a1b9a, #ab47bc);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(106, 27, 154, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .quote-btn:hover {
            transform: scale(1.1);
        }

        .quote-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .quote-modal.active {
            display: flex;
        }

        .quote-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            overflow: hidden;
        }

        .quote-header {
            background: linear-gradient(135deg, #6a1b9a, #ab47bc);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quote-body {
            padding: 30px;
            text-align: center;
        }

        .quote-text {
            font-size: 1.2rem;
            font-style: italic;
            color: #333;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .quote-author {
            font-weight: bold;
            color: #6a1b9a;
        }

        /* Practice Mode */
        .practice-btn {
            position: fixed;
            right: 18px;
            bottom: 1990px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1976d2, #64b5f6);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .practice-btn:hover {
            transform: scale(1.1);
        }

        .practice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .practice-modal.active {
            display: flex;
        }

        .practice-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            overflow: hidden;
        }

        .practice-header {
            background: linear-gradient(135deg, #1976d2, #64b5f6);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .practice-body {
            padding: 20px;
        }

        .practice-topic-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #1976d2;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .practice-question {
            padding: 20px;
            background: #e3f2fd;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 1.05rem;
            text-align: center;
        }

        .practice-options {
            display: grid;
            gap: 10px;
        }

        .practice-option {
            padding: 15px;
            border: 2px solid #1976d2;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .practice-option:hover {
            background: #e3f2fd;
        }

        .practice-option.correct {
            background: #c8e6c9;
            border-color: #4caf50;
        }

        .practice-option.wrong {
            background: #ffcdd2;
            border-color: #f44336;
        }

        /* Daily Challenge */
        .daily-challenge-btn {
            position: fixed;
            left: 18px;
            bottom: 2530px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f57c00, #ffb74d);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(245, 124, 0, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .daily-challenge-btn:hover {
            transform: scale(1.1);
        }

        .daily-challenge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .daily-challenge-modal.active {
            display: flex;
        }

        .daily-challenge-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            overflow: hidden;
        }

        .daily-challenge-header {
            background: linear-gradient(135deg, #f57c00, #ffb74d);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .daily-challenge-body {
            padding: 20px;
        }

        .challenge-info {
            text-align: center;
            padding: 20px;
            background: #fff3e0;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .challenge-date {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .challenge-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e65100;
            margin-bottom: 10px;
        }

        .challenge-desc {
            font-size: 0.95rem;
            color: #333;
        }

        .challenge-progress {
            text-align: center;
            margin-bottom: 15px;
        }

        .challenge-progress-bar {
            height: 20px;
            background: #ffe0b2;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .challenge-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f57c00, #ffb74d);
            transition: width 0.3s ease;
        }

        .challenge-reward {
            padding: 15px;
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            color: #e65100;
        }

        /* Batch 84: Science Vocab Builder */
        .vocab-btn {
            position: fixed;
            right: 18px;
            bottom: 2050px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5c6bc0, #9fa8da);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(92, 107, 192, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .vocab-btn:hover {
            transform: scale(1.1);
        }

        .vocab-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .vocab-modal.active {
            display: flex;
        }

        .vocab-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            overflow: hidden;
        }

        .vocab-header {
            background: linear-gradient(135deg, #5c6bc0, #9fa8da);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vocab-body {
            padding: 20px;
        }

        .vocab-card {
            padding: 25px;
            background: linear-gradient(135deg, #e8eaf6, #c5cae9);
            border-radius: 12px;
            text-align: center;
            margin-bottom: 15px;
        }

        .vocab-word {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3949ab;
            margin-bottom: 10px;
        }

        .vocab-definition {
            font-size: 0.95rem;
            color: #666;
            display: none;
        }

        .vocab-definition.show {
            display: block;
        }

        .vocab-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .vocab-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Experiment Log */
        .exp-log-btn {
            position: fixed;
            left: 18px;
            bottom: 2590px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #388e3c, #81c784);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(56, 142, 60, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .exp-log-btn:hover {
            transform: scale(1.1);
        }

        .exp-log-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .exp-log-modal.active {
            display: flex;
        }

        .exp-log-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 480px;
            max-height: 85vh;
            overflow: hidden;
        }

        .exp-log-header {
            background: linear-gradient(135deg, #388e3c, #81c784);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exp-log-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .exp-log-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #388e3c;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .exp-log-textarea {
            width: 100%;
            height: 80px;
            padding: 12px;
            border: 2px solid #388e3c;
            border-radius: 10px;
            margin-bottom: 10px;
            resize: none;
        }

        .exp-log-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .exp-log-item {
            padding: 12px;
            background: #e8f5e9;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #388e3c;
        }

        .exp-log-item-title {
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 5px;
        }

        .exp-log-item-notes {
            font-size: 0.85rem;
            color: #666;
        }

        .exp-log-item-date {
            font-size: 0.75rem;
            color: #999;
            margin-top: 5px;
        }

        /* Brain Break */
        .brain-break-btn {
            position: fixed;
            right: 18px;
            bottom: 2110px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63, #f48fb1);
            color: white;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .brain-break-btn:hover {
            transform: scale(1.1);
        }

        .brain-break-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .brain-break-modal.active {
            display: flex;
        }

        .brain-break-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }

        .brain-break-header {
            background: linear-gradient(135deg, #e91e63, #f48fb1);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brain-break-body {
            padding: 25px;
            text-align: center;
        }

        .brain-break-activity {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .brain-break-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #c2185b;
            margin-bottom: 10px;
        }

        .brain-break-desc {
            color: #666;
            margin-bottom: 20px;
        }

        .brain-break-timer {
            font-size: 2.5rem;
            font-weight: bold;
            color: #e91e63;
            margin-bottom: 15px;
        }

        /* Batch 85: Science Word of the Day */
        .wotd-btn {
            position: fixed;
            right: 18px;
            bottom: 2110px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00897b, #4db6ac);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 137, 123, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .wotd-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 137, 123, 0.5);
        }

        .wotd-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .wotd-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .wotd-word {
            font-size: 2rem;
            font-weight: bold;
            color: #00897b;
            margin-bottom: 10px;
        }

        .wotd-pronunciation {
            color: #666;
            font-style: italic;
            margin-bottom: 15px;
        }

        .wotd-definition {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .wotd-example {
            background: #e0f2f1;
            padding: 15px;
            border-radius: 10px;
            color: #00695c;
            font-style: italic;
        }

        /* Lab Report Builder */
        .lab-report-btn {
            position: fixed;
            left: 18px;
            bottom: 2650px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5d4037, #8d6e63);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(93, 64, 55, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .lab-report-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(93, 64, 55, 0.5);
        }

        .lab-report-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .lab-report-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 550px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .lab-report-section {
            margin-bottom: 15px;
        }

        .lab-report-section label {
            display: block;
            font-weight: bold;
            color: #5d4037;
            margin-bottom: 5px;
        }

        .lab-report-section textarea,
        .lab-report-section input {
            width: 100%;
            padding: 10px;
            border: 2px solid #d7ccc8;
            border-radius: 8px;
            font-size: 0.95rem;
            box-sizing: border-box;
        }

        .lab-report-section textarea:focus,
        .lab-report-section input:focus {
            border-color: #8d6e63;
            outline: none;
        }

        /* Quick Reference Cards */
        .quick-ref-btn {
            position: fixed;
            right: 18px;
            bottom: 2170px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1565c0, #42a5f5);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(21, 101, 192, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .quick-ref-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(21, 101, 192, 0.5);
        }

        .quick-ref-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .quick-ref-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .quick-ref-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .quick-ref-tab {
            padding: 8px 16px;
            border: none;
            background: #e3f2fd;
            color: #1565c0;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .quick-ref-tab.active {
            background: #1565c0;
            color: white;
        }

        .quick-ref-card {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .quick-ref-card h4 {
            color: #1565c0;
            margin: 0 0 8px 0;
        }

        .quick-ref-card p {
            margin: 0;
            color: #555;
            font-family: monospace;
            font-size: 0.95rem;
        }

        /* Batch 86: Science Meme Generator */
        .meme-btn {
            position: fixed;
            right: 18px;
            bottom: 2230px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f57c00, #ffb74d);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(245, 124, 0, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .meme-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(245, 124, 0, 0.5);
        }

        .meme-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .meme-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .meme-display {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 15px;
        }

        .meme-emoji {
            font-size: 4rem;
            margin-bottom: 10px;
        }

        .meme-text {
            font-size: 1.1rem;
            color: #e65100;
            font-weight: 600;
            line-height: 1.5;
        }

        .meme-fact {
            background: #fff8e1;
            padding: 12px;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #ff6f00;
            margin-top: 15px;
        }

        /* Formula Solver */
        .formula-solver-btn {
            position: fixed;
            left: 18px;
            bottom: 2710px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7b1fa2, #ba68c8);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(123, 31, 162, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .formula-solver-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(123, 31, 162, 0.5);
        }

        .formula-solver-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .formula-solver-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .formula-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1bee7;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .formula-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .formula-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .formula-input-row label {
            min-width: 100px;
            font-weight: 600;
            color: #7b1fa2;
        }

        .formula-input-row input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e1bee7;
            border-radius: 8px;
        }

        .formula-result {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
            color: #7b1fa2;
        }

        /* Revision Checklist */
        .revision-btn {
            position: fixed;
            right: 18px;
            bottom: 2290px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00695c, #4db6ac);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 105, 92, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .revision-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 105, 92, 0.5);
        }

        .revision-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .revision-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .revision-topic {
            background: #e0f2f1;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .revision-topic:hover {
            background: #b2dfdb;
        }

        .revision-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .revision-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .revision-progress {
            background: #e0f2f1;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 15px;
        }

        .revision-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00695c, #26a69a);
            transition: width 0.3s ease;
        }

        /* Batch 87: Science Trivia Wheel */
        .trivia-wheel-btn {
            position: fixed;
            right: 18px;
            bottom: 2350px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c2185b, #f06292);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(194, 24, 91, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .trivia-wheel-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(194, 24, 91, 0.5);
        }

        .trivia-wheel-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .trivia-wheel-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .wheel-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
        }

        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                #e91e63 0deg 60deg,
                #9c27b0 60deg 120deg,
                #3f51b5 120deg 180deg,
                #00bcd4 180deg 240deg,
                #4caf50 240deg 300deg,
                #ff9800 300deg 360deg
            );
            transition: transform 3s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #333;
            z-index: 10;
        }

        .trivia-question-box {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .trivia-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .trivia-option {
            padding: 12px;
            border: 2px solid #c2185b;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .trivia-option:hover {
            background: #fce4ec;
        }

        .trivia-option.correct {
            background: #c8e6c9;
            border-color: #4caf50;
        }

        .trivia-option.wrong {
            background: #ffcdd2;
            border-color: #f44336;
        }

        /* Focus Timer */
        .focus-timer-btn {
            position: fixed;
            left: 18px;
            bottom: 2770px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0288d1, #4fc3f7);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(2, 136, 209, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .focus-timer-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(2, 136, 209, 0.5);
        }

        .focus-timer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .focus-timer-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 350px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .timer-display {
            font-size: 4rem;
            font-weight: bold;
            color: #0288d1;
            margin: 20px 0;
            font-family: monospace;
        }

        .timer-presets {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .timer-preset {
            padding: 8px 16px;
            border: 2px solid #0288d1;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            color: #0288d1;
            transition: all 0.3s ease;
        }

        .timer-preset:hover, .timer-preset.active {
            background: #0288d1;
            color: white;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .timer-controls button {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        /* Flashcard Deck */
        .flashcard-btn {
            position: fixed;
            right: 18px;
            bottom: 2410px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a1b9a, #ab47bc);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(106, 27, 154, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .flashcard-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(106, 27, 154, 0.5);
        }

        .flashcard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .flashcard-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .flashcard-display {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            min-height: 150px;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .flashcard-display:hover {
            transform: scale(1.02);
        }

        .flashcard-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .flashcard-nav button {
            padding: 10px 20px;
            border: none;
            background: #6a1b9a;
            color: white;
            border-radius: 20px;
            cursor: pointer;
        }

        .flashcard-add {
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .flashcard-add input, .flashcard-add textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1bee7;
            border-radius: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        /* Batch 88: Study Goals */
        .study-goals-btn {
            position: fixed;
            left: 18px;
            bottom: 2830px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #388e3c, #81c784);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(56, 142, 60, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .study-goals-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(56, 142, 60, 0.5);
        }

        .study-goals-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .study-goals-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 420px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .goal-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .goal-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .goal-text {
            flex: 1;
            font-weight: 500;
        }

        .goal-text.completed {
            text-decoration: line-through;
            color: #9e9e9e;
        }

        .add-goal-section {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .add-goal-section input {
            flex: 1;
            padding: 10px;
            border: 2px solid #81c784;
            border-radius: 8px;
        }

        /* Science News Feed */
        .science-news-btn {
            position: fixed;
            right: 18px;
            bottom: 2470px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d32f2f, #ef5350);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .science-news-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(211, 47, 47, 0.5);
        }

        .science-news-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .science-news-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .news-item {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .news-category {
            display: inline-block;
            background: #d32f2f;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-bottom: 8px;
        }

        .news-title {
            font-weight: bold;
            color: #b71c1c;
            margin-bottom: 8px;
        }

        .news-snippet {
            color: #555;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Achievement Badges */
        .badges-btn {
            position: fixed;
            right: 18px;
            bottom: 2530px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffc107, #ffeb3b);
            color: #333;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .badges-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.5);
        }

        .badges-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .badges-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .badge-item {
            text-align: center;
            padding: 15px 10px;
            background: #f5f5f5;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .badge-item.unlocked {
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
            border: 2px solid #ffc107;
        }

        .badge-item.locked {
            opacity: 0.5;
            filter: grayscale(100%);
        }

        .badge-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .badge-name {
            font-size: 0.8rem;
            font-weight: bold;
            color: #333;
        }

        .badge-desc {
            font-size: 0.7rem;
            color: #666;
            margin-top: 4px;
        }

        /* Batch 89: Science Dictionary */
        .dict-btn {
            position: fixed;
            left: 18px;
            bottom: 2890px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #455a64, #78909c);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(69, 90, 100, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .dict-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(69, 90, 100, 0.5);
        }

        .dict-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .dict-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .dict-search {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #78909c;
            border-radius: 25px;
            font-size: 1rem;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .dict-result {
            background: linear-gradient(135deg, #eceff1, #cfd8dc);
            padding: 20px;
            border-radius: 15px;
        }

        .dict-term {
            font-size: 1.4rem;
            font-weight: bold;
            color: #37474f;
            margin-bottom: 10px;
        }

        .dict-definition {
            color: #546e7a;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .dict-category {
            display: inline-block;
            background: #455a64;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        /* Study Streak Tracker */
        .streak-btn {
            position: fixed;
            right: 18px;
            bottom: 2590px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff5722, #ff8a65);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 87, 34, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .streak-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 87, 34, 0.5);
        }

        .streak-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .streak-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 380px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .streak-number {
            font-size: 5rem;
            font-weight: bold;
            color: #ff5722;
            line-height: 1;
        }

        .streak-label {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .streak-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .streak-day {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            margin: 0 auto;
        }

        .streak-day.active {
            background: linear-gradient(135deg, #ff5722, #ff8a65);
            color: white;
        }

        .streak-day.inactive {
            background: #f5f5f5;
            color: #bbb;
        }

        .streak-day.today {
            border: 2px solid #ff5722;
        }

        /* Quick Notes */
        .quick-notes-btn {
            position: fixed;
            right: 18px;
            bottom: 2650px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9c27b0, #ce93d8);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .quick-notes-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.5);
        }

        .quick-notes-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .quick-notes-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 420px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .sticky-note {
            background: linear-gradient(135deg, #fff59d, #fff176);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .sticky-note-text {
            color: #5d4037;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }

        .sticky-note-date {
            font-size: 0.75rem;
            color: #8d6e63;
            margin-top: 8px;
        }

        .sticky-note-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: #d32f2f;
            cursor: pointer;
            font-size: 1rem;
        }

        .add-note-area {
            margin-top: 15px;
        }

        .add-note-area textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ce93d8;
            border-radius: 10px;
            resize: none;
            box-sizing: border-box;
        }

        /* Batch 90: Quiz History */
        .quiz-history-btn {
            position: fixed;
            left: 18px;
            bottom: 2950px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1976d2, #64b5f6);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .quiz-history-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.5);
        }

        .quiz-history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .quiz-history-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #e3f2fd;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .history-score {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1976d2;
        }

        .history-date {
            font-size: 0.8rem;
            color: #666;
        }

        .history-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 12px;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #1976d2;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #666;
        }

        /* Science Challenge */
        .challenge-btn {
            position: fixed;
            right: 18px;
            bottom: 2710px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63, #f48fb1);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .challenge-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(233, 30, 99, 0.5);
        }

        .challenge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .challenge-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .challenge-timer {
            font-size: 3rem;
            font-weight: bold;
            color: #e91e63;
            margin: 15px 0;
        }

        .challenge-question {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #880e4f;
        }

        .challenge-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #f48fb1;
            border-radius: 10px;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        /* Learning Path */
        .learning-path-btn {
            position: fixed;
            right: 18px;
            bottom: 2770px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00796b, #4db6ac);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 121, 107, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .learning-path-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 121, 107, 0.5);
        }

        .learning-path-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .learning-path-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .path-topic {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #e0f2f1;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .path-topic:hover {
            background: #b2dfdb;
        }

        .path-topic.completed {
            background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
        }

        .path-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #00796b;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .path-topic.completed .path-number {
            background: #4caf50;
        }

        .path-info {
            flex: 1;
        }

        .path-title {
            font-weight: bold;
            color: #00695c;
        }

        .path-desc {
            font-size: 0.85rem;
            color: #666;
        }

        /* Batch 91: Science Tip of the Day */
        .tip-btn {
            position: fixed;
            left: 18px;
            bottom: 3010px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6f00, #ffb74d);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 111, 0, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .tip-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 111, 0, 0.5);
        }

        .tip-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .tip-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .tip-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .tip-text {
            font-size: 1.1rem;
            color: #333;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .tip-category {
            display: inline-block;
            background: #ff6f00;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        /* Memory Game */
        .memory-btn {
            position: fixed;
            right: 18px;
            bottom: 2830px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c4dff, #b388ff);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(124, 77, 255, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .memory-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(124, 77, 255, 0.5);
        }

        .memory-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .memory-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .memory-card {
            height: 60px;
            background: linear-gradient(135deg, #ede7f6, #d1c4e9);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: bold;
            color: transparent;
            transition: all 0.3s ease;
            padding: 5px;
            text-align: center;
        }

        .memory-card.flipped {
            background: linear-gradient(135deg, #7c4dff, #b388ff);
            color: white;
        }

        .memory-card.matched {
            background: linear-gradient(135deg, #4caf50, #81c784);
            color: white;
        }

        /* Quick Quiz Generator */
        .quick-quiz-btn {
            position: fixed;
            right: 18px;
            bottom: 2890px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bcd4, #4dd0e1);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .quick-quiz-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 188, 212, 0.5);
        }

        .quick-quiz-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .quick-quiz-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .quiz-progress-bar {
            height: 8px;
            background: #e0f7fa;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .quiz-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00bcd4, #4dd0e1);
            transition: width 0.3s ease;
        }

        .quiz-question-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #00838f;
            margin-bottom: 15px;
            text-align: center;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quiz-option {
            padding: 12px 15px;
            background: #e0f7fa;
            border: 2px solid #4dd0e1;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .quiz-option:hover {
            background: #b2ebf2;
        }

        .quiz-option.correct {
            background: #c8e6c9;
            border-color: #4caf50;
        }

        .quiz-option.wrong {
            background: #ffcdd2;
            border-color: #f44336;
        }

        /* Batch 92: Science Scoreboard */
        .scoreboard-btn {
            position: fixed;
            left: 18px;
            bottom: 3070px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c62828, #ef5350);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(198, 40, 40, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .scoreboard-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(198, 40, 40, 0.5);
        }

        .scoreboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .scoreboard-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .scoreboard-rank {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .scoreboard-rank.gold {
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
            border: 2px solid #ffc107;
        }

        .scoreboard-rank.silver {
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            border: 2px solid #9e9e9e;
        }

        .scoreboard-rank.bronze {
            background: linear-gradient(135deg, #fbe9e7, #ffccbc);
            border: 2px solid #ff8a65;
        }

        .rank-number {
            font-size: 1.5rem;
            font-weight: bold;
            width: 40px;
        }

        .rank-xp {
            font-weight: bold;
            color: #c62828;
        }

        /* Random Fact Generator */
        .random-fact-btn {
            position: fixed;
            right: 18px;
            bottom: 2950px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2e7d32, #66bb6a);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .random-fact-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.5);
        }

        .random-fact-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .random-fact-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .fact-display {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .fact-emoji {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .fact-text {
            font-size: 1.1rem;
            color: #2e7d32;
            line-height: 1.6;
        }

        /* Homework Tracker */
        .homework-btn {
            position: fixed;
            right: 18px;
            bottom: 3010px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5e35b1, #9575cd);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(94, 53, 177, 0.4);
            z-index: 999;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }

        .homework-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(94, 53, 177, 0.5);
        }

        .homework-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .homework-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .homework-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #ede7f6;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .homework-item.completed {
            background: #e8f5e9;
            opacity: 0.7;
        }

        .homework-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
        }

        .homework-info {
            flex: 1;
        }

        .homework-title {
            font-weight: 600;
            color: #5e35b1;
        }

        .homework-item.completed .homework-title {
            text-decoration: line-through;
            color: #4caf50;
        }

        .homework-due {
            font-size: 0.8rem;
            color: #666;
        }

        .homework-due.overdue {
            color: #f44336;
            font-weight: bold;
        }

        .add-homework {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .add-homework input {
            padding: 10px;
            border: 2px solid #9575cd;
            border-radius: 8px;
        }

        /* Batch 93: Progress Rings */
        .progress-rings-btn {
            position: fixed;
            right: 20px;
            bottom: 3070px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c4dff, #536dfe);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.4rem;
            box-shadow: 0 4px 15px rgba(124, 77, 255, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .progress-rings-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(124, 77, 255, 0.6);
        }

        .progress-rings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .progress-rings-content {
            background: white;
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .ring-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .progress-ring {
            text-align: center;
        }

        .ring-svg {
            width: 80px;
            height: 80px;
            transform: rotate(-90deg);
        }

        .ring-bg {
            fill: none;
            stroke: #e0e0e0;
            stroke-width: 8;
        }

        .ring-progress {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .ring-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .ring-value {
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
        }

        /* Experiment Log */
        .experiment-log-btn {
            position: fixed;
            left: 18px;
            bottom: 3190px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00897b, #26a69a);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.4rem;
            box-shadow: 0 4px 15px rgba(0, 137, 123, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .experiment-log-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 137, 123, 0.6);
        }

        .experiment-log-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .experiment-log-content {
            background: linear-gradient(135deg, #e0f2f1, #ffffff);
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .experiment-entry {
            background: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #00897b;
        }

        .experiment-title {
            font-weight: bold;
            color: #00695c;
        }

        .experiment-date {
            font-size: 0.75rem;
            color: #999;
        }

        .experiment-notes {
            font-size: 0.85rem;
            color: #555;
            margin-top: 5px;
        }

        .add-experiment {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .add-experiment input,
        .add-experiment textarea {
            padding: 10px;
            border: 2px solid #26a69a;
            border-radius: 8px;
            font-family: inherit;
        }

        /* Study Timer Breaks */
        .study-break-btn {
            position: fixed;
            right: 20px;
            bottom: 3130px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ec407a, #f48fb1);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.4rem;
            box-shadow: 0 4px 15px rgba(236, 64, 122, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .study-break-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(236, 64, 122, 0.6);
        }

        .study-break-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .study-break-content {
            background: linear-gradient(135deg, #fce4ec, #ffffff);
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 380px;
            text-align: center;
        }

        .break-activity {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .break-emoji {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .break-title {
            font-weight: bold;
            color: #c2185b;
            font-size: 1.1rem;
        }

        .break-duration {
            color: #666;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .break-description {
            color: #555;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .new-break-btn {
            background: linear-gradient(135deg, #ec407a, #f48fb1);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            transition: transform 0.2s;
        }

        .new-break-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>

<body>

    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" onclick="toggleMobileSidebar()">
        <span id="mobile-menu-icon"></span>
    </button>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeMobileSidebar()" style="display: none;"></div>

    <!-- Version Indicator for debugging -->
    <div class="version-indicator" id="version-display"></div>

    <!-- Auth Overlay -->
    <div id="auth-overlay">
        <div class="auth-box">
            <img src="https://www.dropbox.com/scl/fi/h40yjlyg8ldefwfaa3dib/polymath-logo-sticker.png?rlkey=o1ra4taqy79gt9t8u096v82zj&raw=1"
                alt="Polymath Logo" class="auth-logo">
            <h2 id="auth-title" class="auth-title">Welcome Back!</h2>
            <p class="auth-subtitle" id="auth-subtitle">Sign in to continue your learning journey</p>

            <div class="error-msg" id="auth-error"></div>

            <input type="email" id="auth-email" class="auth-input" placeholder="Email Address">
            <input type="password" id="auth-pass" class="auth-input" placeholder="Password">
            
            <!-- Password Confirmation (Registration only) -->
            <input type="password" id="auth-pass-confirm" class="auth-input" placeholder="Confirm Password" style="display: none;">

            <div id="forgot-password-link" style="text-align: right; margin-bottom: 20px; margin-top: -10px;">
                <span class="toggle-link" onclick="handleForgotPassword()" style="font-size: 0.85rem;">Forgot
                    Password?</span>
            </div>

            <!-- Registration Fields (Hidden by default) -->
            <div id="reg-fields" style="display: none;">
                <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #1976d2;">
                    <div style="font-weight: 600; color: #1565c0; margin-bottom: 5px;"> Parent & Student Information</div>
                    <div style="font-size: 0.85rem; color: #666;">Please provide details for each student</div>
                </div>
                
                <input type="text" id="parent-name" class="auth-input" placeholder="Parent's Name">
                
                <div id="students-container">
                    <div class="student-entry" data-student-index="0">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" class="auth-input student-name" placeholder="Student's Name" style="flex: 1; margin-bottom: 0;">
                            <select class="auth-input student-level" style="width: 100px; margin-bottom: 0;">
                                <option value="">Level</option>
                                <option value="P3">P3</option>
                                <option value="P4">P4</option>
                                <option value="P5">P5</option>
                                <option value="P6">P6</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button type="button" onclick="addStudentEntry()" class="add-student-btn" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #e3f2fd; border: 2px dashed #1976d2; border-radius: 8px; color: #1976d2; font-weight: 600; cursor: pointer;">
                     Add Another Student
                </button>
            </div>

            <div id="legal-box" class="legal-check" style="display: none;">
                <input type="checkbox" id="legal-agree">
                <label for="legal-agree" style="font-size: 0.85rem; line-height: 1.4;">
                    By registering, logging in, and using this system, I confirm that I am a parent/guardian and agree to be liable for the tuition fees of the current month or whichever period is applicable. I acknowledge that Polymath Learning Centre reserves the right to change any aspect of this system at any time and may remove access to any student without prior notice at any time.
                </label>
            </div>

            <button onclick="handleLogin()" id="btn-login" class="auth-btn btn-primary">Login</button>
            <button onclick="handleGoogleLogin()" id="btn-google" class="auth-btn btn-google">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Sign in with
                Google
            </button>

            <span class="toggle-link" onclick="toggleAuthMode()">New here? Create an Account</span>
        </div>
    </div>
    
    <!-- First-time Google User Student Setup Modal -->
    <div id="google-setup-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 500px;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 3rem; margin-bottom: 0.5rem;"></div>
                <h3 style="color: #1976d2; margin: 0;">Welcome to Polymath!</h3>
                <p style="color: #666; margin-top: 0.5rem;">Let's set up your account</p>
            </div>
            
            <div class="error-msg" id="google-setup-error"></div>
            
            <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #1976d2;">
                <div style="font-weight: 600; color: #1565c0; margin-bottom: 5px;"> Student Information Required</div>
                <div style="font-size: 0.85rem; color: #666;">Please tell us about the student(s) using this account</div>
            </div>
            
            <div class="form-group">
                <label style="font-weight: 600; color: #333;">Parent's Name *</label>
                <input type="text" id="google-parent-name" class="auth-input" placeholder="Enter parent's name" style="margin-top: 5px;">
            </div>
            
            <div id="google-students-container">
                <label style="font-weight: 600; color: #333; display: block; margin-bottom: 10px;">Student(s) *</label>
                <div class="google-student-entry" data-student-index="0">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" class="auth-input google-student-name" placeholder="Student's Name" style="flex: 1; margin-bottom: 0;">
                        <select class="auth-input google-student-level" style="width: 100px; margin-bottom: 0;">
                            <option value="">Level</option>
                            <option value="P3">P3</option>
                            <option value="P4">P4</option>
                            <option value="P5">P5</option>
                            <option value="P6">P6</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <button type="button" onclick="addGoogleStudentEntry()" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #e3f2fd; border: 2px dashed #1976d2; border-radius: 8px; color: #1976d2; font-weight: 600; cursor: pointer;">
                 Add Another Student
            </button>
            
            <div class="legal-check" style="margin-bottom: 1rem;">
                <input type="checkbox" id="google-legal-agree">
                <label for="google-legal-agree" style="font-size: 0.85rem; line-height: 1.4;">
                    By registering, I confirm that I am a parent/guardian and agree to be liable for the tuition fees. I acknowledge that Polymath Learning Centre reserves the right to change any aspect of this system at any time.
                </label>
            </div>
            
            <button onclick="completeGoogleSetup()" class="btn-save" style="width: 100%; padding: 12px; font-size: 1rem;">
                 Complete Setup
            </button>
        </div>
    </div>

    <!-- Skip to main content link for accessibility -->
    <a href="#main-content-area" class="skip-link" style="position: absolute; top: -40px; left: 0; background: var(--primary-blue); color: white; padding: 8px 16px; z-index: 10002; text-decoration: none; font-weight: 600; border-radius: 0 0 8px 0; transition: top 0.3s;">Skip to main content</a>

    <div class="app-container" role="application" aria-label="CER Interactive Questions Application">
        <header class="app-header" role="banner">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.3rem;">
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                    <img src="https://www.dropbox.com/scl/fi/h40yjlyg8ldefwfaa3dib/polymath-logo-sticker.png?rlkey=o1ra4taqy79gt9t8u096v82zj&raw=1"
                        alt="Polymath Logo" class="app-logo">
                    <button class="print-btn tooltip-container" onclick="printAll()" data-tooltip="Print the current page or worksheet"> Print All</button>
                </div>
                <div class="header-icons">
                    <button class="header-icon-btn tooltip-container hidden" onclick="switchTab('flagged', this)" data-tooltip="View questions that have been flagged for review (Admin only)" id="header-flagged-btn">
                        
                        <span id="header-flagged-badge" class="header-icon-badge" style="display: none;">0</span>
                    </button>
                    <button class="header-icon-btn tooltip-container" onclick="switchTab('inbox', this)" data-tooltip="View messages and notifications from teachers" id="header-inbox-btn">
                        
                        <span id="header-inbox-badge" class="header-icon-badge" style="display: none;">0</span>
                    </button>
                    <button class="header-icon-btn tooltip-container" onclick="showAccountSettings()" data-tooltip="Access account settings and preferences" id="header-settings-btn">
                        
                    </button>
                    <button class="header-icon-btn tooltip-container" onclick="toggleDarkMode()" data-tooltip="Toggle dark/light mode (Alt+D)" id="dark-mode-toggle" aria-label="Toggle dark mode">
                        
                    </button>
                    <button class="tutorial-help-btn tooltip-container" onclick="startTutorial()" data-tooltip="Click to view a comprehensive tutorial covering all features of the app" id="header-tutorial-btn" style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-blue); color: white; border: none; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3); transition: all 0.3s;">
                        ?
                    </button>
                </div>
            </div>
            
            <!-- Horizontal Tab Groups - Practice, Progress, Learn -->
            <nav class="main-nav-groups" role="navigation" aria-label="Main navigation" style="display: flex; align-items: center; gap: 32px; padding: 8px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 8px;">
                <div class="nav-group" data-group="practice" style="position: relative;">
                    <button class="nav-group-btn" aria-expanded="false" aria-haspopup="true" aria-controls="practice-dropdown" style="background: none; border: none; font-size: 14px; font-weight: 600; color: var(--main-text); cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 6px;">
                        Practice
                        <span class="nav-arrow" aria-hidden="true" style="font-size: 10px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);"></span>
                    </button>
                    <div class="nav-dropdown" id="practice-dropdown" role="menu" aria-label="Practice menu" style="position: absolute; top: calc(100% + 4px); left: 0; background: white; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); padding: 8px; min-width: 220px; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000;">
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('practice', this)" data-tooltip="Practice mode - work through questions at your own pace" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; gap: 10px;">
                            <span></span> Practice Mode
                        </button>
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('worksheet', this)" data-tooltip="My Worksheet - view and manage your practice questions" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; justify-content: space-between;">
                            <span style="display: flex; align-items: center; gap: 10px;"><span></span> My Worksheet</span>
                            <span id="worksheet-count-header" style="background: var(--primary-blue); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">0</span>
                        </button>
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('saved-worksheets', this)" data-tooltip="Access your previously saved worksheets" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; gap: 10px;">
                            <span></span> Saved Worksheets
                        </button>
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('question-list', this)" data-tooltip="Question Library - browse and search all available questions" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; gap: 10px;">
                            <span></span> Question Library
                        </button>
                    </div>
                </div>
                
                <div class="nav-group" data-group="progress" style="position: relative;">
                    <button class="nav-group-btn" aria-expanded="false" aria-haspopup="true" aria-controls="progress-dropdown" style="background: none; border: none; font-size: 14px; font-weight: 600; color: var(--main-text); cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 6px;">
                        Progress
                        <span class="nav-arrow" aria-hidden="true" style="font-size: 10px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);"></span>
                    </button>
                    <div class="nav-dropdown" id="progress-dropdown" role="menu" aria-label="Progress menu" style="position: absolute; top: calc(100% + 4px); left: 0; background: white; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); padding: 8px; min-width: 200px; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000;">
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('my-progress', this)" data-tooltip="View your learning progress and mastery statistics" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; gap: 10px;">
                            <span></span> My Progress
                        </button>
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('leaderboard', this)" data-tooltip="See how you rank among other students" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; gap: 10px;">
                            <span></span> Leaderboard
                        </button>
                    </div>
                </div>
                
                <div class="nav-group" data-group="learn" style="position: relative;">
                    <button class="nav-group-btn" aria-expanded="false" aria-haspopup="true" aria-controls="learn-dropdown" style="background: none; border: none; font-size: 14px; font-weight: 600; color: var(--main-text); cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 6px;">
                        Learn
                        <span class="nav-arrow" aria-hidden="true" style="font-size: 10px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);"></span>
                    </button>
                    <div class="nav-dropdown" id="learn-dropdown" role="menu" aria-label="Learn menu" style="position: absolute; top: calc(100% + 4px); left: 0; background: white; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); padding: 8px; min-width: 180px; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000;">
                        <button class="nav-dropdown-item tooltip-container" onclick="switchTab('lessons', this)" data-tooltip="Watch video lessons and complete practice questions" style="width: 100%; padding: 12px 16px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--main-text); transition: background 0.2s; display: flex; align-items: center; gap: 10px;">
                            <span></span> Lessons
                        </button>
                    </div>
                </div>
            </nav>

            <div class="header-tabs-row">
                <div class="level-selector-container tooltip-container" id="header-level-selector" data-tooltip="Select your grade level to see questions appropriate for your class">
                    <label for="header-level-select" class="level-selector-label"> Level</label>
                    <select id="header-level-select" class="level-select" onchange="changeLevel(this.value)" aria-label="Select grade level">
                        <option value="P3">P3</option>
                        <option value="P4">P4</option>
                        <option value="P5">P5</option>
                        <option value="P6" selected>P6</option>
                    </select>
                    <span class="level-selector-badge" aria-hidden="true">Grade</span>
                </div>
                <div id="header-tabs-container" role="tablist" aria-label="Question type tabs">
                    <button class="tab-btn active" data-type="cer" onclick="switchTab('cer', this)" role="tab" aria-selected="true" aria-controls="view-cer">CER</button><button class="tab-btn" data-type="definition"
                        onclick="switchTab('definition', this)" role="tab" aria-selected="false" aria-controls="view-definition">Definition</button><button class="tab-btn" data-type="single-relationship"
                        onclick="switchTab('single-relationship', this)" role="tab" aria-selected="false" aria-controls="view-single-relationship">Single Relationship</button><button class="tab-btn" data-type="double-relationship"
                        onclick="switchTab('double-relationship', this)" role="tab" aria-selected="false" aria-controls="view-double-relationship">Double Relationship</button><button class="tab-btn" data-type="fairness" onclick="switchTab('fairness', this)" role="tab" aria-selected="false" aria-controls="view-fairness">Fairness</button><button class="tab-btn" data-type="reliability"
                        onclick="switchTab('reliability', this)" role="tab" aria-selected="false" aria-controls="view-reliability">Reliability</button><button class="tab-btn" data-type="accuracy" onclick="switchTab('accuracy', this)" role="tab" aria-selected="false" aria-controls="view-accuracy">Accuracy</button><button class="tab-btn" data-type="constant-variable"
                        onclick="switchTab('constant-variable', this)" role="tab" aria-selected="false" aria-controls="view-constant-variable">Constant Variable</button><button class="tab-btn" data-type="explanation"
                        onclick="switchTab('explanation', this)" role="tab" aria-selected="false" aria-controls="view-explanation">Explanation</button><button class="tab-btn" data-type="control-setup" onclick="switchTab('control-setup', this)" role="tab" aria-selected="false" aria-controls="view-control-setup">Control Set-up</button>
                </div>
            </div>
        </header>
        
        <!-- Colored line that changes based on active tab -->
        <div class="header-color-line" id="header-color-line" style="background: linear-gradient(90deg, #AEC6CF 0%, #c4d6dd 50%, #AEC6CF 100%);"></div>

        <!-- Save Worksheet Modal -->
        <div id="save-worksheet-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="save-worksheet-modal-title" aria-describedby="save-worksheet-modal-desc">
            <div class="modal-box">
                <h3 id="save-worksheet-modal-title"> Save Worksheet</h3>
                <p id="save-worksheet-modal-desc" class="visually-hidden" style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;">Save your current worksheet with a name and optional description</p>
                <div class="form-group">
                    <label for="worksheet-name-input">Worksheet Name *</label>
                    <input type="text" id="worksheet-name-input" placeholder="e.g., Heat Chapter Review" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="worksheet-description-input">Description (optional)</label>
                    <textarea id="worksheet-description-input" rows="2" placeholder="Brief description of this worksheet..."></textarea>
                </div>
                <div id="admin-lesson-fields" class="hidden">
                    <div class="form-group">
                        <label for="lesson-video-input"> Video Link (Dropbox)</label>
                        <input type="text" id="lesson-video-input" placeholder="https://www.dropbox.com/..." aria-describedby="lesson-video-hint">
                        <small id="lesson-video-hint" style="color: #888; font-size: 0.8rem;">Optional: Dropbox video link for this lesson</small>
                    </div>
                    <div class="form-group" style="background: #fff3e0; padding: 10px; border-radius: 8px; border-left: 4px solid #f57c00;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="share-as-lesson-checkbox" style="width: auto; margin: 0;">
                            <span> Share as Lesson (visible to all students)</span>
                        </label>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="hideSaveWorksheetModal()" type="button">Cancel</button>
                    <button class="btn-save" onclick="saveWorksheet()" type="button">Save</button>
                </div>
            </div>
        </div>

        <div class="app-body active" style="display: flex;">
            <aside class="sidebar" role="complementary" aria-label="Sidebar navigation">
                <button class="mobile-sidebar-close" onclick="closeMobileSidebar()" aria-label="Close sidebar" style="display: none; position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.2rem; cursor: pointer; z-index: 10;"></button>
                
                <!-- TOP SECTION: Streak, Practice, Toggle -->
                <div class="sidebar-top-section">
                    <!-- Profile Card with Avatar -->
                    <div class="profile-card" id="profile-card" onclick="showAvatarSelector()">
                        <div class="user-avatar" id="user-avatar"></div>
                        <div class="profile-info">
                            <div class="profile-name" id="profile-name">Student</div>
                            <div class="profile-title" id="profile-title">Science Explorer</div>
                        </div>
                        <span style="opacity: 0.7; font-size: 0.9rem;"></span>
                    </div>

                    <div id="login-days-display"> Loading Streak...</div>

                    <!-- XP Progress Bar -->
                    <div class="xp-progress-container" id="xp-progress-container">
                        <div class="xp-header">
                            <div class="xp-level">
                                <span class="xp-level-badge" id="xp-level-badge">Lv 1</span>
                                <span class="xp-level-title" id="xp-level-title">Beginner</span>
                            </div>
                            <span class="xp-points" id="xp-points-display">0 / 100 XP</span>
                        </div>
                        <div class="xp-bar-outer">
                            <div class="xp-bar-inner" id="xp-bar-inner" style="width: 0%;"></div>
                        </div>
                    </div>

                    <!-- Daily Challenge Card -->
                    <div class="daily-challenge-card" id="daily-challenge-card" onclick="showDailyChallengeDetails()">
                        <div class="daily-challenge-header">
                            <div class="daily-challenge-title">
                                <span></span> Daily Challenge
                            </div>
                            <span class="daily-challenge-timer" id="daily-challenge-timer">23:59:59</span>
                        </div>
                        <div class="daily-challenge-task" id="daily-challenge-task">
                            Answer 5 questions correctly
                        </div>
                        <div class="daily-challenge-progress">
                            <div class="daily-challenge-progress-bar" id="daily-challenge-progress-bar" style="width: 0%;"></div>
                        </div>
                        <div class="daily-challenge-reward">
                            <span></span> Reward: <span id="daily-challenge-reward-xp">+50 XP</span>
                        </div>
                    </div>

                    <!-- Achievements Button -->
                    <button class="achievements-btn" onclick="showAchievementsModal()">
                        <span></span> Achievements <span id="achievements-unlocked-count">(0/12)</span>
                    </button>

                    <!-- Active Quest Card -->
                    <div class="quest-card" id="active-quest-card" onclick="showQuestDetails()">
                        <div class="quest-header">
                            <div class="quest-title">
                                <span></span> <span id="quest-name">Science Explorer</span>
                            </div>
                            <span class="quest-chapter" id="quest-chapter">Ch. 1</span>
                        </div>
                        <div class="quest-description" id="quest-description">
                            Begin your journey to become a science master!
                        </div>
                        <div class="quest-objectives" id="quest-objectives">
                            <div class="quest-objective" id="quest-obj-1">
                                <div class="quest-objective-check"></div>
                                <span>Answer 5 questions correctly</span>
                            </div>
                            <div class="quest-objective" id="quest-obj-2">
                                <div class="quest-objective-check"></div>
                                <span>Try 2 different topics</span>
                            </div>
                        </div>
                    </div>

                    <!-- Streak Bonus Card (shown when streak >= 3) -->
                    <div class="streak-bonus-card" id="streak-bonus-card" style="display: none;">
                        <div class="streak-bonus-flame"></div>
                        <div class="streak-bonus-count" id="streak-bonus-count">0</div>
                        <div class="streak-bonus-label">Day Streak!</div>
                        <div class="streak-bonus-multiplier" id="streak-bonus-multiplier">+10% XP Bonus</div>
                    </div>

                    <!-- Smart Recommendation Card -->
                    <div class="recommendation-card" id="smart-recommendation-card">
                        <div class="recommendation-header">
                            <span></span> <span id="recommendation-title">Recommended for You</span>
                        </div>
                        <div class="recommendation-content" id="recommendation-content">
                            Loading personalized suggestion...
                        </div>
                        <button class="recommendation-btn" id="recommendation-btn" onclick="followRecommendation()">
                            Start Now
                        </button>
                    </div>

                    <!-- Motivational Tip Card -->
                    <div id="motivational-tip-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 16px; padding: 12px 16px; margin-bottom: 1rem; color: #333;">
                        <div style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 6px;">
                            <span id="tip-emoji"></span> <span id="tip-title">Daily Tip</span>
                        </div>
                        <div id="tip-content" style="font-size: 0.85rem; line-height: 1.4;">
                            Practice makes progress! Every question you answer brings you closer to mastery.
                        </div>
                    </div>

                    <!-- Topic Mastery Section -->
                    <div class="topic-mastery-section" id="topic-mastery-section">
                        <div class="topic-mastery-header">
                            <span> Topic Mastery</span>
                            <span style="font-size: 0.75rem; color: var(--light-text);">Top 5</span>
                        </div>
                        <div id="topic-mastery-list">
                            <!-- Topic mastery items populated by JS -->
                            <div class="content-loading-indicator">
                                <div class="loading-spinner-small"></div>
                                <span>Loading progress...</span>
                            </div>
                        </div>
                        <button class="focus-practice-btn" id="focus-practice-btn" onclick="startFocusPractice()" style="display: none;">
                             Focus on Weak Topics
                        </button>
                    </div>

                    <!-- Animated Practice Mode Button -->
                    <button id="btn-sidebar-practice" class="practice-btn-animated tooltip-container" onclick="switchTab('practice', this)" data-tooltip="Enter practice mode to work through questions at your own pace">
                        <span class="practice-btn-icon"></span>
                        <span class="practice-btn-text">Practice Mode</span>
                        <span class="practice-btn-sparkle"></span>
                    </button>
                    
                    <!-- iOS-style OEQ/MCQ Toggle -->
                    <div class="ios-toggle-container" role="group" aria-label="Question type toggle">
                        <span class="ios-toggle-label" id="oeq-label">OEQ</span>
                        <div class="ios-toggle tooltip-container mcq-active" id="mode-toggle" onclick="toggleMode()" data-tooltip="Switch between OEQ (Open-Ended Questions) and MCQ (Multiple Choice Questions) modes" role="switch" aria-checked="true" tabindex="0">
                            <div class="ios-toggle-track" aria-hidden="true">
                                <div class="ios-toggle-thumb" id="toggle-thumb"></div>
                            </div>
                        </div>
                        <span class="ios-toggle-label active" id="mcq-label">MCQ</span>
                    </div>
                    
                    <!-- Exam Mode Toggle (Monochrome) -->
                    <div class="exam-mode-toggle-container" role="group" aria-label="Display mode toggle" title="Exam Mode: Shows questions in black & white like actual exams">
                        <span class="exam-mode-label" id="colour-label"> Colour</span>
                        <div class="exam-mode-toggle" id="exam-mode-toggle" onclick="toggleExamMode()" role="switch" aria-checked="false" tabindex="0">
                            <div class="exam-mode-track" aria-hidden="true">
                                <div class="exam-mode-thumb"></div>
                            </div>
                        </div>
                        <span class="exam-mode-label" id="exam-label"> Exam</span>
                    </div>
                </div>
                
                <!-- DIVIDER -->
                <div class="sidebar-divider"></div>
                
                <!-- BOTTOM SECTION: Navigation Buttons -->
                <div class="sidebar-nav-section">
                    <button id="btn-sidebar-admin" class="hidden sidebar-nav-btn admin-btn tooltip-container" onclick="switchTab('admin', this)" data-tooltip="Access admin panel to manage questions and view student data (Admin only)">
                         Admin Mode
                    </button>

                    <button id="btn-sidebar-review" class="hidden sidebar-nav-btn review-btn tooltip-container" onclick="switchTab('review-questions', this)" data-tooltip="Review questions submitted by interns before making them available (Admin only)" style="background: linear-gradient(135deg, #ff9800, #f57c00); color: white;">
                         Review Questions <span id="pending-review-count" class="worksheet-badge" style="background: #f44336;">0</span>
                    </button>

                    <button id="btn-sidebar-progress" class="hidden sidebar-nav-btn progress-btn tooltip-container" onclick="switchTab('student-progress', this)" data-tooltip="View detailed progress for all students (Admin only)">
                         Student Progress
                    </button>

                    <button id="btn-sidebar-leaderboard" class="sidebar-nav-btn tooltip-container" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: white;" onclick="switchTab('leaderboard', this)" data-tooltip="See rankings and compare your performance with other students">
                         Leaderboard
                    </button>

                    <button id="btn-sidebar-my-progress" class="sidebar-nav-btn tooltip-container" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;" onclick="switchTab('my-progress', this)" data-tooltip="Track your learning progress, mastery percentages, and improvement over time">
                         My Progress
                    </button>

                    <button id="btn-sidebar-worksheet" class="sidebar-nav-btn worksheet-btn tooltip-container" onclick="switchTab('worksheet', this)" data-tooltip="View and manage your collection of practice questions">
                         My Worksheet <span id="worksheet-count" class="worksheet-badge">0</span>
                    </button>

                    <button id="btn-sidebar-saved-worksheets" class="sidebar-nav-btn saved-btn tooltip-container" onclick="switchTab('saved-worksheets', this)" data-tooltip="Access previously saved worksheets for review">
                         Saved Worksheets
                    </button>

                    <button id="btn-sidebar-lessons" class="sidebar-nav-btn lessons-btn tooltip-container" onclick="switchTab('lessons', this)" data-tooltip="Browse video lessons with practice questions">
                         Lessons
                    </button>

                    <button id="btn-sidebar-question-list" class="sidebar-nav-btn tooltip-container" style="background: linear-gradient(135deg, #9c27b0, #673ab7); color: white;" onclick="switchTab('question-list', this)" data-tooltip="Browse and search all available questions in the library">
                         Question Library
                    </button>
                    
                    <!-- Tutorial button moved to header -->
                    
                    <button onclick="handleLogout()" class="logout-btn tooltip-container" data-tooltip="Sign out of your account"> Logout</button>
                </div>

                <div id="oeq-sidebar-content">
                    <h2 id="oeq-title">OEQ Questions</h2>
                    <nav id="oeq-topic-nav" class="sidebar-nav">
                        <!-- Dynamic topic buttons will be populated here -->
                    </nav>
                </div>

                <div id="mcq-sidebar-content" class="hidden">
                    <h2 style="margin-bottom: 0.5rem;">MCQ Level</h2>
                    <select id="mcq-level-select" onchange="window.currentMcqLevel = this.value; renderMcqHeaders();"
                        class="auth-input"
                        style="height: 40px; margin-bottom: 1rem; border-radius: 8px; padding: 5px 10px; font-size: 0.9rem;">
                        <option value="P3">Primary 3</option>
                        <option value="P4">Primary 4</option>
                        <option value="P5">Primary 5</option>
                        <option value="P6">Primary 6</option>
                    </select>
                    <h2 id="mcq-topic-label" style="font-size: 1rem; color: #666; margin-bottom: 1rem;">Questions</h2>
                    <nav id="mcq-question-nav" class="sidebar-nav">
                        <!-- Dynamic Question Buttons (Q1, Q2...) -->
                    </nav>
                </div>
            </aside>

            <main id="main-content-area" role="main" aria-label="Main content" style="flex: 1; overflow-y: auto;">

                <!-- View: CER (Existing - Part of OEQ) -->
                <div id="view-cer" class="view-content active">
                    <!-- TOPIC: HEAT -->
                    <div id="topic-heat" class="topic-content hidden">
                        <!-- Question 1: Heat -->
                        <div id="heat-question-1" class="question-container">
                            <h3>Question 1</h3>
                            <p>Peter conducted an experiment to find out how the materials of bowls affect the time
                                taken for the water in them to cool down. He measured the temperature of the water in
                                the three bowls every two minutes and recorded it in the table.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2" style="vertical-align: middle;">Time (min)</th>
                                        <th colspan="3">Temperature of Water (C)</th>
                                    </tr>
                                    <tr>
                                        <th>Bowl A</th>
                                        <th>Bowl B</th>
                                        <th>Bowl C</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>0</td>
                                        <td>80</td>
                                        <td>80</td>
                                        <td>80</td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>79</td>
                                        <td>74</td>
                                        <td>78</td>
                                    </tr>
                                    <tr>
                                        <td>4</td>
                                        <td>78</td>
                                        <td>68</td>
                                        <td>74</td>
                                    </tr>
                                    <tr>
                                        <td>6</td>
                                        <td>78</td>
                                        <td>61</td>
                                        <td>72</td>
                                    </tr>
                                    <tr>
                                        <td>8</td>
                                        <td>76</td>
                                        <td>55</td>
                                        <td>69</td>
                                    </tr>
                                    <tr>
                                        <td>10</td>
                                        <td>74</td>
                                        <td>49</td>
                                        <td>66</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Which bowl is the most suitable for storing frozen ice-cream?
                                Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="heat-form-1">
                                    <div class="cer-segment" data-label="claim">Bowl<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="A"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The temperature of water in bowl A
                                        decreased by the<div class="answer-blank"><input type="text"
                                                class="answer-input" data-answer="least"></div> amount,<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that bowl A is the poorest
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                style="width: 120px;" data-answer="conductor"></div>of<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="heat"></div>, allowing the ice-cream to<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="gain"></div>heat from the warmer surrounding air slowest to
                                        melt the slowest.<span class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                    <button class="next-btn btn hidden">Next Question</button>
                                </div>
                            </div>
                        </div>

                        <!-- Question 2: Heat -->
                        <div id="heat-question-2" class="question-container">
                            <h3>Question 2</h3>
                            <p>Warren conducted an experiment on three solid blocks made of materials, A, B and C, of
                                the same size and thickness. He heated the three materials and measured the time taken
                                for each to increase from 30C to 50C. The table below shows his results.</p>
                            <img src="https://www.dropbox.com/scl/fi/tsjlvlar0etwnhd3wyple/Screenshot-2025-10-18-at-8.42.36-AM.png?rlkey=l15xphdym7bmg352669a8ykt1&raw=1"
                                alt="Cooler Box Experiment Diagram" class="question-diagram">
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Materials</th>
                                        <th>Time taken for the experiment (second)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>A</td>
                                        <td>50</td>
                                    </tr>
                                    <tr>
                                        <td>B</td>
                                        <td>80</td>
                                    </tr>
                                    <tr>
                                        <td>C</td>
                                        <td>35</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Which material A, B or C, should Warren choose to keep the ice
                                cold for the longest time? Explain why.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="heat-form-2">
                                    <div class="cer-segment" data-label="claim">Material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="B"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The time taken for the temperature of
                                        the block made of material B to increase from 30C to 50C is the<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="longest"></div>,<span class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that material B is the
                                        poorest<div class="answer-blank"><input type="text" class="answer-input"
                                                style="width: 120px;" data-answer="conductor"></div>of<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="heat"></div>, allowing the ice in the ice box to<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="gain"></div>heat from the warmer surrounding air<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="slowest"></div>to melt<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="slowest"></div>.<span
                                            class="feedback-icon"></span></div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                    <button class="next-btn btn hidden">Next Question</button>
                                </div>
                            </div>
                        </div>

                        <!-- Question 3: Heat (Jarrell/Double-Glazed) -->
                        <div id="heat-question-3" class="question-container">
                            <h3>Question 3</h3>
                            <p>Jarrell wanted to investigate which glass, A or B, keeps water cold for a longer time.
                                Both glasses were made of the same material.</p>
                            <p>He measured the temperature of water in each glass at the start of the experiment and
                                every 10 minutes for 50 minutes. He plotted the results in the graph.</p>
                            <div style="display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-start;">
                                <img src="https://www.dropbox.com/scl/fi/6k92e3bl2ypvtoj2z3vgh/Screenshot-2026-01-01-at-1.23.56-AM.png?rlkey=sod3j1qoo1luvqt9of4vsfbak&raw=1"
                                    alt="Glasses Diagram (A: Double vs B: Single)" class="question-diagram"
                                    style="max-width: 45%; border: 1px dashed #ccc; min-height: 150px; background: #f9f9f9;">
                                <img src="https://www.dropbox.com/scl/fi/qlxcbhuj6m9awgtd3xb2z/Screenshot-2026-01-01-at-1.27.47-AM.png?rlkey=cd4cwykuja7k335j2qwymavmn&raw=1"
                                    alt="Graph Diagram (Line X vs Line Y)" class="question-diagram"
                                    style="max-width: 45%; border: 1px dashed #ccc; min-height: 150px; background: #f9f9f9;">
                            </div>
                            <p>The table shows the daily average temperature for Singapore during the day.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Average temperature (C) in the day</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Inside the house</td>
                                        <td>28C</td>
                                    </tr>
                                    <tr>
                                        <td>Outside the house</td>
                                        <td>32C</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Are double-layered or single-layered glass windows more suitable
                                for houses in Singapore, so that it is cooler inside the house? Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="heat-form-3">
                                    <div class="cer-segment" data-label="claim">
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                style="width: 150px;" data-answer="Double-layered"></div>glass windows
                                        are more suitable.<span class="feedback-icon"></span>
                                    </div>
                                    <div class="cer-segment" data-label="evidence">The temperature of water increases
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="slower"></div> for glass <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="A"></div> when compared to
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="B"></div> over 50 minutes.<span
                                            class="feedback-icon"></span>
                                    </div>
                                    <div class="cer-segment" data-label="reasoning">The layer of <div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="air"></div> trapped between the glass layer is a <div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="poor"></div> conductor of <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="heat"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="link">This <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="reduces"></div> the heat
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="gained"></div> from the <div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="warmer"></div> surrounding
                                        air outside the house into the inside of the house, thus, keeping the inside of
                                        the house <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="cooler"></div>.<span class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TOPIC: LIGHT -->
                    <div id="topic-light" class="topic-content hidden">
                        <div id="light-question-1" class="question-container">
                            <h3>Question 1</h3>
                            <p>Jeremy conducted an experiment in a dark room to investigate the properties of materials
                                P, Q, R and S. He placed different materials at positions 1 and 2 respectively each
                                time.</p>
                            <img src="https://www.dropbox.com/scl/fi/m72szjzburi7sqf8u9vcj/Screenshot-2025-10-18-at-8.06.48-AM.png?rlkey=h2pcg2ig894ot07xjx7bld0fn&raw=1"
                                alt="Light Experiment Diagram" class="question-diagram">
                            <p>The amount of light detected by the light sensor was recorded as shown in the table.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Material at position 1</th>
                                        <th>Material at position 2</th>
                                        <th>Amount of light detected (lux)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>P</td>
                                        <td>Q</td>
                                        <td>2000</td>
                                    </tr>
                                    <tr>
                                        <td>Q</td>
                                        <td>R</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>R</td>
                                        <td>S</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>S</td>
                                        <td>P</td>
                                        <td>300</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Which material would be most suitable to make a bedroom curtain
                                that keeps the room totally dark? Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="light-form-1">
                                    <div class="cer-segment" data-label="claim">Material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="R"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The amount of light detected is<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="0"></div>lux when material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="R"></div>is placed in
                                        either position 1 or position 2,<span class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that material R is the only
                                        <div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="opaque"></div>material, allowing the curtain to block<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="all"></div>light and keep the room totally dark.<span
                                            class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TOPIC: MATERIALS -->
                    <div id="topic-materials" class="topic-content hidden">
                        <div id="materials-question-1" class="question-container">
                            <h3>Question 1</h3>
                            <p>Tony set up an experiment to compare the property of four strips, A, B, C and D, made of
                                different materials but of the same thickness.</p>
                            <img src="https://www.dropbox.com/scl/fi/jsxkxtz7ryrm3s4i04x49/Screenshot-2025-10-18-at-2.29.33-AM.png?rlkey=cib9nnrvpxta2imuncs4j9ugw&raw=1"
                                alt="Flexibility Experiment Diagram" class="question-diagram">
                            <p>He recorded the distance, x, in the table below.</p>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Distance x (cm)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>A</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>B</td>
                                        <td>9</td>
                                    </tr>
                                    <tr>
                                        <td>C</td>
                                        <td>30</td>
                                    </tr>
                                    <tr>
                                        <td>D</td>
                                        <td>10</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="question-title">Based on the results, which strip is most suitable for making a
                                belt? Explain your answer.</p>
                            <div class="answer-box">
                                <div class="answer-template" id="materials-form-1">
                                    <div class="cer-segment" data-label="claim">Material<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="C"></div>.<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="evidence">The<div class="answer-blank"><input
                                                type="text" class="answer-input" data-answer="distance"></div>X for
                                        material<div class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="C"></div>is the<div class="answer-blank"><input type="text"
                                                class="answer-input" data-answer="greatest"></div>,<span
                                            class="feedback-icon"></span></div>
                                    <div class="cer-segment" data-label="reasoning">showing that material<div
                                            class="answer-blank"><input type="text" class="answer-input"
                                                data-answer="C"></div>is the most<div class="answer-blank"><input
                                                type="text" class="answer-input" style="width: 120px;"
                                                data-answer="flexible"></div>material, allowing a belt made of it to
                                        wrap around a person's waist most easily.<span class="feedback-icon"></span>
                                    </div>
                                </div>
                                <div class="controls">
                                    <button class="submit-btn btn">Submit</button>
                                    <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TOPIC: MCQ CONTENT (Dynamic) -->
                <div id="topic-mcq-living-and-non-living-things" class="topic-content hidden"></div>
                <div id="topic-mcq-materials" class="topic-content hidden"></div>
                <div id="topic-mcq-life-cycles" class="topic-content hidden"></div>
                <div id="topic-mcq-magnets" class="topic-content hidden"></div>
                <div id="topic-mcq-plant-systems" class="topic-content hidden"></div>
                <div id="topic-mcq-human-body-systems" class="topic-content hidden"></div>
                <div id="topic-mcq-matter-and-its-3-states" class="topic-content hidden"></div>
                <div id="topic-mcq-light" class="topic-content hidden"></div>
                <div id="topic-mcq-heat" class="topic-content hidden"></div>
                <div id="topic-mcq-water-and-its-3-states" class="topic-content hidden"></div>
                <div id="topic-mcq-plant-reproduction" class="topic-content hidden"></div>
                <div id="topic-mcq-human-reproduction" class="topic-content hidden"></div>
                <div id="topic-mcq-human-and-plant-respiration" class="topic-content hidden"></div>
                <div id="topic-mcq-human-and-plant-transport" class="topic-content hidden"></div>
                <div id="topic-mcq-electrical-systems" class="topic-content hidden"></div>
                <div id="topic-mcq-forces" class="topic-content hidden"></div>
                <div id="topic-mcq-energy-in-food" class="topic-content hidden"></div>
                <div id="topic-mcq-energy-conversion" class="topic-content hidden"></div>
                <div id="topic-mcq-living-together" class="topic-content hidden"></div>
                <div id="topic-mcq-food-chains-and-webs" class="topic-content hidden"></div>
                <div id="topic-mcq-humans-and-the-environment" class="topic-content hidden"></div>

                <!-- View: Single Relationship -->
                <div id="view-single-relationship" class="view-content hidden">
                    <!-- TOPIC: FORCES -->
                    <div id="topic-sr-forces" class="topic-content">
                        <div id="sr-forces-question-1" class="question-container">
                                <h3>Question 1</h3>
                                <p>Meiling conducted an experiment by placing a 1 kg block on a flat surface and
                                    measured the amount of force needed to pull it along the surface using a spring
                                    balance.</p>
                                <img src="https://www.dropbox.com/scl/fi/xvhgx31uk82s32edfv6a6/spring-block.jpg?rlkey=8aejaocw35svctiogmy9mbbwt&raw=1"
                                    alt="Spring Block Diagram" class="question-diagram">
                                <p>She repeated the experiment using three similar blocks that are of different masses
                                    and recorded the results in the graph.</p>
                                <img src="https://www.dropbox.com/scl/fi/j1kumnl75vervdk5he9p7/graph-app.jpg?rlkey=4gqp7teop1dy2wa38yr20iu2n&raw=1"
                                    alt="Force Graph Diagram" class="question-diagram">
                                <p class="question-title">State what Meiling could conclude based on the results of her
                                    experiment.</p>
                                <div class="answer-box">
                                    <div class="answer-template" id="sr-forces-form-1">
                                        <div class="cer-segment" style="border:none; padding:0; margin-bottom:0;"
                                            data-label="">
                                            As the
                                            <div class="answer-group">
                                                <div class="answer-blank"><input type="text" class="answer-input"
                                                        style="width: 200px;" data-answer="mass of the block|mass">
                                                </div>
                                                <span class="variable-label"
                                                    data-tooltip="The variable that is changed or controlled in a scientific experiment to test the effects on the dependent variable.">independent
                                                    variable</span>
                                            </div>
                                            increases, the
                                            <div class="answer-group">
                                                <div class="answer-blank"><input type="text" class="answer-input"
                                                        style="width: 350px;"
                                                        data-answer="amount of force needed to pull it along the surface|amount of force|force">
                                                </div>
                                                <span class="variable-label"
                                                    data-tooltip="The variable being tested and measured in a scientific experiment.">dependent
                                                    variable</span>
                                            </div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="increases"></div>.
                                            <span class="feedback-icon" style="margin-left: 10px;"></span>
                                        </div>
                                    </div>
                                    <div class="controls">
                                        <button class="submit-btn btn">Submit</button>
                                        <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>

                <div id="view-double-relationship" class="view-content hidden">
                    <div class="placeholder-content">
                        <h2>Double Relationship Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-definition" class="view-content hidden">
                    <div id="topic-def-evap" class="topic-content">
                        <div id="def-evap-question-1" class="question-container">
                                <h3>Question 1</h3>
                                <p class="question-title">Define evaporation.</p>
                                <div class="answer-box">
                                    <div class="answer-template" id="def-form-1"
                                        style="font-size: 1.2rem; line-height: 2;">
                                        <div class="cer-segment" data-label="definition">
                                            Evaporation is a process where a <div class="answer-blank"><input
                                                    type="text" class="answer-input" data-answer="liquid"></div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="gains"></div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="heat"></div> from a heat source to become <div
                                                class="answer-blank"><input type="text" class="answer-input"
                                                    data-answer="gas"></div> at <div class="answer-blank"><input
                                                    type="text" class="answer-input" data-answer="any"></div>
                                            <div class="answer-blank"><input type="text" class="answer-input"
                                                    style="width: 150px;" data-answer="temperature"></div>.
                                            <span class="feedback-icon"></span>
                                        </div>
                                    </div>
                                    <div class="controls">
                                        <button class="submit-btn btn">Submit</button>
                                        <button class="print-btn" onclick="printQuestion(this)"> Print</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>

                <div id="view-fairness" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Fairness Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-reliability" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Reliability Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-accuracy" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Accuracy Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-constant-variable" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Constant Variable Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-explanation" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Explanation Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-control-setup" class="view-content hidden" style="flex: 1;">
                    <div class="placeholder-content">
                        <h2>Control Set-up Questions</h2>
                        <p>Coming Soon</p>
                    </div>
                </div>

                <div id="view-admin" class="view-content hidden" style="flex: 1;">
                    <main style="max-width: 900px; margin: 0 auto; padding-top: 2rem;">
                        <h2 style="margin-bottom: 1rem; color: var(--main-text);">Question Creator (Admin)</h2>
                        
                        <!-- Push Update Section -->
                        <div id="push-update-section" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #667eea30;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <strong style="color: #667eea;"> Push App Update</strong>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 2px;">Current version: <code id="current-version-display" style="background: #e9ecef; padding: 2px 6px; border-radius: 4px;"></code></div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="pushUpdateNotification(false)" class="btn" style="background: #667eea; color: white; font-size: 0.85rem; padding: 8px 16px;">
                                         Notify Users
                                    </button>
                                    <button onclick="pushUpdateNotification(true)" class="btn" style="background: #dc3545; color: white; font-size: 0.85rem; padding: 8px 16px;">
                                         Force Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Question Ratings Dashboard (Admin Only) -->
                        <div id="ratings-dashboard-section" style="background: linear-gradient(135deg, #f3e5f515 0%, #e1bee715 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #ce93d830;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 1rem;">
                                <div>
                                    <strong style="color: #7b1fa2;"> Question Ratings Dashboard</strong>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 2px;">View and manage question difficulty ratings (Elo-based)</div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="loadRatingsDashboard()" class="btn" style="background: #7b1fa2; color: white; font-size: 0.85rem; padding: 8px 16px;">
                                         Refresh Ratings
                                    </button>
                                    <button onclick="toggleRatingsDashboard()" class="btn" style="background: #9c27b0; color: white; font-size: 0.85rem; padding: 8px 16px;" id="btn-toggle-ratings">
                                         Show Dashboard
                                    </button>
                                </div>
                            </div>
                            <div id="ratings-dashboard-content" class="hidden">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 1rem;">
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #7b1fa2;" id="stat-total-questions">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Total Questions</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #4CAF50;" id="stat-rated-questions">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Rated Questions</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #ff9800;" id="stat-avg-rating">1200</div>
                                        <div style="font-size: 0.8rem; color: #888;">Avg Rating</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #2196F3;" id="stat-total-attempts">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Total Attempts</div>
                                    </div>
                                </div>
                                <div style="max-height: 400px; overflow-y: auto; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                        <thead style="position: sticky; top: 0; background: #f5f5f5;">
                                            <tr>
                                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e0e0e0;">Question</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Level</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Topic</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Rating</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Attempts</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Correct %</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Confidence</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ratings-table-body">
                                            <tr><td colspan="7" style="padding: 20px; text-align: center; color: #888;">Click "Refresh Ratings" to load data</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Activity Dashboard (Admin Only) -->
                        <div id="activity-dashboard-section" style="background: linear-gradient(135deg, #e3f2fd15 0%, #bbdefb15 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #2196f330;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 1rem;">
                                <div>
                                    <strong style="color: #1976d2;"> User Activity Dashboard</strong>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 2px;">Track user logins and account activities</div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="loadActivityDashboard()" class="btn" style="background: #1976d2; color: white; font-size: 0.85rem; padding: 8px 16px;">
                                         Refresh
                                    </button>
                                    <button onclick="toggleActivityDashboard()" class="btn" style="background: #2196f3; color: white; font-size: 0.85rem; padding: 8px 16px;" id="btn-toggle-activity">
                                         Show Dashboard
                                    </button>
                                </div>
                            </div>
                            <div id="activity-dashboard-content" class="hidden">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 1rem;">
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #1976d2;" id="stat-total-users">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Total Users</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #4CAF50;" id="stat-active-today">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Active Today</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #ff9800;" id="stat-active-week">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Active This Week</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #9c27b0;" id="stat-total-practice-sessions">0</div>
                                        <div style="font-size: 0.8rem; color: #888;">Total Questions Done</div>
                                    </div>
                                </div>
                                <div style="max-height: 350px; overflow-y: auto; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                        <thead style="position: sticky; top: 0; background: #f5f5f5;">
                                            <tr>
                                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e0e0e0;">User</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Students</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Last Active</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Questions Done</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Correct %</th>
                                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">Avg Rating</th>
                                            </tr>
                                        </thead>
                                        <tbody id="activity-table-body">
                                            <tr><td colspan="6" style="padding: 20px; text-align: center; color: #888;">Click "Refresh" to load data</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div id="editing-indicator" class="hidden" style="background: #fff3cd; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; color: #856404; display: flex; justify-content: space-between; align-items: center;">
                            <span> <strong>Editing:</strong> <span id="editing-question-name"></span></span>
                            <button onclick="cancelEditing()" style="background: #856404; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Cancel Edit</button>
                        </div>
                        <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.9rem; color: #2e7d32;">
                            <strong> How to create a question:</strong>
                            <ol style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
                                <li>Fill in the <strong>Title</strong> and select <strong>Category/Topic</strong></li>
                                <li>Add <strong>Text blocks</strong> for question content and <strong>Answer blocks</strong> for fill-in-the-blank sections</li>
                                <li>Click <strong>"Preview & Select Blanks"</strong> to see your question and click words to turn them into blanks</li>
                                <li>Click <strong>"Save Question"</strong> when done</li>
                            </ol>
                            <p style="margin-top: 0.5rem; font-size: 0.85rem;"><em> Tip: In Answer blocks, wrap words in [brackets] to automatically make them blanks (e.g., "The answer is [correct]")</em></p>
                        </div>
                        <div id="admin-editor" class="answer-box"
                            style="background: #fff; border: 1px solid var(--border-color);">
                            <div id="admin-basic-meta"
                                style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-top-left-radius: 8px; border-top-right-radius: 8px;">
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="flex: 1;">
                                        <label for="admin-category"
                                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Category:</label>
                                        <select id="admin-category" class="auth-input"
                                            style="width: 100%; height: 50px; cursor: pointer;"
                                            onchange="handleCategoryChange(this.value)">
                                            <option value="cer">CER (Open Ended)</option>
                                            <option value="definition">Definition</option>
                                            <option value="single-relationship">Single Relationship</option>
                                            <option value="double-relationship">Double Relationship</option>
                                            <option value="mcq">Multiple Choice (MCQ)</option>
                                            <option value="fairness">Fairness</option>
                                            <option value="reliability">Reliability</option>
                                            <option value="accuracy">Accuracy</option>
                                            <option value="constant-variable">Constant Variable</option>
                                            <option value="explanation">Explanation</option>
                                            <option value="control-setup">Control Set-up</option>
                                        </select>
                                    </div>
                                    <div id="admin-level-container" class="hidden" style="flex: 1;">
                                        <label for="admin-level"
                                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Level:</label>
                                        <select id="admin-level" class="auth-input"
                                            style="width: 100%; height: 50px; cursor: pointer;"
                                            onchange="updateAdminTopicsByLevel(this.value)">
                                            <option value="P3">Primary 3</option>
                                            <option value="P4">Primary 4</option>
                                            <option value="P5">Primary 5</option>
                                            <option value="P6">Primary 6</option>
                                        </select>
                                    </div>
                                </div>
                                <label for="admin-title"
                                    style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Question
                                    Title:</label>
                                <input type="text" id="admin-title" class="auth-input"
                                    style="width: 100%; height: 50px; margin-bottom: 1rem;"
                                    placeholder="e.g., Bird Life Cycle">
                                <label for="admin-topic"
                                    style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #555;">Topic:</label>
                                <select id="admin-topic" class="auth-input"
                                    style="width: 100%; height: 50px; cursor: pointer; margin-bottom: 0.5rem;"
                                    onchange="handleTopicChange(this.value)">
                                    <option value="heat">Heat</option>
                                    <option value="light">Light</option>
                                    <option value="materials">Materials</option>
                                    <option value="air">Air</option>
                                    <option value="water">Water</option>
                                    <option value="new-topic">-- Add Custom Topic --</option>
                                </select>
                                <input type="text" id="admin-new-topic" class="auth-input hidden"
                                    style="width: 100%; height: 50px;" placeholder="Enter new topic name...">
                                <!-- MCQ Options (Hidden by default) -->
                                <div id="mcq-options-container" class="hidden"
                                    style="margin-top: 1rem; padding: 1rem; background: #eee; border-radius: 8px;">
                                    <p style="font-weight: 600; margin-bottom: 0.5rem;">Enter Options:</p>
                                    <input type="text" id="mcq-opt-1" class="auth-input" placeholder="Option 1"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <input type="text" id="mcq-opt-2" class="auth-input" placeholder="Option 2"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <input type="text" id="mcq-opt-3" class="auth-input" placeholder="Option 3"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <input type="text" id="mcq-opt-4" class="auth-input" placeholder="Option 4"
                                        style="height: 40px; margin-bottom: 8px;">
                                    <p style="font-weight: 600; margin-top: 0.5rem;">Correct Answer:</p>
                                    <select id="mcq-correct" class="auth-input" style="height: 40px;">
                                        <option value="1">Option 1</option>
                                        <option value="2">Option 2</option>
                                        <option value="3">Option 3</option>
                                        <option value="4">Option 4</option>
                                    </select>
                                </div>
                            </div>
                            <div id="admin-blocks"></div>
                            <div
                                style="display: flex; gap: 0.8rem; margin-top: 2rem; border-top: 2px dashed #eee; padding-top: 1.5rem; flex-wrap: wrap; justify-content: center;">
                                <button class="btn" onclick="addAdminBlock('text')"
                                    style="background: #e7f5ff; color: #007bff; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+ Add Text</button>
                                <button class="btn" onclick="addAdminBlock('answer')"
                                    style="background: #fff9c4; color: #f9a825; border: 1px solid #fbc02d; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+
                                    Add Answer</button>
                                <button class="btn" onclick="addAdminBlock('explanation')"
                                    style="background: #f0f4ff; color: #007bff; border: 1px solid #007bff; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+
                                    Add Explanation</button>
                                <button class="btn" onclick="addAdminBlock('video')"
                                    style="background: #fff5f5; color: #dc3545; border: 1px solid #dc3545; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+
                                    Add Video URL</button>
                                <button class="btn" onclick="addAdminBlock('image')"
                                    style="background: #fdfdfd; border: 1px solid #ddd; color: #555; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+ Add
                                    Image URL</button>
                                <button class="btn" onclick="event.stopPropagation(); showTableGridSelector(this)" id="add-table-btn"
                                    style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 1px solid #81c784; color: #2e7d32; padding: 10px 16px; border-radius: 20px; font-size: 0.85rem;">+ Add
                                    Table</button>
                            </div>
                            <div id="admin-actions" class="controls"
                                style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #eee;">
                                <button id="admin-clear-btn" class="btn" onclick="clearAdminForm(false, true)"
                                    style="background: #dc3545; color: white;"> Clear Form</button>
                                <button id="admin-process-btn" class="btn" onclick="processAdminQuestion()"
                                    style="background: #28a745; color: white;"> Preview & Select Blanks</button>
                                <button id="save-question-btn" class="btn" onclick="saveAdminQuestion('approved')"
                                    style="background: var(--primary-blue); color: white;"> Save Question</button>
                                <button id="submit-review-btn" class="btn" onclick="saveAdminQuestion('pending')"
                                    style="background: #ff9800; color: white;" title="Submit question for admin review before making it available to students"> Submit for Review</button>
                            </div>
                        </div>
                        <div id="admin-preview-section" class="hidden" style="margin-top: 4rem;">
                            <h3 style="margin-bottom: 1.5rem;">Interactive Preview</h3>
                            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">Click the words you want
                                to turn into blanks. Yellow words will become questions.</p>
                            <div id="admin-preview-content" class="answer-template"
                                style="background: var(--blue-light); padding: 2rem; border-radius: 12px;"></div>
                        </div>
                    </main>
                </div>

                <!-- REVIEW QUESTIONS VIEW (Admin Only) -->
                <div id="view-review-questions" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 1000px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <h2 style="margin: 0;"> Review Pending Questions</h2>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" style="background: #1976d2; color: white;" onclick="loadPendingQuestions()"> Refresh</button>
                            </div>
                        </div>

                        <p style="color: #666; margin-bottom: 1.5rem;">Questions submitted by interns for review. Approve to make them available to students, or reject to remove them.</p>

                        <!-- Filter Controls -->
                        <div style="background: #f5f5f5; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <div>
                                <label style="font-weight: 600; margin-right: 8px;">Category:</label>
                                <select id="review-category-filter" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.9rem;" onchange="filterPendingQuestions()">
                                    <option value="all">All Categories</option>
                                    <option value="cer">CER</option>
                                    <option value="mcq">MCQ</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight: 600; margin-right: 8px;">Level:</label>
                                <select id="review-level-filter" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.9rem;" onchange="filterPendingQuestions()">
                                    <option value="all">All Levels</option>
                                    <option value="p3">P3</option>
                                    <option value="p4">P4</option>
                                    <option value="p5">P5</option>
                                    <option value="p6">P6</option>
                                </select>
                            </div>
                        </div>

                        <!-- Summary Stats -->
                        <div id="review-summary-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #f57c00;" id="stat-pending-count">0</div>
                                <div style="color: #666; font-size: 0.8rem;">Pending</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #388e3c;" id="stat-approved-today">0</div>
                                <div style="color: #666; font-size: 0.8rem;">Approved Today</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffebee, #ffcdd2); padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #d32f2f;" id="stat-rejected-today">0</div>
                                <div style="color: #666; font-size: 0.8rem;">Rejected Today</div>
                            </div>
                        </div>

                        <!-- Pending Questions List -->
                        <div id="pending-questions-container" style="display: flex; flex-direction: column; gap: 1.5rem;">
                            <div style="text-align: center; padding: 3rem; color: #888;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                                <p>No pending questions to review</p>
                                <p style="font-size: 0.85rem; margin-top: 0.5rem;">Questions submitted by interns will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WORKSHEET VIEW -->
                <div id="view-worksheet" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div class="worksheet-actions"
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0;"> My Worksheet</h2>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn" style="background: #9c27b0; color: white;"
                                    onclick="quickGenerateWorksheet()"> Quick Generate</button>
                                <button class="btn" style="background: #1976d2; color: white;"
                                    onclick="showSaveWorksheetModal()"> Save Worksheet</button>
                                <button class="btn" style="background: #28a745; color: white;"
                                    onclick="exportWorksheet()"> Export PDF</button>
                                <button class="btn" style="background: #dc3545; color: white;"
                                    onclick="clearWorksheet()"> Clear All</button>
                            </div>
                        </div>

                        <div id="worksheet-header"
                            style="display: none; border-bottom: 2px solid #000; padding-bottom: 1rem; margin-bottom: 2rem;">
                            <div
                                style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem;">
                                <span>Name: __________________________</span>
                                <span>Score: ________ / ________</span>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">Date: ________________</div>
                        </div>

                        <div id="worksheet-questions-container">
                            <div class="placeholder-content" id="worksheet-empty-msg">
                                <p style="font-size: 1.2rem; color: #666;">No questions added to your worksheet yet.</p>
                                <p style="font-size: 0.95rem; margin-top: 10px; color: #888;">Browse questions and click
                                    the <strong style="color: #2ed573;"> Worksheet</strong> button to add them here.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SAVED WORKSHEETS VIEW -->
                <div id="view-saved-worksheets" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0;"> My Saved Worksheets</h2>
                            <button class="btn" style="background: #dc3545; color: white;" onclick="refreshSavedWorksheets()"> Refresh</button>
                        </div>
                        <div id="saved-worksheets-container">
                            <div class="placeholder-content" id="saved-worksheets-empty-msg">
                                <p style="font-size: 1.2rem; color: #666;">No saved worksheets yet.</p>
                                <p style="font-size: 0.95rem; margin-top: 10px; color: #888;">
                                    Create a worksheet and click <strong style="color: #1976d2;"> Save Worksheet</strong> to save it here.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LEADERBOARD VIEW -->
                <div id="view-leaderboard" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 1000px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                            <h2 style="margin: 0; background: linear-gradient(135deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"> Student Leaderboard</h2>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <button class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; padding: 10px 24px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);" onclick="switchTab('practice', this)" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
                                     Practice Now
                                </button>
                                <button class="btn" style="background: #1976d2; color: white;" onclick="loadLeaderboard()"> Refresh</button>
                            </div>
                        </div>

                        <!--  PRIZE DRAW SECTION -->
                        <div id="prize-draw-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); border-radius: 20px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4); position: relative; overflow: hidden;">
                            <!-- Animated background sparkles -->
                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('data:image/svg+xml,%3Csvg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cg fill=\"%23ffffff\" fill-opacity=\"0.1\"%3E%3Cpath d=\"M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); opacity: 0.5; pointer-events: none;"></div>

                            <div style="position: relative; z-index: 1;">
                                <!-- Header -->
                                <div style="text-align: center; margin-bottom: 1.5rem;">
                                    <div style="display: inline-block; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius: 50px; padding: 8px 24px; margin-bottom: 1rem;">
                                        <span style="color: #FFD700; font-size: 1.5rem; animation: pulse 2s infinite;"></span>
                                        <span style="color: white; font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px;">Lucky Draw Event</span>
                                        <span style="color: #FFD700; font-size: 1.5rem; animation: pulse 2s infinite;"></span>
                                    </div>
                                    <h2 style="color: white; font-size: 2rem; margin: 0 0 0.5rem 0; text-shadow: 0 2px 10px rgba(0,0,0,0.3);"> Grand Prize Draw!</h2>
                                    <p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; margin: 0;">Win amazing prizes just by learning!</p>
                                </div>

                                <!-- Countdown Timer -->
                                <div style="background: rgba(0,0,0,0.2); backdrop-filter: blur(10px); border-radius: 16px; padding: 1.25rem; margin-bottom: 1.5rem; text-align: center;">
                                    <p style="color: rgba(255,255,255,0.8); margin: 0 0 0.75rem 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;"> Draw Date: February 15, 2026</p>
                                    <div id="prize-countdown" style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                        <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 12px 20px; min-width: 80px;">
                                            <div id="countdown-days" style="color: #FFD700; font-size: 2rem; font-weight: 800; line-height: 1;">--</div>
                                            <div style="color: rgba(255,255,255,0.8); font-size: 0.75rem; text-transform: uppercase;">Days</div>
                                        </div>
                                        <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 12px 20px; min-width: 80px;">
                                            <div id="countdown-hours" style="color: #FFD700; font-size: 2rem; font-weight: 800; line-height: 1;">--</div>
                                            <div style="color: rgba(255,255,255,0.8); font-size: 0.75rem; text-transform: uppercase;">Hours</div>
                                        </div>
                                        <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 12px 20px; min-width: 80px;">
                                            <div id="countdown-mins" style="color: #FFD700; font-size: 2rem; font-weight: 800; line-height: 1;">--</div>
                                            <div style="color: rgba(255,255,255,0.8); font-size: 0.75rem; text-transform: uppercase;">Mins</div>
                                        </div>
                                        <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 12px 20px; min-width: 80px;">
                                            <div id="countdown-secs" style="color: #FFD700; font-size: 2rem; font-weight: 800; line-height: 1;">--</div>
                                            <div style="color: rgba(255,255,255,0.8); font-size: 0.75rem; text-transform: uppercase;">Secs</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Winner Announcement (hidden by default, shown after draw) -->
                                <div id="prize-winner-announcement" style="display: none; background: linear-gradient(135deg, #FFD700, #FFA500); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
                                    <h3 style="color: #333; margin: 0 0 0.5rem 0; font-size: 1.5rem;"> Congratulations! </h3>
                                    <p style="color: #333; margin: 0; font-size: 1.1rem;">Winner: <strong id="winner-name">---</strong></p>
                                    <p style="color: #555; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Thank you to all participants!</p>
                                </div>

                                <!-- Prizes Display -->
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                                    <!-- Prize 1: Popular Voucher -->
                                    <div style="background: white; border-radius: 16px; padding: 1.5rem; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 30px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.15)'">
                                        <div style="background: linear-gradient(135deg, #FF6B6B, #ee5a24); color: white; font-size: 0.75rem; font-weight: 700; padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 1rem; text-transform: uppercase;">Prize Option 1</div>
                                        <img src="https://www.dropbox.com/scl/fi/e7u3u8hx9rrnmfd33ypzm/popular-voucher.png?rlkey=8yoay1qitlu73vh21zuuznyoy&raw=1" alt="Popular $30 Voucher" style="width: 100%; max-width: 200px; height: 120px; object-fit: contain; margin-bottom: 1rem; border-radius: 8px;">
                                        <h4 style="color: #333; margin: 0 0 0.5rem 0; font-size: 1.2rem;">$30 Popular Voucher</h4>
                                        <p style="color: #666; margin: 0; font-size: 0.85rem;">Get books, stationery & more!</p>
                                    </div>

                                    <!-- Prize 2: Roblox Gift Card -->
                                    <div style="background: white; border-radius: 16px; padding: 1.5rem; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 30px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.15)'">
                                        <div style="background: linear-gradient(135deg, #00b894, #00cec9); color: white; font-size: 0.75rem; font-weight: 700; padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 1rem; text-transform: uppercase;">Prize Option 2</div>
                                        <img src="https://www.dropbox.com/scl/fi/mc75afi4leil0ohgfmicm/roblox_30_gift_card_1725114732_880fb481_progressive.jpg?rlkey=imkwpncqglevmw9i2caklq8gd&raw=1" alt="Roblox $30 Gift Card" style="width: 100%; max-width: 200px; height: 120px; object-fit: contain; margin-bottom: 1rem; border-radius: 8px;">
                                        <h4 style="color: #333; margin: 0 0 0.5rem 0; font-size: 1.2rem;">$30 Roblox Gift Card</h4>
                                        <p style="color: #666; margin: 0; font-size: 0.85rem;">Get Robux for your favourite games!</p>
                                    </div>
                                </div>

                                <!-- Your Tickets Section -->
                                <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                        <div>
                                            <h4 style="color: white; margin: 0 0 0.25rem 0; font-size: 1.1rem;"> Your Lucky Draw Tickets</h4>
                                            <p style="color: rgba(255,255,255,0.8); margin: 0; font-size: 0.85rem;">More tickets = Higher chance to win!</p>
                                        </div>
                                        <div style="text-align: center;">
                                            <div id="user-ticket-count" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; font-size: 2.5rem; font-weight: 800; padding: 10px 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(255,215,0,0.4);">0</div>
                                            <div style="color: rgba(255,255,255,0.9); font-size: 0.8rem; margin-top: 4px;">TICKETS</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- How to Earn Tickets -->
                                <div style="background: rgba(255,255,255,0.95); border-radius: 16px; padding: 1.5rem;">
                                    <h4 style="color: #333; margin: 0 0 1rem 0; font-size: 1.1rem; text-align: center;"> How to Earn More Tickets</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                        <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 1rem; border-radius: 12px; text-align: center;">
                                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                            <div style="font-weight: 700; color: #2e7d32; font-size: 0.95rem;">Login Streak</div>
                                            <div style="color: #555; font-size: 0.8rem;">+1 ticket per streak day</div>
                                        </div>
                                        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 1rem; border-radius: 12px; text-align: center;">
                                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                            <div style="font-weight: 700; color: #1565c0; font-size: 0.95rem;">Rating Points</div>
                                            <div style="color: #555; font-size: 0.8rem;">+1 ticket per 100 rating</div>
                                        </div>
                                        <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 1rem; border-radius: 12px; text-align: center;">
                                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                            <div style="font-weight: 700; color: #e65100; font-size: 0.95rem;">Correct Answers</div>
                                            <div style="color: #555; font-size: 0.8rem;">+1 ticket per 10 correct</div>
                                        </div>
                                        <div style="background: linear-gradient(135deg, #fce4ec, #f8bbd9); padding: 1rem; border-radius: 12px; text-align: center;">
                                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                            <div style="font-weight: 700; color: #c2185b; font-size: 0.95rem;">Total Login Days</div>
                                            <div style="color: #555; font-size: 0.8rem;">+1 ticket per 3 days</div>
                                        </div>
                                    </div>
                                    <div style="text-align: center; margin-top: 1.25rem;">
                                        <button onclick="switchTab('practice', this)" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 14px 32px; border-radius: 30px; font-size: 1rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(102,126,234,0.4); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px) scale(1.02)'; this.style.boxShadow='0 6px 20px rgba(102,126,234,0.5)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 15px rgba(102,126,234,0.4)'">
                                             Start Practicing to Earn Tickets!
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- END PRIZE DRAW SECTION -->

                        <!-- Leaderboard Info Box -->
                        <div style="background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%); border-left: 4px solid #667eea; border-radius: 8px; padding: 1.25rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="display: flex; align-items: flex-start; gap: 12px;">
                                <div style="font-size: 1.5rem; line-height: 1;"></div>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: #333; font-weight: 600;">How the Leaderboard Works</h3>
                                    <p style="margin: 0; font-size: 0.9rem; color: #555; line-height: 1.6;">
                                        Your ranking is based on your <strong>rating</strong>, which changes when you answer questions in <strong>Practice Mode</strong>.
                                        Answering questions correctly increases your rating, while incorrect answers decrease it.
                                        The leaderboard shows your current rating, improvement score, and total attempts.
                                        <strong>Only practice mode activities count towards your leaderboard ranking.</strong>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div id="leaderboard-container">
                            <div class="placeholder-content" id="leaderboard-loading-msg">
                                <p style="font-size: 1.2rem; color: #666;">Loading leaderboard...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MY PROGRESS VIEW (Student) -->
                <div id="view-my-progress" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <h2 style="margin: 0; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"> My Progress</h2>
                            <button class="btn" style="background: #1976d2; color: white;" onclick="loadMyProgress()"> Refresh</button>
                        </div>

                        <!-- Student Selector (if multiple students) -->
                        <div id="my-progress-student-selector" style="margin-bottom: 2rem; display: none;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Select Student:</label>
                            <select id="my-progress-student-select" style="padding: 10px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%; max-width: 300px;" onchange="loadMyProgress()">
                            </select>
                        </div>

                        <div id="my-progress-container">
                            <div class="placeholder-content" id="my-progress-loading-msg">
                                <p style="font-size: 1.2rem; color: #666;">Loading your progress...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QUESTION LIST VIEW -->
                <div id="view-question-list" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 1400px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <h2 style="margin: 0; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"> Question Library</h2>
                            <button class="btn" style="background: #1976d2; color: white;" onclick="loadQuestionList()"> Refresh</button>
                        </div>

                        <!-- Filter and Sort Controls -->
                        <div style="background: #f5f5f5; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Sort By:</label>
                                <select id="question-list-sort" class="auth-input" style="width: 100%; padding: 10px; border-radius: 8px;" onchange="sortQuestionList()">
                                    <option value="rating-desc">Rating (High to Low)</option>
                                    <option value="rating-asc">Rating (Low to High)</option>
                                    <option value="topic-asc">Topic (A-Z)</option>
                                    <option value="topic-desc">Topic (Z-A)</option>
                                    <option value="date-desc">Date Added (Newest)</option>
                                    <option value="date-asc">Date Added (Oldest)</option>
                                    <option value="level-asc">Level (P3-P6)</option>
                                    <option value="level-desc">Level (P6-P3)</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Filter by Topic:</label>
                                <select id="question-list-filter-topic" class="auth-input" style="width: 100%; padding: 10px; border-radius: 8px;" onchange="filterQuestionList()">
                                    <option value="">All Topics</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Filter by Level:</label>
                                <select id="question-list-filter-level" class="auth-input" style="width: 100%; padding: 10px; border-radius: 8px;" onchange="filterQuestionList()">
                                    <option value="">All Levels</option>
                                    <option value="P3">Primary 3</option>
                                    <option value="P4">Primary 4</option>
                                    <option value="P5">Primary 5</option>
                                    <option value="P6">Primary 6</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Search:</label>
                                <input type="text" id="question-list-search" class="auth-input" style="width: 100%; padding: 10px; border-radius: 8px;" placeholder="Search questions..." oninput="debouncedFilterQuestionList()" aria-label="Search questions">
                            </div>
                        </div>

                        <div id="question-list-container">
                            <div class="placeholder-content" id="question-list-loading-msg">
                                <p style="font-size: 1.2rem; color: #666;">Loading questions...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STUDENT PROGRESS VIEW (Admin Only) -->
                <div id="view-student-progress" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 1100px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <h2 style="margin: 0;"> Student Progress Tracker</h2>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" style="background: #1976d2; color: white;" onclick="refreshStudentProgress()"> Refresh</button>
                                <button class="btn" style="background: #28a745; color: white;" onclick="exportProgressToCSV()"> Export CSV</button>
                            </div>
                        </div>
                        
                        <!-- Filter Controls -->
                        <div style="background: #f5f5f5; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <div>
                                <label style="font-weight: 600; margin-right: 8px;">Worksheet:</label>
                                <select id="progress-worksheet-filter" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.9rem;" onchange="filterProgressByWorksheet()">
                                    <option value="all">All Worksheets</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight: 600; margin-right: 8px;">Student:</label>
                                <select id="progress-student-filter" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.9rem;" onchange="filterProgressByStudent()">
                                    <option value="all">All Students</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight: 600; margin-right: 8px;">Status:</label>
                                <select id="progress-status-filter" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.9rem;" onchange="filterProgressByStatus()">
                                    <option value="all">All</option>
                                    <option value="completed">Completed</option>
                                    <option value="in-progress">In Progress</option>
                                </select>
                            </div>
                        </div>

                        <!-- Summary Stats -->
                        <div id="progress-summary-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 1.2rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #1976d2;" id="stat-total-attempts">0</div>
                                <div style="color: #666; font-size: 0.85rem;">Total Attempts</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 1.2rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #388e3c;" id="stat-completed-count">0</div>
                                <div style="color: #666; font-size: 0.85rem;">Completed</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 1.2rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #f57c00;" id="stat-avg-score">0%</div>
                                <div style="color: #666; font-size: 0.85rem;">Avg Score</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fce4ec, #f8bbd9); padding: 1.2rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #c2185b;" id="stat-unique-students">0</div>
                                <div style="color: #666; font-size: 0.85rem;">Students</div>
                            </div>
                        </div>

                        <!-- Progress Table -->
                        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                            <div style="overflow-x: auto;">
                                <table id="progress-table" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                    <thead>
                                        <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                            <th style="padding: 1rem; text-align: left; font-weight: 600;">Student</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600;">Worksheet</th>
                                            <th style="padding: 1rem; text-align: center; font-weight: 600;">Score</th>
                                            <th style="padding: 1rem; text-align: center; font-weight: 600;">Status</th>
                                            <th style="padding: 1rem; text-align: center; font-weight: 600;">Date</th>
                                            <th style="padding: 1rem; text-align: center; font-weight: 600;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="progress-table-body">
                                        <tr>
                                            <td colspan="6" style="padding: 3rem; text-align: center; color: #888;">
                                                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                                                <p>No worksheet attempts yet</p>
                                                <p style="font-size: 0.85rem; margin-top: 0.5rem;">Student progress will appear here when they attempt assigned worksheets</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Progress Detail Modal -->
                <div id="progress-detail-modal" class="modal-overlay">
                    <div class="modal-box" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 1rem;">
                            <h3 style="margin: 0; color: #1976d2;"> Detailed Results</h3>
                            <button class="btn" style="background: #666; color: white;" onclick="hideProgressDetailModal()"> Close</button>
                        </div>
                        
                        <!-- Student Info -->
                        <div id="progress-detail-header" style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <!-- Populated dynamically -->
                        </div>
                        
                        <!-- Question Results -->
                        <div id="progress-detail-questions">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- SHARED LESSONS VIEW -->
                <div id="view-lessons" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0;"> Lessons</h2>
                            <button class="btn" style="background: #f57c00; color: white;" onclick="refreshSharedLessons()"> Refresh</button>
                        </div>
                        <div id="lessons-container">
                            <div class="placeholder-content" id="lessons-empty-msg">
                                <p style="font-size: 1.2rem; color: #666;">No lessons available yet.</p>
                                <p style="font-size: 0.95rem; margin-top: 10px; color: #888;">
                                    Check back later for new lessons from your teacher!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LESSON DETAIL VIEW -->
                <div id="view-lesson-detail" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <button class="btn" style="background: #666; color: white; margin-bottom: 1.5rem;" onclick="switchTab('lessons')"> Back to Lessons</button>
                        <div id="lesson-detail-content"></div>
                    </div>
                </div>

                <!-- PRACTICE MODE VIEW -->
                <div id="view-practice" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h2 style="margin: 0; color: #7b1fa2;"> Practice Mode</h2>
                                <p style="margin: 0.5rem 0 0; color: #666;" id="practice-student-info">Select a student to start practicing</p>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="practice-student-select" style="height: 45px; margin: 0; border-radius: 8px; min-width: 250px; padding: 0 15px; font-size: 1rem; border: 2px solid #e0e0e0; background: #fafafa; cursor: pointer;" onchange="selectPracticeStudent()">
                                    <option value="">-- Select Student --</option>
                                </select>
                            </div>
                        </div>

                        <!-- Practice Stats -->
                        <div id="practice-stats" class="hidden" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: #e8f5e9; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #28a745;" id="stat-correct">0</div>
                                <div style="color: #666; font-size: 0.9rem;">Correct</div>
                            </div>
                            <div style="background: #ffebee; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #dc3545;" id="stat-wrong">0</div>
                                <div style="color: #666; font-size: 0.9rem;">Wrong</div>
                            </div>
                            <div style="background: #fff3e0; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #f57c00;" id="stat-review">0</div>
                                <div style="color: #666; font-size: 0.9rem;"> Review</div>
                            </div>
                            <div style="background: #e3f2fd; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #1976d2;" id="stat-remaining">0</div>
                                <div style="color: #666; font-size: 0.9rem;">Remaining</div>
                            </div>
                            <div style="background: #f3e5f5; padding: 1rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #7b1fa2;" id="stat-streak">0</div>
                                <div style="color: #666; font-size: 0.9rem;">Streak </div>
                            </div>
                        </div>

                        <!-- Start Practice Button -->
                        <div id="practice-start-container" style="text-align: center; padding: 3rem;">
                            <button id="btn-start-practice" class="btn" style="background: #7b1fa2; color: white; font-size: 1.2rem; padding: 15px 40px;" onclick="startPractice()" disabled>
                                 Start Practice
                            </button>
                            <p style="color: #888; margin-top: 1rem; font-size: 0.9rem;">Questions will be served based on your level. Review questions (from 7 days ago) come first!</p>
                        </div>

                        <!-- Current Question Container -->
                        <div id="practice-question-container" class="hidden">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span style="background: #f3e5f5; color: #7b1fa2; padding: 5px 15px; border-radius: 20px; font-weight: 600;" id="practice-question-level">P6</span>
                                <span style="color: #888; font-size: 0.9rem;" id="practice-question-topic">Topic: Forces</span>
                            </div>
                            <div id="practice-question-content" style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
                            <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;">
                                <button class="btn" style="background: #7b1fa2; color: white;" onclick="nextPracticeQuestion()">Next Question </button>
                                <button class="btn" style="background: #666; color: white;" onclick="endPractice()">End Practice</button>
                            </div>
                        </div>

                        <!-- Practice Complete -->
                        <div id="practice-complete" class="hidden" style="text-align: center; padding: 3rem;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                            <h3 style="color: #7b1fa2;">Practice Complete!</h3>
                            <p style="color: #666;" id="practice-summary">Great job!</p>
                            <button class="btn" style="background: #7b1fa2; color: white; margin-top: 1rem;" onclick="restartPractice()">Practice Again</button>
                        </div>
                    </div>
                </div>

                <!-- INBOX VIEW -->
                <div id="view-inbox" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h2 style="margin: 0; color: #0288d1;"> Inbox</h2>
                                <p style="margin: 0.5rem 0 0; color: #666;">Messages between you and Mr Chung</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" style="background: #0288d1; color: white;" onclick="refreshInbox()"> Refresh</button>
                                <button id="btn-new-message" class="btn" style="background: #28a745; color: white;" onclick="showNewMessageModal()"> New Message</button>
                            </div>
                        </div>

                        <!-- Message Tabs -->
                        <div style="display: flex; gap: 10px; margin-bottom: 1.5rem; flex-wrap: wrap;">
                            <button id="inbox-tab-received" class="inbox-tab active" onclick="switchInboxTab('received')"> Received</button>
                            <button id="inbox-tab-sent" class="inbox-tab" onclick="switchInboxTab('sent')"> Sent</button>
                            <button id="inbox-tab-deleted" class="inbox-tab" onclick="switchInboxTab('deleted')" style="background: #fff5f5; border-color: #ffcdd2;"> Deleted</button>
                        </div>

                        <!-- Messages Container -->
                        <div id="inbox-messages-container">
                            <div class="inbox-empty" id="inbox-empty-msg">
                                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                                <p>No messages yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Flagged Questions View (Admin Only) -->
                <div id="view-flagged" class="view-content hidden" style="flex: 1;">
                    <div style="max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h2 style="margin: 0; color: #ff9800;"> Flagged Questions</h2>
                                <p style="margin: 0.5rem 0 0; color: #666;">Questions reported by users as having issues</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" style="background: #ff9800; color: white;" onclick="loadFlaggedQuestions()"> Refresh</button>
                            </div>
                        </div>

                        <!-- Flagged Questions Tabs -->
                        <div style="display: flex; gap: 10px; margin-bottom: 1.5rem; flex-wrap: wrap;">
                            <button id="flagged-tab-pending" class="inbox-tab active" onclick="switchFlaggedTab('pending')" style="border-color: #ff9800;"> Pending</button>
                            <button id="flagged-tab-resolved" class="inbox-tab" onclick="switchFlaggedTab('resolved')" style="border-color: #4CAF50;"> Resolved</button>
                            <button id="flagged-tab-all" class="inbox-tab" onclick="switchFlaggedTab('all')"> All</button>
                        </div>

                        <!-- Flagged Questions Container -->
                        <div id="flagged-questions-container">
                            <div class="inbox-empty" id="flagged-empty-msg">
                                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                                <p>No flagged questions</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Worksheet Attempt Modal -->
    <div id="worksheet-attempt-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #667eea; padding-bottom: 1rem;">
                <div>
                    <h3 style="margin: 0; color: #667eea;" id="attempt-worksheet-title"> Worksheet</h3>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;" id="attempt-worksheet-progress">Question 1 of 5</div>
                </div>
                <button class="btn" style="background: #666; color: white;" onclick="cancelWorksheetAttempt()"> Exit</button>
            </div>
            
            <!-- Progress Bar -->
            <div style="background: #e0e0e0; height: 8px; border-radius: 4px; margin-bottom: 1.5rem; overflow: hidden;">
                <div id="attempt-progress-bar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
            </div>
            
            <!-- Question Container -->
            <div id="attempt-question-container" style="min-height: 300px;">
                <!-- Question will be loaded here -->
            </div>
            
            <!-- Navigation Buttons -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e0e0e0;">
                <button id="attempt-prev-btn" class="btn" style="background: #666; color: white;" onclick="prevAttemptQuestion()"> Previous</button>
                <div style="display: flex; gap: 10px;">
                    <button id="attempt-next-btn" class="btn" style="background: #667eea; color: white;" onclick="nextAttemptQuestion()">Next </button>
                    <button id="attempt-submit-btn" class="btn hidden" style="background: #28a745; color: white;" onclick="submitWorksheetAttempt()"> Submit Worksheet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Consult Mr Chung Modal -->
    <div id="consult-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 600px;">
            <h3 style="color: #0288d1; margin-bottom: 1rem;"> Ask Mr Chung</h3>
            <div id="consult-question-preview" style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; max-height: 150px; overflow-y: auto; font-size: 0.9rem; border-left: 4px solid #0288d1;">
                <!-- Question preview will be inserted here -->
            </div>
            <div class="form-group">
                <label for="consult-message">Your Question / Message *</label>
                <textarea id="consult-message" rows="4" placeholder="Type your question here..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideConsultModal()">Cancel</button>
                <button class="btn-save" style="background: #0288d1;" onclick="sendConsultMessage()"> Send Message</button>
            </div>
        </div>
    </div>

    <!-- New Message Modal (for admin to message students) -->
    <div id="new-message-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 600px;">
            <h3 style="color: #0288d1; margin-bottom: 1rem;"> New Message</h3>
            <div class="form-group" id="recipient-select-group">
                <label for="message-recipient">To *</label>
                <select id="message-recipient" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    <option value="">-- Select Recipient --</option>
                    <option value="admin">Mr Chung (Teacher)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="new-message-subject">Subject *</label>
                <input type="text" id="new-message-subject" placeholder="Subject..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
            </div>
            <div class="form-group">
                <label for="new-message-content">Message *</label>
                <textarea id="new-message-content" rows="5" placeholder="Type your message here..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideNewMessageModal()">Cancel</button>
                <button class="btn-save" style="background: #0288d1;" onclick="sendNewMessage()"> Send</button>
            </div>
        </div>
    </div>

    <!-- View Message Modal -->
    <div id="view-message-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 650px;">
            <div id="view-message-content"></div>
            <div class="modal-buttons" style="margin-top: 1.5rem; flex-wrap: wrap;">
                <button class="btn-cancel" onclick="hideViewMessageModal()">Close</button>
                <button id="btn-delete-message" class="btn" style="background: #dc3545; color: white;" onclick="deleteCurrentMessage()"> Delete</button>
                <button id="btn-reply-message" class="btn-save" style="background: #0288d1;" onclick="replyToMessage()"> Reply</button>
            </div>
        </div>
    </div>

    <!-- Flag Question Modal -->
    <div id="flag-question-modal" class="modal-overlay">
        <div class="modal-box flag-modal-content">
            <h3> Flag Question</h3>
            <div id="flag-question-preview" class="flag-question-preview">
                <strong>Question:</strong> <span id="flag-question-title"></span>
            </div>
            <div class="form-group">
                <label for="flag-comment-input">What's wrong with this question?</label>
                <textarea id="flag-comment-input" placeholder="Describe the issue (e.g., incorrect answer, unclear wording, typo, etc.)..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideFlagModal()">Cancel</button>
                <button class="btn-save" onclick="submitFlag()" style="background: #ff9800;"> Submit Flag</button>
            </div>
        </div>
    </div>

    <!-- Question Popup Modal -->
    <div id="question-popup-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 1rem;">
                <h3 style="margin: 0; color: #1976d2;"> Original Question</h3>
                <button class="btn" style="background: #666; color: white; padding: 8px 16px;" onclick="hideQuestionPopup()"> Close</button>
            </div>
            <div id="question-popup-content" style="padding: 1rem 0;"></div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div id="achievements-modal" class="modal-overlay">
        <div class="modal-box achievements-modal" style="max-width: 650px; max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #FFD700; padding-bottom: 1rem;">
                <h3 style="margin: 0; color: #333; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5rem;"></span> Achievements
                </h3>
                <button class="btn" style="background: #666; color: white; padding: 8px 16px;" onclick="hideAchievementsModal()"> Close</button>
            </div>
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: center;">
                <div style="font-size: 0.9rem; opacity: 0.9;">Total XP Earned</div>
                <div style="font-size: 2rem; font-weight: 700;" id="achievements-total-xp">0 XP</div>
            </div>
            <div class="achievement-grid" id="achievements-grid">
                <!-- Achievements will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Daily Challenge Details Modal -->
    <div id="daily-challenge-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 450px;">
            <div style="background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0; margin: -24px -24px 1.5rem -24px; text-align: center;">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;"></div>
                <h3 style="margin: 0; font-size: 1.5rem;">Daily Challenge</h3>
                <div style="opacity: 0.9; margin-top: 0.5rem;" id="dc-modal-timer">Resets in: 23:59:59</div>
            </div>
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 1.2rem; font-weight: 600; color: #333; margin-bottom: 1rem;" id="dc-modal-task">
                    Answer 5 questions correctly
                </div>
                <div style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 1rem;">
                    <div>
                        <div style="font-size: 2rem; font-weight: 700; color: #FF6B6B;" id="dc-modal-progress">0/5</div>
                        <div style="font-size: 0.85rem; color: #666;">Progress</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: 700; color: #FFD700;" id="dc-modal-reward">+50 XP</div>
                        <div style="font-size: 0.85rem; color: #666;">Reward</div>
                    </div>
                </div>
                <div style="background: #f5f5f5; border-radius: 12px; height: 16px; overflow: hidden; margin: 1rem 0;">
                    <div id="dc-modal-progress-bar" style="background: linear-gradient(90deg, #FF6B6B, #FF8E53); height: 100%; border-radius: 12px; transition: width 0.5s; width: 0%;"></div>
                </div>
            </div>
            <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 8px; color: #2e7d32; font-weight: 600;">
                    <span></span> Tip
                </div>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #555;">
                    Complete daily challenges consistently to earn bonus XP and unlock special achievements!
                </p>
            </div>
            <div style="display: flex; justify-content: center;">
                <button class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 30px;" onclick="hideDailyChallengeModal(); switchTab('practice', document.getElementById('btn-sidebar-practice'));">
                     Start Practicing
                </button>
            </div>
            <div style="text-align: center; margin-top: 1rem;">
                <button style="background: none; border: none; color: #666; cursor: pointer;" onclick="hideDailyChallengeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Quick Start Wizard (for new users) -->
    <div id="quickstart-wizard" class="quickstart-overlay" style="display: none;">
        <div class="quickstart-modal">
            <div class="quickstart-header">
                <h2>Welcome to CER Questions! </h2>
                <p>Let's get you started on your learning journey</p>
            </div>
            <div class="quickstart-content">
                <!-- Step 1: Welcome -->
                <div class="quickstart-step active" data-step="1">
                    <div class="quickstart-step-title">
                        <span style="font-size: 1.5rem;"></span> Hello, Young Scientist!
                    </div>
                    <div class="quickstart-step-content">
                        <p>This app will help you master Science questions and become a pro at answering exam questions!</p>
                        <ul class="quickstart-feature-list">
                            <li>
                                <span class="quickstart-feature-icon"></span>
                                <div>
                                    <strong>Practice Questions</strong><br>
                                    <span style="color: #777;">Answer MCQ and Open-Ended questions</span>
                                </div>
                            </li>
                            <li>
                                <span class="quickstart-feature-icon"></span>
                                <div>
                                    <strong>Earn XP & Level Up</strong><br>
                                    <span style="color: #777;">Gain experience points with each answer</span>
                                </div>
                            </li>
                            <li>
                                <span class="quickstart-feature-icon"></span>
                                <div>
                                    <strong>Compete & Achieve</strong><br>
                                    <span style="color: #777;">Unlock badges and climb the leaderboard</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Step 2: Practice Mode -->
                <div class="quickstart-step" data-step="2">
                    <div class="quickstart-step-title">
                        <span style="font-size: 1.5rem;"></span> Practice Mode
                    </div>
                    <div class="quickstart-step-content">
                        <p>This is where you'll spend most of your time!</p>
                        <ul class="quickstart-feature-list">
                            <li>
                                <span class="quickstart-feature-icon"></span>
                                <div>
                                    <strong>Click "Practice Mode"</strong><br>
                                    <span style="color: #777;">Start answering questions tailored to your level</span>
                                </div>
                            </li>
                            <li>
                                <span class="quickstart-feature-icon"></span>
                                <div>
                                    <strong>OEQ or MCQ</strong><br>
                                    <span style="color: #777;">Toggle between Open-Ended and Multiple Choice</span>
                                </div>
                            </li>
                            <li>
                                <span class="quickstart-feature-icon"></span>
                                <div>
                                    <strong>See Instant Feedback</strong><br>
                                    <span style="color: #777;">Learn from your mistakes right away</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Step 3: Gamification -->
                <div class="quickstart-step" data-step="3">
                    <div class="quickstart-step-title">
                        <span style="font-size: 1.5rem;"></span> Level Up & Earn Rewards
                    </div>
                    <div class="quickstart-step-content">
                        <p>Make learning fun with our gamification system!</p>
                        <ul class="quickstart-feature-list">
                            <li>
                                <span class="quickstart-feature-icon"></span>
                                <div>
                                    <strong>Earn XP</strong><br>
                                    <span style="color: #777;">+10 XP for correct answers, +5 XP for trying</span>
                                </div>
                            </li>
                            <li>
                                <span class="quickstart-feature-icon"></span>
                                <div>
                                    <strong>Daily Streaks</strong><br>
                                    <span style="color: #777;">Practice daily for bonus XP multipliers</span>
                                </div>
                            </li>
                            <li>
                                <span class="quickstart-feature-icon"></span>
                                <div>
                                    <strong>Unlock Achievements</strong><br>
                                    <span style="color: #777;">Earn badges for completing challenges</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Step 4: Daily Challenges -->
                <div class="quickstart-step" data-step="4">
                    <div class="quickstart-step-title">
                        <span style="font-size: 1.5rem;"></span> Daily Challenges
                    </div>
                    <div class="quickstart-step-content">
                        <p>Complete daily challenges for extra rewards!</p>
                        <ul class="quickstart-feature-list">
                            <li>
                                <span class="quickstart-feature-icon"></span>
                                <div>
                                    <strong>New Challenge Every Day</strong><br>
                                    <span style="color: #777;">Fresh goals to keep you motivated</span>
                                </div>
                            </li>
                            <li>
                                <span class="quickstart-feature-icon"></span>
                                <div>
                                    <strong>Bonus XP Rewards</strong><br>
                                    <span style="color: #777;">Complete challenges for +50 to +100 XP</span>
                                </div>
                            </li>
                            <li>
                                <span class="quickstart-feature-icon"></span>
                                <div>
                                    <strong>Resets at Midnight</strong><br>
                                    <span style="color: #777;">Don't miss your daily bonus!</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Step 5: Ready to Go -->
                <div class="quickstart-step" data-step="5">
                    <div class="quickstart-step-title">
                        <span style="font-size: 1.5rem;"></span> You're Ready!
                    </div>
                    <div class="quickstart-step-content" style="text-align: center;">
                        <div style="font-size: 4rem; margin: 1rem 0;"></div>
                        <p style="font-size: 1.1rem; font-weight: 600; color: #333; margin-bottom: 1rem;">
                            Time to start your science journey!
                        </p>
                        <p>Click "Let's Go!" to begin practicing and earning XP.</p>
                        <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 1rem; border-radius: 12px; margin-top: 1.5rem;">
                            <div style="color: #2e7d32; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span></span> Welcome Bonus: +25 XP!
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="quickstart-footer">
                <button class="quickstart-nav-btn prev" id="quickstart-prev-btn" onclick="quickstartPrevStep()" disabled> Back</button>
                <div class="quickstart-dots" id="quickstart-dots">
                    <div class="quickstart-dot active"></div>
                    <div class="quickstart-dot"></div>
                    <div class="quickstart-dot"></div>
                    <div class="quickstart-dot"></div>
                    <div class="quickstart-dot"></div>
                </div>
                <button class="quickstart-nav-btn next" id="quickstart-next-btn" onclick="quickstartNextStep()">Next </button>
            </div>
        </div>
    </div>

    <!-- Celebration Overlay Container -->
    <div id="celebration-overlay" class="celebration-overlay" style="display: none;"></div>

    <!-- Account Settings Modal -->
    <div id="account-settings-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 500px;">
            <h3 style="color: #1976d2; margin-bottom: 1.5rem;"> Account Settings</h3>
            
            <!-- Account Info Section -->
            <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">Email</div>
                <div id="settings-email" style="font-weight: 600; color: #333;">Loading...</div>
            </div>

            <!-- Student Names Section -->
            <div id="settings-students-section" style="margin-bottom: 1.5rem;">
                <h4 style="color: #333; margin-bottom: 1rem; font-size: 1rem;"> Students</h4>
                <div id="settings-students-list">
                    <!-- Student entries will be populated here -->
                </div>
            </div>

            <!-- Change Password Section -->
            <div style="border-top: 1px solid #e0e0e0; padding-top: 1.5rem; margin-bottom: 1.5rem;">
                <h4 style="color: #333; margin-bottom: 1rem; font-size: 1rem;"> Change Password</h4>
                <div class="form-group">
                    <label for="settings-new-password">New Password</label>
                    <input type="password" id="settings-new-password" class="auth-input" placeholder="Enter new password" style="margin-bottom: 10px;">
                </div>
                <div class="form-group">
                    <label for="settings-confirm-password">Confirm New Password</label>
                    <input type="password" id="settings-confirm-password" class="auth-input" placeholder="Confirm new password">
                </div>
                <button class="btn" style="background: #f57c00; color: white; width: 100%; margin-top: 1rem;" onclick="changePassword()">
                     Update Password
                </button>
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideAccountSettings()">Close</button>
                <button class="btn-save" onclick="saveAccountSettings()"> Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Welcome Back / New Questions Modal -->
    <div id="welcome-back-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 450px; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
            <h3 style="color: #667eea; margin-bottom: 0.5rem;" id="welcome-back-title">Welcome Back!</h3>
            <p style="color: #666; margin-bottom: 1.5rem;" id="welcome-back-subtitle">Good to see you again</p>
            
            <!-- New Questions Info -->
            <div id="new-questions-info" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                <div style="font-size: 2.5rem; font-weight: 700; color: #2e7d32;" id="new-questions-count">0</div>
                <div style="font-size: 1rem; color: #2e7d32; font-weight: 600;">New Questions Added!</div>
                <div style="font-size: 0.85rem; color: #666; margin-top: 5px;" id="new-questions-since">Since your last visit</div>
            </div>
            
            <!-- Quick Stats -->
            <div id="welcome-quick-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 1.5rem;">
                <div style="background: #f5f5f5; padding: 10px; border-radius: 8px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: #667eea;" id="welcome-stat-streak">0</div>
                    <div style="font-size: 0.75rem; color: #888;">Day Streak</div>
                </div>
                <div style="background: #f5f5f5; padding: 10px; border-radius: 8px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: #4CAF50;" id="welcome-stat-rating">1000</div>
                    <div style="font-size: 0.75rem; color: #888;">Your Rating</div>
                </div>
                <div style="background: #f5f5f5; padding: 10px; border-radius: 8px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: #ff9800;" id="welcome-stat-review">0</div>
                    <div style="font-size: 0.75rem; color: #888;">Due for Review</div>
                </div>
            </div>
            
            <div class="modal-buttons" style="flex-direction: column; gap: 10px;">
                <button class="btn-save" onclick="practiceNewQuestions()" style="width: 100%; background: linear-gradient(135deg, #667eea, #764ba2); padding: 12px;" id="btn-practice-new">
                     Practice New Questions
                </button>
                <button class="btn-cancel" onclick="hideWelcomeModal()" style="width: 100%;">
                    Maybe Later
                </button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // FORCE FRESH CONTENT - AGGRESSIVE CACHE BUSTING
        // =====================================================
        (function() {
            'use strict';
            
            // Generate unique version based on current timestamp
            const currentTimestamp = Date.now();
            const storedTimestamp = sessionStorage.getItem('page_load_time');
            
            // Display version for debugging (can be removed in production)
            const versionDisplay = document.getElementById('version-display');
            if (versionDisplay) {
                versionDisplay.textContent = 'v' + currentTimestamp;
            }
            
            // Method 1: Force reload if this is a new browser session
            if (!storedTimestamp) {
                sessionStorage.setItem('page_load_time', currentTimestamp);
                
                // Check if URL already has cache buster
                const urlParams = new URLSearchParams(window.location.search);
                if (!urlParams.has('_cb')) {
                    // Add cache buster to URL and reload
                    const newUrl = window.location.pathname + '?_cb=' + currentTimestamp + window.location.hash;
                    window.location.replace(newUrl);
                    return; // Stop execution
                }
            }
            
            // Method 2: Fetch the page with no-cache headers to check for updates
            // BUT skip if user is in admin mode (editing questions)
            fetch(window.location.pathname, {
                method: 'HEAD',
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            }).then(response => {
                const serverLastModified = response.headers.get('Last-Modified');
                const serverETag = response.headers.get('ETag');
                const serverVersion = serverLastModified || serverETag || '';
                
                const cachedVersion = localStorage.getItem('server_file_version');
                
                if (cachedVersion && serverVersion && cachedVersion !== serverVersion) {
                    // Check if user is in admin mode - don't auto-reload if they're working on a question
                    const isInAdminMode = document.getElementById('view-admin') && 
                                          !document.getElementById('view-admin').classList.contains('hidden');
                    const hasUnsavedWork = window.adminBlocks && window.adminBlocks.length > 0;
                    const isSaving = window.isSavingQuestion;
                    
                    if (isInAdminMode || hasUnsavedWork || isSaving) {
                        console.log('New version available but user is in admin mode - skipping auto-reload');
                        localStorage.setItem('server_file_version', serverVersion);
                        return;
                    }
                    
                    // Server file has changed - force hard reload
                    console.log('New version detected! Reloading...');
                    localStorage.setItem('server_file_version', serverVersion);
                    
                    // Clear all caches
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                        });
                    }
                    
                    // Force reload bypassing cache
                    window.location.href = window.location.pathname + '?_cb=' + Date.now();
                } else if (!cachedVersion && serverVersion) {
                    localStorage.setItem('server_file_version', serverVersion);
                }
            }).catch(err => {
                console.log('Version check failed:', err);
            });
            
            // Method 3: Clear service worker caches if present
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => {
                        registration.unregister();
                    });
                });
            }
        })();

        // =====================================================
        // GLOBAL STATE & UTILITIES
        // =====================================================
        window.adminBlocks = [];
        window.isAdminUser = false;
        window.worksheetItems = [];
        window.currentActiveTab = 'cer';
        window.currentMode = 'mcq'; // Default to MCQ mode
        window.currentMcqLevel = 'P6'; // Default MCQ level matches header
        window.currentOeqLevel = 'P6';
        window.currentMcqTopic = '';
        window.editingQuestionId = null;

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================

        /**
         * Debounce function - limits how often a function can be called
         * @param {Function} func - Function to debounce
         * @param {number} wait - Milliseconds to wait before calling
         * @returns {Function} Debounced function
         */
        window.debounce = function(func, wait = 300) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        /**
         * Throttle function - ensures function is called at most once per interval
         * @param {Function} func - Function to throttle
         * @param {number} limit - Minimum milliseconds between calls
         * @returns {Function} Throttled function
         */
        window.throttle = function(func, limit = 100) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        };

        /**
         * Sanitize HTML to prevent XSS attacks
         * @param {string} str - String to sanitize
         * @returns {string} Sanitized string
         */
        window.sanitizeHTML = function(str) {
            if (!str) return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        };

        /**
         * Escape special characters for use in HTML attributes
         * @param {string} str - String to escape
         * @returns {string} Escaped string
         */
        window.escapeAttr = function(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function(match) {
                const escape = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                };
                return escape[match];
            });
        };

        /**
         * Show a toast notification
         * @param {string} message - Message to display
         * @param {string} type - Type: 'success', 'error', 'info', 'warning'
         * @param {number} duration - Duration in ms (default 3000)
         */
        window.showToast = function(message, type = 'info', duration = 3000) {
            // Remove existing toast if any
            const existingToast = document.getElementById('toast-notification');
            if (existingToast) existingToast.remove();

            const colors = {
                success: { bg: '#d4edda', border: '#28a745', text: '#155724', icon: '' },
                error: { bg: '#f8d7da', border: '#dc3545', text: '#721c24', icon: '' },
                warning: { bg: '#fff3cd', border: '#ffc107', text: '#856404', icon: '' },
                info: { bg: '#d1ecf1', border: '#17a2b8', text: '#0c5460', icon: '' }
            };
            const color = colors[type] || colors.info;

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'polite');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${color.bg};
                border: 1px solid ${color.border};
                color: ${color.text};
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 10003;
                display: flex;
                align-items: center;
                gap: 12px;
                font-weight: 500;
                animation: slideInToast 0.3s ease;
                max-width: 400px;
            `;
            toast.innerHTML = `<span>${color.icon}</span><span>${window.sanitizeHTML(message)}</span>`;

            document.body.appendChild(toast);

            // Auto remove after duration
            setTimeout(() => {
                toast.style.animation = 'slideOutToast 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        };

        // Add toast animation CSS
        if (!document.getElementById('toast-styles')) {
            const style = document.createElement('style');
            style.id = 'toast-styles';
            style.textContent = `
                @keyframes slideInToast {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutToast {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        /**
         * Show a loading spinner overlay
         * @param {string} message - Optional message to display
         * @returns {Function} Function to hide the spinner
         */
        window.showLoadingSpinner = function(message = 'Loading...') {
            // Remove existing spinner if any
            const existingSpinner = document.getElementById('loading-spinner-overlay');
            if (existingSpinner) existingSpinner.remove();

            const overlay = document.createElement('div');
            overlay.id = 'loading-spinner-overlay';
            overlay.setAttribute('role', 'alert');
            overlay.setAttribute('aria-busy', 'true');
            overlay.setAttribute('aria-live', 'polite');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 10004;
            `;
            overlay.innerHTML = `
                <div style="background: white; padding: 30px 50px; border-radius: 16px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                    <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                    <p style="margin: 0; color: #333; font-weight: 500;">${window.sanitizeHTML(message)}</p>
                </div>
            `;

            document.body.appendChild(overlay);

            // Add spinner animation if not exists
            if (!document.getElementById('spinner-styles')) {
                const style = document.createElement('style');
                style.id = 'spinner-styles';
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }

            // Return function to hide spinner
            return function hideSpinner() {
                const spinner = document.getElementById('loading-spinner-overlay');
                if (spinner) spinner.remove();
            };
        };

        /**
         * Hide the loading spinner
         */
        window.hideLoadingSpinner = function() {
            const spinner = document.getElementById('loading-spinner-overlay');
            if (spinner) spinner.remove();
        };

        // =====================================================
        // KEYBOARD SHORTCUTS
        // =====================================================

        /**
         * Keyboard shortcuts for power users
         * Alt+P: Practice mode
         * Alt+W: Worksheet
         * Alt+L: Leaderboard
         * Alt+M: Toggle MCQ/OEQ mode
         * Alt+S: Save worksheet (when in worksheet view)
         * Alt+H: Show help/shortcuts
         * Escape: Close modals
         * Arrow keys: Navigate questions (when in practice mode)
         */
        window.keyboardShortcutsEnabled = true;

        window.initKeyboardShortcuts = function() {
            document.addEventListener('keydown', function(e) {
                // Don't trigger shortcuts when typing in inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                    // Only handle Escape in inputs
                    if (e.key === 'Escape') {
                        e.target.blur();
                    }
                    return;
                }

                if (!window.keyboardShortcutsEnabled) return;

                // Handle Escape key - close modals
                if (e.key === 'Escape') {
                    // Close any visible modal
                    const visibleModal = document.querySelector('.modal-overlay.visible');
                    if (visibleModal) {
                        visibleModal.classList.remove('visible');
                        e.preventDefault();
                        return;
                    }
                    // Close question popup if open
                    const questionPopup = document.querySelector('.modal-overlay[style*="z-index: 10000"]');
                    if (questionPopup) {
                        questionPopup.remove();
                        e.preventDefault();
                        return;
                    }
                }

                // Alt key shortcuts
                if (e.altKey && !e.ctrlKey && !e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'p': // Practice mode
                            e.preventDefault();
                            if (window.switchTab) switchTab('practice');
                            window.showToast('Switched to Practice Mode', 'info', 1500);
                            break;
                        case 'w': // Worksheet
                            e.preventDefault();
                            if (window.switchTab) switchTab('worksheet');
                            window.showToast('Switched to Worksheet', 'info', 1500);
                            break;
                        case 'l': // Leaderboard
                            e.preventDefault();
                            if (window.switchTab) switchTab('leaderboard');
                            window.showToast('Switched to Leaderboard', 'info', 1500);
                            break;
                        case 'm': // Toggle mode
                            e.preventDefault();
                            if (window.toggleMode) toggleMode();
                            break;
                        case 's': // Save worksheet
                            e.preventDefault();
                            if (window.showSaveWorksheetModal) showSaveWorksheetModal();
                            break;
                        case 'h': // Show help
                            e.preventDefault();
                            showKeyboardShortcutsHelp();
                            break;
                        case 'q': // Question library
                            e.preventDefault();
                            if (window.switchTab) switchTab('question-list');
                            window.showToast('Switched to Question Library', 'info', 1500);
                            break;
                        case 'r': // My Progress
                            e.preventDefault();
                            if (window.switchTab) switchTab('my-progress');
                            window.showToast('Switched to My Progress', 'info', 1500);
                            break;
                        case 'd': // Dark mode toggle
                            e.preventDefault();
                            if (window.toggleDarkMode) toggleDarkMode();
                            break;
                    }
                }

                // Number keys 1-4 for level selection (without modifiers)
                if (!e.altKey && !e.ctrlKey && !e.metaKey && !e.shiftKey) {
                    if (e.key >= '3' && e.key <= '6') {
                        const level = 'P' + e.key;
                        if (window.changeLevel) {
                            changeLevel(level);
                            window.showToast(`Level changed to ${level}`, 'info', 1500);
                        }
                    }
                }
            });
        };

        /**
         * Show keyboard shortcuts help modal
         */
        window.showKeyboardShortcutsHelp = function() {
            const existingModal = document.getElementById('shortcuts-help-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'shortcuts-help-modal';
            modal.className = 'modal-overlay visible';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            modal.setAttribute('aria-labelledby', 'shortcuts-title');
            modal.style.zIndex = '10005';
            modal.innerHTML = `
                <div class="modal-box" style="max-width: 500px;">
                    <h3 id="shortcuts-title" style="margin-bottom: 1.5rem; color: #667eea; display: flex; align-items: center; gap: 10px;">
                         Keyboard Shortcuts
                    </h3>
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span><kbd style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-family: monospace; border: 1px solid #ddd;">Alt + P</kbd></span>
                            <span style="color: #666;">Practice Mode</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span><kbd style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-family: monospace; border: 1px solid #ddd;">Alt + W</kbd></span>
                            <span style="color: #666;">My Worksheet</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span><kbd style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-family: monospace; border: 1px solid #ddd;">Alt + Q</kbd></span>
                            <span style="color: #666;">Question Library</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span><kbd style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-family: monospace; border: 1px solid #ddd;">Alt + L</kbd></span>
                            <span style="color: #666;">Leaderboard</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span><kbd style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-family: monospace; border: 1px solid #ddd;">Alt + R</kbd></span>
                            <span style="color: #666;">My Progress</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span><kbd style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-family: monospace; border: 1px solid #ddd;">Alt + M</kbd></span>
                            <span style="color: #666;">Toggle MCQ/OEQ Mode</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span><kbd style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-family: monospace; border: 1px solid #ddd;">Alt + S</kbd></span>
                            <span style="color: #666;">Save Worksheet</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span><kbd style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-family: monospace; border: 1px solid #ddd;">3, 4, 5, 6</kbd></span>
                            <span style="color: #666;">Change Level (P3-P6)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span><kbd style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-family: monospace; border: 1px solid #ddd;">Alt + D</kbd></span>
                            <span style="color: #666;">Toggle Dark Mode</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span><kbd style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-family: monospace; border: 1px solid #ddd;">Escape</kbd></span>
                            <span style="color: #666;">Close Modal/Popup</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <span><kbd style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-family: monospace; border: 1px solid #ddd;">Alt + H</kbd></span>
                            <span style="color: #666;">Show This Help</span>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button onclick="this.closest('.modal-overlay').remove()" class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            Got it!
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Close on backdrop click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) modal.remove();
            });
        };

        // Initialize keyboard shortcuts when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.initKeyboardShortcuts);
        } else {
            window.initKeyboardShortcuts();
        }

        // =====================================================
        // DARK MODE SUPPORT
        // =====================================================

        /**
         * Initialize dark mode based on saved preference or system preference
         */
        window.initDarkMode = function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
            // If no saved preference, system preference is handled by CSS media query
        };

        /**
         * Toggle dark mode on/off
         */
        window.toggleDarkMode = function() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            let newTheme;

            if (currentTheme === 'dark') {
                newTheme = 'light';
            } else if (currentTheme === 'light') {
                // If explicitly light, switch to dark
                newTheme = 'dark';
            } else {
                // If no explicit theme, check system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                newTheme = prefersDark ? 'light' : 'dark';
            }

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            const icon = newTheme === 'dark' ? '' : '';
            const label = newTheme === 'dark' ? 'Dark Mode' : 'Light Mode';
            window.showToast(`${icon} ${label} enabled`, 'info', 1500);

            // Update toggle button if exists
            const darkModeBtn = document.getElementById('dark-mode-toggle');
            if (darkModeBtn) {
                darkModeBtn.innerHTML = newTheme === 'dark' ? '' : '';
                darkModeBtn.setAttribute('aria-label', newTheme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
            }
        };

        /**
         * Get current theme
         */
        window.getCurrentTheme = function() {
            const savedTheme = document.documentElement.getAttribute('data-theme');
            if (savedTheme) return savedTheme;

            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };

        // Initialize dark mode on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.initDarkMode);
        } else {
            window.initDarkMode();
        }

        // Change level (works for both OEQ and MCQ modes)
        window.changeLevel = function(level) {
            if (window.currentMode === 'mcq') {
                window.currentMcqLevel = level;
                // Update MCQ level select if it exists
                const mcqSelect = document.getElementById('mcq-level-select');
                if (mcqSelect) mcqSelect.value = level;
                renderMcqHeaders();
            } else {
                window.currentOeqLevel = level;
                // Refresh OEQ tabs with new level
                renderOeqHeaderTabs(window.currentActiveTab || 'cer');
                // Update sidebar
                updateOeqSidebar(window.currentActiveTab || 'cer');
            }
            
            // Update the header level select
            const headerSelect = document.getElementById('header-level-select');
            if (headerSelect) headerSelect.value = level;
            
            // Save preference
            localStorage.setItem('selectedLevel', level);
        };

        // Initialize level from localStorage
        window.initLevel = function() {
            const savedLevel = localStorage.getItem('selectedLevel');
            if (savedLevel) {
                window.currentOeqLevel = savedLevel;
                window.currentMcqLevel = savedLevel;
                const headerSelect = document.getElementById('header-level-select');
                if (headerSelect) headerSelect.value = savedLevel;
                const mcqSelect = document.getElementById('mcq-level-select');
                if (mcqSelect) mcqSelect.value = savedLevel;
            }
        };

        window.mcqCurriculum = {
            'P3': ['Living and non-living things', 'Materials', 'Life Cycles', 'Magnets'],
            'P4': ['Plant Systems', 'Human Body Systems', 'Matter and its 3 States', 'Light', 'Heat'],
            'P5': ['Water and its 3 States', 'Plant Reproduction', 'Human Reproduction', 'Human and Plant Respiration', 'Human and Plant Transport', 'Electrical Systems'],
            'P6': ['Forces', 'Energy in Food', 'Energy Conversion', 'Living Together', 'Food Chains and Webs', 'Humans and the Environment']
        };

        window.typeColors = {
            'cer': '#AEC6CF',
            'definition': '#ADD8E6',
            'single-relationship': '#FFB7B2',
            'double-relationship': '#FFDAC1',
            'fairness': '#E2F0CB',
            'reliability': '#C7CEEA',
            'accuracy': '#FDFD96',
            'constant-variable': '#B5EAD7',
            'explanation': '#FF9AA2',
            'control-setup': '#E0BBE4',
            'admin': '#ffd1dc',
            'worksheet': '#e3f2fd',
            'saved-worksheets': '#e8f5e9',
            'practice': '#f3e5f5',
            'inbox': '#e1f5fe',
            'lessons': '#fff3e0',
            'lesson-detail': '#fff3e0',
            'flagged': '#fff3e0',
            'leaderboard': '#FFD700',
            'student-progress': '#e3f2fd',
            'my-progress': '#667eea',
            // MCQ level colors
            'mcq-P3': '#FFB3BA',
            'mcq-P4': '#BAFFC9',
            'mcq-P5': '#BAE1FF',
            'mcq-P6': '#FFFFBA'
        };

        // =====================================================
        // QUESTION COUNT PER TAB TYPE
        // =====================================================
        
        // Count questions in a specific tab type
        window.countQuestionsForType = function(tabType) {
            const viewContainer = document.getElementById(`view-${tabType}`);
            if (!viewContainer) return 0;
            
            // Count all question-container elements within this view
            const questions = viewContainer.querySelectorAll('.question-container');
            return questions.length;
        };

        // Get all OEQ tab types with their question counts
        window.getOeqTabsWithCounts = function() {
            const tabTypes = [
                { type: 'cer', name: 'CER' },
                { type: 'definition', name: 'Definition' },
                { type: 'single-relationship', name: 'Single Relationship' },
                { type: 'double-relationship', name: 'Double Relationship' },
                { type: 'fairness', name: 'Fairness' },
                { type: 'reliability', name: 'Reliability' },
                { type: 'accuracy', name: 'Accuracy' },
                { type: 'constant-variable', name: 'Constant Variable' },
                { type: 'explanation', name: 'Explanation' },
                { type: 'control-setup', name: 'Control Set-up' }
            ];
            
            return tabTypes.map(tab => ({
                ...tab,
                count: countQuestionsForType(tab.type)
            }));
        };

        // Render OEQ header tabs with question count badges
        window.renderOeqHeaderTabs = function(activeType = 'cer') {
            const container = document.getElementById('header-tabs-container');
            if (!container) return;
            
            const tabs = getOeqTabsWithCounts();
            
            container.innerHTML = tabs.map(tab => {
                const activeClass = tab.type === activeType ? 'active' : '';
                const countBadge = `<span class="tab-count-badge">${tab.count}</span>`;
                return `<button class="tab-btn ${activeClass}" data-type="${tab.type}" onclick="switchTab('${tab.type}', this)">${tab.name}${countBadge}</button>`;
            }).join('');
        };

        // Update tab counts (call after adding/removing questions)
        window.updateTabCounts = function() {
            // Only update if in OEQ mode
            if (window.currentMode !== 'mcq') {
                const activeTab = window.currentActiveTab || 'cer';
                renderOeqHeaderTabs(activeTab);
            }
        };

        // =====================================================
        // OEQ TOPICS BY TAB TYPE
        // =====================================================
        // Maps tab type to array of {name, id} objects
        window.oeqTopics = {
            'cer': [
                {name: 'Heat', id: 'heat'},
                {name: 'Light', id: 'light'},
                {name: 'Materials', id: 'materials'}
            ],
            'definition': [
                {name: 'Evaporation', id: 'def-evap'}
            ],
            'single-relationship': [
                {name: 'Forces', id: 'sr-forces'}
            ],
            'double-relationship': [],
            'fairness': [],
            'reliability': [],
            'accuracy': [],
            'constant-variable': [],
            'explanation': [],
            'control-setup': []
        };

        window.currentOeqTab = 'cer';
        window.currentOeqTopic = 'heat';

        // Update OEQ sidebar topics based on current tab
        window.updateOeqSidebar = function(tabType) {
            const nav = document.getElementById('oeq-topic-nav');
            const title = document.getElementById('oeq-title');
            if (!nav) return;

            const topics = window.oeqTopics[tabType] || [];
            const tabNames = {
                'cer': 'CER Questions',
                'definition': 'Definition',
                'single-relationship': 'Single Relationship',
                'double-relationship': 'Double Relationship',
                'fairness': 'Fairness',
                'reliability': 'Reliability',
                'accuracy': 'Accuracy',
                'constant-variable': 'Constant Variable',
                'explanation': 'Explanation',
                'control-setup': 'Control Set-up'
            };

            if (title) {
                title.textContent = tabNames[tabType] || 'OEQ Questions';
            }

            if (topics.length === 0) {
                nav.innerHTML = '<p style="color: #888; font-size: 0.9rem;">Coming Soon</p>';
                return;
            }

            nav.innerHTML = topics.map((topic, idx) => {
                const activeClass = idx === 0 ? 'active' : '';
                // Count questions for this specific topic
                const questionCount = countQuestionsForTopic(tabType, topic.id);
                const countBadge = `<span class="sidebar-topic-badge">${questionCount}</span>`;
                return `<button id="btn-${topic.id}" class="${activeClass}" onclick="selectOeqTopic('${tabType}', '${topic.id}', this)">${topic.name}${countBadge}</button>`;
            }).join('');

            // Select first topic by default
            if (topics.length > 0) {
                selectOeqTopic(tabType, topics[0].id, nav.querySelector('button'));
            }
        };

        // Count questions for a specific topic within a tab type
        window.countQuestionsForTopic = function(tabType, topicId) {
            const viewContainer = document.getElementById(`view-${tabType}`);
            if (!viewContainer) return 0;
            
            const topicContainer = viewContainer.querySelector(`#topic-${topicId}`);
            if (!topicContainer) return 0;
            
            return topicContainer.querySelectorAll('.question-container').length;
        };

        // Select an OEQ topic and show its content
        window.selectOeqTopic = function(tabType, topicId, btn) {
            window.currentOeqTopic = topicId;

            // Update button states
            const nav = document.getElementById('oeq-topic-nav');
            if (nav) {
                nav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                if (btn) btn.classList.add('active');
            }

            // Hide all topic contents within the current view
            const viewContainer = document.getElementById(`view-${tabType}`);
            if (viewContainer) {
                viewContainer.querySelectorAll('.topic-content').forEach(tc => {
                    tc.classList.add('hidden');
                });

                // Show the selected topic - try multiple ID patterns
                let targetTopic = viewContainer.querySelector(`#topic-${topicId}`);
                if (targetTopic) {
                    targetTopic.classList.remove('hidden');
                }
            }
        };

        // =====================================================
        // WORKSHEET FUNCTIONALITY - FIXED
        // =====================================================

        // Load worksheet from localStorage on page load
        function loadWorksheetFromStorage() {
            try {
                const stored = localStorage.getItem('worksheetItems');
                if (stored) {
                    window.worksheetItems = JSON.parse(stored);
                } else {
                    window.worksheetItems = [];
                }
            } catch (e) {
                console.error('Error loading worksheet:', e);
                window.worksheetItems = [];
            }
        }

        // Save worksheet to localStorage
        function saveWorksheetToStorage() {
            try {
                localStorage.setItem('worksheetItems', JSON.stringify(window.worksheetItems));
                // Track last save time
                localStorage.setItem('worksheetLastSaved', Date.now().toString());
            } catch (e) {
                console.error('Error saving worksheet:', e);
            }
        }

        // =====================================================
        // AUTO-SAVE FUNCTIONALITY
        // =====================================================

        /**
         * Auto-save worksheet progress
         * Saves every 60 seconds if there are changes
         */
        window.autoSaveInterval = null;
        window.lastSavedWorksheetHash = '';

        window.getWorksheetHash = function() {
            return JSON.stringify(window.worksheetItems || []);
        };

        window.startAutoSave = function() {
            // Don't start if already running
            if (window.autoSaveInterval) return;

            // Save initial hash
            window.lastSavedWorksheetHash = window.getWorksheetHash();

            // Auto-save every 60 seconds
            window.autoSaveInterval = setInterval(function() {
                const currentHash = window.getWorksheetHash();

                // Only save if there are changes
                if (currentHash !== window.lastSavedWorksheetHash && window.worksheetItems && window.worksheetItems.length > 0) {
                    saveWorksheetToStorage();
                    window.lastSavedWorksheetHash = currentHash;

                    // Show subtle notification
                    const indicator = document.createElement('div');
                    indicator.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        left: 20px;
                        background: rgba(40, 167, 69, 0.9);
                        color: white;
                        padding: 8px 16px;
                        border-radius: 8px;
                        font-size: 0.85rem;
                        z-index: 10000;
                        animation: fadeInOut 2s ease;
                    `;
                    indicator.innerHTML = ' Auto-saved';
                    document.body.appendChild(indicator);

                    setTimeout(() => indicator.remove(), 2000);
                }
            }, 60000); // 60 seconds

            console.log('Auto-save started');
        };

        window.stopAutoSave = function() {
            if (window.autoSaveInterval) {
                clearInterval(window.autoSaveInterval);
                window.autoSaveInterval = null;
                console.log('Auto-save stopped');
            }
        };

        // Add auto-save animation
        if (!document.getElementById('autosave-styles')) {
            const style = document.createElement('style');
            style.id = 'autosave-styles';
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translateY(10px); }
                    20% { opacity: 1; transform: translateY(0); }
                    80% { opacity: 1; transform: translateY(0); }
                    100% { opacity: 0; transform: translateY(-10px); }
                }
            `;
            document.head.appendChild(style);
        }

        // Start auto-save when document is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.startAutoSave);
        } else {
            window.startAutoSave();
        }

        // =====================================================
        // ENHANCED CONFIRMATION DIALOG
        // =====================================================

        /**
         * Show a custom confirmation dialog
         * @param {Object} options - Dialog options
         * @param {string} options.title - Dialog title
         * @param {string} options.message - Dialog message
         * @param {string} options.confirmText - Confirm button text (default: "Confirm")
         * @param {string} options.cancelText - Cancel button text (default: "Cancel")
         * @param {string} options.type - Type: 'danger', 'warning', 'info' (default: 'warning')
         * @returns {Promise<boolean>} - Resolves true if confirmed, false if cancelled
         */
        window.showConfirmDialog = function(options = {}) {
            return new Promise((resolve) => {
                const {
                    title = 'Confirm Action',
                    message = 'Are you sure you want to proceed?',
                    confirmText = 'Confirm',
                    cancelText = 'Cancel',
                    type = 'warning'
                } = options;

                const colors = {
                    danger: { bg: '#dc3545', icon: '' },
                    warning: { bg: '#ffc107', icon: '' },
                    info: { bg: '#17a2b8', icon: '' }
                };
                const color = colors[type] || colors.warning;

                const modal = document.createElement('div');
                modal.className = 'modal-overlay visible';
                modal.style.zIndex = '10006';
                modal.setAttribute('role', 'alertdialog');
                modal.setAttribute('aria-modal', 'true');
                modal.setAttribute('aria-labelledby', 'confirm-dialog-title');
                modal.innerHTML = `
                    <div class="modal-box" style="max-width: 400px; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">${color.icon}</div>
                        <h3 id="confirm-dialog-title" style="margin-bottom: 1rem; color: var(--main-text);">${window.sanitizeHTML(title)}</h3>
                        <p style="color: var(--light-text); margin-bottom: 1.5rem;">${window.sanitizeHTML(message)}</p>
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button class="confirm-cancel-btn" style="padding: 12px 24px; border: 2px solid var(--border-color); background: transparent; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--main-text); min-width: 100px;">
                                ${window.sanitizeHTML(cancelText)}
                            </button>
                            <button class="confirm-ok-btn" style="padding: 12px 24px; border: none; background: ${color.bg}; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; min-width: 100px;">
                                ${window.sanitizeHTML(confirmText)}
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Focus the cancel button by default (safer)
                const cancelBtn = modal.querySelector('.confirm-cancel-btn');
                const confirmBtn = modal.querySelector('.confirm-ok-btn');
                cancelBtn.focus();

                // Handle cancel
                cancelBtn.addEventListener('click', () => {
                    modal.remove();
                    resolve(false);
                });

                // Handle confirm
                confirmBtn.addEventListener('click', () => {
                    modal.remove();
                    resolve(true);
                });

                // Handle backdrop click (cancel)
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                });

                // Handle Escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        resolve(false);
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            });
        };

        // =====================================================
        // IMAGE LAZY LOADING
        // =====================================================

        /**
         * Initialize lazy loading for images
         * Uses native loading="lazy" with IntersectionObserver fallback
         */
        window.initLazyLoading = function() {
            // Add loading="lazy" to all images without it
            document.querySelectorAll('img:not([loading])').forEach(img => {
                img.setAttribute('loading', 'lazy');
            });

            // For browsers that don't support native lazy loading, use IntersectionObserver
            if (!('loading' in HTMLImageElement.prototype)) {
                const lazyImages = document.querySelectorAll('img[loading="lazy"]');

                if ('IntersectionObserver' in window) {
                    const imageObserver = new IntersectionObserver((entries, observer) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                if (img.dataset.src) {
                                    img.src = img.dataset.src;
                                    img.removeAttribute('data-src');
                                }
                                observer.unobserve(img);
                            }
                        });
                    }, {
                        rootMargin: '50px 0px',
                        threshold: 0.01
                    });

                    lazyImages.forEach(img => {
                        // Store original src in data-src for lazy loading
                        if (img.src && !img.dataset.src) {
                            img.dataset.src = img.src;
                            img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1"%3E%3C/svg%3E';
                        }
                        imageObserver.observe(img);
                    });
                }
            }

            console.log('Lazy loading initialized');
        };

        // Initialize lazy loading when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.initLazyLoading);
        } else {
            window.initLazyLoading();
        }

        /**
         * Shuffle array randomly (Fisher-Yates algorithm)
         * @param {Array} array - Array to shuffle
         * @returns {Array} - Shuffled array
         */
        window.shuffleArray = function(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        };

        /**
         * Shuffle questions in worksheet
         */
        window.shuffleWorksheetQuestions = function() {
            if (!window.worksheetItems || window.worksheetItems.length < 2) {
                window.showToast('Need at least 2 questions to shuffle', 'warning');
                return;
            }

            window.worksheetItems = window.shuffleArray(window.worksheetItems);
            saveWorksheetToStorage();
            updateWorksheetUI();
            window.showToast('Questions shuffled!', 'success');
        };

        // =====================================================
        // STUDY TIMER & SESSION STATISTICS
        // =====================================================

        window.studyTimer = {
            startTime: null,
            elapsed: 0,
            interval: null,
            isRunning: false
        };

        window.sessionStats = {
            questionsViewed: 0,
            questionsAnswered: 0,
            correctAnswers: 0,
            incorrectAnswers: 0,
            startTime: Date.now()
        };

        /**
         * Start the study timer
         */
        window.startStudyTimer = function() {
            if (window.studyTimer.isRunning) return;

            window.studyTimer.startTime = Date.now() - window.studyTimer.elapsed;
            window.studyTimer.isRunning = true;

            window.studyTimer.interval = setInterval(() => {
                window.studyTimer.elapsed = Date.now() - window.studyTimer.startTime;
            }, 1000);
        };

        /**
         * Format time in MM:SS or HH:MM:SS
         */
        window.formatStudyTime = function(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        };

        /**
         * Track an answer submission
         */
        window.trackAnswer = function(isCorrect) {
            window.sessionStats.questionsAnswered++;
            if (isCorrect) {
                window.sessionStats.correctAnswers++;
            } else {
                window.sessionStats.incorrectAnswers++;
            }
        };

        /**
         * Get session accuracy percentage
         */
        window.getSessionAccuracy = function() {
            if (window.sessionStats.questionsAnswered === 0) return 0;
            return Math.round((window.sessionStats.correctAnswers / window.sessionStats.questionsAnswered) * 100);
        };

        /**
         * Show session statistics modal
         */
        window.showSessionStats = function() {
            const duration = window.studyTimer.elapsed;
            const accuracy = window.getSessionAccuracy();

            const modal = document.createElement('div');
            modal.className = 'modal-overlay visible';
            modal.style.zIndex = '10005';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            modal.innerHTML = `
                <div class="modal-box" style="max-width: 450px;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-blue); display: flex; align-items: center; gap: 10px;">
                         Session Statistics
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 1.5rem;">
                        <div style="background: var(--blue-light); padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-blue);">${window.formatStudyTime(duration)}</div>
                            <div style="color: var(--light-text); font-size: 0.9rem;">Study Time</div>
                        </div>
                        <div style="background: var(--teal); padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #2e7d32;">${window.sessionStats.questionsAnswered}</div>
                            <div style="color: var(--light-text); font-size: 0.9rem;">Questions Answered</div>
                        </div>
                        <div style="background: #e8f5e9; padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--correct-color);">${window.sessionStats.correctAnswers}</div>
                            <div style="color: var(--light-text); font-size: 0.9rem;">Correct</div>
                        </div>
                        <div style="background: #ffebee; padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--incorrect-color);">${window.sessionStats.incorrectAnswers}</div>
                            <div style="color: var(--light-text); font-size: 0.9rem;">Incorrect</div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; border-radius: 12px; text-align: center; color: white; margin-bottom: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: 700;">${accuracy}%</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Session Accuracy</div>
                    </div>
                    <div style="text-align: center;">
                        <button onclick="this.closest('.modal-overlay').remove()" class="btn" style="background: var(--primary-blue); color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            Continue Studying
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        };

        // Start study timer on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.startStudyTimer);
        } else {
            window.startStudyTimer();
        }

        // Toggle question in/out of worksheet
        window.toggleWorksheetItem = function (btn) {
            const container = btn.closest('.question-container');
            if (!container) {
                alert("Could not find question container.");
                return;
            }

            // Get or create a unique ID for this question
            let qId = container.id;
            if (!qId) {
                qId = 'q-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                container.id = qId;
            }

            const existingIndex = window.worksheetItems.findIndex(item => item.id === qId);

            if (existingIndex > -1) {
                // Remove from worksheet
                window.worksheetItems.splice(existingIndex, 1);
                btn.innerHTML = ' Worksheet';
                btn.classList.remove('added');
            } else {
                // Add to worksheet - capture the full question content
                const questionTitle = container.querySelector('h3')?.textContent || 'Question';

                // Clone the container to capture its content
                const clone = container.cloneNode(true);

                // Remove UI elements from the clone
                clone.querySelectorAll('.admin-controls, .worksheet-control-bar, .controls, .feedback-icon').forEach(el => el.remove());

                // Reset any input states in the clone
                clone.querySelectorAll('.answer-input').forEach(input => {
                    input.disabled = false;
                    input.value = '';
                    input.style.borderBottomColor = '';
                });

                // Get the cleaned HTML
                const cleanedHtml = clone.innerHTML;

                window.worksheetItems.push({
                    id: qId,
                    title: questionTitle,
                    html: cleanedHtml,
                    addedAt: new Date().toISOString()
                });

                btn.innerHTML = ' Added';
                btn.classList.add('added');
            }

            saveWorksheetToStorage();
            updateWorksheetUI();
        };

        // Update worksheet display
        window.updateWorksheetUI = function () {
            const countBadge = document.getElementById('worksheet-count');
            const container = document.getElementById('worksheet-questions-container');
            const emptyMsg = document.getElementById('worksheet-empty-msg');

            if (!container) return;

            const count = window.worksheetItems.length;

            // Update badge count
            if (countBadge) {
                countBadge.textContent = count;
            }
            // Update header badge
            updateWorksheetCountHeader();

            // Clear existing question cards (keep empty message)
            const existingCards = container.querySelectorAll('.worksheet-question-card');
            existingCards.forEach(card => card.remove());

            if (count === 0) {
                if (emptyMsg) emptyMsg.style.display = 'block';
            } else {
                if (emptyMsg) emptyMsg.style.display = 'none';

                // Render each worksheet item
                window.worksheetItems.forEach((item, idx) => {
                    const card = document.createElement('div');
                    card.className = 'worksheet-question-card';
                    card.setAttribute('data-worksheet-id', item.id);

                    card.innerHTML = `
                        <span class="question-number">Question ${idx + 1}</span>
                        <div class="remove-btn-wrapper">
                            <button class="btn-worksheet-remove" onclick="removeFromWorksheet('${item.id}')"> Remove</button>
                        </div>
                        <div class="worksheet-question-content" style="margin-top: 1rem;">
                            ${item.html}
                        </div>
                    `;

                    container.appendChild(card);
                });
            }

            // Update all add/remove buttons in main content
            syncWorksheetButtons();
        };

        // Sync worksheet buttons with current state
        function syncWorksheetButtons() {
            document.querySelectorAll('.question-container').forEach(container => {
                const qId = container.id;
                const btn = container.querySelector('.btn-worksheet-add');
                if (btn && qId) {
                    const isInWorksheet = window.worksheetItems.some(item => item.id === qId);
                    if (isInWorksheet) {
                        btn.innerHTML = ' Added';
                        btn.classList.add('added');
                    } else {
                        btn.innerHTML = ' Worksheet';
                        btn.classList.remove('added');
                    }
                }
            });
        }

        // Remove question from worksheet
        window.removeFromWorksheet = function (qId) {
            window.worksheetItems = window.worksheetItems.filter(item => item.id !== qId);
            saveWorksheetToStorage();
            updateWorksheetUI();
        };

        // Clear all worksheet items
        window.clearWorksheet = function () {
            if (!confirm("Are you sure you want to clear all questions from your worksheet?")) return;
            window.worksheetItems = [];
            saveWorksheetToStorage();
            updateWorksheetUI();
        };

        // Quick Generate Worksheet - generates 30 questions prioritizing unanswered and ELO-matched questions
        window.quickGenerateWorksheet = async function() {
            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) {
                    alert("Please log in to use Quick Generate.");
                    return;
                }

                // Show loading message
                const loadingMsg = document.createElement('div');
                loadingMsg.id = 'quick-generate-loading';
                loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
                loadingMsg.innerHTML = '<div style="font-size: 1.2rem; margin-bottom: 1rem;"> Generating worksheet...</div><div style="color: #666;">Loading questions and student data...</div>';
                document.body.appendChild(loadingMsg);

                // Get student data and answered questions
                let studentIndex = 0;
                let studentRating = RATING_CONFIG.DEFAULT_STUDENT_RATING;
                let answeredQuestions = new Set();

                // Try to get current student from practice state, otherwise use first student
                if (window.practiceState?.currentStudent) {
                    studentIndex = window.practiceState.currentStudent.index;
                } else {
                    // Load user data to get first student
                    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                    const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        const students = data.students || [];
                        if (students.length > 0 && students[0].rating !== undefined) {
                            studentRating = students[0].rating;
                        }
                    }
                }

                // Get student rating
                if (window.getStudentRating) {
                    const ratingData = await window.getStudentRating(studentIndex);
                    studentRating = ratingData.rating || RATING_CONFIG.DEFAULT_STUDENT_RATING;
                }

                // Load answered questions
                const answeredKey = `answered_${user.uid}_${studentIndex}`;
                const answeredStored = localStorage.getItem(answeredKey);
                if (answeredStored) {
                    answeredQuestions = new Set(JSON.parse(answeredStored));
                }

                // Load question ratings
                if (window.loadQuestionRatings) {
                    await window.loadQuestionRatings();
                }

                loadingMsg.innerHTML = '<div style="font-size: 1.2rem; margin-bottom: 1rem;"> Generating worksheet...</div><div style="color: #666;">Fetching questions from database...</div>';

                // Get all questions from Firestore
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const questionsRef = collection(window.db_fs, "custom_questions");
                const snapshot = await getDocs(questionsRef);

                const allQuestions = [];
                const firestoreQuestionIds = new Set();
                
                // First, add questions from Firestore
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const qId = `q-${doc.id}`;
                    firestoreQuestionIds.add(qId);
                    
                    // Check if question is already in worksheet
                    const isInWorksheet = window.worksheetItems.some(item => item.id === qId);
                    
                    // Check if question has been answered
                    const isAnswered = answeredQuestions.has(qId);
                    
                    // Get question rating
                    const qRatingData = window.getQuestionRating ? window.getQuestionRating(qId) : { rating: RATING_CONFIG.DEFAULT_QUESTION_RATING };
                    const questionRating = qRatingData.rating || RATING_CONFIG.DEFAULT_QUESTION_RATING;
                    
                    // Calculate if in growth zone
                    let inGrowthZone = false;
                    if (window.isInGrowthZone) {
                        inGrowthZone = window.isInGrowthZone(studentRating, questionRating);
                    }
                    
                    // Calculate expected success rate
                    let expectedSuccess = 0.5;
                    if (window.calculateExpectedSuccess) {
                        expectedSuccess = window.calculateExpectedSuccess(studentRating, questionRating);
                    }
                    
                    allQuestions.push({
                        id: qId,
                        firestoreId: doc.id,
                        title: data.title || 'Question',
                        html: data.html || '',
                        topic: data.topic || 'general',
                        category: data.category || 'mcq',
                        level: data.level || 'P6',
                        isAnswered: isAnswered,
                        questionRating: questionRating,
                        inGrowthZone: inGrowthZone,
                        expectedSuccess: expectedSuccess,
                        isInWorksheet: isInWorksheet,
                        fromFirestore: true
                    });
                });

                // Also gather questions from DOM that aren't in Firestore (hardcoded questions)
                const domQuestions = document.querySelectorAll('.question-container[id]');
                domQuestions.forEach(container => {
                    const qId = container.id;
                    // Skip if already in Firestore questions or doesn't have a valid ID
                    if (!qId || firestoreQuestionIds.has(qId) || qId.startsWith('q-custom-')) {
                        return;
                    }
                    
                    // Check if question is already in worksheet
                    const isInWorksheet = window.worksheetItems.some(item => item.id === qId);
                    
                    // Check if question has been answered
                    const isAnswered = answeredQuestions.has(qId);
                    
                    // Get question rating
                    const qRatingData = window.getQuestionRating ? window.getQuestionRating(qId) : { rating: RATING_CONFIG.DEFAULT_QUESTION_RATING };
                    const questionRating = qRatingData.rating || RATING_CONFIG.DEFAULT_QUESTION_RATING;
                    
                    // Calculate if in growth zone
                    let inGrowthZone = false;
                    if (window.isInGrowthZone) {
                        inGrowthZone = window.isInGrowthZone(studentRating, questionRating);
                    }
                    
                    // Calculate expected success rate
                    let expectedSuccess = 0.5;
                    if (window.calculateExpectedSuccess) {
                        expectedSuccess = window.calculateExpectedSuccess(studentRating, questionRating);
                    }
                    
                    // Get question title
                    const questionTitle = container.querySelector('h3')?.textContent || 'Question';
                    
                    allQuestions.push({
                        id: qId,
                        firestoreId: null,
                        title: questionTitle,
                        html: container.innerHTML,
                        topic: 'general',
                        category: 'mcq',
                        level: 'P6',
                        isAnswered: isAnswered,
                        questionRating: questionRating,
                        inGrowthZone: inGrowthZone,
                        expectedSuccess: expectedSuccess,
                        isInWorksheet: isInWorksheet,
                        fromFirestore: false,
                        domElement: container
                    });
                });

                loadingMsg.innerHTML = '<div style="font-size: 1.2rem; margin-bottom: 1rem;"> Generating worksheet...</div><div style="color: #666;">Selecting best questions for you...</div>';

                // Sort questions by priority:
                // 1. Not in worksheet already
                // 2. Not answered (unanswered first)
                // 3. In growth zone (ELO-matched)
                // 4. Closest to optimal challenge (55% expected success)
                const sortedQuestions = allQuestions
                    .filter(q => !q.isInWorksheet) // Exclude questions already in worksheet
                    .sort((a, b) => {
                        // Priority 1: Unanswered questions first
                        if (a.isAnswered !== b.isAnswered) {
                            return a.isAnswered ? 1 : -1;
                        }
                        
                        // Priority 2: Growth zone questions
                        if (a.inGrowthZone !== b.inGrowthZone) {
                            return a.inGrowthZone ? -1 : 1;
                        }
                        
                        // Priority 3: Closest to optimal challenge (55% expected success)
                        const optimalExpected = 0.55;
                        const aDiff = Math.abs(a.expectedSuccess - optimalExpected);
                        const bDiff = Math.abs(b.expectedSuccess - optimalExpected);
                        return aDiff - bDiff;
                    });

                // Select top 30 questions
                const selectedQuestions = sortedQuestions.slice(0, 30);

                if (selectedQuestions.length === 0) {
                    loadingMsg.remove();
                    alert("No new questions available to add. All questions are either already in your worksheet or you've completed them all!");
                    return;
                }

                loadingMsg.innerHTML = '<div style="font-size: 1.2rem; margin-bottom: 1rem;"> Generating worksheet...</div><div style="color: #666;">Adding questions to worksheet...</div>';

                // Add questions to worksheet
                // First, clear existing worksheet if user wants
                if (window.worksheetItems.length > 0) {
                    if (!confirm(`You currently have ${window.worksheetItems.length} questions in your worksheet. Quick Generate will add ${selectedQuestions.length} new questions. Continue?`)) {
                        loadingMsg.remove();
                        return;
                    }
                }

                // Add each question to worksheet
                for (const question of selectedQuestions) {
                    // Check if question container exists in DOM
                    const questionContainer = document.getElementById(question.id);
                    
                    if (questionContainer) {
                        // Question exists in DOM, use existing toggleWorksheetItem logic
                        const btn = questionContainer.querySelector('.btn-worksheet-add');
                        if (btn && !window.worksheetItems.some(item => item.id === question.id)) {
                            // Simulate adding to worksheet
                            const questionTitle = questionContainer.querySelector('h3')?.textContent || question.title;
                            
                            // Clone the container to capture its content
                            const clone = questionContainer.cloneNode(true);
                            
                            // Remove UI elements from the clone
                            clone.querySelectorAll('.admin-controls, .worksheet-control-bar, .controls, .feedback-icon').forEach(el => el.remove());
                            
                            // Reset any input states in the clone
                            clone.querySelectorAll('.answer-input').forEach(input => {
                                input.disabled = false;
                                input.value = '';
                                input.style.borderBottomColor = '';
                            });
                            
                            // Get the cleaned HTML
                            const cleanedHtml = clone.innerHTML;
                            
                            window.worksheetItems.push({
                                id: question.id,
                                title: questionTitle,
                                html: cleanedHtml,
                                addedAt: new Date().toISOString()
                            });
                            
                            // Update button state
                            if (btn) {
                                btn.innerHTML = ' Added';
                                btn.classList.add('added');
                            }
                        }
                    } else {
                        // Question not in DOM, create worksheet item from stored data
                        if (!window.worksheetItems.some(item => item.id === question.id)) {
                            // Process HTML similar to how it's done in loadCustomQuestions
                            let processedHtml = question.html;
                            
                            // Fix Dropbox image URLs
                            processedHtml = processedHtml.replace(/src="(https:\/\/www\.dropbox\.com\/scl\/[^"]+)"/g, (match, url) => {
                                let fixedUrl = url.replace(/[?&]dl=[01]/, '&raw=1');
                                if (!fixedUrl.includes('raw=1')) {
                                    fixedUrl += (fixedUrl.includes('?') ? '&' : '?') + 'raw=1';
                                }
                                return `src="${fixedUrl}"`;
                            });
                            
                            // Remove controls/buttons from HTML
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = processedHtml;
                            tempDiv.querySelectorAll('.controls, .admin-controls, .worksheet-control-bar, .feedback-icon').forEach(el => el.remove());
                            tempDiv.querySelectorAll('button.submit-btn, button.next-btn, button.print-btn, button.btn-primary').forEach(el => el.remove());
                            tempDiv.querySelectorAll('.explanation-box').forEach(el => {
                                el.style.display = 'none';
                            });
                            tempDiv.querySelectorAll('.video-container').forEach(el => {
                                el.style.display = 'none';
                                el.classList.add('hidden-until-answered');
                            });
                            processedHtml = tempDiv.innerHTML;
                            
                            window.worksheetItems.push({
                                id: question.id,
                                title: question.title,
                                html: processedHtml,
                                addedAt: new Date().toISOString()
                            });
                        }
                    }
                }

                // Save and update UI
                saveWorksheetToStorage();
                updateWorksheetUI();

                loadingMsg.remove();
                
                const unansweredCount = selectedQuestions.filter(q => !q.isAnswered).length;
                const growthZoneCount = selectedQuestions.filter(q => q.inGrowthZone).length;
                
                alert(` Worksheet generated successfully!\n\nAdded ${selectedQuestions.length} questions:\n- ${unansweredCount} new questions (not yet attempted)\n- ${growthZoneCount} questions matched to your skill level`);
                
            } catch (e) {
                console.error("Error generating worksheet:", e);
                const loadingMsg = document.getElementById('quick-generate-loading');
                if (loadingMsg) loadingMsg.remove();
                alert("Error generating worksheet: " + e.message);
            }
        };

        // Helper function to get topic and rating for a question
        async function getQuestionInfo(questionId) {
            let topic = 'General';
            let rating = RATING_CONFIG.DEFAULT_QUESTION_RATING;
            
            // Try to find the question in the DOM
            const questionElement = document.getElementById(questionId);
            if (questionElement) {
                // Try to find topic from parent containers
                const mcqParent = questionElement.closest('[id^="topic-mcq-"]');
                if (mcqParent) {
                    const topicId = mcqParent.id.replace('topic-mcq-', '');
                    // Find which level this topic belongs to
                    if (window.mcqCurriculum) {
                        for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                            const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                            if (matchingTopic) {
                                topic = matchingTopic;
                                break;
                            }
                        }
                    }
                } else {
                    // Check for OEQ topic container
                    const topicParent = questionElement.closest('[id^="topic-"]');
                    if (topicParent) {
                        const topicId = topicParent.id.replace('topic-', '');
                        // Remove view prefix if present
                        const cleanTopicId = topicId.replace(/^(mcq|oeq|cer)-/, '');
                        topic = cleanTopicId.charAt(0).toUpperCase() + cleanTopicId.slice(1).replace(/-/g, ' ');
                    }
                }
                
                // Get rating
                if (window.getQuestionRating) {
                    const ratingData = window.getQuestionRating(questionId);
                    rating = ratingData.rating || RATING_CONFIG.DEFAULT_QUESTION_RATING;
                }
            } else {
                // Question not in DOM - might be from Firestore
                // Check if it's a custom question (starts with q-)
                if (questionId.startsWith('q-')) {
                    const firestoreId = questionId.replace('q-', '');
                    try {
                        // Try to get topic from Firestore
                        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                        const questionDoc = await getDoc(doc(window.db_fs, "custom_questions", firestoreId));
                        if (questionDoc.exists()) {
                            const data = questionDoc.data();
                            topic = data.topic || 'General';
                        }
                    } catch (e) {
                        console.warn("Could not fetch question topic from Firestore:", e);
                    }
                }
                
                // Get rating
                if (window.getQuestionRating) {
                    const ratingData = window.getQuestionRating(questionId);
                    rating = ratingData.rating || RATING_CONFIG.DEFAULT_QUESTION_RATING;
                }
            }
            
            return { topic, rating };
        }

        // Export worksheet as PDF
        window.exportWorksheet = async function () {
            if (window.worksheetItems.length === 0) {
                alert("Your worksheet is empty! Add some questions first.");
                return;
            }

            // Load question ratings if not already loaded
            if (window.loadQuestionRatings && !window.questionRatings || Object.keys(window.questionRatings || {}).length === 0) {
                await window.loadQuestionRatings();
            }

            // Create summary table page
            const summaryContainer = document.createElement('div');
            summaryContainer.id = 'worksheet-summary-page';
            summaryContainer.style.cssText = 'page-break-after: always; padding: 2rem; background: white;';
            
            // Create summary table
            let summaryTableHTML = `
                <div style="margin-bottom: 2rem;">
                    <h2 style="text-align: center; margin-bottom: 1.5rem; color: #333;">Worksheet Summary</h2>
                    <table style="width: 100%; border-collapse: collapse; border: 2px solid #333; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="border: 1px solid #333; padding: 12px; text-align: center; font-weight: bold; width: 10%;">Question #</th>
                                <th style="border: 1px solid #333; padding: 12px; text-align: center; font-weight: bold; width: 20%;">Rating</th>
                                <th style="border: 1px solid #333; padding: 12px; text-align: left; font-weight: bold; width: 40%;">Topic</th>
                                <th style="border: 1px solid #333; padding: 12px; text-align: center; font-weight: bold; width: 30%;">Marks</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add rows for each question (await all async calls)
            const questionInfos = await Promise.all(
                window.worksheetItems.map(item => getQuestionInfo(item.id))
            );
            
            questionInfos.forEach((questionInfo, idx) => {
                const questionNum = idx + 1;
                const topic = questionInfo.topic;
                const rating = questionInfo.rating;
                
                summaryTableHTML += `
                    <tr>
                        <td style="border: 1px solid #333; padding: 10px; text-align: center; font-weight: 600;">${questionNum}</td>
                        <td style="border: 1px solid #333; padding: 10px; text-align: center;">${rating}</td>
                        <td style="border: 1px solid #333; padding: 10px; text-align: left;">${topic}</td>
                        <td style="border: 1px solid #333; padding: 10px; text-align: center;">_____</td>
                    </tr>
                `;
            });
            
            // Add total row
            const totalRating = questionInfos.reduce((sum, info) => sum + info.rating, 0);
            const avgRating = Math.round(totalRating / window.worksheetItems.length);
            
            summaryTableHTML += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #f9f9f9; font-weight: bold;">
                                <td style="border: 1px solid #333; padding: 12px; text-align: center;" colspan="2">Total Questions: ${window.worksheetItems.length}</td>
                                <td style="border: 1px solid #333; padding: 12px; text-align: center;" colspan="2">Average Rating: ${avgRating}</td>
                            </tr>
                            <tr style="background: #f9f9f9;">
                                <td style="border: 1px solid #333; padding: 12px; text-align: center; font-weight: bold;" colspan="4">Total Marks: ________ / ________</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            summaryContainer.innerHTML = summaryTableHTML;
            
            // Insert summary page at the beginning of the worksheet view
            const worksheetView = document.getElementById('view-worksheet');
            if (worksheetView) {
                // Insert after the header but before questions container
                const worksheetContainer = document.getElementById('worksheet-questions-container');
                if (worksheetContainer && worksheetContainer.parentNode) {
                    worksheetContainer.parentNode.insertBefore(summaryContainer, worksheetContainer);
                } else {
                    // Fallback: insert at the beginning of worksheet view
                    const firstChild = worksheetView.firstElementChild;
                    if (firstChild) {
                        worksheetView.insertBefore(summaryContainer, firstChild);
                    } else {
                        worksheetView.appendChild(summaryContainer);
                    }
                }
            }

            // Add print class to body
            document.body.classList.add('print-worksheet');

            // Show worksheet header
            const header = document.getElementById('worksheet-header');
            if (header) header.style.display = 'block';

            // Trigger print
            window.print();

            // Clean up after print
            setTimeout(() => {
                document.body.classList.remove('print-worksheet');
                if (header) header.style.display = 'none';
                // Remove summary page
                if (summaryContainer && summaryContainer.parentNode) {
                    summaryContainer.parentNode.removeChild(summaryContainer);
                }
            }, 100);
        };

        // =====================================================
        // WORKSHEET SAVE/LOAD SYSTEM
        // =====================================================

        window.showSaveWorksheetModal = function() {
            if (window.worksheetItems.length === 0) {
                alert("Your worksheet is empty! Add some questions first.");
                return;
            }

            const modal = document.getElementById('save-worksheet-modal');
            const adminFields = document.getElementById('admin-lesson-fields');
            const title = document.getElementById('save-worksheet-modal-title');
            
            // Show admin fields if admin user
            if (window.isAdminUser) {
                adminFields.classList.remove('hidden');
                title.textContent = ' Save Worksheet / Create Lesson';
            } else {
                adminFields.classList.add('hidden');
                title.textContent = ' Save Worksheet';
            }
            
            // Clear previous inputs
            document.getElementById('worksheet-name-input').value = '';
            document.getElementById('worksheet-description-input').value = '';
            document.getElementById('lesson-video-input').value = '';
            document.getElementById('share-as-lesson-checkbox').checked = false;
            
            modal.classList.add('visible');
            document.getElementById('worksheet-name-input').focus();
            
            // Close when clicking outside modal box
            modal.onclick = function(e) {
                if (e.target === modal) {
                    hideSaveWorksheetModal();
                }
            };
        };

        window.hideSaveWorksheetModal = function() {
            document.getElementById('save-worksheet-modal').classList.remove('visible');
        };

        window.saveWorksheet = async function() {
            const name = document.getElementById('worksheet-name-input').value.trim();
            const description = document.getElementById('worksheet-description-input').value.trim();
            
            if (!name) {
                alert("Please enter a name for your worksheet.");
                document.getElementById('worksheet-name-input').focus();
                return;
            }
            
            const isAdmin = window.isAdminUser;
            const shareAsLesson = isAdmin && document.getElementById('share-as-lesson-checkbox').checked;
            const videoUrl = document.getElementById('lesson-video-input').value.trim();
            
            if (shareAsLesson && !videoUrl) {
                alert("Please provide a video link for the lesson.");
                document.getElementById('lesson-video-input').focus();
                return;
            }
            
            try {
                const { doc, setDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const worksheetId = 'ws_' + Date.now();
                const user = window.auth.currentUser;
                
                // Prepare question data (store question IDs and HTML)
                const questionsData = window.worksheetItems.map(item => ({
                    id: item.id,
                    title: item.title,
                    html: item.html
                }));
                
                if (shareAsLesson) {
                    // Save as shared lesson (visible to all)
                    const lessonData = {
                        name: name,
                        description: description,
                        videoUrl: convertYoutubeUrl(videoUrl),
                        questions: questionsData,
                        questionCount: questionsData.length,
                        createdBy: user.email,
                        createdAt: new Date().toISOString(),
                        type: 'lesson'
                    };
                    
                    await setDoc(doc(window.db_fs, "shared_lessons", worksheetId), lessonData);
                    alert("Lesson created and shared with all students! ");
                } else {
                    // Save as personal worksheet
                    const worksheetData = {
                        name: name,
                        description: description,
                        questions: questionsData,
                        questionCount: questionsData.length,
                        userId: user.uid,
                        userEmail: user.email,
                        createdAt: new Date().toISOString(),
                        type: 'worksheet'
                    };
                    
                    await setDoc(doc(window.db_fs, "user_worksheets", worksheetId), worksheetData);
                    alert("Worksheet saved successfully! ");
                }
                
                hideSaveWorksheetModal();
                
                // Optionally clear the current worksheet
                if (confirm("Would you like to clear your current worksheet?")) {
                    window.worksheetItems = [];
                    saveWorksheetToStorage();
                    updateWorksheetUI();
                }
                
            } catch (e) {
                console.error("Save worksheet error:", e);
                window.showToast("Failed to save worksheet. Please try again.", "error");
            }
        };

        // Convert YouTube URL to embed format
        window.convertYoutubeUrl = function(url) {
            if (!url) return url;
            if (url.includes('youtube.com/watch?v=')) {
                return url.replace('watch?v=', 'embed/');
            } else if (url.includes('youtu.be/')) {
                return url.replace('youtu.be/', 'youtube.com/embed/');
            }
            return url;
        };

        // Load user's saved worksheets
        window.loadSavedWorksheets = async function() {
            const container = document.getElementById('saved-worksheets-container');
            const emptyMsg = document.getElementById('saved-worksheets-empty-msg');
            
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const user = window.auth.currentUser;
                if (!user) return;
                
                // Fetch all worksheets and filter client-side
                const snapshot = await getDocs(collection(window.db_fs, "user_worksheets"));
                
                const worksheets = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId === user.uid) {
                        worksheets.push({ id: doc.id, ...data });
                    }
                });
                
                if (worksheets.length === 0) {
                    container.innerHTML = '';
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'inbox-empty';
                    emptyDiv.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <p>No saved worksheets yet</p>
                    `;
                    container.appendChild(emptyDiv);
                    return;
                }
                
                container.innerHTML = '';
                
                // Sort by date descending
                worksheets.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                worksheets.forEach(ws => {
                    const date = new Date(ws.createdAt).toLocaleDateString();
                    const card = document.createElement('div');
                    card.className = 'saved-worksheet-card';
                    card.innerHTML = `
                        <h4> ${ws.name}</h4>
                        <div class="meta">${ws.questionCount} questions  Saved on ${date}</div>
                        ${ws.description ? `<p style="color: #666; margin-bottom: 1rem;">${ws.description}</p>` : ''}
                        <div class="actions" style="flex-wrap: wrap;">
                            <button class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;" onclick="attemptWorksheet('${ws.id}')"> Attempt</button>
                            <button class="btn" style="background: #1976d2; color: white;" onclick="loadWorksheetToActive('${ws.id}')"> Load</button>
                            <button class="btn" style="background: #28a745; color: white;" onclick="viewSavedWorksheet('${ws.id}')"> View</button>
                            <button class="btn" style="background: #dc3545; color: white;" onclick="deleteSavedWorksheet('${ws.id}')"> Delete</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
                
            } catch (e) {
                console.error("Load worksheets error:", e);
                container.innerHTML = '<p style="color: #dc3545;">Error loading worksheets. Please try again.</p>';
            }
        };

        window.refreshSavedWorksheets = function() {
            loadSavedWorksheets();
        };

        // Load a saved worksheet into the active worksheet
        window.loadWorksheetToActive = async function(worksheetId) {
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const docRef = doc(window.db_fs, "user_worksheets", worksheetId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert("Worksheet not found.");
                    return;
                }
                
                const data = docSnap.data();
                
                if (window.worksheetItems.length > 0) {
                    if (!confirm(`This will replace your current worksheet (${window.worksheetItems.length} items). Continue?`)) {
                        return;
                    }
                }
                
                window.worksheetItems = data.questions.map(q => ({
                    id: q.id,
                    title: q.title,
                    html: q.html
                }));
                
                saveWorksheetToStorage();
                updateWorksheetUI();
                
                window.showToast(`Loaded "${window.sanitizeHTML(data.name)}" with ${data.questions.length} questions!`, "success");
                switchTab('worksheet');

            } catch (e) {
                console.error("Load worksheet error:", e);
                window.showToast("Failed to load worksheet. Please try again.", "error");
            }
        };

        // View a saved worksheet (read-only)
        window.viewSavedWorksheet = async function(worksheetId) {
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const docRef = doc(window.db_fs, "user_worksheets", worksheetId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert("Worksheet not found.");
                    return;
                }
                
                const data = docSnap.data();
                
                // Open in new window for viewing/printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${data.name}</title>
                        <style>
                            body { font-family: 'Segoe UI', sans-serif; padding: 2rem; max-width: 900px; margin: 0 auto; }
                            h1 { color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 10px; }
                            .question { background: #f5f5f5; padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid #1976d2; }
                            .question h3 { margin-top: 0; color: #333; }
                            .header-info { display: flex; justify-content: space-between; margin-bottom: 2rem; }
                            .answer-input { border: none; border-bottom: 2px solid #333; background: transparent; min-width: 100px; }
                            @media print { button { display: none; } }
                        </style>
                    </head>
                    <body>
                        <h1> ${data.name}</h1>
                        <div class="header-info">
                            <span>Name: _______________________</span>
                            <span>Date: _______________</span>
                            <span>Score: _____ / ${data.questionCount}</span>
                        </div>
                        ${data.questions.map((q, i) => `
                            <div class="question">
                                <h3>Question ${i + 1}: ${q.title}</h3>
                                <div>${q.html}</div>
                            </div>
                        `).join('')}
                        <button onclick="window.print()" style="margin-top: 2rem; padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer;"> Print</button>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
            } catch (e) {
                console.error("View worksheet error:", e);
                alert("Error viewing worksheet: " + e.message);
            }
        };

        // Delete a saved worksheet
        window.deleteSavedWorksheet = async function(worksheetId) {
            if (!confirm("Are you sure you want to delete this worksheet? This cannot be undone.")) {
                return;
            }
            
            try {
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                await deleteDoc(doc(window.db_fs, "user_worksheets", worksheetId));

                window.showToast("Worksheet deleted successfully.", "success");
                loadSavedWorksheets();

            } catch (e) {
                console.error("Delete worksheet error:", e);
                window.showToast("Failed to delete worksheet. Please try again.", "error");
            }
        };

        // =====================================================
        // WORKSHEET ATTEMPT SYSTEM
        // =====================================================
        
        window.currentAttempt = {
            worksheetId: null,
            worksheetName: null,
            questions: [],
            currentIndex: 0,
            answers: [] // {questionId, questionTitle, topic, type, studentAnswer, correctAnswer, correct}
        };

        // Start attempting a worksheet
        window.attemptWorksheet = async function(worksheetId) {
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const docRef = doc(window.db_fs, "user_worksheets", worksheetId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert("Worksheet not found.");
                    return;
                }
                
                const data = docSnap.data();
                
                // Initialize attempt state
                window.currentAttempt = {
                    worksheetId: worksheetId,
                    worksheetName: data.name,
                    questions: data.questions || [],
                    currentIndex: 0,
                    answers: data.questions.map((q, i) => ({
                        questionId: q.id || `q-${i}`,
                        questionTitle: q.title || `Question ${i + 1}`,
                        topic: q.topic || 'N/A',
                        type: q.type || 'unknown',
                        studentAnswer: null,
                        correctAnswer: null,
                        correct: false
                    }))
                };
                
                // Update UI
                document.getElementById('attempt-worksheet-title').textContent = ` ${data.name}`;
                
                // Show modal
                document.getElementById('worksheet-attempt-modal').classList.add('visible');
                
                // Show first question
                showAttemptQuestion(0);
                
            } catch (e) {
                console.error("Error loading worksheet for attempt:", e);
                alert("Error loading worksheet: " + e.message);
            }
        };

        // Show a specific question in the attempt
        window.showAttemptQuestion = function(index) {
            const attempt = window.currentAttempt;
            const total = attempt.questions.length;
            
            if (index < 0 || index >= total) return;
            
            attempt.currentIndex = index;
            
            // Update progress
            document.getElementById('attempt-worksheet-progress').textContent = `Question ${index + 1} of ${total}`;
            document.getElementById('attempt-progress-bar').style.width = `${((index + 1) / total) * 100}%`;
            
            // Update navigation buttons
            document.getElementById('attempt-prev-btn').style.display = index === 0 ? 'none' : 'inline-block';
            document.getElementById('attempt-next-btn').classList.toggle('hidden', index === total - 1);
            document.getElementById('attempt-submit-btn').classList.toggle('hidden', index !== total - 1);
            
            // Render question
            const question = attempt.questions[index];
            const container = document.getElementById('attempt-question-container');
            
            // Get previous answer if any
            const previousAnswer = attempt.answers[index]?.studentAnswer;
            
            container.innerHTML = `
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #667eea;">
                    <h4 style="margin: 0 0 1rem 0; color: #333;">Question ${index + 1}: ${question.title || 'Untitled'}</h4>
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">
                        <span style="background: #e3f2fd; padding: 2px 8px; border-radius: 4px; margin-right: 8px;">Topic: ${question.topic || 'N/A'}</span>
                        <span style="background: #f3e5f5; padding: 2px 8px; border-radius: 4px;">Type: ${question.type || 'N/A'}</span>
                    </div>
                    <div id="attempt-question-content" style="margin-bottom: 1.5rem;">
                        ${question.html || '<p>No question content</p>'}
                    </div>
                    ${renderAttemptAnswerInput(question, index, previousAnswer)}
                </div>
            `;
            
            // Initialize MCQ radio buttons with previous selection
            if (previousAnswer && question.type === 'mcq') {
                const radios = container.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => {
                    if (radio.value === previousAnswer) {
                        radio.checked = true;
                    }
                });
            }
        };

        // Render answer input based on question type
        window.renderAttemptAnswerInput = function(question, index, previousAnswer) {
            if (question.type === 'mcq') {
                // For MCQ, find the options in the HTML
                return `
                    <div style="background: white; padding: 1rem; border-radius: 8px; border: 2px solid #e0e0e0;">
                        <p style="font-weight: 600; margin-bottom: 0.5rem; color: #555;">Select your answer:</p>
                        <p style="font-size: 0.85rem; color: #888;">Click on an option above or in the question content</p>
                    </div>
                `;
            } else {
                // For other types, provide a text area
                return `
                    <div style="background: white; padding: 1rem; border-radius: 8px; border: 2px solid #e0e0e0;">
                        <p style="font-weight: 600; margin-bottom: 0.5rem; color: #555;">Your Answer:</p>
                        <textarea id="attempt-answer-${index}" 
                                  style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; resize: vertical;"
                                  placeholder="Type your answer here..."
                                  onchange="saveAttemptAnswer(${index}, this.value)">${previousAnswer || ''}</textarea>
                    </div>
                `;
            }
        };

        // Save answer for a question
        window.saveAttemptAnswer = function(index, answer) {
            if (window.currentAttempt.answers[index]) {
                window.currentAttempt.answers[index].studentAnswer = answer;
            }
        };

        // Navigate to previous question
        window.prevAttemptQuestion = function() {
            const index = window.currentAttempt.currentIndex;
            if (index > 0) {
                // Save current answer first
                saveCurrentAttemptAnswer();
                showAttemptQuestion(index - 1);
            }
        };

        // Navigate to next question
        window.nextAttemptQuestion = function() {
            const attempt = window.currentAttempt;
            const index = attempt.currentIndex;
            
            // Save current answer first
            saveCurrentAttemptAnswer();
            
            if (index < attempt.questions.length - 1) {
                showAttemptQuestion(index + 1);
            }
        };

        // Save the current question's answer
        window.saveCurrentAttemptAnswer = function() {
            const attempt = window.currentAttempt;
            const index = attempt.currentIndex;
            const question = attempt.questions[index];
            
            if (question.type === 'mcq') {
                // Find selected MCQ option
                const container = document.getElementById('attempt-question-container');
                const selected = container.querySelector('input[type="radio"]:checked');
                if (selected) {
                    attempt.answers[index].studentAnswer = selected.value || selected.nextSibling?.textContent?.trim();
                    attempt.answers[index].correct = selected.dataset.correct === 'true';
                }
            } else {
                // Get text answer
                const textarea = document.getElementById(`attempt-answer-${index}`);
                if (textarea) {
                    attempt.answers[index].studentAnswer = textarea.value;
                    // For non-MCQ, we can't automatically determine correctness
                    // Mark as correct if they provided an answer (teacher can review)
                    attempt.answers[index].correct = textarea.value.trim().length > 0;
                }
            }
        };

        // Submit the worksheet attempt
        window.submitWorksheetAttempt = async function() {
            // Save last answer
            saveCurrentAttemptAnswer();
            
            const attempt = window.currentAttempt;
            
            // Check if all questions answered
            const unanswered = attempt.answers.filter(a => !a.studentAnswer || a.studentAnswer.trim() === '').length;
            if (unanswered > 0) {
                if (!confirm(`You have ${unanswered} unanswered question(s). Submit anyway?`)) {
                    return;
                }
            }
            
            try {
                // Calculate results for MCQ questions
                let correctCount = 0;
                attempt.answers.forEach((ans, idx) => {
                    const question = attempt.questions[idx];
                    if (question.type === 'mcq') {
                        // For MCQ, correctness was determined when selecting
                        if (ans.correct) correctCount++;
                    } else {
                        // For other types, mark as correct if answered
                        if (ans.studentAnswer && ans.studentAnswer.trim()) {
                            ans.correct = true;
                            correctCount++;
                        }
                    }
                });
                
                // Save the attempt to Firestore
                await saveWorksheetAttempt(
                    attempt.worksheetId,
                    attempt.worksheetName,
                    attempt.answers,
                    'completed'
                );
                
                // Show completion message
                const score = Math.round((correctCount / attempt.answers.length) * 100);
                const wrongCount = attempt.answers.length - correctCount;
                
                alert(`Worksheet submitted!\n\nScore: ${score}%\nCorrect: ${correctCount}/${attempt.answers.length}\nWrong: ${wrongCount}`);
                
                // Close modal
                document.getElementById('worksheet-attempt-modal').classList.remove('visible');
                
                // Reset attempt state
                window.currentAttempt = {
                    worksheetId: null,
                    worksheetName: null,
                    questions: [],
                    currentIndex: 0,
                    answers: []
                };
                
            } catch (e) {
                console.error("Error submitting worksheet:", e);
                alert("Error submitting worksheet: " + e.message);
            }
        };

        // Cancel worksheet attempt
        window.cancelWorksheetAttempt = function() {
            if (confirm("Are you sure you want to exit? Your progress will be lost.")) {
                document.getElementById('worksheet-attempt-modal').classList.remove('visible');
                window.currentAttempt = {
                    worksheetId: null,
                    worksheetName: null,
                    questions: [],
                    currentIndex: 0,
                    answers: []
                };
            }
        };

        // =====================================================
        // SHARED LESSONS SYSTEM
        // =====================================================

        window.loadSharedLessons = async function() {
            const container = document.getElementById('lessons-container');
            const emptyMsg = document.getElementById('lessons-empty-msg');
            
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const snapshot = await getDocs(collection(window.db_fs, "shared_lessons"));
                
                if (snapshot.empty) {
                    container.innerHTML = '';
                    container.appendChild(emptyMsg);
                    emptyMsg.style.display = 'block';
                    return;
                }
                
                emptyMsg.style.display = 'none';
                container.innerHTML = '';
                
                const lessons = [];
                snapshot.forEach(doc => {
                    lessons.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by date descending
                lessons.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                lessons.forEach(lesson => {
                    const date = new Date(lesson.createdAt).toLocaleDateString();
                    const card = document.createElement('div');
                    card.className = 'lesson-card';
                    card.onclick = () => openLesson(lesson.id);
                    card.innerHTML = `
                        <h4> ${lesson.name}</h4>
                        <div class="meta"> Video Lesson  ${lesson.questionCount} practice questions</div>
                        ${lesson.description ? `<p class="description">${lesson.description}</p>` : ''}
                        <span class="badge"> ${date}</span>
                        ${window.isAdminUser ? `<button class="btn" style="margin-left: 10px; background: #dc3545; color: white; padding: 3px 10px; font-size: 0.75rem;" onclick="event.stopPropagation(); deleteSharedLesson('${lesson.id}')"> Delete</button>` : ''}
                    `;
                    container.appendChild(card);
                });
                
            } catch (e) {
                console.error("Load lessons error:", e);
                container.innerHTML = '<p style="color: #dc3545;">Error loading lessons. Please try again.</p>';
            }
        };

        window.refreshSharedLessons = function() {
            loadSharedLessons();
        };

        window.openLesson = async function(lessonId) {
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const docRef = doc(window.db_fs, "shared_lessons", lessonId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert("Lesson not found.");
                    return;
                }
                
                const lesson = docSnap.data();
                const container = document.getElementById('lesson-detail-content');
                
                container.innerHTML = `
                    <h2 style="margin: 0 0 1rem; color: #e65100;"> ${lesson.name}</h2>
                    ${lesson.description ? `<p style="color: #666; margin-bottom: 1.5rem;">${lesson.description}</p>` : ''}
                    
                    <div class="lesson-video-container">
                        <iframe src="${lesson.videoUrl}" allowfullscreen></iframe>
                    </div>
                    
                    <div class="lesson-questions-section">
                        <h3> Practice Questions (${lesson.questionCount})</h3>
                        <div class="scroll-buttons-container">
                            <button class="scroll-btn" onclick="scrollToTop('lesson-questions-section')">
                                 Go to Top
                            </button>
                            <button class="scroll-btn" onclick="scrollToBottom('lesson-questions-section')">
                                 Go to Bottom
                            </button>
                        </div>
                        <div id="lesson-questions-list"></div>
                    </div>
                `;
                
                const questionsList = document.getElementById('lesson-questions-list');
                lesson.questions.forEach((q, i) => {
                    const qDiv = document.createElement('div');
                    qDiv.className = 'question-container';
                    qDiv.style.marginBottom = '1.5rem';
                    qDiv.style.background = 'white';
                    qDiv.style.padding = '1.5rem';
                    qDiv.style.borderRadius = '8px';
                    qDiv.style.borderLeft = '4px solid #f57c00';
                    qDiv.innerHTML = `
                        <h4 style="margin: 0 0 1rem; color: #333;">Question ${i + 1}: ${q.title}</h4>
                        <div class="question-body answer-template">${q.html}</div>
                    `;
                    questionsList.appendChild(qDiv);
                    
                    // Setup question functionality
                    if (window.setupQuestionFormGlobal) {
                        const bodyDiv = qDiv.querySelector('.question-body');
                        if (bodyDiv && bodyDiv.id) {
                            window.setupQuestionFormGlobal(bodyDiv.id);
                        }
                    }
                });
                
                // Add controls to lesson questions
                setTimeout(() => {
                    questionsList.querySelectorAll('.question-body').forEach(body => {
                        // Find MCQ containers and add check functionality
                        const mcqContainer = body.querySelector('.mcq-container');
                        if (mcqContainer) {
                            const existingBtn = body.querySelector('.submit-btn');
                            if (!existingBtn) {
                                const btn = document.createElement('button');
                                btn.className = 'btn btn-primary submit-btn';
                                btn.style.marginTop = '1rem';
                                btn.textContent = 'Check Answer';
                                btn.onclick = function() {
                                    const selected = mcqContainer.querySelector('input[type="radio"]:checked');
                                    if (!selected) {
                                        alert('Please select an answer.');
                                        return;
                                    }
                                    const isCorrect = selected.dataset.correct === 'true';
                                    
                                    // Show correct answer highlighting with icons inside options
                                    mcqContainer.querySelectorAll('label, .mcq-option').forEach(opt => {
                                        const radio = opt.querySelector('input');
                                        opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());
                                        
                                        if (radio && radio.dataset.correct === 'true') {
                                            opt.style.background = '#d4edda';
                                            opt.style.borderColor = '#28a745';
                                            const icon = document.createElement('span');
                                            icon.className = 'option-feedback-icon';
                                            icon.textContent = '';
                                            icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #28a745; margin-left: auto; padding-left: 10px;';
                                            opt.style.display = 'flex';
                                            opt.style.alignItems = 'center';
                                            opt.appendChild(icon);
                                        } else if (radio && radio.checked && !isCorrect) {
                                            opt.style.background = '#f8d7da';
                                            opt.style.borderColor = '#dc3545';
                                            const icon = document.createElement('span');
                                            icon.className = 'option-feedback-icon';
                                            icon.textContent = '';
                                            icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #dc3545; margin-left: auto; padding-left: 10px;';
                                            opt.style.display = 'flex';
                                            opt.style.alignItems = 'center';
                                            opt.appendChild(icon);
                                        }
                                    });
                                    
                                    // Disable all radios
                                    mcqContainer.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);
                                    btn.disabled = true;
                                    
                                    // Show explanation if exists
                                    const explanationBox = body.querySelector('.explanation-box');
                                    if (explanationBox) {
                                        explanationBox.style.display = 'block';
                                    }
                                };
                                body.appendChild(btn);
                            }
                        }
                    });
                }, 100);
                
                switchTab('lesson-detail');

            } catch (e) {
                console.error("Open lesson error:", e);
                window.showToast("Failed to open lesson. Please try again.", "error");
            }
        };

        window.deleteSharedLesson = async function(lessonId) {
            if (!confirm("Are you sure you want to delete this lesson? This will remove it for all students.")) {
                return;
            }

            try {
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

                await deleteDoc(doc(window.db_fs, "shared_lessons", lessonId));

                window.showToast("Lesson deleted successfully.", "success");
                loadSharedLessons();

            } catch (e) {
                console.error("Delete lesson error:", e);
                window.showToast("Failed to delete lesson. Please try again.", "error");
            }
        };

        // =====================================================
        // MULTI-STUDENT REGISTRATION
        // =====================================================
        
        window.studentEntryCount = 1;
        
        window.addStudentEntry = function() {
            const container = document.getElementById('students-container');
            const index = window.studentEntryCount++;
            
            const entry = document.createElement('div');
            entry.className = 'student-entry';
            entry.dataset.studentIndex = index;
            entry.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <input type="text" class="auth-input student-name" placeholder="Student's Name" style="flex: 1; margin-bottom: 0;">
                    <select class="auth-input student-level" style="width: 100px; margin-bottom: 0;">
                        <option value="">Level</option>
                        <option value="P3">P3</option>
                        <option value="P4">P4</option>
                        <option value="P5">P5</option>
                        <option value="P6">P6</option>
                    </select>
                    <button type="button" onclick="removeStudentEntry(${index})" style="background: #dc3545; color: white; border: none; border-radius: 8px; width: 35px; height: 35px; cursor: pointer; font-size: 1.2rem;"></button>
                </div>
            `;
            container.appendChild(entry);
        };
        
        window.removeStudentEntry = function(index) {
            const entry = document.querySelector(`.student-entry[data-student-index="${index}"]`);
            if (entry) entry.remove();
        };
        
        window.getStudentsData = function() {
            const students = [];
            document.querySelectorAll('.student-entry').forEach(entry => {
                const name = entry.querySelector('.student-name').value.trim();
                const level = entry.querySelector('.student-level').value;
                if (name && level) {
                    students.push({ name, level });
                }
            });
            return students;
        };

        // =====================================================
        // PRACTICE MODE
        // =====================================================
        
        window.practiceState = {
            currentStudent: null,
            questions: [],
            currentIndex: 0,
            correct: 0,
            wrong: 0,
            streak: 0,
            answeredQuestions: new Set(),
            wrongAnswersForReview: {} // {questionId: timestamp} - questions to review after 7 days
        };

        // =====================================================
        // ELO RATING SYSTEM FOR DELIBERATE PRACTICE
        // =====================================================
        // Based on Elo chess rating system adapted for education
        // Questions and students both have ratings
        // More attempts = more accurate ratings (confidence)
        
        // Rating constants
        const RATING_CONFIG = {
            DEFAULT_QUESTION_RATING: 1200,  // Starting difficulty for questions
            DEFAULT_STUDENT_RATING: 1000,   // Starting rating for students
            MIN_RATING: 400,                // Minimum possible rating
            MAX_RATING: 2400,               // Maximum possible rating
            K_FACTOR_BASE: 32,              // Base K-factor for rating changes
            K_FACTOR_MIN: 8,                // Minimum K-factor (after many attempts)
            GROWTH_ZONE_MIN: 0.35,          // Minimum expected success rate for growth zone
            GROWTH_ZONE_MAX: 0.75,          // Maximum expected success rate for growth zone
            CONFIDENCE_THRESHOLD: 20        // Number of attempts for full confidence
        };

        // Calculate expected probability of correct answer
        // Uses standard Elo formula: E = 1 / (1 + 10^((Rq - Rs) / 400))
        window.calculateExpectedSuccess = function(studentRating, questionRating) {
            const exponent = (questionRating - studentRating) / 400;
            return 1 / (1 + Math.pow(10, exponent));
        };

        // Calculate K-factor based on number of attempts (decreases with more data)
        window.calculateKFactor = function(attempts) {
            if (attempts <= 0) return RATING_CONFIG.K_FACTOR_BASE;
            
            // K-factor decreases as confidence increases
            const confidence = Math.min(attempts / RATING_CONFIG.CONFIDENCE_THRESHOLD, 1);
            return Math.max(
                RATING_CONFIG.K_FACTOR_MIN,
                RATING_CONFIG.K_FACTOR_BASE * (1 - confidence * 0.75)
            );
        };

        // Update ratings after an answer
        // Returns { newStudentRating, newQuestionRating, ratingChange }
        window.calculateRatingUpdate = function(studentRating, questionRating, isCorrect, studentAttempts, questionAttempts) {
            const expected = calculateExpectedSuccess(studentRating, questionRating);
            const actual = isCorrect ? 1 : 0;
            
            // Calculate K-factors
            const studentK = calculateKFactor(studentAttempts);
            const questionK = calculateKFactor(questionAttempts);
            
            // Calculate rating changes
            const studentChange = studentK * (actual - expected);
            const questionChange = -questionK * (actual - expected) * 0.5; // Questions change more slowly
            
            // Apply changes with bounds
            let newStudentRating = Math.round(studentRating + studentChange);
            let newQuestionRating = Math.round(questionRating + questionChange);
            
            // Enforce bounds
            newStudentRating = Math.max(RATING_CONFIG.MIN_RATING, Math.min(RATING_CONFIG.MAX_RATING, newStudentRating));
            newQuestionRating = Math.max(RATING_CONFIG.MIN_RATING, Math.min(RATING_CONFIG.MAX_RATING, newQuestionRating));
            
            return {
                newStudentRating,
                newQuestionRating,
                studentChange: Math.round(studentChange),
                questionChange: Math.round(questionChange),
                expected: Math.round(expected * 100)
            };
        };

        // Check if a question is in the student's growth zone
        window.isInGrowthZone = function(studentRating, questionRating) {
            const expected = calculateExpectedSuccess(studentRating, questionRating);
            return expected >= RATING_CONFIG.GROWTH_ZONE_MIN && expected <= RATING_CONFIG.GROWTH_ZONE_MAX;
        };

        // Get difficulty label based on expected success rate
        window.getDifficultyLabel = function(studentRating, questionRating) {
            const expected = calculateExpectedSuccess(studentRating, questionRating);
            
            if (expected >= 0.85) return { label: 'Easy', color: '#4CAF50', icon: '' };
            if (expected >= 0.70) return { label: 'Moderate', color: '#8BC34A', icon: '' };
            if (expected >= 0.50) return { label: 'Challenging', color: '#FF9800', icon: '' };
            if (expected >= 0.35) return { label: 'Hard', color: '#f44336', icon: '' };
            return { label: 'Very Hard', color: '#9C27B0', icon: '' };
        };

        // Get rating tier name
        window.getRatingTier = function(rating) {
            if (rating >= 2000) return { tier: 'Master', color: '#9C27B0' };
            if (rating >= 1600) return { tier: 'Expert', color: '#673AB7' };
            if (rating >= 1400) return { tier: 'Advanced', color: '#3F51B5' };
            if (rating >= 1200) return { tier: 'Intermediate', color: '#2196F3' };
            if (rating >= 1000) return { tier: 'Developing', color: '#4CAF50' };
            if (rating >= 800) return { tier: 'Beginner', color: '#FF9800' };
            return { tier: 'Novice', color: '#f44336' };
        };

        // Question ratings cache (loaded from Firebase)
        window.questionRatings = {};

        // Load question ratings from Firebase
        window.loadQuestionRatings = async function() {
            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) return;
                
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const ratingsRef = collection(window.db_fs, "question_ratings");
                const snapshot = await getDocs(ratingsRef);
                
                window.questionRatings = {};
                snapshot.forEach(doc => {
                    window.questionRatings[doc.id] = doc.data();
                });
                
                console.log(`Loaded ${Object.keys(window.questionRatings).length} question ratings`);
            } catch (e) {
                console.error("Error loading question ratings:", e);
            }
        };

        // Get rating for a specific question
        window.getQuestionRating = function(questionId) {
            if (window.questionRatings[questionId]) {
                return window.questionRatings[questionId];
            }
            return {
                rating: RATING_CONFIG.DEFAULT_QUESTION_RATING,
                attempts: 0,
                correctCount: 0,
                lastUpdated: null
            };
        };

        // Update question rating in Firebase
        window.updateQuestionRating = async function(questionId, newRating, isCorrect) {
            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) return;
                
                const { doc, setDoc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get current data
                const currentData = getQuestionRating(questionId);
                
                const updatedData = {
                    rating: newRating,
                    attempts: (currentData.attempts || 0) + 1,
                    correctCount: (currentData.correctCount || 0) + (isCorrect ? 1 : 0),
                    lastUpdated: new Date()
                };
                
                await setDoc(doc(window.db_fs, "question_ratings", questionId), updatedData);
                
                // Update local cache
                window.questionRatings[questionId] = updatedData;
            } catch (e) {
                console.error("Error updating question rating:", e);
            }
        };

        // Get student rating from Firebase
        window.getStudentRating = async function(studentIndex) {
            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) {
                    console.warn("Cannot get rating - no user or db");
                    return { rating: RATING_CONFIG.DEFAULT_STUDENT_RATING, attempts: 0 };
                }
                
                // Validate studentIndex
                if (typeof studentIndex !== 'number' || isNaN(studentIndex) || studentIndex < 0) {
                    console.warn("Invalid studentIndex:", studentIndex);
                    return { rating: RATING_CONFIG.DEFAULT_STUDENT_RATING, attempts: 0 };
                }
                
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    const students = data.students || [];
                    
                    if (students[studentIndex]) {
                        // Check if rating exists (could be 0, so check for undefined/null)
                        const rating = students[studentIndex].rating;
                        if (rating !== undefined && rating !== null) {
                            console.log("Loaded rating:", rating, "for student index:", studentIndex);
                            return {
                                rating: rating,
                                attempts: students[studentIndex].totalAttempts || 0
                            };
                        }
                    }
                }
                
                return {
                    rating: RATING_CONFIG.DEFAULT_STUDENT_RATING,
                    attempts: 0
                };
            } catch (e) {
                console.error("Error getting student rating:", e);
                return {
                    rating: RATING_CONFIG.DEFAULT_STUDENT_RATING,
                    attempts: 0
                };
            }
        };

        // Update student rating in Firebase
        window.updateStudentRating = async function(studentIndex, newRating, isCorrect) {
            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) {
                    console.warn("Cannot update rating - no user or db");
                    return;
                }
                
                // Validate studentIndex
                if (typeof studentIndex !== 'number' || isNaN(studentIndex) || studentIndex < 0) {
                    console.warn("Invalid studentIndex:", studentIndex);
                    return;
                }
                
                const { doc, getDoc, updateDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const userRef = doc(window.db_fs, "users", user.uid);
                const userDoc = await getDoc(userRef);
                
                let students = [];
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    students = data.students || [];
                }
                
                // Ensure student exists at this index
                if (!students[studentIndex]) {
                    // Create a placeholder student if needed
                    while (students.length <= studentIndex) {
                        students.push({ name: 'Student ' + (students.length + 1), level: 'P6' });
                    }
                }
                
                // Store starting rating if this is the first time the student gets a rating
                if (students[studentIndex].startingRating === undefined || students[studentIndex].startingRating === null) {
                    students[studentIndex].startingRating = RATING_CONFIG.DEFAULT_STUDENT_RATING;
                }
                
                // Update the student's rating data
                students[studentIndex].rating = Math.round(newRating);
                students[studentIndex].totalAttempts = (students[studentIndex].totalAttempts || 0) + 1;
                students[studentIndex].correctCount = (students[studentIndex].correctCount || 0) + (isCorrect ? 1 : 0);
                students[studentIndex].lastPractice = new Date().toISOString();
                
                // Save to Firebase
                await updateDoc(userRef, { students: students });
                
                console.log("Rating saved:", students[studentIndex].rating, "for student index:", studentIndex);
                
                // Update local state
                if (window.practiceState.currentStudent) {
                    window.practiceState.currentStudent.rating = Math.round(newRating);
                    window.practiceState.currentStudent.attempts = students[studentIndex].totalAttempts;
                }
            } catch (e) {
                console.error("Error updating student rating:", e);
            }
        };

        // Load and display leaderboard
        window.loadLeaderboard = async function() {
            const container = document.getElementById('leaderboard-container');
            if (!container) return;

            container.innerHTML = '<div class="placeholder-content" id="leaderboard-loading-msg"><p style="font-size: 1.2rem; color: #666;">Loading leaderboard...</p></div>';

            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Fetch all users
                const usersRef = collection(window.db_fs, "users");
                const snapshot = await getDocs(usersRef);
                
                const allStudents = [];
                
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    const students = userData.students || [];
                    const parentName = userData.parentName || userData.email || 'Unknown';
                    
                    students.forEach((student, index) => {
                        const currentRating = student.rating !== undefined && student.rating !== null 
                            ? student.rating 
                            : RATING_CONFIG.DEFAULT_STUDENT_RATING;
                        
                        // Get starting rating (stored or default to 1000)
                        const startingRating = student.startingRating !== undefined && student.startingRating !== null
                            ? student.startingRating
                            : RATING_CONFIG.DEFAULT_STUDENT_RATING;
                        
                        // Calculate improvement
                        const improvement = currentRating - startingRating;
                        
                        allStudents.push({
                            name: student.name || 'Student',
                            level: student.level || 'P6',
                            rating: currentRating,
                            startingRating: startingRating,
                            improvement: improvement,
                            attempts: student.totalAttempts || 0,
                            correctCount: student.correctCount || 0,
                            parentName: parentName,
                            userId: doc.id,
                            studentIndex: index
                        });
                    });
                });

                if (allStudents.length === 0) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #666;">No students found in the leaderboard.</p></div>';
                    return;
                }

                // Sort by rating (descending) for top ratings
                const sortedByRating = [...allStudents].sort((a, b) => b.rating - a.rating);
                
                // Sort by improvement (descending) for biggest improvement
                const sortedByImprovement = [...allStudents].sort((a, b) => b.improvement - a.improvement);
                
                // Get top 3 and biggest improvement
                const top1 = sortedByRating[0];
                const top2 = sortedByRating[1];
                const top3 = sortedByRating[2];
                const biggestImprovement = sortedByImprovement[0];

                // Build leaderboard HTML
                let leaderboardHTML = `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #333; margin-bottom: 1rem;"> Top Ratings</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                `;

                // Top 3 podium
                if (top3) {
                    leaderboardHTML += `
                        <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;"></div>
                            <div style="font-weight: bold; font-size: 1.2rem; margin-bottom: 0.5rem;">${top1.name}</div>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">${top1.level}</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333;">${top1.rating}</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">${top1.attempts} attempts</div>
                        </div>
                    `;
                }

                if (top2) {
                    leaderboardHTML += `
                        <div style="background: linear-gradient(135deg, #C0C0C0, #A8A8A8); padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(192, 192, 192, 0.3);">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;"></div>
                            <div style="font-weight: bold; font-size: 1.2rem; margin-bottom: 0.5rem;">${top2.name}</div>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">${top2.level}</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333;">${top2.rating}</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">${top2.attempts} attempts</div>
                        </div>
                    `;
                }

                if (top3) {
                    leaderboardHTML += `
                        <div style="background: linear-gradient(135deg, #CD7F32, #B87333); padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(205, 127, 50, 0.3);">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;"></div>
                            <div style="font-weight: bold; font-size: 1.2rem; margin-bottom: 0.5rem;">${top3.name}</div>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">${top3.level}</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333;">${top3.rating}</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">${top3.attempts} attempts</div>
                        </div>
                    `;
                }

                leaderboardHTML += `</div>`;

                // Biggest improvement
                if (biggestImprovement && biggestImprovement.improvement > 0) {
                    leaderboardHTML += `
                        <div style="background: linear-gradient(135deg, #4CAF50, #45a049); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                            <h3 style="color: white; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 2rem;"></span>
                                <span>Biggest Improvement</span>
                            </h3>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 1rem; align-items: center;">
                                <div style="font-size: 2.5rem;"></div>
                                <div>
                                    <div style="font-weight: bold; font-size: 1.3rem; color: white; margin-bottom: 0.3rem;">${biggestImprovement.name}</div>
                                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.9); margin-bottom: 0.5rem;">${biggestImprovement.level}</div>
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                        <div>
                                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">Starting Rating</div>
                                            <div style="font-size: 1.1rem; font-weight: bold; color: white;">${biggestImprovement.startingRating}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">Current Rating</div>
                                            <div style="font-size: 1.1rem; font-weight: bold; color: white;">${biggestImprovement.rating}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">Improvement</div>
                                            <div style="font-size: 1.1rem; font-weight: bold; color: #FFD700;">+${biggestImprovement.improvement}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Full leaderboard table
                leaderboardHTML += `
                    <h3 style="color: #333; margin-bottom: 1rem;"> Full Leaderboard</h3>
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                    <th style="padding: 12px; text-align: center; font-weight: bold; width: 60px;">Rank</th>
                                    <th style="padding: 12px; text-align: left; font-weight: bold;">Student</th>
                                    <th style="padding: 12px; text-align: center; font-weight: bold; width: 100px;">Level</th>
                                    <th style="padding: 12px; text-align: center; font-weight: bold; width: 120px;">Rating</th>
                                    <th style="padding: 12px; text-align: center; font-weight: bold; width: 120px;">Improvement</th>
                                    <th style="padding: 12px; text-align: center; font-weight: bold; width: 100px;">Attempts</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                sortedByRating.forEach((student, index) => {
                    const rank = index + 1;
                    let medalIcon = '';
                    let rowStyle = '';
                    
                    if (rank === 1) {
                        medalIcon = '';
                        rowStyle = 'background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));';
                    } else if (rank === 2) {
                        medalIcon = '';
                        rowStyle = 'background: linear-gradient(90deg, rgba(192, 192, 192, 0.1), rgba(192, 192, 192, 0.05));';
                    } else if (rank === 3) {
                        medalIcon = '';
                        rowStyle = 'background: linear-gradient(90deg, rgba(205, 127, 50, 0.1), rgba(205, 127, 50, 0.05));';
                    }
                    
                    const isBiggestImprovement = biggestImprovement && 
                        student.name === biggestImprovement.name && 
                        student.userId === biggestImprovement.userId &&
                        student.studentIndex === biggestImprovement.studentIndex;
                    
                    if (isBiggestImprovement && rank > 3) {
                        rowStyle += ' border-left: 4px solid #4CAF50;';
                    }

                    const clickableStyle = window.isAdminUser ? 'cursor: pointer; transition: background 0.2s;' : '';
                    const onClickHandler = window.isAdminUser ? `onclick="viewStudentProgress('${student.userId}', ${student.studentIndex}, '${student.name}')" onmouseover="this.style.background='rgba(102, 126, 234, 0.1)'" onmouseout="this.style.background='${rowStyle}'"` : '';
                    
                    leaderboardHTML += `
                        <tr style="${rowStyle} ${clickableStyle}" ${onClickHandler}>
                            <td style="padding: 12px; text-align: center; font-weight: bold;">
                                ${medalIcon || rank}
                            </td>
                            <td style="padding: 12px; text-align: left;">
                                <div style="font-weight: 600;">${student.name} ${window.isAdminUser ? '' : ''}</div>
                                ${isBiggestImprovement ? '<div style="font-size: 0.75rem; color: #4CAF50; margin-top: 2px;"> Biggest Improvement</div>' : ''}
                            </td>
                            <td style="padding: 12px; text-align: center;">${student.level}</td>
                            <td style="padding: 12px; text-align: center; font-weight: bold; color: #667eea;">${student.rating}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="color: ${student.improvement >= 0 ? '#4CAF50' : '#dc3545'}; font-weight: ${student.improvement !== 0 ? 'bold' : 'normal'};">
                                    ${student.improvement > 0 ? '+' : ''}${student.improvement}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center;">${student.attempts}</td>
                        </tr>
                    `;
                });

                leaderboardHTML += `
                            </tbody>
                        </table>
                    </div>
                `;

                container.innerHTML = leaderboardHTML;

                // Initialize prize draw section
                initPrizeDraw();

            } catch (e) {
                console.error("Error loading leaderboard:", e);
                container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Error loading leaderboard. Please try again.</p></div>';
            }
        };

        // =====================================================
        // PRIZE DRAW SYSTEM
        // =====================================================

        const PRIZE_DRAW_DATE = new Date('2026-02-15T12:00:00+08:00'); // Feb 15, 2026 at noon SGT

        // Start countdown timer
        window.startPrizeCountdown = function() {
            function updateCountdown() {
                const now = new Date();
                const diff = PRIZE_DRAW_DATE - now;

                if (diff <= 0) {
                    // Draw has happened
                    document.getElementById('countdown-days').textContent = '0';
                    document.getElementById('countdown-hours').textContent = '0';
                    document.getElementById('countdown-mins').textContent = '0';
                    document.getElementById('countdown-secs').textContent = '0';

                    // Check if winner needs to be drawn
                    checkAndPerformDraw();
                    return;
                }

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((diff % (1000 * 60)) / 1000);

                const daysEl = document.getElementById('countdown-days');
                const hoursEl = document.getElementById('countdown-hours');
                const minsEl = document.getElementById('countdown-mins');
                const secsEl = document.getElementById('countdown-secs');

                if (daysEl) daysEl.textContent = days;
                if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, '0');
                if (minsEl) minsEl.textContent = mins.toString().padStart(2, '0');
                if (secsEl) secsEl.textContent = secs.toString().padStart(2, '0');
            }

            updateCountdown();
            setInterval(updateCountdown, 1000);
        };

        // Calculate tickets for a student based on their stats
        window.calculateTickets = function(studentData) {
            let tickets = 0;

            // Login streak: +1 ticket per streak day
            const streak = studentData.loginStreak || 0;
            tickets += streak;

            // Rating: +1 ticket per 100 rating points (above 1000 base)
            const rating = studentData.rating || 1000;
            tickets += Math.floor(rating / 100);

            // Correct answers: +1 ticket per 10 correct answers
            const correctCount = studentData.correctCount || 0;
            tickets += Math.floor(correctCount / 10);

            // Total login days: +1 ticket per 3 days
            const totalLoginDays = studentData.totalLoginDays || 0;
            tickets += Math.floor(totalLoginDays / 3);

            return Math.max(1, tickets); // Minimum 1 ticket for participating
        };

        // Load and display user's ticket count
        window.loadUserTickets = async function() {
            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) return;

                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const students = userData.students || [];

                    // Calculate total tickets for all students under this account
                    let totalTickets = 0;
                    students.forEach(student => {
                        totalTickets += calculateTickets(student);
                    });

                    const ticketEl = document.getElementById('user-ticket-count');
                    if (ticketEl) {
                        ticketEl.textContent = totalTickets;
                        // Add animation
                        ticketEl.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            ticketEl.style.transform = 'scale(1)';
                        }, 200);
                    }
                }
            } catch (e) {
                console.error("Error loading user tickets:", e);
            }
        };

        // Check if draw needs to happen and perform it
        window.checkAndPerformDraw = async function() {
            try {
                const { doc, getDoc, setDoc, collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

                // Check if winner already exists
                const drawDoc = await getDoc(doc(window.db_fs, "prize_draw", "jan2026"));

                if (drawDoc.exists() && drawDoc.data().winner) {
                    // Winner already selected, show announcement
                    showWinnerAnnouncement(drawDoc.data().winner);
                    return;
                }

                // Only admins can trigger the draw
                if (!window.isAdminUser) {
                    // For non-admins, just check if winner exists
                    return;
                }

                // Perform the draw (admin only)
                const now = new Date();
                if (now >= PRIZE_DRAW_DATE) {
                    await performPrizeDraw();
                }
            } catch (e) {
                console.error("Error checking draw:", e);
            }
        };

        // Perform the actual prize draw
        window.performPrizeDraw = async function() {
            try {
                const { doc, setDoc, collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

                // Collect all tickets
                const usersRef = collection(window.db_fs, "users");
                const snapshot = await getDocs(usersRef);

                const ticketPool = []; // Array of {studentName, userId, studentIndex}

                snapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const students = userData.students || [];

                    students.forEach((student, index) => {
                        const tickets = calculateTickets(student);
                        // Add entry for each ticket
                        for (let i = 0; i < tickets; i++) {
                            ticketPool.push({
                                studentName: student.name || 'Student',
                                userId: userDoc.id,
                                studentIndex: index,
                                parentEmail: userData.email
                            });
                        }
                    });
                });

                if (ticketPool.length === 0) {
                    console.log("No tickets in the pool");
                    return;
                }

                // Random draw
                const winnerIndex = Math.floor(Math.random() * ticketPool.length);
                const winner = ticketPool[winnerIndex];

                // Save winner to Firebase
                await setDoc(doc(window.db_fs, "prize_draw", "jan2026"), {
                    winner: winner,
                    drawDate: new Date().toISOString(),
                    totalTickets: ticketPool.length,
                    drawnBy: window.auth?.currentUser?.uid
                });

                // Show announcement
                showWinnerAnnouncement(winner);

            } catch (e) {
                console.error("Error performing draw:", e);
            }
        };

        // Show winner announcement
        window.showWinnerAnnouncement = function(winner) {
            const announcementEl = document.getElementById('prize-winner-announcement');
            const winnerNameEl = document.getElementById('winner-name');
            const countdownSection = document.getElementById('prize-countdown')?.parentElement;

            if (announcementEl && winnerNameEl) {
                winnerNameEl.textContent = winner.studentName;
                announcementEl.style.display = 'block';

                // Hide countdown
                if (countdownSection) {
                    countdownSection.style.display = 'none';
                }
            }
        };

        // Initialize prize draw section when leaderboard loads
        window.initPrizeDraw = function() {
            startPrizeCountdown();
            loadUserTickets();

            // Check for existing winner
            checkAndPerformDraw();
        };

        // Load and display student's own progress
        window.loadMyProgress = async function() {
            const container = document.getElementById('my-progress-container');
            if (!container) return;

            // Reset header to default
            const progressHeader = document.querySelector('#view-my-progress h2');
            if (progressHeader) {
                progressHeader.innerHTML = ' My Progress';
            }

            container.innerHTML = '<div class="placeholder-content" id="my-progress-loading-msg"><p style="font-size: 1.2rem; color: #666;">Loading your progress...</p></div>';

            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Please log in to view your progress.</p></div>';
                    return;
                }

                const { doc, getDoc, collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get user data
                const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                if (!userDoc.exists()) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #666;">No progress data found.</p></div>';
                    return;
                }

                const userData = userDoc.data();
                const students = userData.students || [];
                const questionAttempts = userData.questionAttempts || {};

                // Handle student selection
                let selectedStudentIndex = 0;
                const studentSelect = document.getElementById('my-progress-student-select');
                const studentSelector = document.getElementById('my-progress-student-selector');
                
                if (students.length > 1) {
                    studentSelector.style.display = 'block';
                    if (studentSelect.value) {
                        selectedStudentIndex = parseInt(studentSelect.value, 10);
                    }
                    // Populate selector if empty
                    if (studentSelect.options.length <= 1) {
                        studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
                        students.forEach((student, idx) => {
                            const option = document.createElement('option');
                            option.value = idx;
                            option.textContent = `${student.name} (${student.level})`;
                            if (idx === 0) option.selected = true;
                            studentSelect.appendChild(option);
                        });
                    }
                } else {
                    studentSelector.style.display = 'none';
                }

                if (students.length === 0) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #666;">No student data found.</p></div>';
                    return;
                }

                const currentStudent = students[selectedStudentIndex];
                if (!currentStudent) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #666;">Student not found.</p></div>';
                    return;
                }

                const studentKey = `student_${selectedStudentIndex}`;
                const studentQuestionAttempts = questionAttempts[studentKey] || {};

                console.log("Student question attempts:", studentQuestionAttempts);
                console.log("Student key:", studentKey);

                // Get all questions from Firestore to determine topics
                const questionsSnapshot = await getDocs(collection(window.db_fs, "custom_questions"));
                const allQuestions = {};
                questionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const qId = `q-${doc.id}`;
                    allQuestions[qId] = {
                        id: qId,
                        title: data.title || 'Question',
                        topic: data.topic || 'General',
                        level: data.level || 'P6',
                        category: data.category || 'mcq'
                    };
                });

                // Also get questions from DOM (including hardcoded questions)
                document.querySelectorAll('.question-container[id]').forEach(container => {
                    const qId = container.id;
                    if (!allQuestions[qId]) {
                        // Try to determine topic from DOM
                        let topic = 'General';
                        const mcqParent = container.closest('[id^="topic-mcq-"]');
                        if (mcqParent) {
                            const topicId = mcqParent.id.replace('topic-mcq-', '');
                            if (window.mcqCurriculum) {
                                for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                                    const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                                    if (matchingTopic) {
                                        topic = matchingTopic;
                                        break;
                                    }
                                }
                            }
                        } else {
                            const topicParent = container.closest('[id^="topic-"]');
                            if (topicParent) {
                                const topicId = topicParent.id.replace('topic-', '').replace(/^(mcq|oeq|cer)-/, '');
                                topic = topicId.charAt(0).toUpperCase() + topicId.slice(1).replace(/-/g, ' ');
                            }
                        }
                        
                        allQuestions[qId] = {
                            id: qId,
                            title: container.querySelector('h3')?.textContent || 'Question',
                            topic: topic,
                            level: currentStudent.level || 'P6',
                            category: 'mcq'
                        };
                    }
                });

                // Also check for questions that have attempts but aren't in allQuestions yet
                Object.keys(studentQuestionAttempts).forEach(qId => {
                    if (!allQuestions[qId]) {
                        // Try to find in DOM
                        const container = document.getElementById(qId);
                        if (container) {
                            let topic = 'General';
                            const mcqParent = container.closest('[id^="topic-mcq-"]');
                            if (mcqParent) {
                                const topicId = mcqParent.id.replace('topic-mcq-', '');
                                if (window.mcqCurriculum) {
                                    for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                                        const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                                        if (matchingTopic) {
                                            topic = matchingTopic;
                                            break;
                                        }
                                    }
                                }
                            }
                            allQuestions[qId] = {
                                id: qId,
                                title: container.querySelector('h3')?.textContent || 'Question',
                                topic: topic,
                                level: currentStudent.level || 'P6',
                                category: 'mcq'
                            };
                        } else {
                            // Question not found, use generic info
                            allQuestions[qId] = {
                                id: qId,
                                title: 'Question',
                                topic: 'General',
                                level: currentStudent.level || 'P6',
                                category: 'mcq'
                            };
                        }
                    }
                });

                // Calculate topic mastery
                const topicStats = {};
                Object.keys(allQuestions).forEach(qId => {
                    const question = allQuestions[qId];
                    const topic = question.topic;
                    if (!topicStats[topic]) {
                        topicStats[topic] = { total: 0, attempted: 0, correct: 0, questions: [] };
                    }
                    topicStats[topic].total++;
                    
                    const attempt = studentQuestionAttempts[qId];
                    if (attempt) {
                        topicStats[topic].attempted += attempt.attempts;
                        topicStats[topic].correct += attempt.correct;
                        topicStats[topic].questions.push({
                            id: qId,
                            title: question.title,
                            attempts: attempt.attempts,
                            correct: attempt.correct,
                            successRate: attempt.attempts > 0 ? (attempt.correct / attempt.attempts) * 100 : 0
                        });
                    }
                });

                // Find weak questions (success rate < 50% and attempted at least once)
                const weakQuestions = [];
                Object.values(topicStats).forEach(topic => {
                    topic.questions.forEach(q => {
                        if (q.attempts > 0 && q.successRate < 50) {
                            weakQuestions.push(q);
                        }
                    });
                });
                weakQuestions.sort((a, b) => a.successRate - b.successRate);

                // Build progress HTML with beautiful pastel colors and emojis
                const totalAttempted = Object.values(studentQuestionAttempts).reduce((sum, a) => sum + (a.attempts || 0), 0);
                const totalCorrect = Object.values(studentQuestionAttempts).reduce((sum, a) => sum + (a.correct || 0), 0);
                const overallSuccess = totalAttempted > 0 ? (totalCorrect / totalAttempted * 100).toFixed(1) : 0;

                let progressHTML = `
                    <div style="margin-bottom: 2rem;">
                        <div style="background: linear-gradient(135deg, #a8e6cf, #dcedc8); padding: 2rem; border-radius: 16px; color: #2d5016; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <span style="font-size: 3rem;"></span>
                                <h3 style="margin: 0; font-size: 1.8rem; color: #2d5016;">${currentStudent.name}</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Level</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${currentStudent.level || 'N/A'}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Rating</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${currentStudent.rating || RATING_CONFIG.DEFAULT_STUDENT_RATING}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Total Attempts</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${currentStudent.totalAttempts || 0}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Overall Success</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${overallSuccess}%</div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span style="font-size: 2rem;"></span>
                            <h3 style="color: #333; margin: 0; font-size: 1.5rem;">Topic Mastery</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.2rem; margin-bottom: 2rem;">
                `;

                // Sort topics by mastery percentage
                const sortedTopics = Object.entries(topicStats).sort((a, b) => {
                    const masteryA = a[1].attempted > 0 ? (a[1].correct / a[1].attempted) * 100 : 0;
                    const masteryB = b[1].attempted > 0 ? (b[1].correct / b[1].attempted) * 100 : 0;
                    return masteryB - masteryA;
                });

                // Pastel color palette for topics
                const pastelColors = [
                    { bg: '#ffe0e6', border: '#ffb3c1', text: '#8b1538', icon: '' }, // Pink
                    { bg: '#e0f2f1', border: '#b2dfdb', text: '#004d40', icon: '' }, // Teal
                    { bg: '#fff3e0', border: '#ffe0b2', text: '#e65100', icon: '' }, // Orange
                    { bg: '#e8eaf6', border: '#c5cae9', text: '#1a237e', icon: '' }, // Indigo
                    { bg: '#f3e5f5', border: '#e1bee7', text: '#4a148c', icon: '' }, // Purple
                    { bg: '#e0f7fa', border: '#b2ebf2', text: '#006064', icon: '' }, // Cyan
                    { bg: '#fff8e1', border: '#ffecb3', text: '#f57f17', icon: '' }, // Yellow
                    { bg: '#fce4ec', border: '#f8bbd0', text: '#880e4f', icon: '' }, // Pink
                    { bg: '#e8f5e9', border: '#c8e6c9', text: '#1b5e20', icon: '' }, // Green
                    { bg: '#fff9c4', border: '#fff59d', text: '#f57f17', icon: '' }, // Yellow
                ];

                sortedTopics.forEach(([topic, stats], index) => {
                    const mastery = stats.attempted > 0 ? (stats.correct / stats.attempted) * 100 : 0;
                    const colorIndex = index % pastelColors.length;
                    const colors = pastelColors[colorIndex];
                    
                    let masteryIcon = '';
                    let masteryEmoji = '';
                    if (mastery >= 80) {
                        masteryIcon = '';
                        masteryEmoji = '';
                    } else if (mastery >= 50) {
                        masteryIcon = '';
                        masteryEmoji = '';
                    } else if (mastery > 0) {
                        masteryIcon = '';
                        masteryEmoji = '';
                    } else {
                        masteryIcon = '';
                        masteryEmoji = '';
                    }

                    const progressColor = mastery >= 80 ? '#4CAF50' : mastery >= 50 ? '#FF9800' : mastery > 0 ? '#FFC107' : '#9E9E9E';

                    progressHTML += `
                        <div style="background: ${colors.bg}; padding: 1.5rem; border-radius: 16px; border: 2px solid ${colors.border}; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.8rem;">${colors.icon}</span>
                                    <h4 style="margin: 0; font-size: 1.1rem; color: ${colors.text}; font-weight: 600;">${topic}</h4>
                                </div>
                                <span style="font-size: 1.8rem;">${masteryIcon}</span>
                            </div>
                            <div style="margin-bottom: 0.8rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem;">
                                    <span style="font-size: 0.9rem; color: ${colors.text}; font-weight: 500;">${masteryEmoji} Mastery</span>
                                    <span style="font-weight: bold; color: ${progressColor}; font-size: 1.2rem;">${mastery.toFixed(1)}%</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.6); height: 24px; border-radius: 12px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="background: linear-gradient(90deg, ${progressColor}, ${progressColor}cc); height: 100%; width: ${Math.max(mastery, 2)}%; transition: width 0.8s ease; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                                </div>
                            </div>
                            <div style="font-size: 0.85rem; color: ${colors.text}; margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid ${colors.border};">
                                <div style="display: flex; justify-content: space-between;">
                                    <span> ${stats.correct} / ${stats.attempted} correct</span>
                                    <span> ${stats.total} questions</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                progressHTML += `</div>`;

                // Weak Questions Section
                if (weakQuestions.length > 0) {
                    progressHTML += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span style="font-size: 2rem;"></span>
                            <h3 style="color: #333; margin: 0; font-size: 1.5rem;">Questions Needing Practice</h3>
                        </div>
                        <div style="background: linear-gradient(135deg, #fff5f5, #ffe0e0); border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; border: 2px solid #ffb3b3;">
                            <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f); padding: 1rem; color: white;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;"></span>
                                    <span style="font-weight: 600;">Focus on these to improve!</span>
                                </div>
                            </div>
                            <div style="padding: 1rem;">
                    `;

                    weakQuestions.slice(0, 10).forEach((q, idx) => {
                        const bgColor = idx % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'rgba(255,255,255,0.3)';
                        progressHTML += `
                            <div style="background: ${bgColor}; padding: 1rem; border-radius: 12px; margin-bottom: 0.8rem; border-left: 4px solid #ff6b6b;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <div style="font-weight: 600; color: #333; margin-bottom: 0.3rem;"> ${q.title}</div>
                                    </div>
                                    <div style="display: flex; gap: 1.5rem; align-items: center;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666;">Attempts</div>
                                            <div style="font-weight: bold; color: #333;">${q.attempts}</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666;">Success</div>
                                            <div style="font-weight: bold; color: #ff6b6b; font-size: 1.1rem;">${q.successRate.toFixed(1)}%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    progressHTML += `
                            </div>
                        </div>
                    `;
                } else {
                    progressHTML += `
                        <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 2rem; border-radius: 16px; text-align: center; border: 2px solid #4CAF50; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                            <p style="margin: 0; font-size: 1.2rem; color: #155724; font-weight: 600;">Excellent work! No weak questions found.</p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 1rem; color: #2e7d32;">Keep up the amazing progress! </p>
                        </div>
                    `;
                }

                container.innerHTML = progressHTML;

            } catch (e) {
                console.error("Error loading my progress:", e);
                container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Error loading progress. Please try again.</p></div>';
            }
        };

        // View student progress (Admin only) - Now uses the same view as My Progress
        window.viewStudentProgress = async function(userId, studentIndex, studentName) {
            if (!window.isAdminUser) return;
            
            try {
                // Switch to my-progress view
                const progressBtn = document.getElementById('btn-sidebar-my-progress');
                if (progressBtn) {
                    window.switchTab('my-progress', progressBtn);
                }

                const container = document.getElementById('my-progress-container');
                if (!container) {
                    alert("Progress view not found.");
                    return;
                }

                // Update header to show student name
                const progressHeader = document.querySelector('#view-my-progress h2');
                if (progressHeader) {
                    progressHeader.innerHTML = ` ${studentName}'s Progress`;
                }

                container.innerHTML = '<div class="placeholder-content" id="my-progress-loading-msg"><p style="font-size: 1.2rem; color: #666;">Loading student progress...</p></div>';

                const { doc, getDoc, collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get user data
                const userDoc = await getDoc(doc(window.db_fs, "users", userId));
                if (!userDoc.exists()) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Student data not found.</p></div>';
                    return;
                }

                const userData = userDoc.data();
                const students = userData.students || [];
                const questionAttempts = userData.questionAttempts || {};

                if (!students[studentIndex]) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Student not found.</p></div>';
                    return;
                }

                const currentStudent = students[studentIndex];
                const studentKey = `student_${studentIndex}`;
                const studentQuestionAttempts = questionAttempts[studentKey] || {};

                // Hide student selector for admin view
                const studentSelector = document.getElementById('my-progress-student-selector');
                if (studentSelector) {
                    studentSelector.style.display = 'none';
                }

                // Get all questions from Firestore to determine topics
                const questionsSnapshot = await getDocs(collection(window.db_fs, "custom_questions"));
                const allQuestions = {};
                questionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const qId = `q-${doc.id}`;
                    allQuestions[qId] = {
                        id: qId,
                        title: data.title || 'Question',
                        topic: data.topic || 'General',
                        level: data.level || 'P6',
                        category: data.category || 'mcq'
                    };
                });

                // Also get questions from DOM (including hardcoded questions)
                document.querySelectorAll('.question-container[id]').forEach(container => {
                    const qId = container.id;
                    if (!allQuestions[qId]) {
                        // Try to determine topic from DOM
                        let topic = 'General';
                        const mcqParent = container.closest('[id^="topic-mcq-"]');
                        if (mcqParent) {
                            const topicId = mcqParent.id.replace('topic-mcq-', '');
                            if (window.mcqCurriculum) {
                                for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                                    const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                                    if (matchingTopic) {
                                        topic = matchingTopic;
                                        break;
                                    }
                                }
                            }
                        } else {
                            const topicParent = container.closest('[id^="topic-"]');
                            if (topicParent) {
                                const topicId = topicParent.id.replace('topic-', '').replace(/^(mcq|oeq|cer)-/, '');
                                topic = topicId.charAt(0).toUpperCase() + topicId.slice(1).replace(/-/g, ' ');
                            }
                        }
                        
                        allQuestions[qId] = {
                            id: qId,
                            title: container.querySelector('h3')?.textContent || 'Question',
                            topic: topic,
                            level: currentStudent.level || 'P6',
                            category: 'mcq'
                        };
                    }
                });

                // Also check for questions that have attempts but aren't in allQuestions yet
                Object.keys(studentQuestionAttempts).forEach(qId => {
                    if (!allQuestions[qId]) {
                        // Try to find in DOM
                        const container = document.getElementById(qId);
                        if (container) {
                            let topic = 'General';
                            const mcqParent = container.closest('[id^="topic-mcq-"]');
                            if (mcqParent) {
                                const topicId = mcqParent.id.replace('topic-mcq-', '');
                                if (window.mcqCurriculum) {
                                    for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                                        const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                                        if (matchingTopic) {
                                            topic = matchingTopic;
                                            break;
                                        }
                                    }
                                }
                            }
                            allQuestions[qId] = {
                                id: qId,
                                title: container.querySelector('h3')?.textContent || 'Question',
                                topic: topic,
                                level: currentStudent.level || 'P6',
                                category: 'mcq'
                            };
                        } else {
                            // Question not found, use generic info
                            allQuestions[qId] = {
                                id: qId,
                                title: 'Question',
                                topic: 'General',
                                level: currentStudent.level || 'P6',
                                category: 'mcq'
                            };
                        }
                    }
                });

                // Calculate topic mastery
                const topicStats = {};
                Object.keys(allQuestions).forEach(qId => {
                    const question = allQuestions[qId];
                    const topic = question.topic;
                    if (!topicStats[topic]) {
                        topicStats[topic] = { total: 0, attempted: 0, correct: 0, questions: [] };
                    }
                    topicStats[topic].total++;
                    
                    const attempt = studentQuestionAttempts[qId];
                    if (attempt) {
                        topicStats[topic].attempted += attempt.attempts;
                        topicStats[topic].correct += attempt.correct;
                        topicStats[topic].questions.push({
                            id: qId,
                            title: question.title,
                            attempts: attempt.attempts,
                            correct: attempt.correct,
                            successRate: attempt.attempts > 0 ? (attempt.correct / attempt.attempts) * 100 : 0
                        });
                    }
                });

                // Find weak questions (success rate < 50% and attempted at least once)
                const weakQuestions = [];
                Object.values(topicStats).forEach(topic => {
                    topic.questions.forEach(q => {
                        if (q.attempts > 0 && q.successRate < 50) {
                            weakQuestions.push(q);
                        }
                    });
                });
                weakQuestions.sort((a, b) => a.successRate - b.successRate);

                // Build progress HTML with beautiful pastel colors and emojis (same as loadMyProgress)
                const totalAttempted = Object.values(studentQuestionAttempts).reduce((sum, a) => sum + (a.attempts || 0), 0);
                const totalCorrect = Object.values(studentQuestionAttempts).reduce((sum, a) => sum + (a.correct || 0), 0);
                const overallSuccess = totalAttempted > 0 ? (totalCorrect / totalAttempted * 100).toFixed(1) : 0;

                let progressHTML = `
                    <div style="margin-bottom: 2rem;">
                        <div style="background: linear-gradient(135deg, #a8e6cf, #dcedc8); padding: 2rem; border-radius: 16px; color: #2d5016; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <span style="font-size: 3rem;"></span>
                                <h3 style="margin: 0; font-size: 1.8rem; color: #2d5016;">${currentStudent.name}</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Level</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${currentStudent.level || 'N/A'}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Rating</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${currentStudent.rating || RATING_CONFIG.DEFAULT_STUDENT_RATING}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Total Attempts</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${currentStudent.totalAttempts || 0}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 12px;">
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;"> Overall Success</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #2d5016;">${overallSuccess}%</div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span style="font-size: 2rem;"></span>
                            <h3 style="color: #333; margin: 0; font-size: 1.5rem;">Topic Mastery</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.2rem; margin-bottom: 2rem;">
                `;

                // Sort topics by mastery percentage
                const sortedTopics = Object.entries(topicStats).sort((a, b) => {
                    const masteryA = a[1].attempted > 0 ? (a[1].correct / a[1].attempted) * 100 : 0;
                    const masteryB = b[1].attempted > 0 ? (b[1].correct / b[1].attempted) * 100 : 0;
                    return masteryB - masteryA;
                });

                // Pastel color palette for topics
                const pastelColors = [
                    { bg: '#ffe0e6', border: '#ffb3c1', text: '#8b1538', icon: '' }, // Pink
                    { bg: '#e0f2f1', border: '#b2dfdb', text: '#004d40', icon: '' }, // Teal
                    { bg: '#fff3e0', border: '#ffe0b2', text: '#e65100', icon: '' }, // Orange
                    { bg: '#e8eaf6', border: '#c5cae9', text: '#1a237e', icon: '' }, // Indigo
                    { bg: '#f3e5f5', border: '#e1bee7', text: '#4a148c', icon: '' }, // Purple
                    { bg: '#e0f7fa', border: '#b2ebf2', text: '#006064', icon: '' }, // Cyan
                    { bg: '#fff8e1', border: '#ffecb3', text: '#f57f17', icon: '' }, // Yellow
                    { bg: '#fce4ec', border: '#f8bbd0', text: '#880e4f', icon: '' }, // Pink
                    { bg: '#e8f5e9', border: '#c8e6c9', text: '#1b5e20', icon: '' }, // Green
                    { bg: '#fff9c4', border: '#fff59d', text: '#f57f17', icon: '' }, // Yellow
                ];

                sortedTopics.forEach(([topic, stats], index) => {
                    const mastery = stats.attempted > 0 ? (stats.correct / stats.attempted) * 100 : 0;
                    const colorIndex = index % pastelColors.length;
                    const colors = pastelColors[colorIndex];
                    
                    let masteryIcon = '';
                    let masteryEmoji = '';
                    if (mastery >= 80) {
                        masteryIcon = '';
                        masteryEmoji = '';
                    } else if (mastery >= 50) {
                        masteryIcon = '';
                        masteryEmoji = '';
                    } else if (mastery > 0) {
                        masteryIcon = '';
                        masteryEmoji = '';
                    } else {
                        masteryIcon = '';
                        masteryEmoji = '';
                    }

                    const progressColor = mastery >= 80 ? '#4CAF50' : mastery >= 50 ? '#FF9800' : mastery > 0 ? '#FFC107' : '#9E9E9E';

                    progressHTML += `
                        <div style="background: ${colors.bg}; padding: 1.5rem; border-radius: 16px; border: 2px solid ${colors.border}; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.8rem;">${colors.icon}</span>
                                    <h4 style="margin: 0; font-size: 1.1rem; color: ${colors.text}; font-weight: 600;">${topic}</h4>
                                </div>
                                <span style="font-size: 1.8rem;">${masteryIcon}</span>
                            </div>
                            <div style="margin-bottom: 0.8rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem;">
                                    <span style="font-size: 0.9rem; color: ${colors.text}; font-weight: 500;">${masteryEmoji} Mastery</span>
                                    <span style="font-weight: bold; color: ${progressColor}; font-size: 1.2rem;">${mastery.toFixed(1)}%</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.6); height: 24px; border-radius: 12px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="background: linear-gradient(90deg, ${progressColor}, ${progressColor}cc); height: 100%; width: ${Math.max(mastery, 2)}%; transition: width 0.8s ease; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                                </div>
                            </div>
                            <div style="font-size: 0.85rem; color: ${colors.text}; margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid ${colors.border};">
                                <div style="display: flex; justify-content: space-between;">
                                    <span> ${stats.correct} / ${stats.attempted} correct</span>
                                    <span> ${stats.total} questions</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                progressHTML += `</div>`;

                // Weak Questions Section
                if (weakQuestions.length > 0) {
                    progressHTML += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <span style="font-size: 2rem;"></span>
                            <h3 style="color: #333; margin: 0; font-size: 1.5rem;">Questions Needing Practice</h3>
                        </div>
                        <div style="background: linear-gradient(135deg, #fff5f5, #ffe0e0); border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; border: 2px solid #ffb3b3;">
                            <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f); padding: 1rem; color: white;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;"></span>
                                    <span style="font-weight: 600;">Focus on these to improve!</span>
                                </div>
                            </div>
                            <div style="padding: 1rem;">
                    `;

                    weakQuestions.slice(0, 10).forEach((q, idx) => {
                        const bgColor = idx % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'rgba(255,255,255,0.3)';
                        progressHTML += `
                            <div style="background: ${bgColor}; padding: 1rem; border-radius: 12px; margin-bottom: 0.8rem; border-left: 4px solid #ff6b6b;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <div style="font-weight: 600; color: #333; margin-bottom: 0.3rem;"> ${q.title}</div>
                                    </div>
                                    <div style="display: flex; gap: 1.5rem; align-items: center;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666;">Attempts</div>
                                            <div style="font-weight: bold; color: #333;">${q.attempts}</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666;">Success</div>
                                            <div style="font-weight: bold; color: #ff6b6b; font-size: 1.1rem;">${q.successRate.toFixed(1)}%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    progressHTML += `
                            </div>
                        </div>
                    `;
                } else {
                    progressHTML += `
                        <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 2rem; border-radius: 16px; text-align: center; border: 2px solid #4CAF50; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                            <p style="margin: 0; font-size: 1.2rem; color: #155724; font-weight: 600;">Excellent work! No weak questions found.</p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 1rem; color: #2e7d32;">Keep up the amazing progress! </p>
                        </div>
                    `;
                }

                container.innerHTML = progressHTML;

            } catch (e) {
                console.error("Error loading student progress:", e);
                const container = document.getElementById('my-progress-container');
                if (container) {
                    container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Error loading student progress. Please try again.</p></div>';
                }
            }
        };

        // Sort questions by priority for deliberate practice
        window.sortQuestionsByPriority = function(questions, studentRating) {
            return questions.sort((a, b) => {
                // Priority 1: Review questions (spaced repetition)
                if (a.isReviewQuestion !== b.isReviewQuestion) {
                    return a.isReviewQuestion ? -1 : 1;
                }
                
                // Priority 2: New questions (never attempted)
                if (a.answered !== b.answered) {
                    return a.answered ? 1 : -1;
                }
                
                // Priority 3: Growth zone questions
                const aInGrowthZone = isInGrowthZone(studentRating, a.questionRating || RATING_CONFIG.DEFAULT_QUESTION_RATING);
                const bInGrowthZone = isInGrowthZone(studentRating, b.questionRating || RATING_CONFIG.DEFAULT_QUESTION_RATING);
                
                if (aInGrowthZone !== bInGrowthZone) {
                    return aInGrowthZone ? -1 : 1;
                }
                
                // Priority 4: Questions closest to optimal challenge (55% expected success)
                const optimalExpected = 0.55;
                const aExpected = calculateExpectedSuccess(studentRating, a.questionRating || RATING_CONFIG.DEFAULT_QUESTION_RATING);
                const bExpected = calculateExpectedSuccess(studentRating, b.questionRating || RATING_CONFIG.DEFAULT_QUESTION_RATING);
                
                const aDiff = Math.abs(aExpected - optimalExpected);
                const bDiff = Math.abs(bExpected - optimalExpected);
                
                return aDiff - bDiff;
            });
        };

        // =====================================================
        // QUESTION LIST PAGE FUNCTIONS
        // =====================================================

        window.allQuestionsList = [];
        window.filteredQuestionsList = [];

        // Load all questions for the question list page
        window.loadQuestionList = async function() {
            const container = document.getElementById('question-list-container');
            if (!container) return;

            container.innerHTML = '<div class="placeholder-content" id="question-list-loading-msg"><p style="font-size: 1.2rem; color: #666;">Loading questions...</p></div>';

            try {
                // Load question ratings if available
                if (window.loadQuestionRatings) {
                    await window.loadQuestionRatings();
                }

                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get questions from Firestore
                const questionsSnapshot = await getDocs(collection(window.db_fs, "custom_questions"));
                const allQuestions = [];

                questionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const qId = `q-${doc.id}`;
                    const ratingData = window.getQuestionRating ? window.getQuestionRating(qId) : { rating: RATING_CONFIG.DEFAULT_QUESTION_RATING };
                    
                    allQuestions.push({
                        id: qId,
                        firestoreId: doc.id,
                        title: data.title || 'Question',
                        html: data.html || '',
                        topic: data.topic || 'General',
                        level: data.level || 'P6',
                        category: data.category || 'mcq',
                        rating: ratingData.rating || RATING_CONFIG.DEFAULT_QUESTION_RATING,
                        createdAt: data.createdAt || data.updatedAt || new Date().toISOString(),
                        fromFirestore: true
                    });
                });

                // Get questions from DOM (hardcoded questions)
                document.querySelectorAll('.question-container[id]').forEach(container => {
                    const qId = container.id;
                    // Skip if already in Firestore list
                    if (allQuestions.find(q => q.id === qId)) return;

                    // Get title
                    const titleEl = container.querySelector('h3, h4');
                    const title = titleEl ? titleEl.textContent.trim() : 'Question';

                    // Get topic
                    let topic = 'General';
                    const mcqParent = container.closest('[id^="topic-mcq-"]');
                    if (mcqParent) {
                        const topicId = mcqParent.id.replace('topic-mcq-', '');
                        if (window.mcqCurriculum) {
                            for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                                const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                                if (matchingTopic) {
                                    topic = matchingTopic;
                                    break;
                                }
                            }
                        }
                    } else {
                        const topicParent = container.closest('[id^="topic-"]');
                        if (topicParent) {
                            const topicId = topicParent.id.replace('topic-', '').replace(/^(mcq|oeq|cer)-/, '');
                            topic = topicId.charAt(0).toUpperCase() + topicId.slice(1).replace(/-/g, ' ');
                        }
                    }

                    // Get level
                    let level = 'P6';
                    const levelParent = container.closest('[id^="topic-mcq-"]');
                    if (levelParent && window.mcqCurriculum) {
                        for (const [lvl, topics] of Object.entries(window.mcqCurriculum)) {
                            const topicId = levelParent.id.replace('topic-mcq-', '');
                            if (topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId)) {
                                level = lvl;
                                break;
                            }
                        }
                    } else {
                        level = window.currentMcqLevel || window.currentOeqLevel || 'P6';
                    }

                    // Get rating
                    const ratingData = window.getQuestionRating ? window.getQuestionRating(qId) : { rating: RATING_CONFIG.DEFAULT_QUESTION_RATING };
                    
                    // Get HTML content
                    const questionBody = container.querySelector('.question-body, .mcq-body');
                    const html = questionBody ? questionBody.innerHTML : container.innerHTML;

                    // Determine category
                    const category = container.querySelector('.mcq-container') ? 'mcq' : 'oeq';

                    allQuestions.push({
                        id: qId,
                        title: title,
                        html: html,
                        topic: topic,
                        level: level,
                        category: category,
                        rating: ratingData.rating || RATING_CONFIG.DEFAULT_QUESTION_RATING,
                        createdAt: new Date(0).toISOString(), // DOM questions have no date
                        fromFirestore: false
                    });
                });

                window.allQuestionsList = allQuestions;
                window.filteredQuestionsList = [...allQuestions];

                // Populate topic filter
                const topicFilter = document.getElementById('question-list-filter-topic');
                if (topicFilter) {
                    const topics = [...new Set(allQuestions.map(q => q.topic))].sort();
                    topicFilter.innerHTML = '<option value="">All Topics</option>';
                    topics.forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic;
                        option.textContent = topic;
                        topicFilter.appendChild(option);
                    });
                }

                // Apply initial sort and render
                performSort();

            } catch (e) {
                console.error("Error loading question list:", e);
                container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #dc3545;">Error loading questions. Please try again.</p></div>';
            }
        };

        // Current sort state
        window.currentQuestionSort = { field: 'rating', order: 'desc' };

        // Render the question list as a table
        function renderQuestionList() {
            const container = document.getElementById('question-list-container');
            if (!container) return;

            if (window.filteredQuestionsList.length === 0) {
                container.innerHTML = '<div class="placeholder-content"><p style="font-size: 1.2rem; color: #666;">No questions found.</p></div>';
                return;
            }

            const sortField = window.currentQuestionSort.field;
            const sortOrder = window.currentQuestionSort.order;

            // Helper to get sort indicator
            const getSortIndicator = (field) => {
                if (sortField !== field) return '';
                return sortOrder === 'asc' ? '' : '';
            };

            let html = `
                <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="btn" style="background: #4CAF50; color: white; padding: 0.75rem 1.5rem; font-weight: 600;" onclick="addSelectedQuestionsToWorksheet()">
                             Add Selected to Worksheet
                        </button>
                        <span id="selected-count" style="color: #666; font-size: 0.9rem;">0 selected</span>
                    </div>
                    <button class="btn" style="background: #2196F3; color: white; padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="selectAllQuestions()">
                        Select All
                    </button>
                </div>
                <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                <th style="padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; width: 40px; font-size: 0.85rem;">
                                    <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)" style="cursor: pointer; width: 16px; height: 16px;">
                                </th>
                                <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; cursor: pointer; user-select: none; transition: background 0.2s; font-size: 0.85rem; min-width: 200px;" 
                                    onclick="sortByColumn('title')"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                    onmouseout="this.style.background='transparent'">
                                    Title ${getSortIndicator('title')}
                                </th>
                                <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; cursor: pointer; user-select: none; transition: background 0.2s; font-size: 0.85rem; min-width: 150px;" 
                                    onclick="sortByColumn('topic')"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                    onmouseout="this.style.background='transparent'">
                                    Topic ${getSortIndicator('topic')}
                                </th>
                                <th style="padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; cursor: pointer; user-select: none; transition: background 0.2s; font-size: 0.85rem; width: 80px;" 
                                    onclick="sortByColumn('level')"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                    onmouseout="this.style.background='transparent'">
                                    Level ${getSortIndicator('level')}
                                </th>
                                <th style="padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; cursor: pointer; user-select: none; transition: background 0.2s; font-size: 0.85rem; width: 90px;" 
                                    onclick="sortByColumn('rating')"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                    onmouseout="this.style.background='transparent'">
                                    Rating ${getSortIndicator('rating')}
                                </th>
                                <th style="padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; cursor: pointer; user-select: none; transition: background 0.2s; font-size: 0.85rem; width: 80px;" 
                                    onclick="sortByColumn('category')"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                    onmouseout="this.style.background='transparent'">
                                    Type ${getSortIndicator('category')}
                                </th>
                                <th style="padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; cursor: pointer; user-select: none; transition: background 0.2s; font-size: 0.85rem; width: 120px;" 
                                    onclick="sortByColumn('date')"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                    onmouseout="this.style.background='transparent'">
                                    Date Added ${getSortIndicator('date')}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            window.filteredQuestionsList.forEach((question, index) => {
                let date = 'N/A';
                if (question.createdAt) {
                    try {
                        const dateObj = new Date(question.createdAt);
                        if (!isNaN(dateObj.getTime())) {
                            date = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                        }
                    } catch (e) {
                        date = 'N/A';
                    }
                }
                const ratingColor = question.rating >= 1500 ? '#4CAF50' : question.rating >= 1200 ? '#FF9800' : '#9E9E9E';
                const categoryIcon = question.category === 'mcq' ? ' MCQ' : ' OEQ';
                const sourceBadge = question.fromFirestore ? '<span style="font-size: 0.7rem; background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">Custom</span>' : '';

                html += `
                    <tr style="border-bottom: 1px solid #eee; transition: background 0.2s;" 
                        onmouseover="this.style.background='#f5f5f5'"
                        onmouseout="this.style.background='white'">
                        <td style="padding: 0.75rem 0.5rem; text-align: center;" onclick="event.stopPropagation();">
                            <input type="checkbox" class="question-checkbox" data-question-id="${question.id}" onchange="updateSelectedCount()" style="cursor: pointer; width: 16px; height: 16px;">
                        </td>
                        <td style="padding: 0.75rem 0.5rem; color: #333; cursor: pointer; font-size: 0.85rem;" onclick="showQuestionPopup('${question.id.replace(/'/g, "\\'")}', ${index})">
                            <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px;">
                                ${question.title}${sourceBadge}
                            </div>
                        </td>
                        <td style="padding: 0.75rem 0.5rem; color: #666; cursor: pointer; font-size: 0.85rem;" onclick="showQuestionPopup('${question.id.replace(/'/g, "\\'")}', ${index})">
                            <span style="background: #f5f5f5; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">
                                 ${question.topic}
                            </span>
                        </td>
                        <td style="padding: 0.75rem 0.5rem; text-align: center; color: #1976d2; cursor: pointer; font-size: 0.85rem;" onclick="showQuestionPopup('${question.id.replace(/'/g, "\\'")}', ${index})">
                            <span style="background: #e3f2fd; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">
                                 ${question.level}
                            </span>
                        </td>
                        <td style="padding: 0.75rem 0.5rem; text-align: center; cursor: pointer; font-size: 0.85rem;" onclick="showQuestionPopup('${question.id.replace(/'/g, "\\'")}', ${index})">
                            <span style="background: ${ratingColor}15; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; color: ${ratingColor}; font-weight: 600; white-space: nowrap;">
                                 ${question.rating}
                            </span>
                        </td>
                        <td style="padding: 0.75rem 0.5rem; text-align: center; color: #7b1fa2; cursor: pointer; font-size: 0.85rem;" onclick="showQuestionPopup('${question.id.replace(/'/g, "\\'")}', ${index})">
                            <span style="background: #f3e5f5; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">
                                ${categoryIcon}
                            </span>
                        </td>
                        <td style="padding: 0.75rem 0.5rem; text-align: center; color: #999; font-size: 0.75rem; cursor: pointer; white-space: nowrap;" onclick="showQuestionPopup('${question.id.replace(/'/g, "\\'")}', ${index})">
                            ${question.fromFirestore ? ` ${date}` : ' Built-in'}
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = html;
            updateSelectedCount();
        }

        // Toggle select all
        window.toggleSelectAll = function(checked) {
            const checkboxes = document.querySelectorAll('.question-checkbox');
            checkboxes.forEach(cb => cb.checked = checked);
            updateSelectedCount();
        };

        // Select all questions
        window.selectAllQuestions = function() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = true;
                toggleSelectAll(true);
            }
        };

        // Update selected count
        window.updateSelectedCount = function() {
            const selectedCount = document.querySelectorAll('.question-checkbox:checked').length;
            const countElement = document.getElementById('selected-count');
            if (countElement) {
                countElement.textContent = `${selectedCount} selected`;
            }
            // Update select all checkbox state
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const allCheckboxes = document.querySelectorAll('.question-checkbox');
            if (selectAllCheckbox && allCheckboxes.length > 0) {
                selectAllCheckbox.checked = selectedCount === allCheckboxes.length;
            }
        };

        // Add selected questions to worksheet
        window.addSelectedQuestionsToWorksheet = async function() {
            const selectedCheckboxes = document.querySelectorAll('.question-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one question to add to the worksheet.');
                return;
            }

            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.questionId);
            let addedCount = 0;
            let skippedCount = 0;

            for (const questionId of selectedIds) {
                // Check if already in worksheet
                if (window.worksheetItems.some(item => item.id === questionId)) {
                    skippedCount++;
                    continue;
                }

                // Find question in the list
                const question = window.allQuestionsList.find(q => q.id === questionId);
                if (!question) continue;

                try {
                    // Try to get question from DOM first
                    const questionContainer = document.getElementById(questionId);
                    
                    if (questionContainer) {
                        // Question exists in DOM, clone it
                        const clone = questionContainer.cloneNode(true);
                        
                        // Remove UI elements from the clone
                        clone.querySelectorAll('.admin-controls, .worksheet-control-bar, .controls, .feedback-icon').forEach(el => el.remove());
                        
                        // Reset any input states in the clone
                        clone.querySelectorAll('.answer-input').forEach(input => {
                            input.disabled = false;
                            input.value = '';
                            input.style.borderBottomColor = '';
                        });
                        
                        // Get the cleaned HTML
                        const cleanedHtml = clone.innerHTML;
                        
                        window.worksheetItems.push({
                            id: questionId,
                            title: question.title,
                            html: cleanedHtml,
                            addedAt: new Date().toISOString()
                        });
                    } else {
                        // Question not in DOM, use stored HTML
                        // Clean the HTML if needed
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = question.html;
                        
                        // Remove unwanted elements
                        tempDiv.querySelectorAll('.admin-controls, .worksheet-control-bar, .controls, .feedback-icon').forEach(el => el.remove());
                        
                        // Reset inputs
                        tempDiv.querySelectorAll('.answer-input').forEach(input => {
                            input.disabled = false;
                            input.value = '';
                            input.style.borderBottomColor = '';
                        });
                        
                        const processedHtml = tempDiv.innerHTML;
                        
                        window.worksheetItems.push({
                            id: questionId,
                            title: question.title,
                            html: processedHtml,
                            addedAt: new Date().toISOString()
                        });
                    }
                    
                    addedCount++;
                } catch (e) {
                    console.error(`Error adding question ${questionId}:`, e);
                }
            }

            // Save and update UI
            if (window.saveWorksheetToStorage) {
                window.saveWorksheetToStorage();
            }
            if (window.updateWorksheetUI) {
                window.updateWorksheetUI();
            }

            // Uncheck all checkboxes
            selectedCheckboxes.forEach(cb => cb.checked = false);
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateSelectedCount();

            // Show success message
            let message = ` Successfully added ${addedCount} question${addedCount !== 1 ? 's' : ''} to your worksheet!`;
            if (skippedCount > 0) {
                message += `\n\n${skippedCount} question${skippedCount !== 1 ? 's were' : ' was'} already in your worksheet and ${skippedCount !== 1 ? 'were' : 'was'} skipped.`;
            }
            alert(message);
        };

        // Sort by column header click
        window.sortByColumn = function(field) {
            if (!window.filteredQuestionsList) return;

            // Toggle order if clicking the same column, otherwise default to desc
            if (window.currentQuestionSort.field === field) {
                window.currentQuestionSort.order = window.currentQuestionSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                window.currentQuestionSort.field = field;
                window.currentQuestionSort.order = 'desc';
            }

            // Update dropdown to match
            const sortSelect = document.getElementById('question-list-sort');
            if (sortSelect) {
                const order = window.currentQuestionSort.order;
                let value = '';
                switch (field) {
                    case 'rating':
                        value = `rating-${order}`;
                        break;
                    case 'topic':
                        value = `topic-${order === 'desc' ? 'desc' : 'asc'}`;
                        break;
                    case 'date':
                        value = `date-${order}`;
                        break;
                    case 'level':
                        value = `level-${order === 'desc' ? 'desc' : 'asc'}`;
                        break;
                    case 'title':
                        value = `topic-${order === 'desc' ? 'desc' : 'asc'}`; // Use topic sort for title
                        break;
                    case 'category':
                        value = `topic-${order === 'desc' ? 'desc' : 'asc'}`; // Use topic sort for category
                        break;
                }
                if (value) sortSelect.value = value;
            }

            performSort();
        };

        // Perform the actual sorting
        function performSort() {
            if (!window.filteredQuestionsList) return;

            const sortField = window.currentQuestionSort.field;
            const sortOrder = window.currentQuestionSort.order;

            window.filteredQuestionsList.sort((a, b) => {
                let aVal, bVal;

                switch (sortField) {
                    case 'rating':
                        aVal = a.rating;
                        bVal = b.rating;
                        break;
                    case 'topic':
                        aVal = a.topic.toLowerCase();
                        bVal = b.topic.toLowerCase();
                        break;
                    case 'title':
                        aVal = a.title.toLowerCase();
                        bVal = b.title.toLowerCase();
                        break;
                    case 'date':
                        aVal = new Date(a.createdAt || 0).getTime();
                        bVal = new Date(b.createdAt || 0).getTime();
                        break;
                    case 'level':
                        const levelOrder = { 'P3': 1, 'P4': 2, 'P5': 3, 'P6': 4 };
                        aVal = levelOrder[a.level] || 5;
                        bVal = levelOrder[b.level] || 5;
                        break;
                    case 'category':
                        aVal = a.category.toLowerCase();
                        bVal = b.category.toLowerCase();
                        break;
                    default:
                        return 0;
                }

                if (sortOrder === 'desc') {
                    return bVal > aVal ? 1 : bVal < aVal ? -1 : 0;
                } else {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                }
            });

            renderQuestionList();
        }

        // Sort question list (from dropdown)
        window.sortQuestionList = function() {
            const sortSelect = document.getElementById('question-list-sort');
            if (!sortSelect || !window.filteredQuestionsList) return;

            const sortValue = sortSelect.value;
            const [sortBy, order] = sortValue.split('-');

            // Map dropdown values to table column fields
            let field = sortBy;
            if (sortBy === 'rating') field = 'rating';
            else if (sortBy === 'topic') field = 'topic';
            else if (sortBy === 'date') field = 'date';
            else if (sortBy === 'level') field = 'level';

            window.currentQuestionSort.field = field;
            window.currentQuestionSort.order = order;

            performSort();
        };

        // Filter question list
        window.filterQuestionList = function() {
            if (!window.allQuestionsList) return;

            const topicFilter = document.getElementById('question-list-filter-topic')?.value || '';
            const levelFilter = document.getElementById('question-list-filter-level')?.value || '';
            const searchInput = document.getElementById('question-list-search')?.value.toLowerCase() || '';

            window.filteredQuestionsList = window.allQuestionsList.filter(question => {
                const matchesTopic = !topicFilter || question.topic === topicFilter;
                const matchesLevel = !levelFilter || question.level === levelFilter;
                const matchesSearch = !searchInput ||
                    question.title.toLowerCase().includes(searchInput) ||
                    question.topic.toLowerCase().includes(searchInput);

                return matchesTopic && matchesLevel && matchesSearch;
            });

            // Apply current sort
            performSort();
        };

        // Debounced version of filterQuestionList for search input
        window.debouncedFilterQuestionList = window.debounce(window.filterQuestionList, 300);

        // Show question popup
        window.showQuestionPopup = function(questionId, listIndex) {
            let question = window.filteredQuestionsList[listIndex];
            if (!question) {
                // Try to find by ID
                const found = window.allQuestionsList.find(q => q.id === questionId);
                if (!found) {
                    alert('Question not found');
                    return;
                }
                question = found;
            }

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay visible';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal-box" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #667eea; padding-bottom: 1rem;">
                        <h3 style="margin: 0; color: #667eea;">${question.title}</h3>
                        <button class="btn" style="background: #666; color: white;" onclick="this.closest('.modal-overlay').remove()"> Close</button>
                    </div>
                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <span style="background: #f5f5f5; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; color: #666;">
                             ${question.topic}
                        </span>
                        <span style="background: #e3f2fd; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; color: #1976d2;">
                             ${question.level}
                        </span>
                        <span style="background: #fff3e0; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; color: #e65100; font-weight: 600;">
                             Rating: ${question.rating}
                        </span>
                        <span style="background: #f3e5f5; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; color: #7b1fa2;">
                            ${question.category === 'mcq' ? ' MCQ' : ' OEQ'}
                        </span>
                    </div>
                    <div class="question-body" style="background: #f9f9f9; padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                        ${question.html || '<p style="color: #999;">Question content not available.</p>'}
                    </div>
                    <div id="popup-submit-area" style="margin-top: 1rem; text-align: center;"></div>
                    <div id="popup-result-area" style="margin-top: 1rem; display: none;"></div>
                </div>
            `;
            document.body.appendChild(modal);

            // Setup question functionality
            setTimeout(() => {
                const bodyDiv = modal.querySelector('.question-body');
                const submitArea = modal.querySelector('#popup-submit-area');
                const resultArea = modal.querySelector('#popup-result-area');

                if (bodyDiv) {
                    bodyDiv.id = question.id + '-popup-body';

                    // Hide any existing explanation boxes initially
                    bodyDiv.querySelectorAll('.explanation-box').forEach(e => e.style.display = 'none');

                    // Check if it's an MCQ question
                    const mcqContainer = bodyDiv.querySelector('.mcq-container');
                    const hasRadios = bodyDiv.querySelectorAll('input[type="radio"]').length > 0;

                    if (mcqContainer || hasRadios) {
                        // MCQ Question - Add submit button
                        const uniqueName = 'popup-mcq-' + question.id + '-' + Date.now();
                        bodyDiv.querySelectorAll('input[type="radio"]').forEach((radio, idx) => {
                            radio.name = uniqueName;
                            radio.checked = false;
                            radio.disabled = false;
                        });

                        // Reset option styling
                        bodyDiv.querySelectorAll('label, .mcq-option').forEach(opt => {
                            opt.style.borderColor = '';
                            opt.style.background = '';
                            opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());
                        });

                        // Remove any existing submit buttons from inside the body
                        bodyDiv.querySelectorAll('.submit-btn, button[onclick*="check"]').forEach(b => b.remove());

                        // Create submit button in submit area
                        const submitBtn = document.createElement('button');
                        submitBtn.className = 'btn btn-primary';
                        submitBtn.style.cssText = 'background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600;';
                        submitBtn.textContent = 'Submit Answer';
                        submitBtn.onclick = function() {
                            const selected = bodyDiv.querySelector('input[type="radio"]:checked');
                            if (!selected) {
                                alert('Please select an answer.');
                                return;
                            }

                            const isCorrect = selected.dataset.correct === 'true';

                            // Show correct/incorrect styling
                            bodyDiv.querySelectorAll('label, .mcq-option').forEach(opt => {
                                const radio = opt.querySelector('input[type="radio"]');
                                opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());

                                if (radio) {
                                    radio.disabled = true;
                                    if (radio.dataset.correct === 'true') {
                                        opt.style.background = '#d4edda';
                                        opt.style.borderColor = '#28a745';
                                        const icon = document.createElement('span');
                                        icon.className = 'option-feedback-icon';
                                        icon.textContent = ' ';
                                        icon.style.cssText = 'font-size: 1.2rem; font-weight: bold; color: #28a745; margin-left: 8px;';
                                        opt.appendChild(icon);
                                    } else if (radio.checked && !isCorrect) {
                                        opt.style.background = '#f8d7da';
                                        opt.style.borderColor = '#dc3545';
                                        const icon = document.createElement('span');
                                        icon.className = 'option-feedback-icon';
                                        icon.textContent = ' ';
                                        icon.style.cssText = 'font-size: 1.2rem; font-weight: bold; color: #dc3545; margin-left: 8px;';
                                        opt.appendChild(icon);
                                    }
                                }
                            });

                            // Hide submit button
                            submitBtn.style.display = 'none';

                            // Show result
                            resultArea.style.display = 'block';
                            resultArea.innerHTML = isCorrect
                                ? '<div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 1.1rem;"> Correct! Well done!</div>'
                                : '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 1.1rem;"> Incorrect. Check the explanation below.</div>';

                            // Show explanation box if it exists
                            const explanationBox = bodyDiv.querySelector('.explanation-box');
                            if (explanationBox) {
                                explanationBox.style.display = 'block';
                                explanationBox.style.marginTop = '1rem';
                                explanationBox.style.background = '#e3f2fd';
                                explanationBox.style.padding = '15px';
                                explanationBox.style.borderRadius = '8px';
                                explanationBox.style.borderLeft = '4px solid #1976d2';
                            }

                            // Show video container if it exists
                            const videoContainer = bodyDiv.querySelector('.video-container');
                            if (videoContainer) {
                                videoContainer.style.display = 'block';
                            }
                        };
                        submitArea.appendChild(submitBtn);
                    } else {
                        // OEQ or fill-in-the-blank question - use setupQuestionFormGlobal
                        if (window.setupQuestionFormGlobal) {
                            window.setupQuestionFormGlobal(bodyDiv.id);
                        }
                    }
                }
            }, 100);

            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        };

        // Load wrong answers that are due for review
        window.loadWrongAnswersForReview = async function() {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const studentIndex = window.practiceState.currentStudent?.index || 0;
                const storageKey = `wrongAnswers_${user.uid}_${studentIndex}`;
                const stored = localStorage.getItem(storageKey);
                
                if (stored) {
                    window.practiceState.wrongAnswersForReview = JSON.parse(stored);
                } else {
                    window.practiceState.wrongAnswersForReview = {};
                }
            } catch (e) {
                console.error("Error loading wrong answers:", e);
                window.practiceState.wrongAnswersForReview = {};
            }
        };

        // Save wrong answer for 7-day review
        window.saveWrongAnswerForReview = function(questionId) {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const studentIndex = window.practiceState.currentStudent?.index || 0;
                const storageKey = `wrongAnswers_${user.uid}_${studentIndex}`;
                
                // Store the timestamp when the question was answered wrong
                window.practiceState.wrongAnswersForReview[questionId] = Date.now();
                
                localStorage.setItem(storageKey, JSON.stringify(window.practiceState.wrongAnswersForReview));
            } catch (e) {
                console.error("Error saving wrong answer:", e);
            }
        };

        // Remove question from review queue (when answered correctly after review)
        window.removeFromReviewQueue = function(questionId) {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const studentIndex = window.practiceState.currentStudent?.index || 0;
                const storageKey = `wrongAnswers_${user.uid}_${studentIndex}`;
                
                delete window.practiceState.wrongAnswersForReview[questionId];
                
                localStorage.setItem(storageKey, JSON.stringify(window.practiceState.wrongAnswersForReview));
            } catch (e) {
                console.error("Error removing from review queue:", e);
            }
        };

        // Check if a question is due for review (7 days after wrong answer)
        window.isQuestionDueForReview = function(questionId) {
            const wrongTimestamp = window.practiceState.wrongAnswersForReview[questionId];
            if (!wrongTimestamp) return false;
            
            const now = Date.now();
            const sevenDaysMs = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds
            
            return (now - wrongTimestamp) >= sevenDaysMs;
        };

        // Get days until review for a question
        window.getDaysUntilReview = function(questionId) {
            const wrongTimestamp = window.practiceState.wrongAnswersForReview[questionId];
            if (!wrongTimestamp) return null;
            
            const now = Date.now();
            const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
            const timeUntilReview = (wrongTimestamp + sevenDaysMs) - now;
            
            if (timeUntilReview <= 0) return 0;
            return Math.ceil(timeUntilReview / (24 * 60 * 60 * 1000));
        };

        window.loadPracticeMode = async function() {
            const select = document.getElementById('practice-student-select');
            select.innerHTML = '<option value="">-- Select Student --</option>';
            
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    let students = data.students || [];
                    
                    // Backwards compatibility: if no students array, create one from old format
                    if (students.length === 0 && data.studentName) {
                        students.push({ name: data.studentName, level: data.level || 'P6' });
                    }
                    
                    // If admin user and no students, add default P6 student for testing
                    if (window.isAdminUser && students.length === 0) {
                        students.push({ name: 'Admin', level: 'P6' });
                    }
                    
                    // If admin user, also add an "Admin (P6)" option at the top for testing
                    if (window.isAdminUser) {
                        const adminOption = document.createElement('option');
                        adminOption.value = 'admin';
                        adminOption.textContent = 'Admin Test Mode (P6)';
                        adminOption.dataset.name = 'Admin';
                        adminOption.dataset.level = 'P6';
                        select.appendChild(adminOption);
                    }
                    
                    students.forEach((student, idx) => {
                        const option = document.createElement('option');
                        option.value = idx;
                        option.textContent = `${student.name} (${student.level})`;
                        option.dataset.name = student.name;
                        option.dataset.level = student.level;
                        select.appendChild(option);
                    });
                    
                    window.userStudents = students;
                } else if (window.isAdminUser) {
                    // Admin without user doc - still allow practice as P6
                    const adminOption = document.createElement('option');
                    adminOption.value = 'admin';
                    adminOption.textContent = 'Admin Test Mode (P6)';
                    adminOption.dataset.name = 'Admin';
                    adminOption.dataset.level = 'P6';
                    select.appendChild(adminOption);
                    
                    window.userStudents = [{ name: 'Admin', level: 'P6' }];
                }
            } catch (e) {
                console.error("Error loading students:", e);
                
                // Fallback for admin if error occurs
                if (window.isAdminUser) {
                    const adminOption = document.createElement('option');
                    adminOption.value = 'admin';
                    adminOption.textContent = 'Admin Test Mode (P6)';
                    adminOption.dataset.name = 'Admin';
                    adminOption.dataset.level = 'P6';
                    select.appendChild(adminOption);
                    
                    window.userStudents = [{ name: 'Admin', level: 'P6' }];
                }
            }
        };

        window.selectPracticeStudent = function() {
            const select = document.getElementById('practice-student-select');
            const selectedOption = select.options[select.selectedIndex];
            const startBtn = document.getElementById('btn-start-practice');
            
            if (select.value && selectedOption.dataset.name) {
                // Handle admin test mode vs regular students
                const isAdminMode = select.value === 'admin';
                window.practiceState.currentStudent = {
                    index: isAdminMode ? 0 : parseInt(select.value, 10),
                    name: selectedOption.dataset.name,
                    level: selectedOption.dataset.level,
                    isAdminMode: isAdminMode
                };
                document.getElementById('practice-student-info').textContent = 
                    `Student: ${selectedOption.dataset.name} | Level: ${selectedOption.dataset.level}`;
                startBtn.disabled = false;
            } else {
                window.practiceState.currentStudent = null;
                document.getElementById('practice-student-info').textContent = 'Select a student to start practicing';
                startBtn.disabled = true;
            }
        };

        window.startPractice = async function() {
            if (!window.practiceState.currentStudent) {
                alert("Please select a student first.");
                return;
            }
            
            const student = window.practiceState.currentStudent;
            const level = student.level;
            const studentIndex = student.index;
            
            // Reset state
            window.practiceState.questions = [];
            window.practiceState.currentIndex = 0;
            window.practiceState.correct = 0;
            window.practiceState.wrong = 0;
            window.practiceState.streak = 0;
            
            // Load answered questions, wrong answers for review, and ratings
            await loadAnsweredQuestions();
            await loadWrongAnswersForReview();
            await loadQuestionRatings();
            
            // Get student's current rating
            const studentRatingData = await getStudentRating(studentIndex);
            student.rating = studentRatingData.rating;
            student.startRating = studentRatingData.rating; // Store for session summary
            student.attempts = studentRatingData.attempts;
            window.practiceState.currentStudent = student;
            
            // Update student info display with rating
            const ratingTier = getRatingTier(student.rating);
            document.getElementById('practice-student-info').innerHTML = 
                `Student: ${student.name} | Level: ${level} | 
                <span style="color: ${ratingTier.color}; font-weight: 600;">Rating: ${student.rating} (${ratingTier.tier})</span>`;
            
            // Collect questions from current level and one level down
            const levels = ['P3', 'P4', 'P5', 'P6'];
            const currentLevelIndex = levels.indexOf(level);
            const targetLevels = [level];
            if (currentLevelIndex > 0) {
                targetLevels.push(levels[currentLevelIndex - 1]);
            }
            
            // Gather MCQ questions from the DOM with ratings
            const allQuestions = [];
            const reviewQuestions = []; // Questions due for 7-day review
            
            targetLevels.forEach(lvl => {
                const topics = window.mcqCurriculum[lvl] || [];
                topics.forEach(topic => {
                    const topicId = topic.toLowerCase().replace(/\s+/g, '-');
                    const container = document.getElementById(`topic-mcq-${topicId}`);
                    if (container) {
                        container.querySelectorAll('.question-container').forEach(q => {
                            const qId = q.id;
                            const isAnswered = window.practiceState.answeredQuestions.has(qId);
                            const isDueForReview = isQuestionDueForReview(qId);
                            const daysUntilReview = getDaysUntilReview(qId);
                            
                            // Get question rating
                            const qRatingData = getQuestionRating(qId);
                            const questionRating = qRatingData.rating;
                            const questionAttempts = qRatingData.attempts;
                            
                            // Calculate expected success and difficulty
                            const expectedSuccess = calculateExpectedSuccess(student.rating, questionRating);
                            const inGrowthZone = isInGrowthZone(student.rating, questionRating);
                            const difficulty = getDifficultyLabel(student.rating, questionRating);
                            
                            const questionData = {
                                id: qId,
                                level: lvl,
                                topic: topic,
                                element: q,
                                answered: isAnswered,
                                isReviewQuestion: isDueForReview,
                                daysUntilReview: daysUntilReview,
                                questionRating: questionRating,
                                questionAttempts: questionAttempts,
                                expectedSuccess: expectedSuccess,
                                inGrowthZone: inGrowthZone,
                                difficulty: difficulty,
                                priority: lvl === level ? 0 : 1 // Current level first
                            };
                            
                            // If due for review, add to priority review queue
                            if (isDueForReview) {
                                reviewQuestions.push(questionData);
                            } else {
                                allQuestions.push(questionData);
                            }
                        });
                    }
                });
            });
            
            // Sort questions using rating-based priority (deliberate practice)
            const sortedQuestions = sortQuestionsByPriority(allQuestions, student.rating);
            
            // Filter for new questions only if coming from welcome modal
            let finalQuestions;
            let practiceMode = 'normal';
            
            if (window.practiceNewQuestionsOnly && window.newQuestionIds && window.newQuestionIds.length > 0) {
                // Filter to only include new questions
                const newQuestionIdsSet = new Set(window.newQuestionIds.map(id => 'q-' + id));
                const newQuestionsFiltered = sortedQuestions.filter(q => {
                    // Check both the question ID and if it's a custom question ID
                    return newQuestionIdsSet.has(q.id) || 
                           newQuestionIdsSet.has(q.id.replace('q-custom-', 'custom-')) ||
                           window.newQuestionIds.includes(q.id.replace('q-', ''));
                });
                
                if (newQuestionsFiltered.length > 0) {
                    finalQuestions = newQuestionsFiltered;
                    practiceMode = 'new';
                } else {
                    // No new questions found in DOM, use all questions
                    finalQuestions = [...reviewQuestions, ...sortedQuestions];
                }
                
                // Reset the flag
                window.practiceNewQuestionsOnly = false;
                window.newQuestionIds = [];
            } else {
                // Combine: Review questions first (highest priority), then sorted questions
                finalQuestions = [...reviewQuestions, ...sortedQuestions];
            }
            
            window.practiceState.questions = finalQuestions;
            
            // Count growth zone questions
            const growthZoneCount = allQuestions.filter(q => q.inGrowthZone && !q.answered).length;
            const newQuestionsCount = allQuestions.filter(q => !q.answered).length;
            
            // Show practice summary with ratings info
            const practiceContainer = document.getElementById('practice-question-container');
            const existingNotification = document.getElementById('review-notification');
            if (existingNotification) existingNotification.remove();
            const existingSummary = document.getElementById('practice-summary-notification');
            if (existingSummary) existingSummary.remove();
            
            // Show review notification if there are review questions
            if (reviewQuestions.length > 0) {
                const reviewNotification = document.createElement('div');
                reviewNotification.id = 'review-notification';
                reviewNotification.style.cssText = 'background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 12px; margin-bottom: 1rem; text-align: center; animation: practicePulse 2s infinite;';
                reviewNotification.innerHTML = `
                    <div style="font-size: 1.5rem; margin-bottom: 5px;"> Review Time!</div>
                    <div>You have <strong>${reviewQuestions.length}</strong> question${reviewQuestions.length > 1 ? 's' : ''} ready for 7-day review</div>
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 5px;">Master these to remove them from review</div>
                `;
                practiceContainer.insertBefore(reviewNotification, practiceContainer.firstChild);
            }
            
            // Show practice summary with growth zone info
            const summaryNotification = document.createElement('div');
            summaryNotification.id = 'practice-summary-notification';
            
            if (practiceMode === 'new') {
                // Special banner for practicing new questions
                summaryNotification.style.cssText = 'background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 15px; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #2196f3;';
                summaryNotification.innerHTML = `
                    <div style="font-weight: 600; color: #1565c0; margin-bottom: 8px;"> Practicing New Questions!</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.9rem; color: #555;">
                        <span> Your Rating: <strong style="color: ${ratingTier.color};">${student.rating}</strong></span>
                        <span> New Questions: <strong style="color: #1565c0;">${finalQuestions.length}</strong></span>
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 8px;">
                        These questions were added since your last visit. Let's practice them!
                    </div>
                `;
            } else {
                summaryNotification.style.cssText = 'background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 15px; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #4CAF50;';
                summaryNotification.innerHTML = `
                    <div style="font-weight: 600; color: #2e7d32; margin-bottom: 8px;"> Deliberate Practice Session</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.9rem; color: #555;">
                        <span> Your Rating: <strong style="color: ${ratingTier.color};">${student.rating}</strong></span>
                        <span> New Questions: <strong>${newQuestionsCount}</strong></span>
                        <span> Growth Zone: <strong style="color: #ff9800;">${growthZoneCount}</strong></span>
                        <span> Total Available: <strong>${finalQuestions.length}</strong></span>
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 8px;">
                        Questions are prioritized: New  Growth Zone (35-75% success rate)  Mastered
                    </div>
                `;
            }
            practiceContainer.insertBefore(summaryNotification, practiceContainer.firstChild);
            
            // Update UI
            document.getElementById('practice-start-container').classList.add('hidden');
            document.getElementById('practice-stats').classList.remove('hidden');
            document.getElementById('practice-stats').style.display = 'grid';
            document.getElementById('practice-question-container').classList.remove('hidden');
            document.getElementById('practice-complete').classList.add('hidden');
            
            updatePracticeStats();
            showCurrentPracticeQuestion();
        };

        window.showCurrentPracticeQuestion = function() {
            const state = window.practiceState;
            if (state.currentIndex >= state.questions.length) {
                endPractice();
                return;
            }
            
            const question = state.questions[state.currentIndex];
            const container = document.getElementById('practice-question-content');
            const student = state.currentStudent;
            
            // Clone the question
            const clone = question.element.cloneNode(true);
            clone.id = 'practice-q-' + question.id;
            
            // Reset any answered state
            clone.querySelectorAll('input[type="radio"]').forEach(r => {
                r.checked = false;
                r.disabled = false;
                r.name = 'practice-mcq-' + state.currentIndex; // Unique name for this question
            });
            clone.querySelectorAll('.mcq-option, label').forEach(opt => {
                opt.style.borderColor = '';
                opt.style.background = '';
                opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());
            });
            clone.querySelectorAll('.explanation-box').forEach(e => e.style.display = 'none');
            clone.querySelectorAll('.submit-btn').forEach(b => b.disabled = false);
            
            // Update submit button to use practice check
            const submitBtn = clone.querySelector('.submit-btn');
            if (submitBtn) {
                submitBtn.onclick = () => checkPracticeAnswer();
            }
            
            container.innerHTML = '';
            
            // Add difficulty badge (visible to all users)
            const difficulty = question.difficulty || getDifficultyLabel(student.rating, question.questionRating || 1200);
            const expectedSuccess = question.expectedSuccess || calculateExpectedSuccess(student.rating, question.questionRating || 1200);
            const inGrowthZone = question.inGrowthZone || isInGrowthZone(student.rating, question.questionRating || 1200);
            
            const difficultyBadge = document.createElement('div');
            difficultyBadge.className = 'question-difficulty-badge';
            difficultyBadge.style.cssText = `
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                padding: 10px 15px; 
                border-radius: 10px; 
                margin-bottom: 1rem; 
                background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
                border-left: 4px solid ${difficulty.color};
            `;
            
            let badgeContent = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.3rem;">${difficulty.icon}</span>
                    <div>
                        <div style="font-weight: 600; color: ${difficulty.color};">${difficulty.label}</div>
                        <div style="font-size: 0.75rem; color: #888;">Success chance: ~${Math.round(expectedSuccess * 100)}%</div>
                    </div>
                </div>
            `;
            
            // Show growth zone indicator
            if (inGrowthZone) {
                badgeContent += `
                    <div style="background: linear-gradient(135deg, #ff9800, #ffc107); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                         Growth Zone
                    </div>
                `;
            }
            
            // Admin-only: Show actual ratings
            if (window.isAdminUser) {
                const qRating = question.questionRating || 1200;
                const qAttempts = question.questionAttempts || 0;
                const confidence = Math.min(qAttempts / 20, 1) * 100;
                
                badgeContent += `
                    <div style="background: #f3e5f5; padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; border: 1px solid #ce93d8;">
                        <div style="color: #7b1fa2; font-weight: 600;"> Admin View</div>
                        <div style="color: #666;">Q-Rating: <strong>${qRating}</strong></div>
                        <div style="color: #666;">Attempts: ${qAttempts} (${Math.round(confidence)}% confidence)</div>
                    </div>
                `;
            }
            
            difficultyBadge.innerHTML = badgeContent;
            container.appendChild(difficultyBadge);
            
            // Add review badge if this is a review question
            if (question.isReviewQuestion) {
                const reviewBadge = document.createElement('div');
                reviewBadge.className = 'review-question-badge';
                reviewBadge.style.cssText = 'background: linear-gradient(135deg, #ff6b6b, #ffa502); color: white; padding: 10px 15px; border-radius: 10px; margin-bottom: 1rem; display: flex; align-items: center; gap: 10px; font-weight: 600; animation: practicePulse 2s infinite;';
                reviewBadge.innerHTML = `
                    <span style="font-size: 1.5rem;"></span>
                    <div>
                        <div>7-Day Review Question</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">Answer correctly to master this topic!</div>
                    </div>
                `;
                container.appendChild(reviewBadge);
            }
            
            container.appendChild(clone);
            
            // Update level and topic display
            document.getElementById('practice-question-level').textContent = question.level;
            document.getElementById('practice-question-topic').textContent = `Topic: ${question.topic}`;
            
            updatePracticeStats();
        };

        window.checkPracticeAnswer = async function() {
            const state = window.practiceState;
            const question = state.questions[state.currentIndex];
            const container = document.getElementById('practice-question-content');
            const student = state.currentStudent;
            
            const selected = container.querySelector('input[type="radio"]:checked');
            if (!selected) {
                alert("Please select an answer!");
                return;
            }
            
            const isCorrect = selected.dataset.correct === 'true';
            
            // Show feedback on options
            container.querySelectorAll('.mcq-option, label').forEach(opt => {
                const radio = opt.querySelector('input');
                opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());
                
                if (radio && radio.dataset.correct === 'true') {
                    opt.style.background = '#d4edda';
                    opt.style.borderColor = '#28a745';
                    const icon = document.createElement('span');
                    icon.className = 'option-feedback-icon';
                    icon.textContent = '';
                    icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #28a745; margin-left: auto; padding-left: 10px;';
                    opt.style.display = 'flex';
                    opt.style.alignItems = 'center';
                    opt.appendChild(icon);
                } else if (radio && radio.checked && !isCorrect) {
                    opt.style.background = '#f8d7da';
                    opt.style.borderColor = '#dc3545';
                    const icon = document.createElement('span');
                    icon.className = 'option-feedback-icon';
                    icon.textContent = '';
                    icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #dc3545; margin-left: auto; padding-left: 10px;';
                    opt.style.display = 'flex';
                    opt.style.alignItems = 'center';
                    opt.appendChild(icon);
                }
            });
            
            // Disable radios
            container.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);
            
            // Show explanation
            const explanation = container.querySelector('.explanation-box');
            if (explanation) explanation.style.display = 'block';
            
            // =====================================================
            // ELO RATING UPDATE
            // =====================================================
            const studentRating = student.rating || 1000;
            const studentAttempts = student.attempts || 0;
            const questionRating = question.questionRating || 1200;
            const questionAttempts = question.questionAttempts || 0;
            
            // Calculate rating changes
            const ratingUpdate = calculateRatingUpdate(
                studentRating, 
                questionRating, 
                isCorrect, 
                studentAttempts, 
                questionAttempts
            );
            
            // Update ratings in Firebase (await to ensure they're saved)
            await updateStudentRating(student.index, ratingUpdate.newStudentRating, isCorrect);
            await updateQuestionRating(question.id, ratingUpdate.newQuestionRating, isCorrect);
            
            // Track question attempt for progress tracking
            if (window.trackQuestionAttempt) {
                await window.trackQuestionAttempt(question.id, isCorrect);
            }
            
            // Update local state
            student.rating = ratingUpdate.newStudentRating;
            student.attempts = studentAttempts + 1;
            question.questionRating = ratingUpdate.newQuestionRating;
            question.questionAttempts = questionAttempts + 1;
            
            // Create rating feedback message
            const ratingFeedback = document.createElement('div');
            ratingFeedback.className = 'rating-feedback';
            
            if (isCorrect) {
                const ratingTier = getRatingTier(ratingUpdate.newStudentRating);
                ratingFeedback.style.cssText = 'background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 12px 15px; border-radius: 10px; margin-top: 1rem; border-left: 4px solid #4CAF50;';
                ratingFeedback.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <div style="font-weight: 600; color: #2e7d32;"> Rating Updated!</div>
                            <div style="font-size: 0.85rem; color: #555;">
                                Your rating: ${studentRating}  <strong style="color: ${ratingTier.color};">${ratingUpdate.newStudentRating}</strong>
                                <span style="color: #4CAF50;">(+${ratingUpdate.studentChange})</span>
                            </div>
                        </div>
                        <div style="background: ${ratingTier.color}; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                            ${ratingTier.tier}
                        </div>
                    </div>
                `;
            } else {
                const ratingTier = getRatingTier(ratingUpdate.newStudentRating);
                const ratingChange = ratingUpdate.studentChange;
                ratingFeedback.style.cssText = 'background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 12px 15px; border-radius: 10px; margin-top: 1rem; border-left: 4px solid #ff9800;';
                ratingFeedback.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <div style="font-weight: 600; color: #e65100;"> Keep Practicing!</div>
                            <div style="font-size: 0.85rem; color: #555;">
                                Your rating: ${studentRating}  <strong style="color: ${ratingTier.color};">${ratingUpdate.newStudentRating}</strong>
                                ${ratingChange < 0 ? `<span style="color: #f44336;">(${ratingChange})</span>` : ''}
                            </div>
                            <div style="font-size: 0.8rem; color: #888; margin-top: 3px;">
                                This was a ${getDifficultyLabel(studentRating, questionRating).label.toLowerCase()} question for you
                            </div>
                        </div>
                        <div style="background: ${ratingTier.color}; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                            ${ratingTier.tier}
                        </div>
                    </div>
                `;
            }
            
            // Admin-only: Show question rating change
            if (window.isAdminUser) {
                const qChangeSpan = document.createElement('div');
                qChangeSpan.style.cssText = 'margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ccc; font-size: 0.8rem; color: #7b1fa2;';
                qChangeSpan.innerHTML = `
                     <strong>Admin:</strong> Q-Rating: ${questionRating}  ${ratingUpdate.newQuestionRating} 
                    (${ratingUpdate.questionChange >= 0 ? '+' : ''}${ratingUpdate.questionChange}) | 
                    Expected: ${ratingUpdate.expected}% | Attempts: ${questionAttempts + 1}
                `;
                ratingFeedback.appendChild(qChangeSpan);
            }
            
            container.appendChild(ratingFeedback);
            
            // Update student info display
            const ratingTier = getRatingTier(ratingUpdate.newStudentRating);
            document.getElementById('practice-student-info').innerHTML = 
                `Student: ${student.name} | Level: ${student.level} | 
                <span style="color: ${ratingTier.color}; font-weight: 600;">Rating: ${ratingUpdate.newStudentRating} (${ratingTier.tier})</span>`;
            
            // Update stats and handle spaced repetition
            if (isCorrect) {
                state.correct++;
                state.streak++;
                
                // If this was a review question answered correctly, remove from review queue
                if (question.isReviewQuestion) {
                    removeFromReviewQueue(question.id);
                    
                    // Show encouraging message for mastered review question
                    const masteredMsg = document.createElement('div');
                    masteredMsg.style.cssText = 'background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 12px; border-radius: 8px; margin-top: 1rem; text-align: center; font-weight: 600; color: #155724;';
                    masteredMsg.innerHTML = ' Great job! You\'ve mastered this review question!';
                    container.appendChild(masteredMsg);
                }
            } else {
                state.wrong++;
                state.streak = 0;
                
                // Save wrong answer for 7-day review (spaced repetition)
                saveWrongAnswerForReview(question.id);
                
                // Show spaced repetition reminder
                const reviewMsg = document.createElement('div');
                reviewMsg.style.cssText = 'background: linear-gradient(135deg, #fff3cd, #ffeeba); padding: 12px; border-radius: 8px; margin-top: 1rem; text-align: center; font-weight: 600; color: #856404;';
                reviewMsg.innerHTML = ' This question will return for review in <strong>7 days</strong> to help you master it!';
                container.appendChild(reviewMsg);
            }
            
            // Mark as answered
            state.answeredQuestions.add(question.id);
            saveAnsweredQuestions();
            
            // Disable submit button
            container.querySelectorAll('.submit-btn').forEach(b => b.disabled = true);
            
            updatePracticeStats();
        };

        window.nextPracticeQuestion = function() {
            window.practiceState.currentIndex++;
            showCurrentPracticeQuestion();
        };

        window.endPractice = function() {
            const state = window.practiceState;
            const student = state.currentStudent;
            
            document.getElementById('practice-question-container').classList.add('hidden');
            document.getElementById('practice-complete').classList.remove('hidden');
            
            const total = state.correct + state.wrong;
            const percentage = total > 0 ? Math.round((state.correct / total) * 100) : 0;
            
            // Calculate rating change during session
            const startRating = student.startRating || 1000;
            const endRating = student.rating || 1000;
            const ratingChange = endRating - startRating;
            const ratingTier = getRatingTier(endRating);
            
            // Build summary with rating info
            let summaryHtml = `
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; margin-bottom: 1rem;">
                        You got <strong>${state.correct}</strong> out of <strong>${total}</strong> correct (<strong>${percentage}%</strong>)!
                    </div>
                    <div style="background: linear-gradient(135deg, #f5f5f5, #e8e8e8); padding: 15px; border-radius: 12px; margin-top: 1rem;">
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 10px;"> Rating Summary</div>
                        <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
                            <div>
                                <div style="color: #888; font-size: 0.85rem;">Current Rating</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${ratingTier.color};">${endRating}</div>
                                <div style="font-size: 0.8rem; color: ${ratingTier.color};">${ratingTier.tier}</div>
                            </div>
                            <div style="font-size: 2rem; color: ${ratingChange >= 0 ? '#4CAF50' : '#f44336'};">
                                ${ratingChange >= 0 ? '' : ''}
                            </div>
                            <div>
                                <div style="color: #888; font-size: 0.85rem;">Session Change</div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: ${ratingChange >= 0 ? '#4CAF50' : '#f44336'};">
                                    ${ratingChange >= 0 ? '+' : ''}${ratingChange}
                                </div>
                            </div>
                        </div>
                    </div>
            `;
            
            // Add performance feedback
            if (percentage >= 80) {
                summaryHtml += `
                    <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 12px; border-radius: 8px; margin-top: 1rem; color: #155724;">
                         Excellent work! You're mastering this material!
                    </div>
                `;
            } else if (percentage >= 60) {
                summaryHtml += `
                    <div style="background: linear-gradient(135deg, #cce5ff, #b8daff); padding: 12px; border-radius: 8px; margin-top: 1rem; color: #004085;">
                         Good progress! Keep practicing to improve further.
                    </div>
                `;
            } else {
                summaryHtml += `
                    <div style="background: linear-gradient(135deg, #fff3cd, #ffeeba); padding: 12px; border-radius: 8px; margin-top: 1rem; color: #856404;">
                         Don't give up! Review the explanations and try again.
                    </div>
                `;
            }
            
            summaryHtml += '</div>';
            
            document.getElementById('practice-summary').innerHTML = summaryHtml;
        };

        window.restartPractice = function() {
            document.getElementById('practice-complete').classList.add('hidden');
            document.getElementById('practice-start-container').classList.remove('hidden');
            document.getElementById('practice-stats').classList.add('hidden');
            document.getElementById('practice-question-container').classList.add('hidden');
        };

        window.updatePracticeStats = function() {
            const state = window.practiceState;
            document.getElementById('stat-correct').textContent = state.correct;
            document.getElementById('stat-wrong').textContent = state.wrong;
            document.getElementById('stat-remaining').textContent = 
                Math.max(0, state.questions.length - state.currentIndex - 1);
            document.getElementById('stat-streak').textContent = state.streak;
            
            // Count review questions remaining
            const reviewRemaining = state.questions
                .slice(state.currentIndex)
                .filter(q => q.isReviewQuestion).length;
            document.getElementById('stat-review').textContent = reviewRemaining;
        };

        window.loadAnsweredQuestions = async function() {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const studentIndex = window.practiceState.currentStudent?.index || 0;
                const key = `answered_${user.uid}_${studentIndex}`;
                const stored = localStorage.getItem(key);
                
                if (stored) {
                    window.practiceState.answeredQuestions = new Set(JSON.parse(stored));
                } else {
                    window.practiceState.answeredQuestions = new Set();
                }
            } catch (e) {
                console.error("Error loading answered questions:", e);
                window.practiceState.answeredQuestions = new Set();
            }
        };

        window.saveAnsweredQuestions = function() {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const studentIndex = window.practiceState.currentStudent?.index || 0;
                const key = `answered_${user.uid}_${studentIndex}`;
                const data = Array.from(window.practiceState.answeredQuestions);
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error("Error saving answered questions:", e);
            }
        };

        // Track answer for practice mode (called from checkMcq)
        window.trackAnswerForPractice = function(questionId, isCorrect) {
            // This can be expanded to track performance over time
            console.log(`Question ${questionId}: ${isCorrect ? 'Correct' : 'Wrong'}`);
            
            // Track this attempt in Firebase for admin dashboard
            trackQuestionAttempt(questionId, isCorrect);
        };

        // Track all question attempts (both practice mode and regular mode) for admin dashboard
        window.trackQuestionAttempt = async function(questionId, isCorrect) {
            try {
                const user = window.auth?.currentUser;
                if (!user || !window.db_fs) return;
                
                const { doc, getDoc, updateDoc, setDoc, increment } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const userRef = doc(window.db_fs, "users", user.uid);
                const userDoc = await getDoc(userRef);
                
                const now = new Date();
                const today = now.toISOString().split('T')[0]; // YYYY-MM-DD
                
                // Get current student index
                const studentIndex = window.practiceState?.currentStudent?.index ?? 0;
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    
                    // Update activity tracking
                    const activityStats = data.activityStats || {};
                    activityStats.totalQuestionsAttempted = (activityStats.totalQuestionsAttempted || 0) + 1;
                    activityStats.totalCorrect = (activityStats.totalCorrect || 0) + (isCorrect ? 1 : 0);
                    activityStats.lastActivity = now;
                    
                    // Track daily activity
                    const dailyActivity = activityStats.dailyActivity || {};
                    if (!dailyActivity[today]) {
                        dailyActivity[today] = { attempts: 0, correct: 0 };
                    }
                    dailyActivity[today].attempts++;
                    if (isCorrect) dailyActivity[today].correct++;
                    activityStats.dailyActivity = dailyActivity;
                    
                    // Track per-question attempts per student
                    const questionAttempts = data.questionAttempts || {};
                    const studentKey = `student_${studentIndex}`;
                    if (!questionAttempts[studentKey]) {
                        questionAttempts[studentKey] = {};
                    }
                    if (!questionAttempts[studentKey][questionId]) {
                        questionAttempts[studentKey][questionId] = { attempts: 0, correct: 0, lastAttempt: null };
                    }
                    questionAttempts[studentKey][questionId].attempts++;
                    if (isCorrect) questionAttempts[studentKey][questionId].correct++;
                    questionAttempts[studentKey][questionId].lastAttempt = now;
                    
                    // Keep only last 30 days of daily activity
                    const thirtyDaysAgo = new Date(now);
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
                    Object.keys(dailyActivity).forEach(date => {
                        if (date < thirtyDaysAgoStr) delete dailyActivity[date];
                    });
                    
                    await updateDoc(userRef, { 
                        activityStats: activityStats,
                        questionAttempts: questionAttempts,
                        lastActivity: now
                    });
                    
                    console.log("Activity tracked - Total attempts:", activityStats.totalQuestionsAttempted);
                } else {
                    // Create new user document with activity
                    const questionAttempts = {};
                    const studentKey = `student_${studentIndex}`;
                    questionAttempts[studentKey] = {};
                    questionAttempts[studentKey][questionId] = { attempts: 1, correct: isCorrect ? 1 : 0, lastAttempt: now };
                    
                    await setDoc(userRef, {
                        email: user.email,
                        activityStats: {
                            totalQuestionsAttempted: 1,
                            totalCorrect: isCorrect ? 1 : 0,
                            lastActivity: now,
                            dailyActivity: {
                                [today]: { attempts: 1, correct: isCorrect ? 1 : 0 }
                            }
                        },
                        questionAttempts: questionAttempts,
                        lastActivity: now,
                        createdAt: now
                    }, { merge: true });
                }
            } catch (e) {
                console.error("Error tracking question attempt:", e);
            }
        };

        // =====================================================
        // ADMIN RATINGS DASHBOARD
        // =====================================================
        
        window.toggleRatingsDashboard = function() {
            const content = document.getElementById('ratings-dashboard-content');
            const btn = document.getElementById('btn-toggle-ratings');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                btn.textContent = ' Hide Dashboard';
                loadRatingsDashboard();
            } else {
                content.classList.add('hidden');
                btn.textContent = ' Show Dashboard';
            }
        };

        window.loadRatingsDashboard = async function() {
            if (!window.isAdminUser) return;
            
            const tableBody = document.getElementById('ratings-table-body');
            tableBody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #888;">Loading...</td></tr>';
            
            try {
                // Load question ratings
                await loadQuestionRatings();
                
                // Get all questions from DOM with level and topic info
                const allQuestions = [];
                document.querySelectorAll('.question-container').forEach(q => {
                    const id = q.id;
                    const titleEl = q.querySelector('h3');
                    const title = titleEl ? titleEl.textContent.trim() : id;
                    
                    // Extract level and topic from parent container IDs
                    let level = '-';
                    let topic = '-';
                    
                    // Check if it's an MCQ question (parent has topic-mcq-* id)
                    const mcqParent = q.closest('[id^="topic-mcq-"]');
                    if (mcqParent) {
                        // Find which level this topic belongs to
                        const topicId = mcqParent.id.replace('topic-mcq-', '');
                        for (const [lvl, topics] of Object.entries(window.mcqCurriculum || {})) {
                            const matchingTopic = topics.find(t => t.toLowerCase().replace(/\s+/g, '-') === topicId);
                            if (matchingTopic) {
                                level = lvl;
                                topic = matchingTopic;
                                break;
                            }
                        }
                    } else {
                        // OEQ question - check parent view container
                        const viewParent = q.closest('[id^="view-"]');
                        if (viewParent) {
                            const viewType = viewParent.id.replace('view-', '');
                            // Check topic container
                            const topicParent = q.closest('[id^="topic-"]');
                            if (topicParent) {
                                const topicId = topicParent.id.replace('topic-', '').replace(viewType + '-', '');
                                topic = topicId.charAt(0).toUpperCase() + topicId.slice(1).replace(/-/g, ' ');
                            }
                            // Set level based on current OEQ level
                            level = window.currentOeqLevel || 'P6';
                        }
                    }
                    
                    const ratingData = getQuestionRating(id);
                    allQuestions.push({
                        id,
                        title: title.substring(0, 40) + (title.length > 40 ? '...' : ''),
                        fullTitle: title,
                        level: level,
                        topic: topic.length > 20 ? topic.substring(0, 18) + '...' : topic,
                        fullTopic: topic,
                        rating: ratingData.rating,
                        attempts: ratingData.attempts,
                        correctCount: ratingData.correctCount || 0,
                        element: q
                    });
                });
                
                // Calculate stats
                const ratedQuestions = allQuestions.filter(q => q.attempts > 0);
                const totalAttempts = ratedQuestions.reduce((sum, q) => sum + q.attempts, 0);
                const avgRating = ratedQuestions.length > 0 
                    ? Math.round(ratedQuestions.reduce((sum, q) => sum + q.rating, 0) / ratedQuestions.length)
                    : 1200;
                
                // Update stats
                document.getElementById('stat-total-questions').textContent = allQuestions.length;
                document.getElementById('stat-rated-questions').textContent = ratedQuestions.length;
                document.getElementById('stat-avg-rating').textContent = avgRating;
                document.getElementById('stat-total-attempts').textContent = totalAttempts;
                
                // Sort by rating descending (hardest first)
                allQuestions.sort((a, b) => b.rating - a.rating);
                
                // Store for popup access
                window.ratingsDashboardQuestions = allQuestions;
                
                // Render table
                if (allQuestions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #888;">No questions found</td></tr>';
                    return;
                }
                
                // Level colors
                const levelColors = {
                    'P3': '#FFB3BA',
                    'P4': '#BAFFC9',
                    'P5': '#BAE1FF',
                    'P6': '#FFFFBA'
                };
                
                tableBody.innerHTML = allQuestions.map((q, idx) => {
                    const correctPercent = q.attempts > 0 
                        ? Math.round((q.correctCount / q.attempts) * 100) 
                        : '-';
                    const confidence = Math.min(q.attempts / 20, 1) * 100;
                    const ratingColor = q.rating >= 1600 ? '#9C27B0' 
                        : q.rating >= 1400 ? '#673AB7'
                        : q.rating >= 1200 ? '#2196F3'
                        : q.rating >= 1000 ? '#4CAF50'
                        : '#FF9800';
                    const levelBg = levelColors[q.level] || '#f5f5f5';
                    
                    return `
                        <tr style="cursor: pointer;" onclick="showRatingQuestionPopup(${idx})" title="Click to view question">
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; max-width: 180px; overflow: hidden; text-overflow: ellipsis;">
                                <span style="color: #1976d2; text-decoration: underline;">${q.title}</span>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <span style="background: ${levelBg}; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${q.level}</span>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center; font-size: 0.8rem; color: #666;" title="${q.fullTopic}">${q.topic}</td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <strong style="color: ${ratingColor};">${q.rating}</strong>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">${q.attempts}</td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                ${correctPercent !== '-' ? `<span style="color: ${correctPercent >= 70 ? '#4CAF50' : correctPercent >= 50 ? '#ff9800' : '#f44336'};">${correctPercent}%</span>` : '-'}
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <div style="background: #e0e0e0; border-radius: 10px; height: 8px; width: 60px; display: inline-block; overflow: hidden;">
                                    <div style="background: ${confidence >= 80 ? '#4CAF50' : confidence >= 50 ? '#ff9800' : '#f44336'}; height: 100%; width: ${confidence}%;"></div>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (e) {
                console.error("Error loading ratings dashboard:", e);
                tableBody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #dc3545;">Error loading data</td></tr>';
            }
        };

        // Show question popup from ratings dashboard
        window.showRatingQuestionPopup = function(idx) {
            const questions = window.ratingsDashboardQuestions;
            if (!questions || !questions[idx]) return;
            
            const q = questions[idx];
            const questionElement = q.element;
            
            if (!questionElement) {
                alert('Question element not found');
                return;
            }
            
            // Clone the question content
            const clone = questionElement.cloneNode(true);
            
            // Remove controls, buttons, etc.
            clone.querySelectorAll('.controls, .worksheet-control-bar, .admin-controls, .consult-btn, .print-question-btn, .flag-question-btn').forEach(el => el.remove());
            
            // Get rating info
            const ratingData = getQuestionRating(q.id);
            const ratingTier = q.rating >= 1600 ? 'Hard' : q.rating >= 1400 ? 'Medium-Hard' : q.rating >= 1200 ? 'Medium' : q.rating >= 1000 ? 'Medium-Easy' : 'Easy';
            
            // Build popup content
            const content = document.getElementById('question-popup-content');
            content.innerHTML = `
                <div style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); padding: 12px 15px; border-radius: 10px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <div style="font-weight: 600; color: #7b1fa2; font-size: 1.1rem;">${q.fullTitle}</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                                Level: <strong>${q.level}</strong> | Topic: <strong>${q.fullTopic}</strong>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #7b1fa2;">${ratingData.rating}</div>
                            <div style="font-size: 0.75rem; color: #888;">${ratingTier}  ${ratingData.attempts} attempts</div>
                        </div>
                    </div>
                </div>
            `;
            content.appendChild(clone);
            
            // Show the popup
            document.getElementById('question-popup-modal').classList.add('visible');
        };

        // =====================================================
        // USER ACTIVITY DASHBOARD (ADMIN)
        // =====================================================
        
        window.toggleActivityDashboard = function() {
            const content = document.getElementById('activity-dashboard-content');
            const btn = document.getElementById('btn-toggle-activity');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                btn.textContent = ' Hide Dashboard';
                loadActivityDashboard();
            } else {
                content.classList.add('hidden');
                btn.textContent = ' Show Dashboard';
            }
        };

        window.loadActivityDashboard = async function() {
            if (!window.isAdminUser) return;
            
            const tableBody = document.getElementById('activity-table-body');
            tableBody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #888;">Loading...</td></tr>';
            
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Load all users
                const usersRef = collection(window.db_fs, "users");
                const snapshot = await getDocs(usersRef);
                
                const users = [];
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekStart = new Date(todayStart);
                weekStart.setDate(weekStart.getDate() - 7);
                const today = now.toISOString().split('T')[0];
                
                let activeToday = 0;
                let activeWeek = 0;
                let totalQuestionsAttempted = 0;
                let totalQuestionsToday = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const lastLogin = data.lastLogin?.toDate ? data.lastLogin.toDate() : null;
                    const lastActivity = data.lastActivity?.toDate ? data.lastActivity.toDate() : 
                                         (data.lastActivity ? new Date(data.lastActivity) : null);
                    const students = data.students || [];
                    const activityStats = data.activityStats || {};
                    
                    // Calculate average rating across all students
                    let avgRating = 1000;
                    let studentAttempts = 0;
                    if (students.length > 0) {
                        const ratings = students.filter(s => s.rating).map(s => s.rating);
                        avgRating = ratings.length > 0 ? Math.round(ratings.reduce((a, b) => a + b, 0) / ratings.length) : 1000;
                        studentAttempts = students.reduce((sum, s) => sum + (s.totalAttempts || 0), 0);
                    }
                    
                    // Get total attempts from activityStats (includes all question types)
                    const totalAttempts = activityStats.totalQuestionsAttempted || studentAttempts || 0;
                    const totalCorrect = activityStats.totalCorrect || 0;
                    const correctRate = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
                    
                    // Get today's attempts
                    const dailyActivity = activityStats.dailyActivity || {};
                    const todayAttempts = dailyActivity[today]?.attempts || 0;
                    
                    // Check activity (use lastActivity if available, fallback to lastLogin)
                    const lastActiveTime = lastActivity || lastLogin;
                    if (lastActiveTime) {
                        if (lastActiveTime >= todayStart) activeToday++;
                        if (lastActiveTime >= weekStart) activeWeek++;
                    }
                    
                    totalQuestionsAttempted += totalAttempts;
                    totalQuestionsToday += todayAttempts;
                    
                    users.push({
                        id: doc.id,
                        email: data.email || doc.id,
                        students: students,
                        studentCount: students.length,
                        lastLogin: lastLogin,
                        lastActivity: lastActiveTime,
                        loginCount: data.loginCount || 0,
                        totalAttempts: totalAttempts,
                        todayAttempts: todayAttempts,
                        correctRate: correctRate,
                        avgRating: avgRating
                    });
                });
                
                // Update stats
                document.getElementById('stat-total-users').textContent = users.length;
                document.getElementById('stat-active-today').textContent = activeToday;
                document.getElementById('stat-active-week').textContent = activeWeek;
                document.getElementById('stat-total-practice-sessions').textContent = totalQuestionsAttempted;
                
                // Sort by last activity (most recent first)
                users.sort((a, b) => {
                    if (!a.lastActivity) return 1;
                    if (!b.lastActivity) return -1;
                    return b.lastActivity - a.lastActivity;
                });
                
                // Render table
                if (users.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #888;">No users found</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = users.map(u => {
                    const lastActivityStr = u.lastActivity 
                        ? formatRelativeTime(u.lastActivity)
                        : 'Never';
                    const isRecent = u.lastActivity && u.lastActivity >= todayStart;
                    const studentNames = u.students.map(s => s.name || 'Unknown').join(', ');
                    const ratingTier = getRatingTier(u.avgRating);
                    const correctRateColor = u.correctRate >= 70 ? '#4CAF50' : u.correctRate >= 50 ? '#ff9800' : '#f44336';
                    
                    return `
                        <tr>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee;">
                                <div style="font-weight: 500;">${u.email}</div>
                                <div style="font-size: 0.75rem; color: #888;" title="${studentNames}">${studentNames.length > 25 ? studentNames.substring(0, 23) + '...' : studentNames || '-'}</div>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <span style="background: #e3f2fd; color: #1976d2; padding: 3px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">${u.studentCount}</span>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <span style="color: ${isRecent ? '#4CAF50' : '#888'}; font-weight: ${isRecent ? '600' : '400'};">${lastActivityStr}</span>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <div style="font-weight: 600;">${u.totalAttempts}</div>
                                ${u.todayAttempts > 0 ? `<div style="font-size: 0.7rem; color: #4CAF50;">+${u.todayAttempts} today</div>` : ''}
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <span style="color: ${correctRateColor}; font-weight: 600;">${u.correctRate}%</span>
                            </td>
                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">
                                <span style="color: ${ratingTier.color}; font-weight: 600;">${u.avgRating}</span>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (e) {
                console.error("Error loading activity dashboard:", e);
                tableBody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #dc3545;">Error loading data</td></tr>';
            }
        };

        // Format relative time (e.g., "2 hours ago", "Yesterday")
        window.formatRelativeTime = function(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        };

        // =====================================================
        // WELCOME BACK & NEW QUESTIONS NOTIFICATION
        // =====================================================
        
        window.newQuestionsForPractice = [];
        
        window.showWelcomeModal = function(newQuestionsCount, lastLoginDate, userStats) {
            const modal = document.getElementById('welcome-back-modal');
            const isNewUser = userStats?.isNewUser || false;
            const reviewCount = userStats?.reviewCount || 0;
            
            // Update title based on new user or time of day
            const hour = new Date().getHours();
            let greeting = 'Welcome Back!';
            let subtitle = 'Good to see you again';
            
            if (isNewUser) {
                greeting = 'Welcome! ';
                subtitle = 'Let\'s start learning!';
            } else {
                if (hour < 12) greeting = 'Good Morning! ';
                else if (hour < 17) greeting = 'Good Afternoon! ';
                else greeting = 'Good Evening! ';
            }
            
            document.getElementById('welcome-back-title').textContent = greeting;
            document.getElementById('welcome-back-subtitle').textContent = subtitle;
            
            // Update quick stats
            if (userStats) {
                document.getElementById('welcome-stat-streak').textContent = userStats.streak || 0;
                document.getElementById('welcome-stat-rating').textContent = userStats.rating || 1000;
                document.getElementById('welcome-stat-review').textContent = reviewCount;
            }
            
            // Update button text and info display
            const practiceBtn = document.getElementById('btn-practice-new');
            const infoBox = document.getElementById('new-questions-info');
            
            if (isNewUser) {
                // New user - show welcome message with total questions
                infoBox.style.background = 'linear-gradient(135deg, #e3f2fd, #bbdefb)';
                infoBox.innerHTML = `
                    <div style="font-size: 2.5rem; font-weight: 700; color: #1565c0;">${newQuestionsCount}</div>
                    <div style="font-size: 1rem; color: #1565c0; font-weight: 600;">Questions Ready to Practice!</div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">Start your learning journey now</div>
                `;
                practiceBtn.innerHTML = ' Start Learning';
            } else if (newQuestionsCount > 0) {
                // Returning user with new questions
                const daysAgo = lastLoginDate ? Math.floor((new Date() - lastLoginDate) / 86400000) : 0;
                let sinceText = 'Since your last visit';
                if (daysAgo === 0) sinceText = 'Since earlier today';
                else if (daysAgo === 1) sinceText = 'Since yesterday';
                else if (daysAgo > 1) sinceText = `Since ${daysAgo} days ago`;
                
                infoBox.style.background = 'linear-gradient(135deg, #e8f5e9, #c8e6c9)';
                infoBox.innerHTML = `
                    <div style="font-size: 2.5rem; font-weight: 700; color: #2e7d32;">${newQuestionsCount}</div>
                    <div style="font-size: 1rem; color: #2e7d32; font-weight: 600;">New Questions Added!</div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">${sinceText}</div>
                `;
                practiceBtn.innerHTML = ` Practice ${newQuestionsCount} New Questions`;
            } else if (reviewCount > 0) {
                // Returning user with no new questions but has reviews due
                infoBox.style.background = 'linear-gradient(135deg, #fff3e0, #ffe0b2)';
                infoBox.innerHTML = `
                    <div style="font-size: 2.5rem; font-weight: 700; color: #e65100;">${reviewCount}</div>
                    <div style="font-size: 1rem; color: #e65100; font-weight: 600;">Questions Due for Review!</div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">Practice to reinforce your learning</div>
                `;
                practiceBtn.innerHTML = ' Start Review';
            } else {
                // Returning user with no new questions and no reviews - all caught up!
                infoBox.style.background = 'linear-gradient(135deg, #f3e5f5, #e1bee7)';
                infoBox.innerHTML = `
                    <div style="font-size: 2.5rem; margin-bottom: 5px;"></div>
                    <div style="font-size: 1rem; color: #7b1fa2; font-weight: 600;">You're All Caught Up!</div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">No new questions since your last visit</div>
                `;
                practiceBtn.innerHTML = ' Continue Practice';
            }
            
            modal.classList.add('visible');
        };

        window.hideWelcomeModal = function() {
            document.getElementById('welcome-back-modal').classList.remove('visible');
        };

        window.practiceNewQuestions = function() {
            hideWelcomeModal();
            
            // Switch to practice mode
            switchMode('mcq');
            switchTab('practice', document.getElementById('btn-sidebar-practice'));
            
            // If there are new questions, start practice automatically after a short delay
            if (window.newQuestionsForPractice && window.newQuestionsForPractice.length > 0) {
                setTimeout(() => {
                    // Store new questions IDs for filtering in practice
                    window.practiceNewQuestionsOnly = true;
                    window.newQuestionIds = window.newQuestionsForPractice.map(q => q.id);
                }, 500);
            }
        };

        // Check for new questions since last login
        window.checkNewQuestionsSinceLastLogin = async function(lastLogin) {
            if (!lastLogin) return 0;
            
            try {
                const { collection, getDocs, query, where, orderBy } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Query questions added after last login
                const questionsRef = collection(window.db_fs, "custom_questions");
                const snapshot = await getDocs(questionsRef);
                
                let newCount = 0;
                window.newQuestionsForPractice = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Handle both Firestore Timestamp and ISO string formats
                    let createdAt = null;
                    if (data.createdAt) {
                        if (data.createdAt.toDate) {
                            createdAt = data.createdAt.toDate();
                        } else if (typeof data.createdAt === 'string') {
                            createdAt = new Date(data.createdAt);
                        } else if (data.createdAt instanceof Date) {
                            createdAt = data.createdAt;
                        }
                    }
                    
                    if (createdAt && createdAt > lastLogin) {
                        newCount++;
                        window.newQuestionsForPractice.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                
                return newCount;
            } catch (e) {
                console.error("Error checking new questions:", e);
                return 0;
            }
        };

        // Track login and show welcome modal
        window.trackLoginAndShowWelcome = async function(user) {
            try {
                const { doc, getDoc, updateDoc, setDoc, increment } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const userRef = doc(window.db_fs, "users", user.uid);
                const userDoc = await getDoc(userRef);
                
                let lastLogin = null;
                let loginStreak = 0;
                let userRating = 1000;
                let reviewCount = 0;
                let isNewUser = false;
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    lastLogin = data.lastLogin?.toDate ? data.lastLogin.toDate() : null;
                    loginStreak = data.loginStreak || 0;
                    
                    // Get first student's rating as user rating
                    const students = data.students || [];
                    if (students.length > 0 && students[0].rating) {
                        userRating = students[0].rating;
                    }
                    
                    // Calculate login streak
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const yesterdayStart = new Date(todayStart);
                    yesterdayStart.setDate(yesterdayStart.getDate() - 1);
                    
                    if (lastLogin) {
                        if (lastLogin >= todayStart) {
                            // Already logged in today, maintain streak
                        } else if (lastLogin >= yesterdayStart) {
                            // Logged in yesterday, increment streak
                            loginStreak++;
                        } else {
                            // More than a day gap, reset streak
                            loginStreak = 1;
                        }
                    } else {
                        loginStreak = 1;
                    }
                    
                    // Update login info
                    await updateDoc(userRef, {
                        lastLogin: new Date(),
                        loginCount: increment(1),
                        loginStreak: loginStreak
                    });
                } else {
                    // New user, create document
                    isNewUser = true;
                    await setDoc(userRef, {
                        email: user.email,
                        lastLogin: new Date(),
                        loginCount: 1,
                        loginStreak: 1,
                        createdAt: new Date()
                    }, { merge: true });
                    loginStreak = 1;
                }
                
                // Count questions due for review
                const studentIndex = 0;
                const reviewKey = `wrongAnswers_${user.uid}_${studentIndex}`;
                const storedReviews = localStorage.getItem(reviewKey);
                if (storedReviews) {
                    const reviews = JSON.parse(storedReviews);
                    const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
                    const now = Date.now();
                    reviewCount = Object.values(reviews).filter(ts => (now - ts) >= sevenDaysMs).length;
                }
                
                // Check for new questions (for returning users) or total questions (for new users)
                let newQuestionsCount = 0;
                let totalQuestionsCount = 0;
                
                if (isNewUser || !lastLogin) {
                    // For new users, count total available questions
                    totalQuestionsCount = await countTotalQuestions();
                    newQuestionsCount = totalQuestionsCount; // Show all as "new" for new users
                } else {
                    // For returning users, check questions added since last login
                    newQuestionsCount = await checkNewQuestionsSinceLastLogin(lastLogin);
                }
                
                // Always show welcome modal on login
                setTimeout(() => {
                    showWelcomeModal(newQuestionsCount, lastLogin, {
                        streak: loginStreak,
                        rating: userRating,
                        reviewCount: reviewCount,
                        isNewUser: isNewUser,
                        totalQuestions: totalQuestionsCount
                    });
                }, 1500); // Delay to let page load
                
            } catch (e) {
                console.error("Error tracking login:", e);
            }
        };

        // Count total available questions
        window.countTotalQuestions = async function() {
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const questionsRef = collection(window.db_fs, "custom_questions");
                const snapshot = await getDocs(questionsRef);
                
                return snapshot.size;
            } catch (e) {
                console.error("Error counting questions:", e);
                return 0;
            }
        };

        // =====================================================
        // AUTO-UPDATE SYSTEM
        // =====================================================
        
        // Get current app version from meta tag
        window.getCurrentAppVersion = function() {
            const versionMeta = document.querySelector('meta[name="app-version"]');
            return versionMeta ? versionMeta.content : '0';
        };

        // Check for updates from Firestore
        window.checkForUpdates = async function() {
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const currentVersion = getCurrentAppVersion();
                const lastCheckedVersion = localStorage.getItem('app_last_version');
                
                // Check Firestore for the latest version
                const versionDoc = await getDoc(doc(window.db_fs, "app_settings", "version"));
                
                if (versionDoc.exists()) {
                    const serverVersion = versionDoc.data().current;
                    const forceRefresh = versionDoc.data().forceRefresh || false;
                    
                    console.log(`Current: ${currentVersion}, Server: ${serverVersion}, Last: ${lastCheckedVersion}`);
                    
                    // If server version is newer than current version
                    if (serverVersion && serverVersion !== currentVersion) {
                        if (forceRefresh) {
                            // Force refresh immediately
                            showUpdateBanner(serverVersion, true);
                        } else {
                            // Show update notification
                            showUpdateBanner(serverVersion, false);
                        }
                    }
                }
                
                // Update last checked version
                localStorage.setItem('app_last_version', currentVersion);
                
            } catch (e) {
                console.log("Update check skipped:", e.message);
            }
        };

        // Show update notification banner
        window.showUpdateBanner = function(newVersion, autoRefresh = false) {
            // Remove existing banner if any
            const existingBanner = document.getElementById('update-banner');
            if (existingBanner) existingBanner.remove();
            
            const banner = document.createElement('div');
            banner.id = 'update-banner';
            banner.className = 'update-banner';
            
            if (autoRefresh) {
                banner.innerHTML = `
                    <span class="update-banner-text"> New update available! Refreshing in <span id="refresh-countdown">5</span> seconds...</span>
                    <button class="update-banner-btn" onclick="forceRefresh()">Refresh Now</button>
                `;
                document.body.prepend(banner);
                
                // Countdown and refresh
                let countdown = 5;
                const interval = setInterval(() => {
                    countdown--;
                    const countdownEl = document.getElementById('refresh-countdown');
                    if (countdownEl) countdownEl.textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(interval);
                        forceRefresh();
                    }
                }, 1000);
            } else {
                banner.innerHTML = `
                    <span class="update-banner-text"> A new version is available with new features and improvements!</span>
                    <button class="update-banner-btn" onclick="forceRefresh()"> Update Now</button>
                    <button class="update-banner-dismiss" onclick="dismissUpdateBanner()">Later</button>
                `;
                document.body.prepend(banner);
            }
        };

        // Force refresh the page
        window.forceRefresh = function() {
            // Clear cache and reload
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            
            // Force reload from server
            window.location.reload(true);
        };

        // Dismiss update banner
        window.dismissUpdateBanner = function() {
            const banner = document.getElementById('update-banner');
            if (banner) {
                banner.style.animation = 'slideUp 0.3s ease forwards';
                setTimeout(() => banner.remove(), 300);
            }
            
            // Don't show again for this session
            sessionStorage.setItem('update_dismissed', 'true');
        };

        // Admin function to push update notification to all users
        window.pushAppUpdate = async function(newVersion, forceRefresh = false) {
            if (!window.isAdminUser) {
                alert("Only admins can push updates.");
                return;
            }
            
            try {
                const { doc, setDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                await setDoc(doc(window.db_fs, "app_settings", "version"), {
                    current: newVersion,
                    forceRefresh: forceRefresh,
                    updatedAt: serverTimestamp(),
                    updatedBy: window.auth.currentUser.email
                });
                
                alert(` Update pushed!\n\nVersion: ${newVersion}\nForce Refresh: ${forceRefresh ? 'Yes' : 'No'}\n\nAll users will be notified on their next page load.`);
                
            } catch (e) {
                console.error("Error pushing update:", e);
                alert("Error pushing update: " + e.message);
            }
        };

        // UI function for push update button
        window.pushUpdateNotification = function(forceRefresh = false) {
            const currentVersion = getCurrentAppVersion();
            const newVersion = prompt(
                `Push Update to All Users\n\n` +
                `Current version: ${currentVersion}\n\n` +
                `Enter new version number (or leave blank to use current):`,
                currentVersion
            );
            
            if (newVersion === null) return; // Cancelled
            
            const versionToUse = newVersion.trim() || currentVersion;
            const confirmMsg = forceRefresh 
                ? ` FORCE REFRESH\n\nThis will immediately refresh all users' browsers!\n\nVersion: ${versionToUse}\n\nProceed?`
                : ` NOTIFY USERS\n\nUsers will see an update banner and can choose to refresh.\n\nVersion: ${versionToUse}\n\nProceed?`;
            
            if (confirm(confirmMsg)) {
                pushAppUpdate(versionToUse, forceRefresh);
            }
        };

        // Update version display when admin view loads
        window.updateVersionDisplay = function() {
            const display = document.getElementById('current-version-display');
            if (display) {
                display.textContent = getCurrentAppVersion();
            }
        };

        // Periodic update check (every 5 minutes)
        window.startUpdateChecker = function() {
            // Check immediately
            setTimeout(() => {
                if (!sessionStorage.getItem('update_dismissed')) {
                    checkForUpdates();
                }
            }, 3000);
            
            // Then check every 5 minutes
            setInterval(() => {
                if (!sessionStorage.getItem('update_dismissed')) {
                    checkForUpdates();
                }
            }, 5 * 60 * 1000);
        };

        // Add CSS for slideUp animation
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            @keyframes slideUp {
                from { transform: translateY(0); opacity: 1; }
                to { transform: translateY(-100%); opacity: 0; }
            }
        `;
        document.head.appendChild(styleSheet);

        // =====================================================
        // STUDENT PROGRESS TRACKING (Admin)
        // =====================================================
        
        window.allProgressData = [];
        window.filteredProgressData = [];

        // Load student progress data
        window.loadStudentProgress = async function() {
            if (!window.isAdminUser) {
                alert("Only admins can view student progress.");
                return;
            }
            
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Fetch all worksheet attempts
                const attemptsSnapshot = await getDocs(collection(window.db_fs, "worksheet_attempts"));
                const worksheetsSnapshot = await getDocs(collection(window.db_fs, "user_worksheets"));
                
                // Build worksheets lookup
                const worksheetsMap = {};
                worksheetsSnapshot.forEach(doc => {
                    worksheetsMap[doc.id] = { id: doc.id, ...doc.data() };
                });
                
                // Build progress data
                window.allProgressData = [];
                const studentsSet = new Set();
                const worksheetsSet = new Set();
                
                attemptsSnapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    data.worksheetInfo = worksheetsMap[data.worksheetId] || { name: 'Unknown Worksheet' };
                    window.allProgressData.push(data);
                    
                    if (data.studentName) studentsSet.add(data.studentName);
                    if (data.worksheetInfo.name) worksheetsSet.add(data.worksheetInfo.name);
                });
                
                // Sort by date descending
                window.allProgressData.sort((a, b) => {
                    const dateA = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt || 0);
                    const dateB = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt || 0);
                    return dateB - dateA;
                });
                
                window.filteredProgressData = [...window.allProgressData];
                
                // Populate filter dropdowns
                populateProgressFilters(studentsSet, worksheetsSet);
                
                // Update summary stats
                updateProgressSummaryStats();
                
                // Render table
                renderProgressTable();
                
            } catch (e) {
                console.error("Error loading student progress:", e);
                document.getElementById('progress-table-body').innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 2rem; text-align: center; color: #dc3545;">
                            Error loading progress data. Please try again.
                        </td>
                    </tr>
                `;
            }
        };

        window.populateProgressFilters = function(studentsSet, worksheetsSet) {
            // Worksheet filter
            const worksheetFilter = document.getElementById('progress-worksheet-filter');
            worksheetFilter.innerHTML = '<option value="all">All Worksheets</option>';
            [...worksheetsSet].sort().forEach(ws => {
                worksheetFilter.innerHTML += `<option value="${ws}">${ws}</option>`;
            });
            
            // Student filter
            const studentFilter = document.getElementById('progress-student-filter');
            studentFilter.innerHTML = '<option value="all">All Students</option>';
            [...studentsSet].sort().forEach(st => {
                studentFilter.innerHTML += `<option value="${st}">${st}</option>`;
            });
        };

        window.updateProgressSummaryStats = function() {
            const data = window.filteredProgressData;
            
            // Total attempts
            document.getElementById('stat-total-attempts').textContent = data.length;
            
            // Completed count
            const completed = data.filter(d => d.status === 'completed').length;
            document.getElementById('stat-completed-count').textContent = completed;
            
            // Average score
            const scoresData = data.filter(d => typeof d.score === 'number');
            const avgScore = scoresData.length > 0 
                ? Math.round(scoresData.reduce((sum, d) => sum + d.score, 0) / scoresData.length) 
                : 0;
            document.getElementById('stat-avg-score').textContent = avgScore + '%';
            
            // Unique students
            const uniqueStudents = new Set(data.map(d => d.studentName)).size;
            document.getElementById('stat-unique-students').textContent = uniqueStudents;
        };

        window.renderProgressTable = function() {
            const tbody = document.getElementById('progress-table-body');
            const data = window.filteredProgressData;
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 3rem; text-align: center; color: #888;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                            <p>No worksheet attempts found</p>
                            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Student progress will appear here when they attempt worksheets</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.map(attempt => {
                const date = attempt.completedAt?.toDate 
                    ? attempt.completedAt.toDate().toLocaleString() 
                    : new Date(attempt.completedAt).toLocaleString();
                
                const scoreClass = attempt.score >= 80 ? 'color: #28a745;' : 
                                   attempt.score >= 50 ? 'color: #f57c00;' : 'color: #dc3545;';
                
                const statusBadge = attempt.status === 'completed' 
                    ? '<span style="background: #d4edda; color: #155724; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;"> Completed</span>'
                    : '<span style="background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;"> In Progress</span>';
                
                const wrongCount = attempt.questionResults ? 
                    attempt.questionResults.filter(q => !q.correct).length : 0;
                const totalCount = attempt.questionResults ? attempt.questionResults.length : 0;
                
                return `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 1rem;">
                            <div style="font-weight: 600;">${attempt.studentName || 'Unknown'}</div>
                            <div style="font-size: 0.8rem; color: #888;">${attempt.studentLevel || ''}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-weight: 500;">${attempt.worksheetInfo?.name || 'Unknown'}</div>
                            <div style="font-size: 0.8rem; color: #888;">${totalCount} questions</div>
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <div style="font-size: 1.3rem; font-weight: bold; ${scoreClass}">${attempt.score || 0}%</div>
                            ${wrongCount > 0 ? `<div style="font-size: 0.75rem; color: #dc3545;">${wrongCount} wrong</div>` : ''}
                        </td>
                        <td style="padding: 1rem; text-align: center;">${statusBadge}</td>
                        <td style="padding: 1rem; text-align: center; font-size: 0.85rem; color: #666;">${date}</td>
                        <td style="padding: 1rem; text-align: center;">
                            <button class="btn" style="background: #1976d2; color: white; padding: 6px 12px; font-size: 0.8rem;" 
                                    onclick="viewProgressDetail('${attempt.id}')">
                                 Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        window.filterProgressByWorksheet = function() {
            const value = document.getElementById('progress-worksheet-filter').value;
            applyProgressFilters();
        };

        window.filterProgressByStudent = function() {
            applyProgressFilters();
        };

        window.filterProgressByStatus = function() {
            applyProgressFilters();
        };

        window.applyProgressFilters = function() {
            const worksheetFilter = document.getElementById('progress-worksheet-filter').value;
            const studentFilter = document.getElementById('progress-student-filter').value;
            const statusFilter = document.getElementById('progress-status-filter').value;
            
            window.filteredProgressData = window.allProgressData.filter(d => {
                if (worksheetFilter !== 'all' && d.worksheetInfo?.name !== worksheetFilter) return false;
                if (studentFilter !== 'all' && d.studentName !== studentFilter) return false;
                if (statusFilter !== 'all' && d.status !== statusFilter) return false;
                return true;
            });
            
            updateProgressSummaryStats();
            renderProgressTable();
        };

        window.refreshStudentProgress = function() {
            loadStudentProgress();
        };

        // =====================================================
        // PENDING QUESTIONS REVIEW SYSTEM
        // =====================================================

        window.pendingQuestionsData = [];
        window.reviewStats = { approvedToday: 0, rejectedToday: 0 };

        // Load pending questions for review
        window.loadPendingQuestions = async function() {
            try {
                const { collection, getDocs, query, where } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

                const questionsRef = collection(window.db_fs, "custom_questions");
                const snapshot = await getDocs(questionsRef);

                window.pendingQuestionsData = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'pending') {
                        window.pendingQuestionsData.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });

                // Sort by creation date (newest first)
                window.pendingQuestionsData.sort((a, b) => {
                    const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                    const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                    return dateB - dateA;
                });

                // Update the count badge
                updatePendingReviewCount();

                // Render the questions
                renderPendingQuestions();

            } catch (e) {
                console.error("Error loading pending questions:", e);
                alert("Error loading pending questions: " + e.message);
            }
        };

        // Update the pending review count badge
        window.updatePendingReviewCount = function() {
            const badge = document.getElementById('pending-review-count');
            const statPending = document.getElementById('stat-pending-count');
            const count = window.pendingQuestionsData ? window.pendingQuestionsData.length : 0;

            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline-block' : 'none';
            }
            if (statPending) {
                statPending.textContent = count;
            }
        };

        // Render pending questions list
        window.renderPendingQuestions = function() {
            const container = document.getElementById('pending-questions-container');
            if (!container) return;

            const categoryFilter = document.getElementById('review-category-filter')?.value || 'all';
            const levelFilter = document.getElementById('review-level-filter')?.value || 'all';

            let filteredQuestions = window.pendingQuestionsData.filter(q => {
                if (categoryFilter !== 'all' && q.category !== categoryFilter) return false;
                if (levelFilter !== 'all' && q.level !== levelFilter) return false;
                return true;
            });

            if (filteredQuestions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #888;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <p>No pending questions to review</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Questions submitted by interns will appear here</p>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredQuestions.forEach(question => {
                const createdDate = question.createdAt
                    ? new Date(question.createdAt).toLocaleDateString()
                    : 'Unknown';

                html += `
                    <div class="pending-question-card" data-id="${question.id}" style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; border-left: 4px solid #ff9800;">
                        <div style="padding: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                                <div>
                                    <h3 style="margin: 0 0 0.5rem 0; color: var(--primary-blue);">${question.title || 'Untitled Question'}</h3>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <span style="font-size: 0.75rem; background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 4px;">${(question.category || 'N/A').toUpperCase()}</span>
                                        <span style="font-size: 0.75rem; background: #f3e5f5; color: #7b1fa2; padding: 2px 8px; border-radius: 4px;">${(question.level || 'N/A').toUpperCase()}</span>
                                        <span style="font-size: 0.75rem; background: #fff8e1; color: #f57c00; padding: 2px 8px; border-radius: 4px;">${question.topic || 'General'}</span>
                                    </div>
                                </div>
                                <div style="text-align: right; font-size: 0.8rem; color: #888;">
                                    <div>Submitted by: ${question.createdBy || 'Unknown'}</div>
                                    <div>${createdDate}</div>
                                </div>
                            </div>

                            <!-- Question Preview -->
                            <div style="background: #f9f9f9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; max-height: 200px; overflow-y: auto;">
                                <div class="question-preview">${question.html || '<em>No content</em>'}</div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                                <button class="btn" onclick="previewPendingQuestion('${question.id}')" style="background: #666; color: white;"> Full Preview</button>
                                <button class="btn" onclick="editPendingQuestion('${question.id}')" style="background: #1976d2; color: white;"> Edit</button>
                                <button class="btn" onclick="rejectQuestion('${question.id}')" style="background: #dc3545; color: white;"> Reject</button>
                                <button class="btn" onclick="approveQuestion('${question.id}')" style="background: #28a745; color: white;"> Approve</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        };

        // Filter pending questions
        window.filterPendingQuestions = function() {
            renderPendingQuestions();
        };

        // Approve a pending question
        window.approveQuestion = async function(questionId) {
            if (!confirm("Approve this question? It will become available to students.")) return;

            try {
                const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

                await updateDoc(doc(window.db_fs, "custom_questions", questionId), {
                    status: 'approved',
                    approvedBy: window.auth.currentUser.email,
                    approvedAt: new Date().toISOString()
                });

                // Update stats
                window.reviewStats.approvedToday++;
                document.getElementById('stat-approved-today').textContent = window.reviewStats.approvedToday;

                // Remove from local data and re-render
                window.pendingQuestionsData = window.pendingQuestionsData.filter(q => q.id !== questionId);
                renderPendingQuestions();
                updatePendingReviewCount();

                // Reload custom questions so the approved question appears
                window.customQuestionsLoaded = false;
                document.querySelectorAll('.custom-question').forEach(el => el.remove());
                if (window.loadCustomQuestions) {
                    await window.loadCustomQuestions();
                }

                alert("Question approved and is now available to students!");

            } catch (e) {
                console.error("Error approving question:", e);
                alert("Error approving question: " + e.message);
            }
        };

        // Reject a pending question
        window.rejectQuestion = async function(questionId) {
            const reason = prompt("Optional: Provide a reason for rejection (or leave empty):");
            if (reason === null) return; // User cancelled

            try {
                const { doc, deleteDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

                // Find the question data before deleting
                const questionData = window.pendingQuestionsData.find(q => q.id === questionId);

                // Store in rejected_questions collection for record keeping
                if (questionData) {
                    await setDoc(doc(window.db_fs, "rejected_questions", questionId), {
                        ...questionData,
                        rejectedBy: window.auth.currentUser.email,
                        rejectedAt: new Date().toISOString(),
                        rejectionReason: reason || 'No reason provided'
                    });
                }

                // Delete from custom_questions
                await deleteDoc(doc(window.db_fs, "custom_questions", questionId));

                // Update stats
                window.reviewStats.rejectedToday++;
                document.getElementById('stat-rejected-today').textContent = window.reviewStats.rejectedToday;

                // Remove from local data and re-render
                window.pendingQuestionsData = window.pendingQuestionsData.filter(q => q.id !== questionId);
                renderPendingQuestions();
                updatePendingReviewCount();

                alert("Question rejected and removed.");

            } catch (e) {
                console.error("Error rejecting question:", e);
                alert("Error rejecting question: " + e.message);
            }
        };

        // Preview a pending question in full
        window.previewPendingQuestion = function(questionId) {
            const question = window.pendingQuestionsData.find(q => q.id === questionId);
            if (!question) return;

            // Create a modal for preview
            let modal = document.getElementById('preview-question-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'preview-question-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-box" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 1rem;">
                            <h3 style="margin: 0; color: #1976d2;"> Question Preview</h3>
                            <button class="btn" style="background: #666; color: white;" onclick="document.getElementById('preview-question-modal').classList.remove('visible')"> Close</button>
                        </div>
                        <div id="preview-question-content"></div>
                        <div style="margin-top: 1.5rem; display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn" onclick="document.getElementById('preview-question-modal').classList.remove('visible')" style="background: #666; color: white;">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            const contentDiv = document.getElementById('preview-question-content');
            contentDiv.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0;">${question.title || 'Untitled'}</h4>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <span style="font-size: 0.75rem; background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 4px;">${(question.category || 'N/A').toUpperCase()}</span>
                        <span style="font-size: 0.75rem; background: #f3e5f5; color: #7b1fa2; padding: 2px 8px; border-radius: 4px;">${(question.level || 'N/A').toUpperCase()}</span>
                        <span style="font-size: 0.75rem; background: #fff8e1; color: #f57c00; padding: 2px 8px; border-radius: 4px;">${question.topic || 'General'}</span>
                    </div>
                </div>
                <div class="answer-template" style="background: #f9f9f9; padding: 1.5rem; border-radius: 8px;">
                    ${question.html || '<em>No content</em>'}
                </div>
            `;

            modal.classList.add('visible');
        };

        // Edit a pending question
        window.editPendingQuestion = function(questionId) {
            const question = window.pendingQuestionsData.find(q => q.id === questionId);
            if (!question) return;

            // Switch to admin tab and load the question for editing
            switchTab('admin');

            // Set up for editing
            window.editingQuestionId = 'q-' + questionId;

            // Populate form fields
            document.getElementById('admin-title').value = question.title || '';
            document.getElementById('admin-category').value = question.category || 'cer';
            if (document.getElementById('admin-level')) {
                document.getElementById('admin-level').value = question.level || 'p3';
            }
            document.getElementById('admin-topic').value = question.topic || 'general';

            // Trigger category change to show appropriate fields
            if (window.handleCategoryChange) {
                handleCategoryChange(question.category || 'cer');
            }

            // Note: The HTML content parsing is complex, so we'll just show a message
            alert("Question loaded for editing. Please review and update the content, then click 'Save Question' to approve with changes, or go back to Review Questions to approve as-is.");

            updateEditingIndicator();
        };

        window.viewProgressDetail = async function(attemptId) {
            const attempt = window.allProgressData.find(a => a.id === attemptId);
            if (!attempt) {
                alert("Attempt not found.");
                return;
            }
            
            // Populate header
            const header = document.getElementById('progress-detail-header');
            const date = attempt.completedAt?.toDate 
                ? attempt.completedAt.toDate().toLocaleString() 
                : new Date(attempt.completedAt).toLocaleString();
            
            header.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">Student</div>
                        <div style="font-weight: 600;">${attempt.studentName || 'Unknown'} (${attempt.studentLevel || 'N/A'})</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">Worksheet</div>
                        <div style="font-weight: 600;">${attempt.worksheetInfo?.name || 'Unknown'}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">Score</div>
                        <div style="font-weight: 600; font-size: 1.2rem; color: ${attempt.score >= 80 ? '#28a745' : attempt.score >= 50 ? '#f57c00' : '#dc3545'};">
                            ${attempt.score || 0}%
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">Date</div>
                        <div style="font-weight: 500;">${date}</div>
                    </div>
                </div>
            `;
            
            // Populate question results
            const questionsContainer = document.getElementById('progress-detail-questions');
            
            if (!attempt.questionResults || attempt.questionResults.length === 0) {
                questionsContainer.innerHTML = '<p style="color: #888; text-align: center;">No detailed question results available.</p>';
            } else {
                questionsContainer.innerHTML = attempt.questionResults.map((q, idx) => {
                    const isCorrect = q.correct;
                    const bgColor = isCorrect ? '#d4edda' : '#f8d7da';
                    const borderColor = isCorrect ? '#28a745' : '#dc3545';
                    const icon = isCorrect ? '' : '';
                    
                    return `
                        <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                <strong style="color: #333;">Question ${idx + 1}: ${q.questionTitle || 'Untitled'}</strong>
                                <span style="font-size: 1.2rem; color: ${borderColor};">${icon}</span>
                            </div>
                            <div style="font-size: 0.9rem; color: #555; margin-bottom: 0.5rem;">
                                <span style="background: white; padding: 2px 8px; border-radius: 4px; margin-right: 8px;">Topic: ${q.topic || 'N/A'}</span>
                                <span style="background: white; padding: 2px 8px; border-radius: 4px;">Type: ${q.type || 'N/A'}</span>
                            </div>
                            ${!isCorrect ? `
                                <div style="margin-top: 0.75rem; padding: 0.75rem; background: white; border-radius: 6px;">
                                    <div style="font-size: 0.85rem;">
                                        <span style="color: #dc3545;">Student's Answer:</span> ${q.studentAnswer || 'No answer'}
                                    </div>
                                    ${q.correctAnswer ? `
                                        <div style="font-size: 0.85rem; margin-top: 0.5rem;">
                                            <span style="color: #28a745;">Correct Answer:</span> ${q.correctAnswer}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('progress-detail-modal').classList.add('visible');
        };

        window.hideProgressDetailModal = function() {
            document.getElementById('progress-detail-modal').classList.remove('visible');
        };

        // Export progress data to CSV
        window.exportProgressToCSV = function() {
            if (window.filteredProgressData.length === 0) {
                alert("No data to export.");
                return;
            }
            
            const headers = ['Student', 'Level', 'Worksheet', 'Score', 'Status', 'Questions', 'Wrong', 'Date'];
            const rows = window.filteredProgressData.map(d => {
                const date = d.completedAt?.toDate 
                    ? d.completedAt.toDate().toLocaleString() 
                    : new Date(d.completedAt).toLocaleString();
                const wrongCount = d.questionResults ? d.questionResults.filter(q => !q.correct).length : 0;
                const totalCount = d.questionResults ? d.questionResults.length : 0;
                
                return [
                    d.studentName || 'Unknown',
                    d.studentLevel || 'N/A',
                    d.worksheetInfo?.name || 'Unknown',
                    (d.score || 0) + '%',
                    d.status || 'unknown',
                    totalCount,
                    wrongCount,
                    date
                ];
            });
            
            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `student_progress_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // Save worksheet attempt when student completes/submits
        window.saveWorksheetAttempt = async function(worksheetId, worksheetName, questionResults, status = 'completed') {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get student info
                const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                let studentName = 'Unknown';
                let studentLevel = 'N/A';
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    if (data.students && data.students.length > 0) {
                        studentName = data.students[0].name;
                        studentLevel = data.students[0].level;
                    } else if (data.studentName) {
                        studentName = data.studentName;
                        studentLevel = data.level || 'N/A';
                    }
                }
                
                // Calculate score
                const correctCount = questionResults.filter(q => q.correct).length;
                const totalCount = questionResults.length;
                const score = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;
                
                await addDoc(collection(window.db_fs, "worksheet_attempts"), {
                    worksheetId: worksheetId,
                    worksheetName: worksheetName,
                    userId: user.uid,
                    userEmail: user.email,
                    studentName: studentName,
                    studentLevel: studentLevel,
                    questionResults: questionResults,
                    score: score,
                    status: status,
                    completedAt: serverTimestamp()
                });
                
                console.log("Worksheet attempt saved successfully");
                
            } catch (e) {
                console.error("Error saving worksheet attempt:", e);
            }
        };

        // =====================================================
        // MESSAGING SYSTEM
        // =====================================================
        
        // Admin email (hidden from users, used internally)
        const ADMIN_EMAIL = 'chungzhikai@gmail.com';
        
        window.currentInboxTab = 'received';
        window.currentViewingMessage = null;

        // Load inbox messages
        window.loadInbox = async function() {
            const container = document.getElementById('inbox-messages-container');
            const emptyMsg = document.getElementById('inbox-empty-msg');
            
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Fetch all messages and filter client-side (avoids need for composite indexes)
                const snapshot = await getDocs(collection(window.db_fs, "messages"));
                
                // Filter messages based on current tab
                let messages = [];
                const now = new Date();
                
                snapshot.forEach(doc => {
                    const msg = { id: doc.id, ...doc.data() };
                    
                    // Check if message is deleted by this user
                    const isDeletedByMe = msg.deletedBy && msg.deletedBy.includes(user.uid);
                    
                    // For deleted tab, show messages deleted by this user
                    if (window.currentInboxTab === 'deleted') {
                        if (isDeletedByMe && (msg.recipientId === user.uid || msg.senderId === user.uid)) {
                            // Check if message is older than 30 days since deletion
                            const deletedAt = msg.deletedAt?.[user.uid];
                            if (deletedAt) {
                                const deletedDate = deletedAt.toDate ? deletedAt.toDate() : new Date(deletedAt);
                                const daysSinceDeleted = (now - deletedDate) / (1000 * 60 * 60 * 24);
                                if (daysSinceDeleted < 30) {
                                    msg.daysUntilPermanentDelete = Math.ceil(30 - daysSinceDeleted);
                                    messages.push(msg);
                                }
                            } else {
                                messages.push(msg);
                            }
                        }
                    } else if (window.currentInboxTab === 'received') {
                        // Show non-deleted received messages
                        if (msg.recipientId === user.uid && !isDeletedByMe) {
                            messages.push(msg);
                        }
                    } else if (window.currentInboxTab === 'sent') {
                        // Show non-deleted sent messages
                        if (msg.senderId === user.uid && !isDeletedByMe) {
                            messages.push(msg);
                        }
                    }
                });
                
                // Sort by date descending (client-side)
                messages.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return dateB - dateA;
                });
                
                if (messages.length === 0) {
                    container.innerHTML = '';
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'inbox-empty';
                    emptyDiv.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;">${window.currentInboxTab === 'deleted' ? '' : ''}</div>
                        <p>${window.currentInboxTab === 'deleted' ? 'No deleted messages' : 'No messages yet'}</p>
                        ${window.currentInboxTab === 'deleted' ? '<p style="font-size: 0.85rem; color: #888;">Deleted messages are permanently removed after 30 days</p>' : ''}
                    `;
                    container.appendChild(emptyDiv);
                    return;
                }
                
                container.innerHTML = '';
                
                messages.forEach(msg => {
                    const date = msg.createdAt ? new Date(msg.createdAt.toDate ? msg.createdAt.toDate() : msg.createdAt).toLocaleString() : 'Unknown';
                    const isUnread = !msg.read && window.currentInboxTab === 'received';
                    
                    // Format sender display with level if available
                    let senderDisplay = msg.senderName || 'Unknown';
                    if (msg.senderLevel) {
                        senderDisplay = `${msg.senderName} (${msg.senderLevel})`;
                    }
                    
                    const card = document.createElement('div');
                    card.className = `message-card ${isUnread ? 'unread' : ''} ${window.currentInboxTab === 'deleted' ? 'deleted-message' : ''}`;
                    card.style.cssText = window.currentInboxTab === 'deleted' ? 'border-left-color: #dc3545; opacity: 0.85;' : '';
                    
                    let cardContent = `
                        <div class="message-header">
                            <span class="message-from">
                                ${isUnread ? '<span class="unread-dot"></span>' : ''}
                                ${window.currentInboxTab === 'received' || window.currentInboxTab === 'deleted' ? senderDisplay : `To: ${msg.recipientName || 'Mr Chung'}`}
                            </span>
                            <span class="message-date">${date}</span>
                        </div>
                        <div class="message-subject">${msg.subject || 'No Subject'}</div>
                        <div class="message-preview">${(msg.message || '').substring(0, 100)}${msg.message?.length > 100 ? '...' : ''}</div>
                    `;
                    
                    if (msg.questionId && window.currentInboxTab !== 'deleted') {
                        cardContent += '<span style="font-size: 0.75rem; background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 4px; margin-top: 5px; display: inline-block;"> Has Question</span>';
                    }
                    
                    if (window.currentInboxTab === 'deleted' && msg.daysUntilPermanentDelete) {
                        cardContent += `<div style="font-size: 0.75rem; color: #dc3545; margin-top: 8px;"> Permanently deleted in ${msg.daysUntilPermanentDelete} days</div>`;
                        cardContent += `<button class="btn" style="background: #28a745; color: white; padding: 5px 10px; font-size: 0.8rem; margin-top: 8px;" onclick="event.stopPropagation(); restoreMessage('${msg.id}')"> Restore</button>`;
                    }
                    
                    card.innerHTML = cardContent;
                    card.onclick = () => viewMessage(msg.id);
                    container.appendChild(card);
                });
                
                // Update unread count
                updateUnreadCount();
                
            } catch (e) {
                console.error("Error loading inbox:", e);
                container.innerHTML = '<p style="color: #dc3545; text-align: center;">Error loading messages. Please try again.</p>';
            }
        };

        window.refreshInbox = function() {
            loadInbox();
        };

        window.switchInboxTab = function(tab) {
            window.currentInboxTab = tab;
            document.getElementById('inbox-tab-received').classList.toggle('active', tab === 'received');
            document.getElementById('inbox-tab-sent').classList.toggle('active', tab === 'sent');
            document.getElementById('inbox-tab-deleted').classList.toggle('active', tab === 'deleted');
            loadInbox();
        };

        // Update unread message count
        window.updateUnreadCount = async function() {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Fetch all messages and count unread client-side (avoids composite index)
                const snapshot = await getDocs(collection(window.db_fs, "messages"));
                let count = 0;
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    // Count unread messages that are not deleted by this user
                    const isDeletedByMe = msg.deletedBy && msg.deletedBy.includes(user.uid);
                    if (msg.recipientId === user.uid && msg.read === false && !isDeletedByMe) {
                        count++;
                    }
                });
                
                // Update header badge
                const headerBadge = document.getElementById('header-inbox-badge');
                if (headerBadge) {
                    headerBadge.textContent = count;
                    headerBadge.style.display = count > 0 ? 'flex' : 'none';
                }
            } catch (e) {
                console.error("Error updating unread count:", e);
            }
        };

        // View a single message
        window.viewMessage = async function(messageId) {
            try {
                const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const msgRef = doc(window.db_fs, "messages", messageId);
                const msgSnap = await getDoc(msgRef);
                
                if (!msgSnap.exists()) {
                    alert("Message not found.");
                    return;
                }
                
                const msg = { id: msgSnap.id, ...msgSnap.data() };
                window.currentViewingMessage = msg;
                
                // Mark as read if recipient
                const user = window.auth?.currentUser;
                if (user && msg.recipientId === user.uid && !msg.read) {
                    await updateDoc(msgRef, { read: true });
                    updateUnreadCount();
                }
                
                const date = msg.createdAt ? new Date(msg.createdAt.toDate ? msg.createdAt.toDate() : msg.createdAt).toLocaleString() : 'Unknown';
                const isReceived = msg.recipientId === user?.uid;
                
                // Format sender display with level
                let senderDisplay = msg.senderName || 'Unknown';
                if (msg.senderLevel) {
                    senderDisplay = `${msg.senderName} (${msg.senderLevel})`;
                }
                
                const content = document.getElementById('view-message-content');
                content.innerHTML = `
                    <div class="view-message-header">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                            ${isReceived ? 'From' : 'To'}: <strong>${isReceived ? senderDisplay : (msg.recipientName || 'Mr Chung')}</strong>
                            ${isReceived && msg.senderLevel ? `<span style="background: #e8f5e9; color: #388e3c; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 8px;">${msg.senderLevel}</span>` : ''}
                        </div>
                        <div style="font-size: 0.85rem; color: #888;">${date}</div>
                        <h3 style="margin: 0.5rem 0; color: #0288d1;">${msg.subject || 'No Subject'}</h3>
                    </div>
                    ${msg.questionContext ? `
                        <div class="view-message-question">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <strong> Related Question:</strong>
                                ${msg.questionId ? `<button class="btn" style="background: #1976d2; color: white; padding: 5px 12px; font-size: 0.8rem;" onclick="viewOriginalQuestion('${msg.questionId}')"> View Full Question</button>` : ''}
                            </div>
                            <div style="color: #555;">${msg.questionContext}</div>
                        </div>
                    ` : ''}
                    <div class="view-message-body">${msg.message || ''}</div>
                `;
                
                // Show/hide reply button based on whether this is a received message
                document.getElementById('btn-reply-message').style.display = isReceived ? 'inline-block' : 'none';
                
                document.getElementById('view-message-modal').classList.add('visible');
                
            } catch (e) {
                console.error("Error viewing message:", e);
                alert("Error loading message.");
            }
        };

        // View original question from message
        window.viewOriginalQuestion = function(questionId) {
            const questionElement = document.getElementById(questionId);
            
            if (questionElement) {
                // Clone the question for the popup
                const clone = questionElement.cloneNode(true);
                clone.id = 'popup-question-clone';
                
                // Remove controls from clone
                clone.querySelectorAll('.worksheet-control-bar, .admin-controls').forEach(el => el.remove());
                
                // Show in a popup modal
                const popupContent = document.getElementById('question-popup-content');
                popupContent.innerHTML = '';
                popupContent.appendChild(clone);
                
                document.getElementById('question-popup-modal').classList.add('visible');
            } else {
                alert("Question not found. It may have been deleted or moved.");
            }
        };

        window.hideQuestionPopup = function() {
            document.getElementById('question-popup-modal').classList.remove('visible');
        };

        window.hideViewMessageModal = function() {
            document.getElementById('view-message-modal').classList.remove('visible');
            window.currentViewingMessage = null;
            loadInbox(); // Refresh inbox to update read status
        };

        // Delete current message (move to trash)
        window.deleteCurrentMessage = async function() {
            if (!window.currentViewingMessage) return;
            
            if (!confirm("Move this message to deleted folder? It will be permanently deleted after 30 days.")) return;
            
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { doc, updateDoc, arrayUnion } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const msgRef = doc(window.db_fs, "messages", window.currentViewingMessage.id);
                
                // Add user to deletedBy array and record deletion time
                await updateDoc(msgRef, {
                    deletedBy: arrayUnion(user.uid),
                    [`deletedAt.${user.uid}`]: new Date()
                });
                
                alert("Message moved to deleted folder.");
                hideViewMessageModal();
                
            } catch (e) {
                console.error("Error deleting message:", e);
                alert("Error deleting message: " + e.message);
            }
        };

        // Restore a deleted message
        window.restoreMessage = async function(messageId) {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const { doc, updateDoc, arrayRemove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const msgRef = doc(window.db_fs, "messages", messageId);
                
                // Remove user from deletedBy array
                await updateDoc(msgRef, {
                    deletedBy: arrayRemove(user.uid)
                });
                
                alert("Message restored!");
                loadInbox();
                
            } catch (e) {
                console.error("Error restoring message:", e);
                alert("Error restoring message: " + e.message);
            }
        };

        // =====================================================
        // ACCOUNT SETTINGS
        // =====================================================

        window.showAccountSettings = async function() {
            const user = window.auth?.currentUser;
            if (!user) {
                alert("Please login first.");
                return;
            }
            
            // Show email
            document.getElementById('settings-email').textContent = user.email;
            
            // Clear password fields
            document.getElementById('settings-new-password').value = '';
            document.getElementById('settings-confirm-password').value = '';
            
            // Load student info
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const studentsContainer = document.getElementById('settings-students-list');
                    studentsContainer.innerHTML = '';
                    
                    // Check if using new students array or old format
                    if (userData.students && Array.isArray(userData.students)) {
                        userData.students.forEach((student, index) => {
                            const entry = document.createElement('div');
                            entry.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                            entry.innerHTML = `
                                <input type="text" class="auth-input student-name-input" value="${student.name || ''}" 
                                       data-index="${index}" placeholder="Student Name" 
                                       style="flex: 1; margin: 0;">
                                <span style="background: #e8f5e9; color: #388e3c; padding: 8px 16px; border-radius: 8px; font-weight: 600; min-width: 60px; text-align: center;">
                                    ${student.level || 'N/A'}
                                </span>
                            `;
                            studentsContainer.appendChild(entry);
                        });
                    } else if (userData.studentName) {
                        // Old format - single student
                        const entry = document.createElement('div');
                        entry.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                        entry.innerHTML = `
                            <input type="text" class="auth-input student-name-input" value="${userData.studentName || ''}" 
                                   data-index="0" placeholder="Student Name" 
                                   style="flex: 1; margin: 0;">
                            <span style="background: #e8f5e9; color: #388e3c; padding: 8px 16px; border-radius: 8px; font-weight: 600; min-width: 60px; text-align: center;">
                                ${userData.level || 'N/A'}
                            </span>
                        `;
                        studentsContainer.appendChild(entry);
                    } else {
                        studentsContainer.innerHTML = '<p style="color: #666;">No students registered</p>';
                    }
                }
            } catch (e) {
                console.error("Error loading user data:", e);
            }
            
            document.getElementById('account-settings-modal').classList.add('visible');
        };

        window.hideAccountSettings = function() {
            document.getElementById('account-settings-modal').classList.remove('visible');
        };

        window.saveAccountSettings = async function() {
            const user = window.auth?.currentUser;
            if (!user) return;
            
            try {
                const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                const userRef = doc(window.db_fs, "users", user.uid);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const nameInputs = document.querySelectorAll('.student-name-input');
                    
                    if (userData.students && Array.isArray(userData.students)) {
                        // Update students array
                        const updatedStudents = [...userData.students];
                        nameInputs.forEach(input => {
                            const index = parseInt(input.dataset.index, 10);
                            if (updatedStudents[index]) {
                                updatedStudents[index].name = input.value.trim();
                            }
                        });
                        await updateDoc(userRef, { students: updatedStudents });
                    } else if (nameInputs.length > 0) {
                        // Old format - update studentName
                        await updateDoc(userRef, { studentName: nameInputs[0].value.trim() });
                    }
                    
                    alert("Settings saved successfully!");
                    hideAccountSettings();
                }
            } catch (e) {
                console.error("Error saving settings:", e);
                alert("Error saving settings: " + e.message);
            }
        };

        window.changePassword = async function() {
            const newPassword = document.getElementById('settings-new-password').value;
            const confirmPassword = document.getElementById('settings-confirm-password').value;
            
            if (!newPassword || !confirmPassword) {
                alert("Please fill in both password fields.");
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert("Passwords do not match.");
                return;
            }
            
            if (newPassword.length < 6) {
                alert("Password must be at least 6 characters.");
                return;
            }
            
            try {
                const user = window.auth?.currentUser;
                if (!user) {
                    alert("Please login again to change your password.");
                    return;
                }
                
                const { updatePassword } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
                
                await updatePassword(user, newPassword);
                
                alert("Password updated successfully!");
                document.getElementById('settings-new-password').value = '';
                document.getElementById('settings-confirm-password').value = '';
                
            } catch (e) {
                console.error("Error changing password:", e);
                if (e.code === 'auth/requires-recent-login') {
                    alert("For security, please logout and login again before changing your password.");
                } else {
                    alert("Error changing password: " + e.message);
                }
            }
        };

        // Reply to a message
        window.replyToMessage = function() {
            if (!window.currentViewingMessage) return;
            
            const msg = window.currentViewingMessage;
            hideViewMessageModal();
            
            // Open new message modal with pre-filled info
            document.getElementById('new-message-modal').classList.add('visible');
            document.getElementById('new-message-subject').value = `Re: ${msg.subject || 'No Subject'}`;
            document.getElementById('new-message-content').value = '';
            
            // Store the recipient info for sending
            window.replyToRecipient = {
                id: msg.senderId,
                name: msg.senderName,
                email: msg.senderEmail
            };
            
            // Hide recipient select for replies
            document.getElementById('recipient-select-group').style.display = 'none';
        };

        // Show new message modal
        window.showNewMessageModal = async function() {
            window.replyToRecipient = null;
            document.getElementById('recipient-select-group').style.display = 'block';
            document.getElementById('new-message-subject').value = '';
            document.getElementById('new-message-content').value = '';
            
            // If admin, load all students as potential recipients
            const select = document.getElementById('message-recipient');
            select.innerHTML = '<option value="">-- Select Recipient --</option>';
            
            if (window.isAdminUser) {
                // Admin can message any student
                try {
                    const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                    const usersSnap = await getDocs(collection(window.db_fs, "users"));
                    
                    const students = [];
                    usersSnap.forEach(doc => {
                        const userData = doc.data();
                        if (userData.email !== ADMIN_EMAIL) {
                            const studentName = userData.studentName || userData.parentName || 'Student';
                            const level = userData.level || (userData.students && userData.students[0]?.level) || '';
                            students.push({
                                id: doc.id,
                                email: userData.email,
                                name: studentName,
                                level: level,
                                displayName: level ? `${studentName} (${level})` : studentName
                            });
                        }
                    });
                    
                    // Sort by level then name
                    students.sort((a, b) => {
                        if (a.level && b.level) {
                            if (a.level !== b.level) return a.level.localeCompare(b.level);
                        }
                        return a.name.localeCompare(b.name);
                    });
                    
                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.dataset.email = student.email;
                        option.dataset.name = student.name;
                        option.dataset.level = student.level;
                        option.textContent = student.displayName;
                        select.appendChild(option);
                    });
                    
                    // Add "All Students" option for broadcast
                    const allOption = document.createElement('option');
                    allOption.value = 'all';
                    allOption.textContent = ' All Students (Broadcast)';
                    select.insertBefore(allOption, select.options[1]);
                    
                } catch (e) {
                    console.error("Error loading students:", e);
                }
            } else {
                // Students can only message admin
                const option = document.createElement('option');
                option.value = 'admin';
                option.textContent = 'Mr Chung (Teacher)';
                select.appendChild(option);
            }
            
            document.getElementById('new-message-modal').classList.add('visible');
        };

        window.hideNewMessageModal = function() {
            document.getElementById('new-message-modal').classList.remove('visible');
            window.replyToRecipient = null;
        };

        // Send a new message
        window.sendNewMessage = async function() {
            const subject = document.getElementById('new-message-subject').value.trim();
            const message = document.getElementById('new-message-content').value.trim();
            
            if (!subject || !message) {
                alert("Please fill in subject and message.");
                return;
            }
            
            try {
                const user = window.auth?.currentUser;
                if (!user) {
                    alert("Please login first.");
                    return;
                }
                
                const { collection, addDoc, getDocs, query, where, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get sender info
                const senderDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                const senderData = senderDoc.exists() ? senderDoc.data() : {};
                const senderName = senderData.studentName || senderData.parentName || user.email;
                
                let recipients = [];
                
                if (window.replyToRecipient) {
                    // Reply to specific person
                    recipients.push(window.replyToRecipient);
                } else {
                    // New message - check recipient select
                    const select = document.getElementById('message-recipient');
                    const selectedValue = select.value;
                    const selectedOption = select.options[select.selectedIndex];
                    
                    if (!selectedValue) {
                        alert("Please select a recipient.");
                        return;
                    }
                    
                    if (selectedValue === 'admin') {
                        // Find admin user ID by fetching all users and filtering
                        const usersSnap = await getDocs(collection(window.db_fs, "users"));
                        let adminFound = false;
                        usersSnap.forEach(adminDoc => {
                            if (adminDoc.data().email === ADMIN_EMAIL) {
                                recipients.push({
                                    id: adminDoc.id,
                                    email: ADMIN_EMAIL,
                                    name: 'Mr Chung'
                                });
                                adminFound = true;
                            }
                        });
                        if (!adminFound) {
                            // Create placeholder if admin hasn't logged in yet
                            recipients.push({
                                id: 'admin_placeholder',
                                email: ADMIN_EMAIL,
                                name: 'Mr Chung'
                            });
                        }
                    } else if (selectedValue === 'all') {
                        // Broadcast to all students
                        const usersSnap = await getDocs(collection(window.db_fs, "users"));
                        usersSnap.forEach(userDoc => {
                            const userData = userDoc.data();
                            if (userData.email !== ADMIN_EMAIL && userDoc.id !== user.uid) {
                                recipients.push({
                                    id: userDoc.id,
                                    email: userData.email,
                                    name: userData.studentName || userData.parentName || 'Student'
                                });
                            }
                        });
                    } else {
                        // Specific student
                        recipients.push({
                            id: selectedValue,
                            email: selectedOption.dataset.email,
                            name: selectedOption.dataset.name
                        });
                    }
                }
                
                // Send message to each recipient
                for (const recipient of recipients) {
                    await addDoc(collection(window.db_fs, "messages"), {
                        senderId: user.uid,
                        senderEmail: user.email,
                        senderName: senderName,
                        recipientId: recipient.id,
                        recipientEmail: recipient.email,
                        recipientName: recipient.name,
                        subject: subject,
                        message: message,
                        read: false,
                        createdAt: new Date()
                    });
                }
                
                alert(`Message sent successfully${recipients.length > 1 ? ` to ${recipients.length} recipients` : ''}!`);
                hideNewMessageModal();
                loadInbox();
                
            } catch (e) {
                console.error("Error sending message:", e);
                alert("Error sending message: " + e.message);
            }
        };

        // =====================================================
        // CONSULT MR CHUNG FUNCTIONALITY
        // =====================================================

        window.currentConsultQuestion = null;

        window.showConsultModal = function(questionElement) {
            // Get question content
            const questionContainer = questionElement.closest('.question-container');
            if (!questionContainer) {
                alert("Could not find question.");
                return;
            }
            
            // Get question title and content
            const title = questionContainer.querySelector('h3')?.textContent || 'Question';
            const questionText = questionContainer.querySelector('p')?.textContent || '';
            
            // Store for sending
            window.currentConsultQuestion = {
                id: questionContainer.id,
                title: title,
                preview: `${title}: ${questionText.substring(0, 200)}${questionText.length > 200 ? '...' : ''}`
            };
            
            // Show preview
            document.getElementById('consult-question-preview').innerHTML = `
                <strong> Question Reference:</strong><br>
                ${window.currentConsultQuestion.preview}
            `;
            
            document.getElementById('consult-message').value = '';
            document.getElementById('consult-modal').classList.add('visible');
        };

        window.hideConsultModal = function() {
            document.getElementById('consult-modal').classList.remove('visible');
            window.currentConsultQuestion = null;
        };

        window.sendConsultMessage = async function() {
            const message = document.getElementById('consult-message').value.trim();
            
            if (!message) {
                alert("Please enter your question or message.");
                return;
            }
            
            try {
                const user = window.auth?.currentUser;
                if (!user) {
                    alert("Please login first.");
                    return;
                }
                
                const { collection, addDoc, getDocs, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Get sender info including level
                const senderDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                const senderData = senderDoc.exists() ? senderDoc.data() : {};
                const senderName = senderData.studentName || senderData.parentName || user.email;
                const senderLevel = senderData.level || (senderData.students && senderData.students[0]?.level) || '';
                
                // Find admin user ID by fetching all users and filtering
                let adminId = 'admin_placeholder';
                const usersSnap = await getDocs(collection(window.db_fs, "users"));
                usersSnap.forEach(adminDoc => {
                    if (adminDoc.data().email === ADMIN_EMAIL) {
                        adminId = adminDoc.id;
                    }
                });
                
                // Create message with student info
                await addDoc(collection(window.db_fs, "messages"), {
                    senderId: user.uid,
                    senderEmail: user.email,
                    senderName: senderName,
                    senderLevel: senderLevel,
                    recipientId: adminId,
                    recipientEmail: ADMIN_EMAIL,
                    recipientName: 'Mr Chung',
                    subject: `Question about: ${window.currentConsultQuestion?.title || 'Practice Question'}`,
                    message: message,
                    questionContext: window.currentConsultQuestion?.preview || '',
                    questionId: window.currentConsultQuestion?.id || '',
                    read: false,
                    createdAt: new Date()
                });
                
                alert("Message sent to Mr Chung! You will receive a reply in your inbox.");
                hideConsultModal();
                updateUnreadCount();
                
            } catch (e) {
                console.error("Error sending message:", e);
                alert("Error sending message: " + e.message);
            }
        };

        // Add Consult button to all question containers
        window.addConsultButtons = function() {
            document.querySelectorAll('.question-container').forEach(container => {
                // Check if buttons already exist
                if (container.querySelector('.consult-btn')) return;
                
                // Find the controls div or create button placement
                const controls = container.querySelector('.controls');
                if (controls) {
                    // Check if add-to-worksheet button exists
                    const addBtn = controls.querySelector('.add-to-worksheet-btn, button[onclick*="addToWorksheet"]');
                    
                    // Create consult button
                    const consultBtn = document.createElement('button');
                    consultBtn.className = 'consult-btn';
                    consultBtn.type = 'button';
                    consultBtn.innerHTML = ' Ask Mr Chung';
                    consultBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        showConsultModal(this);
                    };
                    
                    // Create print button
                    const printBtn = document.createElement('button');
                    printBtn.className = 'print-question-btn';
                    printBtn.type = 'button';
                    printBtn.innerHTML = ' Print';
                    printBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        printSingleQuestion(container);
                    };
                    
                    // Create flag button
                    const flagBtn = document.createElement('button');
                    flagBtn.className = 'flag-question-btn';
                    flagBtn.type = 'button';
                    flagBtn.innerHTML = ' Flag';
                    flagBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        showFlagModal(container);
                    };
                    
                    if (addBtn) {
                        addBtn.insertAdjacentElement('afterend', consultBtn);
                        consultBtn.insertAdjacentElement('afterend', printBtn);
                        printBtn.insertAdjacentElement('afterend', flagBtn);
                    } else {
                        controls.insertBefore(flagBtn, controls.firstChild);
                        controls.insertBefore(printBtn, controls.firstChild);
                        controls.insertBefore(consultBtn, controls.firstChild);
                    }
                }
            });
        };

        // Print a single question
        window.printSingleQuestion = function(questionContainer) {
            if (!questionContainer) return;
            
            // Get question title
            const titleEl = questionContainer.querySelector('h3');
            const title = titleEl ? titleEl.textContent.trim() : 'Question';
            
            // Check if exam mode is enabled
            const isExamMode = window.examModeEnabled || false;
            
            // Clone the question content
            const clone = questionContainer.cloneNode(true);
            
            // Remove buttons and controls from the clone
            clone.querySelectorAll('.controls, .consult-btn, .print-question-btn, .add-to-worksheet-btn, .worksheet-added-btn, button').forEach(el => el.remove());
            
            // Remove any hidden elements
            clone.querySelectorAll('.hidden, [style*="display: none"]').forEach(el => el.remove());
            
            // Exam mode styles
            const examModeStyles = isExamMode ? `
                body, .question-body, .answer-template, .answer-box {
                    filter: grayscale(100%);
                    -webkit-filter: grayscale(100%);
                }
                img {
                    filter: grayscale(100%) contrast(1.1);
                    -webkit-filter: grayscale(100%) contrast(1.1);
                }
                h3 {
                    color: #000 !important;
                    border-bottom-color: #333 !important;
                }
                .question-body {
                    background: #f5f5f5 !important;
                    border-left-color: #333 !important;
                }
            ` : '';
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        * {
                            box-sizing: border-box;
                        }
                        body {
                            font-family: 'Poppins', 'Segoe UI', sans-serif;
                            padding: 2rem;
                            max-width: 800px;
                            margin: 0 auto;
                            color: #333;
                            line-height: 1.6;
                        }
                        h3 {
                            color: #1976d2;
                            border-bottom: 2px solid #1976d2;
                            padding-bottom: 10px;
                            margin-top: 0;
                        }
                        .question-body {
                            background: #f8f9fa;
                            padding: 1.5rem;
                            border-radius: 12px;
                            border-left: 4px solid #1976d2;
                        }
                        .answer-box, .answer-template {
                            background: white;
                            padding: 1rem;
                            border-radius: 8px;
                            margin: 1rem 0;
                        }
                        input[type="text"], .blank-input {
                            border: none;
                            border-bottom: 2px solid #333;
                            background: transparent;
                            min-width: 100px;
                            padding: 2px 5px;
                        }
                        .header-info {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 1.5rem;
                            padding-bottom: 1rem;
                            border-bottom: 1px dashed #ccc;
                        }
                        table {
                            border-collapse: collapse;
                            width: 100%;
                            margin: 1rem 0;
                        }
                        td, th {
                            border: 1px solid #ddd;
                            padding: 8px;
                        }
                        img {
                            max-width: 100%;
                            height: auto;
                        }
                        .exam-mode-indicator {
                            background: #f5f5f5;
                            padding: 5px 10px;
                            border-radius: 4px;
                            font-size: 0.8rem;
                            color: #666;
                            display: ${isExamMode ? 'inline-block' : 'none'};
                        }
                        .print-btn-container {
                            text-align: center;
                            margin-top: 2rem;
                        }
                        .print-btn-container button {
                            padding: 12px 24px;
                            background: #1976d2;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1rem;
                            font-weight: 600;
                        }
                        .print-btn-container button:hover {
                            background: #1565c0;
                        }
                        ${examModeStyles}
                        @media print {
                            .print-btn-container {
                                display: none;
                            }
                            body {
                                padding: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header-info">
                        <span>Name: _______________________</span>
                        <span>Date: _______________</span>
                        <span class="exam-mode-indicator"> Exam Mode</span>
                    </div>
                    ${clone.innerHTML}
                    <div class="print-btn-container">
                        <button onclick="window.print()"> Print Question</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        // =====================================================
        // FLAG QUESTION FUNCTIONALITY
        // =====================================================

        window.currentFlaggedQuestion = null;
        window.flaggedQuestions = [];
        window.currentFlaggedTab = 'pending';

        // Show flag modal
        window.showFlagModal = function(questionContainer) {
            if (!questionContainer) return;
            
            window.currentFlaggedQuestion = questionContainer;
            
            // Get question title
            const titleEl = questionContainer.querySelector('h3');
            const title = titleEl ? titleEl.textContent.trim() : 'Question';
            
            document.getElementById('flag-question-title').textContent = title;
            document.getElementById('flag-comment-input').value = '';
            document.getElementById('flag-question-modal').classList.add('visible');
        };

        // Hide flag modal
        window.hideFlagModal = function() {
            document.getElementById('flag-question-modal').classList.remove('visible');
            window.currentFlaggedQuestion = null;
        };

        // Submit flag (will be connected to Firebase in module)
        window.submitFlag = async function() {
            const comment = document.getElementById('flag-comment-input').value.trim();
            
            if (!comment) {
                alert('Please describe what is wrong with the question.');
                return;
            }
            
            if (!window.currentFlaggedQuestion) {
                alert('No question selected.');
                return;
            }
            
            const questionContainer = window.currentFlaggedQuestion;
            const titleEl = questionContainer.querySelector('h3');
            const questionTitle = titleEl ? titleEl.textContent.trim() : 'Unknown Question';
            const questionId = questionContainer.id || `q-${Date.now()}`;
            
            // Get question type/category from URL or tab
            const questionType = window.currentActiveTab || 'cer';
            
            // Call Firebase function if available
            if (window.submitFlagToFirebase) {
                await window.submitFlagToFirebase({
                    questionId: questionId,
                    questionTitle: questionTitle,
                    questionType: questionType,
                    comment: comment,
                    questionHtml: questionContainer.innerHTML
                });
            } else {
                console.log('Flag submitted:', { questionId, questionTitle, questionType, comment });
                alert('Thank you for reporting this issue! An admin will review it soon.');
            }
            
            hideFlagModal();
        };

        // Load flagged questions (admin only)
        window.loadFlaggedQuestions = async function() {
            if (!window.isAdminUser) return;
            
            const container = document.getElementById('flagged-questions-container');
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #888;">Loading flagged questions...</div>';
            
            if (window.loadFlaggedQuestionsFromFirebase) {
                await window.loadFlaggedQuestionsFromFirebase();
            }
            
            renderFlaggedQuestions();
        };

        // Render flagged questions based on current tab
        window.renderFlaggedQuestions = function() {
            const container = document.getElementById('flagged-questions-container');
            const emptyMsg = document.getElementById('flagged-empty-msg');
            
            let filtered = window.flaggedQuestions || [];
            
            if (window.currentFlaggedTab === 'pending') {
                filtered = filtered.filter(q => q.status !== 'resolved');
            } else if (window.currentFlaggedTab === 'resolved') {
                filtered = filtered.filter(q => q.status === 'resolved');
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '';
                if (emptyMsg) {
                    emptyMsg.style.display = 'block';
                    emptyMsg.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;">${window.currentFlaggedTab === 'resolved' ? '' : ''}</div>
                        <p>${window.currentFlaggedTab === 'pending' ? 'No pending flags' : window.currentFlaggedTab === 'resolved' ? 'No resolved flags' : 'No flagged questions'}</p>
                    `;
                }
                return;
            }
            
            if (emptyMsg) emptyMsg.style.display = 'none';
            
            container.innerHTML = filtered.map(flag => `
                <div class="flagged-question-card ${flag.status === 'resolved' ? 'resolved' : ''}" data-flag-id="${flag.id}">
                    <div class="flagged-question-header">
                        <div>
                            <div class="flagged-question-title">${flag.questionTitle || 'Unknown Question'}</div>
                            <div class="flagged-question-meta">
                                <span>Type: ${flag.questionType || 'N/A'}</span>  
                                <span>Flagged by: ${flag.userEmail || 'Anonymous'}</span>  
                                <span>${flag.createdAt ? new Date(flag.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown date'}</span>
                            </div>
                        </div>
                        <span class="flagged-status-badge ${flag.status === 'resolved' ? 'resolved' : 'pending'}">
                            ${flag.status === 'resolved' ? ' Resolved' : ' Pending'}
                        </span>
                    </div>
                    <div class="flagged-question-comment">${flag.comment || 'No comment provided'}</div>
                    <div class="flagged-question-actions">
                        <button class="btn" style="background: #667eea; color: white;" onclick="viewFlaggedQuestion('${flag.id}')"> View Question</button>
                        <button class="btn" style="background: #4CAF50; color: white;" onclick="editFlaggedQuestion('${flag.questionId}')"> Edit</button>
                        ${flag.status !== 'resolved' ? 
                            `<button class="btn" style="background: #ff9800; color: white;" onclick="resolveFlaggedQuestion('${flag.id}')"> Mark Resolved</button>` : 
                            `<button class="btn" style="background: #9e9e9e; color: white;" onclick="reopenFlaggedQuestion('${flag.id}')"> Reopen</button>`
                        }
                        <button class="btn" style="background: #dc3545; color: white;" onclick="deleteFlaggedQuestion('${flag.id}')"> Delete Flag</button>
                    </div>
                </div>
            `).join('');
        };

        // Switch flagged questions tab
        window.switchFlaggedTab = function(tab) {
            window.currentFlaggedTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('[id^="flagged-tab-"]').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(`flagged-tab-${tab}`);
            if (activeBtn) activeBtn.classList.add('active');
            
            renderFlaggedQuestions();
        };

        // View flagged question (show modal with question content)
        window.viewFlaggedQuestion = function(flagId) {
            const flag = window.flaggedQuestions.find(f => f.id === flagId);
            if (!flag || !flag.questionHtml) {
                alert('Question content not available.');
                return;
            }
            
            const content = document.getElementById('question-popup-content');
            content.innerHTML = flag.questionHtml;
            document.getElementById('question-popup-modal').classList.add('visible');
        };

        // Edit flagged question (navigate to question)
        window.editFlaggedQuestion = function(questionId) {
            // Try to find and scroll to the question
            const question = document.getElementById(questionId);
            if (question) {
                // Switch to the appropriate tab
                const flag = window.flaggedQuestions.find(f => f.questionId === questionId);
                if (flag && flag.questionType) {
                    switchTab(flag.questionType, document.querySelector(`.tab-btn[data-type="${flag.questionType}"]`));
                }
                setTimeout(() => {
                    question.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    question.style.boxShadow = '0 0 20px rgba(255, 152, 0, 0.5)';
                    setTimeout(() => question.style.boxShadow = '', 3000);
                }, 300);
            } else {
                alert('Could not locate question. It may have been deleted or is from a different level.');
            }
        };

        // Resolve flagged question (will be connected to Firebase in module)
        window.resolveFlaggedQuestion = async function(flagId) {
            if (window.updateFlagStatusInFirebase) {
                await window.updateFlagStatusInFirebase(flagId, 'resolved');
            }
            
            // Update local data
            const flag = window.flaggedQuestions.find(f => f.id === flagId);
            if (flag) flag.status = 'resolved';
            
            renderFlaggedQuestions();
            updateFlaggedCount();
        };

        // Reopen flagged question
        window.reopenFlaggedQuestion = async function(flagId) {
            if (window.updateFlagStatusInFirebase) {
                await window.updateFlagStatusInFirebase(flagId, 'pending');
            }
            
            const flag = window.flaggedQuestions.find(f => f.id === flagId);
            if (flag) flag.status = 'pending';
            
            renderFlaggedQuestions();
            updateFlaggedCount();
        };

        // Delete flagged question (will be connected to Firebase in module)
        window.deleteFlaggedQuestion = async function(flagId) {
            if (!confirm('Are you sure you want to delete this flag? This cannot be undone.')) return;
            
            if (window.deleteFlagFromFirebase) {
                await window.deleteFlagFromFirebase(flagId);
            }
            
            window.flaggedQuestions = window.flaggedQuestions.filter(f => f.id !== flagId);
            renderFlaggedQuestions();
            updateFlaggedCount();
        };

        // Update flagged count badge
        window.updateFlaggedCount = function() {
            const badge = document.getElementById('header-flagged-badge');
            if (!badge) return;
            
            const pendingCount = (window.flaggedQuestions || []).filter(f => f.status !== 'resolved').length;
            
            if (pendingCount > 0) {
                badge.textContent = pendingCount > 99 ? '99+' : pendingCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        };

        // =====================================================
        // TAB & VIEW SWITCHING
        // =====================================================

        window.switchTab = function (type, btn) {
            window.currentActiveTab = type;

            // Close mobile sidebar if open
            if (window.innerWidth <= 768) {
                closeMobileSidebar();
            }

            // Update button states
            const allBtns = document.querySelectorAll('.tab-btn, #btn-sidebar-admin, #btn-sidebar-worksheet, #btn-sidebar-saved-worksheets, #btn-sidebar-practice, #btn-sidebar-lessons, #btn-sidebar-progress, #btn-sidebar-leaderboard, #btn-sidebar-my-progress, #header-inbox-btn, #header-flagged-btn');
            allBtns.forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            // Hide all views
            const mainContentArea = document.getElementById('main-content-area');
            mainContentArea.querySelectorAll('.view-content').forEach(el => {
                el.classList.add('hidden');
            });
            
            // List of special tabs (admin, worksheet, etc) - these need topic containers hidden
            const specialTabs = ['admin', 'worksheet', 'saved-worksheets', 'practice', 'inbox', 'lessons', 'lesson-detail', 'student-progress', 'my-progress', 'flagged', 'leaderboard', 'question-list', 'review-questions'];
            
            // Hide all topic containers for special tabs (practice mode should be a full-page view)
            if (specialTabs.includes(type)) {
                mainContentArea.querySelectorAll('.topic-content').forEach(el => {
                    el.classList.add('hidden');
                });
            }

            // Show target view
            const target = document.getElementById(`view-${type}`);
            if (target) {
                target.classList.remove('hidden');
            }

            // Handle sidebar visibility
            const oeqSidebarContent = document.getElementById('oeq-sidebar-content');
            const mcqSidebarContent = document.getElementById('mcq-sidebar-content');
            
            // List of all OEQ tabs
            const oeqTabs = ['cer', 'definition', 'single-relationship', 'double-relationship', 'fairness', 'reliability', 'accuracy', 'constant-variable', 'explanation', 'control-setup'];
            
            if (oeqSidebarContent && mcqSidebarContent) {
                if (oeqTabs.includes(type)) {
                    // Show OEQ sidebar for all OEQ tabs and update topics
                    oeqSidebarContent.classList.remove('hidden');
                    mcqSidebarContent.classList.add('hidden');
                    window.currentOeqTab = type;
                    updateOeqSidebar(type);
                } else if (specialTabs.includes(type)) {
                    // Hide both sidebars for special tabs
                    oeqSidebarContent.classList.add('hidden');
                    mcqSidebarContent.classList.add('hidden');
                }
            }

            // Update border color and header line color
            const appBody = document.querySelector('.app-body');
            const headerLine = document.getElementById('header-color-line');
            if (window.typeColors[type]) {
                const color = window.typeColors[type];
                if (appBody) {
                    appBody.style.borderTopColor = color;
                }
                if (headerLine) {
                    // Create a gradient effect for the line
                    const lighterColor = adjustColorBrightness(color, 20);
                    headerLine.style.background = `linear-gradient(90deg, ${color} 0%, ${lighterColor} 50%, ${color} 100%)`;
                }
            }

            // Refresh worksheet UI when switching to worksheet tab
            if (type === 'worksheet') {
                updateWorksheetUI();
            }
            
            // Load saved worksheets when switching to that tab
            if (type === 'saved-worksheets') {
                loadSavedWorksheets();
            }
            
            // Load shared lessons when switching to lessons tab
            if (type === 'lessons') {
                loadSharedLessons();
            }
            
            // Load practice mode when switching to practice tab
            if (type === 'practice') {
                loadPracticeMode();
            }
            
            // Load inbox when switching to inbox tab
            if (type === 'inbox') {
                loadInbox();
            }
            
            // Load student progress when switching to student-progress tab
            if (type === 'student-progress') {
                loadStudentProgress();
            }
            
            // Load leaderboard when switching to leaderboard tab
            if (type === 'leaderboard') {
                loadLeaderboard();
            }
            
            // Load my progress when switching to my-progress tab
            if (type === 'my-progress') {
                loadMyProgress();
            }
            
            // Load question list when switching to question-list tab
            if (type === 'question-list') {
                loadQuestionList();
            }
            
            // Update version display when switching to admin tab
            if (type === 'admin') {
                updateVersionDisplay();
            }
            
            // Load flagged questions when switching to flagged tab
            if (type === 'flagged') {
                loadFlaggedQuestions();
            }

            // Load pending questions when switching to review-questions tab
            if (type === 'review-questions') {
                loadPendingQuestions();
            }
        };
        
        // Helper function to adjust color brightness
        function adjustColorBrightness(hex, percent) {
            // Remove # if present
            hex = hex.replace('#', '');
            
            // Parse the hex color
            let r = parseInt(hex.substring(0, 2), 16);
            let g = parseInt(hex.substring(2, 4), 16);
            let b = parseInt(hex.substring(4, 6), 16);
            
            // Adjust brightness
            r = Math.min(255, Math.floor(r + (255 - r) * (percent / 100)));
            g = Math.min(255, Math.floor(g + (255 - g) * (percent / 100)));
            b = Math.min(255, Math.floor(b + (255 - b) * (percent / 100)));
            
            // Convert back to hex
            return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        // =====================================================
        // MODE SWITCHING (OEQ/MCQ)
        // =====================================================

        // Note: currentMode is already set to 'mcq' in global state above
        window.examModeEnabled = false;

        // Toggle mode using iOS-style switch
        window.toggleMode = function() {
            const newMode = window.currentMode === 'oeq' ? 'mcq' : 'oeq';
            switchMode(newMode);
        };

        // Toggle Exam Mode (Colour/Monochrome)
        window.toggleExamMode = function() {
            window.examModeEnabled = !window.examModeEnabled;
            const toggleContainer = document.querySelector('.exam-mode-toggle-container');
            
            if (window.examModeEnabled) {
                document.body.classList.add('exam-mode');
                if (toggleContainer) toggleContainer.classList.add('exam-active');
                localStorage.setItem('examMode', 'true');
            } else {
                document.body.classList.remove('exam-mode');
                if (toggleContainer) toggleContainer.classList.remove('exam-active');
                localStorage.setItem('examMode', 'false');
            }
        };

        // Initialize exam mode from localStorage
        window.initExamMode = function() {
            const savedExamMode = localStorage.getItem('examMode');
            if (savedExamMode === 'true') {
                window.examModeEnabled = true;
                document.body.classList.add('exam-mode');
                const toggleContainer = document.querySelector('.exam-mode-toggle-container');
                if (toggleContainer) toggleContainer.classList.add('exam-active');
            }
        };

        window.switchMode = function (mode) {
            window.currentMode = mode;
            const oeqSidebar = document.getElementById('oeq-sidebar-content');
            const mcqSidebar = document.getElementById('mcq-sidebar-content');
            const container = document.getElementById('header-tabs-container');
            const toggle = document.getElementById('mode-toggle');
            const oeqLabel = document.querySelector('.ios-toggle-label:first-of-type');
            const mcqLabel = document.querySelector('.ios-toggle-label:last-of-type');
            const headerLevelSelect = document.getElementById('header-level-select');

            // Update iOS toggle state
            if (toggle) {
                if (mode === 'mcq') {
                    toggle.classList.add('mcq-active');
                } else {
                    toggle.classList.remove('mcq-active');
                }
            }

            // Update labels
            if (oeqLabel && mcqLabel) {
                oeqLabel.classList.toggle('active', mode === 'oeq');
                mcqLabel.classList.toggle('active', mode === 'mcq');
            }

            if (mode === 'mcq') {
                oeqSidebar.classList.add('hidden');
                mcqSidebar.classList.remove('hidden');
                document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                // Sync header level selector with MCQ level
                if (headerLevelSelect) headerLevelSelect.value = window.currentMcqLevel;
                renderMcqHeaders();
            } else {
                oeqSidebar.classList.remove('hidden');
                mcqSidebar.classList.add('hidden');
                // Sync header level selector with OEQ level
                if (headerLevelSelect) headerLevelSelect.value = window.currentOeqLevel;
                renderOeqHeaderTabs('cer');
                switchTab('cer', document.querySelector('.tab-btn[data-type="cer"]'));
                if (window.isAdminUser) document.getElementById('btn-sidebar-admin').classList.remove('hidden');
            }
        };

        // =====================================================
        // MCQ FUNCTIONALITY
        // =====================================================

        window.renderMcqHeaders = function () {
            const container = document.getElementById('header-tabs-container');
            const topics = window.mcqCurriculum[window.currentMcqLevel] || [];
            const pastelColors = ['#AEC6CF', '#FFB7B2', '#FFDAC1', '#E2F0CB', '#C7CEEA', '#FDFD96', '#B5EAD7', '#FF9AA2', '#E0BBE4', '#ADD8E6'];

            container.innerHTML = topics.map((t, i) => {
                const topicId = t.toLowerCase().replace(/\s+/g, '-');
                const activeClass = i === 0 ? 'active' : '';
                const color = pastelColors[i % pastelColors.length];
                if (i === 0) window.currentMcqTopic = topicId;
                
                // Count questions for this MCQ topic
                const topicContainerId = `topic-mcq-${topicId}`;
                const topicContainer = document.getElementById(topicContainerId);
                const questionCount = topicContainer ? topicContainer.querySelectorAll('.question-container').length : 0;
                const countBadge = `<span class="tab-count-badge">${questionCount}</span>`;
                
                return `<button class="tab-btn ${activeClass}" onclick="switchMcqTopicAndTab('${topicId}', this)" style="background-color: ${color};">${t}${countBadge}</button>`;
            }).join('');

            // Set initial header line color to first topic's color
            const headerLine = document.getElementById('header-color-line');
            if (headerLine && topics.length > 0) {
                const firstColor = pastelColors[0];
                const lighterColor = adjustColorBrightness(firstColor, 20);
                headerLine.style.background = `linear-gradient(90deg, ${firstColor} 0%, ${lighterColor} 50%, ${firstColor} 100%)`;
            }

            renderMcqQuestionList();
        };

        window.switchMcqTopicAndTab = function (topicId, btn) {
            document.querySelectorAll('#header-tabs-container .tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            window.currentMcqTopic = topicId;
            
            // Update header line color based on the button's background color
            const headerLine = document.getElementById('header-color-line');
            if (headerLine && btn) {
                const btnColor = btn.style.backgroundColor || '#AEC6CF';
                // Convert rgb to hex if needed
                let hexColor = btnColor;
                if (btnColor.startsWith('rgb')) {
                    const rgb = btnColor.match(/\d+/g);
                    if (rgb) {
                        hexColor = '#' + ((1 << 24) + (parseInt(rgb[0], 10) << 16) + (parseInt(rgb[1], 10) << 8) + parseInt(rgb[2], 10)).toString(16).slice(1);
                    }
                }
                const lighterColor = adjustColorBrightness(hexColor, 20);
                headerLine.style.background = `linear-gradient(90deg, ${hexColor} 0%, ${lighterColor} 50%, ${hexColor} 100%)`;
            }
            
            renderMcqQuestionList();
        };

        window.renderMcqQuestionList = function () {
            const nav = document.getElementById('mcq-question-nav');
            if (!nav) return;

            const topicId = `topic-mcq-${window.currentMcqTopic}`;
            const container = document.getElementById(topicId);
            const questions = container ? container.querySelectorAll('.question-container') : [];

            nav.innerHTML = Array.from(questions).map((q, i) => {
                const qId = q.id;
                return `<button onclick="scrollToMcqQuestion('${qId}', this)">Question ${i + 1}</button>`;
            }).join('');

            document.querySelectorAll('.topic-content').forEach(t => t.classList.add('hidden'));
            if (container) container.classList.remove('hidden');
        };

        window.scrollToMcqQuestion = function (qId, btn) {
            document.querySelectorAll('#mcq-question-nav button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const q = document.getElementById(qId);
            if (q) q.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        window.checkMcq = function (containerId) {
            const container = document.getElementById(containerId);
            const selected = container.querySelector('input[type="radio"]:checked');
            if (!selected) return alert("Please select an option!");

            const isCorrect = selected.dataset.correct === 'true';
            
            const allOptions = container.querySelectorAll('.mcq-option');
            allOptions.forEach(opt => {
                const radio = opt.querySelector('input');
                // Remove any existing feedback icons
                opt.querySelectorAll('.option-feedback-icon').forEach(i => i.remove());
                
                if (radio.dataset.correct === 'true') {
                    opt.style.borderColor = 'var(--correct-color)';
                    opt.style.background = '#e8f5e9';
                    // Add checkmark inside the correct answer option
                    const icon = document.createElement('span');
                    icon.className = 'option-feedback-icon';
                    icon.textContent = '';
                    icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #28a745; margin-left: auto; padding-left: 10px;';
                    opt.style.display = 'flex';
                    opt.style.alignItems = 'center';
                    opt.appendChild(icon);
                } else if (radio.checked) {
                    opt.style.borderColor = 'var(--incorrect-color)';
                    opt.style.background = '#ffebee';
                    // Add cross inside the wrong selected option
                    const icon = document.createElement('span');
                    icon.className = 'option-feedback-icon';
                    icon.textContent = '';
                    icon.style.cssText = 'font-size: 1.3rem; font-weight: bold; color: #dc3545; margin-left: auto; padding-left: 10px;';
                    opt.style.display = 'flex';
                    opt.style.alignItems = 'center';
                    opt.appendChild(icon);
                }
                radio.disabled = true;
            });
            
            const submitBtn = container.querySelector('.submit-btn');
            submitBtn.disabled = true;
            
            // Show explanation if it exists
            const explanationBox = container.querySelector('.explanation-box');
            if (explanationBox) {
                explanationBox.style.display = 'block';
            }
            
            // Show video if it exists
            const videoContainer = container.querySelector('.video-container');
            if (videoContainer) {
                videoContainer.style.display = 'block';
            }
            
            // Track answer for practice mode and regular mode
            const questionId = container.closest('.question-container')?.id;
            if (questionId) {
                // Track for practice mode if in practice
                if (window.trackAnswerForPractice) {
                    window.trackAnswerForPractice(questionId, isCorrect);
                }
                // Always track question attempts (for progress tracking)
                if (window.trackQuestionAttempt) {
                    window.trackQuestionAttempt(questionId, isCorrect);
                }
            }
        };

        // =====================================================
        // ADMIN FUNCTIONALITY
        // =====================================================

        window.handleTopicChange = function (value) {
            const newTopicInput = document.getElementById('admin-new-topic');
            if (value === 'new-topic') {
                newTopicInput.classList.remove('hidden');
            } else {
                newTopicInput.classList.add('hidden');
            }
        };

        window.updateAdminTopicsByLevel = function (level) {
            const topicSelect = document.getElementById('admin-topic');
            const topics = window.mcqCurriculum[level] || [];
            let html = topics.map(t => `<option value="${t.toLowerCase().replace(/\s+/g, '-')}">${t}</option>`).join('');
            html += `<option value="new-topic">-- Add Custom Topic --</option>`;
            topicSelect.innerHTML = html;
        };

        window.handleCategoryChange = function (value) {
            const mcqOptions = document.getElementById('mcq-options-container');
            const levelContainer = document.getElementById('admin-level-container');
            const previewInstructions = document.querySelector('#admin-preview-section p');
            const processBtn = document.getElementById('admin-process-btn');

            if (value === 'mcq') {
                mcqOptions.classList.remove('hidden');
                levelContainer.classList.remove('hidden');
                if (processBtn) processBtn.classList.add('hidden');
                updateAdminTopicsByLevel(document.getElementById('admin-level').value);
                if (previewInstructions) previewInstructions.classList.add('hidden');
            } else {
                mcqOptions.classList.add('hidden');
                levelContainer.classList.add('hidden');
                if (processBtn) processBtn.classList.remove('hidden');
                const topicSelect = document.getElementById('admin-topic');
                topicSelect.innerHTML = `
                    <option value="heat">Heat</option>
                    <option value="light">Light</option>
                    <option value="materials">Materials</option>
                    <option value="air">Air</option>
                    <option value="water">Water</option>
                    <option value="new-topic">-- Add Custom Topic --</option>
                `;
                if (previewInstructions) previewInstructions.classList.remove('hidden');
            }
        };

        function addAdminBlock(type) {
            const id = Date.now();
            const block = { id, type, value: '' };
            
            // Video and explanation should always be at the end
            if (type === 'video' || type === 'explanation') {
                window.adminBlocks.push(block);
            } else {
                // Insert before any video/explanation blocks
                const lastContentIndex = window.adminBlocks.findIndex(b => b.type === 'video' || b.type === 'explanation');
                if (lastContentIndex === -1) {
                    window.adminBlocks.push(block);
                } else {
                    window.adminBlocks.splice(lastContentIndex, 0, block);
                }
            }
            renderAdminBlocks();
        }

        function renderAdminBlocks() {
            const container = document.getElementById('admin-blocks');
            if (!container) return;
            
            let html = '';
            let addedSeparator = false;
            
            window.adminBlocks.forEach((block, index) => {
                // Add separator before first video/explanation block
                if (!addedSeparator && (block.type === 'video' || block.type === 'explanation')) {
                    html += `<div style="margin: 1.5rem 0; padding: 0.8rem; background: linear-gradient(90deg, #e3f2fd 0%, #f5f5f5 50%, #e3f2fd 100%); border-radius: 8px; text-align: center;">
                        <span style="color: #666; font-size: 0.85rem; font-weight: 500;"> Shown after students answer (drag blocks above to reorder)</span>
                    </div>`;
                    addedSeparator = true;
                }
                
                // Handle table blocks specially
                if (block.type === 'table') {
                    html += renderTableBlock(block);
                    return;
                }
                
                let inputHtml = '';
                if (block.type === 'text' || block.type === 'answer' || block.type === 'explanation') {
                    const placeholders = {
                        'answer': 'Enter text to be blanked... Use [brackets] around words to make them blanks.',
                        'explanation': 'Enter step-by-step explanation...',
                        'text': 'Enter question text...'
                    };
                    
                    // Add formatting toolbar for text and explanation blocks
                    const formattingToolbar = `
                        <div class="text-formatting-toolbar">
                            <!-- Text Style -->
                            <div class="toolbar-group">
                                <button type="button" onclick="formatText(${block.id}, 'bold')" class="format-btn" title="Bold (Ctrl+B)"><strong>B</strong></button>
                                <button type="button" onclick="formatText(${block.id}, 'italic')" class="format-btn" title="Italic (Ctrl+I)"><em>I</em></button>
                                <button type="button" onclick="formatText(${block.id}, 'underline')" class="format-btn" title="Underline (Ctrl+U)"><u>U</u></button>
                            </div>
                            
                            <!-- Alignment -->
                            <div class="toolbar-group">
                                <button type="button" onclick="formatText(${block.id}, 'justifyLeft')" class="format-btn" title="Align Left">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg>
                                </button>
                                <button type="button" onclick="formatText(${block.id}, 'justifyCenter')" class="format-btn" title="Align Center">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>
                                </button>
                                <button type="button" onclick="formatText(${block.id}, 'justifyRight')" class="format-btn" title="Align Right">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/></svg>
                                </button>
                                <button type="button" onclick="formatText(${block.id}, 'justifyFull')" class="format-btn" title="Justify">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                                </button>
                            </div>
                            
                            <!-- Indentation -->
                            <div class="toolbar-group">
                                <button type="button" onclick="formatText(${block.id}, 'outdent')" class="format-btn" title="Decrease Indent">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/><polyline points="7 9 4 12 7 15"/></svg>
                                </button>
                                <button type="button" onclick="formatText(${block.id}, 'indent')" class="format-btn" title="Increase Indent">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="9" y1="18" x2="21" y2="18"/><polyline points="4 9 7 12 4 15"/></svg>
                                </button>
                            </div>
                            
                            <!-- Lists/Numbering -->
                            <div class="toolbar-group" style="border-right: none;">
                                <button type="button" onclick="formatText(${block.id}, 'insertUnorderedList')" class="format-btn" title="Bullet List">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="4" cy="6" r="1.5" fill="currentColor"/><circle cx="4" cy="12" r="1.5" fill="currentColor"/><circle cx="4" cy="18" r="1.5" fill="currentColor"/><line x1="9" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="9" y1="18" x2="21" y2="18"/></svg>
                                </button>
                                <button type="button" onclick="formatText(${block.id}, 'insertOrderedList')" class="format-btn" title="Numbered List">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><text x="2" y="8" font-size="6" fill="currentColor">1</text><text x="2" y="14" font-size="6" fill="currentColor">2</text><text x="2" y="20" font-size="6" fill="currentColor">3</text><line x1="9" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="9" y1="18" x2="21" y2="18"/></svg>
                                </button>
                                <select class="list-type-select" onchange="insertNumberedList(${block.id}, this.value); this.selectedIndex=0;" title="List Style">
                                    <option value="">List Style </option>
                                    <optgroup label="Numbers">
                                        <option value="decimal">1, 2, 3...</option>
                                        <option value="decimal-paren">1), 2), 3)...</option>
                                    </optgroup>
                                    <optgroup label="Letters">
                                        <option value="lower-alpha">a, b, c...</option>
                                        <option value="upper-alpha">A, B, C...</option>
                                        <option value="lower-alpha-paren">a), b), c)...</option>
                                        <option value="upper-alpha-paren">A), B), C)...</option>
                                    </optgroup>
                                    <optgroup label="Roman Numerals">
                                        <option value="lower-roman">i, ii, iii...</option>
                                        <option value="upper-roman">I, II, III...</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        <div id="editor-${block.id}" 
                             class="rich-text-editor" 
                             contenteditable="true" 
                             data-placeholder="${placeholders[block.type]}"
                             oninput="updateBlockValueFromEditor(${block.id})"
                             onpaste="handleEditorPaste(event)"
                             onkeydown="handleEditorKeydown(event, ${block.id})"
                        >${block.value || ''}</div>
                    `;
                    inputHtml = formattingToolbar;
                } else if (block.type === 'image') {
                    const previewUrl = convertDropboxUrl(block.value);
                    inputHtml = `
                        <input type="text" class="auth-input" style="margin-top: 10px;" oninput="updateBlockValue(${block.id}, this.value); updateImagePreview(${block.id})" value="${block.value}" placeholder="Enter image URL (Dropbox, Imgur, etc.)...">
                        <div id="img-preview-${block.id}" style="margin-top: 10px; text-align: center;">
                            ${block.value ? `<img src="${previewUrl}" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #ddd;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><span style="display: none; color: #dc3545; font-size: 0.85rem;"> Image failed to load</span>` : '<span style="color: #888; font-size: 0.85rem;">Image preview will appear here</span>'}
                        </div>
                    `;
                } else if (block.type === 'video') {
                    inputHtml = `<input type="text" class="auth-input" style="margin-top: 10px;" oninput="updateBlockValue(${block.id}, this.value)" value="${block.value}" placeholder="Enter Video URL (Dropbox or YouTube)...">`;
                }

                const typeColors = {
                    'answer': 'background: #fffdf0; border-color: #fbc02d;',
                    'explanation': 'background: #f0f4ff; border-color: #007bff;',
                    'video': 'background: #fdf2f2; border-color: #dc3545;',
                    'image': 'background: #f5f5f5; border-color: #9e9e9e;',
                    'text': ''
                };
                
                const typeLabels = {
                    'text': ' TEXT BLOCK',
                    'answer': ' ANSWER BLOCK (fill-in-blank)',
                    'explanation': ' EXPLANATION (shown after answer)',
                    'video': ' VIDEO (shown after answer, optional)',
                    'image': ' IMAGE BLOCK'
                };
                
                // Only text, image, answer, and table blocks are draggable
                // Video and explanation are fixed at the end
                const isDraggable = ['text', 'image', 'answer', 'table'].includes(block.type);
                const dragAttrs = isDraggable ? `draggable="true" 
                             ondragstart="handleDragStart(event, ${block.id})" 
                             ondragend="handleDragEnd(event)"
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)"
                             ondrop="handleDrop(event, ${block.id})"` : '';
                const dragHandle = isDraggable ? `<span class="drag-handle" title="Drag to reorder"></span>` : '';
                const leftPadding = isDraggable ? '40px' : '1rem';

                html += `
                        <div class="admin-block ${isDraggable ? '' : 'no-drag'}" data-block-id="${block.id}" ${dragAttrs}
                             style="margin-bottom: 1rem; position: relative; padding: 1rem 1rem 1rem ${leftPadding}; border: 1px solid #eee; border-radius: 8px; ${typeColors[block.type] || ''}">
                            ${dragHandle}
                            <span style="font-size: 0.8rem; color: #666; font-weight: 600;">${typeLabels[block.type] || block.type.toUpperCase()}</span>
                            <button onclick="removeAdminBlock(${block.id})" style="position: absolute; right: 10px; top: 10px; border: none; background: none; cursor: pointer; color: #dc3545; font-size: 1.2rem;"></button>
                            ${inputHtml}
                        </div>
                    `;
            });
            
            container.innerHTML = html;
            
            // Re-attach any event listeners if needed
            initDragAndDrop();
        }
        
        // ==================== TEXT FORMATTING FUNCTIONS ====================
        
        window.formatText = function(blockId, command) {
            const editor = document.getElementById(`editor-${blockId}`);
            if (!editor) return;
            
            // Focus the editor first
            editor.focus();
            
            // Execute the formatting command
            document.execCommand(command, false, null);
            
            // Update block value
            updateBlockValueFromEditor(blockId);
        };
        
        window.insertNumberedList = function(blockId, listType) {
            const editor = document.getElementById(`editor-${blockId}`);
            if (!editor || !listType) return;
            
            editor.focus();
            
            // Handle parenthesis variants
            let cssListType = listType;
            let useParenthesis = false;
            
            if (listType.endsWith('-paren')) {
                cssListType = listType.replace('-paren', '');
                useParenthesis = true;
            }
            
            // Insert ordered list first
            document.execCommand('insertOrderedList', false, null);
            
            // Find the created ol element and set its style
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                let node = selection.anchorNode;
                while (node && node.nodeName !== 'OL') {
                    node = node.parentNode;
                }
                if (node && node.nodeName === 'OL') {
                    node.style.listStyleType = cssListType;
                    node.style.paddingLeft = '2em';
                    
                    // For parenthesis style, we use CSS counter
                    if (useParenthesis) {
                        node.classList.add('paren-list');
                        node.setAttribute('data-list-type', cssListType);
                    }
                }
            }
            
            // Update block value
            updateBlockValueFromEditor(blockId);
        };
        
        window.updateBlockValueFromEditor = function(blockId) {
            const editor = document.getElementById(`editor-${blockId}`);
            if (!editor) return;
            
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (block) {
                block.value = editor.innerHTML;
            }
        };
        
        // Handle keyboard shortcuts in the editor
        window.handleEditorKeydown = function(event, blockId) {
            // Ctrl/Cmd + B = Bold
            if ((event.ctrlKey || event.metaKey) && event.key === 'b') {
                event.preventDefault();
                formatText(blockId, 'bold');
            }
            // Ctrl/Cmd + I = Italic
            else if ((event.ctrlKey || event.metaKey) && event.key === 'i') {
                event.preventDefault();
                formatText(blockId, 'italic');
            }
            // Ctrl/Cmd + U = Underline
            else if ((event.ctrlKey || event.metaKey) && event.key === 'u') {
                event.preventDefault();
                formatText(blockId, 'underline');
            }
            // Tab = Indent
            else if (event.key === 'Tab' && !event.shiftKey) {
                event.preventDefault();
                formatText(blockId, 'indent');
            }
            // Shift + Tab = Outdent
            else if (event.key === 'Tab' && event.shiftKey) {
                event.preventDefault();
                formatText(blockId, 'outdent');
            }
        };
        
        window.handleEditorPaste = function(event) {
            // Prevent default paste and paste as plain text to avoid formatting issues
            event.preventDefault();
            
            const text = event.clipboardData.getData('text/html') || event.clipboardData.getData('text/plain');
            
            // Create a temporary div to parse the HTML
            const temp = document.createElement('div');
            temp.innerHTML = text;
            
            // Remove scripts and potentially harmful elements
            temp.querySelectorAll('script, style, meta, link').forEach(el => el.remove());
            
            // Insert the cleaned HTML
            document.execCommand('insertHTML', false, temp.innerHTML);
        };
        
        // ==================== DRAG AND DROP FUNCTIONS ====================
        
        window.draggedBlockId = null;
        
        window.initDragAndDrop = function() {
            // Initialize is called after render, nothing special needed here
            // All handlers are inline in the HTML
        };
        
        window.handleDragStart = function(event, blockId) {
            window.draggedBlockId = blockId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', blockId);
        };
        
        window.handleDragEnd = function(event) {
            event.target.classList.remove('dragging');
            // Remove drag-over class from all blocks
            document.querySelectorAll('.admin-block').forEach(block => {
                block.classList.remove('drag-over');
            });
            window.draggedBlockId = null;
        };
        
        window.handleDragOver = function(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const block = event.target.closest('.admin-block');
            if (block && !block.classList.contains('dragging')) {
                // Remove drag-over from other blocks
                document.querySelectorAll('.admin-block').forEach(b => {
                    if (b !== block) b.classList.remove('drag-over');
                });
                block.classList.add('drag-over');
            }
        };
        
        window.handleDragLeave = function(event) {
            const block = event.target.closest('.admin-block');
            if (block) {
                block.classList.remove('drag-over');
            }
        };
        
        window.handleDrop = function(event, targetBlockId) {
            event.preventDefault();
            const block = event.target.closest('.admin-block');
            if (block) {
                block.classList.remove('drag-over');
            }
            
            if (window.draggedBlockId === null || window.draggedBlockId === targetBlockId) return;
            
            // Find the blocks
            const draggedBlock = window.adminBlocks.find(b => b.id === window.draggedBlockId);
            const targetBlock = window.adminBlocks.find(b => b.id === targetBlockId);
            
            // Don't allow dragging video/explanation blocks
            if (draggedBlock && (draggedBlock.type === 'video' || draggedBlock.type === 'explanation')) {
                window.draggedBlockId = null;
                return;
            }
            
            // Don't allow dropping onto video/explanation blocks
            if (targetBlock && (targetBlock.type === 'video' || targetBlock.type === 'explanation')) {
                window.draggedBlockId = null;
                return;
            }
            
            // Find indices
            const fromIndex = window.adminBlocks.findIndex(b => b.id === window.draggedBlockId);
            const toIndex = window.adminBlocks.findIndex(b => b.id === targetBlockId);
            
            if (fromIndex === -1 || toIndex === -1) return;
            
            // Reorder the array
            const [movedBlock] = window.adminBlocks.splice(fromIndex, 1);
            window.adminBlocks.splice(toIndex, 0, movedBlock);
            
            // Re-render
            renderAdminBlocks();
            
            window.draggedBlockId = null;
        };
        
        // ==================== END DRAG AND DROP ====================
        
        // Update image preview when URL changes
        window.updateImagePreview = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            const previewDiv = document.getElementById(`img-preview-${blockId}`);
            if (block && previewDiv) {
                const previewUrl = convertDropboxUrl(block.value);
                if (block.value) {
                    previewDiv.innerHTML = `<img src="${previewUrl}" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #ddd;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><span style="display: none; color: #dc3545; font-size: 0.85rem;"> Image failed to load</span>`;
                } else {
                    previewDiv.innerHTML = '<span style="color: #888; font-size: 0.85rem;">Image preview will appear here</span>';
                }
            }
        };

        // ==================== TABLE EDITOR FUNCTIONS ====================
        
        // Pastel colors for table
        const pastelColors = [
            '#FFFFFF', '#F5F5F5', '#E8E8E8',  // Whites/Grays
            '#FFB3BA', '#FFDFBA', '#FFFFBA',  // Light Pink, Peach, Yellow
            '#BAFFC9', '#BAE1FF', '#E0BBE4',  // Mint, Sky Blue, Lavender
            '#FFC6D9', '#C9FFE5', '#D4F0F0',  // Rose, Seafoam, Aqua
            '#FCE4EC', '#E8F5E9', '#E3F2FD',  // Pale Pink, Pale Green, Pale Blue
            '#FFF8E1', '#F3E5F5', '#ECEFF1'   // Cream, Pale Purple, Blue Gray
        ];

        // Initialize table grid selector
        window.initTableGridSelector = function() {
            const grid = document.getElementById('table-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'table-grid-cell';
                    cell.dataset.row = row + 1;
                    cell.dataset.col = col + 1;
                    cell.addEventListener('mouseenter', handleGridHover);
                    cell.addEventListener('click', handleGridClick);
                    grid.appendChild(cell);
                }
            }
        };

        function handleGridHover(e) {
            const targetRow = parseInt(e.target.dataset.row, 10);
            const targetCol = parseInt(e.target.dataset.col, 10);
            const cells = document.querySelectorAll('.table-grid-cell');

            cells.forEach(cell => {
                const cellRow = parseInt(cell.dataset.row, 10);
                const cellCol = parseInt(cell.dataset.col, 10);
                if (cellRow <= targetRow && cellCol <= targetCol) {
                    cell.classList.add('selected');
                } else {
                    cell.classList.remove('selected');
                }
            });
            
            document.getElementById('grid-size-label').innerHTML = `<strong>${targetCol}  ${targetRow}</strong> table`;
        }

        function handleGridClick(e) {
            const rows = parseInt(e.target.dataset.row, 10);
            const cols = parseInt(e.target.dataset.col, 10);
            createTableBlock(rows, cols);
            hideTableGridSelector();
        }

        window.showTableGridSelector = function(btn) {
            const selector = document.getElementById('table-grid-selector');
            if (!selector) {
                console.error('Table grid selector not found');
                return;
            }
            
            // Toggle - if already visible, hide it
            if (selector.classList.contains('visible')) {
                hideTableGridSelector();
                return;
            }
            
            // Initialize grid if needed
            if (!document.querySelector('.table-grid-cell')) {
                initTableGridSelector();
            }
            
            // Get button position relative to viewport
            const rect = btn.getBoundingClientRect();
            const selectorWidth = 280;
            const selectorHeight = 320;
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            const padding = 15;
            
            let top, left;
            let showAbove = true;
            
            // Calculate horizontal position (centered on button)
            left = rect.left + (rect.width / 2) - (selectorWidth / 2);
            
            // Keep within horizontal bounds
            if (left < padding) {
                left = padding;
            } else if (left + selectorWidth > viewportWidth - padding) {
                left = viewportWidth - selectorWidth - padding;
            }
            
            // Determine vertical position
            const spaceAbove = rect.top;
            const spaceBelow = viewportHeight - rect.bottom;
            
            if (spaceAbove >= selectorHeight + padding) {
                // Enough space above - show above
                top = rect.top - selectorHeight - 10;
                showAbove = true;
            } else if (spaceBelow >= selectorHeight + padding) {
                // Not enough above but enough below - show below
                top = rect.bottom + 10;
                showAbove = false;
            } else {
                // Not enough space either way - center in viewport
                top = Math.max(padding, (viewportHeight - selectorHeight) / 2);
                showAbove = spaceAbove > spaceBelow; // Arrow points to closer edge
            }
            
            // Apply position
            selector.style.top = top + 'px';
            selector.style.left = left + 'px';
            
            // Update arrow direction
            if (showAbove) {
                selector.classList.remove('arrow-up');
                selector.classList.add('arrow-down');
            } else {
                selector.classList.remove('arrow-down');
                selector.classList.add('arrow-up');
            }
            
            selector.classList.add('visible');
            
            // Reset grid selection
            document.querySelectorAll('.table-grid-cell').forEach(c => c.classList.remove('selected'));
            document.getElementById('grid-size-label').innerHTML = '<span style="color: #888;">Hover to select</span>';
            
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeGridSelectorOnClickOutside, true);
            }, 100);
        };

        function hideTableGridSelector() {
            const selector = document.getElementById('table-grid-selector');
            if (selector) {
                selector.classList.remove('visible');
            }
            document.removeEventListener('click', closeGridSelectorOnClickOutside, true);
        }

        function closeGridSelectorOnClickOutside(e) {
            const selector = document.getElementById('table-grid-selector');
            const btn = document.getElementById('add-table-btn');
            if (selector && !selector.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
                hideTableGridSelector();
            }
        }

        function createTableBlock(rows, cols) {
            // Create table data structure
            const tableData = {
                rows: rows,
                cols: cols,
                cells: [],
                headerRow: true,
                colWidths: Array(cols).fill('auto')
            };
            
            // Initialize cells with empty content
            for (let r = 0; r < rows; r++) {
                const rowData = [];
                for (let c = 0; c < cols; c++) {
                    rowData.push({
                        content: r === 0 ? `Header ${c + 1}` : '',
                        align: 'left',
                        vAlign: 'middle',
                        bgColor: r === 0 ? '#E8E8E8' : '#FFFFFF'
                    });
                }
                tableData.cells.push(rowData);
            }
            
            const blockId = Date.now();
            window.adminBlocks.push({
                id: blockId,
                type: 'table',
                value: tableData
            });
            
            renderAdminBlocks();
            
            // Scroll to the new table
            setTimeout(() => {
                const tableBlock = document.getElementById(`table-block-${blockId}`);
                if (tableBlock) {
                    tableBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        // Render table in admin blocks
        window.renderTableBlock = function(block) {
            const tableData = block.value;
            const blockId = block.id;
            
            // Build a map of cells that are hidden due to merging
            const hiddenCells = new Set();
            if (tableData.mergedCells) {
                tableData.mergedCells.forEach(merge => {
                    for (let r = merge.startRow; r <= merge.endRow; r++) {
                        for (let c = merge.startCol; c <= merge.endCol; c++) {
                            if (r !== merge.startRow || c !== merge.startCol) {
                                hiddenCells.add(`${r}-${c}`);
                            }
                        }
                    }
                });
            }
            
            // Build a map of merge info for cells that start a merge
            const mergeMap = {};
            if (tableData.mergedCells) {
                tableData.mergedCells.forEach(merge => {
                    mergeMap[`${merge.startRow}-${merge.startCol}`] = {
                        colspan: merge.endCol - merge.startCol + 1,
                        rowspan: merge.endRow - merge.startRow + 1
                    };
                });
            }
            
            let tableHtml = `<table class="admin-table" id="admin-table-${blockId}">`;
            
            for (let r = 0; r < tableData.rows; r++) {
                tableHtml += `<tr data-row="${r}">`;
                for (let c = 0; c < tableData.cols; c++) {
                    // Skip hidden cells
                    if (hiddenCells.has(`${r}-${c}`)) {
                        continue;
                    }
                    
                    const cell = tableData.cells[r][c];
                    const tag = (r === 0 && tableData.headerRow) ? 'th' : 'td';
                    const colWidth = tableData.colWidths && tableData.colWidths[c] ? `width: ${tableData.colWidths[c]}px;` : '';
                    const rowHeight = tableData.rowHeights && tableData.rowHeights[r] ? `height: ${tableData.rowHeights[r]}px;` : '';
                    
                    // Check for merge attributes
                    const mergeInfo = mergeMap[`${r}-${c}`];
                    const colspanAttr = mergeInfo && mergeInfo.colspan > 1 ? `colspan="${mergeInfo.colspan}"` : '';
                    const rowspanAttr = mergeInfo && mergeInfo.rowspan > 1 ? `rowspan="${mergeInfo.rowspan}"` : '';
                    const mergedClass = mergeInfo ? 'merged-cell' : '';
                    
                    tableHtml += `<${tag} 
                        contenteditable="true" 
                        data-row="${r}" 
                        data-col="${c}" 
                        data-block="${blockId}"
                        ${colspanAttr}
                        ${rowspanAttr}
                        class="${mergedClass}"
                        style="text-align: ${cell.align}; vertical-align: ${cell.vAlign || 'middle'}; background-color: ${cell.bgColor}; ${colWidth} ${rowHeight}"
                        onclick="selectTableCell(this, event)"
                        onblur="updateTableCell(this)"
                        oninput="updateTableCell(this)"
                        onmousedown="handleTableCellMouseDown(event, ${blockId}, ${r}, ${c})"
                    >${cell.content}</${tag}>`;
                }
                tableHtml += '</tr>';
            }
            
            tableHtml += '</table>';
            
            return `
                <div class="admin-block" id="table-block-${blockId}" data-block-id="${blockId}" draggable="true"
                     ondragstart="handleDragStart(event, ${blockId})" 
                     ondragend="handleDragEnd(event)"
                     ondragover="handleDragOver(event)" 
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event, ${blockId})"
                     style="margin-bottom: 1rem; position: relative; padding: 1rem 1rem 1rem 40px; border: 1px solid #81c784; border-radius: 8px; background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);">
                    <span class="drag-handle" title="Drag to reorder"></span>
                    <span style="font-size: 0.8rem; color: #2e7d32; font-weight: 600;"> TABLE BLOCK</span>
                    <button onclick="removeAdminBlock(${blockId})" style="position: absolute; right: 10px; top: 10px; border: none; background: none; cursor: pointer; color: #dc3545; font-size: 1.2rem;"></button>
                    
                    <div class="admin-table-wrapper" style="margin-top: 10px;">
                        <div class="table-toolbar">
                            <div class="table-toolbar-group">
                                <label>Select:</label>
                                <button onclick="selectTableRow(${blockId})" title="Select Entire Row"> Row</button>
                                <button onclick="selectTableColumn(${blockId})" title="Select Entire Column"> Col</button>
                                <button onclick="selectEntireTable(${blockId})" title="Select Entire Table"> All</button>
                                <button onclick="clearCellSelection(${blockId})" title="Clear Selection"></button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Merge:</label>
                                <button onclick="mergeCells(${blockId})" title="Merge Selected Cells"> Merge</button>
                                <button onclick="unmergeCells(${blockId})" title="Unmerge Cell"> Unmerge</button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Align:</label>
                                <button onclick="setTableAlignment(${blockId}, 'left')" title="Align Left"></button>
                                <button onclick="setTableAlignment(${blockId}, 'center')" title="Align Center"></button>
                                <button onclick="setTableAlignment(${blockId}, 'right')" title="Align Right"></button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>V-Align:</label>
                                <button onclick="setTableVerticalAlignment(${blockId}, 'top')" title="Align Top"></button>
                                <button onclick="setTableVerticalAlignment(${blockId}, 'middle')" title="Align Middle"></button>
                                <button onclick="setTableVerticalAlignment(${blockId}, 'bottom')" title="Align Bottom"></button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Color:</label>
                                <button onclick="showColorPicker(${blockId}, 'selection')" title="Color Selection"></button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Rows:</label>
                                <button onclick="addTableRow(${blockId})" title="Add Row">+</button>
                                <button onclick="deleteTableRow(${blockId})" class="danger" title="Delete Row"></button>
                            </div>
                            <div class="table-toolbar-group">
                                <label>Cols:</label>
                                <button onclick="addTableColumn(${blockId})" title="Add Column">+</button>
                                <button onclick="deleteTableColumn(${blockId})" class="danger" title="Delete Column"></button>
                            </div>
                        </div>
                        <p style="font-size: 0.75rem; color: #666; margin: 5px 0; padding: 0 15px;"> Shift+Click or Ctrl+Click to select multiple cells for merging</p>
                        <div class="admin-table-container">
                            ${tableHtml}
                        </div>
                    </div>
                    
                    <!-- Color Picker Dropdown -->
                    <div id="color-picker-${blockId}" class="color-picker-dropdown">
                        <h5 id="color-picker-title-${blockId}">Select Color</h5>
                        <div class="color-palette">
                            ${pastelColors.map(color => `
                                <div class="color-swatch" 
                                    style="background-color: ${color};" 
                                    onclick="applyTableColor(${blockId}, '${color}')"
                                    title="${color}">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        };

        // Track selected cell for operations
        window.selectedTableCell = null;
        window.selectedCells = []; // Array of {row, col, blockId} for multi-select
        window.colorPickerMode = null; // 'row', 'col', or 'cell'
        window.colorPickerBlockId = null;

        window.selectTableCell = function(cell, event) {
            const blockId = parseInt(cell.dataset.block, 10);
            const row = parseInt(cell.dataset.row, 10);
            const col = parseInt(cell.dataset.col, 10);
            
            // Check for Shift or Ctrl key for multi-selection
            if (event && (event.shiftKey || event.ctrlKey || event.metaKey)) {
                // Multi-select mode
                const cellKey = `${row}-${col}`;
                const existingIndex = window.selectedCells.findIndex(c => 
                    c.row === row && c.col === col && c.blockId === blockId
                );
                
                if (event.shiftKey && window.selectedCells.length > 0) {
                    // Shift+Click: Select range from last selected to current
                    const lastCell = window.selectedCells[window.selectedCells.length - 1];
                    if (lastCell.blockId === blockId) {
                        const startRow = Math.min(lastCell.row, row);
                        const endRow = Math.max(lastCell.row, row);
                        const startCol = Math.min(lastCell.col, col);
                        const endCol = Math.max(lastCell.col, col);
                        
                        // Clear existing selection and select range
                        window.selectedCells = [];
                        for (let r = startRow; r <= endRow; r++) {
                            for (let c = startCol; c <= endCol; c++) {
                                window.selectedCells.push({ row: r, col: c, blockId });
                            }
                        }
                    }
                } else if (existingIndex >= 0) {
                    // Ctrl+Click on already selected: deselect
                    window.selectedCells.splice(existingIndex, 1);
                } else {
                    // Ctrl+Click on new cell: add to selection
                    window.selectedCells.push({ row, col, blockId });
                }
                
                // Update visual selection
                updateCellSelectionVisual(blockId);
            } else {
                // Single selection mode - clear multi-select
                window.selectedCells = [{ row, col, blockId }];
                
                // Remove all previous selections
                document.querySelectorAll('.admin-table td.selected-cell, .admin-table th.selected-cell').forEach(c => {
                    c.classList.remove('selected-cell');
                });
                document.querySelectorAll('.admin-table td.cell-selected, .admin-table th.cell-selected').forEach(c => {
                    c.classList.remove('cell-selected');
                });
                
                cell.classList.add('selected-cell');
            }
            
            window.selectedTableCell = cell;
        };
        
        window.updateCellSelectionVisual = function(blockId) {
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Clear existing selection visual
            table.querySelectorAll('.cell-selected').forEach(c => c.classList.remove('cell-selected'));
            table.querySelectorAll('.selected-cell').forEach(c => c.classList.remove('selected-cell'));
            
            // Apply selection visual to all selected cells
            window.selectedCells.forEach(sel => {
                if (sel.blockId === blockId) {
                    const cell = table.querySelector(`[data-row="${sel.row}"][data-col="${sel.col}"]`);
                    if (cell) {
                        cell.classList.add('cell-selected');
                    }
                }
            });
        };
        
        window.clearCellSelection = function(blockId) {
            window.selectedCells = [];
            window.selectedTableCell = null;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (table) {
                table.querySelectorAll('.cell-selected, .selected-cell, .selected-row, .selected-col').forEach(c => {
                    c.classList.remove('cell-selected', 'selected-cell', 'selected-row', 'selected-col');
                });
                table.classList.remove('selected-all');
            }
            
            // Also clear table selection
            window.tableSelection = { blockId: null, type: null, row: null, col: null };
        };
        
        // ==================== MERGE CELLS FUNCTIONS ====================
        
        window.mergeCells = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            // Get selected cells for this block
            const selectedForBlock = window.selectedCells.filter(c => c.blockId === blockId);
            
            if (selectedForBlock.length < 2) {
                alert('Please select at least 2 cells to merge. Use Shift+Click or Ctrl+Click to select multiple cells.');
                return;
            }
            
            // Find the bounding rectangle of selected cells
            const rows = selectedForBlock.map(c => c.row);
            const cols = selectedForBlock.map(c => c.col);
            const startRow = Math.min(...rows);
            const endRow = Math.max(...rows);
            const startCol = Math.min(...cols);
            const endCol = Math.max(...cols);
            
            // Check if selection forms a complete rectangle
            const expectedCount = (endRow - startRow + 1) * (endCol - startCol + 1);
            if (selectedForBlock.length !== expectedCount) {
                alert('Please select a rectangular area of cells to merge.');
                return;
            }
            
            // Check if any of the selected cells are already part of a merge
            if (!block.value.mergedCells) {
                block.value.mergedCells = [];
            }
            
            for (const merge of block.value.mergedCells) {
                for (let r = startRow; r <= endRow; r++) {
                    for (let c = startCol; c <= endCol; c++) {
                        if (r >= merge.startRow && r <= merge.endRow && 
                            c >= merge.startCol && c <= merge.endCol) {
                            alert('Cannot merge: some selected cells are already part of a merged region. Unmerge them first.');
                            return;
                        }
                    }
                }
            }
            
            // Combine content from all cells into the top-left cell
            let combinedContent = '';
            for (let r = startRow; r <= endRow; r++) {
                for (let c = startCol; c <= endCol; c++) {
                    const cellContent = block.value.cells[r][c].content.trim();
                    if (cellContent) {
                        if (combinedContent) combinedContent += ' ';
                        combinedContent += cellContent;
                    }
                }
            }
            block.value.cells[startRow][startCol].content = combinedContent;
            
            // Add the merge info
            block.value.mergedCells.push({
                startRow, endRow, startCol, endCol
            });
            
            // Clear selection and re-render
            window.selectedCells = [];
            renderAdminBlocks();
        };
        
        window.unmergeCells = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table' || !block.value.mergedCells) return;
            
            // Find which merge the selected cell belongs to
            if (!window.selectedTableCell || parseInt(window.selectedTableCell.dataset.block, 10) !== blockId) {
                alert('Please click on a merged cell to unmerge it.');
                return;
            }

            const row = parseInt(window.selectedTableCell.dataset.row, 10);
            const col = parseInt(window.selectedTableCell.dataset.col, 10);
            
            // Find the merge that contains this cell
            const mergeIndex = block.value.mergedCells.findIndex(merge => 
                row >= merge.startRow && row <= merge.endRow &&
                col >= merge.startCol && col <= merge.endCol
            );
            
            if (mergeIndex === -1) {
                alert('This cell is not part of a merged region.');
                return;
            }
            
            // Remove the merge
            block.value.mergedCells.splice(mergeIndex, 1);
            
            // Clean up empty array
            if (block.value.mergedCells.length === 0) {
                delete block.value.mergedCells;
            }
            
            renderAdminBlocks();
        };
        
        // ==================== END MERGE CELLS FUNCTIONS ====================

        window.updateTableCell = function(cell) {
            const blockId = parseInt(cell.dataset.block, 10);
            const row = parseInt(cell.dataset.row, 10);
            const col = parseInt(cell.dataset.col, 10);
            
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (block && block.type === 'table') {
                block.value.cells[row][col].content = cell.textContent;
            }
        };

        window.setTableAlignment = function(blockId, alignment) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Check for table selection first (row/col/all)
            if (window.tableSelection.blockId === blockId && window.tableSelection.type) {
                const sel = window.tableSelection;
                
                if (sel.type === 'all') {
                    // Align entire table
                    for (let r = 0; r < block.value.rows; r++) {
                        for (let c = 0; c < block.value.cols; c++) {
                            const cell = table.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            if (cell) {
                                cell.style.textAlign = alignment;
                                block.value.cells[r][c].align = alignment;
                            }
                        }
                    }
                } else if (sel.type === 'row') {
                    // Align selected row
                    const row = sel.row;
                    for (let c = 0; c < block.value.cols; c++) {
                        const cell = table.querySelector(`[data-row="${row}"][data-col="${c}"]`);
                        if (cell) {
                            cell.style.textAlign = alignment;
                            block.value.cells[row][c].align = alignment;
                        }
                    }
                } else if (sel.type === 'col') {
                    // Align selected column
                    const col = sel.col;
                    for (let r = 0; r < block.value.rows; r++) {
                        const cell = table.querySelector(`[data-row="${r}"][data-col="${col}"]`);
                        if (cell) {
                            cell.style.textAlign = alignment;
                            block.value.cells[r][col].align = alignment;
                        }
                    }
                }
                return;
            }
            
            // Check for multi-cell selection
            const selectedForBlock = window.selectedCells.filter(c => c.blockId === blockId);
            if (selectedForBlock.length > 0) {
                selectedForBlock.forEach(sel => {
                    const cell = table.querySelector(`[data-row="${sel.row}"][data-col="${sel.col}"]`);
                    if (cell) {
                        cell.style.textAlign = alignment;
                        block.value.cells[sel.row][sel.col].align = alignment;
                    }
                });
                return;
            }
            
            // Fall back to single cell
            if (!window.selectedTableCell || parseInt(window.selectedTableCell.dataset.block, 10) !== blockId) {
                alert('Please select a cell, row, column, or table first.');
                return;
            }

            const cell = window.selectedTableCell;
            const row = parseInt(cell.dataset.row, 10);
            const col = parseInt(cell.dataset.col, 10);
            
            cell.style.textAlign = alignment;
            block.value.cells[row][col].align = alignment;
        };
        
        window.setTableVerticalAlignment = function(blockId, vAlign) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Check for table selection first (row/col/all)
            if (window.tableSelection.blockId === blockId && window.tableSelection.type) {
                const sel = window.tableSelection;
                
                if (sel.type === 'all') {
                    for (let r = 0; r < block.value.rows; r++) {
                        for (let c = 0; c < block.value.cols; c++) {
                            const cell = table.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            if (cell) {
                                cell.style.verticalAlign = vAlign;
                                block.value.cells[r][c].vAlign = vAlign;
                            }
                        }
                    }
                } else if (sel.type === 'row') {
                    const row = sel.row;
                    for (let c = 0; c < block.value.cols; c++) {
                        const cell = table.querySelector(`[data-row="${row}"][data-col="${c}"]`);
                        if (cell) {
                            cell.style.verticalAlign = vAlign;
                            block.value.cells[row][c].vAlign = vAlign;
                        }
                    }
                } else if (sel.type === 'col') {
                    const col = sel.col;
                    for (let r = 0; r < block.value.rows; r++) {
                        const cell = table.querySelector(`[data-row="${r}"][data-col="${col}"]`);
                        if (cell) {
                            cell.style.verticalAlign = vAlign;
                            block.value.cells[r][col].vAlign = vAlign;
                        }
                    }
                }
                return;
            }
            
            // Check for multi-cell selection
            const selectedForBlock = window.selectedCells.filter(c => c.blockId === blockId);
            if (selectedForBlock.length > 0) {
                selectedForBlock.forEach(sel => {
                    const cell = table.querySelector(`[data-row="${sel.row}"][data-col="${sel.col}"]`);
                    if (cell) {
                        cell.style.verticalAlign = vAlign;
                        block.value.cells[sel.row][sel.col].vAlign = vAlign;
                    }
                });
                return;
            }
            
            // Fall back to single cell
            if (!window.selectedTableCell || parseInt(window.selectedTableCell.dataset.block, 10) !== blockId) {
                alert('Please select a cell, row, column, or table first.');
                return;
            }

            const cell = window.selectedTableCell;
            const row = parseInt(cell.dataset.row, 10);
            const col = parseInt(cell.dataset.col, 10);
            
            cell.style.verticalAlign = vAlign;
            block.value.cells[row][col].vAlign = vAlign;
        };

        window.showColorPicker = function(blockId, mode) {
            const picker = document.getElementById(`color-picker-${blockId}`);
            const title = document.getElementById(`color-picker-title-${blockId}`);
            
            // Check if we have a selection or selected cell
            const hasTableSelection = window.tableSelection.blockId === blockId && window.tableSelection.type;
            const hasMultiSelect = window.selectedCells.filter(c => c.blockId === blockId).length > 0;
            const hasCell = window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block, 10) === blockId;
            
            if (!hasTableSelection && !hasMultiSelect && !hasCell) {
                alert('Please select a cell, row, column, or table first.');
                return;
            }
            
            window.colorPickerMode = mode;
            window.colorPickerBlockId = blockId;
            
            // Determine title based on selection type
            let titleText = 'Select Color';
            if (hasTableSelection) {
                const typeLabels = { 'row': 'Row', 'col': 'Column', 'all': 'Table' };
                titleText = `Color ${typeLabels[window.tableSelection.type] || 'Selection'}`;
            } else if (hasMultiSelect && window.selectedCells.length > 1) {
                titleText = `Color ${window.selectedCells.length} Cells`;
            } else {
                titleText = 'Color Cell';
            }
            title.textContent = titleText;
            
            picker.classList.add('visible');
            
            // Position picker
            const table = document.getElementById(`admin-table-${blockId}`);
            if (table) {
                const tableRect = table.getBoundingClientRect();
                const parentRect = picker.parentElement.getBoundingClientRect();
                picker.style.top = (tableRect.bottom - parentRect.top + 10) + 'px';
                picker.style.left = '0px';
            }
            
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeColorPicker(e) {
                    if (!picker.contains(e.target) && !e.target.textContent.includes('')) {
                        picker.classList.remove('visible');
                        document.removeEventListener('click', closeColorPicker);
                    }
                });
            }, 10);
        };

        window.applyTableColor = function(blockId, color) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Check for table selection first (row/col/all)
            if (window.tableSelection.blockId === blockId && window.tableSelection.type) {
                const sel = window.tableSelection;
                
                if (sel.type === 'all') {
                    // Color entire table
                    for (let r = 0; r < block.value.rows; r++) {
                        for (let c = 0; c < block.value.cols; c++) {
                            const cell = table.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            if (cell) {
                                cell.style.backgroundColor = color;
                                block.value.cells[r][c].bgColor = color;
                            }
                        }
                    }
                } else if (sel.type === 'row') {
                    // Color selected row
                    const row = sel.row;
                    for (let c = 0; c < block.value.cols; c++) {
                        const cell = table.querySelector(`[data-row="${row}"][data-col="${c}"]`);
                        if (cell) {
                            cell.style.backgroundColor = color;
                            block.value.cells[row][c].bgColor = color;
                        }
                    }
                } else if (sel.type === 'col') {
                    // Color selected column
                    const col = sel.col;
                    for (let r = 0; r < block.value.rows; r++) {
                        const cell = table.querySelector(`[data-row="${r}"][data-col="${col}"]`);
                        if (cell) {
                            cell.style.backgroundColor = color;
                            block.value.cells[r][col].bgColor = color;
                        }
                    }
                }
                
                // Clear selection visual after applying
                clearTableSelection(blockId);
            }
            // Check for multi-cell selection
            else {
                const selectedForBlock = window.selectedCells.filter(c => c.blockId === blockId);
                if (selectedForBlock.length > 0) {
                    selectedForBlock.forEach(sel => {
                        const cell = table.querySelector(`[data-row="${sel.row}"][data-col="${sel.col}"]`);
                        if (cell) {
                            cell.style.backgroundColor = color;
                            block.value.cells[sel.row][sel.col].bgColor = color;
                        }
                    });
                }
                // Fall back to single cell
                else if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block, 10) === blockId) {
                    const row = parseInt(window.selectedTableCell.dataset.row, 10);
                    const col = parseInt(window.selectedTableCell.dataset.col, 10);
                    window.selectedTableCell.style.backgroundColor = color;
                    block.value.cells[row][col].bgColor = color;
                }
            }
            
            // Hide color picker
            document.getElementById(`color-picker-${blockId}`).classList.remove('visible');
        };

        window.addTableRow = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            const newRow = [];
            for (let c = 0; c < block.value.cols; c++) {
                newRow.push({
                    content: '',
                    align: 'left',
                    vAlign: 'middle',
                    bgColor: '#FFFFFF'
                });
            }
            
            block.value.cells.push(newRow);
            block.value.rows++;
            
            // Add default height for new row if rowHeights exists
            if (block.value.rowHeights) {
                block.value.rowHeights.push(40);
            }
            
            renderAdminBlocks();
        };

        window.deleteTableRow = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table' || block.value.rows <= 1) {
                alert('Table must have at least one row.');
                return;
            }
            
            let rowToDelete = block.value.rows - 1; // Default to last row
            
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block, 10) === blockId) {
                rowToDelete = parseInt(window.selectedTableCell.dataset.row, 10);
            }
            
            block.value.cells.splice(rowToDelete, 1);
            block.value.rows--;
            
            // Also remove row height if stored
            if (block.value.rowHeights) {
                block.value.rowHeights.splice(rowToDelete, 1);
            }
            
            window.selectedTableCell = null;
            renderAdminBlocks();
        };

        window.addTableColumn = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table') return;
            
            for (let r = 0; r < block.value.rows; r++) {
                block.value.cells[r].push({
                    content: r === 0 && block.value.headerRow ? `Header ${block.value.cols + 1}` : '',
                    align: 'left',
                    vAlign: 'middle',
                    bgColor: r === 0 && block.value.headerRow ? '#E8E8E8' : '#FFFFFF'
                });
            }
            
            block.value.cols++;
            
            // Add default width for new column if colWidths exists
            if (block.value.colWidths) {
                block.value.colWidths.push(100);
            }
            
            renderAdminBlocks();
        };

        window.deleteTableColumn = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block || block.type !== 'table' || block.value.cols <= 1) {
                alert('Table must have at least one column.');
                return;
            }
            
            let colToDelete = block.value.cols - 1; // Default to last column
            
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block, 10) === blockId) {
                colToDelete = parseInt(window.selectedTableCell.dataset.col, 10);
            }
            
            for (let r = 0; r < block.value.rows; r++) {
                block.value.cells[r].splice(colToDelete, 1);
            }
            
            block.value.cols--;
            
            // Also remove column width if stored
            if (block.value.colWidths) {
                block.value.colWidths.splice(colToDelete, 1);
            }
            
            window.selectedTableCell = null;
            renderAdminBlocks();
        };
        
        // ==================== TABLE SELECTION FUNCTIONS ====================
        
        window.tableSelection = {
            blockId: null,
            type: null, // 'cell', 'row', 'col', 'all'
            row: null,
            col: null
        };
        
        window.selectTableRow = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            // Use currently selected cell's row, or default to first row
            let rowIndex = 0;
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block, 10) === blockId) {
                rowIndex = parseInt(window.selectedTableCell.dataset.row, 10);
            }
            
            window.tableSelection = { blockId, type: 'row', row: rowIndex, col: null };
            
            // Clear previous selection
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            table.classList.remove('selected-all');
            table.querySelectorAll('.selected-row, .selected-col').forEach(c => {
                c.classList.remove('selected-row', 'selected-col');
            });
            
            // Highlight row
            table.querySelectorAll(`td[data-row="${rowIndex}"], th[data-row="${rowIndex}"]`).forEach(c => {
                c.classList.add('selected-row');
            });
        };
        
        window.selectTableColumn = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            // Use currently selected cell's column, or default to first column
            let colIndex = 0;
            if (window.selectedTableCell && parseInt(window.selectedTableCell.dataset.block, 10) === blockId) {
                colIndex = parseInt(window.selectedTableCell.dataset.col, 10);
            }
            
            window.tableSelection = { blockId, type: 'col', row: null, col: colIndex };
            
            // Clear previous selection
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            table.classList.remove('selected-all');
            table.querySelectorAll('.selected-row, .selected-col').forEach(c => {
                c.classList.remove('selected-row', 'selected-col');
            });
            
            // Highlight column
            table.querySelectorAll(`td[data-col="${colIndex}"], th[data-col="${colIndex}"]`).forEach(c => {
                c.classList.add('selected-col');
            });
        };
        
        window.selectEntireTable = function(blockId) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            window.tableSelection = { blockId, type: 'all', row: null, col: null };
            
            // Clear previous selection
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            table.querySelectorAll('.selected-row, .selected-col').forEach(c => {
                c.classList.remove('selected-row', 'selected-col');
            });
            
            // Highlight entire table
            table.classList.add('selected-all');
        };
        
        window.clearTableSelection = function(blockId) {
            window.tableSelection = { blockId: null, type: null, row: null, col: null };
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            table.classList.remove('selected-all');
            table.querySelectorAll('.selected-row, .selected-col').forEach(c => {
                c.classList.remove('selected-row', 'selected-col');
            });
        };
        
        // Add mousemove listener for cursor changes on table cells
        document.addEventListener('mousemove', function(event) {
            const cell = event.target.closest('.admin-table td, .admin-table th');
            if (!cell) return;
            
            const rect = cell.getBoundingClientRect();
            const edgeThreshold = 8;
            
            const isRightEdge = event.clientX >= rect.right - edgeThreshold;
            const isBottomEdge = event.clientY >= rect.bottom - edgeThreshold;
            
            const blockId = parseInt(cell.dataset.block, 10);
            const col = parseInt(cell.dataset.col, 10);
            const row = parseInt(cell.dataset.row, 10);
            const block = window.adminBlocks?.find(b => b.id === blockId);
            
            if (!block) return;
            
            // Not last column and on right edge
            if (isRightEdge && col < block.value.cols - 1) {
                cell.style.cursor = 'col-resize';
            }
            // Not last row and on bottom edge
            else if (isBottomEdge && row < block.value.rows - 1) {
                cell.style.cursor = 'row-resize';
            }
            // Normal text cursor
            else {
                cell.style.cursor = 'text';
            }
        });
        
        // ==================== TABLE RESIZE FUNCTIONS ====================
        
        window.tableResizeState = {
            isResizing: false,
            type: null, // 'col' or 'row'
            blockId: null,
            index: null,
            startX: 0,
            startY: 0,
            startSize: 0,
            overlay: null
        };
        
        // Handle mousedown on table cell to detect edge clicks for resizing
        window.handleTableCellMouseDown = function(event, blockId, row, col) {
            const cell = event.target.closest('td, th');
            if (!cell) return;
            
            const rect = cell.getBoundingClientRect();
            const edgeThreshold = 8; // pixels from edge to trigger resize
            
            const isRightEdge = event.clientX >= rect.right - edgeThreshold;
            const isBottomEdge = event.clientY >= rect.bottom - edgeThreshold;
            
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            // Check if on right edge (column resize) - not for last column
            if (isRightEdge && col < block.value.cols - 1) {
                event.preventDefault();
                startColResize(event, blockId, col);
                return;
            }
            
            // Check if on bottom edge (row resize) - not for last row
            if (isBottomEdge && row < block.value.rows - 1) {
                event.preventDefault();
                startRowResize(event, blockId, row);
                return;
            }
            
            // Normal cell selection - clear any table selections
            clearTableSelection(blockId);
        };
        
        window.startColResize = function(event, blockId, colIndex) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Get current column width
            const firstRowCells = table.querySelectorAll('tr:first-child th, tr:first-child td');
            const cell = firstRowCells[colIndex];
            const startWidth = cell ? cell.offsetWidth : 100;
            
            // Initialize colWidths array if not exists
            if (!block.value.colWidths) {
                block.value.colWidths = [];
                firstRowCells.forEach((c, idx) => {
                    block.value.colWidths[idx] = c.offsetWidth;
                });
            }
            
            window.tableResizeState = {
                isResizing: true,
                type: 'col',
                blockId: blockId,
                index: colIndex,
                startX: event.clientX,
                startY: 0,
                startSize: startWidth,
                overlay: null
            };
            
            // Add overlay to capture mouse
            const overlay = document.createElement('div');
            overlay.className = 'table-resize-overlay';
            document.body.appendChild(overlay);
            window.tableResizeState.overlay = overlay;
            
            document.addEventListener('mousemove', handleTableResize);
            document.addEventListener('mouseup', stopTableResize);
        };
        
        window.startRowResize = function(event, blockId, rowIndex) {
            const block = window.adminBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            const table = document.getElementById(`admin-table-${blockId}`);
            if (!table) return;
            
            // Get current row height
            const rows = table.querySelectorAll('tr');
            const row = rows[rowIndex];
            const startHeight = row ? row.offsetHeight : 40;
            
            // Initialize rowHeights array if not exists
            if (!block.value.rowHeights) {
                block.value.rowHeights = [];
                rows.forEach((r, idx) => {
                    block.value.rowHeights[idx] = r.offsetHeight;
                });
            }
            
            window.tableResizeState = {
                isResizing: true,
                type: 'row',
                blockId: blockId,
                index: rowIndex,
                startX: 0,
                startY: event.clientY,
                startSize: startHeight,
                overlay: null
            };
            
            // Add overlay to capture mouse
            const overlay = document.createElement('div');
            overlay.className = 'table-resize-overlay row-resize';
            document.body.appendChild(overlay);
            window.tableResizeState.overlay = overlay;
            
            document.addEventListener('mousemove', handleTableResize);
            document.addEventListener('mouseup', stopTableResize);
        };
        
        function handleTableResize(event) {
            if (!window.tableResizeState.isResizing) return;
            
            const state = window.tableResizeState;
            const block = window.adminBlocks.find(b => b.id === state.blockId);
            if (!block) return;
            
            const table = document.getElementById(`admin-table-${state.blockId}`);
            if (!table) return;
            
            if (state.type === 'col') {
                const deltaX = event.clientX - state.startX;
                const newWidth = Math.max(40, state.startSize + deltaX);
                
                // Update all cells in this column
                const cells = table.querySelectorAll(`td[data-col="${state.index}"], th[data-col="${state.index}"]`);
                cells.forEach(cell => {
                    cell.style.width = newWidth + 'px';
                });
                
                // Store width
                if (!block.value.colWidths) block.value.colWidths = [];
                block.value.colWidths[state.index] = newWidth;
                
            } else if (state.type === 'row') {
                const deltaY = event.clientY - state.startY;
                const newHeight = Math.max(25, state.startSize + deltaY);
                
                // Update all cells in this row
                const cells = table.querySelectorAll(`td[data-row="${state.index}"], th[data-row="${state.index}"]`);
                cells.forEach(cell => {
                    cell.style.height = newHeight + 'px';
                });
                
                // Store height
                if (!block.value.rowHeights) block.value.rowHeights = [];
                block.value.rowHeights[state.index] = newHeight;
            }
        }
        
        function stopTableResize(event) {
            if (!window.tableResizeState.isResizing) return;
            
            // Remove overlay
            if (window.tableResizeState.overlay) {
                window.tableResizeState.overlay.remove();
            }
            
            window.tableResizeState.isResizing = false;
            document.removeEventListener('mousemove', handleTableResize);
            document.removeEventListener('mouseup', stopTableResize);
        }
        
        // ==================== END TABLE RESIZE FUNCTIONS ====================

        // ==================== END TABLE EDITOR FUNCTIONS ====================

        window.removeAdminBlock = function (id) {
            window.adminBlocks = window.adminBlocks.filter(b => b.id !== id);
            renderAdminBlocks();
        };

        window.updateBlockValue = function (id, value) {
            const block = window.adminBlocks.find(b => b.id === id);
            if (block) block.value = value;
        };

        window.toggleBlank = function (el) {
            if (el.classList.contains('is-blank')) {
                el.classList.remove('is-blank');
                el.style.backgroundColor = 'transparent';
                el.style.borderBottom = 'none';
            } else {
                el.classList.add('is-blank');
                el.style.backgroundColor = '#fff9c4';
                el.style.borderBottom = '2px solid #fbc02d';
            }
        };

        window.processAdminQuestion = function () {
            const previewSection = document.getElementById('admin-preview-section');
            const previewContent = document.getElementById('admin-preview-content');
            const category = document.getElementById('admin-category').value;
            
            if (window.adminBlocks.length === 0) {
                alert("Please add some content blocks first!");
                return;
            }
            
            previewSection.classList.remove('hidden');

            let mainHtml = '';
            let afterAnswerHtml = '';
            
            window.adminBlocks.forEach(block => {
                if (block.type === 'text' && block.value) {
                    mainHtml += `<div style="margin-bottom: 1.5rem; color: var(--main-text); font-size: 1.1rem;">${block.value.replace(/\n/g, '<br>')}</div>`;
                } else if (block.type === 'answer' && block.value) {
                    const words = block.value.split(/\s+/);
                    const wrappedWords = words.map(word => `<span class="admin-word" onclick="toggleBlank(this)" style="cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: all 0.2s;">${word}</span>`).join(' ');
                    mainHtml += `<div class="cer-segment" style="margin-bottom: 1.5rem; line-height: 2;">${wrappedWords}</div>`;
                } else if (block.type === 'explanation' && block.value) {
                    // Explanation goes after the answer/MCQ options
                    afterAnswerHtml += `<div class="explanation-box" style="margin-top: 1.5rem; padding: 1.5rem; background: #f0f4ff; border-left: 4px solid #007bff; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 0.8rem; color: #007bff; display: flex; align-items: center; gap: 8px;"> Explanation</h4>
                                <div style="color: #444; line-height: 1.6;">${block.value.replace(/\n/g, '<br>')}</div>
                             </div>`;
                } else if (block.type === 'image' && block.value) {
                    const imageUrl = convertDropboxUrl(block.value);
                    mainHtml += `<img src="${imageUrl}" style="max-width: 100%; border-radius: 8px; margin-bottom: 1.5rem; display: block; margin-left: auto; margin-right: auto;" onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<p style=\\'color:#dc3545;\\'> Image failed to load. Check URL.</p>');">`;
                } else if (block.type === 'video' && block.value) {
                    // Video goes after the answer/MCQ options
                    let videoUrl = block.value;
                    if (videoUrl.includes('dropbox.com')) {
                        videoUrl = videoUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?raw=1', '');
                    } else if (videoUrl.includes('youtube.com/watch?v=')) {
                        videoUrl = videoUrl.replace('watch?v=', 'embed/');
                    } else if (videoUrl.includes('youtu.be/')) {
                        videoUrl = videoUrl.replace('youtu.be/', 'youtube.com/embed/');
                    }
                    afterAnswerHtml += `<div class="video-container hidden-until-answered" style="margin-top: 1.5rem; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none;">
                                <iframe src="${videoUrl}" style="width: 100%; height: 315px; border: none;" allowfullscreen></iframe>
                             </div>`;
                } else if (block.type === 'table' && block.value) {
                    // Render table for preview with merge support
                    const tableData = block.value;
                    
                    // Build hidden cells map
                    const hiddenCells = new Set();
                    const mergeMap = {};
                    if (tableData.mergedCells) {
                        tableData.mergedCells.forEach(merge => {
                            for (let r = merge.startRow; r <= merge.endRow; r++) {
                                for (let c = merge.startCol; c <= merge.endCol; c++) {
                                    if (r !== merge.startRow || c !== merge.startCol) {
                                        hiddenCells.add(`${r}-${c}`);
                                    }
                                }
                            }
                            mergeMap[`${merge.startRow}-${merge.startCol}`] = {
                                colspan: merge.endCol - merge.startCol + 1,
                                rowspan: merge.endRow - merge.startRow + 1
                            };
                        });
                    }
                    
                    let tableHtml = `<table class="question-table" style="width: 100%; border-collapse: collapse; font-family: 'Century Gothic', 'Segoe UI', sans-serif; margin-bottom: 1.5rem;">`;
                    
                    for (let r = 0; r < tableData.rows; r++) {
                        const rowHeightStyle = tableData.rowHeights && tableData.rowHeights[r] ? `height: ${tableData.rowHeights[r]}px;` : '';
                        tableHtml += `<tr style="${rowHeightStyle}">`;
                        for (let c = 0; c < tableData.cols; c++) {
                            // Skip hidden cells
                            if (hiddenCells.has(`${r}-${c}`)) continue;
                            
                            const cell = tableData.cells[r][c];
                            const tag = (r === 0 && tableData.headerRow) ? 'th' : 'td';
                            const fontWeight = (r === 0 && tableData.headerRow) ? 'font-weight: 600;' : '';
                            const colWidthStyle = tableData.colWidths && tableData.colWidths[c] ? `width: ${tableData.colWidths[c]}px;` : '';
                            
                            // Check for merge attributes
                            const mergeInfo = mergeMap[`${r}-${c}`];
                            const colspanAttr = mergeInfo && mergeInfo.colspan > 1 ? `colspan="${mergeInfo.colspan}"` : '';
                            const rowspanAttr = mergeInfo && mergeInfo.rowspan > 1 ? `rowspan="${mergeInfo.rowspan}"` : '';
                            
                            tableHtml += `<${tag} ${colspanAttr} ${rowspanAttr} style="border: 1px solid #bbb; padding: 10px 14px; text-align: ${cell.align}; vertical-align: ${cell.vAlign || 'middle'}; background-color: ${cell.bgColor}; ${fontWeight} ${colWidthStyle}">${cell.content}</${tag}>`;
                        }
                        tableHtml += '</tr>';
                    }
                    
                    tableHtml += '</table>';
                    mainHtml += tableHtml;
                }
            });

            // Build final HTML: main content first, then MCQ options (if MCQ), then after-answer content
            let html = mainHtml;
            
            if (category === 'mcq') {
                const opts = [
                    document.getElementById('mcq-opt-1').value,
                    document.getElementById('mcq-opt-2').value,
                    document.getElementById('mcq-opt-3').value,
                    document.getElementById('mcq-opt-4').value
                ];
                const correct = document.getElementById('mcq-correct').value;
                html += `<div class="mcq-container" style="margin-top: 1rem;">`;
                opts.forEach((opt, i) => {
                    if (opt) {
                        html += `
                            <label class="mcq-option">
                                <input type="radio" name="temp-mcq-preview" value="${i + 1}" data-correct="${correct == i + 1}">
                                <span>${opt}</span>
                            </label>
                        `;
                    }
                });
                html += `</div>`;
            }
            
            // Add explanation and video at the end (after MCQ options / answer areas)
            html += afterAnswerHtml;

            previewContent.innerHTML = html;
            previewSection.scrollIntoView({ behavior: 'smooth' });
        };

        window.saveAdminQuestion = async function (status = 'approved') {
            // Set flag to prevent any auto-refresh during save
            window.isSavingQuestion = true;
            
            if (!window.auth || !window.auth.currentUser) {
                window.isSavingQuestion = false;
                alert("You must be logged in to save.");
                return;
            }
            
            const title = document.getElementById('admin-title').value.trim();
            if (!title) {
                window.isSavingQuestion = false;
                alert("Please enter a question title.");
                document.getElementById('admin-title').focus();
                return;
            }
            
            if (window.adminBlocks.length === 0) {
                window.isSavingQuestion = false;
                alert("Please add some content blocks before saving.");
                return;
            }

            try {
                const category = document.getElementById('admin-category').value;
                const level = document.getElementById('admin-level').value;

                let topic = document.getElementById('admin-topic').value;
                if (topic === 'new-topic') {
                    topic = document.getElementById('admin-new-topic').value.trim().toLowerCase().replace(/\s+/g, '-');
                    if (!topic) {
                        alert("Please enter a name for the new topic.");
                        return;
                    }
                }

                // Check if preview has been generated
                const previewContent = document.getElementById('admin-preview-content');
                let finalHtml = '';
                
                if (previewContent.innerHTML.trim()) {
                    // Use preview content (with blanks selected)
                    const clone = previewContent.cloneNode(true);
                    
                    // Remove any controls that might be in the preview
                    clone.querySelectorAll('.controls, button.submit-btn, button.next-btn, button.print-btn, button.btn-primary').forEach(el => el.remove());
                    
                    // Ensure explanation boxes are hidden by default
                    clone.querySelectorAll('.explanation-box').forEach(el => {
                        el.style.display = 'none';
                    });
                    
                    // Ensure video containers are hidden by default
                    clone.querySelectorAll('.video-container').forEach(el => {
                        el.style.display = 'none';
                        el.classList.add('hidden-until-answered');
                    });
                    
                    const selectedWords = clone.querySelectorAll('.admin-word.is-blank');
                    selectedWords.forEach(word => {
                        const answer = word.textContent.trim().replace(/[.,!?;:]/g, '');
                        const calcWidth = Math.max(90, (answer.length * 1.5) * 10);
                        word.outerHTML = `<input type="text" class="answer-input" data-answer="${answer}" placeholder="..." style="width: ${calcWidth}px;">`;
                    });

                    // Convert non-blank words back to plain text
                    clone.querySelectorAll('.admin-word:not(.is-blank)').forEach(word => {
                        word.outerHTML = word.textContent;
                    });

                    clone.querySelectorAll('.cer-segment').forEach(seg => {
                        if (!seg.querySelector('.feedback-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'feedback-icon';
                            seg.appendChild(icon);
                        }
                    });
                    
                    finalHtml = clone.innerHTML;
                } else {
                    // Build HTML directly from blocks (no preview)
                    // Separate main content from after-answer content
                    let mainHtml = '';
                    let afterAnswerHtml = '';
                    
                    window.adminBlocks.forEach(block => {
                        if (block.type === 'text' && block.value) {
                            mainHtml += `<div style="margin-bottom: 1.5rem; color: var(--main-text); font-size: 1.1rem;">${block.value.replace(/\n/g, '<br>')}</div>`;
                        } else if (block.type === 'answer' && block.value) {
                            // Parse [word] as blanks
                            let answerHtml = block.value.replace(/\[([^\]]+)\]/g, (match, answer) => {
                                const calcWidth = Math.max(90, (answer.length * 1.5) * 10);
                                return `<input type="text" class="answer-input" data-answer="${answer.trim()}" placeholder="..." style="width: ${calcWidth}px;">`;
                            });
                            mainHtml += `<div class="cer-segment" style="margin-bottom: 1.5rem; line-height: 2;">${answerHtml}<span class="feedback-icon"></span></div>`;
                        } else if (block.type === 'explanation' && block.value) {
                            // Explanation goes after MCQ/answer section
                            afterAnswerHtml += `<div class="explanation-box" style="margin-top: 1.5rem; padding: 1.5rem; background: #f0f4ff; border-left: 4px solid #007bff; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 0.8rem; color: #007bff; display: flex; align-items: center; gap: 8px;"> Explanation</h4>
                                <div style="color: #444; line-height: 1.6;">${block.value.replace(/\n/g, '<br>')}</div>
                             </div>`;
                        } else if (block.type === 'image' && block.value) {
                            const imageUrl = convertDropboxUrl(block.value);
                            mainHtml += `<img src="${imageUrl}" class="question-diagram" style="max-width: 100%; border-radius: 8px; margin-bottom: 1.5rem; display: block; margin-left: auto; margin-right: auto;">`;
                        } else if (block.type === 'video' && block.value) {
                            // Video goes after MCQ/answer section
                            let videoUrl = block.value;
                            if (videoUrl.includes('dropbox.com')) {
                                videoUrl = videoUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?raw=1', '');
                            } else if (videoUrl.includes('youtube.com/watch?v=')) {
                                videoUrl = videoUrl.replace('watch?v=', 'embed/');
                            } else if (videoUrl.includes('youtu.be/')) {
                                videoUrl = videoUrl.replace('youtu.be/', 'youtube.com/embed/');
                            }
                            afterAnswerHtml += `<div class="video-container hidden-until-answered" style="margin-top: 1.5rem; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none;">
                                <iframe src="${videoUrl}" style="width: 100%; height: 315px; border: none;" allowfullscreen></iframe>
                             </div>`;
                        } else if (block.type === 'table' && block.value) {
                            // Generate table HTML for saving with merge support
                            const tableData = block.value;
                            
                            // Build hidden cells map
                            const hiddenCells = new Set();
                            const mergeMap = {};
                            if (tableData.mergedCells) {
                                tableData.mergedCells.forEach(merge => {
                                    for (let r = merge.startRow; r <= merge.endRow; r++) {
                                        for (let c = merge.startCol; c <= merge.endCol; c++) {
                                            if (r !== merge.startRow || c !== merge.startCol) {
                                                hiddenCells.add(`${r}-${c}`);
                                            }
                                        }
                                    }
                                    mergeMap[`${merge.startRow}-${merge.startCol}`] = {
                                        colspan: merge.endCol - merge.startCol + 1,
                                        rowspan: merge.endRow - merge.startRow + 1
                                    };
                                });
                            }
                            
                            let tableHtml = `<table class="question-table" style="width: 100%; border-collapse: collapse; font-family: 'Century Gothic', 'Segoe UI', sans-serif; margin-bottom: 1.5rem;">`;
                            
                            for (let r = 0; r < tableData.rows; r++) {
                                const rowHeightStyle = tableData.rowHeights && tableData.rowHeights[r] ? `height: ${tableData.rowHeights[r]}px;` : '';
                                tableHtml += `<tr style="${rowHeightStyle}">`;
                                for (let c = 0; c < tableData.cols; c++) {
                                    // Skip hidden cells
                                    if (hiddenCells.has(`${r}-${c}`)) continue;
                                    
                                    const cell = tableData.cells[r][c];
                                    const tag = (r === 0 && tableData.headerRow) ? 'th' : 'td';
                                    const fontWeight = (r === 0 && tableData.headerRow) ? 'font-weight: 600;' : '';
                                    const colWidthStyle = tableData.colWidths && tableData.colWidths[c] ? `width: ${tableData.colWidths[c]}px;` : '';
                                    
                                    // Check for merge attributes
                                    const mergeInfo = mergeMap[`${r}-${c}`];
                                    const colspanAttr = mergeInfo && mergeInfo.colspan > 1 ? `colspan="${mergeInfo.colspan}"` : '';
                                    const rowspanAttr = mergeInfo && mergeInfo.rowspan > 1 ? `rowspan="${mergeInfo.rowspan}"` : '';
                                    
                                    tableHtml += `<${tag} ${colspanAttr} ${rowspanAttr} style="border: 1px solid #bbb; padding: 10px 14px; text-align: ${cell.align}; vertical-align: ${cell.vAlign || 'middle'}; background-color: ${cell.bgColor}; ${fontWeight} ${colWidthStyle}">${cell.content}</${tag}>`;
                                }
                                tableHtml += '</tr>';
                            }
                            
                            tableHtml += '</table>';
                            mainHtml += tableHtml;
                        }
                    });

                    // Start with main content
                    finalHtml = mainHtml;

                    // Add MCQ options if MCQ category
                    if (category === 'mcq') {
                        const opts = [
                            document.getElementById('mcq-opt-1').value,
                            document.getElementById('mcq-opt-2').value,
                            document.getElementById('mcq-opt-3').value,
                            document.getElementById('mcq-opt-4').value
                        ];
                        const correct = document.getElementById('mcq-correct').value;
                        finalHtml += `<div class="mcq-container" style="margin-top: 1rem;">`;
                        opts.forEach((opt, i) => {
                            if (opt) {
                                finalHtml += `
                                    <label class="mcq-option">
                                        <input type="radio" name="mcq-answer" value="${i + 1}" data-correct="${correct == i + 1}">
                                        <span>${opt}</span>
                                    </label>
                                `;
                            }
                        });
                        finalHtml += `</div>`;
                    }
                    
                    // Add explanation and video at the very end
                    finalHtml += afterAnswerHtml;
                }

                const { doc, setDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                
                // Determine if updating existing or creating new
                const isEditing = window.editingQuestionId && window.editingQuestionId.startsWith('q-custom-');
                const questionId = isEditing 
                    ? window.editingQuestionId.replace('q-', '') 
                    : "custom-" + Date.now();
                
                const questionData = {
                    title: title,
                    html: finalHtml,
                    updatedBy: window.auth.currentUser.email,
                    updatedAt: new Date().toISOString(),
                    category: category,
                    level: level,
                    topic: topic,
                    type: 'custom',
                    status: status
                };

                if (!isEditing) {
                    questionData.createdBy = window.auth.currentUser.email;
                    questionData.createdAt = new Date().toISOString();
                    questionData.status = status; // Set initial status for new questions
                }
                
                await setDoc(doc(window.db_fs, "custom_questions", questionId), questionData, { merge: true });
                
                let actionText;
                if (isEditing) {
                    actionText = "updated";
                } else if (status === 'pending') {
                    actionText = "submitted for review! An admin will review it before it becomes available to students.";
                } else {
                    actionText = "added and is now available to students!";
                }
                alert(`Question successfully ${actionText}`);
                
                // Clear the form but preserve category/level/topic settings
                window.editingQuestionId = null;
                window.clearAdminForm(true, true); // force clear, preserve settings
                
                // Reset the loaded flag so questions can be reloaded
                window.customQuestionsLoaded = false;
                
                // Remove existing custom questions from DOM to prevent duplicates
                document.querySelectorAll('.custom-question').forEach(el => el.remove());
                
                // Reload the custom questions from database
                if (window.loadCustomQuestions) {
                    await window.loadCustomQuestions();
                }
                
                // Update tab counts after adding new question
                if (window.updateTabCounts) {
                    setTimeout(() => updateTabCounts(), 100);
                }
                
                // Scroll to title and focus for next question entry
                const titleInput = document.getElementById('admin-title');
                if (titleInput) {
                    titleInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => titleInput.focus(), 300);
                }
                
                // Reset the saving flag
                window.isSavingQuestion = false;
                
            } catch (e) {
                window.isSavingQuestion = false;
                console.error("Save Error:", e);
                alert("Error saving: " + e.message);
            }
        };

        // Cancel editing and clear form
        window.cancelEditing = function() {
            if (window.adminBlocks.length > 0 && !confirm("Cancel editing? Unsaved changes will be lost.")) return;
            window.editingQuestionId = null;
            window.clearAdminForm(true, true); // force clear, preserve settings
            updateEditingIndicator();
        };
        
        // Update the editing indicator
        window.updateEditingIndicator = function() {
            const indicator = document.getElementById('editing-indicator');
            const nameSpan = document.getElementById('editing-question-name');
            const titleInput = document.getElementById('admin-title');
            
            if (window.editingQuestionId) {
                indicator.classList.remove('hidden');
                indicator.style.display = 'flex';
                nameSpan.textContent = titleInput.value || window.editingQuestionId;
            } else {
                indicator.classList.add('hidden');
                indicator.style.display = 'none';
            }
        };

        // Clear admin form
        window.clearAdminForm = function(force = false, preserveSettings = false) {
            if (!force && window.adminBlocks.length > 0 && !confirm("Clear all content? This cannot be undone.")) return;
            
            // Save current settings if preserving
            let savedCategory, savedLevel, savedTopic;
            if (preserveSettings) {
                savedCategory = document.getElementById('admin-category').value;
                savedLevel = document.getElementById('admin-level')?.value;
                savedTopic = document.getElementById('admin-topic').value;
            }
            
            window.adminBlocks = [];
            window.editingQuestionId = null;
            renderAdminBlocks();
            
            document.getElementById('admin-title').value = '';
            document.getElementById('admin-new-topic').value = '';
            document.getElementById('admin-new-topic').classList.add('hidden');
            document.getElementById('mcq-opt-1').value = '';
            document.getElementById('mcq-opt-2').value = '';
            document.getElementById('mcq-opt-3').value = '';
            document.getElementById('mcq-opt-4').value = '';
            document.getElementById('mcq-correct').value = '1';
            
            if (preserveSettings && savedCategory) {
                // Restore saved settings
                document.getElementById('admin-category').value = savedCategory;
                handleCategoryChange(savedCategory);
                
                if (savedCategory === 'mcq' && savedLevel) {
                    document.getElementById('admin-level').value = savedLevel;
                    updateAdminTopicsByLevel(savedLevel);
                }
                
                // Restore topic after a small delay to ensure options are populated
                setTimeout(() => {
                    const topicSelect = document.getElementById('admin-topic');
                    const topicExists = Array.from(topicSelect.options).some(opt => opt.value === savedTopic);
                    if (topicExists) {
                        topicSelect.value = savedTopic;
                    }
                }, 50);
            } else {
                // Reset to defaults
                document.getElementById('admin-category').value = 'cer';
                document.getElementById('admin-topic').value = 'heat';
                handleCategoryChange('cer');
            }
            
            document.getElementById('admin-preview-section').classList.add('hidden');
            document.getElementById('admin-preview-content').innerHTML = '';
            
            updateEditingIndicator();
        };

        // Convert Dropbox URL to displayable format
        window.convertDropboxUrl = function(url) {
            if (!url) return url;
            
            // Handle new Dropbox format: /scl/fi/xxx/file.jpg?rlkey=xxx&dl=0
            if (url.includes('dropbox.com/scl/')) {
                // Replace dl=0 or dl=1 with raw=1
                url = url.replace(/[?&]dl=[01]/, '&raw=1');
                if (!url.includes('raw=1')) {
                    url += (url.includes('?') ? '&' : '?') + 'raw=1';
                }
                return url;
            }
            
            // Handle old Dropbox format
            if (url.includes('dropbox.com')) {
                return url.replace('www.dropbox.com', 'dl.dropboxusercontent.com')
                          .replace('?dl=0', '')
                          .replace('?dl=1', '');
            }
            
            return url;
        };

        function editQuestion(btn, isDuplicate = false) {
            const container = btn.closest('.question-container');
            const titleEl = container.querySelector('h3');
            
            // Extract title from h3 - this works for both custom and built-in questions
            let title = "";
            if (titleEl) {
                title = titleEl.innerText.trim();
            }
            
            // If h3 is generic like "Question 1" for built-in questions, try question-title paragraph
            if (!title || (/^Question\s*\d*$/i.test(title) && !container.classList.contains('custom-question') && !container.id.includes('custom'))) {
                const questionTitleEl = container.querySelector('.question-title, p.question-title');
                if (questionTitleEl) {
                    const fullText = questionTitleEl.textContent.trim();
                    title = fullText.length > 60 ? fullText.substring(0, 57) + '...' : fullText;
                }
            }
            
            // Fallback if still no title
            if (!title) {
                title = "Untitled Question";
            }

            // Detect category from container location
            let category = 'cer';
            let detectedTopic = 'heat';
            
            if (container.closest('#view-cer') || container.closest('[id^="topic-heat"]') || container.closest('[id^="topic-light"]') || container.closest('[id^="topic-materials"]')) {
                category = 'cer';
            } else if (container.closest('#view-definition')) {
                category = 'definition';
            } else if (container.closest('#view-single-relationship')) {
                category = 'single-relationship';
            } else if (container.id.includes('mcq') || container.closest('[id^="topic-mcq-"]')) {
                category = 'mcq';
            }
            
            // Try to detect topic from container ID
            const containerId = container.closest('[id^="topic-"]')?.id || '';
            if (containerId) {
                const topicMatch = containerId.match(/topic-(?:mcq-)?(.+)/);
                if (topicMatch) {
                    detectedTopic = topicMatch[1];
                }
            }

            // Store the question ID if editing (not duplicating) - do this BEFORE setTimeout
            if (!isDuplicate && container.id) {
                window.editingQuestionId = container.id;
            } else {
                window.editingQuestionId = null;
            }
            
            // Store the title for later use
            const finalTitle = isDuplicate ? title + " (Copy)" : title;

            // Switch to admin tab
            switchTab('admin', document.getElementById('btn-sidebar-admin'));

            // Set form values with a small delay to ensure DOM is ready
            setTimeout(() => {
                // Set category
                document.getElementById('admin-category').value = category;
                handleCategoryChange(category);
                
                // Set the title explicitly
                document.getElementById('admin-title').value = finalTitle;
                
                // Try to set the topic
                const topicSelect = document.getElementById('admin-topic');
                const topicExists = Array.from(topicSelect.options).some(opt => opt.value === detectedTopic);
                if (topicExists) {
                    topicSelect.value = detectedTopic;
                }
                
                // Try to detect MCQ level from topic container
                if (category === 'mcq') {
                    // Check which level's topics include this topic
                    for (const [level, topics] of Object.entries(window.mcqCurriculum)) {
                        const normalizedTopics = topics.map(t => t.toLowerCase().replace(/\s+/g, '-'));
                        if (normalizedTopics.includes(detectedTopic)) {
                            document.getElementById('admin-level').value = level;
                            updateAdminTopicsByLevel(level);
                            // Re-set the topic after updating options
                            setTimeout(() => {
                                const topicSelect = document.getElementById('admin-topic');
                                const topicExists = Array.from(topicSelect.options).some(opt => opt.value === detectedTopic);
                                if (topicExists) {
                                    topicSelect.value = detectedTopic;
                                }
                                // Re-set title again after MCQ updates to be sure
                                document.getElementById('admin-title').value = finalTitle;
                            }, 100);
                            break;
                        }
                    }
                }
                
                // Update editing indicator after title is set
                updateEditingIndicator();
            }, 100);

            window.adminBlocks = [];
            
            // ========== EXTRACT CONTENT IN DOM ORDER ==========
            // Find the question body container
            const questionBody = container.querySelector('.question-body, .answer-template, .mcq-body') || container;
            
            // Get all direct children and walk through them in order
            const processElement = (element, blockIdOffset) => {
                if (!element || element.classList?.contains('controls')) return;
                
                const tagName = element.tagName?.toLowerCase();
                
                // Skip certain elements
                if (element.classList?.contains('feedback-icon')) return;
                if (element.classList?.contains('mcq-option')) return; // MCQ options handled separately
                if (element.classList?.contains('mcq-container')) return; // MCQ container handled separately
                if (tagName === 'button') return;
                if (tagName === 'h3') return; // Title is handled separately
                
                // Check for explanation box
                if (element.classList?.contains('explanation-box')) {
                    const contentDiv = element.querySelector('div:last-child') || element.querySelector('div');
                    let explainText = '';
                    if (contentDiv) {
                        explainText = contentDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '').trim();
                    } else {
                        explainText = element.textContent.replace(/\s*Explanation/i, '').trim();
                    }
                    if (explainText) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'explanation', 
                            value: explainText
                        });
                    }
                    return;
                }
                
                // Check for video container
                if (element.classList?.contains('video-container')) {
                    const iframe = element.querySelector('iframe');
                    if (iframe && iframe.src) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'video', 
                            value: iframe.src
                        });
                    }
                    return;
                }
                
                // Check for standalone iframe (video)
                if (tagName === 'iframe' && (element.src?.includes('youtube') || element.src?.includes('dropbox'))) {
                    window.adminBlocks.push({ 
                        id: Date.now() + blockIdOffset, 
                        type: 'video', 
                        value: element.src
                    });
                    return;
                }
                
                // Check for image
                if (tagName === 'img' && element.src && !element.src.includes('data:')) {
                    window.adminBlocks.push({ 
                        id: Date.now() + blockIdOffset, 
                        type: 'image', 
                        value: element.src 
                    });
                    return;
                }
                
                // Check for table
                if (tagName === 'table') {
                    // Extract table data with merge support
                    const rows = element.querySelectorAll('tr');
                    
                    // First pass: determine actual grid dimensions and collect merge info
                    let maxCols = 0;
                    const mergedCells = [];
                    
                    // Create a grid to track which cells are occupied
                    const occupiedGrid = {};
                    
                    rows.forEach((row, rowIdx) => {
                        let colIdx = 0;
                        row.querySelectorAll('th, td').forEach((cell) => {
                            // Skip already occupied positions
                            while (occupiedGrid[`${rowIdx}-${colIdx}`]) {
                                colIdx++;
                            }
                            
                            const colspan = parseInt(cell.getAttribute('colspan'), 10) || 1;
                            const rowspan = parseInt(cell.getAttribute('rowspan'), 10) || 1;
                            
                            // Mark cells as occupied
                            for (let r = 0; r < rowspan; r++) {
                                for (let c = 0; c < colspan; c++) {
                                    occupiedGrid[`${rowIdx + r}-${colIdx + c}`] = {
                                        content: cell.textContent.trim(),
                                        align: cell.style.textAlign || 'left',
                                        vAlign: cell.style.verticalAlign || 'middle',
                                        bgColor: cell.style.backgroundColor || '#FFFFFF',
                                        isOrigin: r === 0 && c === 0,
                                        originRow: rowIdx,
                                        originCol: colIdx
                                    };
                                }
                            }
                            
                            // Record merge info if this is a merged cell
                            if (colspan > 1 || rowspan > 1) {
                                mergedCells.push({
                                    startRow: rowIdx,
                                    startCol: colIdx,
                                    endRow: rowIdx + rowspan - 1,
                                    endCol: colIdx + colspan - 1
                                });
                            }
                            
                            maxCols = Math.max(maxCols, colIdx + colspan);
                            colIdx += colspan;
                        });
                    });
                    
                    const numRows = rows.length;
                    const numCols = maxCols;
                    
                    // Build cell data array
                    const tableData = {
                        rows: numRows,
                        cols: numCols,
                        cells: [],
                        headerRow: !!rows[0]?.querySelector('th'),
                        colWidths: [],
                        rowHeights: []
                    };
                    
                    // Add merged cells data if any
                    if (mergedCells.length > 0) {
                        tableData.mergedCells = mergedCells;
                    }
                    
                    // Build cells array from occupied grid
                    for (let r = 0; r < numRows; r++) {
                        const rowData = [];
                        for (let c = 0; c < numCols; c++) {
                            const cellInfo = occupiedGrid[`${r}-${c}`];
                            if (cellInfo) {
                                rowData.push({
                                    content: cellInfo.isOrigin ? cellInfo.content : '',
                                    align: cellInfo.align,
                                    vAlign: cellInfo.vAlign || 'middle',
                                    bgColor: cellInfo.bgColor
                                });
                            } else {
                                rowData.push({
                                    content: '',
                                    align: 'left',
                                    vAlign: 'middle',
                                    bgColor: '#FFFFFF'
                                });
                            }
                        }
                        tableData.cells.push(rowData);
                        
                        // Extract row height
                        const rowHeight = parseInt(rows[r].style.height, 10) || null;
                        if (rowHeight) {
                            tableData.rowHeights[r] = rowHeight;
                        }
                    }
                    
                    // Extract column widths from first row cells
                    let colIdx = 0;
                    rows[0]?.querySelectorAll('th, td').forEach((cell) => {
                        while (occupiedGrid[`0-${colIdx}`] && !occupiedGrid[`0-${colIdx}`].isOrigin) {
                            colIdx++;
                        }
                        const colWidth = parseInt(cell.style.width, 10) || null;
                        if (colWidth) {
                            tableData.colWidths[colIdx] = colWidth;
                        }
                        const colspan = parseInt(cell.getAttribute('colspan'), 10) || 1;
                        colIdx += colspan;
                    });
                    
                    // Clean up empty arrays
                    if (tableData.colWidths.length === 0 || tableData.colWidths.every(w => !w)) {
                        delete tableData.colWidths;
                    }
                    if (tableData.rowHeights.length === 0 || tableData.rowHeights.every(h => !h)) {
                        delete tableData.rowHeights;
                    }
                    
                    if (tableData.rows > 0 && tableData.cols > 0) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'table', 
                            value: tableData
                        });
                    }
                    return;
                }
                
                // Check for CER segment (fill-in-blank)
                if (element.classList?.contains('cer-segment')) {
                    let segText = '';
                    const label = element.getAttribute('data-label') || '';
                    
                    // Walk through all nodes to build the text with blanks marked
                    const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT);
                    let node;
                    while (node = walker.nextNode()) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            segText += node.textContent;
                        } else if (node.nodeType === Node.ELEMENT_NODE) {
                            if (node.classList?.contains('answer-input') || node.tagName === 'INPUT') {
                                const answer = node.dataset?.answer || node.value || '';
                                if (answer) {
                                    segText += `[${answer}]`;
                                }
                            }
                        }
                    }
                    
                    segText = segText.replace(/\s+/g, ' ').trim();
                    // Remove feedback icons text
                    segText = segText.replace(/[]/g, '').trim();
                    
                    if (segText) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'answer', 
                            value: (label ? `(${label}) ` : '') + segText
                        });
                    }
                    return;
                }
                
                // Check for div with text content (but not containers)
                if (tagName === 'div') {
                    // Skip if it's a container div with children that we'll process
                    const hasProcessableChildren = element.querySelector('img, table, iframe, .cer-segment, .explanation-box, .video-container');
                    if (hasProcessableChildren) {
                        // Process children instead
                        Array.from(element.children).forEach((child, idx) => {
                            processElement(child, blockIdOffset + idx * 10);
                        });
                        return;
                    }
                    
                    // It's a text div
                    const text = element.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '').trim();
                    if (text && text.length > 0) {
                        window.adminBlocks.push({ 
                            id: Date.now() + blockIdOffset, 
                            type: 'text', 
                            value: text
                        });
                    }
                    return;
                }
                
                // Check for paragraph
                if (tagName === 'p') {
                    // Skip if inside mcq-option or explanation
                    if (element.closest('.mcq-option') || element.closest('.explanation-box')) return;
                    
                    const text = element.textContent.trim();
                    if (text) {
                        // Check if this is a question-title
                        if (element.classList?.contains('question-title')) {
                            window.adminBlocks.push({ 
                                id: Date.now() + blockIdOffset, 
                                type: 'text', 
                                value: text
                            });
                        } else {
                            window.adminBlocks.push({ 
                                id: Date.now() + blockIdOffset, 
                                type: 'text', 
                                value: text
                            });
                        }
                    }
                    return;
                }
            };
            
            // Process all children of the question body in order
            let blockOffset = 0;
            Array.from(questionBody.children).forEach((child, idx) => {
                processElement(child, blockOffset);
                blockOffset += 100;
            });
            
            // If no blocks were extracted, try a simpler approach for older question formats
            if (window.adminBlocks.length === 0) {
                // Get text content
                const allText = [];
                container.querySelectorAll('p:not(.question-title), div[style*="margin-bottom"]').forEach(el => {
                    if (!el.closest('.mcq-option') && !el.closest('.explanation-box') && !el.closest('.controls')) {
                        const text = el.textContent.trim();
                        if (text) allText.push(text);
                    }
                });
                if (allText.length > 0) {
                    window.adminBlocks.push({ 
                        id: Date.now(), 
                        type: 'text', 
                        value: allText.join('\n\n')
                    });
                }
                
                // Get images
                container.querySelectorAll('img').forEach((img, idx) => {
                    if (img.src && !img.src.includes('data:') && !img.closest('.explanation-box')) {
                        window.adminBlocks.push({ 
                            id: Date.now() + idx + 100, 
                            type: 'image', 
                            value: img.src
                        });
                    }
                });
                
                // Get explanation
                const explanation = container.querySelector('.explanation-box');
                if (explanation) {
                    const contentDiv = explanation.querySelector('div:last-child') || explanation.querySelector('div');
                    let explainText = contentDiv ? contentDiv.textContent.trim() : explanation.textContent.replace(/\s*Explanation/i, '').trim();
                    if (explainText) {
                        window.adminBlocks.push({ 
                            id: Date.now() + 500, 
                            type: 'explanation', 
                            value: explainText
                        });
                    }
                }
                
                // Get video
                const video = container.querySelector('iframe[src*="youtube"], iframe[src*="dropbox"], .video-container iframe');
                if (video && video.src) {
                    window.adminBlocks.push({ 
                        id: Date.now() + 600, 
                        type: 'video', 
                        value: video.src
                    });
                }
            }
            
            // Handle MCQ specific content - fill in the option fields
            if (category === 'mcq') {
                const mcqOptions = container.querySelectorAll('.mcq-option');
                mcqOptions.forEach((opt, idx) => {
                    const input = opt.querySelector('input[type="radio"]');
                    const span = opt.querySelector('span');
                    if (span && idx < 4) {
                        let optText = span.textContent.trim();
                        optText = optText.replace(/^\d+\.\s*/, '');
                        setTimeout(() => {
                            document.getElementById(`mcq-opt-${idx + 1}`).value = optText;
                            if (input && input.dataset.correct === 'true') {
                                document.getElementById('mcq-correct').value = (idx + 1).toString();
                            }
                        }, 150);
                    }
                });
            }

            renderAdminBlocks();
            
            // Hide preview section when loading new content
            document.getElementById('admin-preview-section').classList.add('hidden');
            
            // Final safety: set title again after everything is done
            setTimeout(() => {
                document.getElementById('admin-title').value = finalTitle;
                updateEditingIndicator();
            }, 200);
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // =====================================================
        // QUESTION FORM SETUP
        // =====================================================

        function setupQuestionForm(formId) {
            const form = document.getElementById(formId);
            if (!form) return;
            const questionContainer = form.closest('.question-container');
            if (!questionContainer) return;
            const submitBtn = questionContainer.querySelector('.submit-btn');
            const nextBtn = questionContainer.querySelector('.next-btn');
            const segments = form.querySelectorAll('.cer-segment');

            if (!submitBtn) return;

            submitBtn.addEventListener('click', () => {
                let allCorrect = true;
                
                segments.forEach(segment => {
                    const inputs = segment.querySelectorAll('.answer-input');
                    const icon = segment.querySelector('.feedback-icon');
                    let isGroupCorrect = true;
                    inputs.forEach(input => {
                        const userAnswer = input.value.trim().toLowerCase();
                        const answerString = input.dataset.answer.toLowerCase();
                        const validAnswers = answerString.split('|').map(a => a.trim());

                        if (validAnswers.includes(userAnswer)) {
                            input.style.borderBottomColor = 'var(--correct-color)';
                        } else {
                            input.style.borderBottomColor = 'var(--incorrect-color)';
                            input.value = validAnswers[0];
                            isGroupCorrect = false;
                            allCorrect = false;
                        }
                    });
                    if (icon) {
                        icon.textContent = isGroupCorrect ? '' : '';
                        icon.classList.add(isGroupCorrect ? 'correct' : 'incorrect', 'visible');
                    }
                });

                form.querySelectorAll('.answer-input').forEach(input => input.disabled = true);
                submitBtn.disabled = true;
                
                if (nextBtn) nextBtn.classList.remove('hidden');
                
                // Show explanation if it exists
                const explanationBox = form.querySelector('.explanation-box');
                if (explanationBox) {
                    explanationBox.style.display = 'block';
                }
                
                // Show video if it exists
                const videoContainer = form.querySelector('.video-container');
                if (videoContainer) {
                    videoContainer.style.display = 'block';
                }
                
                // Track OEQ answer for admin dashboard
                const questionId = questionContainer.id;
                if (questionId && window.trackQuestionAttempt) {
                    window.trackQuestionAttempt(questionId, allCorrect);
                }
            });
        }
        window.setupQuestionFormGlobal = setupQuestionForm;

        // =====================================================
        // ADD CONTROLS TO QUESTIONS
        // =====================================================

        function addControlsToQuestion(container) {
            // Add worksheet button if not exists
            if (!container.querySelector('.worksheet-control-bar')) {
                const bar = document.createElement('div');
                bar.className = 'worksheet-control-bar';
                bar.style.display = 'flex';
                bar.style.gap = '10px';
                bar.style.flexWrap = 'wrap';

                const qId = container.id;
                const isInWorksheet = qId && window.worksheetItems.some(item => item.id === qId);

                bar.innerHTML = `
                    <button class="btn-worksheet-add ${isInWorksheet ? 'added' : ''}" onclick="toggleWorksheetItem(this)">${isInWorksheet ? ' Added' : ' Worksheet'}</button>
                    <button class="consult-btn" onclick="showConsultModal(this)"> Ask Mr Chung</button>
                    <button class="print-question-btn" onclick="printSingleQuestion(this.closest('.question-container'))"> Print</button>
                    <button class="flag-question-btn" onclick="showFlagModal(this.closest('.question-container'))"> Flag</button>
                `;
                container.appendChild(bar);
            } else {
                // Add consult button if missing
                const bar = container.querySelector('.worksheet-control-bar');
                if (bar && !bar.querySelector('.consult-btn')) {
                    const consultBtn = document.createElement('button');
                    consultBtn.className = 'consult-btn';
                    consultBtn.onclick = function() { showConsultModal(this); };
                    consultBtn.innerHTML = ' Ask Mr Chung';
                    bar.appendChild(consultBtn);
                }
                // Add print button if missing
                if (bar && !bar.querySelector('.print-question-btn')) {
                    const printBtn = document.createElement('button');
                    printBtn.className = 'print-question-btn';
                    printBtn.onclick = function() { printSingleQuestion(this.closest('.question-container')); };
                    printBtn.innerHTML = ' Print';
                    bar.appendChild(printBtn);
                }
                // Add flag button if missing
                if (bar && !bar.querySelector('.flag-question-btn')) {
                    const flagBtn = document.createElement('button');
                    flagBtn.className = 'flag-question-btn';
                    flagBtn.onclick = function() { showFlagModal(this.closest('.question-container')); };
                    flagBtn.innerHTML = ' Flag';
                    bar.appendChild(flagBtn);
                }
            }

            // Add admin controls if admin
            if (window.isAdminUser && !container.querySelector('.admin-controls')) {
                const controls = document.createElement('div');
                controls.className = 'admin-controls';
                
                const isCustomQuestion = container.classList.contains('custom-question') || container.id.includes('custom');
                
                let controlsHtml = `
                    <button class="admin-edit-btn" onclick="editQuestion(this)"> Edit</button>
                    <button class="admin-duplicate-btn" onclick="editQuestion(this, true)"> Duplicate</button>
                `;
                
                if (isCustomQuestion) {
                    controlsHtml += `<button class="admin-delete-btn" onclick="deleteQuestion(this)" style="background: #ffeae8; color: #dc3545; border: 1px solid #dc3545;"> Delete</button>`;
                }
                
                controls.innerHTML = controlsHtml;
                container.appendChild(controls);
            }
        }

        // Delete a custom question
        window.deleteQuestion = async function(btn) {
            if (!confirm("Are you sure you want to delete this question? This cannot be undone.")) return;
            
            const container = btn.closest('.question-container');
            if (!container || !container.id) {
                alert("Cannot identify question to delete.");
                return;
            }
            
            try {
                const questionId = container.id.replace('q-', '');
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                await deleteDoc(doc(window.db_fs, "custom_questions", questionId));
                
                alert("Question deleted successfully!");
                container.remove();
            } catch (e) {
                console.error("Delete Error:", e);
                alert("Error deleting question: " + e.message);
            }
        };

        window.updateAllControls = function () {
            document.querySelectorAll('.question-container').forEach(addControlsToQuestion);
        };

        // =====================================================
        // PRINT FUNCTIONS
        // =====================================================

        window.printQuestion = function (btn) {
            const container = btn.closest('.question-container');
            container.classList.add('printing');
            document.body.classList.add('print-single');
            window.print();
            document.body.classList.remove('print-single');
            container.classList.remove('printing');
        };

        window.printAll = function () {
            document.body.classList.add('print-all');
            window.print();
            document.body.classList.remove('print-all');
        };

        // =====================================================
        // TOPIC SWITCHING
        // =====================================================

        function switchTopic(topic) {
            const navButtons = {
                heat: document.getElementById('btn-heat'),
                light: document.getElementById('btn-light'),
                materials: document.getElementById('btn-materials')
            };
            const topics = {
                heat: document.getElementById('topic-heat'),
                light: document.getElementById('topic-light'),
                materials: document.getElementById('topic-materials')
            };

            Object.values(navButtons).forEach(btn => btn?.classList.remove('active'));
            Object.values(topics).forEach(t => t?.classList.add('hidden'));

            if (navButtons[topic]) navButtons[topic].classList.add('active');
            if (topics[topic]) topics[topic].classList.remove('hidden');
        }

        // =====================================================
        // MOBILE SIDEBAR TOGGLE
        // =====================================================
        
        window.toggleMobileSidebar = function() {
            const sidebar = document.querySelector('.app-body > .sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const toggleBtn = document.getElementById('mobile-menu-toggle');
            const icon = document.getElementById('mobile-menu-icon');
            
            if (sidebar && overlay) {
                const isOpen = sidebar.classList.contains('mobile-open');
                
                if (isOpen) {
                    closeMobileSidebar();
                } else {
                    sidebar.classList.add('mobile-open');
                    overlay.classList.add('active');
                    toggleBtn.classList.add('active');
                    icon.textContent = '';
                    document.body.style.overflow = 'hidden';
                    
                    // Ensure sidebar is clickable
                    sidebar.style.pointerEvents = 'auto';
                    sidebar.style.zIndex = '10000';
                    
                    // Prevent overlay from blocking sidebar clicks
                    overlay.style.zIndex = '9998';
                }
            }
        };

        window.closeMobileSidebar = function() {
            const sidebar = document.querySelector('.app-body > .sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const toggleBtn = document.getElementById('mobile-menu-toggle');
            const icon = document.getElementById('mobile-menu-icon');
            
            if (sidebar) {
                sidebar.classList.remove('mobile-open');
            }
            if (overlay) {
                overlay.classList.remove('active');
            }
            if (toggleBtn) {
                toggleBtn.classList.remove('active');
            }
            if (icon) {
                icon.textContent = '';
            }
            document.body.style.overflow = '';
        };
        
        // Prevent sidebar clicks from closing the sidebar (only overlay should close it)
        // Also ensure sidebar buttons are clickable
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.querySelector('.app-body > .sidebar');
            if (sidebar) {
                // Stop clicks on sidebar background from bubbling to overlay
                // But allow all interactive elements to work normally
                sidebar.addEventListener('click', function(e) {
                    // Check if the click is on an interactive element
                    const isInteractive = e.target.closest('button') || 
                                        e.target.closest('a') || 
                                        e.target.closest('input') || 
                                        e.target.closest('select') ||
                                        e.target.closest('.ios-toggle') ||
                                        e.target.closest('.exam-mode-toggle') ||
                                        e.target.closest('.ios-toggle-track') ||
                                        e.target.closest('.ios-toggle-thumb') ||
                                        e.target.closest('.exam-mode-track') ||
                                        e.target.closest('.exam-mode-thumb');
                    
                    // Only stop propagation for non-interactive elements (sidebar background)
                    // This prevents overlay from closing sidebar, but allows buttons to work
                    if (!isInteractive && e.target === sidebar) {
                        e.stopPropagation();
                    }
                }, false); // Use bubble phase, not capture
            }
        });

        // Close sidebar when clicking a sidebar button on mobile
        window.handleSidebarButtonClick = function(callback) {
            return function(e) {
                // Close mobile sidebar if open
                if (window.innerWidth <= 768) {
                    closeMobileSidebar();
                }
                // Execute the original callback
                if (callback) callback(e);
            };
        };

        // Handle orientation change
        window.addEventListener('orientationchange', function() {
            // Close mobile sidebar on orientation change
            closeMobileSidebar();
            
            // Delay to let the browser settle
            setTimeout(() => {
                // Scroll to top to reset view
                window.scrollTo(0, 0);
            }, 100);
        });

        // Handle resize - close sidebar if switching from mobile to desktop
        let lastWidth = window.innerWidth;
        window.addEventListener('resize', function() {
            const currentWidth = window.innerWidth;
            
            // If crossing the 768px threshold, close mobile sidebar
            if (lastWidth <= 768 && currentWidth > 768) {
                closeMobileSidebar();
            }
            
            lastWidth = currentWidth;
        });

        // Prevent body scroll when sidebar is open (iOS fix)
        document.addEventListener('touchmove', function(e) {
            const sidebar = document.querySelector('.app-body > .sidebar');
            if (sidebar && sidebar.classList.contains('mobile-open')) {
                // Allow scrolling and clicking within the sidebar
                // Only prevent scroll on the overlay/background
                if (!sidebar.contains(e.target)) {
                    e.preventDefault();
                }
            }
        }, { passive: false });

        // =====================================================
        // DOM CONTENT LOADED
        // =====================================================

        document.addEventListener('DOMContentLoaded', () => {
            // Load worksheet from storage
            loadWorksheetFromStorage();

            // Setup topic navigation
            const topicButtons = ['heat', 'light', 'materials'];
            topicButtons.forEach(topic => {
                const btn = document.getElementById(`btn-${topic}`);
                if (btn) {
                    btn.addEventListener('click', () => switchTopic(topic));
                }
            });

            // Setup next buttons
            document.querySelectorAll('.next-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const currentQuestion = button.closest('.question-container');
                    const nextQuestion = currentQuestion?.nextElementSibling;
                    if (nextQuestion && nextQuestion.classList.contains('question-container')) {
                        nextQuestion.classList.remove('hidden');
                        nextQuestion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });

            // Setup all question forms
            document.querySelectorAll('.answer-template').forEach(form => {
                if (form.id) setupQuestionForm(form.id);
            });

            // Initialize with heat topic
            switchTopic('heat');

            // Initialize OEQ/MCQ toggle label
            const oeqLabel = document.querySelector('.ios-toggle-label:first-of-type');
            if (oeqLabel) oeqLabel.classList.add('active');

            // Initialize level selection
            initLevel();

            // Initialize Exam Mode (Colour/Monochrome)
            initExamMode();

            // Initialize with MCQ mode as default
            switchMode('mcq');

            // Update worksheet UI
            updateWorksheetUI();
        });
    </script>

    <!-- Firebase Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, getDocs, query, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAUSI3Uh28IeqASEp0JhH4QPaVt-O3meBo",
            authDomain: "mathgen--app.firebaseapp.com",
            projectId: "mathgen--app",
            storageBucket: "mathgen--app.firebasestorage.app",
            messagingSenderId: "165654161198",
            appId: "1:165654161198:web:16c8bd60eb3a2aa7edbcbf",
            measurementId: "G-0MWZFG211D"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth;
        const db_fs = getFirestore(app);
        window.db_fs = db_fs;
        const googleProvider = new GoogleAuthProvider();

        let isSignUpMode = false;

        window.toggleAuthMode = () => {
            isSignUpMode = !isSignUpMode;
            document.querySelector('.toggle-link').innerText = isSignUpMode ? "Already have an account? Login" : "New here? Create an Account";
            document.getElementById('reg-fields').style.display = isSignUpMode ? "block" : "none";
            document.getElementById('legal-box').style.display = isSignUpMode ? "block" : "none";
            document.getElementById('btn-google').style.display = isSignUpMode ? "none" : "flex";
            document.getElementById('auth-title').innerText = isSignUpMode ? "Create New Account" : "Welcome Back!";
            document.getElementById('auth-subtitle').innerText = isSignUpMode ? "Register to start your learning journey" : "Sign in to continue your learning journey";
            document.getElementById('btn-login').innerText = isSignUpMode ? "Create Account" : "Login";
            document.getElementById('forgot-password-link').style.display = isSignUpMode ? "none" : "block";
            
            // Show/hide password confirmation
            document.getElementById('auth-pass-confirm').style.display = isSignUpMode ? "block" : "none";
            document.getElementById('auth-pass').placeholder = isSignUpMode ? "Create Password" : "Password";
            
            // Clear error
            document.getElementById('auth-error').innerText = "";
        };

        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errorMsg = document.getElementById('auth-error');
            errorMsg.style.color = "#dc3545";
            
            if (!email || !pass) { errorMsg.innerText = "Fields cannot be empty."; return; }

            try {
                if (isSignUpMode) {
                    // Validate password confirmation
                    const passConfirm = document.getElementById('auth-pass-confirm').value;
                    if (pass !== passConfirm) {
                        errorMsg.innerText = "Passwords do not match.";
                        return;
                    }
                    if (pass.length < 6) {
                        errorMsg.innerText = "Password must be at least 6 characters.";
                        return;
                    }
                    
                    const pName = document.getElementById('parent-name').value;
                    const students = getStudentsData();
                    
                    if (!pName) {
                        errorMsg.innerText = "Please enter parent's name."; 
                        return;
                    }
                    if (students.length === 0) {
                        errorMsg.innerText = "Please add at least one student with name and level."; 
                        return;
                    }
                    if (!document.getElementById('legal-agree').checked) {
                        errorMsg.innerText = "Please agree to the terms and conditions."; 
                        return;
                    }
                    
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db_fs, "users", cred.user.uid), {
                        email, 
                        parentName: pName, 
                        students: students,
                        studentName: students[0].name, // Backwards compatibility
                        level: students[0].level, // Backwards compatibility
                        loginDays: 1, 
                        lastLoginDate: new Date().toDateString(), 
                        agreedToTerms: true,
                        createdAt: new Date()
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (e) {
                console.error("Auth Error:", e);
                if (e.code === 'auth/email-already-in-use') {
                    errorMsg.innerText = "This email is already registered. Please login instead.";
                } else if (e.code === 'auth/weak-password') {
                    errorMsg.innerText = "Password must be at least 6 characters.";
                } else if (e.code === 'auth/invalid-email') {
                    errorMsg.innerText = "Please enter a valid email address.";
                } else if (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') {
                    errorMsg.innerText = "Invalid email or password.";
                } else {
                    errorMsg.innerText = "Error: " + e.message;
                }
            }
        };

        window.handleForgotPassword = async () => {
            const email = document.getElementById('auth-email').value;
            const errorMsg = document.getElementById('auth-error');
            if (!email) {
                errorMsg.innerText = "Please enter your email address first.";
                errorMsg.style.color = "#dc3545";
                return;
            }

            try {
                await sendPasswordResetEmail(auth, email);
                errorMsg.innerText = "Password reset email sent! Check your inbox.";
                errorMsg.style.color = "#28a745";
            } catch (e) {
                console.error("Reset Error:", e);
                errorMsg.innerText = "Error sending reset email: " + e.message;
                errorMsg.style.color = "#dc3545";
            }
        };

        window.handleGoogleLogin = async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                // Check if first-time Google user
                const userRef = doc(db_fs, "users", result.user.uid);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists() || !userSnap.data().students || userSnap.data().students.length === 0) {
                    // First-time Google user - show setup modal
                    window.pendingGoogleUser = result.user;
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('google-setup-modal').classList.add('visible');
                } else {
                    await trackLoginDays(result.user);
                }
            } catch (e) {
                document.getElementById('auth-error').innerText = "Google Error: " + e.message;
            }
        };

        // Add student entry for Google setup
        window.addGoogleStudentEntry = function() {
            const container = document.getElementById('google-students-container');
            const entries = container.querySelectorAll('.google-student-entry');
            const newIndex = entries.length;
            
            const entryDiv = document.createElement('div');
            entryDiv.className = 'google-student-entry';
            entryDiv.dataset.studentIndex = newIndex;
            entryDiv.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" class="auth-input google-student-name" placeholder="Student's Name" style="flex: 1; margin-bottom: 0;">
                    <select class="auth-input google-student-level" style="width: 100px; margin-bottom: 0;">
                        <option value="">Level</option>
                        <option value="P3">P3</option>
                        <option value="P4">P4</option>
                        <option value="P5">P5</option>
                        <option value="P6">P6</option>
                    </select>
                    <button type="button" onclick="this.parentElement.parentElement.remove()" style="background: #ffebee; border: none; border-radius: 8px; width: 40px; color: #f44336; font-size: 1.2rem; cursor: pointer;"></button>
                </div>
            `;
            container.appendChild(entryDiv);
        };

        // Get students data from Google setup modal
        window.getGoogleStudentsData = function() {
            const students = [];
            document.querySelectorAll('.google-student-entry').forEach(entry => {
                const name = entry.querySelector('.google-student-name').value.trim();
                const level = entry.querySelector('.google-student-level').value;
                if (name && level) {
                    students.push({ name, level });
                }
            });
            return students;
        };

        // Complete Google setup
        window.completeGoogleSetup = async function() {
            const errorMsg = document.getElementById('google-setup-error');
            errorMsg.style.color = "#dc3545";
            
            const parentName = document.getElementById('google-parent-name').value.trim();
            const students = getGoogleStudentsData();
            
            if (!parentName) {
                errorMsg.innerText = "Please enter parent's name.";
                return;
            }
            if (students.length === 0) {
                errorMsg.innerText = "Please add at least one student with name and level.";
                return;
            }
            if (!document.getElementById('google-legal-agree').checked) {
                errorMsg.innerText = "Please agree to the terms and conditions.";
                return;
            }
            
            try {
                const user = window.pendingGoogleUser;
                if (!user) {
                    errorMsg.innerText = "Session expired. Please try again.";
                    return;
                }
                
                await setDoc(doc(db_fs, "users", user.uid), {
                    email: user.email,
                    parentName: parentName,
                    students: students,
                    studentName: students[0].name, // Backwards compatibility
                    level: students[0].level, // Backwards compatibility
                    loginDays: 1,
                    lastLoginDate: new Date().toDateString(),
                    agreedToTerms: true,
                    createdAt: new Date(),
                    authProvider: 'google'
                });
                
                // Hide modal and continue
                document.getElementById('google-setup-modal').classList.remove('visible');
                window.pendingGoogleUser = null;
                
                // Reload page to complete login
                window.location.reload();
            } catch (e) {
                console.error("Setup Error:", e);
                errorMsg.innerText = "Error saving details: " + e.message;
            }
        };

        async function trackLoginDays(user) {
            const userRef = doc(db_fs, "users", user.uid);
            const today = new Date().toDateString();
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                const data = userSnap.data();
                
                // Check if Google user without student setup
                if ((!data.students || data.students.length === 0) && !window.isAdminUser) {
                    // Show setup modal
                    window.pendingGoogleUser = user;
                    document.getElementById('google-setup-modal').classList.add('visible');
                    return;
                }
                
                if (data.lastLoginDate !== today) {
                    await updateDoc(userRef, { loginDays: increment(1), lastLoginDate: today });
                }
                const display = document.getElementById('login-days-display');
                if (display) display.innerText = ` Day ${data.loginDays || 1} streak!`;
            } else {
                // New user via Google - minimal record, setup modal will be shown
                await setDoc(userRef, { 
                    email: user.email, 
                    studentName: user.displayName || "Student", 
                    loginDays: 1, 
                    lastLoginDate: today,
                    createdAt: new Date()
                });
                
                // Show setup modal for first-time Google users
                if (!window.isAdminUser) {
                    window.pendingGoogleUser = user;
                    document.getElementById('google-setup-modal').classList.add('visible');
                }
            }
        }

        window.handleLogout = () => signOut(auth).then(() => {
            // Clear all session data on logout
            sessionStorage.clear();
            localStorage.removeItem('server_file_version');
            window.location.href = window.location.origin + window.location.pathname + '?r=' + Date.now();
        });

        onAuthStateChanged(auth, (user) => {
            const overlay = document.getElementById('auth-overlay');
            if (user) {
                overlay.style.display = 'none';
                trackLoginDays(user);

                window.loadCustomQuestions = async function() {
                    if (window.customQuestionsLoaded) return;
                    window.customQuestionsLoaded = true;

                    try {
                        const qSnapshot = await getDocs(query(collection(db_fs, "custom_questions")));
                        qSnapshot.forEach((docSnap) => {
                            const data = docSnap.data();

                            // Skip pending questions for non-admin users
                            // Questions with status='pending' are only visible to admins for review
                            if (data.status === 'pending' && !window.isAdminUser) {
                                return; // Skip this question
                            }

                            const category = data.category;
                            const topic = data.topic || 'general';
                            const topicId = topic.toLowerCase().replace(/\s+/g, '-');

                            // If MCQ, attach to the main content area topics instead of being inside view-cer
                            const mainContentArea = document.getElementById('main-content-area');
                            const targetView = category === 'mcq' ? null : document.getElementById(`view-${category}`);

                            let containerId = category === 'mcq' ? `topic-mcq-${topicId}` : `topic-${topicId}`;
                            let topicContainer = document.getElementById(containerId);

                            if (!topicContainer) {
                                topicContainer = document.createElement('div');
                                topicContainer.id = containerId;
                                topicContainer.className = 'topic-content hidden';
                                if (category === 'mcq') {
                                    mainContentArea.appendChild(topicContainer);
                                } else if (targetView) {
                                    // Try to find main-content, if not found, append directly to view
                                    const targetContent = targetView.querySelector('.main-content');
                                    if (targetContent) {
                                        targetContent.appendChild(topicContainer);
                                    } else {
                                        targetView.appendChild(topicContainer);
                                    }
                                }
                            }

                            if (topicContainer) {
                                const qId = "q-" + docSnap.id;
                                const div = document.createElement('div');
                                div.className = 'question-container custom-question';
                                div.id = qId;
                                div.style.borderLeft = '4px solid #fbc02d';
                                
                                // Convert any Dropbox URLs in the saved HTML
                                let processedHtml = data.html;
                                // Fix Dropbox image URLs
                                processedHtml = processedHtml.replace(/src="(https:\/\/www\.dropbox\.com\/scl\/[^"]+)"/g, (match, url) => {
                                    let fixedUrl = url.replace(/[?&]dl=[01]/, '&raw=1');
                                    if (!fixedUrl.includes('raw=1')) {
                                        fixedUrl += (fixedUrl.includes('?') ? '&' : '?') + 'raw=1';
                                    }
                                    return `src="${fixedUrl}"`;
                                });
                                
                                // Remove any existing controls/buttons from saved HTML to prevent duplicates
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = processedHtml;
                                tempDiv.querySelectorAll('.controls').forEach(el => el.remove());
                                // Also remove any stray buttons that might be outside controls
                                tempDiv.querySelectorAll('button.submit-btn, button.next-btn, button.print-btn, button.btn-primary').forEach(el => el.remove());
                                // Remove any divs that only contain "Check Answer" text
                                tempDiv.querySelectorAll('div').forEach(div => {
                                    const text = div.textContent.trim();
                                    if (text === 'Check Answer' || text === 'Submit') {
                                        div.remove();
                                    }
                                });
                                // Remove mcq-option labels that contain "Check Answer"
                                tempDiv.querySelectorAll('.mcq-option, label').forEach(el => {
                                    if (el.textContent.trim().includes('Check Answer')) {
                                        el.remove();
                                    }
                                });
                                // Ensure explanation boxes are hidden by default
                                tempDiv.querySelectorAll('.explanation-box').forEach(el => {
                                    el.style.display = 'none';
                                });
                                // Ensure video containers are hidden by default
                                tempDiv.querySelectorAll('.video-container').forEach(el => {
                                    el.style.display = 'none';
                                    el.classList.add('hidden-until-answered');
                                });
                                processedHtml = tempDiv.innerHTML;
                                
                                div.innerHTML = `
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                            <h3 style="margin: 0; color: var(--primary-blue);">${data.title || 'Custom Question'}</h3>
                                            <span style="font-size: 0.7rem; background: #fff9c4; padding: 2px 8px; border-radius: 4px; color: #fbc02d; font-weight: bold;">USER CONTRIBUTED (${topic.toUpperCase()})</span>
                                        </div>
                                        <div id="${qId}-body" class="question-body ${category === 'mcq' ? 'mcq-body' : 'answer-template'}" style="background: rgba(251, 192, 45, 0.05); padding: 1.5rem; border-radius: 8px;">
                                            ${processedHtml}
                                            <div class="controls" style="margin-top: 2rem;">
                                                <button class="btn btn-primary submit-btn" ${category === 'mcq' ? `onclick="checkMcq('${qId}-body')"` : ''} style="background: #fbc02d; border-color: #fbc02d;">Check Answer</button>
                                            </div>
                                        </div>
                                    `;
                                topicContainer.appendChild(div);
                                if (category !== 'mcq' && window.setupQuestionFormGlobal) {
                                    window.setupQuestionFormGlobal(`${qId}-body`);
                                }
                            }
                        });

                        if (window.currentMode === 'mcq') window.renderMcqQuestionList();

                        // Update all controls after loading custom questions
                        setTimeout(() => {
                            window.updateAllControls();
                        }, 100);

                    } catch (e) {
                        console.error("Error loading custom questions:", e);
                    }
                }

                // =====================================================
                // FLAGGED QUESTIONS FIREBASE FUNCTIONS
                // =====================================================
                
                // Submit flag to Firebase
                window.submitFlagToFirebase = async function(flagData) {
                    try {
                        const flagId = `flag-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                        await setDoc(doc(db, "flagged_questions", flagId), {
                            ...flagData,
                            id: flagId,
                            userEmail: user.email,
                            userId: user.uid,
                            status: 'pending',
                            createdAt: new Date(),
                            updatedAt: new Date()
                        });
                        alert('Thank you for reporting this issue! An admin will review it soon.');
                    } catch (e) {
                        console.error("Error submitting flag:", e);
                        alert("Error submitting flag. Please try again.");
                    }
                };

                // Load flagged questions from Firebase (admin only)
                window.loadFlaggedQuestionsFromFirebase = async function() {
                    try {
                        const flagsRef = collection(db, "flagged_questions");
                        const snapshot = await getDocs(flagsRef);
                        
                        window.flaggedQuestions = [];
                        snapshot.forEach(doc => {
                            window.flaggedQuestions.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Sort by createdAt descending
                        window.flaggedQuestions.sort((a, b) => {
                            const dateA = a.createdAt?.seconds || 0;
                            const dateB = b.createdAt?.seconds || 0;
                            return dateB - dateA;
                        });
                        
                        window.updateFlaggedCount();
                    } catch (e) {
                        console.error("Error loading flagged questions:", e);
                    }
                };

                // Update flag status in Firebase
                window.updateFlagStatusInFirebase = async function(flagId, status) {
                    try {
                        await updateDoc(doc(db, "flagged_questions", flagId), {
                            status: status,
                            updatedAt: new Date(),
                            resolvedBy: status === 'resolved' ? user.email : null
                        });
                    } catch (e) {
                        console.error("Error updating flag status:", e);
                        alert("Error updating flag. Please try again.");
                    }
                };

                // Delete flag from Firebase
                window.deleteFlagFromFirebase = async function(flagId) {
                    try {
                        await deleteDoc(doc(db, "flagged_questions", flagId));
                    } catch (e) {
                        console.error("Error deleting flag:", e);
                        alert("Error deleting flag. Please try again.");
                    }
                };

                // Check admin status
                const emailParts = user.email.toLowerCase().split('@');
                const handle = emailParts[1] === 'gmail.com' ? emailParts[0].replace(/\./g, '') : emailParts[0];
                const adminHandles = ['zhikaichung', 'chungzhikai'];
                const isAdmin = adminHandles.includes(handle) || user.email.toLowerCase().includes('admin');

                if (isAdmin) {
                    console.log("Admin identified:", user.email);
                    window.isAdminUser = true;
                    document.getElementById('btn-sidebar-admin').classList.remove('hidden');
                    document.getElementById('btn-sidebar-progress').classList.remove('hidden');
                    document.getElementById('btn-sidebar-review').classList.remove('hidden');
                    document.getElementById('header-flagged-btn').classList.remove('hidden');

                    // Load flagged questions count for admin
                    if (window.loadFlaggedQuestionsFromFirebase) {
                        window.loadFlaggedQuestionsFromFirebase().then(() => {
                            window.updateFlaggedCount();
                        });
                    }

                    // Load pending questions count for admin
                    if (window.loadPendingQuestions) {
                        window.loadPendingQuestions().then(() => {
                            window.updatePendingReviewCount();
                        });
                    }
                } else {
                    window.isAdminUser = false;
                    document.getElementById('btn-sidebar-admin').classList.add('hidden');
                    document.getElementById('btn-sidebar-progress').classList.add('hidden');
                    document.getElementById('btn-sidebar-review').classList.add('hidden');
                    document.getElementById('header-flagged-btn').classList.add('hidden');
                }

                window.loadCustomQuestions();

                // Add controls to all questions
                setTimeout(() => {
                    window.updateAllControls();
                    window.updateWorksheetUI();
                    window.addConsultButtons();
                    window.updateUnreadCount();
                    
                    // Update tab counts after questions are loaded
                    if (window.updateTabCounts) {
                        window.updateTabCounts();
                    }
                    
                    // Initialize tooltips
                    if (window.initTooltips) {
                        initTooltips();
                    }
                    
                    // Start checking for updates
                    window.startUpdateChecker();
                    
                    // Track login and show welcome modal with new questions notification (for all users)
                    window.trackLoginAndShowWelcome(user);
                }, 200);
            } else {
                overlay.style.display = 'flex';
            }
        });

        // =====================================================
        // PREMIUM NAVIGATION DROPDOWNS
        // =====================================================

        // Update worksheet count in header badge
        function updateWorksheetCountHeader() {
            const count = window.worksheetItems ? window.worksheetItems.length : 0;
            const headerBadge = document.getElementById('worksheet-count-header');
            if (headerBadge) {
                headerBadge.textContent = count;
                headerBadge.style.display = count > 0 ? 'inline-block' : 'none';
            }
        }

        // Close all dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.nav-group') && !e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown').forEach(dropdown => {
                    dropdown.style.opacity = '0';
                    dropdown.style.transform = 'translateY(-10px)';
                    dropdown.style.pointerEvents = 'none';
                });
                document.querySelectorAll('.nav-arrow').forEach(arrow => {
                    arrow.style.transform = 'rotate(0deg)';
                });
            }
        });

        // Enhanced hover handling with mouseenter/mouseleave for better control
        document.querySelectorAll('.nav-group').forEach(group => {
            let hoverTimeout;
            
            group.addEventListener('mouseenter', () => {
                clearTimeout(hoverTimeout);
                const dropdown = group.querySelector('.nav-dropdown');
                const arrow = group.querySelector('.nav-arrow');
                if (dropdown && arrow) {
                    dropdown.style.opacity = '1';
                    dropdown.style.transform = 'translateY(0)';
                    dropdown.style.pointerEvents = 'all';
                    arrow.style.transform = 'rotate(180deg)';
                }
            });
            
            group.addEventListener('mouseleave', (e) => {
                // Check if we're moving to the dropdown
                const relatedTarget = e.relatedTarget;
                const dropdown = group.querySelector('.nav-dropdown');
                
                if (!relatedTarget || !dropdown || !dropdown.contains(relatedTarget)) {
                    hoverTimeout = setTimeout(() => {
                        const dropdown = group.querySelector('.nav-dropdown');
                        const arrow = group.querySelector('.nav-arrow');
                        if (dropdown && arrow) {
                            dropdown.style.opacity = '0';
                            dropdown.style.transform = 'translateY(-10px)';
                            dropdown.style.pointerEvents = 'none';
                            arrow.style.transform = 'rotate(0deg)';
                        }
                    }, 150); // Small delay to allow cursor movement
                }
            });
            
            // Also handle dropdown hover
            const dropdown = group.querySelector('.nav-dropdown');
            if (dropdown) {
                dropdown.addEventListener('mouseenter', () => {
                    clearTimeout(hoverTimeout);
                });
                
                dropdown.addEventListener('mouseleave', () => {
                    hoverTimeout = setTimeout(() => {
                        const arrow = group.querySelector('.nav-arrow');
                        if (dropdown && arrow) {
                            dropdown.style.opacity = '0';
                            dropdown.style.transform = 'translateY(-10px)';
                            dropdown.style.pointerEvents = 'none';
                            arrow.style.transform = 'rotate(0deg)';
                        }
                    }, 150);
                });
            }
        });

        // Initialize navigation groups - run after auth loads
        function initNavigationGroups() {
            // Update worksheet count
            updateWorksheetCountHeader();
        }

        // Initialize on DOM ready and after auth
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initNavigationGroups);
        } else {
            initNavigationGroups();
        }

        // Also initialize after auth loads
        setTimeout(() => {
            initNavigationGroups();
        }, 500);

        // Scroll to top function for questions interface
        function scrollToTop(sectionId) {
            const section = document.querySelector('.' + sectionId);
            if (section) {
                // Scroll the section header into view
                const header = section.querySelector('h3');
                if (header) {
                    header.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } else {
                // Fallback: scroll to top of page
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Scroll to bottom function for questions interface
        function scrollToBottom(sectionId) {
            const section = document.querySelector('.' + sectionId);
            if (section) {
                const questionsList = section.querySelector('#lesson-questions-list');
                if (questionsList) {
                    // Scroll to the last question in the list
                    const lastQuestion = questionsList.lastElementChild;
                    if (lastQuestion) {
                        lastQuestion.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    } else {
                        // If no questions yet, scroll to bottom of section
                        section.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }
                } else {
                    section.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
            } else {
                // Fallback: scroll to bottom of page
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }
        }

        // =====================================================
        // TUTORIAL SYSTEM
        // =====================================================

        window.tutorialState = {
            currentStep: 0,
            steps: []
        };

        // Define all tutorial steps
        const tutorialSteps = [
            {
                title: "Welcome to the Tutorial! ",
                content: "Welcome! This tutorial will guide you through all the features of the Polymath Science App. You can navigate using the Previous and Next buttons, or skip the tutorial anytime.",
                highlight: null,
                action: null
            },
            {
                title: "Navigation Sidebar ",
                content: "The sidebar on the left contains all the main features. You can access different sections like Leaderboard, My Progress, Worksheet, and more. Each button takes you to a different part of the app.",
                highlight: ".sidebar-nav-section",
                action: null
            },
            {
                title: "Answering Questions - MCQ ",
                content: "For Multiple Choice Questions (MCQ): 1) Read the question carefully, 2) Click on one of the answer options (A, B, C, or D), 3) Click 'Check Answer' to see if you're correct. The correct answer will be highlighted in green, and incorrect answers in red.",
                highlight: ".mcq-container",
                action: () => {
                    // Try to find an MCQ question to highlight
                    const mcqContainer = document.querySelector('.mcq-container');
                    if (mcqContainer) {
                        mcqContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Answering Questions - OEQ ",
                content: "For Open-Ended Questions (OEQ): 1) Read the question and instructions, 2) Type your answer in the text input fields provided, 3) Click 'Submit' to check your answer. You'll see feedback showing which parts are correct.",
                highlight: ".answer-template",
                action: () => {
                    const oeqContainer = document.querySelector('.answer-template');
                    if (oeqContainer) {
                        oeqContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Adding Questions to Worksheet ",
                content: "You can add questions to your worksheet for practice: 1) Find a question you want to practice, 2) Click the ' Add to Worksheet' button on the question, 3) The question will be saved to your worksheet. You can add multiple questions and practice them all together.",
                highlight: ".btn-worksheet-add",
                action: () => {
                    const addBtn = document.querySelector('.btn-worksheet-add');
                    if (addBtn) {
                        addBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "My Worksheet ",
                content: "Your worksheet is where you collect questions to practice. Click ' My Worksheet' in the sidebar to view all your added questions. You can: print your worksheet, save it, or remove questions. The badge shows how many questions you have.",
                highlight: "#btn-sidebar-worksheet",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-worksheet');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "My Progress ",
                content: "Track your learning progress! Click ' My Progress' to see: your overall success rate, topic mastery percentages, questions that need more practice, and your rating. This helps you identify areas to focus on.",
                highlight: "#btn-sidebar-my-progress",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-my-progress');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Leaderboard ",
                content: "See how you rank among other students! The leaderboard shows: student rankings by rating, improvement scores, total attempts, and top performers. Admins can click on student names to view their detailed progress.",
                highlight: "#btn-sidebar-leaderboard",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-leaderboard');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Question Library ",
                content: "Browse all available questions in the Question Library! Features include: sortable columns (click headers to sort), filters by topic and level, search functionality, checkboxes to select multiple questions, and 'Add to Worksheet' button for bulk adding.",
                highlight: "#btn-sidebar-question-list",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-question-list');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Saved Worksheets ",
                content: "Access your previously saved worksheets! Click ' Saved Worksheets' to view all your saved practice sets. You can reload them, share them, or delete old ones. This is great for revisiting past practice sessions.",
                highlight: "#btn-sidebar-saved-worksheets",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-saved-worksheets');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Lessons ",
                content: "Learn from video lessons! Click ' Lessons' to access educational videos with practice questions. Each lesson includes: a video explanation, related practice questions, and progress tracking. Complete lessons to improve your understanding.",
                highlight: "#btn-sidebar-lessons",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-lessons');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Rating System ",
                content: "Your performance affects your rating! The app uses an Elo-style rating system: answering correctly increases your rating, answering incorrectly decreases it, questions are matched to your skill level, and your rating helps track improvement over time.",
                highlight: null,
                action: null
            },
            {
                title: "Topic Navigation ",
                content: "Navigate between different topics easily! Use the topic buttons in the sidebar to jump to specific topics. Topics are organized by level (P3-P6) and subject area. Click any topic to see all related questions.",
                highlight: ".sidebar-nav",
                action: null
            },
            {
                title: "Level Selection ",
                content: "Choose your difficulty level! Use the level selector in the header to filter questions by Primary level (P3, P4, P5, or P6). This helps you practice at the right difficulty for your grade level.",
                highlight: "#header-level-select",
                action: () => {
                    const select = document.getElementById('header-level-select');
                    if (select) {
                        select.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Mode Toggle ",
                content: "Switch between question types! Use the toggle in the header to switch between OEQ (Open-Ended Questions) and MCQ (Multiple Choice Questions) modes. Each mode has different question types and answering methods.",
                highlight: "#mode-toggle",
                action: () => {
                    const toggle = document.getElementById('mode-toggle');
                    if (toggle) {
                        toggle.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            {
                title: "Printing Worksheets ",
                content: "Print your worksheets for offline practice! In your worksheet view, click the 'Print' button to generate a printable version. This is perfect for practicing without a device or sharing with teachers.",
                highlight: null,
                action: null
            },
            {
                title: "Question Filtering & Search ",
                content: "Find questions quickly! In the Question Library, you can: filter by topic using the dropdown, filter by level (P3-P6), search by typing keywords in the search box, and sort by clicking column headers. This makes it easy to find exactly what you need!",
                highlight: null,
                action: null
            },
            {
                title: "Progress Tracking ",
                content: "Monitor your learning journey! The progress page shows: which topics you've mastered, which questions need more practice, your overall success rate, and improvement over time. Use this to focus your study efforts!",
                highlight: null,
                action: null
            },
            {
                title: "Tutorial Complete! ",
                content: "Congratulations! You've learned about all the main features. Remember: you can always click the ' Tutorial' button in the sidebar to review this tutorial again. Happy learning and good luck with your studies!",
                highlight: "#btn-sidebar-tutorial",
                action: () => {
                    const btn = document.getElementById('btn-sidebar-tutorial');
                    if (btn) {
                        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
        ];

        // Initialize tutorial
        window.tutorialState.steps = tutorialSteps;

        // Start tutorial - shows all functions
        window.startTutorial = function() {
            window.tutorialState.steps = tutorialSteps;
            window.tutorialState.currentStep = 0;
            showTutorialStep(0);
        };

        // Show tutorial step
        function showTutorialStep(stepIndex) {
            const tutorialStepsList = window.tutorialState.steps || tutorialSteps;
            if (stepIndex < 0 || stepIndex >= tutorialStepsList.length) return;

            const step = tutorialStepsList[stepIndex];
            window.tutorialState.currentStep = stepIndex;

            // Remove existing tutorial overlay
            const existing = document.getElementById('tutorial-overlay');
            if (existing) existing.remove();

            // Create tutorial container (no backdrop, positioned top right)
            const overlay = document.createElement('div');
            overlay.id = 'tutorial-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 100000;
                max-width: 400px;
                width: calc(100% - 40px);
                pointer-events: none;
            `;

            // Create tutorial box
            const tutorialBox = document.createElement('div');
            tutorialBox.style.cssText = `
                background: rgba(255, 255, 255, 0.85);
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                border-radius: 16px;
                padding: 1.5rem;
                width: 100%;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.3) inset;
                position: relative;
                pointer-events: all;
                border: 1px solid rgba(255, 255, 255, 0.5);
                font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif;
            `;
            tutorialBox.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0; color: #000000; font-size: 1.2rem; font-weight: 600; font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif;">${step.title}</h2>
                    <button onclick="closeTutorial()" style="background: rgba(0, 0, 0, 0.1); border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 1rem; color: #000000; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif;" onmouseover="this.style.background='rgba(0, 0, 0, 0.2)'" onmouseout="this.style.background='rgba(0, 0, 0, 0.1)'"></button>
                </div>
                <div style="font-size: 0.9rem; line-height: 1.6; color: #000000; margin-bottom: 1.5rem; max-height: 200px; overflow-y: auto; font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif;">
                    ${step.content}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 0.8rem; color: #000000; font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif;">
                        Step ${stepIndex + 1} of ${tutorialStepsList.length}
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="previousTutorialStep()" 
                                style="padding: 0.5rem 1rem; background: rgba(0, 0, 0, 0.1); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #000000; font-size: 0.85rem; transition: all 0.2s; font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif; ${stepIndex === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
                                ${stepIndex === 0 ? 'disabled' : ''}
                                onmouseover="if(!this.disabled) this.style.background='rgba(0, 0, 0, 0.2)'"
                                onmouseout="if(!this.disabled) this.style.background='rgba(0, 0, 0, 0.1)'">
                            
                        </button>
                        <button onclick="nextTutorialStep()" 
                                style="padding: 0.5rem 1rem; background: rgba(0, 0, 0, 0.8); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #ffffff; font-size: 0.85rem; transition: all 0.2s; font-family: 'Century Gothic', 'CenturyGothic', 'AppleGothic', sans-serif;"
                                onmouseover="this.style.background='rgba(0, 0, 0, 0.95)'"
                                onmouseout="this.style.background='rgba(0, 0, 0, 0.8)'">
                            ${stepIndex === tutorialStepsList.length - 1 ? 'Done' : ''}
                        </button>
                    </div>
                </div>
            `;

            overlay.appendChild(tutorialBox);
            document.body.appendChild(overlay);

            // Highlight element if specified
            if (step.highlight) {
                setTimeout(() => {
                    highlightElement(step.highlight);
                }, 100);
            }

            // Execute action if specified
            if (step.action) {
                setTimeout(() => {
                    step.action();
                }, 300);
            }
        }

        // Highlight an element
        function highlightElement(selector) {
            // Remove existing highlights
            document.querySelectorAll('.tutorial-highlight').forEach(el => {
                el.style.outline = '';
                el.style.outlineOffset = '';
                el.classList.remove('tutorial-highlight');
            });

            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
                el.classList.add('tutorial-highlight');
                el.style.outline = '4px solid #667eea';
                el.style.outlineOffset = '4px';
                el.style.transition = 'outline 0.3s ease';
                el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
            });
        }

        // Navigate to next step
        window.nextTutorialStep = function() {
            const tutorialStepsList = window.tutorialState.steps || tutorialSteps;
            const nextStep = window.tutorialState.currentStep + 1;
            if (nextStep < tutorialStepsList.length) {
                showTutorialStep(nextStep);
            } else {
                closeTutorial();
            }
        };

        // Navigate to previous step
        window.previousTutorialStep = function() {
            const prevStep = window.tutorialState.currentStep - 1;
            if (prevStep >= 0) {
                showTutorialStep(prevStep);
            }
        };

        // Close tutorial
        window.closeTutorial = function() {
            const overlay = document.getElementById('tutorial-overlay');
            if (overlay) overlay.remove();
            
            // Remove highlights
            document.querySelectorAll('.tutorial-highlight').forEach(el => {
                el.style.outline = '';
                el.style.outlineOffset = '';
                el.classList.remove('tutorial-highlight');
            });
        };

        // Add CSS for tutorial highlight
        const tutorialStyle = document.createElement('style');
        tutorialStyle.textContent = `
            .tutorial-highlight {
                position: relative;
                z-index: 100001 !important;
            }
            #tutorial-overlay button:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }
            #tutorial-overlay button:active {
                transform: translateY(0);
            }
        `;
        document.head.appendChild(tutorialStyle);

        // =====================================================
        // TOOLTIP SYSTEM
        // =====================================================

        // Tooltip descriptions for buttons
        const tooltipDescriptions = {
            'header-tutorial-btn': 'Click to view a comprehensive tutorial covering all features of the app',
            'header-inbox-btn': 'View messages and notifications from teachers',
            'header-flagged-btn': 'View questions that have been flagged for review (Admin only)',
            'header-settings-btn': 'Access account settings and preferences',
            'print-btn': 'Print the current page or worksheet',
            'btn-sidebar-practice': 'Enter practice mode to work through questions at your own pace',
            'mode-toggle': 'Switch between OEQ (Open-Ended Questions) and MCQ (Multiple Choice Questions) modes',
            'exam-mode-toggle': 'Toggle exam mode for a distraction-free testing environment',
            'btn-sidebar-admin': 'Access admin panel to manage questions and view student data (Admin only)',
            'btn-sidebar-progress': 'View detailed progress for all students (Admin only)',
            'btn-sidebar-leaderboard': 'See rankings and compare your performance with other students',
            'btn-sidebar-my-progress': 'Track your learning progress, mastery percentages, and improvement over time',
            'btn-sidebar-worksheet': 'View and manage your collection of practice questions',
            'btn-sidebar-saved-worksheets': 'Access previously saved worksheets for review',
            'btn-sidebar-lessons': 'Browse video lessons with practice questions',
            'btn-sidebar-question-list': 'Browse and search all available questions in the library',
            'logout-btn': 'Sign out of your account',
            'practice': 'Practice mode - work through questions at your own pace',
            'worksheet': 'My Worksheet - view and manage your practice questions',
            'saved-worksheets': 'Access your previously saved worksheets',
            'question-list': 'Question Library - browse and search all available questions',
            'my-progress': 'View your learning progress and mastery statistics',
            'leaderboard': 'See how you rank among other students',
            'lessons': 'Watch video lessons and complete practice questions'
        };

        // Initialize tooltips
        window.initTooltips = function() {
            // Add tooltips to all buttons with data-tooltip or matching IDs
            document.querySelectorAll('button, .nav-group-btn, .nav-dropdown-item, .tab-btn').forEach(button => {
                const id = button.id;
                const text = button.textContent.trim();
                const onclick = button.getAttribute('onclick');
                
                // Get tooltip text
                let tooltipText = tooltipDescriptions[id];
                
                // Check for navigation items
                if (!tooltipText && onclick) {
                    if (onclick.includes("switchTab('practice'")) tooltipText = tooltipDescriptions['practice'];
                    else if (onclick.includes("switchTab('worksheet'")) tooltipText = tooltipDescriptions['worksheet'];
                    else if (onclick.includes("switchTab('saved-worksheets'")) tooltipText = tooltipDescriptions['saved-worksheets'];
                    else if (onclick.includes("switchTab('question-list'")) tooltipText = tooltipDescriptions['question-list'];
                    else if (onclick.includes("switchTab('my-progress'")) tooltipText = tooltipDescriptions['my-progress'];
                    else if (onclick.includes("switchTab('leaderboard'")) tooltipText = tooltipDescriptions['leaderboard'];
                    else if (onclick.includes("switchTab('lessons'")) tooltipText = tooltipDescriptions['lessons'];
                }
                
                // Check for mode toggle
                if (!tooltipText && (id === 'mode-toggle' || onclick?.includes('toggleMode'))) {
                    tooltipText = tooltipDescriptions['mode-toggle'];
                }
                
                // Check for exam mode toggle
                if (!tooltipText && (id === 'exam-mode-toggle' || onclick?.includes('toggleExamMode'))) {
                    tooltipText = tooltipDescriptions['exam-mode-toggle'];
                }
                
                if (tooltipText) {
                    button.setAttribute('data-tooltip', tooltipText);
                    button.classList.add('tooltip-container');
                }
            });
        }

        // Show tooltip
        function showTooltip(element, text) {
            // Remove existing tooltip
            const existing = document.querySelector('.tooltip');
            if (existing) {
                existing.remove();
            }

            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = text;
            tooltip.style.position = 'fixed';
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '0';

            document.body.appendChild(tooltip);

            // Get dimensions after adding to DOM
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            // Check if element is in sidebar (left side of screen, less than 350px from left)
            const isInSidebar = rect.left < 350;

            let position = 'top';
            let top, left;

            // For sidebar elements, prefer right positioning
            if (isInSidebar && rect.right + tooltipRect.width + 20 < viewportWidth) {
                position = 'right';
                left = rect.right + 12;
                top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
            }
            // If not enough space on top, try bottom
            else if (rect.top < tooltipRect.height + 20) {
                position = 'bottom';
                left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                top = rect.bottom + 12;
            }
            // If tooltip would overflow right edge, use left positioning
            else if (rect.left + (rect.width / 2) + (tooltipRect.width / 2) > viewportWidth - 20) {
                position = 'left';
                left = rect.left - tooltipRect.width - 12;
                top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
            }
            // Default: top position
            else {
                position = 'top';
                left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                top = rect.top - tooltipRect.height - 12;
            }

            // Ensure tooltip doesn't overflow viewport edges
            if (left < 10) left = 10;
            if (left + tooltipRect.width > viewportWidth - 10) {
                left = viewportWidth - tooltipRect.width - 10;
            }
            if (top < 10) top = 10;
            if (top + tooltipRect.height > viewportHeight - 10) {
                top = viewportHeight - tooltipRect.height - 10;
            }

            // Apply position
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.style.transform = 'none'; // Reset any CSS transforms

            // Add position class for arrow
            tooltip.classList.add('tooltip-' + position);

            // Position the arrow based on element position relative to tooltip
            if (position === 'right') {
                const arrowTop = rect.top + (rect.height / 2) - top;
                tooltip.style.setProperty('--arrow-top', arrowTop + 'px');
            } else if (position === 'left') {
                const arrowTop = rect.top + (rect.height / 2) - top;
                tooltip.style.setProperty('--arrow-top', arrowTop + 'px');
            } else if (position === 'top' || position === 'bottom') {
                const arrowLeft = rect.left + (rect.width / 2) - left;
                tooltip.style.setProperty('--arrow-left', arrowLeft + 'px');
            }

            tooltip.style.visibility = 'visible';

            // Show with animation after a brief delay
            setTimeout(() => {
                tooltip.classList.add('show');
            }, 50);
        }

        // Hide tooltip
        function hideTooltip() {
            const tooltip = document.querySelector('.tooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
                setTimeout(() => {
                    tooltip.remove();
                }, 200);
            }
        }

        // Add tooltip event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initTooltips();
            
            let tooltipTimeout;
            
            document.addEventListener('mouseenter', (e) => {
                const element = e.target.closest('[data-tooltip]');
                if (element) {
                    const text = element.getAttribute('data-tooltip');
                    if (text) {
                        // 1 second delay before showing tooltip
                        tooltipTimeout = setTimeout(() => {
                            showTooltip(element, text);
                        }, 1000);
                    }
                }
            }, true);
            
            document.addEventListener('mouseleave', (e) => {
                const element = e.target.closest('[data-tooltip]');
                if (element) {
                    clearTimeout(tooltipTimeout);
                    hideTooltip();
                }
            }, true);
        });

        // Re-initialize tooltips after dynamic content loads
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(...args) {
            const result = originalSwitchTab.apply(this, args);
            setTimeout(() => {
                initTooltips();
            }, 100);
            return result;
        };
    </script>

    <!-- =====================================================
         GAMIFICATION SYSTEM
         ===================================================== -->
    <script>
        // =====================================================
        // GAMIFICATION CONFIGURATION
        // =====================================================
        window.GAMIFICATION_CONFIG = {
            XP_PER_CORRECT: 15,
            XP_PER_INCORRECT: 3,
            XP_PER_ATTEMPT: 5,
            XP_DAILY_CHALLENGE_BONUS: 50,
            XP_WELCOME_BONUS: 25,
            XP_STREAK_MULTIPLIER: 0.1,
            MAX_STREAK_BONUS: 0.5,
            LEVELS: [
                { level: 1, xpRequired: 0, title: 'Beginner', color: '#9E9E9E' },
                { level: 2, xpRequired: 100, title: 'Learner', color: '#8BC34A' },
                { level: 3, xpRequired: 250, title: 'Explorer', color: '#4CAF50' },
                { level: 4, xpRequired: 500, title: 'Scientist', color: '#2196F3' },
                { level: 5, xpRequired: 850, title: 'Researcher', color: '#3F51B5' },
                { level: 6, xpRequired: 1300, title: 'Expert', color: '#9C27B0' },
                { level: 7, xpRequired: 1900, title: 'Master', color: '#E91E63' },
                { level: 8, xpRequired: 2700, title: 'Professor', color: '#FF5722' },
                { level: 9, xpRequired: 3800, title: 'Genius', color: '#FF9800' },
                { level: 10, xpRequired: 5200, title: 'Legend', color: '#FFD700' }
            ],
            ACHIEVEMENTS: [
                { id: 'first_steps', name: 'First Steps', desc: 'Answer your first question', icon: '', xp: 10, condition: (s) => s.totalAttempts >= 1 },
                { id: 'getting_started', name: 'Getting Started', desc: 'Answer 10 questions', icon: '', xp: 25, condition: (s) => s.totalAttempts >= 10 },
                { id: 'on_a_roll', name: 'On a Roll', desc: 'Get 5 correct in a row', icon: '', xp: 30, condition: (s) => s.maxStreak >= 5 },
                { id: 'streak_master', name: 'Streak Master', desc: 'Maintain a 7-day login streak', icon: '', xp: 50, condition: (s) => s.loginStreak >= 7 },
                { id: 'dedicated', name: 'Dedicated Learner', desc: 'Answer 50 questions', icon: '', xp: 50, condition: (s) => s.totalAttempts >= 50 },
                { id: 'perfectionist', name: 'Perfectionist', desc: 'Get 10 correct in a row', icon: '', xp: 75, condition: (s) => s.maxStreak >= 10 },
                { id: 'century', name: 'Century', desc: 'Answer 100 questions', icon: '', xp: 100, condition: (s) => s.totalAttempts >= 100 },
                { id: 'daily_warrior', name: 'Daily Warrior', desc: 'Complete 5 daily challenges', icon: '', xp: 75, condition: (s) => s.dailyChallengesCompleted >= 5 },
                { id: 'topic_master', name: 'Topic Master', desc: 'Achieve 80% mastery in any topic', icon: '', xp: 60, condition: (s) => s.hasTopicMastery },
                { id: 'speed_demon', name: 'Speed Demon', desc: 'Answer 20 questions in one session', icon: '', xp: 40, condition: (s) => s.sessionAttempts >= 20 },
                { id: 'science_pro', name: 'Science Pro', desc: 'Reach level 5', icon: '', xp: 100, condition: (s) => s.level >= 5 },
                { id: 'legendary', name: 'Legendary', desc: 'Reach level 10', icon: '', xp: 200, condition: (s) => s.level >= 10 }
            ],
            DAILY_CHALLENGES: [
                { id: 'correct_5', task: 'Answer 5 questions correctly', target: 5, type: 'correct', reward: 50 },
                { id: 'correct_10', task: 'Answer 10 questions correctly', target: 10, type: 'correct', reward: 80 },
                { id: 'attempt_15', task: 'Attempt 15 questions', target: 15, type: 'attempts', reward: 60 },
                { id: 'streak_3', task: 'Get 3 correct answers in a row', target: 3, type: 'streak', reward: 40 },
                { id: 'topics_3', task: 'Practice 3 different topics', target: 3, type: 'topics', reward: 70 },
                { id: 'mcq_5', task: 'Answer 5 MCQ questions correctly', target: 5, type: 'mcq_correct', reward: 45 },
                { id: 'oeq_3', task: 'Answer 3 OEQ questions correctly', target: 3, type: 'oeq_correct', reward: 55 }
            ]
        };

        // Gamification State
        window.gamificationState = {
            xp: 0, level: 1, totalAttempts: 0, correctCount: 0, currentStreak: 0, maxStreak: 0,
            loginStreak: 0, sessionAttempts: 0, dailyChallengesCompleted: 0, hasTopicMastery: false,
            unlockedAchievements: [], soundEnabled: true, dailyChallenge: null, dailyChallengeProgress: 0,
            lastDailyChallengeDate: null, topicsPracticedToday: new Set()
        };

        // XP and Level Calculations
        window.calculateLevel = function(xp) {
            const levels = window.GAMIFICATION_CONFIG.LEVELS;
            for (let i = levels.length - 1; i >= 0; i--) {
                if (xp >= levels[i].xpRequired) return levels[i];
            }
            return levels[0];
        };

        window.getXPForNextLevel = function(currentLevel) {
            const levels = window.GAMIFICATION_CONFIG.LEVELS;
            const nextLevel = levels.find(l => l.level === currentLevel + 1);
            return nextLevel ? nextLevel.xpRequired : null;
        };

        window.updateXPDisplay = function() {
            const state = window.gamificationState;
            const currentLevelInfo = calculateLevel(state.xp);
            const nextLevelXP = getXPForNextLevel(currentLevelInfo.level);
            const prevLevelXP = currentLevelInfo.xpRequired;

            const levelBadge = document.getElementById('xp-level-badge');
            const levelTitle = document.getElementById('xp-level-title');
            const xpPoints = document.getElementById('xp-points-display');
            const xpBar = document.getElementById('xp-bar-inner');

            if (levelBadge) levelBadge.textContent = `Lv ${currentLevelInfo.level}`;
            if (levelTitle) levelTitle.textContent = currentLevelInfo.title;

            if (nextLevelXP) {
                const xpInCurrentLevel = state.xp - prevLevelXP;
                const xpNeededForLevel = nextLevelXP - prevLevelXP;
                const progressPercent = (xpInCurrentLevel / xpNeededForLevel) * 100;
                if (xpPoints) xpPoints.textContent = `${state.xp} / ${nextLevelXP} XP`;
                if (xpBar) xpBar.style.width = `${Math.min(progressPercent, 100)}%`;
            } else {
                if (xpPoints) xpPoints.textContent = `${state.xp} XP (MAX)`;
                if (xpBar) xpBar.style.width = '100%';
            }

            const achievementsTotalXP = document.getElementById('achievements-total-xp');
            if (achievementsTotalXP) achievementsTotalXP.textContent = `${state.xp} XP`;
        };

        window.addXP = function(amount, reason, sourceElement) {
            const state = window.gamificationState;
            const oldLevel = calculateLevel(state.xp).level;

            let bonusMultiplier = 1;
            if (state.loginStreak >= 3) {
                const streakBonus = Math.min(state.loginStreak * window.GAMIFICATION_CONFIG.XP_STREAK_MULTIPLIER, window.GAMIFICATION_CONFIG.MAX_STREAK_BONUS);
                bonusMultiplier = 1 + streakBonus;
            }

            const finalAmount = Math.round(amount * bonusMultiplier);
            state.xp += finalAmount;

            showXPPopup(finalAmount, sourceElement);

            const newLevel = calculateLevel(state.xp).level;
            if (newLevel > oldLevel) showLevelUpModal(newLevel);

            updateXPDisplay();
            saveGamificationState();
            checkAchievements();
            return finalAmount;
        };

        window.showXPPopup = function(amount, sourceElement) {
            const popup = document.createElement('div');
            popup.className = 'xp-popup';
            popup.textContent = `+${amount} XP`;

            if (sourceElement) {
                const rect = sourceElement.getBoundingClientRect();
                popup.style.left = `${rect.left + rect.width / 2}px`;
                popup.style.top = `${rect.top}px`;
            } else {
                popup.style.left = '50%';
                popup.style.top = '40%';
                popup.style.transform = 'translateX(-50%)';
            }
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1500);
        };

        window.showLevelUpModal = function(newLevel) {
            const levelInfo = window.GAMIFICATION_CONFIG.LEVELS.find(l => l.level === newLevel);
            const modal = document.createElement('div');
            modal.className = 'level-up-modal';
            modal.innerHTML = `<h2> Level Up!</h2><div class="new-level">${newLevel}</div><div class="level-title">${levelInfo.title}</div><button class="level-up-close-btn" onclick="this.parentElement.remove()">Awesome!</button>`;
            document.body.appendChild(modal);
            triggerCelebration();
            if (window.gamificationState.soundEnabled) playLevelUpSound();
            setTimeout(() => { if (modal.parentElement) modal.remove(); }, 5000);
        };

        // Celebration Effects
        window.triggerCelebration = function() {
            const overlay = document.getElementById('celebration-overlay');
            if (!overlay) return;
            overlay.style.display = 'block';
            overlay.innerHTML = '';
            const colors = ['#FFD700', '#FF6B6B', '#4CAF50', '#2196F3', '#9C27B0', '#FF9800'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = confetti.style.width;
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.animation = `confettiFall ${Math.random() * 2 + 1.5}s ease-out forwards`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                overlay.appendChild(confetti);
            }
            setTimeout(() => { overlay.style.display = 'none'; overlay.innerHTML = ''; }, 3500);
        };

        window.triggerCorrectAnswerCelebration = function(element) {
            if (!element) return;
            const rect = element.getBoundingClientRect();
            const stars = ['', '', '', ''];
            for (let i = 0; i < 5; i++) {
                const star = document.createElement('div');
                star.textContent = stars[Math.floor(Math.random() * stars.length)];
                star.style.cssText = `position:fixed;left:${rect.left + Math.random() * rect.width}px;top:${rect.top + Math.random() * rect.height}px;font-size:1.5rem;pointer-events:none;z-index:10000;animation:xpFloat 1s ease-out forwards;animation-delay:${i * 0.1}s`;
                document.body.appendChild(star);
                setTimeout(() => star.remove(), 1100 + i * 100);
            }
        };

        // Sound Effects
        window.playCorrectSound = function() {
            if (!window.gamificationState.soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 523.25;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) { }
        };

        window.playLevelUpSound = function() {
            if (!window.gamificationState.soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const notes = [523.25, 659.25, 783.99];
                notes.forEach((freq, i) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.15);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.15 + 0.4);
                    oscillator.start(audioContext.currentTime + i * 0.15);
                    oscillator.stop(audioContext.currentTime + i * 0.15 + 0.4);
                });
            } catch (e) { }
        };

        // Achievements System
        window.checkAchievements = function() {
            const state = window.gamificationState;
            state.level = calculateLevel(state.xp).level;
            window.GAMIFICATION_CONFIG.ACHIEVEMENTS.forEach(achievement => {
                if (!state.unlockedAchievements.includes(achievement.id) && achievement.condition(state)) {
                    unlockAchievement(achievement);
                }
            });
            updateAchievementsCount();
        };

        window.unlockAchievement = function(achievement) {
            const state = window.gamificationState;
            state.unlockedAchievements.push(achievement.id);
            showAchievementUnlocked(achievement);
            addXP(achievement.xp, `Achievement: ${achievement.name}`);
            saveGamificationState();
        };

        window.showAchievementUnlocked = function(achievement) {
            const notification = document.createElement('div');
            notification.style.cssText = 'position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#FFD700,#FFA500);color:#333;padding:16px 24px;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.3);z-index:10003;animation:slideUp 0.5s ease forwards;display:flex;align-items:center;gap:12px';
            notification.innerHTML = `<span style="font-size:2rem;">${achievement.icon}</span><div><div style="font-weight:700;font-size:1rem;">Achievement Unlocked!</div><div style="font-size:0.9rem;">${achievement.name}</div><div style="font-size:0.8rem;opacity:0.8;">+${achievement.xp} XP</div></div>`;
            document.body.appendChild(notification);
            setTimeout(() => { notification.style.animation = 'fadeIn 0.3s ease reverse forwards'; setTimeout(() => notification.remove(), 300); }, 4000);
        };

        window.updateAchievementsCount = function() {
            const state = window.gamificationState;
            const total = window.GAMIFICATION_CONFIG.ACHIEVEMENTS.length;
            const unlocked = state.unlockedAchievements.length;
            const countEl = document.getElementById('achievements-unlocked-count');
            if (countEl) countEl.textContent = `(${unlocked}/${total})`;
        };

        window.showAchievementsModal = function() {
            const modal = document.getElementById('achievements-modal');
            const grid = document.getElementById('achievements-grid');
            if (!modal || !grid) return;
            const state = window.gamificationState;
            grid.innerHTML = window.GAMIFICATION_CONFIG.ACHIEVEMENTS.map(a => {
                const isUnlocked = state.unlockedAchievements.includes(a.id);
                return `<div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}"><div class="achievement-icon">${a.icon}</div><div class="achievement-name">${a.name}</div><div class="achievement-desc">${a.desc}</div><div class="achievement-xp">${isUnlocked ? ' Earned' : `+${a.xp} XP`}</div></div>`;
            }).join('');
            modal.classList.add('visible');
        };

        window.hideAchievementsModal = function() {
            const modal = document.getElementById('achievements-modal');
            if (modal) modal.classList.remove('visible');
        };

        // Daily Challenges
        window.initDailyChallenge = function() {
            const state = window.gamificationState;
            const today = new Date().toDateString();
            if (state.lastDailyChallengeDate !== today) {
                const challenges = window.GAMIFICATION_CONFIG.DAILY_CHALLENGES;
                const randomIndex = Math.floor(Math.random() * challenges.length);
                state.dailyChallenge = { ...challenges[randomIndex] };
                state.dailyChallengeProgress = 0;
                state.lastDailyChallengeDate = today;
                state.topicsPracticedToday = new Set();
                saveGamificationState();
            }
            updateDailyChallengeDisplay();
            startDailyChallengeTimer();
        };

        window.updateDailyChallengeDisplay = function() {
            const state = window.gamificationState;
            const challenge = state.dailyChallenge;
            if (!challenge) return;

            const taskEl = document.getElementById('daily-challenge-task');
            const progressBar = document.getElementById('daily-challenge-progress-bar');
            const rewardEl = document.getElementById('daily-challenge-reward-xp');

            if (taskEl) taskEl.textContent = challenge.task;
            if (rewardEl) rewardEl.textContent = `+${challenge.reward} XP`;

            const progress = Math.min((state.dailyChallengeProgress / challenge.target) * 100, 100);
            if (progressBar) progressBar.style.width = `${progress}%`;

            const modalTask = document.getElementById('dc-modal-task');
            const modalProgress = document.getElementById('dc-modal-progress');
            const modalReward = document.getElementById('dc-modal-reward');
            const modalProgressBar = document.getElementById('dc-modal-progress-bar');

            if (modalTask) modalTask.textContent = challenge.task;
            if (modalProgress) modalProgress.textContent = `${state.dailyChallengeProgress}/${challenge.target}`;
            if (modalReward) modalReward.textContent = `+${challenge.reward} XP`;
            if (modalProgressBar) modalProgressBar.style.width = `${progress}%`;

            if (state.dailyChallengeProgress >= challenge.target && !challenge.completed) completeDailyChallenge();
        };

        window.startDailyChallengeTimer = function() {
            const updateTimer = () => {
                const now = new Date();
                const midnight = new Date();
                midnight.setHours(24, 0, 0, 0);
                const diff = midnight - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((diff % (1000 * 60)) / 1000);
                const timeString = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                const timerEl = document.getElementById('daily-challenge-timer');
                const modalTimerEl = document.getElementById('dc-modal-timer');
                if (timerEl) timerEl.textContent = timeString;
                if (modalTimerEl) modalTimerEl.textContent = `Resets in: ${timeString}`;
            };
            updateTimer();
            setInterval(updateTimer, 1000);
        };

        window.updateDailyChallengeProgress = function(type, amount = 1) {
            const state = window.gamificationState;
            const challenge = state.dailyChallenge;
            if (!challenge || challenge.completed) return;
            if (challenge.type === type) {
                state.dailyChallengeProgress += amount;
                updateDailyChallengeDisplay();
                saveGamificationState();
            }
        };

        window.completeDailyChallenge = function() {
            const state = window.gamificationState;
            const challenge = state.dailyChallenge;
            if (!challenge || challenge.completed) return;
            challenge.completed = true;
            state.dailyChallengesCompleted++;
            addXP(challenge.reward, 'Daily Challenge Complete');
            triggerCelebration();
            if (window.showToast) showToast(' Daily Challenge Complete! +' + challenge.reward + ' XP', 'success');
            saveGamificationState();
            checkAchievements();
        };

        window.showDailyChallengeDetails = function() {
            const modal = document.getElementById('daily-challenge-modal');
            if (modal) modal.classList.add('visible');
        };

        window.hideDailyChallengeModal = function() {
            const modal = document.getElementById('daily-challenge-modal');
            if (modal) modal.classList.remove('visible');
        };

        // Streak Bonus
        window.updateStreakBonusDisplay = function() {
            const state = window.gamificationState;
            const streakCard = document.getElementById('streak-bonus-card');
            const streakCount = document.getElementById('streak-bonus-count');
            const streakMultiplier = document.getElementById('streak-bonus-multiplier');
            if (state.loginStreak >= 3 && streakCard) {
                streakCard.style.display = 'block';
                if (streakCount) streakCount.textContent = state.loginStreak;
                const bonus = Math.min(Math.round(state.loginStreak * window.GAMIFICATION_CONFIG.XP_STREAK_MULTIPLIER * 100), Math.round(window.GAMIFICATION_CONFIG.MAX_STREAK_BONUS * 100));
                if (streakMultiplier) streakMultiplier.textContent = `+${bonus}% XP Bonus`;
            } else if (streakCard) {
                streakCard.style.display = 'none';
            }
        };

        // Quick Start Wizard
        window.quickstartCurrentStep = 1;
        window.quickstartTotalSteps = 5;

        window.showQuickstartWizard = function() {
            const wizard = document.getElementById('quickstart-wizard');
            if (wizard) { wizard.style.display = 'flex'; window.quickstartCurrentStep = 1; updateQuickstartUI(); }
        };

        window.hideQuickstartWizard = function() {
            const wizard = document.getElementById('quickstart-wizard');
            if (wizard) wizard.style.display = 'none';
            localStorage.setItem('quickstartCompleted', 'true');
            addXP(window.GAMIFICATION_CONFIG.XP_WELCOME_BONUS, 'Welcome Bonus');
        };

        window.quickstartNextStep = function() {
            if (window.quickstartCurrentStep < window.quickstartTotalSteps) { window.quickstartCurrentStep++; updateQuickstartUI(); }
            else hideQuickstartWizard();
        };

        window.quickstartPrevStep = function() {
            if (window.quickstartCurrentStep > 1) { window.quickstartCurrentStep--; updateQuickstartUI(); }
        };

        window.updateQuickstartUI = function() {
            const steps = document.querySelectorAll('.quickstart-step');
            const dots = document.querySelectorAll('.quickstart-dot');
            const prevBtn = document.getElementById('quickstart-prev-btn');
            const nextBtn = document.getElementById('quickstart-next-btn');
            steps.forEach((step, i) => step.classList.toggle('active', i + 1 === window.quickstartCurrentStep));
            dots.forEach((dot, i) => dot.classList.toggle('active', i + 1 === window.quickstartCurrentStep));
            if (prevBtn) prevBtn.disabled = window.quickstartCurrentStep === 1;
            if (nextBtn) nextBtn.textContent = window.quickstartCurrentStep === window.quickstartTotalSteps ? "Let's Go! " : 'Next ';
        };

        // Gamification Integration
        window.handleQuestionAnswer = function(isCorrect, questionElement, questionType) {
            const state = window.gamificationState;
            state.totalAttempts++;
            state.sessionAttempts++;

            if (isCorrect) {
                state.correctCount++;
                state.currentStreak++;
                state.maxStreak = Math.max(state.maxStreak, state.currentStreak);
                addXP(window.GAMIFICATION_CONFIG.XP_PER_CORRECT, 'Correct Answer', questionElement);
                playCorrectSound();
                triggerCorrectAnswerCelebration(questionElement);
                updateDailyChallengeProgress('correct');
                updateDailyChallengeProgress('streak', state.currentStreak);
                if (questionType === 'mcq') updateDailyChallengeProgress('mcq_correct');
                else updateDailyChallengeProgress('oeq_correct');
            } else {
                state.currentStreak = 0;
                addXP(window.GAMIFICATION_CONFIG.XP_PER_INCORRECT, 'Attempted', questionElement);
            }

            updateDailyChallengeProgress('attempts');

            if (questionElement) {
                const topic = questionElement.closest('[id^="topic-"]');
                if (topic) {
                    state.topicsPracticedToday.add(topic.id);
                    updateDailyChallengeProgress('topics', state.topicsPracticedToday.size);
                }
            }

            saveGamificationState();
            checkAchievements();
            updateXPDisplay();
        };

        // Save/Load State
        window.saveGamificationState = async function() {
            const state = window.gamificationState;
            localStorage.setItem('gamificationState', JSON.stringify({ ...state, topicsPracticedToday: Array.from(state.topicsPracticedToday) }));
            try {
                const user = window.auth?.currentUser;
                if (user && window.db_fs) {
                    const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                    await updateDoc(doc(window.db_fs, "users", user.uid), {
                        gamification: { xp: state.xp, level: calculateLevel(state.xp).level, unlockedAchievements: state.unlockedAchievements, dailyChallengesCompleted: state.dailyChallengesCompleted, maxStreak: state.maxStreak, lastDailyChallengeDate: state.lastDailyChallengeDate, dailyChallenge: state.dailyChallenge, dailyChallengeProgress: state.dailyChallengeProgress }
                    });
                }
            } catch (e) { console.log('Gamification save failed:', e); }
        };

        window.loadGamificationState = async function() {
            const stored = localStorage.getItem('gamificationState');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    Object.assign(window.gamificationState, parsed);
                    if (parsed.topicsPracticedToday) window.gamificationState.topicsPracticedToday = new Set(parsed.topicsPracticedToday);
                } catch (e) { }
            }
            try {
                const user = window.auth?.currentUser;
                if (user && window.db_fs) {
                    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                    const userDoc = await getDoc(doc(window.db_fs, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        const gam = data.gamification || {};
                        const students = data.students || [];
                        const currentStudent = students[0] || {};
                        window.gamificationState.xp = gam.xp || 0;
                        window.gamificationState.unlockedAchievements = gam.unlockedAchievements || [];
                        window.gamificationState.dailyChallengesCompleted = gam.dailyChallengesCompleted || 0;
                        window.gamificationState.maxStreak = gam.maxStreak || 0;
                        window.gamificationState.loginStreak = currentStudent.loginStreak || 0;
                        window.gamificationState.totalAttempts = currentStudent.totalAttempts || 0;
                        window.gamificationState.correctCount = currentStudent.correctCount || 0;
                        window.gamificationState.lastDailyChallengeDate = gam.lastDailyChallengeDate;
                        window.gamificationState.dailyChallenge = gam.dailyChallenge;
                        window.gamificationState.dailyChallengeProgress = gam.dailyChallengeProgress || 0;
                    }
                }
            } catch (e) { console.log('Gamification load failed:', e); }
            updateXPDisplay();
            updateAchievementsCount();
            updateStreakBonusDisplay();
            initDailyChallenge();
        };

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            const quickstartCompleted = localStorage.getItem('quickstartCompleted');
            setTimeout(() => {
                if (window.auth?.currentUser) {
                    loadGamificationState();
                    if (!quickstartCompleted) setTimeout(() => showQuickstartWizard(), 1500);
                }
            }, 2000);
        });

        // Hook into existing answer tracking
        const originalTrackQuestionAttempt = window.trackQuestionAttempt;
        window.trackQuestionAttempt = function(questionId, isCorrect) {
            if (originalTrackQuestionAttempt) originalTrackQuestionAttempt(questionId, isCorrect);
            const questionElement = document.getElementById(questionId);
            const isMCQ = window.currentMode === 'mcq';
            handleQuestionAnswer(isCorrect, questionElement, isMCQ ? 'mcq' : 'oeq');
        };

        console.log(' Gamification system loaded!');
    </script>

    <!-- =====================================================
         SMART RECOMMENDATIONS & MOTIVATIONAL TIPS
         ===================================================== -->
    <script>
        // =====================================================
        // SMART RECOMMENDATION SYSTEM
        // =====================================================
        window.RECOMMENDATIONS = {
            types: [
                { id: 'review_due', title: 'Review Time', icon: '', priority: 10 },
                { id: 'weak_topic', title: 'Focus Area', icon: '', priority: 9 },
                { id: 'new_challenge', title: 'New Challenge', icon: '', priority: 7 },
                { id: 'daily_goal', title: 'Daily Goal', icon: '', priority: 8 },
                { id: 'streak_protect', title: 'Keep Streak', icon: '', priority: 10 },
                { id: 'level_up_close', title: 'Almost There', icon: '', priority: 8 },
                { id: 'achievement_close', title: 'Badge Nearby', icon: '', priority: 6 }
            ]
        };

        window.currentRecommendation = null;

        window.generateSmartRecommendation = function() {
            const state = window.gamificationState;
            const recommendations = [];

            // Check for review questions due
            const reviewCount = window.practiceState?.reviewDueCount || 0;
            if (reviewCount > 0) {
                recommendations.push({
                    type: 'review_due',
                    title: 'Review Time',
                    content: `You have ${reviewCount} question${reviewCount > 1 ? 's' : ''} due for review. Reviewing helps strengthen memory!`,
                    action: 'review',
                    priority: 10
                });
            }

            // Check for daily challenge progress
            const challenge = state.dailyChallenge;
            if (challenge && !challenge.completed) {
                const remaining = challenge.target - state.dailyChallengeProgress;
                if (remaining > 0) {
                    recommendations.push({
                        type: 'daily_goal',
                        title: 'Daily Challenge',
                        content: `${remaining} more to complete today's challenge and earn +${challenge.reward} XP!`,
                        action: 'practice',
                        priority: 8
                    });
                }
            }

            // Check for level up proximity
            const currentLevel = calculateLevel(state.xp);
            const nextLevelXP = getXPForNextLevel(currentLevel.level);
            if (nextLevelXP) {
                const xpNeeded = nextLevelXP - state.xp;
                if (xpNeeded <= 50) {
                    recommendations.push({
                        type: 'level_up_close',
                        title: 'Almost Level Up!',
                        content: `Just ${xpNeeded} XP away from Level ${currentLevel.level + 1}! Answer a few questions to level up!`,
                        action: 'practice',
                        priority: 9
                    });
                }
            }

            // Check streak protection (if user hasn't practiced today)
            if (state.loginStreak >= 3) {
                const today = new Date().toDateString();
                const lastPractice = localStorage.getItem('lastPracticeDate');
                if (lastPractice !== today) {
                    recommendations.push({
                        type: 'streak_protect',
                        title: 'Protect Your Streak!',
                        content: `You have a ${state.loginStreak}-day streak! Practice now to keep it going!`,
                        action: 'practice',
                        priority: 10
                    });
                }
            }

            // Check for achievement proximity
            const achievements = window.GAMIFICATION_CONFIG.ACHIEVEMENTS;
            achievements.forEach(ach => {
                if (!state.unlockedAchievements.includes(ach.id)) {
                    // Check specific achievements that are close
                    if (ach.id === 'getting_started' && state.totalAttempts >= 7) {
                        recommendations.push({
                            type: 'achievement_close',
                            title: 'Badge Nearby!',
                            content: `Answer ${10 - state.totalAttempts} more questions to unlock "Getting Started" badge!`,
                            action: 'practice',
                            priority: 7
                        });
                    }
                    if (ach.id === 'on_a_roll' && state.currentStreak >= 3) {
                        recommendations.push({
                            type: 'achievement_close',
                            title: 'On Fire!',
                            content: `${5 - state.currentStreak} more correct answers in a row to unlock "On a Roll" badge!`,
                            action: 'practice',
                            priority: 8
                        });
                    }
                }
            });

            // Default recommendation if nothing specific
            if (recommendations.length === 0) {
                const defaultRecs = [
                    { type: 'new_challenge', title: 'Ready to Learn?', content: 'Start practicing to earn XP and climb the leaderboard!', action: 'practice', priority: 5 },
                    { type: 'new_challenge', title: 'Explore Topics', content: 'Try a new topic to broaden your science knowledge!', action: 'practice', priority: 5 },
                    { type: 'new_challenge', title: 'Challenge Yourself', content: 'Push your limits with some challenging questions!', action: 'practice', priority: 5 }
                ];
                recommendations.push(defaultRecs[Math.floor(Math.random() * defaultRecs.length)]);
            }

            // Sort by priority and pick the best
            recommendations.sort((a, b) => b.priority - a.priority);
            return recommendations[0];
        };

        window.updateRecommendationDisplay = function() {
            const recommendation = generateSmartRecommendation();
            window.currentRecommendation = recommendation;

            const titleEl = document.getElementById('recommendation-title');
            const contentEl = document.getElementById('recommendation-content');
            const btnEl = document.getElementById('recommendation-btn');

            if (titleEl) titleEl.textContent = recommendation.title;
            if (contentEl) contentEl.textContent = recommendation.content;
            if (btnEl) {
                if (recommendation.action === 'review') {
                    btnEl.textContent = ' Review Now';
                } else {
                    btnEl.textContent = ' Start Now';
                }
            }
        };

        window.followRecommendation = function() {
            const rec = window.currentRecommendation;
            if (!rec) return;

            if (rec.action === 'review') {
                // Navigate to review questions
                const practiceBtn = document.getElementById('btn-sidebar-practice');
                if (practiceBtn) {
                    switchTab('practice', practiceBtn);
                    // Could trigger review mode here
                }
            } else {
                // Navigate to practice mode
                const practiceBtn = document.getElementById('btn-sidebar-practice');
                if (practiceBtn) {
                    switchTab('practice', practiceBtn);
                }
            }

            // Mark practice date
            localStorage.setItem('lastPracticeDate', new Date().toDateString());
        };

        // =====================================================
        // MOTIVATIONAL TIPS SYSTEM
        // =====================================================
        window.MOTIVATIONAL_TIPS = [
            { emoji: '', title: 'Stay Strong', content: 'Every mistake is a learning opportunity. Keep going!' },
            { emoji: '', title: 'Brain Power', content: 'Science shows that practicing retrieval strengthens memory more than re-reading!' },
            { emoji: '', title: 'Focus Tip', content: 'Try answering 5 questions without breaks for better concentration.' },
            { emoji: '', title: 'Star Tip', content: 'Correct answers earn more XP. Take your time to think carefully!' },
            { emoji: '', title: 'Streak Power', content: 'Daily practice builds momentum. Your streak bonus increases your XP!' },
            { emoji: '', title: 'Champion Mindset', content: 'Top students review their mistakes. Check the explanations after each question!' },
            { emoji: '', title: 'Study Smart', content: 'Mix up topics to improve your ability to recall information during exams.' },
            { emoji: '', title: 'You Got This', content: 'Believe in yourself! Every question you answer makes you smarter.' },
            { emoji: '', title: 'Perfect Timing', content: 'Short, focused study sessions are more effective than long cramming sessions.' },
            { emoji: '', title: 'Level Up', content: 'Completing daily challenges is the fastest way to gain XP and level up!' },
            { emoji: '', title: 'Pro Tip', content: 'Read the question twice before answering. Details matter in science!' },
            { emoji: '', title: 'Positive Vibes', content: 'A positive attitude helps your brain absorb information better!' },
            { emoji: '', title: 'Be Curious', content: 'Scientists ask questions. Be curious about why things work the way they do!' },
            { emoji: '', title: 'Progress', content: 'Check "My Progress" to see how much you have improved over time!' },
            { emoji: '', title: 'Learn Together', content: 'Compare your ranking on the Leaderboard and challenge your friends!' },
            { emoji: '', title: 'Rewards', content: 'Complete achievements to unlock special badges and bonus XP!' },
            { emoji: '', title: 'Experiment', content: 'Try both MCQ and OEQ modes to master different question types!' },
            { emoji: '', title: 'Growth', content: 'Every expert was once a beginner. Keep practicing and you will improve!' }
        ];

        window.currentTipIndex = 0;

        window.updateMotivationalTip = function() {
            const tips = window.MOTIVATIONAL_TIPS;
            const tip = tips[window.currentTipIndex];

            const emojiEl = document.getElementById('tip-emoji');
            const titleEl = document.getElementById('tip-title');
            const contentEl = document.getElementById('tip-content');

            if (emojiEl) emojiEl.textContent = tip.emoji;
            if (titleEl) titleEl.textContent = tip.title;
            if (contentEl) contentEl.textContent = tip.content;

            // Rotate to next tip
            window.currentTipIndex = (window.currentTipIndex + 1) % tips.length;
        };

        // =====================================================
        // ENCOURAGEMENT MESSAGES AFTER ANSWERS
        // =====================================================
        window.ENCOURAGEMENT_MESSAGES = {
            correct: [
                { emoji: '', message: 'Excellent work!' },
                { emoji: '', message: 'You nailed it!' },
                { emoji: '', message: 'On fire!' },
                { emoji: '', message: 'Perfect!' },
                { emoji: '', message: 'Champion answer!' },
                { emoji: '', message: 'Brilliant!' },
                { emoji: '', message: 'Stellar work!' },
                { emoji: '', message: 'Strong answer!' },
                { emoji: '', message: 'Superstar!' },
                { emoji: '', message: 'Great job!' }
            ],
            incorrect: [
                { emoji: '', message: 'Keep trying!' },
                { emoji: '', message: 'Learning in progress!' },
                { emoji: '', message: 'Try again next time!' },
                { emoji: '', message: 'Now you know!' },
                { emoji: '', message: 'Getting closer!' },
                { emoji: '', message: 'Room to grow!' },
                { emoji: '', message: 'Brain training!' },
                { emoji: '', message: 'Every attempt counts!' }
            ],
            streak: [
                { emoji: '', message: '{n} in a row! Keep it up!' },
                { emoji: '', message: '{n} streak! You are unstoppable!' },
                { emoji: '', message: 'Perfect streak of {n}!' },
                { emoji: '', message: '{n} correct! Brilliant!' }
            ]
        };

        window.showEncouragementMessage = function(isCorrect, streakCount) {
            let messages, message;

            if (isCorrect && streakCount >= 3) {
                messages = window.ENCOURAGEMENT_MESSAGES.streak;
                const msg = messages[Math.floor(Math.random() * messages.length)];
                message = { emoji: msg.emoji, message: msg.message.replace('{n}', streakCount) };
            } else if (isCorrect) {
                messages = window.ENCOURAGEMENT_MESSAGES.correct;
                message = messages[Math.floor(Math.random() * messages.length)];
            } else {
                messages = window.ENCOURAGEMENT_MESSAGES.incorrect;
                message = messages[Math.floor(Math.random() * messages.length)];
            }

            // Show toast with encouragement
            if (window.showToast) {
                showToast(`${message.emoji} ${message.message}`, isCorrect ? 'success' : 'info');
            }
        };

        // =====================================================
        // SKELETON LOADING HELPERS
        // =====================================================
        window.showSkeletonLoading = function(containerId, count = 3) {
            const container = document.getElementById(containerId);
            if (!container) return;

            let skeletonHTML = '';
            for (let i = 0; i < count; i++) {
                skeletonHTML += `
                    <div class="skeleton-card">
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text medium"></div>
                        <div class="skeleton skeleton-text short"></div>
                    </div>
                `;
            }
            container.innerHTML = skeletonHTML;
        };

        window.hideSkeletonLoading = function(containerId) {
            const container = document.getElementById(containerId);
            if (container && container.querySelector('.skeleton-card')) {
                container.innerHTML = '';
            }
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize motivational tip with random start
            window.currentTipIndex = Math.floor(Math.random() * window.MOTIVATIONAL_TIPS.length);
            updateMotivationalTip();

            // Rotate tips every 30 seconds
            setInterval(updateMotivationalTip, 30000);

            // Wait for auth then update recommendation
            setTimeout(() => {
                if (window.auth?.currentUser) {
                    updateRecommendationDisplay();
                    // Update recommendation every 2 minutes
                    setInterval(updateRecommendationDisplay, 120000);
                }
            }, 3000);
        });

        // Hook into answer handling for encouragement messages
        const originalHandleQuestionAnswer = window.handleQuestionAnswer;
        window.handleQuestionAnswer = function(isCorrect, questionElement, questionType) {
            if (originalHandleQuestionAnswer) {
                originalHandleQuestionAnswer(isCorrect, questionElement, questionType);
            }
            // Show encouragement message
            const streakCount = window.gamificationState?.currentStreak || 0;
            showEncouragementMessage(isCorrect, streakCount);
        };

        console.log(' Smart recommendations and tips loaded!');
    </script>

    <!-- =====================================================
         PROGRESS MILESTONES & WEEKLY CHALLENGES
         ===================================================== -->
    <script>
        // =====================================================
        // PROGRESS MILESTONES
        // =====================================================
        window.MILESTONES = [
            { id: 'first_question', count: 1, title: 'First Step!', message: 'You answered your first question! Keep going!', emoji: '', xpBonus: 5 },
            { id: 'ten_questions', count: 10, title: 'Getting Warmed Up!', message: "10 questions down! You're building momentum!", emoji: '', xpBonus: 15 },
            { id: 'twentyfive', count: 25, title: 'Quarter Century!', message: '25 questions completed! Great progress!', emoji: '', xpBonus: 25 },
            { id: 'fifty', count: 50, title: 'Half Century!', message: '50 questions! You are dedicated!', emoji: '', xpBonus: 40 },
            { id: 'hundred', count: 100, title: 'Century Club!', message: '100 questions! You are a true learner!', emoji: '', xpBonus: 75 },
            { id: 'twohundred', count: 200, title: 'Double Century!', message: '200 questions! Incredible dedication!', emoji: '', xpBonus: 100 },
            { id: 'fivehundred', count: 500, title: 'Science Champion!', message: '500 questions! You are a science master!', emoji: '', xpBonus: 200 },
            { id: 'thousand', count: 1000, title: 'LEGENDARY!', message: '1000 questions! You are absolutely LEGENDARY!', emoji: '', xpBonus: 500 }
        ];

        window.checkMilestones = function() {
            const state = window.gamificationState;
            const reachedMilestones = JSON.parse(localStorage.getItem('reachedMilestones') || '[]');

            window.MILESTONES.forEach(milestone => {
                if (state.totalAttempts >= milestone.count && !reachedMilestones.includes(milestone.id)) {
                    showMilestonePopup(milestone);
                    reachedMilestones.push(milestone.id);
                    localStorage.setItem('reachedMilestones', JSON.stringify(reachedMilestones));

                    // Award bonus XP
                    if (window.addXP) {
                        setTimeout(() => addXP(milestone.xpBonus, `Milestone: ${milestone.title}`), 1500);
                    }
                }
            });
        };

        window.showMilestonePopup = function(milestone) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
                background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                color: #333;
                padding: 40px;
                border-radius: 24px;
                text-align: center;
                z-index: 10005;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
                animation: milestoneAppear 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
                max-width: 400px;
            `;
            popup.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 10px;">${milestone.emoji}</div>
                <h2 style="margin: 0 0 10px 0; font-size: 1.8rem;">${milestone.title}</h2>
                <p style="margin: 0 0 20px 0; font-size: 1rem; opacity: 0.9;">${milestone.message}</p>
                <div style="background: rgba(0,0,0,0.1); padding: 10px 20px; border-radius: 12px; display: inline-block; margin-bottom: 20px;">
                    <span style="font-size: 1.2rem; font-weight: 700;">+${milestone.xpBonus} XP Bonus!</span>
                </div>
                <br>
                <button onclick="this.parentElement.remove()" style="background: #333; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: 600; cursor: pointer;">
                    Awesome! 
                </button>
            `;

            // Add animation keyframes if not exists
            if (!document.getElementById('milestone-animation-style')) {
                const style = document.createElement('style');
                style.id = 'milestone-animation-style';
                style.textContent = `
                    @keyframes milestoneAppear {
                        0% { transform: translate(-50%, -50%) scale(0); }
                        100% { transform: translate(-50%, -50%) scale(1); }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(popup);

            // Trigger celebration
            if (window.triggerCelebration) triggerCelebration();

            // Auto-close after 8 seconds
            setTimeout(() => {
                if (popup.parentElement) popup.remove();
            }, 8000);
        };

        // =====================================================
        // WEEKLY CHALLENGES
        // =====================================================
        window.WEEKLY_CHALLENGES = [
            { id: 'weekly_50', task: 'Answer 50 questions this week', target: 50, type: 'attempts', reward: 150 },
            { id: 'weekly_30_correct', task: 'Get 30 correct answers this week', target: 30, type: 'correct', reward: 200 },
            { id: 'weekly_all_topics', task: 'Practice 5 different topics this week', target: 5, type: 'topics', reward: 175 },
            { id: 'weekly_streak', task: 'Maintain a 5-day login streak', target: 5, type: 'login_streak', reward: 250 },
            { id: 'weekly_daily_complete', task: 'Complete 3 daily challenges', target: 3, type: 'daily_challenges', reward: 225 }
        ];

        window.weeklyState = {
            challenge: null,
            progress: 0,
            weekStart: null,
            completed: false,
            topicsPracticed: new Set()
        };

        window.initWeeklyChallenge = function() {
            const stored = localStorage.getItem('weeklyState');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    window.weeklyState = {
                        ...parsed,
                        topicsPracticed: new Set(parsed.topicsPracticed || [])
                    };
                } catch (e) { }
            }

            const now = new Date();
            const currentWeekStart = getWeekStart(now).toDateString();

            // Check if we need a new weekly challenge
            if (window.weeklyState.weekStart !== currentWeekStart) {
                // New week, new challenge
                const challenges = window.WEEKLY_CHALLENGES;
                const randomIndex = Math.floor(Math.random() * challenges.length);
                window.weeklyState = {
                    challenge: { ...challenges[randomIndex] },
                    progress: 0,
                    weekStart: currentWeekStart,
                    completed: false,
                    topicsPracticed: new Set()
                };
                saveWeeklyState();
            }

            updateWeeklyChallengeDisplay();
        };

        window.getWeekStart = function(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday
            return new Date(d.setDate(diff));
        };

        window.updateWeeklyChallengeProgress = function(type, amount = 1) {
            const state = window.weeklyState;
            if (!state.challenge || state.completed) return;

            if (state.challenge.type === type) {
                if (type === 'topics') {
                    state.topicsPracticed.add(amount);
                    state.progress = state.topicsPracticed.size;
                } else {
                    state.progress += (typeof amount === 'number' ? amount : 1);
                }
                saveWeeklyState();
                updateWeeklyChallengeDisplay();

                // Check completion
                if (state.progress >= state.challenge.target && !state.completed) {
                    completeWeeklyChallenge();
                }
            }
        };

        window.completeWeeklyChallenge = function() {
            const state = window.weeklyState;
            if (!state.challenge || state.completed) return;

            state.completed = true;

            // Award XP
            if (window.addXP) {
                addXP(state.challenge.reward, 'Weekly Challenge Complete');
            }

            // Show notification
            const notification = document.createElement('div');
            notification.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#9C27B0,#673AB7);color:white;padding:20px 30px;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.3);z-index:10004;animation:slideDown 0.5s ease;text-align:center';
            notification.innerHTML = `
                <div style="font-size:2rem;margin-bottom:8px;"></div>
                <div style="font-weight:700;font-size:1.2rem;">Weekly Challenge Complete!</div>
                <div style="font-size:1rem;opacity:0.9;margin-top:5px;">+${state.challenge.reward} XP</div>
            `;

            if (!document.getElementById('slidedown-style')) {
                const style = document.createElement('style');
                style.id = 'slidedown-style';
                style.textContent = '@keyframes slideDown { from { transform: translateX(-50%) translateY(-100px); } to { transform: translateX(-50%) translateY(0); } }';
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);

            if (window.triggerCelebration) triggerCelebration();

            saveWeeklyState();
        };

        window.updateWeeklyChallengeDisplay = function() {
            // This could update a UI element if we add one
        };

        window.saveWeeklyState = function() {
            localStorage.setItem('weeklyState', JSON.stringify({
                ...window.weeklyState,
                topicsPracticed: Array.from(window.weeklyState.topicsPracticed)
            }));
        };

        // =====================================================
        // STUDY SESSION TIMER WITH BREAK REMINDERS
        // =====================================================
        window.studySessionState = {
            startTime: null,
            questionsAnswered: 0,
            breaksTaken: 0,
            lastBreakReminder: null
        };

        window.STUDY_CONFIG = {
            BREAK_REMINDER_INTERVAL: 20 * 60 * 1000, // 20 minutes
            QUESTIONS_BEFORE_BREAK: 15,
            BREAK_MESSAGES: [
                { emoji: '', title: 'Time for a Break!', message: 'You have been studying for 20 minutes. Take a 5-minute break to refresh your mind!' },
                { emoji: '', title: 'Stretch Break!', message: 'Stand up, stretch, and take some deep breaths. Your brain will thank you!' },
                { emoji: '', title: 'Hydration Check!', message: 'Time to drink some water and rest your eyes for a few minutes!' },
                { emoji: '', title: 'Fresh Air Break!', message: 'Consider stepping outside for fresh air. Short breaks improve focus!' }
            ]
        };

        window.initStudySession = function() {
            window.studySessionState.startTime = Date.now();
            window.studySessionState.questionsAnswered = 0;
            window.studySessionState.lastBreakReminder = Date.now();

            // Check for break reminders every minute
            setInterval(checkBreakReminder, 60000);
        };

        window.checkBreakReminder = function() {
            const state = window.studySessionState;
            const now = Date.now();

            // Check time-based break
            if (now - state.lastBreakReminder >= window.STUDY_CONFIG.BREAK_REMINDER_INTERVAL) {
                showBreakReminder();
                state.lastBreakReminder = now;
            }
        };

        window.trackStudyQuestion = function() {
            const state = window.studySessionState;
            state.questionsAnswered++;

            // Check questions-based break
            if (state.questionsAnswered > 0 && state.questionsAnswered % window.STUDY_CONFIG.QUESTIONS_BEFORE_BREAK === 0) {
                showBreakReminder();
            }
        };

        window.showBreakReminder = function() {
            const messages = window.STUDY_CONFIG.BREAK_MESSAGES;
            const msg = messages[Math.floor(Math.random() * messages.length)];

            const reminder = document.createElement('div');
            reminder.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4CAF50, #8BC34A);
                color: white;
                padding: 20px;
                border-radius: 16px;
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
                z-index: 10003;
                max-width: 320px;
                animation: slideLeft 0.5s ease;
            `;
            reminder.innerHTML = `
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
                    <span style="font-size:2rem;">${msg.emoji}</span>
                    <span style="font-weight:700;font-size:1.1rem;">${msg.title}</span>
                </div>
                <p style="margin:0 0 15px 0;font-size:0.9rem;line-height:1.4;">${msg.message}</p>
                <div style="display:flex;gap:10px;">
                    <button onclick="this.parentElement.parentElement.remove(); window.studySessionState.breaksTaken++;" style="flex:1;background:rgba(255,255,255,0.2);border:none;color:white;padding:10px;border-radius:8px;cursor:pointer;font-weight:600;">
                        Take Break
                    </button>
                    <button onclick="this.parentElement.parentElement.remove();" style="flex:1;background:rgba(0,0,0,0.2);border:none;color:white;padding:10px;border-radius:8px;cursor:pointer;font-weight:600;">
                        Later
                    </button>
                </div>
            `;

            if (!document.getElementById('slideleft-style')) {
                const style = document.createElement('style');
                style.id = 'slideleft-style';
                style.textContent = '@keyframes slideLeft { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }';
                document.head.appendChild(style);
            }

            document.body.appendChild(reminder);

            // Auto-dismiss after 15 seconds
            setTimeout(() => {
                if (reminder.parentElement) reminder.remove();
            }, 15000);
        };

        // =====================================================
        // INITIALIZATION AND HOOKS
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            initWeeklyChallenge();
            initStudySession();
        });

        // Hook into answer tracking for milestones and weekly challenges
        const originalHandleAnswer2 = window.handleQuestionAnswer;
        window.handleQuestionAnswer = function(isCorrect, questionElement, questionType) {
            if (originalHandleAnswer2) {
                originalHandleAnswer2(isCorrect, questionElement, questionType);
            }

            // Check milestones
            setTimeout(checkMilestones, 500);

            // Update weekly challenge
            updateWeeklyChallengeProgress('attempts');
            if (isCorrect) {
                updateWeeklyChallengeProgress('correct');
            }

            // Track for study session
            trackStudyQuestion();
        };

        console.log(' Progress milestones and weekly challenges loaded!');
    </script>

    <!-- =====================================================
         TOPIC MASTERY & FOCUSED PRACTICE
         ===================================================== -->
    <script>
        // =====================================================
        // TOPIC MASTERY TRACKING
        // =====================================================
        window.topicMasteryState = {
            topics: {},
            focusMode: false,
            focusTopic: null
        };

        window.updateTopicMastery = function(topic, isCorrect) {
            if (!topic) return;

            const topicKey = topic.toLowerCase().trim();
            if (!window.topicMasteryState.topics[topicKey]) {
                window.topicMasteryState.topics[topicKey] = {
                    name: topic,
                    attempts: 0,
                    correct: 0
                };
            }

            window.topicMasteryState.topics[topicKey].attempts++;
            if (isCorrect) {
                window.topicMasteryState.topics[topicKey].correct++;
            }

            saveTopicMastery();
            renderTopicMasteryList();
        };

        window.getTopicMasteryPercent = function(topicKey) {
            const topic = window.topicMasteryState.topics[topicKey];
            if (!topic || topic.attempts === 0) return 0;
            return Math.round((topic.correct / topic.attempts) * 100);
        };

        window.getMasteryClass = function(percent) {
            if (percent >= 80) return 'mastered';
            if (percent >= 60) return 'high';
            if (percent >= 40) return 'medium';
            return 'low';
        };

        window.renderTopicMasteryList = function() {
            const container = document.getElementById('topic-mastery-list');
            const focusBtn = document.getElementById('focus-practice-btn');
            if (!container) return;

            const topics = window.topicMasteryState.topics;
            const topicEntries = Object.entries(topics)
                .filter(([key, data]) => data.attempts >= 1)
                .map(([key, data]) => ({
                    key,
                    name: data.name,
                    percent: getTopicMasteryPercent(key),
                    attempts: data.attempts,
                    correct: data.correct
                }))
                .sort((a, b) => a.percent - b.percent); // Sort by weakest first

            if (topicEntries.length === 0) {
                container.innerHTML = '<div style="font-size: 0.85rem; color: var(--light-text); text-align: center; padding: 10px;">Start practicing to see your topic mastery!</div>';
                if (focusBtn) focusBtn.style.display = 'none';
                return;
            }

            // Show top 5 (weakest topics)
            const displayTopics = topicEntries.slice(0, 5);

            container.innerHTML = displayTopics.map(topic => `
                <div class="topic-mastery-item" data-topic="${topic.key}">
                    <span class="topic-mastery-name" title="${topic.name}">${topic.name}</span>
                    <div class="topic-mastery-bar">
                        <div class="topic-mastery-fill ${getMasteryClass(topic.percent)}" style="width: ${topic.percent}%;"></div>
                    </div>
                    <span class="topic-mastery-percent">${topic.percent}%</span>
                </div>
            `).join('');

            // Show focus button if there are weak topics
            const weakTopics = topicEntries.filter(t => t.percent < 60);
            if (focusBtn) {
                focusBtn.style.display = weakTopics.length > 0 ? 'block' : 'none';
            }
        };

        window.saveTopicMastery = function() {
            localStorage.setItem('topicMastery', JSON.stringify(window.topicMasteryState));
        };

        window.loadTopicMastery = function() {
            const stored = localStorage.getItem('topicMastery');
            if (stored) {
                try {
                    window.topicMasteryState = JSON.parse(stored);
                } catch (e) { }
            }
            renderTopicMasteryList();
        };

        // =====================================================
        // FOCUSED PRACTICE MODE
        // =====================================================
        window.startFocusPractice = function() {
            // Find weakest topic
            const topics = window.topicMasteryState.topics;
            const weakestTopic = Object.entries(topics)
                .filter(([key, data]) => data.attempts >= 1)
                .map(([key, data]) => ({
                    key,
                    name: data.name,
                    percent: getTopicMasteryPercent(key)
                }))
                .sort((a, b) => a.percent - b.percent)[0];

            if (!weakestTopic) {
                showToast('Start practicing to identify weak topics!', 'info');
                return;
            }

            window.topicMasteryState.focusMode = true;
            window.topicMasteryState.focusTopic = weakestTopic;

            // Show focus mode banner
            showFocusModeBanner(weakestTopic);

            // Navigate to practice mode
            const practiceBtn = document.getElementById('btn-sidebar-practice');
            if (practiceBtn) {
                switchTab('practice', practiceBtn);
            }

            showToast(` Focus Mode: Practicing "${weakestTopic.name}" questions`, 'success');
        };

        window.showFocusModeBanner = function(topic) {
            // Remove existing banner if any
            const existing = document.getElementById('focus-mode-banner');
            if (existing) existing.remove();

            const banner = document.createElement('div');
            banner.id = 'focus-mode-banner';
            banner.className = 'focus-mode-banner';
            banner.innerHTML = `
                <div class="focus-mode-text">
                    <span></span>
                    <span>Focus Mode: ${topic.name} (${topic.percent}% mastery)</span>
                </div>
                <button class="focus-mode-exit" onclick="exitFocusMode()">Exit Focus</button>
            `;

            // Insert at the top of main content
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.insertBefore(banner, mainContent.firstChild);
            }
        };

        window.exitFocusMode = function() {
            window.topicMasteryState.focusMode = false;
            window.topicMasteryState.focusTopic = null;

            const banner = document.getElementById('focus-mode-banner');
            if (banner) banner.remove();

            showToast('Focus mode ended', 'info');
        };

        // =====================================================
        // LOADING OPTIMIZATION
        // =====================================================
        window.prefetchCriticalResources = function() {
            // Prefetch Firebase modules
            const modules = [
                'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js',
                'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'
            ];

            modules.forEach(url => {
                const link = document.createElement('link');
                link.rel = 'prefetch';
                link.href = url;
                document.head.appendChild(link);
            });
        };

        window.deferNonCriticalLoad = function(callback, delay = 100) {
            if ('requestIdleCallback' in window) {
                requestIdleCallback(callback, { timeout: 2000 });
            } else {
                setTimeout(callback, delay);
            }
        };

        // =====================================================
        // PERFORMANCE HINTS
        // =====================================================
        window.showPerformanceTip = function() {
            const tips = [
                'Tip: Use keyboard shortcuts (Alt+P for Practice) for faster navigation!',
                'Tip: Questions are cached locally for faster loading on return visits.',
                'Tip: Your progress is saved automatically - no need to manually save!'
            ];

            const randomTip = tips[Math.floor(Math.random() * tips.length)];

            // Show briefly in console for debugging
            console.log(' ' + randomTip);
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Load topic mastery data
            loadTopicMastery();

            // Prefetch resources during idle time
            deferNonCriticalLoad(prefetchCriticalResources, 3000);

            // Show performance tip occasionally
            if (Math.random() < 0.1) { // 10% chance
                showPerformanceTip();
            }
        });

        // Hook into answer handling for topic mastery tracking
        const originalHandleAnswer3 = window.handleQuestionAnswer;
        window.handleQuestionAnswer = function(isCorrect, questionElement, questionType) {
            if (originalHandleAnswer3) {
                originalHandleAnswer3(isCorrect, questionElement, questionType);
            }

            // Extract topic from question element
            if (questionElement) {
                const topicEl = questionElement.closest('[data-topic]');
                if (topicEl) {
                    const topic = topicEl.getAttribute('data-topic');
                    updateTopicMastery(topic, isCorrect);
                }

                // Also check for topic container
                const topicContainer = questionElement.closest('[id^="topic-"]');
                if (topicContainer) {
                    const topicName = topicContainer.querySelector('h2, h3');
                    if (topicName) {
                        updateTopicMastery(topicName.textContent.trim(), isCorrect);
                    }
                }
            }
        };

        console.log(' Topic mastery and focused practice loaded!');
    </script>

    <!-- =====================================================
         LEARNING GOALS, SESSION STATS & POWER-UPS
         ===================================================== -->
    <script>
        // =====================================================
        // LEARNING GOALS SYSTEM
        // =====================================================
        window.learningGoals = {
            daily: { target: 10, current: 0, lastReset: null },
            weekly: { target: 50, current: 0, lastReset: null },
            customGoal: null
        };

        window.initLearningGoals = function() {
            const stored = localStorage.getItem('learningGoals');
            if (stored) {
                try {
                    window.learningGoals = JSON.parse(stored);
                } catch (e) { }
            }

            // Check if daily/weekly needs reset
            const now = new Date();
            const today = now.toDateString();
            const weekStart = getWeekStart(now).toDateString();

            if (window.learningGoals.daily.lastReset !== today) {
                window.learningGoals.daily.current = 0;
                window.learningGoals.daily.lastReset = today;
            }

            if (window.learningGoals.weekly.lastReset !== weekStart) {
                window.learningGoals.weekly.current = 0;
                window.learningGoals.weekly.lastReset = weekStart;
            }

            saveLearningGoals();
        };

        window.updateLearningGoals = function() {
            window.learningGoals.daily.current++;
            window.learningGoals.weekly.current++;

            // Check if goals completed
            if (window.learningGoals.daily.current === window.learningGoals.daily.target) {
                showGoalCompleted('daily');
            }
            if (window.learningGoals.weekly.current === window.learningGoals.weekly.target) {
                showGoalCompleted('weekly');
            }

            saveLearningGoals();
        };

        window.showGoalCompleted = function(type) {
            const goalName = type === 'daily' ? 'Daily Goal' : 'Weekly Goal';
            const xpBonus = type === 'daily' ? 30 : 100;

            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #00C853, #69F0AE);
                color: white;
                padding: 30px 40px;
                border-radius: 20px;
                text-align: center;
                z-index: 10005;
                box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
                animation: goalPop 0.5s ease;
            `;
            notification.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                <h2 style="margin: 0 0 10px 0; font-size: 1.5rem;">${goalName} Complete!</h2>
                <p style="margin: 0 0 15px 0; opacity: 0.9;">You did it! Keep up the great work!</p>
                <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px; display: inline-block;">
                    +${xpBonus} XP Bonus
                </div>
                <br>
                <button onclick="this.parentElement.remove()" style="margin-top: 15px; background: white; color: #00C853; border: none; padding: 10px 25px; border-radius: 20px; font-weight: 600; cursor: pointer;">
                    Awesome!
                </button>
            `;

            if (!document.getElementById('goal-pop-style')) {
                const style = document.createElement('style');
                style.id = 'goal-pop-style';
                style.textContent = '@keyframes goalPop { from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }';
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            // Add XP
            if (window.addXP) {
                setTimeout(() => addXP(xpBonus, `${goalName} Complete`), 500);
            }

            if (window.triggerCelebration) triggerCelebration();

            setTimeout(() => {
                if (notification.parentElement) notification.remove();
            }, 6000);
        };

        window.saveLearningGoals = function() {
            localStorage.setItem('learningGoals', JSON.stringify(window.learningGoals));
        };

        // =====================================================
        // SESSION STATISTICS
        // =====================================================
        window.sessionStats = {
            startTime: null,
            questionsAnswered: 0,
            correctAnswers: 0,
            xpEarned: 0,
            bestStreak: 0,
            topicsVisited: new Set()
        };

        window.initSessionStats = function() {
            window.sessionStats.startTime = Date.now();
        };

        window.getSessionDuration = function() {
            if (!window.sessionStats.startTime) return '0m';
            const durationMs = Date.now() - window.sessionStats.startTime;
            const minutes = Math.floor(durationMs / 60000);
            const hours = Math.floor(minutes / 60);
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            }
            return `${minutes}m`;
        };

        window.updateSessionStats = function(isCorrect, xpAmount) {
            window.sessionStats.questionsAnswered++;
            if (isCorrect) {
                window.sessionStats.correctAnswers++;
            }
            window.sessionStats.xpEarned += xpAmount || 0;

            // Update best streak
            const currentStreak = window.gamificationState?.currentStreak || 0;
            if (currentStreak > window.sessionStats.bestStreak) {
                window.sessionStats.bestStreak = currentStreak;
            }
        };

        window.showSessionSummary = function() {
            const stats = window.sessionStats;
            const accuracy = stats.questionsAnswered > 0
                ? Math.round((stats.correctAnswers / stats.questionsAnswered) * 100)
                : 0;

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10006;
            `;
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; padding: 30px; max-width: 400px; width: 90%; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                    <h2 style="margin: 0 0 20px 0; color: #333;">Session Summary</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 12px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #667eea;">${stats.questionsAnswered}</div>
                            <div style="font-size: 0.8rem; color: #666;">Questions</div>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 12px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #4CAF50;">${accuracy}%</div>
                            <div style="font-size: 0.8rem; color: #666;">Accuracy</div>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 12px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #FF9800;">${stats.xpEarned}</div>
                            <div style="font-size: 0.8rem; color: #666;">XP Earned</div>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 12px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #E91E63;">${getSessionDuration()}</div>
                            <div style="font-size: 0.8rem; color: #666;">Duration</div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-size: 0.9rem; opacity: 0.9;">Best Streak</div>
                        <div style="font-size: 1.5rem; font-weight: 700;"> ${stats.bestStreak} in a row</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: 600; cursor: pointer;">
                        Continue Learning
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
        };

        // =====================================================
        // POWER-UPS SYSTEM
        // =====================================================
        window.powerUps = {
            doubleXP: { active: false, endTime: null, remaining: 3 },
            hintBoost: { remaining: 5 },
            streakShield: { remaining: 2 }
        };

        window.initPowerUps = function() {
            const stored = localStorage.getItem('powerUps');
            if (stored) {
                try {
                    window.powerUps = JSON.parse(stored);
                } catch (e) { }
            }

            // Check if double XP expired
            if (window.powerUps.doubleXP.active && window.powerUps.doubleXP.endTime) {
                if (Date.now() > window.powerUps.doubleXP.endTime) {
                    window.powerUps.doubleXP.active = false;
                    window.powerUps.doubleXP.endTime = null;
                }
            }

            savePowerUps();
        };

        window.activateDoubleXP = function() {
            if (window.powerUps.doubleXP.remaining <= 0) {
                showToast('No Double XP power-ups remaining!', 'warning');
                return;
            }

            window.powerUps.doubleXP.active = true;
            window.powerUps.doubleXP.endTime = Date.now() + (5 * 60 * 1000); // 5 minutes
            window.powerUps.doubleXP.remaining--;

            savePowerUps();

            showPowerUpActivated('Double XP', '2x XP for 5 minutes!', '');

            // Auto-deactivate after 5 minutes
            setTimeout(() => {
                window.powerUps.doubleXP.active = false;
                window.powerUps.doubleXP.endTime = null;
                savePowerUps();
                showToast('Double XP has expired', 'info');
            }, 5 * 60 * 1000);
        };

        window.useHintBoost = function() {
            if (window.powerUps.hintBoost.remaining <= 0) {
                showToast('No Hint Boosts remaining!', 'warning');
                return false;
            }

            window.powerUps.hintBoost.remaining--;
            savePowerUps();
            showToast(' Hint Boost used!', 'success');
            return true;
        };

        window.useStreakShield = function() {
            if (window.powerUps.streakShield.remaining <= 0) {
                return false;
            }

            window.powerUps.streakShield.remaining--;
            savePowerUps();
            showToast(' Streak Shield activated! Your streak is protected!', 'success');
            return true;
        };

        window.showPowerUpActivated = function(name, desc, emoji) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #FFD700, #FFA500);
                color: #333;
                padding: 15px 25px;
                border-radius: 16px;
                box-shadow: 0 8px 30px rgba(0,0,0,0.3);
                z-index: 10004;
                animation: powerUpSlide 0.5s ease;
                display: flex;
                align-items: center;
                gap: 15px;
            `;
            notification.innerHTML = `
                <span style="font-size: 2rem;">${emoji}</span>
                <div>
                    <div style="font-weight: 700; font-size: 1.1rem;">${name} Activated!</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">${desc}</div>
                </div>
            `;

            if (!document.getElementById('powerup-slide-style')) {
                const style = document.createElement('style');
                style.id = 'powerup-slide-style';
                style.textContent = '@keyframes powerUpSlide { from { transform: translateX(-50%) translateY(-50px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }';
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        };

        window.savePowerUps = function() {
            localStorage.setItem('powerUps', JSON.stringify(window.powerUps));
        };

        // Award power-ups on level up
        window.awardPowerUpsOnLevelUp = function(newLevel) {
            if (newLevel % 2 === 0) { // Every even level
                window.powerUps.doubleXP.remaining++;
                window.powerUps.hintBoost.remaining++;
                savePowerUps();
                showToast(' Level up bonus: +1 Double XP, +1 Hint Boost!', 'success');
            }
            if (newLevel % 5 === 0) { // Every 5 levels
                window.powerUps.streakShield.remaining++;
                savePowerUps();
                showToast(' Level up bonus: +1 Streak Shield!', 'success');
            }
        };

        // =====================================================
        // QUICK HELP MODAL (KEYBOARD SHORTCUTS)
        // =====================================================
        window.showQuickHelp = function() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10006;
            `;
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333; display: flex; align-items: center; gap: 10px;">
                            <span></span> Quick Help
                        </h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
                    </div>

                    <h3 style="color: #667eea; margin: 15px 0 10px 0; font-size: 1rem;">Keyboard Shortcuts</h3>
                    <div style="background: #f5f5f5; border-radius: 12px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ddd;">
                            <span>Toggle Dark Mode</span>
                            <kbd style="background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Alt + D</kbd>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ddd;">
                            <span>Toggle MCQ/OEQ</span>
                            <kbd style="background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Alt + M</kbd>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ddd;">
                            <span>Practice Mode</span>
                            <kbd style="background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Alt + P</kbd>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ddd;">
                            <span>My Worksheet</span>
                            <kbd style="background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Alt + W</kbd>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <span>My Progress</span>
                            <kbd style="background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Alt + Y</kbd>
                        </div>
                    </div>

                    <h3 style="color: #667eea; margin: 20px 0 10px 0; font-size: 1rem;">Power-Ups Available</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div style="background: #FFF3E0; padding: 15px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 1.5rem;"></div>
                            <div style="font-weight: 600; font-size: 0.9rem;">Double XP</div>
                            <div style="font-size: 0.8rem; color: #666;">${window.powerUps?.doubleXP?.remaining || 0} left</div>
                        </div>
                        <div style="background: #E3F2FD; padding: 15px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 1.5rem;"></div>
                            <div style="font-weight: 600; font-size: 0.9rem;">Hint Boost</div>
                            <div style="font-size: 0.8rem; color: #666;">${window.powerUps?.hintBoost?.remaining || 0} left</div>
                        </div>
                        <div style="background: #E8F5E9; padding: 15px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 1.5rem;"></div>
                            <div style="font-weight: 600; font-size: 0.9rem;">Streak Shield</div>
                            <div style="font-size: 0.8rem; color: #666;">${window.powerUps?.streakShield?.remaining || 0} left</div>
                        </div>
                    </div>

                    <h3 style="color: #667eea; margin: 20px 0 10px 0; font-size: 1rem;">Today's Goals</h3>
                    <div style="background: #f5f5f5; border-radius: 12px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span>Daily Goal</span>
                            <span style="font-weight: 600;">${window.learningGoals?.daily?.current || 0}/${window.learningGoals?.daily?.target || 10}</span>
                        </div>
                        <div style="background: #ddd; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: ${Math.min(((window.learningGoals?.daily?.current || 0) / (window.learningGoals?.daily?.target || 10)) * 100, 100)}%;"></div>
                        </div>
                    </div>

                    <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px; width: 100%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        Got it!
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            initLearningGoals();
            initSessionStats();
            initPowerUps();
        });

        // Add keyboard shortcut for quick help
        document.addEventListener('keydown', (e) => {
            if (e.altKey && e.key === 'h') {
                e.preventDefault();
                showQuickHelp();
            }
        });

        // Hook into answer handling
        const originalHandleAnswer4 = window.handleQuestionAnswer;
        window.handleQuestionAnswer = function(isCorrect, questionElement, questionType) {
            // Track XP before the call
            const xpBefore = window.gamificationState?.xp || 0;

            if (originalHandleAnswer4) {
                originalHandleAnswer4(isCorrect, questionElement, questionType);
            }

            // Calculate XP earned
            const xpAfter = window.gamificationState?.xp || 0;
            const xpEarned = xpAfter - xpBefore;

            // Apply double XP if active
            if (window.powerUps.doubleXP.active && xpEarned > 0) {
                addXP(xpEarned, 'Double XP Bonus');
            }

            // Update learning goals
            updateLearningGoals();

            // Update session stats
            updateSessionStats(isCorrect, xpEarned);
        };

        // Hook into level up for power-up awards
        const originalShowLevelUpModal = window.showLevelUpModal;
        window.showLevelUpModal = function(newLevel) {
            if (originalShowLevelUpModal) {
                originalShowLevelUpModal(newLevel);
            }
            awardPowerUpsOnLevelUp(newLevel);
        };

        console.log(' Learning goals, session stats, and power-ups loaded!');
    </script>

    <!-- =====================================================
         STREAK CALENDAR, BONUS EVENTS & FUN FACTS
         ===================================================== -->
    <script>
        // =====================================================
        // PRACTICE STREAK CALENDAR
        // =====================================================
        window.streakCalendar = {
            practiceDays: [] // Array of date strings when user practiced
        };

        window.initStreakCalendar = function() {
            const stored = localStorage.getItem('streakCalendar');
            if (stored) {
                try {
                    window.streakCalendar = JSON.parse(stored);
                } catch (e) { }
            }
        };

        window.markTodayAsPracticed = function() {
            const today = new Date().toDateString();
            if (!window.streakCalendar.practiceDays.includes(today)) {
                window.streakCalendar.practiceDays.push(today);
                // Keep only last 90 days
                if (window.streakCalendar.practiceDays.length > 90) {
                    window.streakCalendar.practiceDays.shift();
                }
                localStorage.setItem('streakCalendar', JSON.stringify(window.streakCalendar));
            }
        };

        window.showStreakCalendar = function() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10006;
            `;
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            // Generate last 35 days
            const days = [];
            for (let i = 34; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                const practiced = window.streakCalendar.practiceDays.includes(dateStr);
                const dayName = date.toLocaleDateString('en', { weekday: 'short' }).charAt(0);
                const dayNum = date.getDate();
                days.push({ dateStr, practiced, dayName, dayNum, isToday: i === 0 });
            }

            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; padding: 30px; max-width: 450px; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333; display: flex; align-items: center; gap: 10px;">
                            <span></span> Practice Calendar
                        </h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
                    </div>

                    <div style="display: flex; justify-content: center; gap: 5px; margin-bottom: 15px;">
                        ${['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(d =>
                            `<div style="width: 40px; text-align: center; font-size: 0.8rem; color: #666;">${d}</div>`
                        ).join('')}
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(7, 40px); gap: 5px; justify-content: center;">
                        ${days.map(day => `
                            <div style="
                                width: 40px;
                                height: 40px;
                                border-radius: 8px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 0.85rem;
                                font-weight: ${day.practiced ? '700' : '400'};
                                background: ${day.practiced ? 'linear-gradient(135deg, #4CAF50, #8BC34A)' : '#f5f5f5'};
                                color: ${day.practiced ? 'white' : '#666'};
                                border: ${day.isToday ? '2px solid #667eea' : 'none'};
                            ">${day.dayNum}</div>
                        `).join('')}
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <div style="display: inline-flex; align-items: center; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #4CAF50, #8BC34A); border-radius: 4px;"></div>
                                <span style="font-size: 0.8rem; color: #666;">Practiced</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div style="width: 16px; height: 16px; background: #f5f5f5; border-radius: 4px;"></div>
                                <span style="font-size: 0.8rem; color: #666;">Missed</span>
                            </div>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 12px; margin-top: 20px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700;"> ${window.gamificationState?.loginStreak || 0}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Current Streak</div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        };

        // =====================================================
        // TIME-LIMITED BONUS EVENTS
        // =====================================================
        window.bonusEvents = {
            active: null,
            history: []
        };

        window.BONUS_EVENT_TYPES = [
            { id: 'double_xp_hour', name: 'Double XP Hour', multiplier: 2, duration: 60, emoji: '' },
            { id: 'triple_streak', name: 'Triple Streak Bonus', multiplier: 3, duration: 30, emoji: '' },
            { id: 'bonus_achievement', name: 'Bonus Achievement Points', multiplier: 1.5, duration: 45, emoji: '' },
            { id: 'happy_hour', name: 'Happy Hour', multiplier: 2.5, duration: 20, emoji: '' }
        ];

        window.checkBonusEvent = function() {
            // 5% chance to trigger a bonus event every 10 questions
            if (window.gamificationState?.totalAttempts % 10 === 0 && Math.random() < 0.05) {
                startRandomBonusEvent();
            }
        };

        window.startRandomBonusEvent = function() {
            if (window.bonusEvents.active) return; // Already active

            const eventType = window.BONUS_EVENT_TYPES[Math.floor(Math.random() * window.BONUS_EVENT_TYPES.length)];
            window.bonusEvents.active = {
                ...eventType,
                startTime: Date.now(),
                endTime: Date.now() + (eventType.duration * 60 * 1000)
            };

            showBonusEventStarted(eventType);

            // Schedule end
            setTimeout(() => {
                endBonusEvent();
            }, eventType.duration * 60 * 1000);
        };

        window.showBonusEventStarted = function(event) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #FF6B6B, #FF8E53);
                color: white;
                padding: 30px 40px;
                border-radius: 24px;
                text-align: center;
                z-index: 10007;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
                animation: bonusEventPop 0.5s ease;
            `;
            notification.innerHTML = `
                <div style="font-size: 3.5rem; margin-bottom: 10px;">${event.emoji}</div>
                <h2 style="margin: 0 0 10px 0; font-size: 1.8rem;">BONUS EVENT!</h2>
                <p style="margin: 0 0 15px 0; font-size: 1.2rem; font-weight: 600;">${event.name}</p>
                <p style="margin: 0 0 20px 0; opacity: 0.9;">${event.multiplier}x rewards for ${event.duration} minutes!</p>
                <button onclick="this.parentElement.remove()" style="background: white; color: #FF6B6B; border: none; padding: 12px 30px; border-radius: 25px; font-weight: 700; cursor: pointer; font-size: 1rem;">
                    Let's Go! 
                </button>
            `;

            if (!document.getElementById('bonus-event-style')) {
                const style = document.createElement('style');
                style.id = 'bonus-event-style';
                style.textContent = '@keyframes bonusEventPop { from { transform: translate(-50%, -50%) scale(0); } to { transform: translate(-50%, -50%) scale(1); } }';
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);
            if (window.triggerCelebration) triggerCelebration();

            setTimeout(() => {
                if (notification.parentElement) notification.remove();
            }, 8000);
        };

        window.endBonusEvent = function() {
            if (!window.bonusEvents.active) return;

            window.bonusEvents.history.push({
                ...window.bonusEvents.active,
                endedAt: Date.now()
            });

            showToast(`${window.bonusEvents.active.emoji} Bonus event ended!`, 'info');
            window.bonusEvents.active = null;
        };

        // =====================================================
        // FUN SCIENCE FACTS
        // =====================================================
        window.SCIENCE_FUN_FACTS = [
            { emoji: '', fact: 'Your DNA could stretch from Earth to Pluto and back 17 times!' },
            { emoji: '', fact: 'Hot water freezes faster than cold water. This is called the Mpemba effect!' },
            { emoji: '', fact: 'Babies have about 300 bones, but adults only have 206!' },
            { emoji: '', fact: 'Lightning strikes Earth about 8 million times per day!' },
            { emoji: '', fact: 'The ocean produces over half of the world\'s oxygen!' },
            { emoji: '', fact: 'One day on Venus is longer than one year on Venus!' },
            { emoji: '', fact: 'Octopuses have three hearts and blue blood!' },
            { emoji: '', fact: 'Your body has more bacteria cells than human cells!' },
            { emoji: '', fact: 'Rainbows are actually full circles - we just see an arc from the ground!' },
            { emoji: '', fact: 'The Sun\'s core is about 15 million degrees Celsius!' },
            { emoji: '', fact: 'Your brain generates enough electricity to power a small light bulb!' },
            { emoji: '', fact: 'Butterflies taste with their feet!' },
            { emoji: '', fact: 'Earth is the only planet not named after a god!' },
            { emoji: '', fact: 'Water is the only substance that exists naturally in all three states!' },
            { emoji: '', fact: 'Elephants are the only animals that can\'t jump!' },
            { emoji: '', fact: 'Trees can communicate with each other through underground fungal networks!' },
            { emoji: '', fact: 'Sharks have been on Earth longer than trees!' },
            { emoji: '', fact: 'Sound travels 4 times faster in water than in air!' },
            { emoji: '', fact: 'The Moon is slowly drifting away from Earth - about 3.8 cm per year!' },
            { emoji: '', fact: 'A teaspoon of neutron star would weigh about 6 billion tons!' }
        ];

        window.getRandomFunFact = function() {
            return window.SCIENCE_FUN_FACTS[Math.floor(Math.random() * window.SCIENCE_FUN_FACTS.length)];
        };

        window.showFunFact = function() {
            const fact = getRandomFunFact();

            const factCard = document.createElement('div');
            factCard.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #2196F3, #03A9F4);
                color: white;
                padding: 15px 25px;
                border-radius: 16px;
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
                z-index: 10002;
                max-width: 400px;
                animation: factSlideUp 0.5s ease;
            `;
            factCard.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <span style="font-size: 2rem;">${fact.emoji}</span>
                    <div>
                        <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 5px;">Did You Know?</div>
                        <div style="font-size: 0.85rem; line-height: 1.4;">${fact.fact}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; opacity: 0.7;"></button>
                </div>
            `;

            if (!document.getElementById('fact-slide-style')) {
                const style = document.createElement('style');
                style.id = 'fact-slide-style';
                style.textContent = '@keyframes factSlideUp { from { transform: translateX(-50%) translateY(50px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }';
                document.head.appendChild(style);
            }

            document.body.appendChild(factCard);

            setTimeout(() => {
                if (factCard.parentElement) {
                    factCard.style.animation = 'factSlideUp 0.3s ease reverse forwards';
                    setTimeout(() => factCard.remove(), 300);
                }
            }, 8000);
        };

        // =====================================================
        // PROGRESS COMPARISON
        // =====================================================
        window.sessionHistory = [];

        window.saveSessionToHistory = function() {
            const session = {
                date: new Date().toISOString(),
                questions: window.sessionStats.questionsAnswered,
                correct: window.sessionStats.correctAnswers,
                xp: window.sessionStats.xpEarned,
                duration: getSessionDuration(),
                streak: window.sessionStats.bestStreak
            };

            window.sessionHistory.push(session);

            // Keep only last 10 sessions
            if (window.sessionHistory.length > 10) {
                window.sessionHistory.shift();
            }

            localStorage.setItem('sessionHistory', JSON.stringify(window.sessionHistory));
        };

        window.loadSessionHistory = function() {
            const stored = localStorage.getItem('sessionHistory');
            if (stored) {
                try {
                    window.sessionHistory = JSON.parse(stored);
                } catch (e) { }
            }
        };

        window.compareWithLastSession = function() {
            if (window.sessionHistory.length < 1) return null;

            const lastSession = window.sessionHistory[window.sessionHistory.length - 1];
            const currentSession = {
                questions: window.sessionStats.questionsAnswered,
                correct: window.sessionStats.correctAnswers,
                xp: window.sessionStats.xpEarned
            };

            return {
                questionsDiff: currentSession.questions - (lastSession.questions || 0),
                correctDiff: currentSession.correct - (lastSession.correct || 0),
                xpDiff: currentSession.xp - (lastSession.xp || 0)
            };
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            initStreakCalendar();
            loadSessionHistory();
        });

        // Hook into answer tracking
        const originalHandleAnswer5 = window.handleQuestionAnswer;
        window.handleQuestionAnswer = function(isCorrect, questionElement, questionType) {
            if (originalHandleAnswer5) {
                originalHandleAnswer5(isCorrect, questionElement, questionType);
            }

            // Mark today as practiced
            markTodayAsPracticed();

            // Check for bonus event
            checkBonusEvent();

            // Show fun fact occasionally (every 10 questions, 30% chance)
            if (window.gamificationState?.totalAttempts % 10 === 0 && Math.random() < 0.3) {
                setTimeout(showFunFact, 1500);
            }

            // Apply bonus event multiplier if active
            if (window.bonusEvents.active && isCorrect) {
                const bonusXP = Math.round(window.GAMIFICATION_CONFIG.XP_PER_CORRECT * (window.bonusEvents.active.multiplier - 1));
                if (bonusXP > 0 && window.addXP) {
                    addXP(bonusXP, `${window.bonusEvents.active.name} Bonus`);
                }
            }
        };

        // Save session on page unload
        window.addEventListener('beforeunload', () => {
            if (window.sessionStats.questionsAnswered > 0) {
                saveSessionToHistory();
            }
        });

        console.log(' Streak calendar, bonus events, and fun facts loaded!');
    </script>

    <!-- Avatar, Quest, Shortcuts, and Enhanced Confetti System -->
    <script>
        // =====================================================
        // AVATAR/PROFILE CUSTOMIZATION SYSTEM
        // =====================================================
        window.AVATAR_OPTIONS = [
            '', '', '', '', '',
            '', '', '', '', '',
            '', '', '', '', '',
            '', '', '', '', '',
            '', '', '', '', ''
        ];

        window.TITLE_LEVELS = [
            { level: 1, title: 'Science Beginner' },
            { level: 2, title: 'Curious Explorer' },
            { level: 3, title: 'Knowledge Seeker' },
            { level: 4, title: 'Science Scholar' },
            { level: 5, title: 'Research Expert' },
            { level: 6, title: 'Lab Master' },
            { level: 7, title: 'Science Champion' },
            { level: 8, title: 'Quantum Genius' },
            { level: 9, title: 'Nobel Candidate' },
            { level: 10, title: 'Science Legend' }
        ];

        window.userProfile = {
            avatar: '',
            name: 'Student',
            title: 'Science Explorer'
        };

        window.loadUserProfile = function() {
            const stored = localStorage.getItem('userProfile');
            if (stored) {
                try {
                    window.userProfile = JSON.parse(stored);
                    updateProfileDisplay();
                } catch (e) {}
            }
            // Get student name from auth if available
            if (typeof currentUser !== 'undefined' && currentUser) {
                const studentName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Student';
                window.userProfile.name = studentName;
                updateProfileDisplay();
            }
        };

        window.saveUserProfile = function() {
            localStorage.setItem('userProfile', JSON.stringify(window.userProfile));
        };

        window.updateProfileDisplay = function() {
            const avatarEl = document.getElementById('user-avatar');
            const nameEl = document.getElementById('profile-name');
            const titleEl = document.getElementById('profile-title');

            if (avatarEl) avatarEl.textContent = window.userProfile.avatar;
            if (nameEl) nameEl.textContent = window.userProfile.name;
            if (titleEl) titleEl.textContent = window.userProfile.title;

            // Update title based on level
            if (window.gamificationState) {
                const levelData = window.TITLE_LEVELS.find(t => t.level === window.gamificationState.level);
                if (levelData) {
                    window.userProfile.title = levelData.title;
                    if (titleEl) titleEl.textContent = levelData.title;
                }
            }
        };

        window.showAvatarSelector = function() {
            // Remove existing
            document.querySelectorAll('.avatar-selector-modal, .modal-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';
            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };

            const modal = document.createElement('div');
            modal.className = 'avatar-selector-modal';
            modal.innerHTML = `
                <h2 style="margin: 0 0 10px 0; font-size: 1.5rem; text-align: center;"> Choose Your Avatar</h2>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Select an avatar to represent you on your science journey!</p>
                <div class="avatar-grid">
                    ${window.AVATAR_OPTIONS.map(avatar => `
                        <div class="avatar-option ${avatar === window.userProfile.avatar ? 'selected' : ''}"
                             onclick="selectAvatar('${avatar}')">${avatar}</div>
                    `).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="document.querySelectorAll('.avatar-selector-modal, .modal-backdrop').forEach(el => el.remove());"
                            style="padding: 12px 30px; border-radius: 25px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; cursor: pointer;">
                        Done
                    </button>
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.selectAvatar = function(avatar) {
            window.userProfile.avatar = avatar;
            saveUserProfile();
            updateProfileDisplay();

            // Update selected state in modal
            document.querySelectorAll('.avatar-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.textContent === avatar) opt.classList.add('selected');
            });

            // Show confirmation
            if (window.showToast) showToast('Avatar updated!', 'success');
        };

        // =====================================================
        // QUEST/STORYLINE PROGRESSION SYSTEM
        // =====================================================
        window.QUEST_CHAPTERS = [
            {
                id: 1, name: 'The Beginning',
                description: 'Every scientist starts somewhere. Begin your journey!',
                objectives: [
                    { id: 'q1_obj1', text: 'Answer 5 questions correctly', target: 5, type: 'correct' },
                    { id: 'q1_obj2', text: 'Try 2 different topics', target: 2, type: 'topics' }
                ],
                reward: { xp: 100, badge: '' }
            },
            {
                id: 2, name: 'Building Foundations',
                description: 'Strengthen your scientific knowledge base.',
                objectives: [
                    { id: 'q2_obj1', text: 'Complete 15 questions', target: 15, type: 'total' },
                    { id: 'q2_obj2', text: 'Achieve 70% accuracy', target: 70, type: 'accuracy' },
                    { id: 'q2_obj3', text: 'Build a 3-day streak', target: 3, type: 'streak' }
                ],
                reward: { xp: 200, badge: '' }
            },
            {
                id: 3, name: 'The Experimenter',
                description: 'A true scientist experiments with many topics!',
                objectives: [
                    { id: 'q3_obj1', text: 'Try 5 different topics', target: 5, type: 'topics' },
                    { id: 'q3_obj2', text: 'Answer 30 questions', target: 30, type: 'total' },
                    { id: 'q3_obj3', text: 'Get 5 questions right in a row', target: 5, type: 'streak_correct' }
                ],
                reward: { xp: 300, badge: '' }
            },
            {
                id: 4, name: 'Rising Star',
                description: 'You\'re becoming a science star!',
                objectives: [
                    { id: 'q4_obj1', text: 'Complete 50 questions', target: 50, type: 'total' },
                    { id: 'q4_obj2', text: 'Achieve 80% accuracy', target: 80, type: 'accuracy' },
                    { id: 'q4_obj3', text: 'Unlock 5 achievements', target: 5, type: 'achievements' }
                ],
                reward: { xp: 500, badge: '' }
            },
            {
                id: 5, name: 'Science Master',
                description: 'The ultimate test of your scientific prowess!',
                objectives: [
                    { id: 'q5_obj1', text: 'Answer 100 questions', target: 100, type: 'total' },
                    { id: 'q5_obj2', text: 'Master 3 topics (90%+)', target: 3, type: 'mastery' },
                    { id: 'q5_obj3', text: 'Build a 7-day streak', target: 7, type: 'streak' }
                ],
                reward: { xp: 1000, badge: '' }
            }
        ];

        window.questProgress = {
            currentChapter: 1,
            objectiveProgress: {},
            completedChapters: []
        };

        window.loadQuestProgress = function() {
            const stored = localStorage.getItem('questProgress');
            if (stored) {
                try {
                    window.questProgress = JSON.parse(stored);
                } catch (e) {}
            }
            updateQuestDisplay();
        };

        window.saveQuestProgress = function() {
            localStorage.setItem('questProgress', JSON.stringify(window.questProgress));
        };

        window.updateQuestDisplay = function() {
            const quest = window.QUEST_CHAPTERS.find(q => q.id === window.questProgress.currentChapter);
            if (!quest) return;

            const nameEl = document.getElementById('quest-name');
            const chapterEl = document.getElementById('quest-chapter');
            const descEl = document.getElementById('quest-description');
            const objContainer = document.getElementById('quest-objectives');

            if (nameEl) nameEl.textContent = quest.name;
            if (chapterEl) chapterEl.textContent = `Ch. ${quest.id}`;
            if (descEl) descEl.textContent = quest.description;

            if (objContainer) {
                objContainer.innerHTML = quest.objectives.map((obj, i) => {
                    const progress = window.questProgress.objectiveProgress[obj.id] || 0;
                    const completed = progress >= obj.target;
                    return `
                        <div class="quest-objective ${completed ? 'completed' : ''}" id="quest-obj-${i + 1}">
                            <div class="quest-objective-check">${completed ? '' : ''}</div>
                            <span>${obj.text} (${Math.min(progress, obj.target)}/${obj.target})</span>
                        </div>
                    `;
                }).join('');
            }
        };

        window.checkQuestObjectives = function() {
            const quest = window.QUEST_CHAPTERS.find(q => q.id === window.questProgress.currentChapter);
            if (!quest) return;

            quest.objectives.forEach(obj => {
                let currentValue = 0;
                switch (obj.type) {
                    case 'correct':
                        currentValue = window.gamificationState?.totalCorrect || 0;
                        break;
                    case 'total':
                        currentValue = window.gamificationState?.totalAttempts || 0;
                        break;
                    case 'topics':
                        currentValue = Object.keys(window.topicMastery || {}).length;
                        break;
                    case 'accuracy':
                        currentValue = window.gamificationState?.totalAttempts > 0
                            ? Math.round((window.gamificationState.totalCorrect / window.gamificationState.totalAttempts) * 100)
                            : 0;
                        break;
                    case 'streak':
                        currentValue = parseInt(document.getElementById('login-days-display')?.textContent?.match(/\d+/) || 0);
                        break;
                    case 'streak_correct':
                        currentValue = window.gamificationState?.streak || 0;
                        break;
                    case 'achievements':
                        currentValue = window.gamificationState?.unlockedAchievements?.length || 0;
                        break;
                    case 'mastery':
                        currentValue = Object.values(window.topicMastery || {}).filter(m => m.percentage >= 90).length;
                        break;
                }
                window.questProgress.objectiveProgress[obj.id] = currentValue;
            });

            // Check if all objectives completed
            const allComplete = quest.objectives.every(obj =>
                (window.questProgress.objectiveProgress[obj.id] || 0) >= obj.target
            );

            if (allComplete && !window.questProgress.completedChapters.includes(quest.id)) {
                completeQuestChapter(quest);
            }

            saveQuestProgress();
            updateQuestDisplay();
        };

        window.completeQuestChapter = function(quest) {
            window.questProgress.completedChapters.push(quest.id);

            // Show celebration
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #FF9800, #F57C00);
                color: white;
                padding: 40px;
                border-radius: 24px;
                text-align: center;
                z-index: 10008;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
                animation: modalPop 0.5s ease;
            `;
            modal.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 15px;"></div>
                <h2 style="margin: 0 0 10px 0;">Chapter Complete!</h2>
                <h3 style="margin: 0 0 20px 0; opacity: 0.9;">"${quest.name}"</h3>
                <div style="background: rgba(255,255,255,0.2); padding: 15px 25px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="font-size: 1.2rem; font-weight: 600;">Rewards Earned</div>
                    <div style="font-size: 1.5rem; margin-top: 8px;">${quest.reward.badge} +${quest.reward.xp} XP</div>
                </div>
                <button onclick="this.parentElement.remove(); advanceToNextChapter();"
                        style="padding: 12px 30px; border-radius: 25px; border: none; background: white; color: #FF9800; font-weight: 700; cursor: pointer; font-size: 1rem;">
                    Continue to Chapter ${quest.id + 1} 
                </button>
            `;

            document.body.appendChild(modal);
            if (window.triggerCelebration) triggerCelebration();
            if (window.addXP) addXP(quest.reward.xp, `Chapter ${quest.id} Complete`);
        };

        window.advanceToNextChapter = function() {
            if (window.questProgress.currentChapter < window.QUEST_CHAPTERS.length) {
                window.questProgress.currentChapter++;
                saveQuestProgress();
                updateQuestDisplay();
                if (window.showToast) showToast(`Chapter ${window.questProgress.currentChapter} started!`, 'success');
            }
        };

        window.showQuestDetails = function() {
            const quest = window.QUEST_CHAPTERS.find(q => q.id === window.questProgress.currentChapter);
            if (!quest) return;

            // Remove existing
            document.querySelectorAll('.quest-details-modal, .modal-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';
            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };

            const modal = document.createElement('div');
            modal.className = 'quest-details-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 24px;
                padding: 30px;
                max-width: 450px;
                width: 90%;
                z-index: 10006;
                box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            `;
            modal.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3rem;"></div>
                    <h2 style="margin: 10px 0 5px 0; color: #FF9800;">Chapter ${quest.id}: ${quest.name}</h2>
                    <p style="color: #666; margin: 0;">${quest.description}</p>
                </div>
                <div style="background: #FFF3E0; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <div style="font-weight: 600; color: #E65100; margin-bottom: 10px;">Objectives:</div>
                    ${quest.objectives.map(obj => {
                        const progress = window.questProgress.objectiveProgress[obj.id] || 0;
                        const completed = progress >= obj.target;
                        return `
                            <div style="display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #FFE0B2;">
                                <span style="color: ${completed ? '#4CAF50' : '#FF9800'};">${completed ? '' : ''}</span>
                                <span style="flex: 1; ${completed ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${obj.text}</span>
                                <span style="font-weight: 600; color: #FF9800;">${Math.min(progress, obj.target)}/${obj.target}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="background: linear-gradient(135deg, #FF9800, #F57C00); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 0.9rem; margin-bottom: 5px;">Chapter Reward</div>
                    <div style="font-size: 1.5rem; font-weight: 700;">${quest.reward.badge} +${quest.reward.xp} XP</div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="document.querySelectorAll('.quest-details-modal, .modal-backdrop').forEach(el => el.remove());"
                            style="padding: 12px 30px; border-radius: 25px; border: none; background: #FF9800; color: white; font-weight: 600; cursor: pointer;">
                        Keep Questing!
                    </button>
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        // =====================================================
        // KEYBOARD SHORTCUTS GUIDE
        // =====================================================
        window.KEYBOARD_SHORTCUTS = [
            { action: 'Toggle Dark Mode', keys: ['Alt', 'D'] },
            { action: 'Quick Help', keys: ['Alt', 'H'] },
            { action: 'Show Keyboard Shortcuts', keys: ['Alt', 'K'] },
            { action: 'Next Question', keys: ['Alt', 'N'] },
            { action: 'Submit Answer', keys: ['Enter'] },
            { action: 'Toggle Practice Mode', keys: ['Alt', 'P'] },
            { action: 'Show Achievements', keys: ['Alt', 'A'] },
            { action: 'Focus Search', keys: ['Ctrl', 'K'] }
        ];

        window.showKeyboardShortcuts = function() {
            // Remove existing
            document.querySelectorAll('.shortcuts-modal, .modal-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';
            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };

            const modal = document.createElement('div');
            modal.className = 'shortcuts-modal';
            modal.innerHTML = `
                <h2 style="margin: 0 0 10px 0; text-align: center; font-size: 1.5rem;"> Keyboard Shortcuts</h2>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Speed up your learning with these handy shortcuts!</p>
                <div class="shortcut-list">
                    ${window.KEYBOARD_SHORTCUTS.map(shortcut => `
                        <div class="shortcut-item">
                            <span class="shortcut-action">${shortcut.action}</span>
                            <div class="shortcut-keys">
                                ${shortcut.keys.map(key => `<span class="key">${key}</span>`).join(' + ')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="document.querySelectorAll('.shortcuts-modal, .modal-backdrop').forEach(el => el.remove());"
                            style="padding: 12px 30px; border-radius: 25px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; cursor: pointer;">
                        Got It!
                    </button>
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        // Add keyboard shortcut listener
        document.addEventListener('keydown', (e) => {
            if (e.altKey && e.key.toLowerCase() === 'k') {
                e.preventDefault();
                showKeyboardShortcuts();
            }
            if (e.altKey && e.key.toLowerCase() === 'a') {
                e.preventDefault();
                if (window.showAchievementsModal) showAchievementsModal();
            }
            if (e.altKey && e.key.toLowerCase() === 'n') {
                e.preventDefault();
                document.querySelector('.next-btn:not(.hidden)')?.click();
            }
            if (e.altKey && e.key.toLowerCase() === 'p') {
                e.preventDefault();
                if (window.switchTab) switchTab('practice');
            }
        });

        // =====================================================
        // SOCIAL SHARING FOR ACHIEVEMENTS
        // =====================================================
        window.shareAchievement = function(achievement) {
            // Remove existing
            document.querySelectorAll('.share-achievement-modal, .modal-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10006;';
            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };

            const shareText = ` I just unlocked the "${achievement.name}" achievement on Science CER! ${achievement.icon} #ScienceLearning #Achievement`;

            const modal = document.createElement('div');
            modal.className = 'share-achievement-modal';
            modal.innerHTML = `
                <h2 style="margin: 0 0 20px 0; text-align: center;"> Share Your Achievement!</h2>
                <div class="share-preview-card">
                    <div style="font-size: 4rem; margin-bottom: 10px;">${achievement.icon}</div>
                    <div style="font-size: 1.3rem; font-weight: 700;">${achievement.name}</div>
                    <div style="opacity: 0.9; margin-top: 5px;">${achievement.description}</div>
                </div>
                <div class="share-buttons">
                    <button class="share-btn copy" onclick="copyAchievementText('${shareText.replace(/'/g, "\\'")}')">
                         Copy Text
                    </button>
                    <button class="share-btn download" onclick="downloadAchievementCard('${achievement.icon}', '${achievement.name}')">
                         Save Image
                    </button>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="document.querySelectorAll('.share-achievement-modal, .modal-backdrop').forEach(el => el.remove());"
                            style="padding: 10px 25px; border-radius: 20px; border: 1px solid #ddd; background: white; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.copyAchievementText = function(text) {
            navigator.clipboard.writeText(text).then(() => {
                if (window.showToast) showToast('Copied to clipboard!', 'success');
            }).catch(() => {
                if (window.showToast) showToast('Could not copy text', 'error');
            });
        };

        window.downloadAchievementCard = function(icon, name) {
            // Create a simple canvas-based share card
            const canvas = document.createElement('canvas');
            canvas.width = 600;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');

            // Background gradient
            const gradient = ctx.createLinearGradient(0, 0, 600, 400);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 600, 400);

            // Icon
            ctx.font = '80px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(icon, 300, 150);

            // Achievement name
            ctx.fillStyle = 'white';
            ctx.font = 'bold 32px Arial';
            ctx.fillText(name, 300, 220);

            // App name
            ctx.font = '20px Arial';
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fillText('Unlocked on Science CER', 300, 280);

            // Download
            const link = document.createElement('a');
            link.download = `achievement-${name.replace(/\s+/g, '-').toLowerCase()}.png`;
            link.href = canvas.toDataURL();
            link.click();

            if (window.showToast) showToast('Achievement card saved!', 'success');
        };

        // =====================================================
        // ENHANCED CONFETTI BURST
        // =====================================================
        window.triggerEpicConfetti = function(x, y) {
            const container = document.createElement('div');
            container.className = 'epic-achievement-burst';

            const emojis = ['', '', '', '', '', '', '', '', '', ''];
            const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#95E1D3', '#F38181', '#AA96DA'];

            // Create 50 confetti pieces
            for (let i = 0; i < 50; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-burst';
                piece.style.left = (x || window.innerWidth / 2) + 'px';
                piece.style.top = (y || window.innerHeight / 2) + 'px';

                const angle = (Math.random() * 360) * (Math.PI / 180);
                const distance = 100 + Math.random() * 300;
                const xDist = Math.cos(angle) * distance;
                const yDist = Math.sin(angle) * distance - 100;

                piece.style.setProperty('--x', xDist + 'px');
                piece.style.setProperty('--y', yDist + 'px');

                if (Math.random() > 0.5) {
                    piece.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                } else {
                    piece.textContent = '';
                    piece.style.color = colors[Math.floor(Math.random() * colors.length)];
                    piece.style.fontSize = (8 + Math.random() * 12) + 'px';
                }

                piece.style.animationDelay = (Math.random() * 0.3) + 's';
                container.appendChild(piece);
            }

            document.body.appendChild(container);
            setTimeout(() => container.remove(), 2000);
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfile();
            loadQuestProgress();

            // Check quest objectives periodically
            setInterval(checkQuestObjectives, 5000);
        });

        // Hook into answer tracking for quest progress
        const originalHandleAnswer6 = window.handleQuestionAnswer;
        window.handleQuestionAnswer = function(isCorrect, questionElement, questionType) {
            if (originalHandleAnswer6) {
                originalHandleAnswer6(isCorrect, questionElement, questionType);
            }
            checkQuestObjectives();
        };

        // Hook into achievement unlocks for sharing
        const originalUnlockAchievement = window.unlockAchievement;
        window.unlockAchievement = function(achievementId) {
            if (originalUnlockAchievement) {
                const result = originalUnlockAchievement(achievementId);

                // Trigger epic confetti for achievements
                if (result && window.GAMIFICATION_CONFIG?.ACHIEVEMENTS) {
                    const achievement = window.GAMIFICATION_CONFIG.ACHIEVEMENTS.find(a => a.id === achievementId);
                    if (achievement) {
                        setTimeout(() => triggerEpicConfetti(), 500);
                    }
                }
                return result;
            }
        };

        console.log(' Avatar, Quest, Shortcuts, and Enhanced Confetti systems loaded!');
    </script>

    <!-- Auto-save, Bookmarks, Pet Companion, Mini Celebrations -->
    <script>
        // =====================================================
        // AUTO-SAVE DRAFT ANSWERS
        // =====================================================
        window.draftAnswers = {};

        window.saveDraftAnswer = function(questionId, inputElement) {
            const value = inputElement.value;
            if (!window.draftAnswers[questionId]) {
                window.draftAnswers[questionId] = {};
            }
            const inputIndex = Array.from(inputElement.closest('.answer-template, .question-container').querySelectorAll('input, textarea')).indexOf(inputElement);
            window.draftAnswers[questionId][inputIndex] = value;

            localStorage.setItem('draftAnswers', JSON.stringify(window.draftAnswers));
            showAutoSaveIndicator();
        };

        window.loadDraftAnswers = function() {
            const stored = localStorage.getItem('draftAnswers');
            if (stored) {
                try {
                    window.draftAnswers = JSON.parse(stored);
                } catch (e) {}
            }
        };

        window.restoreDraftAnswers = function(questionId) {
            if (!window.draftAnswers[questionId]) return;

            const container = document.querySelector(`[id*="${questionId}"]`) ||
                              document.querySelector(`.question-container:has(input)`);
            if (!container) return;

            const inputs = container.querySelectorAll('input:not([type="submit"]):not([type="button"]), textarea');
            Object.entries(window.draftAnswers[questionId]).forEach(([index, value]) => {
                if (inputs[parseInt(index)]) {
                    inputs[parseInt(index)].value = value;
                }
            });
        };

        window.showAutoSaveIndicator = function() {
            // Remove existing indicator
            document.querySelectorAll('.autosave-indicator').forEach(el => el.remove());

            const indicator = document.createElement('div');
            indicator.className = 'autosave-indicator';
            indicator.innerHTML = '<span></span> Draft saved';
            document.body.appendChild(indicator);

            setTimeout(() => indicator.remove(), 2000);
        };

        window.clearDraftForQuestion = function(questionId) {
            delete window.draftAnswers[questionId];
            localStorage.setItem('draftAnswers', JSON.stringify(window.draftAnswers));
        };

        // Add auto-save listeners to all inputs
        document.addEventListener('input', (e) => {
            if (e.target.matches('.answer-input, .cer-input, textarea')) {
                const questionContainer = e.target.closest('.question-container');
                if (questionContainer) {
                    const questionId = questionContainer.id || 'unknown';
                    saveDraftAnswer(questionId, e.target);
                }
            }
        });

        // =====================================================
        // QUESTION BOOKMARKING SYSTEM
        // =====================================================
        window.bookmarkedQuestions = [];

        window.loadBookmarks = function() {
            const stored = localStorage.getItem('bookmarkedQuestions');
            if (stored) {
                try {
                    window.bookmarkedQuestions = JSON.parse(stored);
                } catch (e) {}
            }
        };

        window.saveBookmarks = function() {
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(window.bookmarkedQuestions));
        };

        window.toggleBookmark = function(questionId, questionTitle, questionType) {
            const index = window.bookmarkedQuestions.findIndex(b => b.id === questionId);

            if (index === -1) {
                window.bookmarkedQuestions.push({
                    id: questionId,
                    title: questionTitle || 'Question',
                    type: questionType || 'general',
                    addedAt: new Date().toISOString()
                });
                if (window.showToast) showToast('Question bookmarked!', 'success');
                triggerMiniCelebration('');
            } else {
                window.bookmarkedQuestions.splice(index, 1);
                if (window.showToast) showToast('Bookmark removed', 'info');
            }

            saveBookmarks();
            updateBookmarkButtons();
        };

        window.isBookmarked = function(questionId) {
            return window.bookmarkedQuestions.some(b => b.id === questionId);
        };

        window.updateBookmarkButtons = function() {
            document.querySelectorAll('.bookmark-btn').forEach(btn => {
                const questionId = btn.dataset.questionId;
                if (isBookmarked(questionId)) {
                    btn.classList.add('bookmarked');
                    btn.textContent = '';
                } else {
                    btn.classList.remove('bookmarked');
                    btn.textContent = '';
                }
            });
        };

        window.showBookmarksPanel = function() {
            // Remove existing panel
            document.querySelectorAll('.bookmarks-panel, .bookmarks-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'bookmarks-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 10003;';
            backdrop.onclick = () => { backdrop.remove(); panel.remove(); };

            const panel = document.createElement('div');
            panel.className = 'bookmarks-panel open';
            panel.innerHTML = `
                <div class="bookmarks-header">
                    <h2 style="margin: 0; font-size: 1.3rem;"> My Bookmarks</h2>
                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">${window.bookmarkedQuestions.length} saved questions</p>
                </div>
                <div class="bookmarks-list">
                    ${window.bookmarkedQuestions.length === 0 ? `
                        <div style="text-align: center; padding: 40px 20px; color: #999;">
                            <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                            <p>No bookmarks yet!</p>
                            <p style="font-size: 0.85rem;">Click the bookmark icon on any question to save it here.</p>
                        </div>
                    ` : window.bookmarkedQuestions.map(bookmark => `
                        <div class="bookmark-item" onclick="goToBookmarkedQuestion('${bookmark.id}')">
                            <div style="font-weight: 600; margin-bottom: 5px;">${bookmark.title}</div>
                            <div style="font-size: 0.8rem; color: #666; display: flex; justify-content: space-between;">
                                <span>${bookmark.type}</span>
                                <span>${new Date(bookmark.addedAt).toLocaleDateString()}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="padding: 15px; border-top: 1px solid #eee;">
                    <button onclick="clearAllBookmarks()" style="width: 100%; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; color: #666;">
                        Clear All Bookmarks
                    </button>
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(panel);
        };

        window.goToBookmarkedQuestion = function(questionId) {
            document.querySelectorAll('.bookmarks-panel, .bookmarks-backdrop').forEach(el => el.remove());
            const questionEl = document.getElementById(questionId);
            if (questionEl) {
                questionEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                questionEl.style.animation = 'highlightQuestion 1s ease';
            }
        };

        window.clearAllBookmarks = function() {
            if (confirm('Clear all bookmarks?')) {
                window.bookmarkedQuestions = [];
                saveBookmarks();
                showBookmarksPanel();
                if (window.showToast) showToast('All bookmarks cleared', 'info');
            }
        };

        // =====================================================
        // PET COMPANION SYSTEM
        // =====================================================
        window.PET_OPTIONS = [
            { id: 'fox', emoji: '', name: 'Foxie' },
            { id: 'panda', emoji: '', name: 'Bambi' },
            { id: 'cat', emoji: '', name: 'Whiskers' },
            { id: 'dog', emoji: '', name: 'Buddy' },
            { id: 'owl', emoji: '', name: 'Wise' },
            { id: 'robot', emoji: '', name: 'Spark' }
        ];

        window.PET_MESSAGES = {
            idle: [
                "Keep up the great work! ",
                "You're doing amazing! ",
                "Science is so cool, right? ",
                "I believe in you! ",
                "Ready for the next question? "
            ],
            correct: [
                "Yay! That's correct! ",
                "You're so smart! ",
                "Amazing job! Keep it up! ",
                "Woohoo! Nailed it! ",
                "You're on fire! "
            ],
            incorrect: [
                "Don't worry, try again! ",
                "You've got this! Keep trying! ",
                "Learning from mistakes makes us stronger! ",
                "Almost there! Give it another shot! ",
                "Every attempt makes you better! "
            ],
            streak: [
                "Wow, what a streak! ",
                "You're unstoppable! ",
                "Keep the streak going! ",
                "On fire! Nothing can stop you! "
            ],
            milestone: [
                "You've reached a new milestone! ",
                "Incredible progress! ",
                "You're becoming a science master! "
            ]
        };

        window.petCompanion = {
            active: true,
            currentPet: 'fox',
            lastMessage: null
        };

        window.loadPetSettings = function() {
            const stored = localStorage.getItem('petCompanion');
            if (stored) {
                try {
                    window.petCompanion = JSON.parse(stored);
                } catch (e) {}
            }
        };

        window.savePetSettings = function() {
            localStorage.setItem('petCompanion', JSON.stringify(window.petCompanion));
        };

        window.initPetCompanion = function() {
            if (!window.petCompanion.active) return;

            // Remove existing pet
            document.querySelectorAll('.pet-companion').forEach(el => el.remove());

            const pet = window.PET_OPTIONS.find(p => p.id === window.petCompanion.currentPet) || window.PET_OPTIONS[0];

            const petEl = document.createElement('div');
            petEl.className = 'pet-companion';
            petEl.id = 'pet-companion';
            petEl.textContent = pet.emoji;
            petEl.onclick = () => showPetMenu();
            document.body.appendChild(petEl);

            // Show random idle message periodically
            setInterval(() => {
                if (Math.random() < 0.3 && !document.querySelector('.pet-speech-bubble')) {
                    showPetMessage('idle');
                }
            }, 60000); // Every minute

            // Show initial message after 5 seconds
            setTimeout(() => showPetMessage('idle'), 5000);
        };

        window.showPetMessage = function(type, duration = 5000) {
            // Remove existing bubble
            document.querySelectorAll('.pet-speech-bubble').forEach(el => el.remove());

            const messages = window.PET_MESSAGES[type] || window.PET_MESSAGES.idle;
            const message = messages[Math.floor(Math.random() * messages.length)];

            const bubble = document.createElement('div');
            bubble.className = 'pet-speech-bubble';
            bubble.innerHTML = `<div class="pet-speech-text">${message}</div>`;
            document.body.appendChild(bubble);

            setTimeout(() => {
                if (bubble.parentElement) {
                    bubble.style.animation = 'bubbleAppear 0.3s ease reverse forwards';
                    setTimeout(() => bubble.remove(), 300);
                }
            }, duration);
        };

        window.showPetMenu = function() {
            // Remove existing
            document.querySelectorAll('.pet-menu-modal, .modal-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';
            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };

            const currentPet = window.PET_OPTIONS.find(p => p.id === window.petCompanion.currentPet) || window.PET_OPTIONS[0];

            const modal = document.createElement('div');
            modal.className = 'pet-menu-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 24px;
                padding: 30px;
                max-width: 400px;
                width: 90%;
                z-index: 10006;
                box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
                animation: modalPop 0.4s ease;
            `;
            modal.innerHTML = `
                <h2 style="margin: 0 0 10px 0; text-align: center;"> Your Study Buddy</h2>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Choose a companion to encourage you!</p>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    ${window.PET_OPTIONS.map(pet => `
                        <div onclick="selectPet('${pet.id}')" style="
                            background: ${pet.id === currentPet.id ? 'linear-gradient(135deg, #FFE0B2, #FFCC80)' : '#f5f5f5'};
                            border-radius: 16px;
                            padding: 20px;
                            text-align: center;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            border: 3px solid ${pet.id === currentPet.id ? '#FF9800' : 'transparent'};
                        ">
                            <div style="font-size: 2.5rem; margin-bottom: 8px;">${pet.emoji}</div>
                            <div style="font-weight: 600; font-size: 0.9rem;">${pet.name}</div>
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="togglePetActive()" style="flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ddd; background: ${window.petCompanion.active ? '#f5f5f5' : '#4CAF50'}; color: ${window.petCompanion.active ? '#666' : 'white'}; cursor: pointer; font-weight: 600;">
                        ${window.petCompanion.active ? 'Hide Pet' : 'Show Pet'}
                    </button>
                    <button onclick="document.querySelectorAll('.pet-menu-modal, .modal-backdrop').forEach(el => el.remove());" style="flex: 1; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #FF9800, #F57C00); color: white; cursor: pointer; font-weight: 600;">
                        Done
                    </button>
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.selectPet = function(petId) {
            window.petCompanion.currentPet = petId;
            savePetSettings();
            initPetCompanion();

            // Close modal
            document.querySelectorAll('.pet-menu-modal, .modal-backdrop').forEach(el => el.remove());

            const pet = window.PET_OPTIONS.find(p => p.id === petId);
            if (window.showToast) showToast(`${pet.emoji} ${pet.name} is now your study buddy!`, 'success');
        };

        window.togglePetActive = function() {
            window.petCompanion.active = !window.petCompanion.active;
            savePetSettings();

            if (window.petCompanion.active) {
                initPetCompanion();
            } else {
                document.querySelectorAll('.pet-companion, .pet-speech-bubble').forEach(el => el.remove());
            }

            // Update modal
            document.querySelectorAll('.pet-menu-modal, .modal-backdrop').forEach(el => el.remove());
            if (window.showToast) showToast(window.petCompanion.active ? 'Pet companion enabled!' : 'Pet companion hidden', 'info');
        };

        // =====================================================
        // MINI CELEBRATION ANIMATIONS
        // =====================================================
        window.triggerMiniCelebration = function(emoji = '', x, y) {
            const element = document.createElement('div');
            element.className = 'mini-celebration';
            element.textContent = emoji;
            element.style.left = (x || window.innerWidth / 2) + 'px';
            element.style.top = (y || window.innerHeight / 2) + 'px';

            document.body.appendChild(element);
            setTimeout(() => element.remove(), 1000);
        };

        window.showAnswerFeedback = function(isCorrect, element, hint = '') {
            // Remove existing feedback
            element.querySelectorAll('.error-feedback, .success-feedback').forEach(el => el.remove());

            const feedback = document.createElement('div');
            feedback.className = isCorrect ? 'success-feedback' : 'error-feedback';

            if (isCorrect) {
                feedback.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; color: #2E7D32;">
                        <span style="font-size: 1.5rem;"></span>
                        <span style="font-weight: 600;">Great job! That's correct!</span>
                    </div>
                `;
                triggerMiniCelebration('', element.getBoundingClientRect().x + element.offsetWidth / 2, element.getBoundingClientRect().y);
            } else {
                feedback.innerHTML = `
                    <div class="error-feedback-header">
                        <span style="font-size: 1.3rem;"></span>
                        <span>Not quite right - let's try again!</span>
                    </div>
                    ${hint ? `<div class="error-feedback-hint"><strong>Hint:</strong> ${hint}</div>` : ''}
                `;
            }

            element.appendChild(feedback);

            // Auto-remove after delay
            setTimeout(() => {
                if (feedback.parentElement) {
                    feedback.style.opacity = '0';
                    feedback.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => feedback.remove(), 300);
                }
            }, 5000);
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadDraftAnswers();
            loadBookmarks();
            loadPetSettings();
            initPetCompanion();
        });

        // Hook into answer handling for pet messages
        const originalHandleAnswer7 = window.handleQuestionAnswer;
        window.handleQuestionAnswer = function(isCorrect, questionElement, questionType) {
            if (originalHandleAnswer7) {
                originalHandleAnswer7(isCorrect, questionElement, questionType);
            }

            // Show pet message based on result
            if (window.petCompanion.active) {
                if (isCorrect) {
                    showPetMessage('correct');

                    // Check for streak messages
                    if (window.gamificationState?.streak >= 3) {
                        setTimeout(() => showPetMessage('streak'), 3000);
                    }
                } else {
                    showPetMessage('incorrect');
                }
            }

            // Clear draft for answered question
            if (questionElement) {
                const questionId = questionElement.id;
                if (questionId) clearDraftForQuestion(questionId);
            }
        };

        console.log(' Auto-save, Bookmarks, Pet Companion, and Mini Celebrations loaded!');
    </script>

    <!-- Lucky Wheel, Daily Rewards, Sound Toggle, Lazy Loading -->
    <script>
        // =====================================================
        // LUCKY WHEEL SPIN SYSTEM
        // =====================================================
        window.WHEEL_PRIZES = [
            { name: '+10 XP', xp: 10, emoji: '', color: '#4CAF50' },
            { name: '+25 XP', xp: 25, emoji: '', color: '#2196F3' },
            { name: '+50 XP', xp: 50, emoji: '', color: '#9C27B0' },
            { name: '+5 XP', xp: 5, emoji: '', color: '#FF9800' },
            { name: '+100 XP', xp: 100, emoji: '', color: '#E91E63' },
            { name: '+15 XP', xp: 15, emoji: '', color: '#00BCD4' },
            { name: '+75 XP', xp: 75, emoji: '', color: '#673AB7' },
            { name: '+20 XP', xp: 20, emoji: '', color: '#F44336' }
        ];

        window.luckyWheelState = {
            lastSpin: null,
            spinsToday: 0,
            maxSpinsPerDay: 3
        };

        window.loadLuckyWheelState = function() {
            const stored = localStorage.getItem('luckyWheelState');
            if (stored) {
                try {
                    const state = JSON.parse(stored);
                    const today = new Date().toDateString();
                    if (state.lastSpin === today) {
                        window.luckyWheelState = state;
                    }
                } catch (e) {}
            }
        };

        window.saveLuckyWheelState = function() {
            window.luckyWheelState.lastSpin = new Date().toDateString();
            localStorage.setItem('luckyWheelState', JSON.stringify(window.luckyWheelState));
        };

        window.canSpinWheel = function() {
            return window.luckyWheelState.spinsToday < window.luckyWheelState.maxSpinsPerDay;
        };

        window.showLuckyWheel = function() {
            if (!canSpinWheel()) {
                if (window.showToast) showToast('No more spins today! Come back tomorrow!', 'info');
                return;
            }

            // Remove existing
            document.querySelectorAll('.lucky-wheel-container, .modal-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10009;';

            const container = document.createElement('div');
            container.className = 'lucky-wheel-container';

            // Create wheel segments with conic gradient
            const colors = window.WHEEL_PRIZES.map(p => p.color);
            const segmentAngle = 360 / window.WHEEL_PRIZES.length;
            let gradientStops = [];
            colors.forEach((color, i) => {
                const start = i * segmentAngle;
                const end = (i + 1) * segmentAngle;
                gradientStops.push(`${color} ${start}deg ${end}deg`);
            });

            container.innerHTML = `
                <h2 style="margin: 0 0 10px 0; font-size: 1.5rem;"> Lucky Wheel!</h2>
                <p style="color: #666; margin-bottom: 15px;">Spins remaining today: ${window.luckyWheelState.maxSpinsPerDay - window.luckyWheelState.spinsToday}</p>
                <div class="wheel-wrapper">
                    <div class="wheel-pointer"></div>
                    <div class="wheel" id="lucky-wheel" style="background: conic-gradient(${gradientStops.join(', ')});">
                        ${window.WHEEL_PRIZES.map((prize, i) => {
                            const angle = i * segmentAngle + segmentAngle / 2;
                            return `<div style="position: absolute; top: 50%; left: 50%; transform: rotate(${angle}deg) translateY(-60px); transform-origin: 0 0; color: white; font-weight: 700; font-size: 1.2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">${prize.emoji}</div>`;
                        }).join('')}
                    </div>
                </div>
                <button class="spin-btn" id="spin-btn" onclick="spinWheel()"> SPIN!</button>
                <p style="margin-top: 15px;">
                    <button onclick="document.querySelectorAll('.lucky-wheel-container, .modal-backdrop').forEach(el => el.remove());" style="background: none; border: none; color: #666; cursor: pointer; font-size: 0.9rem;">Close</button>
                </p>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(container);
        };

        window.spinWheel = function() {
            if (!canSpinWheel()) return;

            const wheel = document.getElementById('lucky-wheel');
            const spinBtn = document.getElementById('spin-btn');
            if (!wheel || !spinBtn) return;

            spinBtn.disabled = true;

            // Random prize selection
            const prizeIndex = Math.floor(Math.random() * window.WHEEL_PRIZES.length);
            const prize = window.WHEEL_PRIZES[prizeIndex];

            // Calculate spin angle
            const segmentAngle = 360 / window.WHEEL_PRIZES.length;
            const targetAngle = 360 - (prizeIndex * segmentAngle + segmentAngle / 2);
            const spins = 5 + Math.random() * 3; // 5-8 full rotations
            const finalAngle = spins * 360 + targetAngle;

            wheel.style.transform = `rotate(${finalAngle}deg)`;

            // Update state
            window.luckyWheelState.spinsToday++;
            saveLuckyWheelState();

            // Award prize after spin
            setTimeout(() => {
                if (window.addXP) addXP(prize.xp, 'Lucky Wheel');
                if (window.triggerCelebration) triggerCelebration();

                // Show result
                const result = document.createElement('div');
                result.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, ${prize.color}, ${prize.color}dd);
                    color: white;
                    padding: 40px;
                    border-radius: 24px;
                    text-align: center;
                    z-index: 10011;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
                    animation: modalPop 0.5s ease;
                `;
                result.innerHTML = `
                    <div style="font-size: 4rem; margin-bottom: 15px;">${prize.emoji}</div>
                    <h2 style="margin: 0 0 10px 0;">You Won!</h2>
                    <div style="font-size: 2rem; font-weight: 700;">${prize.name}</div>
                    <button onclick="this.parentElement.remove(); document.querySelectorAll('.lucky-wheel-container, .modal-backdrop').forEach(el => el.remove());"
                            style="margin-top: 25px; padding: 12px 30px; border-radius: 25px; border: none; background: white; color: ${prize.color}; font-weight: 700; cursor: pointer;">
                        Awesome! 
                    </button>
                `;
                document.body.appendChild(result);
            }, 4500);
        };

        // =====================================================
        // DAILY LOGIN REWARDS SYSTEM
        // =====================================================
        window.DAILY_REWARDS = [
            { day: 1, prize: '', xp: 10, name: '10 XP' },
            { day: 2, prize: '', xp: 15, name: '15 XP' },
            { day: 3, prize: '', xp: 20, name: '20 XP' },
            { day: 4, prize: '', xp: 25, name: '25 XP' },
            { day: 5, prize: '', xp: 30, name: '30 XP' },
            { day: 6, prize: '', xp: 40, name: '40 XP' },
            { day: 7, prize: '', xp: 100, name: '100 XP + Spin' }
        ];

        window.loginRewardsState = {
            lastClaim: null,
            currentDay: 1,
            claimedDays: []
        };

        window.loadLoginRewards = function() {
            const stored = localStorage.getItem('loginRewardsState');
            if (stored) {
                try {
                    window.loginRewardsState = JSON.parse(stored);
                } catch (e) {}
            }
        };

        window.saveLoginRewards = function() {
            localStorage.setItem('loginRewardsState', JSON.stringify(window.loginRewardsState));
        };

        window.checkDailyReward = function() {
            const today = new Date().toDateString();
            const lastClaim = window.loginRewardsState.lastClaim;

            if (lastClaim !== today) {
                // Check if we should reset streak
                if (lastClaim) {
                    const lastDate = new Date(lastClaim);
                    const diff = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));
                    if (diff > 1) {
                        // Reset streak if more than 1 day gap
                        window.loginRewardsState.currentDay = 1;
                        window.loginRewardsState.claimedDays = [];
                    }
                }
                showDailyRewardModal();
            }
        };

        window.showDailyRewardModal = function() {
            // Remove existing
            document.querySelectorAll('.login-rewards-modal, .modal-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10008;';

            const currentDay = window.loginRewardsState.currentDay;
            const todayReward = window.DAILY_REWARDS[currentDay - 1] || window.DAILY_REWARDS[0];

            const modal = document.createElement('div');
            modal.className = 'login-rewards-modal';
            modal.innerHTML = `
                <h2 style="margin: 0 0 10px 0; text-align: center; font-size: 1.5rem;"> Daily Login Reward!</h2>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Day ${currentDay} of 7 - Keep coming back for bigger rewards!</p>
                <div class="rewards-calendar">
                    ${window.DAILY_REWARDS.map(reward => {
                        const isClaimed = window.loginRewardsState.claimedDays.includes(reward.day);
                        const isToday = reward.day === currentDay;
                        const isLocked = reward.day > currentDay;
                        return `
                            <div class="reward-day ${isClaimed ? 'claimed' : ''} ${isToday ? 'today' : ''} ${isLocked ? 'locked' : ''}">
                                <div class="reward-day-num">Day ${reward.day}</div>
                                <div class="reward-day-prize">${reward.prize}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">${todayReward.prize}</div>
                    <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 20px;">${todayReward.name}</div>
                    <button onclick="claimDailyReward()" style="padding: 15px 40px; border-radius: 25px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 700; font-size: 1.1rem; cursor: pointer;">
                        Claim Reward! 
                    </button>
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.claimDailyReward = function() {
            const currentDay = window.loginRewardsState.currentDay;
            const reward = window.DAILY_REWARDS[currentDay - 1] || window.DAILY_REWARDS[0];

            // Award XP
            if (window.addXP) addXP(reward.xp, 'Daily Login Reward');

            // Update state
            window.loginRewardsState.lastClaim = new Date().toDateString();
            window.loginRewardsState.claimedDays.push(currentDay);
            window.loginRewardsState.currentDay = currentDay >= 7 ? 1 : currentDay + 1;
            saveLoginRewards();

            // Close modal
            document.querySelectorAll('.login-rewards-modal, .modal-backdrop').forEach(el => el.remove());

            // Celebrate
            if (window.triggerCelebration) triggerCelebration();
            if (window.showToast) showToast(`${reward.prize} ${reward.name} claimed!`, 'success');

            // Day 7 bonus: free spin
            if (currentDay === 7) {
                setTimeout(() => {
                    window.luckyWheelState.spinsToday = 0;
                    saveLuckyWheelState();
                    showLuckyWheel();
                }, 1000);
            }
        };

        // =====================================================
        // SOUND EFFECTS TOGGLE
        // =====================================================
        window.soundSettings = {
            enabled: true,
            volume: 0.5
        };

        window.loadSoundSettings = function() {
            const stored = localStorage.getItem('soundSettings');
            if (stored) {
                try {
                    window.soundSettings = JSON.parse(stored);
                } catch (e) {}
            }
            initSoundToggle();
        };

        window.saveSoundSettings = function() {
            localStorage.setItem('soundSettings', JSON.stringify(window.soundSettings));
        };

        window.initSoundToggle = function() {
            // Remove existing toggle
            document.querySelectorAll('.sound-toggle').forEach(el => el.remove());

            const toggle = document.createElement('div');
            toggle.className = `sound-toggle ${window.soundSettings.enabled ? '' : 'muted'}`;
            toggle.id = 'sound-toggle';
            toggle.textContent = window.soundSettings.enabled ? '' : '';
            toggle.onclick = toggleSound;
            toggle.title = 'Toggle sound effects';
            document.body.appendChild(toggle);
        };

        window.toggleSound = function() {
            window.soundSettings.enabled = !window.soundSettings.enabled;
            saveSoundSettings();

            const toggle = document.getElementById('sound-toggle');
            if (toggle) {
                toggle.textContent = window.soundSettings.enabled ? '' : '';
                toggle.classList.toggle('muted', !window.soundSettings.enabled);
            }

            if (window.showToast) {
                showToast(window.soundSettings.enabled ? 'Sound enabled' : 'Sound muted', 'info');
            }
        };

        window.playSound = function(type) {
            if (!window.soundSettings.enabled) return;

            // Use Web Audio API for simple sounds
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            const sounds = {
                correct: { freq: 880, duration: 0.1, type: 'sine' },
                incorrect: { freq: 220, duration: 0.2, type: 'sawtooth' },
                levelUp: { freq: 523.25, duration: 0.3, type: 'sine' },
                achievement: { freq: 659.25, duration: 0.4, type: 'sine' },
                click: { freq: 440, duration: 0.05, type: 'square' }
            };

            const sound = sounds[type] || sounds.click;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = sound.type;
            oscillator.frequency.setValueAtTime(sound.freq, audioContext.currentTime);

            gainNode.gain.setValueAtTime(window.soundSettings.volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + sound.duration);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + sound.duration);
        };

        // =====================================================
        // LAZY LOADING FOR IMAGES
        // =====================================================
        window.initLazyLoading = function() {
            const images = document.querySelectorAll('img[src]:not(.lazy-loaded)');

            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.classList.add('lazy-image');

                        // Add loaded class when image loads
                        img.onload = () => {
                            img.classList.add('loaded');
                            img.classList.add('lazy-loaded');
                        };

                        observer.unobserve(img);
                    }
                });
            }, { rootMargin: '50px' });

            images.forEach(img => imageObserver.observe(img));
        };

        // =====================================================
        // CONTEXTUAL HELP TOOLTIPS
        // =====================================================
        window.HELP_TOOLTIPS = {
            'xp-progress-container': 'Earn XP by answering questions. Level up to unlock new titles!',
            'daily-challenge-card': 'Complete daily challenges for bonus XP rewards!',
            'active-quest-card': 'Follow the quest storyline to become a Science Master!',
            'streak-bonus-card': 'Keep practicing daily to maintain your streak and earn bonus XP!',
            'profile-card': 'Click to customize your avatar and see your profile!',
            'mode-toggle': 'Switch between open-ended (OEQ) and multiple choice (MCQ) questions.'
        };

        window.showHelpTooltip = function(elementId, position = 'top') {
            const element = document.getElementById(elementId);
            const message = window.HELP_TOOLTIPS[elementId];
            if (!element || !message) return;

            // Remove existing tooltips
            document.querySelectorAll('.help-tooltip').forEach(el => el.remove());

            const tooltip = document.createElement('div');
            tooltip.className = `help-tooltip ${position}`;
            tooltip.textContent = message;

            // Position tooltip
            const rect = element.getBoundingClientRect();
            if (position === 'top') {
                tooltip.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
                tooltip.style.left = (rect.left + rect.width / 2) + 'px';
                tooltip.style.transform = 'translateX(-50%)';
            } else {
                tooltip.style.top = (rect.bottom + 10) + 'px';
                tooltip.style.left = (rect.left + rect.width / 2) + 'px';
                tooltip.style.transform = 'translateX(-50%)';
            }

            document.body.appendChild(tooltip);

            // Auto-remove
            setTimeout(() => {
                if (tooltip.parentElement) {
                    tooltip.style.opacity = '0';
                    tooltip.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => tooltip.remove(), 300);
                }
            }, 4000);
        };

        // Add hover listeners for help
        document.addEventListener('mouseenter', (e) => {
            const helpElement = e.target.closest('[data-help]');
            if (helpElement) {
                showHelpTooltip(helpElement.id, helpElement.dataset.helpPosition || 'top');
            }
        }, true);

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadLuckyWheelState();
            loadLoginRewards();
            loadSoundSettings();
            initLazyLoading();

            // Check for daily reward after a short delay
            setTimeout(checkDailyReward, 2000);
        });

        // Hook into gamification for sounds
        const originalAddXP2 = window.addXP;
        window.addXP = function(amount, reason) {
            if (originalAddXP2) {
                originalAddXP2(amount, reason);
            }
            if (reason?.includes('Level')) {
                playSound('levelUp');
            }
        };

        // Hook into answer handling for sounds
        const originalHandleAnswer8 = window.handleQuestionAnswer;
        window.handleQuestionAnswer = function(isCorrect, questionElement, questionType) {
            if (originalHandleAnswer8) {
                originalHandleAnswer8(isCorrect, questionElement, questionType);
            }
            playSound(isCorrect ? 'correct' : 'incorrect');
        };

        console.log(' Lucky Wheel, Daily Rewards, Sound Toggle, and Lazy Loading loaded!');
    </script>

    <!-- Collectible Badges, Session Progress, Focus Timer, Answer History -->
    <script>
        // =====================================================
        // COLLECTIBLE SCIENCE BADGES SYSTEM
        // =====================================================
        window.SCIENCE_BADGES = [
            // Common Badges
            { id: 'first_question', name: 'First Steps', icon: '', rarity: 'common', condition: 'Answer your first question', requirement: { type: 'total', value: 1 } },
            { id: 'five_correct', name: 'Getting Started', icon: '', rarity: 'common', condition: 'Get 5 correct answers', requirement: { type: 'correct', value: 5 } },
            { id: 'explorer', name: 'Topic Explorer', icon: '', rarity: 'common', condition: 'Try 3 different topics', requirement: { type: 'topics', value: 3 } },
            { id: 'early_bird', name: 'Early Bird', icon: '', rarity: 'common', condition: 'Practice before 8 AM', requirement: { type: 'time', value: 'morning' } },
            // Rare Badges
            { id: 'streak_master', name: 'Streak Master', icon: '', rarity: 'rare', condition: 'Get 5 correct in a row', requirement: { type: 'streak', value: 5 } },
            { id: 'fifty_club', name: 'Fifty Club', icon: '', rarity: 'rare', condition: 'Answer 50 questions', requirement: { type: 'total', value: 50 } },
            { id: 'perfectionist', name: 'Perfectionist', icon: '', rarity: 'rare', condition: 'Get 10 perfect scores', requirement: { type: 'perfect', value: 10 } },
            { id: 'weekender', name: 'Weekender', icon: '', rarity: 'rare', condition: 'Practice for 7 days', requirement: { type: 'days', value: 7 } },
            // Epic Badges
            { id: 'century', name: 'Century Milestone', icon: '', rarity: 'epic', condition: 'Answer 100 questions', requirement: { type: 'total', value: 100 } },
            { id: 'topic_master', name: 'Topic Master', icon: '', rarity: 'epic', condition: 'Master 5 topics', requirement: { type: 'mastery', value: 5 } },
            { id: 'unstoppable', name: 'Unstoppable', icon: '', rarity: 'epic', condition: 'Get 10 correct in a row', requirement: { type: 'streak', value: 10 } },
            { id: 'night_owl', name: 'Night Owl', icon: '', rarity: 'epic', condition: 'Practice after 9 PM', requirement: { type: 'time', value: 'night' } },
            // Legendary Badges
            { id: 'science_legend', name: 'Science Legend', icon: '', rarity: 'legendary', condition: 'Reach Level 10', requirement: { type: 'level', value: 10 } },
            { id: 'marathon', name: 'Marathon Runner', icon: '', rarity: 'legendary', condition: 'Answer 500 questions', requirement: { type: 'total', value: 500 } },
            { id: 'champion', name: 'Champion', icon: '', rarity: 'legendary', condition: '90% accuracy over 100 questions', requirement: { type: 'accuracy', value: 90 } },
            { id: 'dedication', name: 'True Dedication', icon: '', rarity: 'legendary', condition: '30-day streak', requirement: { type: 'days', value: 30 } }
        ];

        window.collectedBadges = [];

        window.loadCollectedBadges = function() {
            const stored = localStorage.getItem('collectedBadges');
            if (stored) {
                try {
                    window.collectedBadges = JSON.parse(stored);
                } catch (e) {}
            }
        };

        window.saveCollectedBadges = function() {
            localStorage.setItem('collectedBadges', JSON.stringify(window.collectedBadges));
        };

        window.checkBadgeUnlocks = function() {
            const hour = new Date().getHours();

            window.SCIENCE_BADGES.forEach(badge => {
                if (window.collectedBadges.includes(badge.id)) return;

                let unlocked = false;
                const req = badge.requirement;

                switch (req.type) {
                    case 'total':
                        unlocked = (window.gamificationState?.totalAttempts || 0) >= req.value;
                        break;
                    case 'correct':
                        unlocked = (window.gamificationState?.totalCorrect || 0) >= req.value;
                        break;
                    case 'streak':
                        unlocked = (window.gamificationState?.streak || 0) >= req.value;
                        break;
                    case 'topics':
                        unlocked = Object.keys(window.topicMastery || {}).length >= req.value;
                        break;
                    case 'level':
                        unlocked = (window.gamificationState?.level || 1) >= req.value;
                        break;
                    case 'mastery':
                        unlocked = Object.values(window.topicMastery || {}).filter(m => m.percentage >= 80).length >= req.value;
                        break;
                    case 'time':
                        if (req.value === 'morning') unlocked = hour < 8;
                        if (req.value === 'night') unlocked = hour >= 21;
                        break;
                    case 'days':
                        unlocked = (window.loginRewardsState?.claimedDays?.length || 0) >= req.value;
                        break;
                }

                if (unlocked) {
                    unlockBadge(badge);
                }
            });
        };

        window.unlockBadge = function(badge) {
            if (window.collectedBadges.includes(badge.id)) return;

            window.collectedBadges.push(badge.id);
            saveCollectedBadges();

            // Show notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 24px;
                padding: 30px;
                text-align: center;
                z-index: 10012;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
                animation: modalPop 0.5s ease;
            `;
            notification.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 15px;">${badge.icon}</div>
                <h2 style="margin: 0 0 10px 0; color: #333;">Badge Unlocked!</h2>
                <div style="font-size: 1.3rem; font-weight: 700; color: #667eea; margin-bottom: 10px;">${badge.name}</div>
                <div class="badge-rarity ${badge.rarity}">${badge.rarity.toUpperCase()}</div>
                <p style="color: #666; margin: 15px 0;">${badge.condition}</p>
                <button onclick="this.parentElement.remove();" style="padding: 12px 30px; border-radius: 25px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; cursor: pointer;">
                    Awesome! 
                </button>
            `;
            document.body.appendChild(notification);

            if (window.triggerEpicConfetti) triggerEpicConfetti();
            if (window.playSound) playSound('achievement');
        };

        window.showBadgeCollection = function() {
            // Remove existing
            document.querySelectorAll('.badges-modal, .modal-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';
            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };

            const modal = document.createElement('div');
            modal.className = 'badges-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 24px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                z-index: 10006;
                box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            `;
            modal.innerHTML = `
                <div style="padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 24px 24px 0 0;">
                    <h2 style="margin: 0;"> Badge Collection</h2>
                    <p style="margin: 5px 0 0 0; opacity: 0.9;">${window.collectedBadges.length}/${window.SCIENCE_BADGES.length} badges collected</p>
                </div>
                <div class="badges-collection">
                    ${window.SCIENCE_BADGES.map(badge => {
                        const unlocked = window.collectedBadges.includes(badge.id);
                        return `
                            <div class="badge-card ${unlocked ? 'unlocked' : 'locked'}" title="${badge.condition}">
                                <div class="badge-icon">${badge.icon}</div>
                                <div class="badge-name">${unlocked ? badge.name : '???'}</div>
                                <div class="badge-rarity ${badge.rarity}">${badge.rarity}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        // =====================================================
        // SESSION PROGRESS INDICATOR
        // =====================================================
        window.sessionGoal = 10; // Default: 10 questions per session

        window.initSessionProgress = function() {
            // Add progress bar to top of page
            const progressBar = document.createElement('div');
            progressBar.className = 'session-progress-bar';
            progressBar.id = 'session-progress-bar';
            progressBar.style.width = '0%';
            document.body.appendChild(progressBar);

            updateSessionProgress();
        };

        window.updateSessionProgress = function() {
            const bar = document.getElementById('session-progress-bar');
            if (!bar) return;

            const answered = window.sessionStats?.questionsAnswered || 0;
            const progress = Math.min((answered / window.sessionGoal) * 100, 100);
            bar.style.width = progress + '%';

            // Change color when goal reached
            if (progress >= 100) {
                bar.style.background = 'linear-gradient(90deg, #4CAF50, #8BC34A)';
            }
        };

        // =====================================================
        // FOCUS TIMER MODE
        // =====================================================
        window.focusTimer = {
            active: false,
            duration: 25 * 60, // 25 minutes default (Pomodoro)
            remaining: 0,
            interval: null
        };

        window.startFocusTimer = function(minutes = 25) {
            window.focusTimer.active = true;
            window.focusTimer.duration = minutes * 60;
            window.focusTimer.remaining = minutes * 60;

            // Remove existing timer
            document.querySelectorAll('.focus-timer').forEach(el => el.remove());

            const timer = document.createElement('div');
            timer.className = 'focus-timer';
            timer.id = 'focus-timer';
            timer.innerHTML = `
                <div class="focus-timer-display" id="focus-timer-display">${formatTime(window.focusTimer.remaining)}</div>
                <div class="focus-timer-label">Focus Mode </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="stopFocusTimer()" style="flex: 1; padding: 5px; border-radius: 8px; border: none; background: rgba(255,255,255,0.2); color: white; cursor: pointer; font-size: 0.8rem;">Stop</button>
                </div>
            `;
            document.body.appendChild(timer);

            window.focusTimer.interval = setInterval(() => {
                window.focusTimer.remaining--;
                const display = document.getElementById('focus-timer-display');
                if (display) {
                    display.textContent = formatTime(window.focusTimer.remaining);
                }

                if (window.focusTimer.remaining <= 0) {
                    focusTimerComplete();
                }
            }, 1000);
        };

        window.formatTime = function(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        };

        window.stopFocusTimer = function() {
            clearInterval(window.focusTimer.interval);
            window.focusTimer.active = false;
            document.querySelectorAll('.focus-timer').forEach(el => el.remove());
            if (window.showToast) showToast('Focus timer stopped', 'info');
        };

        window.focusTimerComplete = function() {
            stopFocusTimer();

            // Award bonus XP for completing focus session
            if (window.addXP) addXP(50, 'Focus Session Complete');
            if (window.triggerCelebration) triggerCelebration();
            if (window.showToast) showToast(' Focus session complete! +50 XP', 'success');

            // Play notification sound
            if (window.playSound) playSound('achievement');
        };

        // =====================================================
        // ANSWER HISTORY VIEWER
        // =====================================================
        window.answerHistory = [];

        window.loadAnswerHistory = function() {
            const stored = localStorage.getItem('answerHistory');
            if (stored) {
                try {
                    window.answerHistory = JSON.parse(stored);
                    // Keep only last 50 entries
                    if (window.answerHistory.length > 50) {
                        window.answerHistory = window.answerHistory.slice(-50);
                    }
                } catch (e) {}
            }
        };

        window.saveAnswerHistory = function() {
            localStorage.setItem('answerHistory', JSON.stringify(window.answerHistory));
        };

        window.addToHistory = function(questionInfo, isCorrect) {
            window.answerHistory.push({
                question: questionInfo.substring(0, 100) + '...',
                correct: isCorrect,
                timestamp: new Date().toISOString()
            });
            saveAnswerHistory();
        };

        window.showAnswerHistoryPanel = function() {
            // Remove existing
            document.querySelectorAll('.history-panel, .history-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'history-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 10003;';
            backdrop.onclick = () => { backdrop.remove(); panel.remove(); };

            const panel = document.createElement('div');
            panel.className = 'history-panel open';
            panel.innerHTML = `
                <div class="history-header">
                    <h2 style="margin: 0; font-size: 1.3rem;"> Answer History</h2>
                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">Your last ${window.answerHistory.length} answers</p>
                </div>
                <div class="history-list">
                    ${window.answerHistory.length === 0 ? `
                        <div style="text-align: center; padding: 40px 20px; color: #999;">
                            <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                            <p>No history yet!</p>
                            <p style="font-size: 0.85rem;">Start answering questions to see your history.</p>
                        </div>
                    ` : window.answerHistory.slice().reverse().map(entry => `
                        <div class="history-item ${entry.correct ? 'correct' : 'incorrect'}">
                            <div style="font-weight: 600; margin-bottom: 5px;">${entry.correct ? ' Correct' : ' Incorrect'}</div>
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">${entry.question}</div>
                            <div style="font-size: 0.75rem; color: #999;">${new Date(entry.timestamp).toLocaleString()}</div>
                        </div>
                    `).join('')}
                </div>
                <div style="padding: 15px; border-top: 1px solid #eee;">
                    <button onclick="clearAnswerHistory()" style="width: 100%; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; color: #666;">
                        Clear History
                    </button>
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(panel);
        };

        window.clearAnswerHistory = function() {
            if (confirm('Clear all answer history?')) {
                window.answerHistory = [];
                saveAnswerHistory();
                showAnswerHistoryPanel();
                if (window.showToast) showToast('History cleared', 'info');
            }
        };

        // =====================================================
        // QUICK PRACTICE SHORTCUTS
        // =====================================================
        window.initQuickActions = function() {
            // Remove existing
            document.querySelectorAll('.quick-actions-fab, .quick-actions-menu').forEach(el => el.remove());

            const fab = document.createElement('div');
            fab.className = 'quick-actions-fab';
            fab.id = 'quick-actions-fab';
            fab.textContent = '';
            fab.onclick = toggleQuickActionsMenu;
            document.body.appendChild(fab);

            const menu = document.createElement('div');
            menu.className = 'quick-actions-menu';
            menu.id = 'quick-actions-menu';
            menu.innerHTML = `
                <button class="quick-action-btn" onclick="startQuickPractice(5)">
                    <span></span> Quick 5 Questions
                </button>
                <button class="quick-action-btn" onclick="startQuickPractice(10)">
                    <span></span> Practice 10 Questions
                </button>
                <button class="quick-action-btn" onclick="startFocusTimer(15)">
                    <span></span> 15-min Focus Mode
                </button>
                <button class="quick-action-btn" onclick="startFocusTimer(25)">
                    <span></span> Pomodoro (25 min)
                </button>
                <button class="quick-action-btn" onclick="showLuckyWheel()">
                    <span></span> Spin Lucky Wheel
                </button>
                <button class="quick-action-btn" onclick="showBadgeCollection()">
                    <span></span> View Badges
                </button>
                <button class="quick-action-btn" onclick="showAnswerHistoryPanel()">
                    <span></span> Answer History
                </button>
            `;
            document.body.appendChild(menu);
        };

        window.toggleQuickActionsMenu = function() {
            const menu = document.getElementById('quick-actions-menu');
            if (menu) {
                menu.classList.toggle('open');
            }
        };

        window.startQuickPractice = function(count) {
            window.sessionGoal = count;
            updateSessionProgress();
            toggleQuickActionsMenu();
            if (window.showToast) showToast(`Goal set: ${count} questions!`, 'success');
            if (window.switchTab) switchTab('practice');
        };

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('quick-actions-menu');
            const fab = document.getElementById('quick-actions-fab');
            if (menu && fab && !menu.contains(e.target) && !fab.contains(e.target)) {
                menu.classList.remove('open');
            }
        });

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadCollectedBadges();
            loadAnswerHistory();
            initSessionProgress();
            initQuickActions();

            // Check badge unlocks periodically
            setInterval(checkBadgeUnlocks, 10000);
        });

        // Hook into answer handling
        const originalHandleAnswer9 = window.handleQuestionAnswer;
        window.handleQuestionAnswer = function(isCorrect, questionElement, questionType) {
            if (originalHandleAnswer9) {
                originalHandleAnswer9(isCorrect, questionElement, questionType);
            }

            // Update session progress
            updateSessionProgress();

            // Add to history
            const questionText = questionElement?.querySelector('p, .question-title')?.textContent || 'Question';
            addToHistory(questionText, isCorrect);

            // Check for badge unlocks
            checkBadgeUnlocks();
        };

        console.log(' Collectible Badges, Session Progress, Focus Timer, and Answer History loaded!');
    </script>

    <!-- Welcome Back, Difficulty, Quotes, Streak Multiplier, Topic Selector -->
    <script>
        // =====================================================
        // WELCOME BACK MESSAGE SYSTEM
        // =====================================================
        window.welcomeMessages = {
            morning: [
                { greeting: 'Good morning, scientist! ', message: 'Ready to start the day with some science?' },
                { greeting: 'Rise and shine! ', message: 'Early birds get the best learning!' },
                { greeting: 'Morning champion! ', message: 'Let\'s make today count!' }
            ],
            afternoon: [
                { greeting: 'Good afternoon! ', message: 'Time for some science exploration!' },
                { greeting: 'Welcome back! ', message: 'Let\'s keep the momentum going!' },
                { greeting: 'Hello, explorer! ', message: 'Ready for more discoveries?' }
            ],
            evening: [
                { greeting: 'Good evening! ', message: 'Perfect time for some focused study!' },
                { greeting: 'Welcome back! ', message: 'Let\'s wind down with some science!' },
                { greeting: 'Evening session! ', message: 'Night owls learn best!' }
            ],
            returning: [
                { greeting: 'Great to see you again! ', message: 'You\'ve been missed!' },
                { greeting: 'Welcome back, champion! ', message: 'Let\'s pick up where we left off!' },
                { greeting: 'The scientist returns! ', message: 'Ready to continue your journey?' }
            ]
        };

        window.showWelcomeMessage = function() {
            const lastVisit = localStorage.getItem('lastVisit');
            const now = new Date();
            const hour = now.getHours();

            // Determine time of day
            let timeOfDay = 'afternoon';
            if (hour < 12) timeOfDay = 'morning';
            else if (hour >= 18) timeOfDay = 'evening';

            // Check if returning after a while
            let messages = window.welcomeMessages[timeOfDay];
            if (lastVisit) {
                const lastDate = new Date(lastVisit);
                const hoursSinceVisit = (now - lastDate) / (1000 * 60 * 60);
                if (hoursSinceVisit > 24) {
                    messages = window.welcomeMessages.returning;
                }
            }

            const selected = messages[Math.floor(Math.random() * messages.length)];

            // Get streak info
            const streakDays = parseInt(document.getElementById('login-days-display')?.textContent?.match(/\d+/) || 0);
            let streakBonus = '';
            if (streakDays > 0) {
                streakBonus = `<div style="margin-top: 10px; font-size: 0.9rem;"> ${streakDays}-day streak! Keep it up!</div>`;
            }

            const banner = document.createElement('div');
            banner.className = 'welcome-banner';
            banner.innerHTML = `
                <button class="welcome-banner-close" onclick="this.parentElement.remove()"></button>
                <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 5px;">${selected.greeting}</div>
                <div style="opacity: 0.95;">${selected.message}</div>
                ${streakBonus}
            `;

            document.body.appendChild(banner);
            localStorage.setItem('lastVisit', now.toISOString());

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (banner.parentElement) {
                    banner.style.animation = 'slideDown 0.3s ease reverse forwards';
                    setTimeout(() => banner.remove(), 300);
                }
            }, 5000);
        };

        // =====================================================
        // DIFFICULTY PROGRESSION SYSTEM
        // =====================================================
        window.difficultyLevels = ['easy', 'medium', 'hard', 'expert'];
        window.currentDifficulty = 'medium';

        window.difficultyConfig = {
            easy: { label: 'Easy', icon: '', xpMultiplier: 0.8, color: '#4CAF50' },
            medium: { label: 'Medium', icon: '', xpMultiplier: 1.0, color: '#FF9800' },
            hard: { label: 'Hard', icon: '', xpMultiplier: 1.5, color: '#F44336' },
            expert: { label: 'Expert', icon: '', xpMultiplier: 2.0, color: '#9C27B0' }
        };

        window.loadDifficulty = function() {
            const stored = localStorage.getItem('currentDifficulty');
            if (stored && window.difficultyLevels.includes(stored)) {
                window.currentDifficulty = stored;
            }
        };

        window.saveDifficulty = function() {
            localStorage.setItem('currentDifficulty', window.currentDifficulty);
        };

        window.setDifficulty = function(level) {
            if (window.difficultyLevels.includes(level)) {
                window.currentDifficulty = level;
                saveDifficulty();
                updateDifficultyDisplay();
                if (window.showToast) {
                    const config = window.difficultyConfig[level];
                    showToast(`${config.icon} Difficulty set to ${config.label}!`, 'success');
                }
            }
        };

        window.updateDifficultyDisplay = function() {
            document.querySelectorAll('.difficulty-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.difficulty === window.currentDifficulty);
            });
        };

        window.getDifficultyXPMultiplier = function() {
            return window.difficultyConfig[window.currentDifficulty]?.xpMultiplier || 1.0;
        };

        window.showDifficultySelector = function() {
            // Remove existing
            document.querySelectorAll('.difficulty-modal, .modal-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';
            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };

            const modal = document.createElement('div');
            modal.className = 'difficulty-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 24px;
                padding: 30px;
                max-width: 400px;
                width: 90%;
                z-index: 10006;
                box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            `;
            modal.innerHTML = `
                <h2 style="margin: 0 0 10px 0; text-align: center;"> Select Difficulty</h2>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Higher difficulty = More XP rewards!</p>
                <div class="difficulty-selector">
                    ${window.difficultyLevels.map(level => {
                        const config = window.difficultyConfig[level];
                        return `
                            <div class="difficulty-option ${level === window.currentDifficulty ? 'selected' : ''}"
                                 data-difficulty="${level}"
                                 onclick="setDifficulty('${level}'); document.querySelectorAll('.difficulty-modal, .modal-backdrop').forEach(el => el.remove());">
                                <div style="font-size: 1.5rem;">${config.icon}</div>
                                <div style="font-weight: 600;">${config.label}</div>
                                <div style="font-size: 0.75rem; color: #666;">${config.xpMultiplier}x XP</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        // =====================================================
        // MOTIVATIONAL QUOTES
        // =====================================================
        window.MOTIVATIONAL_QUOTES = [
            { quote: 'The important thing is not to stop questioning. Curiosity has its own reason for existing.', author: 'Albert Einstein' },
            { quote: 'Science is not only a disciple of reason but also one of romance and passion.', author: 'Stephen Hawking' },
            { quote: 'The good thing about science is that it\'s true whether or not you believe in it.', author: 'Neil deGrasse Tyson' },
            { quote: 'Research is to see what everybody else has seen, and to think what nobody else has thought.', author: 'Albert Szent-Gyrgyi' },
            { quote: 'The reward of the young scientist is the emotional thrill of being the first person in the history of the world to see something.', author: 'Cecilia Payne' },
            { quote: 'Nothing in life is to be feared, it is only to be understood.', author: 'Marie Curie' },
            { quote: 'The saddest aspect of life right now is that science gathers knowledge faster than society gathers wisdom.', author: 'Isaac Asimov' },
            { quote: 'Science is organized knowledge. Wisdom is organized life.', author: 'Immanuel Kant' },
            { quote: 'The science of today is the technology of tomorrow.', author: 'Edward Teller' },
            { quote: 'In questions of science, the authority of a thousand is not worth the humble reasoning of a single individual.', author: 'Galileo Galilei' }
        ];

        window.currentQuoteIndex = 0;

        window.showRandomQuote = function() {
            const quote = window.MOTIVATIONAL_QUOTES[Math.floor(Math.random() * window.MOTIVATIONAL_QUOTES.length)];
            return quote;
        };

        window.displayQuoteInSidebar = function() {
            const container = document.getElementById('sidebar-quote-container');
            if (!container) return;

            const quote = showRandomQuote();
            container.innerHTML = `
                <div class="quote-display">
                    "${quote.quote}"
                    <div class="quote-author"> ${quote.author}</div>
                </div>
            `;
        };

        // =====================================================
        // STREAK REWARDS MULTIPLIER
        // =====================================================
        window.streakMultiplier = {
            active: false,
            multiplier: 1.0,
            threshold: 3 // Streak needed to activate
        };

        window.checkStreakMultiplier = function() {
            const streakDays = parseInt(document.getElementById('login-days-display')?.textContent?.match(/\d+/) || 0);

            // Remove existing multiplier display
            document.querySelectorAll('.streak-multiplier').forEach(el => el.remove());

            if (streakDays >= window.streakMultiplier.threshold) {
                window.streakMultiplier.active = true;

                // Calculate multiplier based on streak
                if (streakDays >= 30) {
                    window.streakMultiplier.multiplier = 2.0;
                } else if (streakDays >= 14) {
                    window.streakMultiplier.multiplier = 1.75;
                } else if (streakDays >= 7) {
                    window.streakMultiplier.multiplier = 1.5;
                } else {
                    window.streakMultiplier.multiplier = 1.25;
                }

                // Show multiplier badge
                const badge = document.createElement('div');
                badge.className = 'streak-multiplier';
                badge.innerHTML = `
                    <span></span>
                    <span>${window.streakMultiplier.multiplier}x XP</span>
                `;
                badge.title = `${streakDays}-day streak bonus!`;
                document.body.appendChild(badge);
            } else {
                window.streakMultiplier.active = false;
                window.streakMultiplier.multiplier = 1.0;
            }
        };

        window.getStreakXPMultiplier = function() {
            return window.streakMultiplier.active ? window.streakMultiplier.multiplier : 1.0;
        };

        // =====================================================
        // QUICK TOPIC SELECTOR
        // =====================================================
        window.popularTopics = [
            { id: 'physics', name: 'Physics', icon: '' },
            { id: 'chemistry', name: 'Chemistry', icon: '' },
            { id: 'biology', name: 'Biology', icon: '' },
            { id: 'earth', name: 'Earth Science', icon: '' },
            { id: 'space', name: 'Space', icon: '' },
            { id: 'energy', name: 'Energy', icon: '' }
        ];

        window.showQuickTopicSelector = function() {
            // Remove existing
            document.querySelectorAll('.topic-selector-modal, .modal-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';
            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };

            // Get hot topics (topics with low mastery)
            const hotTopics = Object.entries(window.topicMastery || {})
                .filter(([_, data]) => data.percentage < 70)
                .map(([id]) => id);

            const modal = document.createElement('div');
            modal.className = 'topic-selector-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 24px;
                padding: 30px;
                max-width: 450px;
                width: 90%;
                z-index: 10006;
                box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            `;
            modal.innerHTML = `
                <h2 style="margin: 0 0 10px 0; text-align: center;"> Quick Topic Select</h2>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Choose a topic to practice!</p>
                <div class="topic-quick-select">
                    ${window.popularTopics.map(topic => {
                        const isHot = hotTopics.includes(topic.id);
                        return `
                            <div class="topic-chip ${isHot ? 'hot' : ''}"
                                 onclick="selectQuickTopic('${topic.id}'); document.querySelectorAll('.topic-selector-modal, .modal-backdrop').forEach(el => el.remove());">
                                ${topic.icon} ${topic.name}
                                ${isHot ? '<span style="font-size: 0.7rem;">  Needs practice</span>' : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="document.querySelectorAll('.topic-selector-modal, .modal-backdrop').forEach(el => el.remove());"
                            style="padding: 10px 25px; border-radius: 20px; border: 1px solid #ddd; background: white; cursor: pointer; color: #666;">
                        Cancel
                    </button>
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.selectQuickTopic = function(topicId) {
            // Find topic in dropdown and select it
            const dropdown = document.querySelector('select[name="topic"], .topic-dropdown');
            if (dropdown) {
                const option = Array.from(dropdown.options).find(opt =>
                    opt.value.toLowerCase().includes(topicId) ||
                    opt.text.toLowerCase().includes(topicId)
                );
                if (option) {
                    dropdown.value = option.value;
                    dropdown.dispatchEvent(new Event('change'));
                }
            }

            if (window.showToast) showToast(`Topic selected: ${topicId}`, 'success');
            if (window.switchTab) switchTab('practice');
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadDifficulty();

            // Show welcome message after a short delay
            setTimeout(showWelcomeMessage, 1000);

            // Check streak multiplier
            setTimeout(checkStreakMultiplier, 2000);

            // Rotate quotes every 5 minutes
            setInterval(displayQuoteInSidebar, 300000);
        });

        // Hook into XP system to apply multipliers
        const originalAddXP3 = window.addXP;
        window.addXP = function(amount, reason) {
            // Apply difficulty multiplier
            let multipliedAmount = Math.round(amount * getDifficultyXPMultiplier());

            // Apply streak multiplier
            multipliedAmount = Math.round(multipliedAmount * getStreakXPMultiplier());

            if (originalAddXP3) {
                originalAddXP3(multipliedAmount, reason);
            }
        };

        console.log(' Welcome Messages, Difficulty, Quotes, and Streak Multipliers loaded!');
    </script>

    <!-- Comeback Notifications, Practice Reminders, Seasonal Events, Progress Summary -->
    <script>
        // =====================================================
        // COMEBACK NOTIFICATION FOR INACTIVE USERS
        // =====================================================
        window.comebackGifts = [
            { xp: 50, icon: '', message: 'A gift for coming back!' },
            { xp: 75, icon: '', message: 'We missed you!' },
            { xp: 100, icon: '', message: 'Welcome back, superstar!' }
        ];

        window.checkComebackBonus = function() {
            const lastActive = localStorage.getItem('lastActiveDate');
            if (!lastActive) {
                localStorage.setItem('lastActiveDate', new Date().toDateString());
                return;
            }

            const lastDate = new Date(lastActive);
            const today = new Date();
            const daysDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));

            // If inactive for 3+ days, show comeback gift
            if (daysDiff >= 3) {
                const giftIndex = Math.min(Math.floor(daysDiff / 3) - 1, window.comebackGifts.length - 1);
                const gift = window.comebackGifts[giftIndex];
                showComebackModal(gift, daysDiff);
            }

            localStorage.setItem('lastActiveDate', today.toDateString());
        };

        window.showComebackModal = function(gift, days) {
            const backdrop = document.createElement('div');
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10019;';

            const modal = document.createElement('div');
            modal.className = 'comeback-modal';
            modal.innerHTML = `
                <div class="comeback-gift">${gift.icon}</div>
                <h2 style="margin: 0 0 10px 0; font-size: 1.5rem;">${gift.message}</h2>
                <p style="opacity: 0.9; margin-bottom: 20px;">It's been ${days} days. Here's a special bonus to get you started!</p>
                <div style="background: rgba(255,255,255,0.2); padding: 15px 25px; border-radius: 15px; margin-bottom: 25px;">
                    <div style="font-size: 2rem; font-weight: 700;">+${gift.xp} XP</div>
                </div>
                <button onclick="claimComebackGift(${gift.xp}); this.closest('.comeback-modal').remove(); document.querySelector('[style*=\\'10019\\']')?.remove();"
                        style="padding: 15px 40px; border-radius: 30px; border: none; background: white; color: #E91E63; font-weight: 700; font-size: 1.1rem; cursor: pointer;">
                    Claim Gift! 
                </button>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.claimComebackGift = function(xp) {
            if (window.addXP) addXP(xp, 'Comeback Bonus');
            if (window.triggerCelebration) triggerCelebration();
            if (window.showToast) showToast('Welcome back! ', 'success');
        };

        // =====================================================
        // PRACTICE REMINDER SYSTEM
        // =====================================================
        window.reminderSettings = {
            enabled: true,
            intervalMinutes: 30,
            idleThresholdMinutes: 15
        };

        window.lastActivityTime = Date.now();

        window.initPracticeReminders = function() {
            // Track activity
            document.addEventListener('click', () => { window.lastActivityTime = Date.now(); });
            document.addEventListener('keypress', () => { window.lastActivityTime = Date.now(); });

            // Check for idle periodically
            setInterval(checkIdleReminder, 60000); // Check every minute
        };

        window.checkIdleReminder = function() {
            if (!window.reminderSettings.enabled) return;

            const idleMinutes = (Date.now() - window.lastActivityTime) / (1000 * 60);

            if (idleMinutes >= window.reminderSettings.idleThresholdMinutes) {
                showPracticeReminder();
                window.lastActivityTime = Date.now(); // Reset to avoid spam
            }
        };

        window.showPracticeReminder = function() {
            // Remove existing
            document.querySelectorAll('.reminder-toast').forEach(el => el.remove());

            const reminders = [
                { icon: '', text: 'Time for some science practice!' },
                { icon: '', text: 'Your brain needs some exercise!' },
                { icon: '', text: 'Quick practice session?' },
                { icon: '', text: 'Let\'s answer a few questions!' },
                { icon: '', text: 'Keep your streak alive!' }
            ];

            const reminder = reminders[Math.floor(Math.random() * reminders.length)];

            const toast = document.createElement('div');
            toast.className = 'reminder-toast';
            toast.innerHTML = `
                <span style="font-size: 1.5rem;">${reminder.icon}</span>
                <span>${reminder.text}</span>
                <button onclick="this.parentElement.remove(); if(window.switchTab) switchTab('practice');"
                        style="background: white; color: #FF5722; border: none; padding: 8px 15px; border-radius: 20px; font-weight: 600; cursor: pointer; margin-left: 10px;">
                    Let's Go!
                </button>
                <button onclick="this.parentElement.remove();"
                        style="background: transparent; color: white; border: none; font-size: 1.2rem; cursor: pointer; padding: 0 5px;"></button>
            `;

            document.body.appendChild(toast);

            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideUp 0.3s ease reverse forwards';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 10000);
        };

        // =====================================================
        // SEASONAL/THEMED EVENTS
        // =====================================================
        window.SEASONAL_EVENTS = [
            { name: 'Science Week', icon: '', color1: '#4CAF50', color2: '#8BC34A', multiplier: 1.5, months: [3] }, // March
            { name: 'Earth Day', icon: '', color1: '#009688', color2: '#4CAF50', multiplier: 1.5, months: [4] }, // April
            { name: 'Space Month', icon: '', color1: '#3F51B5', color2: '#673AB7', multiplier: 1.5, months: [7] }, // July
            { name: 'Back to School', icon: '', color1: '#FF9800', color2: '#F57C00', multiplier: 1.25, months: [8, 9] }, // Aug-Sep
            { name: 'Nobel Week', icon: '', color1: '#FFD700', color2: '#FF8C00', multiplier: 2.0, months: [10] }, // October
            { name: 'Winter Science', icon: '', color1: '#00BCD4', color2: '#03A9F4', multiplier: 1.5, months: [12, 1] } // Dec-Jan
        ];

        window.currentSeasonalEvent = null;

        window.checkSeasonalEvent = function() {
            const currentMonth = new Date().getMonth() + 1;

            window.currentSeasonalEvent = window.SEASONAL_EVENTS.find(event =>
                event.months.includes(currentMonth)
            );

            if (window.currentSeasonalEvent) {
                displaySeasonalBanner();
            }
        };

        window.displaySeasonalBanner = function() {
            const event = window.currentSeasonalEvent;
            if (!event) return;

            // Set CSS variables
            document.documentElement.style.setProperty('--seasonal-color-1', event.color1);
            document.documentElement.style.setProperty('--seasonal-color-2', event.color2);

            // Find sidebar or create container
            const sidebar = document.querySelector('.sidebar-top-section');
            if (!sidebar) return;

            // Remove existing banner
            document.querySelectorAll('.seasonal-banner').forEach(el => el.remove());

            const banner = document.createElement('div');
            banner.className = 'seasonal-banner';
            banner.innerHTML = `
                <div class="seasonal-icon">${event.icon}</div>
                <div class="seasonal-info">
                    <div class="seasonal-title">${event.name} Event!</div>
                    <div class="seasonal-bonus">${event.multiplier}x XP Bonus Active</div>
                </div>
            `;

            sidebar.insertBefore(banner, sidebar.firstChild);
        };

        window.getSeasonalMultiplier = function() {
            return window.currentSeasonalEvent?.multiplier || 1.0;
        };

        // =====================================================
        // MOTIVATIONAL PROGRESS SUMMARY
        // =====================================================
        window.showProgressSummary = function() {
            const stats = window.gamificationState || {};
            const level = stats.level || 1;
            const xp = stats.xp || 0;
            const totalQuestions = stats.totalAttempts || 0;
            const correctAnswers = stats.totalCorrect || 0;
            const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
            const streakDays = parseInt(document.getElementById('login-days-display')?.textContent?.match(/\d+/) || 0);
            const badges = window.collectedBadges?.length || 0;

            // Remove existing
            document.querySelectorAll('.progress-summary-modal, .modal-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';
            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };

            const modal = document.createElement('div');
            modal.className = 'progress-summary-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 24px;
                padding: 30px;
                max-width: 400px;
                width: 90%;
                z-index: 10006;
                box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            `;

            // Generate motivational message based on stats
            let motivation = '';
            if (accuracy >= 80) motivation = 'Outstanding accuracy! ';
            else if (accuracy >= 60) motivation = 'Great progress! Keep it up! ';
            else motivation = 'Every question makes you stronger! ';

            modal.innerHTML = `
                <h2 style="margin: 0 0 20px 0; text-align: center;"> Your Progress</h2>
                <div class="progress-summary-card">
                    <div class="progress-summary-stat">
                        <span class="progress-summary-label"> Level</span>
                        <span class="progress-summary-value">${level}</span>
                    </div>
                    <div class="progress-summary-stat">
                        <span class="progress-summary-label"> Total XP</span>
                        <span class="progress-summary-value">${xp.toLocaleString()}</span>
                    </div>
                    <div class="progress-summary-stat">
                        <span class="progress-summary-label"> Questions</span>
                        <span class="progress-summary-value">${totalQuestions}</span>
                    </div>
                    <div class="progress-summary-stat">
                        <span class="progress-summary-label"> Accuracy</span>
                        <span class="progress-summary-value">${accuracy}%</span>
                    </div>
                    <div class="progress-summary-stat">
                        <span class="progress-summary-label"> Streak</span>
                        <span class="progress-summary-value">${streakDays} days</span>
                    </div>
                    <div class="progress-summary-stat">
                        <span class="progress-summary-label"> Badges</span>
                        <span class="progress-summary-value">${badges}/${window.SCIENCE_BADGES?.length || 16}</span>
                    </div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 12px; margin-top: 15px;">
                    <div style="font-size: 1.1rem; color: #333;">${motivation}</div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="document.querySelectorAll('.progress-summary-modal, .modal-backdrop').forEach(el => el.remove());"
                            style="padding: 12px 30px; border-radius: 25px; border: none; background: linear-gradient(135deg, #00BCD4, #009688); color: white; font-weight: 600; cursor: pointer;">
                        Keep Going! 
                    </button>
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Check for comeback bonus
            setTimeout(checkComebackBonus, 3000);

            // Initialize practice reminders
            initPracticeReminders();

            // Check for seasonal events
            checkSeasonalEvent();
        });

        // Update XP multiplier to include seasonal
        const originalAddXP4 = window.addXP;
        window.addXP = function(amount, reason) {
            // Apply seasonal multiplier
            const multipliedAmount = Math.round(amount * getSeasonalMultiplier());

            if (originalAddXP4) {
                originalAddXP4(multipliedAmount, reason);
            }
        };

        console.log(' Comeback Notifications, Practice Reminders, Seasonal Events, and Progress Summary loaded!');
    </script>

    <!-- BATCH 13: Encouragement, Mini-Games, and Goal Rewards -->
    <script>
        // =====================================================
        // ENCOURAGEMENT MESSAGES BETWEEN QUESTIONS
        // =====================================================
        window.encouragementMessages = {
            correct: [
                { icon: '', text: 'Brilliant! You\'re a science superstar!' },
                { icon: '', text: 'Perfect aim! Keep hitting those targets!' },
                { icon: '', text: 'You\'re rocketing through these questions!' },
                { icon: '', text: 'Your brain is on fire today!' },
                { icon: '', text: 'Unstoppable! Nothing can slow you down!' },
                { icon: '', text: 'Champion material right here!' },
                { icon: '', text: 'Lightning fast and accurate!' },
                { icon: '', text: 'You\'re blazing through science!' },
                { icon: '', text: 'Magical thinking! Keep it up!' },
                { icon: '', text: 'Celebration time! Another one right!' }
            ],
            incorrect: [
                { icon: '', text: 'Great learning opportunity! Keep going!' },
                { icon: '', text: 'Every mistake helps you grow!' },
                { icon: '', text: 'You\'ve got this! Try the next one!' },
                { icon: '', text: 'Getting closer! Don\'t give up!' },
                { icon: '', text: 'Scientists learn from experiments!' },
                { icon: '', text: 'Knowledge is building! Keep at it!' },
                { icon: '', text: 'Brighter understanding ahead!' },
                { icon: '', text: 'Stars are made under pressure!' }
            ],
            streak: [
                { icon: '', text: '{streak} in a row! You\'re on FIRE!' },
                { icon: '', text: 'Streak of {streak}! Electrifying!' },
                { icon: '', text: '{streak} consecutive wins! To infinity!' },
                { icon: '', text: 'Diamond streak: {streak}! Unbreakable!' },
                { icon: '', text: 'Shooting star! {streak} correct!' }
            ]
        };

        window.questionCounter = parseInt(localStorage.getItem('science_question_counter') || '0');
        window.correctStreak = parseInt(localStorage.getItem('science_correct_streak') || '0');

        window.showEncouragement = function(isCorrect, streak = 0) {
            // Don't show every time - show periodically to avoid spam
            window.questionCounter++;
            localStorage.setItem('science_question_counter', window.questionCounter);

            // Show encouragement every 3-5 questions or on streaks
            const showThisTime = (window.questionCounter % 4 === 0) || (streak > 0 && streak % 3 === 0);

            if (!showThisTime && streak < 3) return;

            // Remove existing banners
            document.querySelectorAll('.encouragement-banner').forEach(el => el.remove());

            let message;
            if (streak >= 3) {
                // Show streak message
                const streakMsgs = window.encouragementMessages.streak;
                message = {...streakMsgs[Math.floor(Math.random() * streakMsgs.length)]};
                message.text = message.text.replace('{streak}', streak);
            } else if (isCorrect) {
                const correctMsgs = window.encouragementMessages.correct;
                message = correctMsgs[Math.floor(Math.random() * correctMsgs.length)];
            } else {
                const incorrectMsgs = window.encouragementMessages.incorrect;
                message = incorrectMsgs[Math.floor(Math.random() * incorrectMsgs.length)];
            }

            const banner = document.createElement('div');
            banner.className = 'encouragement-banner';
            banner.innerHTML = `
                <span class="encouragement-icon">${message.icon}</span>
                <span class="encouragement-text">${message.text}</span>
            `;

            document.body.appendChild(banner);

            // Trigger animation
            requestAnimationFrame(() => {
                banner.classList.add('show');
            });

            // Auto-remove after 3 seconds
            setTimeout(() => {
                banner.classList.remove('show');
                setTimeout(() => banner.remove(), 400);
            }, 3000);
        };

        // Track correct answers for encouragement
        window.trackAnswerForEncouragement = function(isCorrect) {
            if (isCorrect) {
                window.correctStreak++;
                localStorage.setItem('science_correct_streak', window.correctStreak);
                showEncouragement(true, window.correctStreak);
            } else {
                window.correctStreak = 0;
                localStorage.setItem('science_correct_streak', '0');
                showEncouragement(false, 0);
            }
        };

        // =====================================================
        // MINI-GAME BREAK AFTER STREAKS
        // =====================================================
        window.miniGameState = {
            lastPlayedAt: parseInt(localStorage.getItem('science_minigame_last') || '0'),
            questionsUntilGame: parseInt(localStorage.getItem('science_questions_until_game') || '15')
        };

        window.checkForMiniGameBreak = function() {
            window.miniGameState.questionsUntilGame--;
            localStorage.setItem('science_questions_until_game', window.miniGameState.questionsUntilGame);

            // Offer mini-game every 15 questions
            if (window.miniGameState.questionsUntilGame <= 0) {
                window.miniGameState.questionsUntilGame = 15;
                localStorage.setItem('science_questions_until_game', '15');

                // Don't show if played recently (within 5 minutes)
                const now = Date.now();
                if (now - window.miniGameState.lastPlayedAt > 5 * 60 * 1000) {
                    setTimeout(() => showMiniGameOffer(), 1000);
                }
            }
        };

        window.showMiniGameOffer = function() {
            // Remove existing
            document.querySelectorAll('.mini-game-modal, .mini-game-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'mini-game-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10010; backdrop-filter: blur(3px);';

            const modal = document.createElement('div');
            modal.className = 'mini-game-modal';
            modal.innerHTML = `
                <h2 style="margin: 0 0 10px 0; color: #333;"> Break Time!</h2>
                <p style="color: #666; margin: 0 0 20px 0;">Great job! Take a quick game break to refresh your mind.</p>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="startEmojiSlots()"
                            style="padding: 15px 25px; border-radius: 15px; border: none; background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; font-weight: 600; cursor: pointer; font-size: 1rem;">
                         Emoji Slots
                    </button>
                    <button onclick="startMemoryMatch()"
                            style="padding: 15px 25px; border-radius: 15px; border: none; background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; font-weight: 600; cursor: pointer; font-size: 1rem;">
                         Memory Match
                    </button>
                    <button onclick="closeMiniGame()"
                            style="padding: 15px 25px; border-radius: 15px; border: none; background: #e0e0e0; color: #666; font-weight: 600; cursor: pointer; font-size: 1rem;">
                        Skip for now
                    </button>
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);

            backdrop.onclick = closeMiniGame;
        };

        window.closeMiniGame = function() {
            document.querySelectorAll('.mini-game-modal, .mini-game-backdrop').forEach(el => el.remove());
        };

        // Emoji Slots Mini-Game
        window.startEmojiSlots = function() {
            window.miniGameState.lastPlayedAt = Date.now();
            localStorage.setItem('science_minigame_last', window.miniGameState.lastPlayedAt);

            const emojis = ['', '', '', '', '', '', '', '', '', ''];

            document.querySelector('.mini-game-modal').innerHTML = `
                <h2 style="margin: 0 0 15px 0; color: #333;"> Emoji Slots</h2>
                <p style="color: #666; margin: 0 0 20px 0;">Match 3 for bonus XP!</p>
                <div class="emoji-slots">
                    <div class="emoji-slot" id="slot1"></div>
                    <div class="emoji-slot" id="slot2"></div>
                    <div class="emoji-slot" id="slot3"></div>
                </div>
                <div id="slots-result" style="margin: 15px 0; font-size: 1.1rem; min-height: 30px;"></div>
                <button id="spin-btn" onclick="spinSlots()"
                        style="padding: 15px 40px; border-radius: 25px; border: none; background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; font-weight: 700; cursor: pointer; font-size: 1.1rem;">
                     SPIN!
                </button>
                <button onclick="closeMiniGame()"
                        style="display: block; margin: 15px auto 0; padding: 10px 25px; border-radius: 20px; border: none; background: #e0e0e0; color: #666; cursor: pointer;">
                    Done Playing
                </button>
            `;
        };

        window.spinSlots = function() {
            const emojis = ['', '', '', '', '', '', '', '', '', ''];
            const spinBtn = document.getElementById('spin-btn');
            spinBtn.disabled = true;
            spinBtn.textContent = 'Spinning...';

            const slots = [
                document.getElementById('slot1'),
                document.getElementById('slot2'),
                document.getElementById('slot3')
            ];

            // Animate slots
            let spins = 0;
            const maxSpins = 20;
            const results = [];

            const spinInterval = setInterval(() => {
                slots.forEach((slot, i) => {
                    if (spins < maxSpins - (2 - i) * 3) {
                        slot.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                        slot.style.transform = 'scale(1.1)';
                        setTimeout(() => slot.style.transform = 'scale(1)', 50);
                    } else if (!results[i]) {
                        results[i] = emojis[Math.floor(Math.random() * emojis.length)];
                        slot.textContent = results[i];
                        slot.style.transform = 'scale(1.2)';
                        setTimeout(() => slot.style.transform = 'scale(1)', 150);
                    }
                });

                spins++;

                if (spins >= maxSpins) {
                    clearInterval(spinInterval);
                    checkSlotsResult(results);
                    spinBtn.disabled = false;
                    spinBtn.textContent = ' SPIN AGAIN!';
                }
            }, 100);
        };

        window.checkSlotsResult = function(results) {
            const resultDiv = document.getElementById('slots-result');

            if (results[0] === results[1] && results[1] === results[2]) {
                // Jackpot! All 3 match
                resultDiv.innerHTML = ' <strong>JACKPOT!</strong> +50 XP Bonus!';
                resultDiv.style.color = '#FF6B6B';
                if (window.addXP) window.addXP(50, 'Mini-game jackpot');
                triggerMiniCelebration();
            } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
                // 2 match
                resultDiv.innerHTML = ' <strong>Nice!</strong> 2 matched! +15 XP';
                resultDiv.style.color = '#4CAF50';
                if (window.addXP) window.addXP(15, 'Mini-game pair');
            } else {
                resultDiv.innerHTML = ' No match, try again!';
                resultDiv.style.color = '#666';
            }
        };

        // Memory Match Mini-Game
        window.memoryCards = [];
        window.memoryFlipped = [];
        window.memoryMatched = 0;
        window.memoryMoves = 0;

        window.startMemoryMatch = function() {
            window.miniGameState.lastPlayedAt = Date.now();
            localStorage.setItem('science_minigame_last', window.miniGameState.lastPlayedAt);

            const scienceEmojis = ['', '', '', '', '', ''];
            window.memoryCards = [...scienceEmojis, ...scienceEmojis].sort(() => Math.random() - 0.5);
            window.memoryFlipped = [];
            window.memoryMatched = 0;
            window.memoryMoves = 0;

            let cardsHTML = window.memoryCards.map((emoji, i) => `
                <div class="memory-card" data-index="${i}" onclick="flipMemoryCard(${i})"
                     style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2);
                            border-radius: 8px; display: flex; align-items: center; justify-content: center;
                            cursor: pointer; font-size: 1.5rem; color: transparent; user-select: none;
                            transition: all 0.3s ease;">
                    ${emoji}
                </div>
            `).join('');

            document.querySelector('.mini-game-modal').innerHTML = `
                <h2 style="margin: 0 0 10px 0; color: #333;"> Memory Match</h2>
                <p style="color: #666; margin: 0 0 15px 0;">Find all pairs! Moves: <span id="memory-moves">0</span></p>
                <div style="display: grid; grid-template-columns: repeat(4, 50px); gap: 8px; justify-content: center;">
                    ${cardsHTML}
                </div>
                <div id="memory-result" style="margin: 15px 0; font-size: 1rem; min-height: 25px;"></div>
                <button onclick="closeMiniGame()"
                        style="padding: 10px 25px; border-radius: 20px; border: none; background: #e0e0e0; color: #666; cursor: pointer;">
                    Done Playing
                </button>
            `;
        };

        window.flipMemoryCard = function(index) {
            if (window.memoryFlipped.length >= 2) return;
            if (window.memoryFlipped.includes(index)) return;

            const card = document.querySelector(`.memory-card[data-index="${index}"]`);
            if (card.classList.contains('matched')) return;

            card.style.color = 'white';
            card.style.background = '#4CAF50';
            window.memoryFlipped.push(index);

            if (window.memoryFlipped.length === 2) {
                window.memoryMoves++;
                document.getElementById('memory-moves').textContent = window.memoryMoves;

                const [first, second] = window.memoryFlipped;

                if (window.memoryCards[first] === window.memoryCards[second]) {
                    // Match found
                    document.querySelectorAll(`.memory-card[data-index="${first}"], .memory-card[data-index="${second}"]`)
                        .forEach(c => c.classList.add('matched'));
                    window.memoryMatched += 2;
                    window.memoryFlipped = [];

                    if (window.memoryMatched === window.memoryCards.length) {
                        // Game complete
                        const bonus = Math.max(50 - window.memoryMoves * 2, 20);
                        document.getElementById('memory-result').innerHTML =
                            ` <strong>Complete!</strong> +${bonus} XP (${window.memoryMoves} moves)`;
                        if (window.addXP) window.addXP(bonus, 'Memory game complete');
                        triggerMiniCelebration();
                    }
                } else {
                    // No match - flip back
                    setTimeout(() => {
                        document.querySelectorAll(`.memory-card[data-index="${first}"], .memory-card[data-index="${second}"]`)
                            .forEach(c => {
                                c.style.color = 'transparent';
                                c.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                            });
                        window.memoryFlipped = [];
                    }, 800);
                }
            }
        };

        window.triggerMiniCelebration = function() {
            // Quick confetti burst for mini-games
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.cssText = `
                        position: fixed;
                        top: 40%;
                        left: ${45 + Math.random() * 10}%;
                        width: 10px;
                        height: 10px;
                        background: hsl(${Math.random() * 360}, 80%, 60%);
                        border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
                        pointer-events: none;
                        z-index: 10020;
                        animation: confettiBurst 1.5s ease-out forwards;
                    `;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 1500);
                }, i * 30);
            }
        };

        // =====================================================
        // DAILY GOAL COMPLETION REWARDS
        // =====================================================
        window.dailyGoals = {
            questions: parseInt(localStorage.getItem('science_daily_goal_questions') || '10'),
            current: parseInt(localStorage.getItem('science_daily_questions_today') || '0'),
            lastDate: localStorage.getItem('science_daily_goal_date') || '',
            completed: localStorage.getItem('science_daily_goal_completed') === 'true'
        };

        window.initDailyGoals = function() {
            const today = new Date().toDateString();

            // Reset if new day
            if (window.dailyGoals.lastDate !== today) {
                window.dailyGoals.current = 0;
                window.dailyGoals.completed = false;
                window.dailyGoals.lastDate = today;
                localStorage.setItem('science_daily_questions_today', '0');
                localStorage.setItem('science_daily_goal_date', today);
                localStorage.setItem('science_daily_goal_completed', 'false');
            }

            // Create goal tracker UI
            createGoalTrackerUI();
        };

        window.createGoalTrackerUI = function() {
            // Remove existing
            document.querySelectorAll('.daily-goal-tracker').forEach(el => el.remove());

            const tracker = document.createElement('div');
            tracker.className = 'daily-goal-tracker';
            tracker.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 20px;
                background: white;
                border-radius: 15px;
                padding: 12px 18px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 999;
                display: flex;
                align-items: center;
                gap: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
            `;

            const progress = Math.min((window.dailyGoals.current / window.dailyGoals.questions) * 100, 100);
            const isComplete = window.dailyGoals.current >= window.dailyGoals.questions;

            tracker.innerHTML = `
                <div style="font-size: 1.5rem;">${isComplete ? '' : ''}</div>
                <div>
                    <div style="font-size: 0.75rem; color: #666; margin-bottom: 3px;">Daily Goal</div>
                    <div style="width: 80px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${progress}%; height: 100%; background: ${isComplete ? '#4CAF50' : 'linear-gradient(90deg, #FF6B6B, #FF8E53)'}; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="font-size: 0.7rem; color: #888; margin-top: 2px;">${window.dailyGoals.current}/${window.dailyGoals.questions}</div>
                </div>
            `;

            tracker.onclick = showGoalSettings;
            document.body.appendChild(tracker);
        };

        window.showGoalSettings = function() {
            // Remove existing modals
            document.querySelectorAll('.goal-settings-modal, .goal-settings-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'goal-settings-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;';

            const modal = document.createElement('div');
            modal.className = 'goal-settings-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 20px;
                padding: 25px;
                max-width: 350px;
                width: 90%;
                z-index: 10001;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            `;

            modal.innerHTML = `
                <h3 style="margin: 0 0 20px 0; text-align: center;"> Daily Goal Settings</h3>
                <p style="color: #666; text-align: center; margin-bottom: 20px;">How many questions do you want to answer each day?</p>
                <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                    ${[5, 10, 15, 20, 30].map(n => `
                        <button onclick="setDailyGoal(${n})"
                                style="padding: 12px 20px; border-radius: 10px; border: 2px solid ${window.dailyGoals.questions === n ? '#4CAF50' : '#e0e0e0'};
                                       background: ${window.dailyGoals.questions === n ? '#E8F5E9' : 'white'};
                                       font-weight: 600; cursor: pointer; font-size: 1rem;">
                            ${n}
                        </button>
                    `).join('')}
                </div>
                <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 12px; margin-bottom: 15px;">
                    <div style="font-size: 0.9rem; color: #666;">Today's Progress</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #333;">${window.dailyGoals.current} / ${window.dailyGoals.questions}</div>
                </div>
                <button onclick="document.querySelectorAll('.goal-settings-modal, .goal-settings-backdrop').forEach(el => el.remove());"
                        style="width: 100%; padding: 12px; border-radius: 10px; border: none; background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; font-weight: 600; cursor: pointer;">
                    Done
                </button>
            `;

            backdrop.onclick = () => {
                backdrop.remove();
                modal.remove();
            };

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.setDailyGoal = function(count) {
            window.dailyGoals.questions = count;
            localStorage.setItem('science_daily_goal_questions', count);

            // Refresh UI
            createGoalTrackerUI();
            showGoalSettings();
        };

        window.incrementDailyGoal = function() {
            window.dailyGoals.current++;
            localStorage.setItem('science_daily_questions_today', window.dailyGoals.current);

            // Update tracker UI
            createGoalTrackerUI();

            // Check for completion
            if (window.dailyGoals.current === window.dailyGoals.questions && !window.dailyGoals.completed) {
                window.dailyGoals.completed = true;
                localStorage.setItem('science_daily_goal_completed', 'true');
                setTimeout(showGoalCompleteCelebration, 500);
            }
        };

        window.showGoalCompleteCelebration = function() {
            // Remove existing
            document.querySelectorAll('.goal-complete-modal, .goal-complete-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'goal-complete-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10010; backdrop-filter: blur(5px);';

            const modal = document.createElement('div');
            modal.className = 'goal-complete-modal';

            const bonusXP = 100;

            modal.innerHTML = `
                <div class="goal-trophy"></div>
                <h2 style="margin: 10px 0; font-size: 1.8rem; background: linear-gradient(135deg, #FFD700, #FF8C00); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    DAILY GOAL COMPLETE!
                </h2>
                <p style="color: #666; margin: 10px 0 20px 0;">You answered ${window.dailyGoals.questions} questions today!</p>
                <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 15px 30px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="color: white; font-weight: 700; font-size: 1.5rem;">+${bonusXP} XP BONUS!</div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="closeGoalCelebration(); setDailyGoal(${window.dailyGoals.questions + 5});"
                            style="padding: 12px 25px; border-radius: 25px; border: none; background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; font-weight: 600; cursor: pointer;">
                         Increase Goal
                    </button>
                    <button onclick="closeGoalCelebration();"
                            style="padding: 12px 25px; border-radius: 25px; border: none; background: #e0e0e0; color: #666; font-weight: 600; cursor: pointer;">
                        Keep Going!
                    </button>
                </div>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);

            // Award bonus XP
            if (window.addXP) window.addXP(bonusXP, 'Daily goal complete');

            // Epic celebration
            triggerGoalCelebration();

            backdrop.onclick = closeGoalCelebration;
        };

        window.closeGoalCelebration = function() {
            document.querySelectorAll('.goal-complete-modal, .goal-complete-backdrop').forEach(el => el.remove());
        };

        window.triggerGoalCelebration = function() {
            // Big confetti burst
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    const startX = Math.random() * 100;
                    confetti.style.cssText = `
                        position: fixed;
                        top: -20px;
                        left: ${startX}%;
                        width: ${8 + Math.random() * 8}px;
                        height: ${8 + Math.random() * 8}px;
                        background: hsl(${Math.random() * 360}, 90%, 60%);
                        border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
                        pointer-events: none;
                        z-index: 10020;
                        animation: confettiDrop 3s ease-out forwards;
                    `;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        };

        // =====================================================
        // INTEGRATE WITH ANSWER SUBMISSION
        // =====================================================
        // Hook into existing answer handling
        const originalHandleAnswer = window.handleAnswerResult;
        if (originalHandleAnswer) {
            window.handleAnswerResult = function(isCorrect, ...args) {
                // Track for encouragement
                trackAnswerForEncouragement(isCorrect);

                // Increment daily goal
                incrementDailyGoal();

                // Check for mini-game break
                checkForMiniGameBreak();

                // Call original
                return originalHandleAnswer.call(this, isCorrect, ...args);
            };
        }

        // Alternative hook using mutation observer or event delegation
        document.addEventListener('click', function(e) {
            // Check if clicking a submit/answer button
            if (e.target.matches('.submit-answer, .answer-option, [data-answer]')) {
                // Increment daily goal counter on any answer attempt
                setTimeout(() => {
                    if (document.querySelector('.answer-result, .feedback-message, .correct-feedback, .incorrect-feedback')) {
                        incrementDailyGoal();
                    }
                }, 100);
            }
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initDailyGoals();
        });

        // Also init if DOM already loaded
        if (document.readyState !== 'loading') {
            initDailyGoals();
        }

        console.log(' Encouragement Messages, Mini-Games, and Daily Goals loaded!');
    </script>

    <!-- BATCH 14: Science Facts, Streak Calendar, Flashcards -->
    <script>
        // =====================================================
        // SCIENCE FACT CARDS
        // =====================================================
        window.SCIENCE_FACTS = [
            { category: 'Physics', icon: '', fact: 'Lightning strikes Earth about 100 times per second, that\'s 8.6 million times per day!' },
            { category: 'Biology', icon: '', fact: 'Your DNA could stretch from Earth to the Sun and back about 600 times!' },
            { category: 'Chemistry', icon: '', fact: 'Water is the only substance that exists naturally in all three states: solid, liquid, and gas.' },
            { category: 'Space', icon: '', fact: 'A day on Venus is longer than a year on Venus! It takes 243 Earth days to rotate but only 225 to orbit the Sun.' },
            { category: 'Physics', icon: '', fact: 'Sound travels about 4 times faster through water than through air.' },
            { category: 'Biology', icon: '', fact: 'Babies are born with about 300 bones, but adults only have 206 because many fuse together.' },
            { category: 'Chemistry', icon: '', fact: 'Diamonds and graphite are both made of pure carbon - only the arrangement of atoms differs!' },
            { category: 'Space', icon: '', fact: 'Neutron stars are so dense that a teaspoon would weigh about 6 billion tons!' },
            { category: 'Biology', icon: '', fact: 'The human brain uses about 20% of your body\'s total energy, even though it\'s only 2% of your weight.' },
            { category: 'Physics', icon: '', fact: 'A single bolt of lightning contains enough energy to toast 100,000 slices of bread!' },
            { category: 'Chemistry', icon: '', fact: 'Helium is the only element that cannot be solidified at normal atmospheric pressure.' },
            { category: 'Space', icon: '', fact: 'The Moon is slowly drifting away from Earth at about 3.8 centimeters per year.' },
            { category: 'Biology', icon: '', fact: 'Your heart beats about 100,000 times per day, pumping about 2,000 gallons of blood!' },
            { category: 'Physics', icon: '', fact: 'Rainbows are actually full circles! We only see a semicircle because the ground is in the way.' },
            { category: 'Chemistry', icon: '', fact: 'At -40 degrees, Celsius and Fahrenheit are the same temperature!' },
            { category: 'Space', icon: '', fact: 'Light from the Sun takes 8 minutes and 20 seconds to reach Earth.' },
            { category: 'Biology', icon: '', fact: 'Your eyes can distinguish about 10 million different colors!' },
            { category: 'Physics', icon: '', fact: 'Magnetic North Pole moves about 40 kilometers per year toward Russia.' },
            { category: 'Chemistry', icon: '', fact: 'Hot water freezes faster than cold water under certain conditions - called the Mpemba effect!' },
            { category: 'Space', icon: '', fact: 'Saturn\'s density is so low it would float in water if you could find a bathtub big enough!' },
            { category: 'Biology', icon: '', fact: 'Octopuses have three hearts and blue blood!' },
            { category: 'Physics', icon: '', fact: 'Radio waves travel at the speed of light - 299,792 kilometers per second!' },
            { category: 'Chemistry', icon: '', fact: 'Fire is not a solid, liquid, or gas - it\'s a plasma, the fourth state of matter!' },
            { category: 'Space', icon: '', fact: 'There are more stars in the universe than grains of sand on all of Earth\'s beaches.' }
        ];

        window.shownFactIndices = JSON.parse(localStorage.getItem('science_shown_facts') || '[]');
        window.factShowCount = parseInt(localStorage.getItem('science_fact_count') || '0');

        window.showRandomScienceFact = function() {
            // Only show facts occasionally (every 5-7 questions)
            window.factShowCount++;
            localStorage.setItem('science_fact_count', window.factShowCount);

            if (window.factShowCount % 6 !== 0) return;

            // Get unshown facts
            let availableIndices = [];
            for (let i = 0; i < window.SCIENCE_FACTS.length; i++) {
                if (!window.shownFactIndices.includes(i)) {
                    availableIndices.push(i);
                }
            }

            // Reset if all facts shown
            if (availableIndices.length === 0) {
                window.shownFactIndices = [];
                availableIndices = [...Array(window.SCIENCE_FACTS.length).keys()];
            }

            // Pick random fact
            const factIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
            window.shownFactIndices.push(factIndex);
            localStorage.setItem('science_shown_facts', JSON.stringify(window.shownFactIndices));

            const fact = window.SCIENCE_FACTS[factIndex];
            displayScienceFact(fact);
        };

        window.displayScienceFact = function(fact) {
            // Remove existing
            document.querySelectorAll('.science-fact-card').forEach(el => el.remove());

            const card = document.createElement('div');
            card.className = 'science-fact-card';
            card.innerHTML = `
                <button class="science-fact-dismiss" onclick="this.parentElement.classList.remove('show'); setTimeout(() => this.parentElement.remove(), 500);"></button>
                <div class="science-fact-icon">${fact.icon}</div>
                <div class="science-fact-category">${fact.category}</div>
                <div class="science-fact-text">${fact.fact}</div>
            `;

            document.body.appendChild(card);

            // Animate in
            requestAnimationFrame(() => {
                card.classList.add('show');
            });

            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (card.parentElement) {
                    card.classList.remove('show');
                    setTimeout(() => card.remove(), 500);
                }
            }, 8000);
        };

        // Hook into answer submission for facts
        const originalCheckFacts = window.checkForMiniGameBreak;
        if (originalCheckFacts) {
            window.checkForMiniGameBreak = function() {
                originalCheckFacts();
                showRandomScienceFact();
            };
        }

        // =====================================================
        // STREAK CALENDAR VISUALIZATION
        // =====================================================
        window.streakData = JSON.parse(localStorage.getItem('science_streak_calendar') || '{}');

        window.recordTodayActivity = function() {
            const today = new Date().toISOString().split('T')[0];
            if (!window.streakData[today]) {
                window.streakData[today] = { questions: 0, correct: 0 };
            }
            window.streakData[today].questions++;
            localStorage.setItem('science_streak_calendar', JSON.stringify(window.streakData));
        };

        window.recordCorrectAnswer = function() {
            const today = new Date().toISOString().split('T')[0];
            if (!window.streakData[today]) {
                window.streakData[today] = { questions: 0, correct: 0 };
            }
            window.streakData[today].correct++;
            localStorage.setItem('science_streak_calendar', JSON.stringify(window.streakData));
        };

        window.showStreakCalendar = function() {
            // Remove existing
            document.querySelectorAll('.streak-calendar-modal, .calendar-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'calendar-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'streak-calendar-modal';

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();

            // Calculate streak
            let currentStreak = 0;
            let checkDate = new Date(today);
            while (true) {
                const dateStr = checkDate.toISOString().split('T')[0];
                if (window.streakData[dateStr] && window.streakData[dateStr].questions > 0) {
                    currentStreak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }

            // Get month name
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];

            // Build calendar HTML
            let calendarHTML = `
                <h2 style="margin: 0 0 5px 0; text-align: center;"> Study Calendar</h2>
                <div style="text-align: center; color: #666; margin-bottom: 15px;">
                    ${monthNames[currentMonth]} ${currentYear}
                </div>
                <div style="display: flex; justify-content: space-around; margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #FF6B6B, #FF8E53); border-radius: 15px; color: white;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: 700;"> ${currentStreak}</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">Day Streak</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: 700;">${Object.keys(window.streakData).length}</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">Active Days</div>
                    </div>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Sun</div>
                    <div class="calendar-day-header">Mon</div>
                    <div class="calendar-day-header">Tue</div>
                    <div class="calendar-day-header">Wed</div>
                    <div class="calendar-day-header">Thu</div>
                    <div class="calendar-day-header">Fri</div>
                    <div class="calendar-day-header">Sat</div>
            `;

            // Empty cells for days before month starts
            for (let i = 0; i < startDay; i++) {
                calendarHTML += '<div class="calendar-day" style="background: transparent;"></div>';
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = date.toISOString().split('T')[0];
                const data = window.streakData[dateStr];
                const isToday = date.toDateString() === today.toDateString();
                const isFuture = date > today;
                const isActive = data && data.questions > 0;

                let classes = 'calendar-day';
                if (isActive) classes += ' active';
                if (isToday) classes += ' today';
                if (isFuture) classes += ' future';

                calendarHTML += `
                    <div class="${classes}" title="${data ? data.questions + ' questions' : 'No activity'}">
                        <span>${day}</span>
                        ${isActive ? '<span class="calendar-day-fire"></span>' : ''}
                    </div>
                `;
            }

            calendarHTML += `
                </div>
                <button onclick="document.querySelectorAll('.streak-calendar-modal, .calendar-backdrop').forEach(el => el.remove());"
                        style="width: 100%; margin-top: 20px; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; font-weight: 600; cursor: pointer;">
                    Keep Studying! 
                </button>
            `;

            modal.innerHTML = calendarHTML;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        // Add calendar button to sidebar or create floating button
        window.createStreakCalendarButton = function() {
            // Remove existing
            document.querySelectorAll('.streak-calendar-btn').forEach(el => el.remove());

            const btn = document.createElement('button');
            btn.className = 'streak-calendar-btn';
            btn.style.cssText = `
                position: fixed;
                bottom: 170px;
                left: 20px;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                border: none;
                background: linear-gradient(135deg, #FF6B6B, #FF8E53);
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
                z-index: 999;
                transition: all 0.3s ease;
            `;
            btn.innerHTML = '';
            btn.title = 'View Streak Calendar';
            btn.onclick = showStreakCalendar;

            btn.onmouseenter = () => btn.style.transform = 'scale(1.1)';
            btn.onmouseleave = () => btn.style.transform = 'scale(1)';

            document.body.appendChild(btn);
        };

        // =====================================================
        // QUICK FLASHCARD REVIEW MODE
        // =====================================================
        window.FLASHCARDS = [
            { topic: 'Physics', question: 'What is the formula for force?', answer: 'F = ma (Force = mass  acceleration)' },
            { topic: 'Chemistry', question: 'What is the chemical formula for water?', answer: 'HO (two hydrogen atoms and one oxygen atom)' },
            { topic: 'Biology', question: 'What is the powerhouse of the cell?', answer: 'Mitochondria - they produce ATP through cellular respiration' },
            { topic: 'Physics', question: 'What is the speed of light?', answer: '299,792,458 meters per second (approximately 310 m/s)' },
            { topic: 'Chemistry', question: 'What is the pH of pure water?', answer: '7 - neutral, neither acidic nor basic' },
            { topic: 'Biology', question: 'What organelle contains genetic material?', answer: 'Nucleus - contains DNA organized into chromosomes' },
            { topic: 'Physics', question: 'What is Newton\'s Third Law?', answer: 'For every action, there is an equal and opposite reaction' },
            { topic: 'Chemistry', question: 'What is an isotope?', answer: 'Atoms of the same element with different numbers of neutrons' },
            { topic: 'Biology', question: 'What is photosynthesis?', answer: 'Process where plants convert CO and HO into glucose and O using light' },
            { topic: 'Physics', question: 'What is kinetic energy?', answer: 'Energy of motion: KE = mv (half mass times velocity squared)' },
            { topic: 'Chemistry', question: 'What is an ionic bond?', answer: 'A bond formed by the transfer of electrons between atoms' },
            { topic: 'Biology', question: 'What are the base pairs in DNA?', answer: 'Adenine-Thymine (A-T) and Guanine-Cytosine (G-C)' },
            { topic: 'Physics', question: 'What is Ohm\'s Law?', answer: 'V = IR (Voltage = Current  Resistance)' },
            { topic: 'Chemistry', question: 'What is a covalent bond?', answer: 'A bond formed by sharing electrons between atoms' },
            { topic: 'Biology', question: 'What is the function of red blood cells?', answer: 'Transport oxygen from lungs to body tissues using hemoglobin' }
        ];

        window.flashcardState = {
            currentIndex: 0,
            isFlipped: false,
            deck: []
        };

        window.startFlashcardMode = function() {
            // Remove existing
            document.querySelectorAll('.flashcard-container, .flashcard-backdrop').forEach(el => el.remove());

            // Shuffle deck
            window.flashcardState.deck = [...window.FLASHCARDS].sort(() => Math.random() - 0.5);
            window.flashcardState.currentIndex = 0;
            window.flashcardState.isFlipped = false;

            const backdrop = document.createElement('div');
            backdrop.className = 'flashcard-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(102,126,234,0.9), rgba(118,75,162,0.9)); z-index: 10005; backdrop-filter: blur(5px);';

            const container = document.createElement('div');
            container.className = 'flashcard-container';

            renderFlashcard(container);
            document.body.appendChild(backdrop);
            document.body.appendChild(container);

            // Keyboard navigation
            window.flashcardKeyHandler = function(e) {
                if (e.code === 'Space') {
                    e.preventDefault();
                    flipFlashcard();
                } else if (e.code === 'ArrowRight' || e.code === 'Enter') {
                    nextFlashcard();
                } else if (e.code === 'ArrowLeft') {
                    prevFlashcard();
                } else if (e.code === 'Escape') {
                    closeFlashcards();
                }
            };
            document.addEventListener('keydown', window.flashcardKeyHandler);
        };

        window.renderFlashcard = function(container) {
            const card = window.flashcardState.deck[window.flashcardState.currentIndex];
            const total = window.flashcardState.deck.length;
            const current = window.flashcardState.currentIndex + 1;

            container.innerHTML = `
                <div class="flashcard ${window.flashcardState.isFlipped ? 'flipped' : ''}" onclick="flipFlashcard()">
                    <div class="flashcard-face flashcard-front">
                        <div class="flashcard-topic"> ${card.topic}</div>
                        <div class="flashcard-question">${card.question}</div>
                        <div class="flashcard-hint">Tap or press Space to flip</div>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <div class="flashcard-topic"> Answer</div>
                        <div class="flashcard-answer">${card.answer}</div>
                    </div>
                </div>
                <div class="flashcard-controls">
                    <button class="flashcard-btn" onclick="prevFlashcard()" style="background: rgba(255,255,255,0.2); color: white;">
                         Previous
                    </button>
                    <button class="flashcard-btn" onclick="nextFlashcard()" style="background: white; color: #667eea;">
                        Next 
                    </button>
                </div>
                <div class="flashcard-progress">${current} / ${total}</div>
                <div style="text-align: center; margin-top: 10px;">
                    <button onclick="closeFlashcards()" style="background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 20px; border-radius: 20px; cursor: pointer;">
                        Exit Flashcards
                    </button>
                </div>
            `;
        };

        window.flipFlashcard = function() {
            window.flashcardState.isFlipped = !window.flashcardState.isFlipped;
            const container = document.querySelector('.flashcard-container');
            if (container) renderFlashcard(container);
        };

        window.nextFlashcard = function() {
            if (window.flashcardState.currentIndex < window.flashcardState.deck.length - 1) {
                window.flashcardState.currentIndex++;
                window.flashcardState.isFlipped = false;
                const container = document.querySelector('.flashcard-container');
                if (container) renderFlashcard(container);
            } else {
                // Completed all cards
                showFlashcardComplete();
            }
        };

        window.prevFlashcard = function() {
            if (window.flashcardState.currentIndex > 0) {
                window.flashcardState.currentIndex--;
                window.flashcardState.isFlipped = false;
                const container = document.querySelector('.flashcard-container');
                if (container) renderFlashcard(container);
            }
        };

        window.showFlashcardComplete = function() {
            const container = document.querySelector('.flashcard-container');
            if (container) {
                container.innerHTML = `
                    <div style="background: white; border-radius: 24px; padding: 40px; text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 20px;"></div>
                        <h2 style="margin: 0 0 10px 0; color: #333;">All Cards Reviewed!</h2>
                        <p style="color: #666; margin-bottom: 25px;">You reviewed ${window.flashcardState.deck.length} flashcards</p>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="startFlashcardMode()" style="padding: 12px 25px; border-radius: 25px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; cursor: pointer;">
                                 Review Again
                            </button>
                            <button onclick="closeFlashcards()" style="padding: 12px 25px; border-radius: 25px; border: none; background: #e0e0e0; color: #666; font-weight: 600; cursor: pointer;">
                                Done
                            </button>
                        </div>
                    </div>
                `;
            }
            // Award XP for completing review
            if (window.addXP) window.addXP(30, 'Flashcard review complete');
        };

        window.closeFlashcards = function() {
            document.querySelectorAll('.flashcard-container, .flashcard-backdrop').forEach(el => el.remove());
            if (window.flashcardKeyHandler) {
                document.removeEventListener('keydown', window.flashcardKeyHandler);
            }
        };

        // Add flashcard button
        window.createFlashcardButton = function() {
            // Remove existing
            document.querySelectorAll('.flashcard-mode-btn').forEach(el => el.remove());

            const btn = document.createElement('button');
            btn.className = 'flashcard-mode-btn';
            btn.style.cssText = `
                position: fixed;
                bottom: 230px;
                left: 20px;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                border: none;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                z-index: 999;
                transition: all 0.3s ease;
            `;
            btn.innerHTML = '';
            btn.title = 'Quick Flashcard Review';
            btn.onclick = startFlashcardMode;

            btn.onmouseenter = () => btn.style.transform = 'scale(1.1)';
            btn.onmouseleave = () => btn.style.transform = 'scale(1)';

            document.body.appendChild(btn);
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            createStreakCalendarButton();
            createFlashcardButton();
            recordTodayActivity(); // Record that user visited today
        });

        // Also init if DOM already loaded
        if (document.readyState !== 'loading') {
            createStreakCalendarButton();
            createFlashcardButton();
            recordTodayActivity();
        }

        console.log(' Science Facts, Streak Calendar, and Flashcard Review loaded!');
    </script>

    <!-- BATCH 15: Achievements Timeline, Learning Roadmap, Weekly Challenges -->
    <script>
        // =====================================================
        // ACHIEVEMENTS TIMELINE
        // =====================================================
        window.achievementsLog = JSON.parse(localStorage.getItem('science_achievements_log') || '[]');

        window.logAchievement = function(type, title, description, isMilestone = false) {
            const achievement = {
                id: Date.now(),
                type: type,
                title: title,
                description: description,
                milestone: isMilestone,
                timestamp: new Date().toISOString()
            };

            window.achievementsLog.unshift(achievement);

            // Keep only last 50 achievements
            if (window.achievementsLog.length > 50) {
                window.achievementsLog = window.achievementsLog.slice(0, 50);
            }

            localStorage.setItem('science_achievements_log', JSON.stringify(window.achievementsLog));
        };

        window.showAchievementsTimeline = function() {
            // Remove existing
            document.querySelectorAll('.achievements-timeline-modal, .timeline-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'timeline-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'achievements-timeline-modal';

            // Build timeline HTML
            let timelineHTML = `
                <h2 style="margin: 0 0 20px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span></span> Your Journey
                </h2>
            `;

            if (window.achievementsLog.length === 0) {
                timelineHTML += `
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                        <p>Your achievements will appear here as you progress!</p>
                    </div>
                `;
            } else {
                timelineHTML += '<div class="timeline-container">';

                window.achievementsLog.slice(0, 20).forEach(achievement => {
                    const date = new Date(achievement.timestamp);
                    const formattedDate = date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const icons = {
                        'level_up': '',
                        'badge': '',
                        'streak': '',
                        'challenge': '',
                        'milestone': '',
                        'xp': '',
                        'goal': ''
                    };

                    timelineHTML += `
                        <div class="timeline-item ${achievement.milestone ? 'milestone' : ''}">
                            <div class="timeline-date">${formattedDate}</div>
                            <div class="timeline-title">
                                <span>${icons[achievement.type] || ''}</span>
                                ${achievement.title}
                            </div>
                            <div class="timeline-desc">${achievement.description}</div>
                        </div>
                    `;
                });

                timelineHTML += '</div>';
            }

            timelineHTML += `
                <button onclick="document.querySelectorAll('.achievements-timeline-modal, .timeline-backdrop').forEach(el => el.remove());"
                        style="width: 100%; margin-top: 20px; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; font-weight: 600; cursor: pointer;">
                    Keep Achieving! 
                </button>
            `;

            modal.innerHTML = timelineHTML;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        // Add sample achievements if empty
        if (window.achievementsLog.length === 0) {
            logAchievement('milestone', 'Started Learning Journey', 'Began your science learning adventure!', true);
        }

        // =====================================================
        // LEARNING ROADMAP
        // =====================================================
        window.LEARNING_ROADMAP = [
            { id: 'basics', icon: '', title: 'Science Basics', desc: 'Fundamental concepts', questionsNeeded: 10, xpReward: 100 },
            { id: 'physics1', icon: '', title: 'Physics Foundations', desc: 'Force, motion, and energy', questionsNeeded: 25, xpReward: 200 },
            { id: 'chemistry1', icon: '', title: 'Chemistry Essentials', desc: 'Atoms, elements, and compounds', questionsNeeded: 25, xpReward: 200 },
            { id: 'biology1', icon: '', title: 'Biology Basics', desc: 'Cells and life processes', questionsNeeded: 25, xpReward: 200 },
            { id: 'intermediate', icon: '', title: 'Intermediate Science', desc: 'Building deeper understanding', questionsNeeded: 50, xpReward: 350 },
            { id: 'physics2', icon: '', title: 'Advanced Physics', desc: 'Waves, electricity, and magnetism', questionsNeeded: 40, xpReward: 300 },
            { id: 'chemistry2', icon: '', title: 'Advanced Chemistry', desc: 'Reactions and bonding', questionsNeeded: 40, xpReward: 300 },
            { id: 'biology2', icon: '', title: 'Advanced Biology', desc: 'Genetics and ecology', questionsNeeded: 40, xpReward: 300 },
            { id: 'expert', icon: '', title: 'Science Expert', desc: 'Master level challenges', questionsNeeded: 100, xpReward: 500 },
            { id: 'master', icon: '', title: 'Science Master', desc: 'Achieve ultimate mastery', questionsNeeded: 200, xpReward: 1000 }
        ];

        window.roadmapProgress = JSON.parse(localStorage.getItem('science_roadmap_progress') || '{}');

        window.updateRoadmapProgress = function() {
            const totalQuestions = window.gamificationState?.totalAttempts ||
                                  parseInt(localStorage.getItem('science_total_questions') || '0');

            localStorage.setItem('science_total_questions', totalQuestions);

            let cumulativeNeeded = 0;
            window.LEARNING_ROADMAP.forEach((node, index) => {
                cumulativeNeeded += node.questionsNeeded;

                if (!window.roadmapProgress[node.id]) {
                    window.roadmapProgress[node.id] = { completed: false, progress: 0 };
                }

                const prevCumulative = cumulativeNeeded - node.questionsNeeded;
                const nodeProgress = Math.max(0, Math.min(totalQuestions - prevCumulative, node.questionsNeeded));
                window.roadmapProgress[node.id].progress = nodeProgress;

                // Check for completion
                if (nodeProgress >= node.questionsNeeded && !window.roadmapProgress[node.id].completed) {
                    window.roadmapProgress[node.id].completed = true;
                    logAchievement('milestone', `Completed: ${node.title}`, `Finished the ${node.title} milestone!`, true);
                    if (window.addXP) window.addXP(node.xpReward, `Roadmap: ${node.title}`);
                }
            });

            localStorage.setItem('science_roadmap_progress', JSON.stringify(window.roadmapProgress));
        };

        window.showLearningRoadmap = function() {
            updateRoadmapProgress();

            // Remove existing
            document.querySelectorAll('.roadmap-modal, .roadmap-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'roadmap-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'roadmap-modal';

            let roadmapHTML = `
                <h2 style="margin: 0 0 20px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span></span> Learning Roadmap
                </h2>
                <div class="roadmap-path">
            `;

            let prevCompleted = true;
            window.LEARNING_ROADMAP.forEach((node, index) => {
                const progress = window.roadmapProgress[node.id] || { completed: false, progress: 0 };
                const isCompleted = progress.completed;
                const isCurrent = prevCompleted && !isCompleted;
                const isLocked = !prevCompleted && !isCompleted;
                prevCompleted = isCompleted;

                const percentage = Math.round((progress.progress / node.questionsNeeded) * 100);

                let statusClass = '';
                if (isCompleted) statusClass = 'completed';
                else if (isCurrent) statusClass = 'current';
                else if (isLocked) statusClass = 'locked';

                roadmapHTML += `
                    <div class="roadmap-node ${statusClass}">
                        <div class="roadmap-icon">${node.icon}</div>
                        <div class="roadmap-info">
                            <div class="roadmap-title">${node.title}</div>
                            <div class="roadmap-desc">${node.desc}</div>
                            <div style="font-size: 0.75rem; color: ${isCompleted ? '#4CAF50' : '#888'}; margin-top: 4px;">
                                ${isCompleted ? ' Completed' : `${progress.progress}/${node.questionsNeeded} questions`}
                            </div>
                        </div>
                        <div class="roadmap-progress">
                            ${isCompleted ? '' : `<div style="font-size: 0.9rem; font-weight: 600;">${percentage}%</div>`}
                            ${isCompleted ? '' : `<div style="font-size: 0.7rem; color: #888;">+${node.xpReward} XP</div>`}
                        </div>
                    </div>
                `;
            });

            roadmapHTML += `
                </div>
                <button onclick="document.querySelectorAll('.roadmap-modal, .roadmap-backdrop').forEach(el => el.remove());"
                        style="width: 100%; margin-top: 20px; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; cursor: pointer;">
                    Continue Journey! 
                </button>
            `;

            modal.innerHTML = roadmapHTML;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        // =====================================================
        // WEEKLY CHALLENGES
        // =====================================================
        window.weeklyChallenges = JSON.parse(localStorage.getItem('science_weekly_challenges') || 'null');

        window.getWeekNumber = function() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 1);
            const diff = now - start;
            const oneWeek = 604800000; // milliseconds in a week
            return Math.ceil((diff / oneWeek) + start.getDay() / 7);
        };

        window.initWeeklyChallenges = function() {
            const currentWeek = `${new Date().getFullYear()}-W${getWeekNumber()}`;

            if (!window.weeklyChallenges || window.weeklyChallenges.week !== currentWeek) {
                // Generate new challenges for the week
                window.weeklyChallenges = {
                    week: currentWeek,
                    challenges: [
                        { id: 'questions', icon: '', title: 'Question Master', target: 50, current: 0, reward: 150, desc: 'Answer 50 questions' },
                        { id: 'streak', icon: '', title: 'Streak Builder', target: 5, current: 0, reward: 100, desc: 'Achieve a 5-day streak' },
                        { id: 'accuracy', icon: '', title: 'Precision Pro', target: 20, current: 0, reward: 120, desc: 'Get 20 correct in a row' },
                        { id: 'flashcards', icon: '', title: 'Study Session', target: 3, current: 0, reward: 80, desc: 'Complete 3 flashcard reviews' },
                        { id: 'login', icon: '', title: 'Dedicated Learner', target: 5, current: 0, reward: 100, desc: 'Log in 5 days this week' }
                    ],
                    claimed: []
                };
                localStorage.setItem('science_weekly_challenges', JSON.stringify(window.weeklyChallenges));
            }
        };

        window.updateWeeklyChallenge = function(id, value) {
            initWeeklyChallenges();

            const challenge = window.weeklyChallenges.challenges.find(c => c.id === id);
            if (challenge && !window.weeklyChallenges.claimed.includes(id)) {
                challenge.current = Math.min(value, challenge.target);

                // Check for completion
                if (challenge.current >= challenge.target && !window.weeklyChallenges.claimed.includes(id)) {
                    window.weeklyChallenges.claimed.push(id);
                    if (window.addXP) window.addXP(challenge.reward, `Weekly Challenge: ${challenge.title}`);
                    logAchievement('challenge', `Challenge Complete: ${challenge.title}`, challenge.desc);
                }

                localStorage.setItem('science_weekly_challenges', JSON.stringify(window.weeklyChallenges));
            }
        };

        window.incrementWeeklyChallenge = function(id, amount = 1) {
            initWeeklyChallenges();
            const challenge = window.weeklyChallenges.challenges.find(c => c.id === id);
            if (challenge) {
                updateWeeklyChallenge(id, challenge.current + amount);
            }
        };

        window.getTimeUntilWeekEnd = function() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const daysUntilSunday = (7 - dayOfWeek) % 7 || 7;
            const endOfWeek = new Date(now);
            endOfWeek.setDate(now.getDate() + daysUntilSunday);
            endOfWeek.setHours(23, 59, 59, 999);

            const diff = endOfWeek - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

            return `${days}d ${hours}h remaining`;
        };

        window.showWeeklyChallenges = function() {
            initWeeklyChallenges();

            // Remove existing
            document.querySelectorAll('.weekly-challenges-modal, .weekly-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'weekly-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'weekly-challenges-modal';

            let challengesHTML = `
                <div class="weekly-header">
                    <h2 style="margin: 0;"> Weekly Challenges</h2>
                    <div class="weekly-timer"> ${getTimeUntilWeekEnd()}</div>
                </div>
            `;

            window.weeklyChallenges.challenges.forEach(challenge => {
                const isCompleted = window.weeklyChallenges.claimed.includes(challenge.id);
                const percentage = Math.round((challenge.current / challenge.target) * 100);

                challengesHTML += `
                    <div class="challenge-card ${isCompleted ? 'completed' : ''}">
                        <div class="challenge-icon">${challenge.icon}</div>
                        <div class="challenge-info">
                            <div class="challenge-title">${challenge.title}</div>
                            <div style="font-size: 0.8rem; color: #666;">${challenge.desc}</div>
                            ${isCompleted ? `
                                <div style="color: #4CAF50; font-weight: 600; font-size: 0.85rem; margin-top: 5px;"> Claimed!</div>
                            ` : `
                                <div class="challenge-progress-bar">
                                    <div class="challenge-progress-fill" style="width: ${percentage}%;"></div>
                                </div>
                                <div style="font-size: 0.75rem; color: #888; margin-top: 3px;">${challenge.current}/${challenge.target}</div>
                            `}
                        </div>
                        <div class="challenge-reward">
                            ${isCompleted ? '' : `+${challenge.reward}`}
                        </div>
                    </div>
                `;
            });

            const totalReward = window.weeklyChallenges.challenges.reduce((sum, c) => sum + c.reward, 0);
            const earnedReward = window.weeklyChallenges.challenges
                .filter(c => window.weeklyChallenges.claimed.includes(c.id))
                .reduce((sum, c) => sum + c.reward, 0);

            challengesHTML += `
                <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 12px; margin-top: 15px;">
                    <div style="font-size: 0.9rem; color: #666;">Total Rewards</div>
                    <div style="font-size: 1.3rem; font-weight: 700; color: #333;">${earnedReward} / ${totalReward} XP</div>
                </div>
                <button onclick="document.querySelectorAll('.weekly-challenges-modal, .weekly-backdrop').forEach(el => el.remove());"
                        style="width: 100%; margin-top: 15px; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; cursor: pointer;">
                    Keep Going! 
                </button>
            `;

            modal.innerHTML = challengesHTML;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        // =====================================================
        // CREATE FLOATING BUTTONS
        // =====================================================
        window.createBatch15Buttons = function() {
            // Timeline button
            let btn1 = document.querySelector('.timeline-btn');
            if (!btn1) {
                btn1 = document.createElement('button');
                btn1.className = 'timeline-btn';
                btn1.style.cssText = `
                    position: fixed;
                    bottom: 290px;
                    left: 20px;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    border: none;
                    background: linear-gradient(135deg, #4CAF50, #8BC34A);
                    color: white;
                    font-size: 1.5rem;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                    z-index: 999;
                    transition: all 0.3s ease;
                `;
                btn1.innerHTML = '';
                btn1.title = 'Achievements Timeline';
                btn1.onclick = showAchievementsTimeline;
                btn1.onmouseenter = () => btn1.style.transform = 'scale(1.1)';
                btn1.onmouseleave = () => btn1.style.transform = 'scale(1)';
                document.body.appendChild(btn1);
            }

            // Roadmap button
            let btn2 = document.querySelector('.roadmap-btn');
            if (!btn2) {
                btn2 = document.createElement('button');
                btn2.className = 'roadmap-btn';
                btn2.style.cssText = `
                    position: fixed;
                    bottom: 350px;
                    left: 20px;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    border: none;
                    background: linear-gradient(135deg, #2196F3, #03A9F4);
                    color: white;
                    font-size: 1.5rem;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
                    z-index: 999;
                    transition: all 0.3s ease;
                `;
                btn2.innerHTML = '';
                btn2.title = 'Learning Roadmap';
                btn2.onclick = showLearningRoadmap;
                btn2.onmouseenter = () => btn2.style.transform = 'scale(1.1)';
                btn2.onmouseleave = () => btn2.style.transform = 'scale(1)';
                document.body.appendChild(btn2);
            }

            // Weekly challenges button
            let btn3 = document.querySelector('.weekly-btn');
            if (!btn3) {
                btn3 = document.createElement('button');
                btn3.className = 'weekly-btn';
                btn3.style.cssText = `
                    position: fixed;
                    bottom: 410px;
                    left: 20px;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    border: none;
                    background: linear-gradient(135deg, #FF6B6B, #FF8E53);
                    color: white;
                    font-size: 1.5rem;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
                    z-index: 999;
                    transition: all 0.3s ease;
                `;
                btn3.innerHTML = '';
                btn3.title = 'Weekly Challenges';
                btn3.onclick = showWeeklyChallenges;
                btn3.onmouseenter = () => btn3.style.transform = 'scale(1.1)';
                btn3.onmouseleave = () => btn3.style.transform = 'scale(1)';
                document.body.appendChild(btn3);
            }
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            initWeeklyChallenges();
            createBatch15Buttons();
            updateRoadmapProgress();

            // Track login for weekly challenges
            incrementWeeklyChallenge('login', 1);
        });

        // Also init if DOM already loaded
        if (document.readyState !== 'loading') {
            initWeeklyChallenges();
            createBatch15Buttons();
            updateRoadmapProgress();
            incrementWeeklyChallenge('login', 1);
        }

        console.log(' Achievements Timeline, Learning Roadmap, and Weekly Challenges loaded!');
    </script>

    <!-- BATCH 16: Subject Mastery, Stats Dashboard, Tips -->
    <script>
        // =====================================================
        // SUBJECT MASTERY TRACKER
        // =====================================================
        window.SUBJECTS = [
            { id: 'physics', name: 'Physics', icon: '', color: '#3F51B5' },
            { id: 'chemistry', name: 'Chemistry', icon: '', color: '#9C27B0' },
            { id: 'biology', name: 'Biology', icon: '', color: '#4CAF50' },
            { id: 'earth', name: 'Earth Science', icon: '', color: '#009688' },
            { id: 'space', name: 'Space', icon: '', color: '#673AB7' },
            { id: 'general', name: 'General', icon: '', color: '#FF9800' }
        ];

        window.MASTERY_LEVELS = [
            { name: 'Novice', minPercent: 0, color: '#9E9E9E' },
            { name: 'Apprentice', minPercent: 20, color: '#8BC34A' },
            { name: 'Journeyman', minPercent: 40, color: '#4CAF50' },
            { name: 'Expert', minPercent: 60, color: '#2196F3' },
            { name: 'Master', minPercent: 80, color: '#9C27B0' },
            { name: 'Grandmaster', minPercent: 95, color: '#FFD700' }
        ];

        window.subjectMastery = JSON.parse(localStorage.getItem('science_subject_mastery') || '{}');

        // Initialize subjects
        window.SUBJECTS.forEach(subject => {
            if (!window.subjectMastery[subject.id]) {
                window.subjectMastery[subject.id] = { total: 0, correct: 0 };
            }
        });

        window.getMasteryLevel = function(percentage) {
            let level = window.MASTERY_LEVELS[0];
            for (let i = window.MASTERY_LEVELS.length - 1; i >= 0; i--) {
                if (percentage >= window.MASTERY_LEVELS[i].minPercent) {
                    level = window.MASTERY_LEVELS[i];
                    break;
                }
            }
            return level;
        };

        window.updateSubjectMastery = function(subjectId, isCorrect) {
            if (!window.subjectMastery[subjectId]) {
                window.subjectMastery[subjectId] = { total: 0, correct: 0 };
            }

            window.subjectMastery[subjectId].total++;
            if (isCorrect) {
                window.subjectMastery[subjectId].correct++;
            }

            localStorage.setItem('science_subject_mastery', JSON.stringify(window.subjectMastery));
        };

        window.showSubjectMastery = function() {
            // Remove existing
            document.querySelectorAll('.mastery-modal, .mastery-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'mastery-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'mastery-modal';

            let masteryHTML = `
                <h2 style="margin: 0 0 10px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span></span> Subject Mastery
                </h2>
                <p style="text-align: center; color: #666; margin-bottom: 15px;">Track your progress across different science topics</p>
                <div class="mastery-grid">
            `;

            window.SUBJECTS.forEach(subject => {
                const data = window.subjectMastery[subject.id] || { total: 0, correct: 0 };
                const percentage = data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0;
                const level = getMasteryLevel(percentage);

                // SVG ring calculation
                const radius = 28;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (percentage / 100) * circumference;

                masteryHTML += `
                    <div class="mastery-card">
                        <div class="mastery-icon">${subject.icon}</div>
                        <div class="mastery-title">${subject.name}</div>
                        <div class="mastery-level" style="color: ${level.color};">${level.name}</div>
                        <div class="mastery-ring">
                            <svg width="70" height="70">
                                <circle class="mastery-ring-bg" cx="35" cy="35" r="${radius}"/>
                                <circle class="mastery-ring-progress" cx="35" cy="35" r="${radius}"
                                        style="stroke: ${subject.color}; stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset}"/>
                            </svg>
                            <span class="mastery-percentage" style="color: ${subject.color};">${percentage}%</span>
                        </div>
                        <div style="font-size: 0.75rem; color: #888; margin-top: 8px;">${data.total} questions</div>
                    </div>
                `;
            });

            masteryHTML += `
                </div>
                <button onclick="document.querySelectorAll('.mastery-modal, .mastery-backdrop').forEach(el => el.remove());"
                        style="width: 100%; margin-top: 20px; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; font-weight: 600; cursor: pointer;">
                    Keep Mastering! 
                </button>
            `;

            modal.innerHTML = masteryHTML;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        // =====================================================
        // STATS DASHBOARD
        // =====================================================
        window.showStatsDashboard = function() {
            // Remove existing
            document.querySelectorAll('.stats-dashboard-modal, .stats-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'stats-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'stats-dashboard-modal';

            // Gather stats
            const stats = window.gamificationState || {};
            const totalQuestions = stats.totalAttempts || parseInt(localStorage.getItem('science_total_questions') || '0');
            const totalCorrect = stats.totalCorrect || 0;
            const accuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            const totalXP = stats.xp || 0;
            const level = stats.level || 1;
            const streakDays = Object.keys(window.streakData || {}).length;
            const badges = window.collectedBadges?.length || 0;
            const studySessions = parseInt(localStorage.getItem('science_study_sessions') || '1');

            // Calculate subject stats
            let subjectStats = [];
            window.SUBJECTS.forEach(subject => {
                const data = window.subjectMastery[subject.id] || { total: 0, correct: 0 };
                if (data.total > 0) {
                    subjectStats.push({
                        ...subject,
                        total: data.total,
                        accuracy: Math.round((data.correct / data.total) * 100)
                    });
                }
            });

            let statsHTML = `
                <h2 style="margin: 0 0 20px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span></span> Study Statistics
                </h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value">${totalQuestions}</div>
                        <div class="stat-label">Questions Answered</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value">${accuracy}%</div>
                        <div class="stat-label">Accuracy Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value">${totalXP.toLocaleString()}</div>
                        <div class="stat-label">Total XP Earned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value">${level}</div>
                        <div class="stat-label">Current Level</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value">${streakDays}</div>
                        <div class="stat-label">Active Days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value">${badges}</div>
                        <div class="stat-label">Badges Earned</div>
                    </div>
                </div>
            `;

            // Add subject breakdown if data exists
            if (subjectStats.length > 0) {
                const maxQuestions = Math.max(...subjectStats.map(s => s.total));

                statsHTML += `
                    <div class="stats-chart">
                        <h3 style="margin: 0 0 15px 0; font-size: 1rem; color: #333;">Questions by Subject</h3>
                `;

                subjectStats.sort((a, b) => b.total - a.total).forEach(subject => {
                    const widthPercent = (subject.total / maxQuestions) * 100;

                    statsHTML += `
                        <div class="chart-bar-container">
                            <span class="chart-label">${subject.icon}</span>
                            <div class="chart-bar-wrapper">
                                <div class="chart-bar" style="width: ${widthPercent}%; background: ${subject.color};"></div>
                            </div>
                            <span class="chart-value">${subject.total}</span>
                        </div>
                    `;
                });

                statsHTML += '</div>';
            }

            statsHTML += `
                <button onclick="document.querySelectorAll('.stats-dashboard-modal, .stats-backdrop').forEach(el => el.remove());"
                        style="width: 100%; margin-top: 20px; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; cursor: pointer;">
                    Keep Studying! 
                </button>
            `;

            modal.innerHTML = statsHTML;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        // =====================================================
        // TIP OF THE DAY
        // =====================================================
        window.STUDY_TIPS = [
            { tip: 'Space out your learning! Studies show spaced repetition helps you remember better than cramming.', icon: '' },
            { tip: 'Take short breaks every 25-30 minutes. Your brain consolidates learning during rest.', icon: '' },
            { tip: 'Try explaining concepts out loud as if teaching someone else. This reveals gaps in understanding.', icon: '' },
            { tip: 'Connect new information to things you already know. Building mental links improves recall.', icon: '' },
            { tip: 'Get enough sleep! Your brain processes and stores memories while you sleep.', icon: '' },
            { tip: 'Quiz yourself instead of just re-reading. Active recall is more effective than passive review.', icon: '' },
            { tip: 'Use diagrams and mind maps to visualize complex concepts and relationships.', icon: '' },
            { tip: 'Stay hydrated! Your brain is 75% water and functions best when properly hydrated.', icon: '' },
            { tip: 'Mix up your study topics. Interleaved practice improves long-term retention.', icon: '' },
            { tip: 'Set specific, achievable goals for each study session to stay motivated.', icon: '' },
            { tip: 'Minimize distractions. Put your phone on silent and find a quiet study space.', icon: '' },
            { tip: 'Review mistakes carefully. Errors are valuable learning opportunities!', icon: '' },
            { tip: 'Exercise before studying. Physical activity boosts brain function and memory.', icon: '' },
            { tip: 'Use mnemonic devices like acronyms or rhymes to remember lists and sequences.', icon: '' },
            { tip: 'Study your most challenging subjects when your energy is highest.', icon: '' }
        ];

        window.tipState = {
            lastShownDate: localStorage.getItem('science_tip_last_date') || '',
            shownToday: localStorage.getItem('science_tip_shown_today') === 'true'
        };

        window.showTipOfDay = function() {
            const today = new Date().toDateString();

            // Reset if new day
            if (window.tipState.lastShownDate !== today) {
                window.tipState.lastShownDate = today;
                window.tipState.shownToday = false;
                localStorage.setItem('science_tip_last_date', today);
                localStorage.setItem('science_tip_shown_today', 'false');
            }

            // Don't show if already shown today
            if (window.tipState.shownToday) return;

            // Remove existing
            document.querySelectorAll('.tip-of-day').forEach(el => el.remove());

            // Pick random tip
            const tip = window.STUDY_TIPS[Math.floor(Math.random() * window.STUDY_TIPS.length)];

            const tipEl = document.createElement('div');
            tipEl.className = 'tip-of-day';
            tipEl.innerHTML = `
                <button class="tip-dismiss" onclick="dismissTip()"></button>
                <div class="tip-header">
                    <span>${tip.icon}</span>
                    <span>Tip of the Day</span>
                </div>
                <div class="tip-text">${tip.tip}</div>
            `;

            document.body.appendChild(tipEl);

            // Animate in after delay
            setTimeout(() => {
                tipEl.classList.add('show');
            }, 2000);

            // Mark as shown
            window.tipState.shownToday = true;
            localStorage.setItem('science_tip_shown_today', 'true');
        };

        window.dismissTip = function() {
            const tip = document.querySelector('.tip-of-day');
            if (tip) {
                tip.classList.remove('show');
                setTimeout(() => tip.remove(), 500);
            }
        };

        // =====================================================
        // CREATE BUTTONS
        // =====================================================
        window.createBatch16Buttons = function() {
            // Subject Mastery button
            let btn1 = document.querySelector('.mastery-btn');
            if (!btn1) {
                btn1 = document.createElement('button');
                btn1.className = 'mastery-btn';
                btn1.style.cssText = `
                    position: fixed;
                    bottom: 470px;
                    left: 20px;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    border: none;
                    background: linear-gradient(135deg, #9C27B0, #673AB7);
                    color: white;
                    font-size: 1.5rem;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);
                    z-index: 999;
                    transition: all 0.3s ease;
                `;
                btn1.innerHTML = '';
                btn1.title = 'Subject Mastery';
                btn1.onclick = showSubjectMastery;
                btn1.onmouseenter = () => btn1.style.transform = 'scale(1.1)';
                btn1.onmouseleave = () => btn1.style.transform = 'scale(1)';
                document.body.appendChild(btn1);
            }

            // Stats Dashboard button
            let btn2 = document.querySelector('.stats-btn');
            if (!btn2) {
                btn2 = document.createElement('button');
                btn2.className = 'stats-btn';
                btn2.style.cssText = `
                    position: fixed;
                    bottom: 530px;
                    left: 20px;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    border: none;
                    background: linear-gradient(135deg, #00BCD4, #0097A7);
                    color: white;
                    font-size: 1.5rem;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
                    z-index: 999;
                    transition: all 0.3s ease;
                `;
                btn2.innerHTML = '';
                btn2.title = 'Statistics Dashboard';
                btn2.onclick = showStatsDashboard;
                btn2.onmouseenter = () => btn2.style.transform = 'scale(1.1)';
                btn2.onmouseleave = () => btn2.style.transform = 'scale(1)';
                document.body.appendChild(btn2);
            }
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            createBatch16Buttons();

            // Show tip of day after a delay
            setTimeout(showTipOfDay, 5000);

            // Increment study sessions
            const sessions = parseInt(localStorage.getItem('science_study_sessions') || '0') + 1;
            localStorage.setItem('science_study_sessions', sessions);
        });

        // Also init if DOM already loaded
        if (document.readyState !== 'loading') {
            createBatch16Buttons();
            setTimeout(showTipOfDay, 5000);
        }

        console.log(' Subject Mastery, Stats Dashboard, and Tips loaded!');
    </script>

    <!-- BATCH 17: Shortcuts Help, Focus Mode, Quick Nav -->
    <script>
        // =====================================================
        // KEYBOARD SHORTCUTS HELP
        // =====================================================
        window.KEYBOARD_SHORTCUTS = [
            { keys: ['?'], desc: 'Show keyboard shortcuts', category: 'Help' },
            { keys: ['Alt', 'K'], desc: 'Show shortcuts panel', category: 'Help' },
            { keys: ['Alt', 'A'], desc: 'Open avatar settings', category: 'Navigation' },
            { keys: ['Alt', 'N'], desc: 'Next question', category: 'Practice' },
            { keys: ['Alt', 'P'], desc: 'Previous question', category: 'Practice' },
            { keys: ['Space'], desc: 'Flip flashcard', category: 'Flashcards' },
            { keys: ['', ''], desc: 'Navigate flashcards', category: 'Flashcards' },
            { keys: ['Esc'], desc: 'Close modal/Exit mode', category: 'General' },
            { keys: ['Alt', 'F'], desc: 'Toggle focus mode', category: 'Study' },
            { keys: ['Alt', 'S'], desc: 'Open statistics', category: 'Navigation' },
            { keys: ['Alt', 'M'], desc: 'Open mastery tracker', category: 'Navigation' },
            { keys: ['1', '2', '3', '4'], desc: 'Quick answer selection', category: 'Practice' }
        ];

        window.showKeyboardShortcuts = function() {
            // Remove existing
            document.querySelectorAll('.shortcuts-modal, .shortcuts-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'shortcuts-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'shortcuts-modal';

            // Group shortcuts by category
            const categories = {};
            window.KEYBOARD_SHORTCUTS.forEach(shortcut => {
                if (!categories[shortcut.category]) {
                    categories[shortcut.category] = [];
                }
                categories[shortcut.category].push(shortcut);
            });

            let shortcutsHTML = `
                <h2 style="margin: 0 0 20px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span></span> Keyboard Shortcuts
                </h2>
            `;

            Object.entries(categories).forEach(([category, shortcuts]) => {
                shortcutsHTML += `<div style="margin-bottom: 20px;">`;
                shortcutsHTML += `<div style="font-weight: 600; color: #667eea; margin-bottom: 10px; font-size: 0.9rem;">${category}</div>`;

                shortcuts.forEach(shortcut => {
                    shortcutsHTML += `
                        <div class="shortcut-row">
                            <span class="shortcut-desc">${shortcut.desc}</span>
                            <div class="shortcut-keys">
                                ${shortcut.keys.map(k => `<span class="key">${k}</span>`).join('<span style="color: #999;">+</span>')}
                            </div>
                        </div>
                    `;
                });

                shortcutsHTML += `</div>`;
            });

            shortcutsHTML += `
                <button onclick="document.querySelectorAll('.shortcuts-modal, .shortcuts-backdrop').forEach(el => el.remove());"
                        style="width: 100%; margin-top: 15px; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; cursor: pointer;">
                    Got it!
                </button>
            `;

            modal.innerHTML = shortcutsHTML;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        // Global keyboard shortcut listener
        document.addEventListener('keydown', function(e) {
            // ? key to show shortcuts
            if (e.key === '?' && !e.target.matches('input, textarea, [contenteditable]')) {
                e.preventDefault();
                showKeyboardShortcuts();
            }

            // Alt+K for shortcuts
            if (e.altKey && e.key.toLowerCase() === 'k') {
                e.preventDefault();
                showKeyboardShortcuts();
            }

            // Alt+F for focus mode
            if (e.altKey && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                toggleFocusMode();
            }

            // Alt+S for statistics
            if (e.altKey && e.key.toLowerCase() === 's') {
                e.preventDefault();
                if (window.showStatsDashboard) showStatsDashboard();
            }

            // Alt+M for mastery
            if (e.altKey && e.key.toLowerCase() === 'm') {
                e.preventDefault();
                if (window.showSubjectMastery) showSubjectMastery();
            }

            // Escape to close modals
            if (e.key === 'Escape') {
                // Close any open modals
                const modals = document.querySelectorAll('.shortcuts-backdrop, .focus-mode-active, .quick-nav-panel.open');
                modals.forEach(m => {
                    if (m.classList.contains('quick-nav-panel')) {
                        m.classList.remove('open');
                    } else {
                        m.remove();
                    }
                });

                // Also close focus mode
                if (document.querySelector('.focus-mode-container')) {
                    exitFocusMode();
                }
            }
        });

        // =====================================================
        // FOCUS MODE
        // =====================================================
        window.focusState = {
            active: false,
            duration: 25, // minutes
            elapsed: 0, // seconds
            interval: null,
            questionsAnswered: 0
        };

        window.toggleFocusMode = function() {
            if (window.focusState.active) {
                exitFocusMode();
            } else {
                showFocusModeSetup();
            }
        };

        window.showFocusModeSetup = function() {
            // Remove existing
            document.querySelectorAll('.focus-setup-modal, .focus-setup-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'focus-setup-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 24px;
                padding: 30px;
                max-width: 400px;
                width: 90%;
                z-index: 10006;
                box-shadow: 0 25px 80px rgba(0,0,0,0.3);
                text-align: center;
            `;
            modal.className = 'focus-setup-modal';

            modal.innerHTML = `
                <h2 style="margin: 0 0 10px 0;"> Focus Mode</h2>
                <p style="color: #666; margin-bottom: 20px;">Minimize distractions and concentrate on learning</p>

                <div style="margin-bottom: 25px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">Select Duration</div>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        ${[15, 25, 30, 45, 60].map(mins => `
                            <button onclick="setFocusDuration(${mins})"
                                    style="padding: 10px 20px; border-radius: 10px; border: 2px solid ${window.focusState.duration === mins ? '#4CAF50' : '#e0e0e0'};
                                           background: ${window.focusState.duration === mins ? '#E8F5E9' : 'white'};
                                           font-weight: 600; cursor: pointer;">
                                ${mins}m
                            </button>
                        `).join('')}
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: left;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Focus mode will:</div>
                    <ul style="margin: 0; padding-left: 20px; color: #666; font-size: 0.9rem;">
                        <li>Hide all notifications and popups</li>
                        <li>Show a distraction-free study area</li>
                        <li>Track your focus session progress</li>
                        <li>Award bonus XP when complete</li>
                    </ul>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="document.querySelectorAll('.focus-setup-modal, .focus-setup-backdrop').forEach(el => el.remove());"
                            style="flex: 1; padding: 12px; border-radius: 25px; border: none; background: #e0e0e0; color: #666; font-weight: 600; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="startFocusMode()"
                            style="flex: 2; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; font-weight: 600; cursor: pointer;">
                         Start Focus Session
                    </button>
                </div>
            `;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.setFocusDuration = function(mins) {
            window.focusState.duration = mins;
            showFocusModeSetup();
        };

        window.startFocusMode = function() {
            // Remove setup modal
            document.querySelectorAll('.focus-setup-modal, .focus-setup-backdrop').forEach(el => el.remove());

            window.focusState.active = true;
            window.focusState.elapsed = 0;
            window.focusState.questionsAnswered = 0;

            // Create focus mode overlay
            const overlay = document.createElement('div');
            overlay.className = 'focus-mode-active';

            const container = document.createElement('div');
            container.className = 'focus-mode-container';

            const totalSeconds = window.focusState.duration * 60;

            container.innerHTML = `
                <div class="focus-mode-header">
                    <div>
                        <h2 style="margin: 0;"> Focus Mode</h2>
                        <div style="color: #666; font-size: 0.9rem;">Stay focused and keep learning!</div>
                    </div>
                    <div class="focus-timer-display" id="focus-timer">
                        ${formatFocusTime(totalSeconds)}
                    </div>
                </div>

                <div class="focus-progress">
                    <div class="focus-progress-fill" id="focus-progress-fill" style="width: 0%;"></div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: 700;" id="focus-questions">0</div>
                        <div style="font-size: 0.8rem; color: #666;">Questions</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: 700;" id="focus-correct">0</div>
                        <div style="font-size: 0.8rem; color: #666;">Correct</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: 700;">${window.focusState.duration}:00</div>
                        <div style="font-size: 0.8rem; color: #666;">Goal Time</div>
                    </div>
                </div>

                <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #E3F2FD, #BBDEFB); border-radius: 16px; margin-bottom: 20px;">
                    <div style="font-size: 1.1rem; color: #1976D2; font-weight: 600;"> Tip: Use Alt+N for next question</div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="pauseFocusMode()" id="focus-pause-btn"
                            style="padding: 12px 25px; border-radius: 25px; border: none; background: #FF9800; color: white; font-weight: 600; cursor: pointer;">
                         Pause
                    </button>
                    <button onclick="exitFocusMode()"
                            style="padding: 12px 25px; border-radius: 25px; border: none; background: #e0e0e0; color: #666; font-weight: 600; cursor: pointer;">
                        Exit Session
                    </button>
                </div>
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(container);

            // Start timer
            window.focusState.interval = setInterval(updateFocusTimer, 1000);
        };

        window.formatFocusTime = function(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        window.updateFocusTimer = function() {
            window.focusState.elapsed++;

            const totalSeconds = window.focusState.duration * 60;
            const remaining = totalSeconds - window.focusState.elapsed;

            if (remaining <= 0) {
                completeFocusSession();
                return;
            }

            // Update display
            const timerEl = document.getElementById('focus-timer');
            if (timerEl) {
                timerEl.textContent = formatFocusTime(remaining);
            }

            // Update progress
            const progressEl = document.getElementById('focus-progress-fill');
            if (progressEl) {
                const percent = (window.focusState.elapsed / totalSeconds) * 100;
                progressEl.style.width = percent + '%';
            }
        };

        window.pauseFocusMode = function() {
            const pauseBtn = document.getElementById('focus-pause-btn');
            if (window.focusState.interval) {
                clearInterval(window.focusState.interval);
                window.focusState.interval = null;
                if (pauseBtn) {
                    pauseBtn.innerHTML = ' Resume';
                    pauseBtn.onclick = resumeFocusMode;
                }
            }
        };

        window.resumeFocusMode = function() {
            window.focusState.interval = setInterval(updateFocusTimer, 1000);
            const pauseBtn = document.getElementById('focus-pause-btn');
            if (pauseBtn) {
                pauseBtn.innerHTML = ' Pause';
                pauseBtn.onclick = pauseFocusMode;
            }
        };

        window.exitFocusMode = function() {
            if (window.focusState.interval) {
                clearInterval(window.focusState.interval);
                window.focusState.interval = null;
            }

            window.focusState.active = false;
            document.querySelectorAll('.focus-mode-active, .focus-mode-container').forEach(el => el.remove());
        };

        window.completeFocusSession = function() {
            if (window.focusState.interval) {
                clearInterval(window.focusState.interval);
                window.focusState.interval = null;
            }

            const questionsAnswered = window.focusState.questionsAnswered;
            const bonusXP = Math.max(50 + questionsAnswered * 10, 100);

            // Remove focus UI
            document.querySelectorAll('.focus-mode-active, .focus-mode-container').forEach(el => el.remove());

            window.focusState.active = false;

            // Show completion modal
            const backdrop = document.createElement('div');
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10010; backdrop-filter: blur(5px);';

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 24px;
                padding: 40px;
                max-width: 400px;
                width: 90%;
                z-index: 10011;
                text-align: center;
            `;

            modal.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 15px;"></div>
                <h2 style="margin: 0 0 10px 0; color: #333;">Focus Session Complete!</h2>
                <p style="color: #666; margin-bottom: 20px;">You stayed focused for ${window.focusState.duration} minutes!</p>

                <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 15px 30px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="color: white; font-weight: 700; font-size: 1.5rem;">+${bonusXP} XP Bonus!</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: 700;">${questionsAnswered}</div>
                        <div style="font-size: 0.8rem; color: #666;">Questions</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: 700;">${window.focusState.duration}m</div>
                        <div style="font-size: 0.8rem; color: #666;">Duration</div>
                    </div>
                </div>

                <button onclick="this.parentElement.remove(); this.parentElement.previousSibling.remove();"
                        style="width: 100%; padding: 15px; border-radius: 25px; border: none; background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; font-weight: 600; cursor: pointer; font-size: 1rem;">
                    Awesome! 
                </button>
            `;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);

            // Award XP
            if (window.addXP) window.addXP(bonusXP, 'Focus session complete');
            if (window.logAchievement) logAchievement('goal', 'Focus Session Complete', `Stayed focused for ${window.focusState.duration} minutes!`);

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
        };

        // =====================================================
        // QUICK NAVIGATION MENU
        // =====================================================
        window.quickNavOpen = false;

        window.createQuickNav = function() {
            // Remove existing
            document.querySelectorAll('.quick-nav-trigger, .quick-nav-panel').forEach(el => el.remove());

            // Create trigger
            const trigger = document.createElement('div');
            trigger.className = 'quick-nav-trigger';
            trigger.innerHTML = ' Quick Access';
            trigger.onclick = toggleQuickNav;

            // Create panel
            const panel = document.createElement('div');
            panel.className = 'quick-nav-panel';

            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;"> Quick Access</h3>
                    <button onclick="toggleQuickNav()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;"></button>
                </div>

                <div class="quick-nav-section">Study Tools</div>
                <div class="quick-nav-item" onclick="if(window.startFlashcardMode) startFlashcardMode(); toggleQuickNav();">
                    <span class="quick-nav-icon"></span>
                    <span class="quick-nav-label">Flashcards</span>
                </div>
                <div class="quick-nav-item" onclick="toggleFocusMode(); toggleQuickNav();">
                    <span class="quick-nav-icon"></span>
                    <span class="quick-nav-label">Focus Mode</span>
                </div>
                <div class="quick-nav-item" onclick="if(window.showLuckyWheel) showLuckyWheel(); toggleQuickNav();">
                    <span class="quick-nav-icon"></span>
                    <span class="quick-nav-label">Lucky Wheel</span>
                </div>

                <div class="quick-nav-section">Progress</div>
                <div class="quick-nav-item" onclick="if(window.showStatsDashboard) showStatsDashboard(); toggleQuickNav();">
                    <span class="quick-nav-icon"></span>
                    <span class="quick-nav-label">Statistics</span>
                </div>
                <div class="quick-nav-item" onclick="if(window.showSubjectMastery) showSubjectMastery(); toggleQuickNav();">
                    <span class="quick-nav-icon"></span>
                    <span class="quick-nav-label">Subject Mastery</span>
                </div>
                <div class="quick-nav-item" onclick="if(window.showLearningRoadmap) showLearningRoadmap(); toggleQuickNav();">
                    <span class="quick-nav-icon"></span>
                    <span class="quick-nav-label">Learning Roadmap</span>
                </div>

                <div class="quick-nav-section">Rewards</div>
                <div class="quick-nav-item" onclick="if(window.showWeeklyChallenges) showWeeklyChallenges(); toggleQuickNav();">
                    <span class="quick-nav-icon"></span>
                    <span class="quick-nav-label">Weekly Challenges</span>
                </div>
                <div class="quick-nav-item" onclick="if(window.showAchievementsTimeline) showAchievementsTimeline(); toggleQuickNav();">
                    <span class="quick-nav-icon"></span>
                    <span class="quick-nav-label">Achievements</span>
                </div>
                <div class="quick-nav-item" onclick="if(window.showStreakCalendar) showStreakCalendar(); toggleQuickNav();">
                    <span class="quick-nav-icon"></span>
                    <span class="quick-nav-label">Streak Calendar</span>
                </div>

                <div class="quick-nav-section">Help</div>
                <div class="quick-nav-item" onclick="showKeyboardShortcuts(); toggleQuickNav();">
                    <span class="quick-nav-icon"></span>
                    <span class="quick-nav-label">Keyboard Shortcuts</span>
                </div>
            `;

            document.body.appendChild(trigger);
            document.body.appendChild(panel);
        };

        window.toggleQuickNav = function() {
            const panel = document.querySelector('.quick-nav-panel');
            if (panel) {
                window.quickNavOpen = !window.quickNavOpen;
                panel.classList.toggle('open', window.quickNavOpen);
            }
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            createQuickNav();
        });

        // Also init if DOM already loaded
        if (document.readyState !== 'loading') {
            createQuickNav();
        }

        console.log(' Keyboard Shortcuts, Focus Mode, and Quick Navigation loaded!');
    </script>

    <!-- BATCH 18: Help Center, Theme Customization, Notifications -->
    <script>
        // =====================================================
        // HELP CENTER / FAQ
        // =====================================================
        window.FAQ_ITEMS = [
            {
                question: 'How do I earn XP?',
                answer: 'You earn XP by answering questions (10-20 XP per correct answer), completing daily goals (+100 XP), finishing weekly challenges, playing mini-games, completing flashcard reviews, and focus sessions. Streak multipliers and difficulty settings can boost your XP earnings!'
            },
            {
                question: 'What are the different difficulty levels?',
                answer: 'We have 4 difficulty levels: Easy (0.8x XP), Medium (1x XP), Hard (1.5x XP), and Expert (2x XP). Higher difficulties give more XP per question but may be more challenging. You can change difficulty anytime from the settings.'
            },
            {
                question: 'How does the streak system work?',
                answer: 'Your streak increases each day you practice. The longer your streak, the higher your XP multiplier! A 3-day streak gives 1.25x, 7 days gives 1.5x, and 14+ days gives 2x XP. Miss a day and your streak resets, but comeback bonuses help you recover!'
            },
            {
                question: 'What is Focus Mode?',
                answer: 'Focus Mode is a distraction-free study environment. Set a duration (15-60 minutes), and the app will hide notifications and track your study session. Complete a focus session to earn bonus XP based on duration and questions answered!'
            },
            {
                question: 'How do I unlock badges?',
                answer: 'Badges are earned by reaching milestones: answer questions, maintain streaks, complete challenges, and reach certain levels. Check your badges collection to see what you\'ve earned and what\'s still available!'
            },
            {
                question: 'What are Weekly Challenges?',
                answer: 'Weekly Challenges reset every Sunday and give you goals like "Answer 50 questions" or "Maintain a 5-day streak". Complete them for bonus XP rewards. Check your progress in the Weekly Challenges panel!'
            },
            {
                question: 'How do I use Flashcards?',
                answer: 'Click the flashcard button () or use the Quick Navigation panel. Tap cards to flip between question and answer. Use keyboard arrows or buttons to navigate. Complete a full deck for bonus XP!'
            },
            {
                question: 'What keyboard shortcuts are available?',
                answer: 'Press ? or Alt+K to see all shortcuts. Key ones: Alt+F for Focus Mode, Alt+S for Statistics, Alt+M for Mastery, Alt+N/P for next/previous question, Space to flip flashcards, and Escape to close modals.'
            },
            {
                question: 'How do I track my progress?',
                answer: 'Use the Statistics Dashboard () for overall stats, Subject Mastery () for per-subject progress, Learning Roadmap () for milestone tracking, and Streak Calendar () for daily activity history.'
            },
            {
                question: 'Can I change the app theme?',
                answer: 'Yes! Click the Settings button and choose from different color themes. Your preference is saved automatically and persists across sessions.'
            }
        ];

        window.showHelpCenter = function() {
            // Remove existing
            document.querySelectorAll('.help-center-modal, .help-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'help-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'help-center-modal';

            let helpHTML = `
                <h2 style="margin: 0 0 10px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span></span> Help Center
                </h2>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Frequently asked questions about the Science Learning App</p>
            `;

            window.FAQ_ITEMS.forEach((item, index) => {
                helpHTML += `
                    <div class="faq-item" id="faq-${index}">
                        <div class="faq-question" onclick="toggleFAQ(${index})">
                            <span>${item.question}</span>
                            <span class="faq-arrow"></span>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-text">${item.answer}</div>
                        </div>
                    </div>
                `;
            });

            helpHTML += `
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #E3F2FD, #BBDEFB); border-radius: 12px;">
                    <div style="font-weight: 600; color: #1976D2; margin-bottom: 5px;"> Quick Tip</div>
                    <div style="font-size: 0.9rem; color: #555;">Press ? anywhere in the app to see keyboard shortcuts!</div>
                </div>
                <button onclick="document.querySelectorAll('.help-center-modal, .help-backdrop').forEach(el => el.remove());"
                        style="width: 100%; margin-top: 20px; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; font-weight: 600; cursor: pointer;">
                    Got it! 
                </button>
            `;

            modal.innerHTML = helpHTML;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.toggleFAQ = function(index) {
            const faqItem = document.getElementById(`faq-${index}`);
            if (faqItem) {
                faqItem.classList.toggle('open');
            }
        };

        // =====================================================
        // THEME CUSTOMIZATION
        // =====================================================
        window.THEMES = [
            { id: 'default', name: 'Default Green', primary: '#4CAF50', secondary: '#8BC34A', icon: '' },
            { id: 'ocean', name: 'Ocean Blue', primary: '#2196F3', secondary: '#03A9F4', icon: '' },
            { id: 'sunset', name: 'Sunset Orange', primary: '#FF9800', secondary: '#FFC107', icon: '' },
            { id: 'berry', name: 'Berry Purple', primary: '#9C27B0', secondary: '#E91E63', icon: '' },
            { id: 'midnight', name: 'Midnight', primary: '#3F51B5', secondary: '#673AB7', icon: '' },
            { id: 'forest', name: 'Forest', primary: '#009688', secondary: '#4CAF50', icon: '' },
            { id: 'coral', name: 'Coral Reef', primary: '#FF6B6B', secondary: '#FF8E53', icon: '' },
            { id: 'lavender', name: 'Lavender', primary: '#667eea', secondary: '#764ba2', icon: '' },
            { id: 'mint', name: 'Fresh Mint', primary: '#4ECDC4', secondary: '#44A08D', icon: '' }
        ];

        window.currentTheme = localStorage.getItem('science_app_theme') || 'default';

        window.showThemeCustomizer = function() {
            // Remove existing
            document.querySelectorAll('.theme-modal, .theme-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'theme-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'theme-modal';

            let themeHTML = `
                <h2 style="margin: 0 0 10px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span></span> Choose Theme
                </h2>
                <p style="text-align: center; color: #666; margin-bottom: 15px;">Personalize your learning experience</p>
                <div class="theme-grid">
            `;

            window.THEMES.forEach(theme => {
                const isSelected = window.currentTheme === theme.id;
                themeHTML += `
                    <div class="theme-option ${isSelected ? 'selected' : ''}"
                         onclick="selectTheme('${theme.id}')"
                         title="${theme.name}"
                         style="background: linear-gradient(135deg, ${theme.primary}, ${theme.secondary});">
                        <div class="theme-preview">
                            <div class="theme-preview-header" style="background: linear-gradient(135deg, ${theme.primary}, ${theme.secondary});"></div>
                            <div class="theme-preview-body">${theme.icon}</div>
                        </div>
                    </div>
                `;
            });

            themeHTML += `
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 12px; text-align: center;">
                    <div style="font-weight: 600; color: #333;">Current: ${window.THEMES.find(t => t.id === window.currentTheme)?.name || 'Default'}</div>
                </div>
                <button onclick="document.querySelectorAll('.theme-modal, .theme-backdrop').forEach(el => el.remove());"
                        style="width: 100%; margin-top: 15px; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; cursor: pointer;">
                    Done
                </button>
            `;

            modal.innerHTML = themeHTML;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.selectTheme = function(themeId) {
            window.currentTheme = themeId;
            localStorage.setItem('science_app_theme', themeId);
            applyTheme(themeId);
            showThemeCustomizer(); // Refresh to show selection
        };

        window.applyTheme = function(themeId) {
            const theme = window.THEMES.find(t => t.id === themeId);
            if (!theme) return;

            document.documentElement.style.setProperty('--theme-primary', theme.primary);
            document.documentElement.style.setProperty('--theme-secondary', theme.secondary);

            // Apply to various elements (simplified, targeting key elements)
            const styleEl = document.getElementById('theme-override') || document.createElement('style');
            styleEl.id = 'theme-override';
            styleEl.textContent = `
                .sidebar-top-section { background: linear-gradient(135deg, ${theme.primary}, ${theme.secondary}) !important; }
                .submit-btn, .primary-btn { background: linear-gradient(135deg, ${theme.primary}, ${theme.secondary}) !important; }
            `;

            if (!document.getElementById('theme-override')) {
                document.head.appendChild(styleEl);
            }
        };

        // =====================================================
        // NOTIFICATION SETTINGS
        // =====================================================
        window.notificationSettings = JSON.parse(localStorage.getItem('science_notification_settings') || JSON.stringify({
            tips: true,
            reminders: true,
            celebrations: true,
            sounds: true,
            encouragement: true
        }));

        window.showNotificationSettings = function() {
            // Remove existing
            document.querySelectorAll('.settings-modal, .settings-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'settings-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'settings-modal';

            const settings = [
                { id: 'tips', label: 'Daily Tips', desc: 'Show tip of the day' },
                { id: 'reminders', label: 'Practice Reminders', desc: 'Remind me to practice' },
                { id: 'celebrations', label: 'Celebrations', desc: 'Show confetti and celebrations' },
                { id: 'sounds', label: 'Sound Effects', desc: 'Play sound effects' },
                { id: 'encouragement', label: 'Encouragement', desc: 'Show encouraging messages' }
            ];

            let settingsHTML = `
                <h2 style="margin: 0 0 20px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span></span> Settings
                </h2>
            `;

            settings.forEach(setting => {
                const isOn = window.notificationSettings[setting.id];
                settingsHTML += `
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">${setting.label}</div>
                            <div class="setting-desc">${setting.desc}</div>
                        </div>
                        <div class="toggle-switch ${isOn ? 'on' : ''}" onclick="toggleSetting('${setting.id}', this)"></div>
                    </div>
                `;
            });

            settingsHTML += `
                <div style="border-top: 2px solid #eee; margin-top: 20px; padding-top: 15px;">
                    <div class="setting-item" style="border-bottom: none;">
                        <div class="setting-info">
                            <div class="setting-label"> Theme</div>
                            <div class="setting-desc">Customize app colors</div>
                        </div>
                        <button onclick="document.querySelectorAll('.settings-modal, .settings-backdrop').forEach(el => el.remove()); showThemeCustomizer();"
                                style="padding: 8px 15px; border-radius: 20px; border: 1px solid #e0e0e0; background: white; cursor: pointer; font-weight: 500;">
                            Change 
                        </button>
                    </div>
                </div>
                <button onclick="document.querySelectorAll('.settings-modal, .settings-backdrop').forEach(el => el.remove());"
                        style="width: 100%; margin-top: 20px; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; font-weight: 600; cursor: pointer;">
                    Save Settings
                </button>
            `;

            modal.innerHTML = settingsHTML;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.toggleSetting = function(settingId, element) {
            window.notificationSettings[settingId] = !window.notificationSettings[settingId];
            element.classList.toggle('on');
            localStorage.setItem('science_notification_settings', JSON.stringify(window.notificationSettings));
        };

        // =====================================================
        // ADD SETTINGS BUTTON
        // =====================================================
        window.createSettingsButton = function() {
            // Remove existing
            document.querySelectorAll('.settings-fab').forEach(el => el.remove());

            const btn = document.createElement('button');
            btn.className = 'settings-fab';
            btn.style.cssText = `
                position: fixed;
                bottom: 590px;
                left: 20px;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                border: none;
                background: linear-gradient(135deg, #607D8B, #455A64);
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(96, 125, 139, 0.4);
                z-index: 999;
                transition: all 0.3s ease;
            `;
            btn.innerHTML = '';
            btn.title = 'Settings';
            btn.onclick = showNotificationSettings;
            btn.onmouseenter = () => btn.style.transform = 'scale(1.1)';
            btn.onmouseleave = () => btn.style.transform = 'scale(1)';

            document.body.appendChild(btn);
        };

        // Add help button
        window.createHelpButton = function() {
            document.querySelectorAll('.help-fab').forEach(el => el.remove());

            const btn = document.createElement('button');
            btn.className = 'help-fab';
            btn.style.cssText = `
                position: fixed;
                bottom: 650px;
                left: 20px;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                border: none;
                background: linear-gradient(135deg, #FF9800, #F57C00);
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
                z-index: 999;
                transition: all 0.3s ease;
            `;
            btn.innerHTML = '';
            btn.title = 'Help Center';
            btn.onclick = showHelpCenter;
            btn.onmouseenter = () => btn.style.transform = 'scale(1.1)';
            btn.onmouseleave = () => btn.style.transform = 'scale(1)';

            document.body.appendChild(btn);
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            createSettingsButton();
            createHelpButton();
            applyTheme(window.currentTheme);
        });

        // Also init if DOM already loaded
        if (document.readyState !== 'loading') {
            createSettingsButton();
            createHelpButton();
            applyTheme(window.currentTheme);
        }

        console.log(' Help Center, Theme Customization, and Notification Settings loaded!');
    </script>

    <!-- BATCH 19: Session Summary, Performance Insights, Recommendations -->
    <script>
        // =====================================================
        // SESSION SUMMARY
        // =====================================================
        window.currentSessionStats = {
            startTime: Date.now(),
            questions: 0,
            correct: 0,
            xpEarned: 0,
            streakMax: 0
        };

        window.updateSessionStats = function(isCorrect, xp = 0) {
            window.currentSessionStats.questions++;
            if (isCorrect) {
                window.currentSessionStats.correct++;
            }
            window.currentSessionStats.xpEarned += xp;
        };

        window.showSessionSummary = function() {
            // Remove existing
            document.querySelectorAll('.session-summary-modal, .session-summary-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'session-summary-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'session-summary-modal';

            // Calculate session duration
            const durationMs = Date.now() - window.currentSessionStats.startTime;
            const durationMins = Math.round(durationMs / 60000);

            // Calculate accuracy
            const accuracy = window.currentSessionStats.questions > 0
                ? Math.round((window.currentSessionStats.correct / window.currentSessionStats.questions) * 100)
                : 0;

            // Determine performance message
            let performanceIcon, performanceMessage;
            if (accuracy >= 90) {
                performanceIcon = '';
                performanceMessage = 'Outstanding performance!';
            } else if (accuracy >= 70) {
                performanceIcon = '';
                performanceMessage = 'Great job!';
            } else if (accuracy >= 50) {
                performanceIcon = '';
                performanceMessage = 'Keep practicing!';
            } else {
                performanceIcon = '';
                performanceMessage = 'Room for improvement!';
            }

            modal.innerHTML = `
                <h2 style="margin: 0 0 10px 0; text-align: center;"> Session Summary</h2>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Here's how you did this session</p>

                <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #E8F5E9, #C8E6C9); border-radius: 16px; margin-bottom: 20px;">
                    <div style="font-size: 3rem;">${performanceIcon}</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: #333;">${performanceMessage}</div>
                </div>

                <div class="session-stats-grid">
                    <div class="session-stat-box">
                        <div class="session-stat-value">${window.currentSessionStats.questions}</div>
                        <div class="session-stat-label">Questions</div>
                    </div>
                    <div class="session-stat-box">
                        <div class="session-stat-value">${accuracy}%</div>
                        <div class="session-stat-label">Accuracy</div>
                    </div>
                    <div class="session-stat-box">
                        <div class="session-stat-value">+${window.currentSessionStats.xpEarned}</div>
                        <div class="session-stat-label">XP Earned</div>
                    </div>
                    <div class="session-stat-box">
                        <div class="session-stat-value">${durationMins}m</div>
                        <div class="session-stat-label">Duration</div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="document.querySelectorAll('.session-summary-modal, .session-summary-backdrop').forEach(el => el.remove()); resetSession();"
                            style="flex: 1; padding: 12px; border-radius: 25px; border: none; background: #e0e0e0; color: #666; font-weight: 600; cursor: pointer;">
                        New Session
                    </button>
                    <button onclick="document.querySelectorAll('.session-summary-modal, .session-summary-backdrop').forEach(el => el.remove());"
                            style="flex: 1; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; font-weight: 600; cursor: pointer;">
                        Continue
                    </button>
                </div>
            `;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.resetSession = function() {
            window.currentSessionStats = {
                startTime: Date.now(),
                questions: 0,
                correct: 0,
                xpEarned: 0,
                streakMax: 0
            };
        };

        // =====================================================
        // PERFORMANCE INSIGHTS
        // =====================================================
        window.generateInsights = function() {
            const insights = [];

            const stats = window.gamificationState || {};
            const totalQuestions = stats.totalAttempts || parseInt(localStorage.getItem('science_total_questions') || '0');
            const totalCorrect = stats.totalCorrect || 0;
            const accuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            const streakDays = Object.keys(window.streakData || {}).length;

            // Positive insights
            if (accuracy >= 80) {
                insights.push({
                    type: 'positive',
                    icon: '',
                    title: 'Excellent Accuracy!',
                    text: `Your ${accuracy}% accuracy rate is impressive! You're mastering the material well.`
                });
            }

            if (streakDays >= 7) {
                insights.push({
                    type: 'positive',
                    icon: '',
                    title: 'Strong Consistency',
                    text: `You've been active for ${streakDays} days! Consistent practice is key to success.`
                });
            }

            if (totalQuestions >= 100) {
                insights.push({
                    type: 'positive',
                    icon: '',
                    title: 'Dedicated Learner',
                    text: `You've answered ${totalQuestions} questions! Your dedication is paying off.`
                });
            }

            // Suggestions
            if (accuracy < 70 && totalQuestions > 10) {
                insights.push({
                    type: 'suggestion',
                    icon: '',
                    title: 'Focus on Understanding',
                    text: 'Try reviewing the explanations after each question. Understanding why an answer is correct helps retention.'
                });
            }

            if (streakDays < 3) {
                insights.push({
                    type: 'suggestion',
                    icon: '',
                    title: 'Build a Routine',
                    text: 'Try practicing a little bit every day. Even 10 minutes daily is more effective than long, infrequent sessions.'
                });
            }

            // Subject-specific insights
            let weakestSubject = null;
            let lowestAccuracy = 100;
            window.SUBJECTS?.forEach(subject => {
                const data = window.subjectMastery?.[subject.id];
                if (data && data.total >= 5) {
                    const subjectAcc = Math.round((data.correct / data.total) * 100);
                    if (subjectAcc < lowestAccuracy) {
                        lowestAccuracy = subjectAcc;
                        weakestSubject = subject;
                    }
                }
            });

            if (weakestSubject && lowestAccuracy < 60) {
                insights.push({
                    type: 'suggestion',
                    icon: weakestSubject.icon,
                    title: `Focus on ${weakestSubject.name}`,
                    text: `Your ${weakestSubject.name} accuracy is ${lowestAccuracy}%. Try some extra practice in this area.`
                });
            }

            // Warnings
            const lastActivity = localStorage.getItem('science_daily_goal_date');
            if (lastActivity && new Date(lastActivity) < new Date(Date.now() - 3 * 24 * 60 * 60 * 1000)) {
                insights.push({
                    type: 'warning',
                    icon: '',
                    title: 'Time to Return!',
                    text: 'It\'s been a few days since your last session. Jump back in to maintain your progress!'
                });
            }

            // Add default if no insights
            if (insights.length === 0) {
                insights.push({
                    type: 'positive',
                    icon: '',
                    title: 'Getting Started',
                    text: 'Keep answering questions and we\'ll provide personalized insights based on your performance!'
                });
            }

            return insights;
        };

        window.showPerformanceInsights = function() {
            // Remove existing
            document.querySelectorAll('.insights-modal, .insights-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'insights-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'insights-modal';

            const insights = generateInsights();

            let insightsHTML = `
                <h2 style="margin: 0 0 10px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span></span> Performance Insights
                </h2>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Personalized feedback based on your learning patterns</p>
            `;

            insights.forEach(insight => {
                insightsHTML += `
                    <div class="insight-card ${insight.type}">
                        <div class="insight-icon">${insight.icon}</div>
                        <div class="insight-content">
                            <div class="insight-title">${insight.title}</div>
                            <div class="insight-text">${insight.text}</div>
                        </div>
                    </div>
                `;
            });

            insightsHTML += `
                <button onclick="document.querySelectorAll('.insights-modal, .insights-backdrop').forEach(el => el.remove());"
                        style="width: 100%; margin-top: 15px; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; cursor: pointer;">
                    Got it! 
                </button>
            `;

            modal.innerHTML = insightsHTML;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        // =====================================================
        // STUDY RECOMMENDATIONS
        // =====================================================
        window.generateRecommendations = function() {
            const recommendations = [];

            // Check subject mastery for weak areas
            window.SUBJECTS?.forEach(subject => {
                const data = window.subjectMastery?.[subject.id];
                if (data && data.total >= 5) {
                    const acc = Math.round((data.correct / data.total) * 100);
                    if (acc < 50) {
                        recommendations.push({
                            icon: subject.icon,
                            title: `Practice ${subject.name}`,
                            reason: `Your accuracy is ${acc}%. More practice needed.`,
                            priority: 'high',
                            action: () => { /* Navigate to subject */ }
                        });
                    } else if (acc < 70) {
                        recommendations.push({
                            icon: subject.icon,
                            title: `Review ${subject.name}`,
                            reason: `Your ${acc}% accuracy can improve.`,
                            priority: 'medium',
                            action: () => { /* Navigate to subject */ }
                        });
                    }
                }
            });

            // Check for incomplete challenges
            if (window.weeklyChallenges) {
                const incomplete = window.weeklyChallenges.challenges.filter(
                    c => !window.weeklyChallenges.claimed.includes(c.id)
                );
                if (incomplete.length > 0) {
                    const challenge = incomplete[0];
                    recommendations.push({
                        icon: '',
                        title: `Complete: ${challenge.title}`,
                        reason: `${challenge.current}/${challenge.target} - ${challenge.reward} XP reward`,
                        priority: 'medium',
                        action: () => { if (window.showWeeklyChallenges) showWeeklyChallenges(); }
                    });
                }
            }

            // Check daily goal
            if (window.dailyGoals && !window.dailyGoals.completed) {
                const remaining = window.dailyGoals.questions - window.dailyGoals.current;
                if (remaining > 0) {
                    recommendations.push({
                        icon: '',
                        title: `Complete Daily Goal`,
                        reason: `${remaining} more questions for 100 XP bonus!`,
                        priority: remaining <= 3 ? 'high' : 'medium',
                        action: () => { /* Start questions */ }
                    });
                }
            }

            // Suggest flashcards if not used recently
            const lastFlashcard = localStorage.getItem('science_flashcard_last');
            if (!lastFlashcard || Date.now() - parseInt(lastFlashcard) > 24 * 60 * 60 * 1000) {
                recommendations.push({
                    icon: '',
                    title: 'Review Flashcards',
                    reason: 'Quick review sessions boost retention!',
                    priority: 'low',
                    action: () => { if (window.startFlashcardMode) startFlashcardMode(); }
                });
            }

            // Suggest focus mode
            const lastFocus = localStorage.getItem('science_focus_last');
            if (!lastFocus || Date.now() - parseInt(lastFocus) > 24 * 60 * 60 * 1000) {
                recommendations.push({
                    icon: '',
                    title: 'Try Focus Mode',
                    reason: 'Distraction-free study with XP bonus',
                    priority: 'low',
                    action: () => { if (window.toggleFocusMode) toggleFocusMode(); }
                });
            }

            // Sort by priority
            const priorityOrder = { high: 0, medium: 1, low: 2 };
            recommendations.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

            return recommendations.slice(0, 5); // Return top 5
        };

        window.showRecommendations = function() {
            // Remove existing
            document.querySelectorAll('.recommendations-modal, .recommendations-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'recommendations-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'recommendations-modal';

            const recommendations = generateRecommendations();

            let recHTML = `
                <h2 style="margin: 0 0 10px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span></span> Study Recommendations
                </h2>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Personalized suggestions to maximize your learning</p>
            `;

            if (recommendations.length === 0) {
                recHTML += `
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                        <p>Great work! Keep practicing and we'll suggest areas to focus on.</p>
                    </div>
                `;
            } else {
                recommendations.forEach((rec, index) => {
                    recHTML += `
                        <div class="recommendation-card" onclick="handleRecommendation(${index})">
                            <div class="recommendation-icon">${rec.icon}</div>
                            <div class="recommendation-info">
                                <div class="recommendation-title">${rec.title}</div>
                                <div class="recommendation-reason">${rec.reason}</div>
                            </div>
                            <span class="recommendation-priority priority-${rec.priority}">${rec.priority}</span>
                        </div>
                    `;
                });
            }

            recHTML += `
                <button onclick="document.querySelectorAll('.recommendations-modal, .recommendations-backdrop').forEach(el => el.remove());"
                        style="width: 100%; margin-top: 15px; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; font-weight: 600; cursor: pointer;">
                    Start Learning! 
                </button>
            `;

            modal.innerHTML = recHTML;

            // Store recommendations for action handling
            window.currentRecommendations = recommendations;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.handleRecommendation = function(index) {
            const rec = window.currentRecommendations?.[index];
            if (rec && rec.action) {
                document.querySelectorAll('.recommendations-modal, .recommendations-backdrop').forEach(el => el.remove());
                rec.action();
            }
        };

        // =====================================================
        // ADD BUTTONS
        // =====================================================
        window.createBatch19Buttons = function() {
            // Session Summary button
            let btn1 = document.querySelector('.session-summary-btn');
            if (!btn1) {
                btn1 = document.createElement('button');
                btn1.className = 'session-summary-btn';
                btn1.style.cssText = `
                    position: fixed;
                    bottom: 710px;
                    left: 20px;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    border: none;
                    background: linear-gradient(135deg, #E91E63, #9C27B0);
                    color: white;
                    font-size: 1.5rem;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
                    z-index: 999;
                    transition: all 0.3s ease;
                `;
                btn1.innerHTML = '';
                btn1.title = 'Session Summary';
                btn1.onclick = showSessionSummary;
                btn1.onmouseenter = () => btn1.style.transform = 'scale(1.1)';
                btn1.onmouseleave = () => btn1.style.transform = 'scale(1)';
                document.body.appendChild(btn1);
            }

            // Insights button
            let btn2 = document.querySelector('.insights-btn');
            if (!btn2) {
                btn2 = document.createElement('button');
                btn2.className = 'insights-btn';
                btn2.style.cssText = `
                    position: fixed;
                    bottom: 770px;
                    left: 20px;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    border: none;
                    background: linear-gradient(135deg, #3F51B5, #2196F3);
                    color: white;
                    font-size: 1.5rem;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(63, 81, 181, 0.4);
                    z-index: 999;
                    transition: all 0.3s ease;
                `;
                btn2.innerHTML = '';
                btn2.title = 'Performance Insights';
                btn2.onclick = showPerformanceInsights;
                btn2.onmouseenter = () => btn2.style.transform = 'scale(1.1)';
                btn2.onmouseleave = () => btn2.style.transform = 'scale(1)';
                document.body.appendChild(btn2);
            }
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            createBatch19Buttons();
        });

        // Also init if DOM already loaded
        if (document.readyState !== 'loading') {
            createBatch19Buttons();
        }

        console.log(' Session Summary, Performance Insights, and Recommendations loaded!');
    </script>

    <!-- BATCH 20: Accessibility, Break Reminders, Question Review -->
    <script>
        // =====================================================
        // ACCESSIBILITY SETTINGS
        // =====================================================
        window.accessibilitySettings = JSON.parse(localStorage.getItem('science_accessibility') || JSON.stringify({
            fontSize: 100,
            contrast: 'normal',
            reducedMotion: false
        }));

        window.showAccessibilitySettings = function() {
            // Remove existing
            document.querySelectorAll('.accessibility-modal, .accessibility-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'accessibility-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'accessibility-modal';

            modal.innerHTML = `
                <h2 style="margin: 0 0 20px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span></span> Accessibility
                </h2>

                <div style="margin-bottom: 25px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">Font Size</div>
                    <div class="font-size-preview" id="font-preview" style="font-size: ${window.accessibilitySettings.fontSize}%;">
                        Preview Text - The quick brown fox
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 0.8rem;">A</span>
                        <input type="range" class="font-size-slider" min="80" max="150" value="${window.accessibilitySettings.fontSize}"
                               oninput="updateFontSize(this.value)">
                        <span style="font-size: 1.2rem;">A</span>
                    </div>
                    <div style="text-align: center; font-size: 0.85rem; color: #666; margin-top: 5px;">${window.accessibilitySettings.fontSize}%</div>
                </div>

                <div style="margin-bottom: 25px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">Contrast</div>
                    <div class="contrast-option ${window.accessibilitySettings.contrast === 'normal' ? 'selected' : ''}" onclick="setContrast('normal')">
                        <div class="contrast-preview" style="background: #f8f9fa; color: #333;">Aa</div>
                        <div>
                            <div style="font-weight: 500;">Normal</div>
                            <div style="font-size: 0.8rem; color: #666;">Default appearance</div>
                        </div>
                    </div>
                    <div class="contrast-option ${window.accessibilitySettings.contrast === 'high' ? 'selected' : ''}" onclick="setContrast('high')">
                        <div class="contrast-preview" style="background: #000; color: #fff;">Aa</div>
                        <div>
                            <div style="font-weight: 500;">High Contrast</div>
                            <div style="font-size: 0.8rem; color: #666;">Black background, white text</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div class="setting-item" style="border-bottom: none; padding: 0;">
                        <div class="setting-info">
                            <div class="setting-label">Reduce Motion</div>
                            <div class="setting-desc">Minimize animations</div>
                        </div>
                        <div class="toggle-switch ${window.accessibilitySettings.reducedMotion ? 'on' : ''}" onclick="toggleReducedMotion(this)"></div>
                    </div>
                </div>

                <button onclick="saveAccessibility(); document.querySelectorAll('.accessibility-modal, .accessibility-backdrop').forEach(el => el.remove());"
                        style="width: 100%; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; font-weight: 600; cursor: pointer;">
                    Save Settings
                </button>
            `;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.updateFontSize = function(size) {
            window.accessibilitySettings.fontSize = parseInt(size);
            const preview = document.getElementById('font-preview');
            if (preview) {
                preview.style.fontSize = size + '%';
                preview.nextElementSibling.nextElementSibling.textContent = size + '%';
            }
        };

        window.setContrast = function(mode) {
            window.accessibilitySettings.contrast = mode;
            showAccessibilitySettings(); // Refresh to show selection
        };

        window.toggleReducedMotion = function(element) {
            window.accessibilitySettings.reducedMotion = !window.accessibilitySettings.reducedMotion;
            element.classList.toggle('on');
        };

        window.saveAccessibility = function() {
            localStorage.setItem('science_accessibility', JSON.stringify(window.accessibilitySettings));
            applyAccessibility();
        };

        window.applyAccessibility = function() {
            // Apply font size
            document.documentElement.style.fontSize = window.accessibilitySettings.fontSize + '%';

            // Apply contrast
            if (window.accessibilitySettings.contrast === 'high') {
                document.body.classList.add('high-contrast');
            } else {
                document.body.classList.remove('high-contrast');
            }

            // Apply reduced motion
            if (window.accessibilitySettings.reducedMotion) {
                document.documentElement.style.setProperty('--animation-duration', '0s');
            } else {
                document.documentElement.style.removeProperty('--animation-duration');
            }
        };

        // =====================================================
        // STUDY BREAK REMINDERS
        // =====================================================
        window.breakState = {
            studyStartTime: Date.now(),
            breakInterval: 30, // minutes
            breakDuration: 5, // minutes
            breakTimer: null,
            isOnBreak: false
        };

        window.initBreakReminder = function() {
            // Check every minute
            setInterval(checkForBreak, 60000);
        };

        window.checkForBreak = function() {
            if (window.breakState.isOnBreak) return;

            const studyMinutes = (Date.now() - window.breakState.studyStartTime) / 60000;

            if (studyMinutes >= window.breakState.breakInterval) {
                showBreakReminder();
            }
        };

        window.showBreakReminder = function() {
            // Remove existing
            document.querySelectorAll('.break-reminder').forEach(el => el.remove());

            window.breakState.isOnBreak = true;
            let breakSeconds = window.breakState.breakDuration * 60;

            const reminder = document.createElement('div');
            reminder.className = 'break-reminder';
            reminder.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 20px;"></div>
                <h2 style="margin: 0; font-size: 2rem;">Time for a Break!</h2>
                <p style="opacity: 0.9; max-width: 400px;">You've been studying for ${window.breakState.breakInterval} minutes. Take a short break to refresh your mind.</p>

                <div class="break-timer" id="break-timer">${formatBreakTime(breakSeconds)}</div>

                <div class="break-activity">
                    <div class="break-activity-item">
                        <div style="font-size: 2rem;"></div>
                        <div>Stretch</div>
                    </div>
                    <div class="break-activity-item">
                        <div style="font-size: 2rem;"></div>
                        <div>Drink Water</div>
                    </div>
                    <div class="break-activity-item">
                        <div style="font-size: 2rem;"></div>
                        <div>Rest Eyes</div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button onclick="skipBreak()" style="padding: 12px 30px; border-radius: 25px; border: 2px solid rgba(255,255,255,0.5); background: transparent; color: white; font-weight: 600; cursor: pointer;">
                        Skip Break
                    </button>
                    <button onclick="extendBreak()" style="padding: 12px 30px; border-radius: 25px; border: none; background: rgba(255,255,255,0.2); color: white; font-weight: 600; cursor: pointer;">
                        +2 Minutes
                    </button>
                </div>
            `;

            document.body.appendChild(reminder);

            // Start break countdown
            window.breakState.breakTimer = setInterval(() => {
                breakSeconds--;
                const timerEl = document.getElementById('break-timer');
                if (timerEl) {
                    timerEl.textContent = formatBreakTime(breakSeconds);
                }

                if (breakSeconds <= 0) {
                    endBreak();
                }
            }, 1000);
        };

        window.formatBreakTime = function(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        };

        window.skipBreak = function() {
            endBreak();
        };

        window.extendBreak = function() {
            window.breakState.breakDuration += 2;
        };

        window.endBreak = function() {
            if (window.breakState.breakTimer) {
                clearInterval(window.breakState.breakTimer);
            }
            window.breakState.isOnBreak = false;
            window.breakState.studyStartTime = Date.now();
            document.querySelectorAll('.break-reminder').forEach(el => el.remove());

            // Log achievement
            if (window.logAchievement) {
                logAchievement('goal', 'Took a Break', 'Healthy study habits!');
            }
        };

        // =====================================================
        // QUESTION REVIEW MODE
        // =====================================================
        window.questionHistory = JSON.parse(localStorage.getItem('science_question_history') || '[]');

        window.addToQuestionHistory = function(question, userAnswer, correctAnswer, isCorrect) {
            const entry = {
                id: Date.now(),
                question: question,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                timestamp: new Date().toISOString()
            };

            window.questionHistory.unshift(entry);

            // Keep only last 100 questions
            if (window.questionHistory.length > 100) {
                window.questionHistory = window.questionHistory.slice(0, 100);
            }

            localStorage.setItem('science_question_history', JSON.stringify(window.questionHistory));
        };

        window.showQuestionReview = function(filter = 'all') {
            // Remove existing
            document.querySelectorAll('.review-modal, .review-backdrop').forEach(el => el.remove());

            const backdrop = document.createElement('div');
            backdrop.className = 'review-backdrop';
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;';

            const modal = document.createElement('div');
            modal.className = 'review-modal';

            // Filter questions
            let filteredQuestions = window.questionHistory;
            if (filter === 'incorrect') {
                filteredQuestions = window.questionHistory.filter(q => !q.isCorrect);
            } else if (filter === 'correct') {
                filteredQuestions = window.questionHistory.filter(q => q.isCorrect);
            }

            const correctCount = window.questionHistory.filter(q => q.isCorrect).length;
            const incorrectCount = window.questionHistory.filter(q => !q.isCorrect).length;

            let reviewHTML = `
                <h2 style="margin: 0 0 15px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span></span> Question Review
                </h2>

                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="showQuestionReview('all')" style="padding: 8px 20px; border-radius: 20px; border: none; background: ${filter === 'all' ? '#4CAF50' : '#e0e0e0'}; color: ${filter === 'all' ? 'white' : '#666'}; font-weight: 600; cursor: pointer;">
                        All (${window.questionHistory.length})
                    </button>
                    <button onclick="showQuestionReview('incorrect')" style="padding: 8px 20px; border-radius: 20px; border: none; background: ${filter === 'incorrect' ? '#F44336' : '#e0e0e0'}; color: ${filter === 'incorrect' ? 'white' : '#666'}; font-weight: 600; cursor: pointer;">
                         Incorrect (${incorrectCount})
                    </button>
                    <button onclick="showQuestionReview('correct')" style="padding: 8px 20px; border-radius: 20px; border: none; background: ${filter === 'correct' ? '#4CAF50' : '#e0e0e0'}; color: ${filter === 'correct' ? 'white' : '#666'}; font-weight: 600; cursor: pointer;">
                         Correct (${correctCount})
                    </button>
                </div>
            `;

            if (filteredQuestions.length === 0) {
                reviewHTML += `
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                        <p>No questions to review yet. Start answering questions!</p>
                    </div>
                `;
            } else {
                filteredQuestions.slice(0, 20).forEach((q, index) => {
                    const questionText = q.question?.substring(0, 100) + (q.question?.length > 100 ? '...' : '') || 'Question ' + (index + 1);
                    reviewHTML += `
                        <div class="review-question ${q.isCorrect ? 'correct' : 'incorrect'}" onclick="showQuestionDetail(${index})">
                            <div class="review-header">
                                <span style="font-weight: 600;">#${index + 1}</span>
                                <span class="review-status" style="background: ${q.isCorrect ? '#E8F5E9' : '#FFEBEE'}; color: ${q.isCorrect ? '#388E3C' : '#D32F2F'};">
                                    ${q.isCorrect ? ' Correct' : ' Incorrect'}
                                </span>
                            </div>
                            <div class="review-text">${questionText}</div>
                        </div>
                    `;
                });
            }

            reviewHTML += `
                <button onclick="document.querySelectorAll('.review-modal, .review-backdrop').forEach(el => el.remove());"
                        style="width: 100%; margin-top: 15px; padding: 12px; border-radius: 25px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; cursor: pointer;">
                    Close Review
                </button>
            `;

            modal.innerHTML = reviewHTML;

            backdrop.onclick = () => { backdrop.remove(); modal.remove(); };
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        };

        window.showQuestionDetail = function(index) {
            const q = window.questionHistory[index];
            if (!q) return;

            alert(`Question: ${q.question}\n\nYour Answer: ${q.userAnswer}\n\nCorrect Answer: ${q.correctAnswer}`);
        };

        // =====================================================
        // ADD BUTTONS
        // =====================================================
        window.createBatch20Buttons = function() {
            // Accessibility button
            let btn1 = document.querySelector('.accessibility-btn');
            if (!btn1) {
                btn1 = document.createElement('button');
                btn1.className = 'accessibility-btn';
                btn1.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    border: none;
                    background: linear-gradient(135deg, #607D8B, #455A64);
                    color: white;
                    font-size: 1.5rem;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(96, 125, 139, 0.4);
                    z-index: 999;
                    transition: all 0.3s ease;
                `;
                btn1.innerHTML = '';
                btn1.title = 'Accessibility Settings';
                btn1.onclick = showAccessibilitySettings;
                btn1.onmouseenter = () => btn1.style.transform = 'scale(1.1)';
                btn1.onmouseleave = () => btn1.style.transform = 'scale(1)';
                document.body.appendChild(btn1);
            }

            // Review button
            let btn2 = document.querySelector('.review-btn');
            if (!btn2) {
                btn2 = document.createElement('button');
                btn2.className = 'review-btn';
                btn2.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    right: 20px;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    border: none;
                    background: linear-gradient(135deg, #FF5722, #E64A19);
                    color: white;
                    font-size: 1.5rem;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(255, 87, 34, 0.4);
                    z-index: 999;
                    transition: all 0.3s ease;
                `;
                btn2.innerHTML = '';
                btn2.title = 'Review Questions';
                btn2.onclick = () => showQuestionReview('all');
                btn2.onmouseenter = () => btn2.style.transform = 'scale(1.1)';
                btn2.onmouseleave = () => btn2.style.transform = 'scale(1)';
                document.body.appendChild(btn2);
            }
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            applyAccessibility();
            createBatch20Buttons();
            initBreakReminder();
        });

        // Also init if DOM already loaded
        if (document.readyState !== 'loading') {
            applyAccessibility();
            createBatch20Buttons();
            initBreakReminder();
        }

        console.log(' Accessibility, Break Reminders, and Question Review loaded!');
    </script>

    <!-- ========== BATCH 21: Social Sharing, Leaderboard, Study Music ========== -->

    <!-- Social Share Modal -->
    <div class="social-share-modal" id="social-share-modal">
        <div class="social-share-content">
            <h2>Share Your Achievement!</h2>
            <div class="share-achievement-card" id="share-card">
                <div class="share-badge" id="share-badge"></div>
                <div class="share-title" id="share-title">Level 5 Achieved!</div>
                <div class="share-subtitle" id="share-subtitle">Earned 500 XP on Polymath Science</div>
            </div>
            <div class="share-buttons">
                <button class="share-btn twitter" onclick="shareToTwitter()">
                    <span></span> Twitter
                </button>
                <button class="share-btn facebook" onclick="shareToFacebook()">
                    <span></span> Facebook
                </button>
                <button class="share-btn whatsapp" onclick="shareToWhatsApp()">
                    <span></span> WhatsApp
                </button>
                <button class="share-btn copy-link" onclick="copyShareText()">
                    <span></span> Copy
                </button>
            </div>
            <button onclick="closeSocialShare()" style="margin-top: 20px; padding: 10px 30px; border: none; background: #f0f0f0; border-radius: 20px; cursor: pointer;">Close</button>
        </div>
    </div>

    <!-- Leaderboard Panel -->
    <div class="leaderboard-panel" id="leaderboard-panel">
        <div class="leaderboard-header">
            <h2> Leaderboard</h2>
            <button class="leaderboard-close" onclick="closeLeaderboard()"></button>
        </div>
        <div class="leaderboard-tabs">
            <button class="leaderboard-tab active" onclick="switchLeaderboardTab('daily')">Today</button>
            <button class="leaderboard-tab" onclick="switchLeaderboardTab('weekly')">This Week</button>
            <button class="leaderboard-tab" onclick="switchLeaderboardTab('alltime')">All Time</button>
        </div>
        <div class="leaderboard-list" id="leaderboard-list">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <!-- Study Music Player -->
    <div class="music-player" id="music-player">
        <div class="music-header">
            <h3> Study Music</h3>
            <button class="music-close" onclick="closeMusicPlayer()"></button>
        </div>
        <div class="music-body">
            <div class="now-playing">
                <div class="now-playing-icon" id="music-icon"></div>
                <div class="now-playing-title" id="now-playing-title">Select a track</div>
            </div>
            <div class="music-controls">
                <button class="music-control-btn" onclick="previousTrack()"></button>
                <button class="music-control-btn play-pause" id="play-pause-btn" onclick="togglePlayPause()"></button>
                <button class="music-control-btn" onclick="nextTrack()"></button>
            </div>
            <div class="volume-control">
                <span></span>
                <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="50" onchange="updateVolume(this.value)">
                <span></span>
            </div>
            <div class="playlist-section">
                <h4>Ambient Sounds</h4>
                <div id="playlist-container">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons for Batch 21 -->
    <button class="floating-share-btn" onclick="openSocialShare()" title="Share Achievement"></button>
    <button class="floating-leaderboard-btn" onclick="toggleLeaderboard()" title="Leaderboard"></button>
    <button class="floating-music-btn" onclick="toggleMusicPlayer()" title="Study Music"></button>

    <script>
        // ========== BATCH 21: Social Sharing, Leaderboard, Study Music ==========

        // Social Sharing Functions
        let currentShareData = {
            badge: '',
            title: 'Level Up!',
            subtitle: 'Learning Science with Polymath'
        };

        function openSocialShare(badge = null, title = null, subtitle = null) {
            if (badge) currentShareData.badge = badge;
            if (title) currentShareData.title = title;
            if (subtitle) currentShareData.subtitle = subtitle;

            // Update from current XP
            const totalXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            const level = Math.floor(totalXP / 100) + 1;

            currentShareData.badge = level >= 10 ? '' : level >= 5 ? '' : '';
            currentShareData.title = `Level ${level} Achieved!`;
            currentShareData.subtitle = `Earned ${totalXP} XP on Polymath Science`;

            document.getElementById('share-badge').textContent = currentShareData.badge;
            document.getElementById('share-title').textContent = currentShareData.title;
            document.getElementById('share-subtitle').textContent = currentShareData.subtitle;

            document.getElementById('social-share-modal').style.display = 'flex';
        }

        function closeSocialShare() {
            document.getElementById('social-share-modal').style.display = 'none';
        }

        function getShareText() {
            return `${currentShareData.badge} ${currentShareData.title}\n${currentShareData.subtitle}\n\nJoin me on Polymath Science! `;
        }

        function shareToTwitter() {
            const text = encodeURIComponent(getShareText());
            window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
        }

        function shareToFacebook() {
            const text = encodeURIComponent(getShareText());
            window.open(`https://www.facebook.com/sharer/sharer.php?quote=${text}`, '_blank');
        }

        function shareToWhatsApp() {
            const text = encodeURIComponent(getShareText());
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        function copyShareText() {
            navigator.clipboard.writeText(getShareText()).then(() => {
                const btn = document.querySelector('.share-btn.copy-link');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span></span> Copied!';
                setTimeout(() => btn.innerHTML = originalText, 2000);
            });
        }

        // Leaderboard Functions
        const virtualCompetitors = [
            { name: 'Science Star', avatar: '', xpMultiplier: 1.5 },
            { name: 'Quiz Master', avatar: '', xpMultiplier: 1.3 },
            { name: 'Curious Cat', avatar: '', xpMultiplier: 1.1 },
            { name: 'Eager Beaver', avatar: '', xpMultiplier: 0.9 },
            { name: 'Wise Owl', avatar: '', xpMultiplier: 1.2 },
            { name: 'Speedy Dolphin', avatar: '', xpMultiplier: 0.8 },
            { name: 'Bright Bulb', avatar: '', xpMultiplier: 1.0 },
            { name: 'Cool Penguin', avatar: '', xpMultiplier: 0.7 },
            { name: 'Happy Bee', avatar: '', xpMultiplier: 0.95 }
        ];

        function generateLeaderboardData(period) {
            const userXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            let periodMultiplier = period === 'daily' ? 0.1 : period === 'weekly' ? 0.5 : 1;

            const entries = virtualCompetitors.map((comp, index) => ({
                name: comp.name,
                avatar: comp.avatar,
                xp: Math.floor(userXP * comp.xpMultiplier * periodMultiplier * (0.8 + Math.random() * 0.4)),
                isUser: false
            }));

            // Add current user
            entries.push({
                name: 'You',
                avatar: '',
                xp: Math.floor(userXP * periodMultiplier),
                isUser: true
            });

            // Sort by XP
            entries.sort((a, b) => b.xp - a.xp);

            return entries;
        }

        function renderLeaderboard(period = 'daily') {
            const entries = generateLeaderboardData(period);
            const container = document.getElementById('leaderboard-list');

            container.innerHTML = entries.map((entry, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                const userClass = entry.isUser ? 'current-user' : '';
                const badge = index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : '';

                return `
                    <div class="leaderboard-entry ${userClass}">
                        <div class="leaderboard-rank ${rankClass}">${index + 1}</div>
                        <div class="leaderboard-avatar">${entry.avatar}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${entry.name}</div>
                            <div class="leaderboard-xp">${entry.xp.toLocaleString()} XP</div>
                        </div>
                        <div class="leaderboard-badge">${badge}</div>
                    </div>
                `;
            }).join('');
        }

        function toggleLeaderboard() {
            const panel = document.getElementById('leaderboard-panel');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                renderLeaderboard('daily');
            }
        }

        function closeLeaderboard() {
            document.getElementById('leaderboard-panel').classList.remove('open');
        }

        function switchLeaderboardTab(period) {
            document.querySelectorAll('.leaderboard-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderLeaderboard(period);
        }

        // Study Music Player Functions
        const studyTracks = [
            { id: 'rain', name: 'Gentle Rain', icon: '', freq: 220 },
            { id: 'forest', name: 'Forest Ambience', icon: '', freq: 180 },
            { id: 'ocean', name: 'Ocean Waves', icon: '', freq: 150 },
            { id: 'fire', name: 'Crackling Fire', icon: '', freq: 200 },
            { id: 'cafe', name: 'Cafe Sounds', icon: '', freq: 250 },
            { id: 'white', name: 'White Noise', icon: '', freq: 440 },
            { id: 'wind', name: 'Soft Wind', icon: '', freq: 160 },
            { id: 'birds', name: 'Morning Birds', icon: '', freq: 300 }
        ];

        let audioContext = null;
        let currentOscillator = null;
        let gainNode = null;
        let isPlaying = false;
        let currentTrackIndex = 0;

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioContext.createGain();
                gainNode.connect(audioContext.destination);
                gainNode.gain.value = 0.3;
            }
        }

        function initMusicPlayer() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = studyTracks.map((track, index) => `
                <div class="playlist-item" data-index="${index}" onclick="selectTrack(${index})">
                    <span class="playlist-item-icon">${track.icon}</span>
                    <span class="playlist-item-name">${track.name}</span>
                </div>
            `).join('');
        }

        function selectTrack(index) {
            currentTrackIndex = index;
            const track = studyTracks[index];

            document.querySelectorAll('.playlist-item').forEach(item => item.classList.remove('playing'));
            document.querySelector(`.playlist-item[data-index="${index}"]`).classList.add('playing');

            document.getElementById('now-playing-title').textContent = track.name;
            document.getElementById('music-icon').textContent = track.icon;

            if (isPlaying) {
                playTrack(track);
            }
        }

        function playTrack(track) {
            initAudioContext();
            stopCurrentTrack();

            // Create ambient sound using oscillator
            currentOscillator = audioContext.createOscillator();
            const noise = audioContext.createOscillator();

            currentOscillator.type = 'sine';
            currentOscillator.frequency.value = track.freq;

            noise.type = 'triangle';
            noise.frequency.value = track.freq * 0.5;

            const oscGain = audioContext.createGain();
            oscGain.gain.value = 0.2;

            currentOscillator.connect(oscGain);
            noise.connect(oscGain);
            oscGain.connect(gainNode);

            currentOscillator.start();
            noise.start();

            // Add some modulation for more natural sound
            const lfo = audioContext.createOscillator();
            lfo.frequency.value = 0.2;
            const lfoGain = audioContext.createGain();
            lfoGain.gain.value = 10;
            lfo.connect(lfoGain);
            lfoGain.connect(currentOscillator.frequency);
            lfo.start();
        }

        function stopCurrentTrack() {
            if (currentOscillator) {
                try {
                    currentOscillator.stop();
                } catch(e) {}
                currentOscillator = null;
            }
        }

        function togglePlayPause() {
            initAudioContext();
            isPlaying = !isPlaying;

            const btn = document.getElementById('play-pause-btn');
            const icon = document.getElementById('music-icon');

            if (isPlaying) {
                btn.textContent = '';
                icon.style.animation = 'pulse 1s infinite';
                const track = studyTracks[currentTrackIndex];
                playTrack(track);
            } else {
                btn.textContent = '';
                icon.style.animation = 'pulse 2s infinite';
                stopCurrentTrack();
            }
        }

        function previousTrack() {
            currentTrackIndex = (currentTrackIndex - 1 + studyTracks.length) % studyTracks.length;
            selectTrack(currentTrackIndex);
        }

        function nextTrack() {
            currentTrackIndex = (currentTrackIndex + 1) % studyTracks.length;
            selectTrack(currentTrackIndex);
        }

        function updateVolume(value) {
            if (gainNode) {
                gainNode.gain.value = value / 100;
            }
        }

        function toggleMusicPlayer() {
            const player = document.getElementById('music-player');
            player.classList.toggle('open');
            if (player.classList.contains('open')) {
                initMusicPlayer();
            }
        }

        function closeMusicPlayer() {
            document.getElementById('music-player').classList.remove('open');
            stopCurrentTrack();
            isPlaying = false;
            document.getElementById('play-pause-btn').textContent = '';
        }

        // Initialize Batch 21
        document.addEventListener('DOMContentLoaded', function() {
            initMusicPlayer();
        });

        // Close modals on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSocialShare();
                closeLeaderboard();
                closeMusicPlayer();
            }
        });

        // Trigger share on level up (hook into existing XP system)
        const originalAddXP = window.addXP;
        if (typeof originalAddXP === 'function') {
            window.addXP = function(amount, source) {
                const oldXP = parseInt(localStorage.getItem('scienceXP')) || 0;
                const oldLevel = Math.floor(oldXP / 100) + 1;

                originalAddXP(amount, source);

                const newXP = parseInt(localStorage.getItem('scienceXP')) || 0;
                const newLevel = Math.floor(newXP / 100) + 1;

                // Auto-prompt to share on level up
                if (newLevel > oldLevel && newLevel % 5 === 0) {
                    setTimeout(() => openSocialShare(), 2000);
                }
            };
        }

        console.log(' Social Sharing, Leaderboard, and Study Music loaded!');
    </script>

    <!-- ========== BATCH 22: Study Notes, Bookmarks, Progress Export ========== -->

    <!-- Study Notes Panel -->
    <div class="notes-panel" id="notes-panel">
        <div class="notes-header">
            <h2> Study Notes</h2>
            <button class="notes-close" onclick="closeNotesPanel()"></button>
        </div>
        <div class="notes-toolbar">
            <button class="notes-toolbar-btn" onclick="createNewNote()" title="New Note"> New</button>
            <button class="notes-toolbar-btn" onclick="exportAllNotes()" title="Export Notes"> Export</button>
            <button class="notes-toolbar-btn" onclick="searchNotes()" title="Search"> Search</button>
        </div>
        <div class="notes-list" id="notes-list">
            <!-- Populated by JavaScript -->
        </div>
        <div class="note-editor" id="note-editor" style="display: none;">
            <input type="text" id="note-title-input" placeholder="Note title...">
            <textarea id="note-content-input" placeholder="Write your notes here..."></textarea>
            <div class="note-editor-actions">
                <button class="note-save-btn" onclick="saveNote()"> Save Note</button>
                <button class="note-delete-btn" onclick="deleteCurrentNote()"></button>
            </div>
        </div>
    </div>

    <!-- Bookmarks Modal -->
    <div class="bookmarks-modal" id="bookmarks-modal">
        <div class="bookmarks-content">
            <div class="bookmarks-header">
                <h2> My Bookmarks</h2>
                <button class="notes-close" onclick="closeBookmarks()"></button>
            </div>
            <div class="bookmarks-list" id="bookmarks-list">
                <!-- Populated by JavaScript -->
            </div>
            <div style="padding: 20px; text-align: center;">
                <button onclick="closeBookmarks()" style="padding: 10px 30px; border: none; background: #f0f0f0; border-radius: 20px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Progress Export Modal -->
    <div class="export-modal" id="export-modal">
        <div class="export-content">
            <h2> Export Progress Report</h2>
            <p style="color: #666;">Share your learning progress with parents or teachers</p>
            <div class="export-preview" id="export-preview">
                <!-- Populated by JavaScript -->
            </div>
            <div class="export-buttons">
                <button class="export-btn pdf" onclick="exportToPDF()">
                    <span></span> Download PDF
                </button>
                <button class="export-btn email" onclick="emailProgress()">
                    <span></span> Email
                </button>
                <button class="export-btn print" onclick="printProgress()">
                    <span></span> Print
                </button>
            </div>
            <button onclick="closeExportModal()" style="margin-top: 20px; padding: 10px 30px; border: none; background: #f0f0f0; border-radius: 20px; cursor: pointer;">Close</button>
        </div>
    </div>

    <!-- Floating Action Buttons for Batch 22 -->
    <button class="floating-notes-btn" onclick="toggleNotesPanel()" title="Study Notes"></button>
    <button class="floating-bookmarks-btn" onclick="openBookmarks()" title="Bookmarks"></button>
    <button class="floating-export-btn" onclick="openExportModal()" title="Export Progress"></button>

    <script>
        // ========== BATCH 22: Study Notes, Bookmarks, Progress Export ==========

        // Study Notes Functions
        let studyNotes = JSON.parse(localStorage.getItem('studyNotes')) || [];
        let currentNoteId = null;

        function toggleNotesPanel() {
            const panel = document.getElementById('notes-panel');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                renderNotesList();
            }
        }

        function closeNotesPanel() {
            document.getElementById('notes-panel').classList.remove('open');
            document.getElementById('note-editor').style.display = 'none';
        }

        function renderNotesList() {
            const container = document.getElementById('notes-list');

            if (studyNotes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                        <p>No notes yet!</p>
                        <p style="font-size: 0.85rem;">Click "New" to create your first study note.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = studyNotes.map(note => `
                <div class="note-card ${currentNoteId === note.id ? 'selected' : ''}" onclick="selectNote('${note.id}')">
                    <div class="note-title">${note.title || 'Untitled Note'}</div>
                    <div class="note-preview">${note.content.substring(0, 50)}${note.content.length > 50 ? '...' : ''}</div>
                    <div class="note-date">${formatNoteDate(note.updatedAt)}</div>
                </div>
            `).join('');
        }

        function formatNoteDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function createNewNote() {
            currentNoteId = 'note_' + Date.now();
            document.getElementById('note-title-input').value = '';
            document.getElementById('note-content-input').value = '';
            document.getElementById('note-editor').style.display = 'block';
            document.getElementById('note-title-input').focus();
        }

        function selectNote(id) {
            const note = studyNotes.find(n => n.id === id);
            if (note) {
                currentNoteId = id;
                document.getElementById('note-title-input').value = note.title;
                document.getElementById('note-content-input').value = note.content;
                document.getElementById('note-editor').style.display = 'block';
                renderNotesList();
            }
        }

        function saveNote() {
            const title = document.getElementById('note-title-input').value.trim();
            const content = document.getElementById('note-content-input').value.trim();

            if (!content) {
                alert('Please enter some content for your note.');
                return;
            }

            const existingIndex = studyNotes.findIndex(n => n.id === currentNoteId);
            const noteData = {
                id: currentNoteId,
                title: title || 'Untitled Note',
                content: content,
                updatedAt: Date.now()
            };

            if (existingIndex >= 0) {
                studyNotes[existingIndex] = noteData;
            } else {
                noteData.createdAt = Date.now();
                studyNotes.unshift(noteData);
            }

            localStorage.setItem('studyNotes', JSON.stringify(studyNotes));
            renderNotesList();

            // Show save confirmation
            const btn = document.querySelector('.note-save-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = ' Saved!';
            setTimeout(() => btn.innerHTML = originalText, 1500);
        }

        function deleteCurrentNote() {
            if (!currentNoteId) return;

            if (confirm('Are you sure you want to delete this note?')) {
                studyNotes = studyNotes.filter(n => n.id !== currentNoteId);
                localStorage.setItem('studyNotes', JSON.stringify(studyNotes));
                currentNoteId = null;
                document.getElementById('note-editor').style.display = 'none';
                renderNotesList();
            }
        }

        function exportAllNotes() {
            if (studyNotes.length === 0) {
                alert('No notes to export!');
                return;
            }

            let exportText = '=== My Science Study Notes ===\n\n';
            studyNotes.forEach(note => {
                exportText += ` ${note.title}\n`;
                exportText += `Date: ${formatNoteDate(note.updatedAt)}\n`;
                exportText += `${note.content}\n\n`;
                exportText += '---\n\n';
            });

            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'study-notes.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function searchNotes() {
            const query = prompt('Search notes:');
            if (!query) return;

            const results = studyNotes.filter(note =>
                note.title.toLowerCase().includes(query.toLowerCase()) ||
                note.content.toLowerCase().includes(query.toLowerCase())
            );

            if (results.length === 0) {
                alert('No notes found matching "' + query + '"');
            } else {
                studyNotes = [...results, ...studyNotes.filter(n => !results.includes(n))];
                renderNotesList();
            }
        }

        // Bookmarks Functions
        let bookmarks = JSON.parse(localStorage.getItem('scienceBookmarks')) || [];

        function openBookmarks() {
            renderBookmarksList();
            document.getElementById('bookmarks-modal').style.display = 'flex';
        }

        function closeBookmarks() {
            document.getElementById('bookmarks-modal').style.display = 'none';
        }

        function renderBookmarksList() {
            const container = document.getElementById('bookmarks-list');

            if (bookmarks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                        <p>No bookmarks yet!</p>
                        <p style="font-size: 0.85rem;">Bookmark questions and topics as you study.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = bookmarks.map((bookmark, index) => `
                <div class="bookmark-item">
                    <div class="bookmark-icon">${bookmark.icon || ''}</div>
                    <div class="bookmark-info">
                        <div class="bookmark-title">${bookmark.title}</div>
                        <div class="bookmark-topic">${bookmark.topic || 'General'}</div>
                    </div>
                    <div class="bookmark-actions">
                        <button class="bookmark-action-btn bookmark-goto" onclick="goToBookmark(${index})">Go</button>
                        <button class="bookmark-action-btn bookmark-remove" onclick="removeBookmark(${index})"></button>
                    </div>
                </div>
            `).join('');
        }

        function addBookmark(title, topic, icon = '', data = {}) {
            bookmarks.push({
                id: 'bm_' + Date.now(),
                title: title,
                topic: topic,
                icon: icon,
                data: data,
                createdAt: Date.now()
            });
            localStorage.setItem('scienceBookmarks', JSON.stringify(bookmarks));

            // Show confirmation toast
            showBookmarkToast('Bookmark added!');
        }

        function removeBookmark(index) {
            bookmarks.splice(index, 1);
            localStorage.setItem('scienceBookmarks', JSON.stringify(bookmarks));
            renderBookmarksList();
        }

        function goToBookmark(index) {
            const bookmark = bookmarks[index];
            closeBookmarks();
            // Implementation depends on app navigation
            console.log('Navigate to:', bookmark);
            alert('Navigating to: ' + bookmark.title);
        }

        function showBookmarkToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                z-index: 99999;
                animation: fadeInUp 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Progress Export Functions
        function openExportModal() {
            populateExportPreview();
            document.getElementById('export-modal').style.display = 'flex';
        }

        function closeExportModal() {
            document.getElementById('export-modal').style.display = 'none';
        }

        function populateExportPreview() {
            const totalXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            const level = Math.floor(totalXP / 100) + 1;
            const streak = parseInt(localStorage.getItem('currentStreak')) || 0;
            const questionsAnswered = parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0;
            const correctAnswers = parseInt(localStorage.getItem('correctAnswers')) || 0;
            const accuracy = questionsAnswered > 0 ? Math.round((correctAnswers / questionsAnswered) * 100) : 0;
            const studyTime = parseInt(localStorage.getItem('totalStudyTime')) || 0;

            const preview = document.getElementById('export-preview');
            preview.innerHTML = `
                <h3 style="margin: 0 0 15px 0; color: #333; text-align: center;"> Science Learning Progress</h3>
                <div class="export-stat">
                    <span class="export-stat-label">Current Level</span>
                    <span class="export-stat-value">Level ${level}</span>
                </div>
                <div class="export-stat">
                    <span class="export-stat-label">Total XP Earned</span>
                    <span class="export-stat-value">${totalXP.toLocaleString()} XP</span>
                </div>
                <div class="export-stat">
                    <span class="export-stat-label">Study Streak</span>
                    <span class="export-stat-value">${streak} days</span>
                </div>
                <div class="export-stat">
                    <span class="export-stat-label">Questions Answered</span>
                    <span class="export-stat-value">${questionsAnswered}</span>
                </div>
                <div class="export-stat">
                    <span class="export-stat-label">Accuracy Rate</span>
                    <span class="export-stat-value">${accuracy}%</span>
                </div>
                <div class="export-stat">
                    <span class="export-stat-label">Study Notes</span>
                    <span class="export-stat-value">${studyNotes.length} notes</span>
                </div>
            `;
        }

        function generateProgressReport() {
            const totalXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            const level = Math.floor(totalXP / 100) + 1;
            const streak = parseInt(localStorage.getItem('currentStreak')) || 0;
            const questionsAnswered = parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0;
            const correctAnswers = parseInt(localStorage.getItem('correctAnswers')) || 0;
            const accuracy = questionsAnswered > 0 ? Math.round((correctAnswers / questionsAnswered) * 100) : 0;

            const date = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            return `
=====================================
   POLYMATH SCIENCE PROGRESS REPORT
=====================================

Generated: ${date}

LEARNING STATISTICS
-------------------
Current Level: Level ${level}
Total XP Earned: ${totalXP.toLocaleString()} XP
Study Streak: ${streak} days
Questions Answered: ${questionsAnswered}
Correct Answers: ${correctAnswers}
Accuracy Rate: ${accuracy}%
Study Notes: ${studyNotes.length} notes

ACHIEVEMENTS
------------
${level >= 10 ? ' ' : ''}${level >= 5 ? ' ' : ''}${streak >= 7 ? ' ' : ''}${accuracy >= 80 ? ' ' : ''}

Keep up the great work!
Learning science is an amazing journey.

---
Polymath Learning Centre
Science Made Fun!
            `.trim();
        }

        function exportToPDF() {
            const report = generateProgressReport();

            // Create a printable version
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Science Progress Report</title>
                    <style>
                        body { font-family: monospace; padding: 40px; white-space: pre-wrap; }
                    </style>
                </head>
                <body>${report}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function emailProgress() {
            const report = generateProgressReport();
            const subject = encodeURIComponent('My Polymath Science Progress Report');
            const body = encodeURIComponent(report);
            window.open(`mailto:?subject=${subject}&body=${body}`);
        }

        function printProgress() {
            const report = generateProgressReport();
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Science Progress Report</title>
                    <style>
                        body { font-family: 'Courier New', monospace; padding: 40px; white-space: pre-wrap; font-size: 12px; }
                        @media print {
                            body { padding: 20px; }
                        }
                    </style>
                </head>
                <body>${report}</body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        // Add keyboard shortcut for notes
        document.addEventListener('keydown', function(e) {
            if (e.key === 'n' && (e.ctrlKey || e.metaKey) && e.shiftKey) {
                e.preventDefault();
                toggleNotesPanel();
            }
        });

        console.log(' Study Notes, Bookmarks, and Progress Export loaded!');
    </script>

    <!-- ========== BATCH 23: Quiz Timer, Power-ups, Daily Login ========== -->

    <!-- Quiz Timer -->
    <div class="quiz-timer" id="quiz-timer">
        <div class="timer-display" id="timer-display">2:00</div>
        <div class="timer-label">Time Remaining</div>
        <div class="timer-progress">
            <div class="timer-progress-bar" id="timer-progress-bar" style="width: 100%"></div>
        </div>
    </div>

    <!-- Power-ups Bar -->
    <div class="powerups-bar" id="powerups-bar">
        <div class="powerup-item" onclick="usePowerup('hint')">
            <div class="powerup-icon hint"></div>
            <span class="powerup-count" id="hint-count">3</span>
            <span class="powerup-name">Hint</span>
            <div class="powerup-tooltip">Reveal a hint for the question</div>
        </div>
        <div class="powerup-item" onclick="usePowerup('freeze')">
            <div class="powerup-icon freeze"></div>
            <span class="powerup-count" id="freeze-count">2</span>
            <span class="powerup-name">Freeze</span>
            <div class="powerup-tooltip">Freeze timer for 30 seconds</div>
        </div>
        <div class="powerup-item" onclick="usePowerup('double')">
            <div class="powerup-icon double"></div>
            <span class="powerup-count" id="double-count">1</span>
            <span class="powerup-name">2x XP</span>
            <div class="powerup-tooltip">Double XP for next correct answer</div>
        </div>
        <div class="powerup-item" onclick="usePowerup('skip')">
            <div class="powerup-icon skip"></div>
            <span class="powerup-count" id="skip-count">2</span>
            <span class="powerup-name">Skip</span>
            <div class="powerup-tooltip">Skip this question without penalty</div>
        </div>
        <div class="powerup-item" onclick="usePowerup('shield')">
            <div class="powerup-icon shield"></div>
            <span class="powerup-count" id="shield-count">1</span>
            <span class="powerup-name">Shield</span>
            <div class="powerup-tooltip">Protect streak from wrong answer</div>
        </div>
    </div>

    <!-- Daily Login Rewards Modal -->
    <div class="login-rewards-modal" id="login-rewards-modal">
        <div class="login-rewards-content">
            <div class="login-rewards-header">
                <h2> Daily Login Rewards</h2>
                <div class="login-streak-badge" id="login-streak-badge"> Day 1</div>
            </div>
            <div class="daily-rewards-grid" id="daily-rewards-grid">
                <!-- Populated by JavaScript -->
            </div>
            <button class="claim-reward-btn" id="claim-reward-btn" onclick="claimDailyReward()">
                Claim Today's Reward!
            </button>
            <button onclick="closeLoginRewards()" style="margin-top: 10px; padding: 10px 20px; border: none; background: transparent; color: #666; cursor: pointer;">Maybe Later</button>
        </div>
    </div>

    <!-- Floating Action Buttons for Batch 23 -->
    <button class="floating-timer-btn" onclick="toggleQuizTimer()" title="Quiz Timer"></button>
    <button class="floating-powerups-btn" onclick="togglePowerupsBar()" title="Power-ups"></button>

    <script>
        // ========== BATCH 23: Quiz Timer, Power-ups, Daily Login ==========

        // Quiz Timer Functions
        let timerInterval = null;
        let timeRemaining = 120; // 2 minutes default
        let maxTime = 120;
        let timerActive = false;
        let timerFrozen = false;

        function toggleQuizTimer() {
            const timer = document.getElementById('quiz-timer');
            if (timer.classList.contains('active')) {
                stopQuizTimer();
            } else {
                startQuizTimer();
            }
        }

        function startQuizTimer(duration = 120) {
            timeRemaining = duration;
            maxTime = duration;
            timerActive = true;
            timerFrozen = false;

            document.getElementById('quiz-timer').classList.add('active');
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                if (!timerFrozen && timeRemaining > 0) {
                    timeRemaining--;
                    updateTimerDisplay();
                } else if (timeRemaining <= 0) {
                    timerExpired();
                }
            }, 1000);
        }

        function stopQuizTimer() {
            timerActive = false;
            clearInterval(timerInterval);
            document.getElementById('quiz-timer').classList.remove('active');
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = document.getElementById('timer-display');
            const progressBar = document.getElementById('timer-progress-bar');

            display.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            const percentage = (timeRemaining / maxTime) * 100;
            progressBar.style.width = percentage + '%';

            // Update visual warnings
            display.classList.remove('warning', 'danger');
            progressBar.classList.remove('warning', 'danger');

            if (timeRemaining <= 10) {
                display.classList.add('danger');
                progressBar.classList.add('danger');
            } else if (timeRemaining <= 30) {
                display.classList.add('warning');
                progressBar.classList.add('warning');
            }
        }

        function timerExpired() {
            stopQuizTimer();
            alert(' Time\'s up! Try to be faster next time.');
        }

        function freezeTimer(duration = 30) {
            if (!timerActive) return;
            timerFrozen = true;
            document.getElementById('timer-display').style.color = '#00d2ff';
            setTimeout(() => {
                timerFrozen = false;
                document.getElementById('timer-display').style.color = '';
            }, duration * 1000);
        }

        // Power-ups Functions
        let powerups = JSON.parse(localStorage.getItem('sciencePowerups')) || {
            hint: 3,
            freeze: 2,
            double: 1,
            skip: 2,
            shield: 1
        };
        let doubleXPActive = false;
        let shieldActive = false;

        function togglePowerupsBar() {
            const bar = document.getElementById('powerups-bar');
            bar.classList.toggle('active');
            if (bar.classList.contains('active')) {
                updatePowerupsDisplay();
            }
        }

        function updatePowerupsDisplay() {
            Object.keys(powerups).forEach(type => {
                const countEl = document.getElementById(type + '-count');
                if (countEl) {
                    countEl.textContent = powerups[type];
                    const item = countEl.closest('.powerup-item');
                    if (powerups[type] <= 0) {
                        item.classList.add('disabled');
                    } else {
                        item.classList.remove('disabled');
                    }
                }
            });
        }

        function usePowerup(type) {
            if (powerups[type] <= 0) {
                showPowerupToast('No more ' + type + ' power-ups!', 'error');
                return;
            }

            powerups[type]--;
            localStorage.setItem('sciencePowerups', JSON.stringify(powerups));
            updatePowerupsDisplay();

            switch (type) {
                case 'hint':
                    showPowerupToast(' Hint revealed!', 'success');
                    // Would integrate with question system
                    break;
                case 'freeze':
                    freezeTimer(30);
                    showPowerupToast(' Timer frozen for 30 seconds!', 'success');
                    break;
                case 'double':
                    doubleXPActive = true;
                    showPowerupToast(' 2x XP active for next answer!', 'success');
                    setTimeout(() => {
                        if (doubleXPActive) {
                            doubleXPActive = false;
                            showPowerupToast('2x XP expired', 'warning');
                        }
                    }, 60000);
                    break;
                case 'skip':
                    showPowerupToast(' Question skipped!', 'success');
                    break;
                case 'shield':
                    shieldActive = true;
                    showPowerupToast(' Shield active! Your streak is protected.', 'success');
                    break;
            }
        }

        function showPowerupToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#333';
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: ${bgColor};
                color: white;
                padding: 15px 25px;
                border-radius: 30px;
                font-weight: 600;
                z-index: 99999;
                animation: slideDown 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        function addPowerups(type, amount) {
            powerups[type] = (powerups[type] || 0) + amount;
            localStorage.setItem('sciencePowerups', JSON.stringify(powerups));
            updatePowerupsDisplay();
        }

        // Daily Login Rewards
        const dailyRewards = [
            { day: 1, icon: '', xp: 50, powerup: null },
            { day: 2, icon: '', xp: 75, powerup: null },
            { day: 3, icon: '', xp: 100, powerup: { type: 'hint', amount: 1 } },
            { day: 4, icon: '', xp: 125, powerup: null },
            { day: 5, icon: '', xp: 150, powerup: { type: 'freeze', amount: 1 } },
            { day: 6, icon: '', xp: 200, powerup: { type: 'double', amount: 1 } },
            { day: 7, icon: '', xp: 500, powerup: { type: 'shield', amount: 1 } }
        ];

        function checkDailyLogin() {
            const lastLogin = localStorage.getItem('lastLoginDate');
            const today = new Date().toDateString();
            const loginStreak = parseInt(localStorage.getItem('loginStreak')) || 0;
            const claimedToday = localStorage.getItem('claimedToday') === today;

            if (lastLogin !== today && !claimedToday) {
                // Check if streak continues
                const lastDate = lastLogin ? new Date(lastLogin) : null;
                const todayDate = new Date(today);
                let newStreak = loginStreak;

                if (lastDate) {
                    const diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                    if (diffDays === 1) {
                        newStreak++;
                    } else if (diffDays > 1) {
                        newStreak = 1; // Reset streak
                    }
                } else {
                    newStreak = 1;
                }

                if (newStreak > 7) newStreak = ((newStreak - 1) % 7) + 1;

                localStorage.setItem('loginStreak', newStreak);
                localStorage.setItem('lastLoginDate', today);

                // Show rewards modal
                setTimeout(() => showLoginRewardsModal(newStreak), 1500);
            }
        }

        function showLoginRewardsModal(streak) {
            const modal = document.getElementById('login-rewards-modal');
            const grid = document.getElementById('daily-rewards-grid');
            const badge = document.getElementById('login-streak-badge');
            const claimBtn = document.getElementById('claim-reward-btn');

            badge.textContent = ` Day ${streak}`;

            grid.innerHTML = dailyRewards.map((reward, index) => {
                let statusClass = '';
                if (index + 1 < streak) {
                    statusClass = 'claimed';
                } else if (index + 1 === streak) {
                    statusClass = 'today';
                } else {
                    statusClass = 'locked';
                }

                return `
                    <div class="daily-reward-day ${statusClass}">
                        <div class="reward-day-num">Day ${reward.day}</div>
                        <div class="reward-day-icon">${reward.icon}</div>
                        <div class="reward-day-xp">+${reward.xp} XP</div>
                    </div>
                `;
            }).join('');

            const today = new Date().toDateString();
            const claimedToday = localStorage.getItem('claimedToday') === today;
            claimBtn.disabled = claimedToday;
            claimBtn.textContent = claimedToday ? 'Already Claimed!' : 'Claim Today\'s Reward!';

            modal.style.display = 'flex';
        }

        function claimDailyReward() {
            const today = new Date().toDateString();
            if (localStorage.getItem('claimedToday') === today) return;

            const streak = parseInt(localStorage.getItem('loginStreak')) || 1;
            const rewardIndex = ((streak - 1) % 7);
            const reward = dailyRewards[rewardIndex];

            // Add XP
            const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            localStorage.setItem('scienceXP', currentXP + reward.xp);

            // Add powerup if included
            if (reward.powerup) {
                addPowerups(reward.powerup.type, reward.powerup.amount);
            }

            localStorage.setItem('claimedToday', today);

            // Show celebration
            const modal = document.getElementById('login-rewards-modal');
            modal.innerHTML = `
                <div class="login-rewards-content" style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 20px;"></div>
                    <h2 style="color: #333;">Reward Claimed!</h2>
                    <p style="font-size: 1.5rem; color: #667eea; font-weight: 600;">+${reward.xp} XP</p>
                    ${reward.powerup ? `<p style="color: #666;">+1 ${reward.powerup.type} power-up</p>` : ''}
                    <button onclick="closeLoginRewards()" style="margin-top: 20px; padding: 15px 40px; border: none; border-radius: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; cursor: pointer;">Awesome!</button>
                </div>
            `;
        }

        function closeLoginRewards() {
            document.getElementById('login-rewards-modal').style.display = 'none';
        }

        function openLoginRewards() {
            const streak = parseInt(localStorage.getItem('loginStreak')) || 1;
            showLoginRewardsModal(streak);
        }

        // Initialize Batch 23
        document.addEventListener('DOMContentLoaded', function() {
            updatePowerupsDisplay();
            checkDailyLogin();
        });

        // Add CSS animation for slide down
        const slideDownStyle = document.createElement('style');
        slideDownStyle.textContent = `
            @keyframes slideDown {
                from { opacity: 0; transform: translate(-50%, -20px); }
                to { opacity: 1; transform: translate(-50%, 0); }
            }
        `;
        document.head.appendChild(slideDownStyle);

        console.log(' Quiz Timer, Power-ups, and Daily Login loaded!');
    </script>

    <!-- ========== BATCH 24: Learning Quests, Virtual Pet, Science Lab ========== -->

    <!-- Quests Modal -->
    <div class="quests-modal" id="quests-modal">
        <div class="quests-content">
            <div class="quests-header">
                <h2> Learning Quests</h2>
                <p style="margin: 5px 0 0 0; opacity: 0.9;">Complete quests to earn bonus rewards!</p>
            </div>
            <div class="quests-tabs">
                <button class="quest-tab active" onclick="switchQuestTab('daily')">Daily</button>
                <button class="quest-tab" onclick="switchQuestTab('weekly')">Weekly</button>
                <button class="quest-tab" onclick="switchQuestTab('special')">Special</button>
            </div>
            <div class="quests-list" id="quests-list">
                <!-- Populated by JavaScript -->
            </div>
            <div style="padding: 15px; text-align: center;">
                <button onclick="closeQuestsModal()" style="padding: 10px 30px; border: none; background: #f0f0f0; border-radius: 20px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Virtual Pet -->
    <div class="virtual-pet" id="virtual-pet">
        <div class="pet-message" id="pet-message">Hello! Let's learn together!</div>
        <div class="pet-container">
            <div class="pet-avatar" id="pet-avatar" onclick="petPet()"></div>
            <div class="pet-name" id="pet-name">Sciency</div>
            <div class="pet-mood" id="pet-mood">Feeling happy!</div>
            <div class="pet-stats">
                <div class="pet-stat">
                    <span class="pet-stat-icon"></span>
                    <div class="pet-stat-bar"><div class="pet-stat-fill" id="pet-happiness" style="width: 100%"></div></div>
                </div>
                <div class="pet-stat">
                    <span class="pet-stat-icon"></span>
                    <div class="pet-stat-bar"><div class="pet-stat-fill" id="pet-energy" style="width: 80%"></div></div>
                </div>
                <div class="pet-stat">
                    <span class="pet-stat-icon"></span>
                    <div class="pet-stat-bar"><div class="pet-stat-fill" id="pet-knowledge" style="width: 50%"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Science Lab Modal -->
    <div class="lab-modal" id="lab-modal">
        <div class="lab-content">
            <div class="lab-header">
                <h2> Science Lab</h2>
                <p style="color: #aaa; margin: 5px 0 0 0;">Conduct virtual experiments!</p>
            </div>
            <div class="lab-experiment" id="current-experiment">
                <div class="experiment-title" id="exp-title">States of Matter</div>
                <div class="experiment-desc" id="exp-desc">Watch what happens when we heat water!</div>
                <div class="experiment-animation" id="exp-animation">
                    <span class="beaker"></span>
                    <div class="bubbles">
                        <div class="bubble"></div>
                        <div class="bubble"></div>
                        <div class="bubble"></div>
                    </div>
                </div>
                <div class="experiment-controls">
                    <button class="experiment-btn start" onclick="startExperiment()">Start Experiment</button>
                    <button class="experiment-btn reset" onclick="resetExperiment()">Reset</button>
                </div>
                <div class="experiment-result" id="exp-result">
                    <h3 style="color: #00d4ff; margin: 0 0 10px 0;"> Experiment Complete!</h3>
                    <p id="exp-result-text"></p>
                    <p style="color: #4CAF50; font-weight: 600;">+25 XP Earned!</p>
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="loadExperiment(0)" class="experiment-btn" style="background: rgba(255,255,255,0.1);"> Water</button>
                <button onclick="loadExperiment(1)" class="experiment-btn" style="background: rgba(255,255,255,0.1);"> Magnets</button>
                <button onclick="loadExperiment(2)" class="experiment-btn" style="background: rgba(255,255,255,0.1);"> Plants</button>
                <button onclick="loadExperiment(3)" class="experiment-btn" style="background: rgba(255,255,255,0.1);"> Electricity</button>
            </div>
            <button onclick="closeLabModal()" style="margin-top: 20px; padding: 10px 30px; border: none; background: rgba(255,255,255,0.2); border-radius: 20px; color: white; cursor: pointer; display: block; margin-left: auto; margin-right: auto;">Close Lab</button>
        </div>
    </div>

    <!-- Floating Action Buttons for Batch 24 -->
    <button class="floating-quests-btn" onclick="openQuestsModal()" title="Learning Quests"></button>
    <button class="floating-pet-btn" onclick="toggleVirtualPet()" title="Virtual Pet"></button>
    <button class="floating-lab-btn" onclick="openLabModal()" title="Science Lab"></button>

    <script>
        // ========== BATCH 24: Learning Quests, Virtual Pet, Science Lab ==========

        // Learning Quests
        const questsData = {
            daily: [
                { id: 'd1', title: 'Early Bird', desc: 'Answer 5 questions before noon', target: 5, icon: '', reward: 100 },
                { id: 'd2', title: 'Perfect Score', desc: 'Get 3 questions correct in a row', target: 3, icon: '', reward: 75 },
                { id: 'd3', title: 'Explorer', desc: 'Try questions from 2 different topics', target: 2, icon: '', reward: 50 },
                { id: 'd4', title: 'Quick Learner', desc: 'Complete 10 questions today', target: 10, icon: '', reward: 150 }
            ],
            weekly: [
                { id: 'w1', title: 'Marathon Runner', desc: 'Answer 50 questions this week', target: 50, icon: '', reward: 500 },
                { id: 'w2', title: 'Science Master', desc: 'Achieve 80% accuracy on 30 questions', target: 30, icon: '', reward: 400 },
                { id: 'w3', title: 'Streak Champion', desc: 'Maintain a 5-day streak', target: 5, icon: '', reward: 300 },
                { id: 'w4', title: 'All-Rounder', desc: 'Answer questions from all topics', target: 6, icon: '', reward: 600 }
            ],
            special: [
                { id: 's1', title: 'First Steps', desc: 'Answer your first question!', target: 1, icon: '', reward: 50 },
                { id: 's2', title: 'Level 5 Hero', desc: 'Reach level 5', target: 500, icon: '', reward: 200 },
                { id: 's3', title: 'Note Taker', desc: 'Create 5 study notes', target: 5, icon: '', reward: 150 },
                { id: 's4', title: 'Social Butterfly', desc: 'Share an achievement', target: 1, icon: '', reward: 100 }
            ]
        };

        let questProgress = JSON.parse(localStorage.getItem('questProgress')) || {};

        function openQuestsModal() {
            renderQuests('daily');
            document.getElementById('quests-modal').style.display = 'flex';
        }

        function closeQuestsModal() {
            document.getElementById('quests-modal').style.display = 'none';
        }

        function switchQuestTab(type) {
            document.querySelectorAll('.quest-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderQuests(type);
        }

        function renderQuests(type) {
            const container = document.getElementById('quests-list');
            const quests = questsData[type];

            container.innerHTML = quests.map(quest => {
                const progress = questProgress[quest.id] || 0;
                const percentage = Math.min((progress / quest.target) * 100, 100);
                const isCompleted = progress >= quest.target;
                const statusClass = isCompleted ? 'completed' : (progress > 0 ? 'active' : '');

                return `
                    <div class="quest-card ${statusClass}">
                        <div class="quest-icon">${quest.icon}</div>
                        <div class="quest-title">${quest.title}</div>
                        <div class="quest-description">${quest.desc}</div>
                        <div class="quest-progress">
                            <div class="quest-progress-bar">
                                <div class="quest-progress-fill" style="width: ${percentage}%"></div>
                            </div>
                            <span class="quest-progress-text">${progress}/${quest.target}</span>
                        </div>
                        <span class="quest-reward"> ${quest.reward} XP</span>
                        ${isCompleted ? '<span style="margin-left: 10px; color: #4CAF50;"> Complete!</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        function updateQuestProgress(questId, amount = 1) {
            questProgress[questId] = (questProgress[questId] || 0) + amount;
            localStorage.setItem('questProgress', JSON.stringify(questProgress));

            // Check for completion and award XP
            Object.values(questsData).flat().forEach(quest => {
                if (quest.id === questId && questProgress[questId] >= quest.target) {
                    const rewarded = localStorage.getItem('quest_rewarded_' + questId);
                    if (!rewarded) {
                        const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
                        localStorage.setItem('scienceXP', currentXP + quest.reward);
                        localStorage.setItem('quest_rewarded_' + questId, 'true');
                        showQuestComplete(quest);
                    }
                }
            });
        }

        function showQuestComplete(quest) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
                color: white;
                padding: 30px 40px;
                border-radius: 20px;
                text-align: center;
                z-index: 99999;
                animation: questPop 0.5s ease;
            `;
            toast.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 10px;">${quest.icon}</div>
                <h3 style="margin: 0;">Quest Complete!</h3>
                <p style="margin: 10px 0;">${quest.title}</p>
                <p style="font-weight: 600;">+${quest.reward} XP</p>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Virtual Pet
        let petState = JSON.parse(localStorage.getItem('virtualPet')) || {
            name: 'Sciency',
            avatar: '',
            happiness: 100,
            energy: 80,
            knowledge: 50,
            lastInteraction: Date.now()
        };

        const petAvatars = ['', '', '', '', '', '', '', ''];
        const petMessages = {
            happy: ['Great job! Keep learning!', 'You\'re doing amazing!', 'I\'m so proud of you!', 'Science is fun!'],
            neutral: ['Let\'s learn something new!', 'Ready to study?', 'Time for science!'],
            sad: ['I miss you! Let\'s study!', 'Come play with me!', 'Don\'t forget about science!'],
            correct: ['Woohoo! You got it right!', 'Smart thinking!', 'Excellent answer!'],
            incorrect: ['Don\'t worry, try again!', 'Keep trying, you\'ll get it!', 'Learning from mistakes!']
        };

        function toggleVirtualPet() {
            const pet = document.getElementById('virtual-pet');
            pet.classList.toggle('active');
            if (pet.classList.contains('active')) {
                updatePetDisplay();
                petSayRandom('happy');
            }
        }

        function updatePetDisplay() {
            document.getElementById('pet-avatar').textContent = petState.avatar;
            document.getElementById('pet-name').textContent = petState.name;
            document.getElementById('pet-happiness').style.width = petState.happiness + '%';
            document.getElementById('pet-energy').style.width = petState.energy + '%';
            document.getElementById('pet-knowledge').style.width = petState.knowledge + '%';

            const mood = petState.happiness > 70 ? 'Feeling happy!' : petState.happiness > 40 ? 'Feeling okay' : 'Feeling sad...';
            document.getElementById('pet-mood').textContent = mood;
        }

        function petSayRandom(type) {
            const messages = petMessages[type];
            const message = messages[Math.floor(Math.random() * messages.length)];
            showPetMessage(message);
        }

        function showPetMessage(message) {
            const msgEl = document.getElementById('pet-message');
            msgEl.textContent = message;
            msgEl.classList.add('show');
            setTimeout(() => msgEl.classList.remove('show'), 3000);
        }

        function petPet() {
            petState.happiness = Math.min(petState.happiness + 10, 100);
            localStorage.setItem('virtualPet', JSON.stringify(petState));
            updatePetDisplay();

            const avatar = document.getElementById('pet-avatar');
            avatar.classList.add('happy');
            setTimeout(() => avatar.classList.remove('happy'), 500);

            petSayRandom('happy');
        }

        function feedPetKnowledge(amount = 5) {
            petState.knowledge = Math.min(petState.knowledge + amount, 100);
            petState.happiness = Math.min(petState.happiness + 5, 100);
            localStorage.setItem('virtualPet', JSON.stringify(petState));
            updatePetDisplay();
        }

        // Science Lab
        const experiments = [
            {
                title: 'States of Matter',
                desc: 'Watch what happens when we heat water!',
                animation: '',
                result: 'Water changes from liquid to gas (steam) when heated! This is called evaporation.',
                xp: 25
            },
            {
                title: 'Magnetic Forces',
                desc: 'See how magnets attract and repel!',
                animation: '',
                result: 'Opposite poles attract (N-S) and same poles repel (N-N or S-S). Magnets create invisible force fields!',
                xp: 25
            },
            {
                title: 'Plant Growth',
                desc: 'Observe photosynthesis in action!',
                animation: '',
                result: 'Plants use sunlight, water, and CO2 to make food (glucose) and release oxygen. This is photosynthesis!',
                xp: 25
            },
            {
                title: 'Electric Circuits',
                desc: 'Build a simple circuit!',
                animation: '',
                result: 'Electricity flows through a closed circuit from battery  wire  bulb  back to battery. Open circuits don\'t work!',
                xp: 25
            }
        ];

        let currentExpIndex = 0;

        function openLabModal() {
            loadExperiment(0);
            document.getElementById('lab-modal').style.display = 'flex';
        }

        function closeLabModal() {
            document.getElementById('lab-modal').style.display = 'none';
        }

        function loadExperiment(index) {
            currentExpIndex = index;
            const exp = experiments[index];

            document.getElementById('exp-title').textContent = exp.title;
            document.getElementById('exp-desc').textContent = exp.desc;
            document.getElementById('exp-animation').innerHTML = `
                <span class="beaker">${exp.animation}</span>
                <div class="bubbles">
                    <div class="bubble"></div>
                    <div class="bubble"></div>
                    <div class="bubble"></div>
                </div>
            `;
            document.getElementById('exp-result').classList.remove('show');
        }

        function startExperiment() {
            const exp = experiments[currentExpIndex];
            const animation = document.getElementById('exp-animation');

            animation.innerHTML = '<div style="font-size: 2rem; color: #00d4ff;">Running experiment...</div>';

            setTimeout(() => {
                animation.innerHTML = `<span style="font-size: 5rem; animation: pulse 1s infinite;"></span>`;

                setTimeout(() => {
                    document.getElementById('exp-result-text').textContent = exp.result;
                    document.getElementById('exp-result').classList.add('show');

                    // Award XP
                    const expCompleted = localStorage.getItem('exp_completed_' + currentExpIndex);
                    if (!expCompleted) {
                        const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
                        localStorage.setItem('scienceXP', currentXP + exp.xp);
                        localStorage.setItem('exp_completed_' + currentExpIndex, 'true');
                        feedPetKnowledge(10);
                    }
                }, 2000);
            }, 2000);
        }

        function resetExperiment() {
            loadExperiment(currentExpIndex);
        }

        // Add quest popup animation
        const questStyle = document.createElement('style');
        questStyle.textContent = `
            @keyframes questPop {
                0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
                50% { transform: translate(-50%, -50%) scale(1.1); }
                100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            }
        `;
        document.head.appendChild(questStyle);

        console.log(' Learning Quests, Virtual Pet, and Science Lab loaded!');
    </script>

    <!-- ========== BATCH 25: Badges Gallery, Custom Avatar, Sound Effects ========== -->

    <!-- Badges Gallery Modal -->
    <div class="badges-gallery-modal" id="badges-gallery-modal">
        <div class="badges-gallery-content">
            <div class="badges-gallery-header">
                <h2> My Badges</h2>
                <div class="badges-stats">
                    <div class="badge-stat">
                        <div class="badge-stat-num" id="earned-badges-count">0</div>
                        <div class="badge-stat-label">Earned</div>
                    </div>
                    <div class="badge-stat">
                        <div class="badge-stat-num" id="total-badges-count">20</div>
                        <div class="badge-stat-label">Total</div>
                    </div>
                </div>
            </div>
            <div class="badges-grid" id="badges-grid">
                <!-- Populated by JavaScript -->
            </div>
            <div style="padding: 15px; text-align: center;">
                <button onclick="closeBadgesGallery()" style="padding: 10px 30px; border: none; background: rgba(255,255,255,0.2); border-radius: 20px; color: white; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Custom Avatar Modal -->
    <div class="avatar-modal" id="avatar-modal">
        <div class="avatar-content">
            <h2 style="margin: 0 0 20px 0;"> Customize Your Avatar</h2>
            <div class="avatar-preview" id="avatar-preview"></div>

            <div class="avatar-section">
                <h4>Choose Your Face</h4>
                <div class="avatar-options" id="face-options">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="avatar-section">
                <h4>Background Color</h4>
                <div class="avatar-options" id="color-options">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="avatar-section">
                <h4>Your Name</h4>
                <input type="text" class="avatar-name-input" id="avatar-name-input" placeholder="Enter your name..." maxlength="20">
            </div>

            <button class="avatar-save-btn" onclick="saveAvatar()">Save Avatar</button>
            <button onclick="closeAvatarModal()" style="margin-top: 10px; padding: 10px 20px; border: none; background: transparent; color: #666; cursor: pointer;">Cancel</button>
        </div>
    </div>

    <!-- Sound Effects Panel -->
    <div class="sound-panel" id="sound-panel">
        <h3> Sound Settings</h3>
        <div class="sound-option">
            <span class="sound-label"> Correct Answer</span>
            <div class="sound-toggle on" id="sound-correct" onclick="toggleSound('correct')"></div>
        </div>
        <div class="sound-option">
            <span class="sound-label"> Wrong Answer</span>
            <div class="sound-toggle on" id="sound-wrong" onclick="toggleSound('wrong')"></div>
        </div>
        <div class="sound-option">
            <span class="sound-label"> Level Up</span>
            <div class="sound-toggle on" id="sound-levelup" onclick="toggleSound('levelup')"></div>
        </div>
        <div class="sound-option">
            <span class="sound-label"> Achievement</span>
            <div class="sound-toggle on" id="sound-achievement" onclick="toggleSound('achievement')"></div>
        </div>
        <div class="sound-option">
            <span class="sound-label"> Click Sounds</span>
            <div class="sound-toggle" id="sound-click" onclick="toggleSound('click')"></div>
        </div>
        <div class="volume-row">
            <span></span>
            <input type="range" class="sound-volume-slider" id="master-volume" min="0" max="100" value="70" onchange="updateMasterVolume(this.value)">
            <span></span>
        </div>
        <button class="sound-preview-btn" onclick="previewSounds()"> Preview Sounds</button>
    </div>

    <!-- Floating Action Buttons for Batch 25 -->
    <button class="floating-badges-btn" onclick="openBadgesGallery()" title="Badges Gallery"></button>
    <button class="floating-avatar-btn" onclick="openAvatarModal()" title="Customize Avatar"></button>
    <button class="floating-sound-btn" onclick="toggleSoundPanel()" title="Sound Settings"></button>

    <script>
        // ========== BATCH 25: Badges Gallery, Custom Avatar, Sound Effects ==========

        // Badges Gallery
        const allBadges = [
            { id: 'b1', icon: '', name: 'First Star', requirement: 'Complete first question', check: () => (parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0) >= 1 },
            { id: 'b2', icon: '', name: 'On Fire', requirement: '5-day streak', check: () => (parseInt(localStorage.getItem('currentStreak')) || 0) >= 5 },
            { id: 'b3', icon: '', name: 'Sharpshooter', requirement: '80% accuracy', check: () => calculateAccuracy() >= 80 },
            { id: 'b4', icon: '', name: 'Rocket Starter', requirement: 'Reach Level 3', check: () => calculateLevel() >= 3 },
            { id: 'b5', icon: '', name: 'Brain Power', requirement: '100 correct answers', check: () => (parseInt(localStorage.getItem('correctAnswers')) || 0) >= 100 },
            { id: 'b6', icon: '', name: 'Bookworm', requirement: '5 study notes', check: () => (JSON.parse(localStorage.getItem('studyNotes')) || []).length >= 5 },
            { id: 'b7', icon: '', name: 'Speed Demon', requirement: '10 quick answers', check: () => (parseInt(localStorage.getItem('quickAnswers')) || 0) >= 10 },
            { id: 'b8', icon: '', name: 'Champion', requirement: 'Reach Level 5', check: () => calculateLevel() >= 5 },
            { id: 'b9', icon: '', name: 'Diamond', requirement: 'Reach Level 10', check: () => calculateLevel() >= 10 },
            { id: 'b10', icon: '', name: 'Royalty', requirement: 'Reach Level 15', check: () => calculateLevel() >= 15 },
            { id: 'b11', icon: '', name: 'Rainbow', requirement: 'All topic badges', check: () => checkAllTopics() },
            { id: 'b12', icon: '', name: 'Explorer', requirement: 'Try all topics', check: () => checkAllTopics() },
            { id: 'b13', icon: '', name: 'Scientist', requirement: 'Complete all experiments', check: () => checkExperiments() },
            { id: 'b14', icon: '', name: 'Pet Friend', requirement: 'Max pet happiness', check: () => (JSON.parse(localStorage.getItem('virtualPet')) || {}).happiness >= 100 },
            { id: 'b15', icon: '', name: 'Consistent', requirement: '7-day streak', check: () => (parseInt(localStorage.getItem('currentStreak')) || 0) >= 7 },
            { id: 'b16', icon: '', name: 'Gift Grabber', requirement: 'Claim 7 daily rewards', check: () => (parseInt(localStorage.getItem('totalRewardsClaimed')) || 0) >= 7 },
            { id: 'b17', icon: '', name: 'Strong', requirement: '500 XP', check: () => (parseInt(localStorage.getItem('scienceXP')) || 0) >= 500 },
            { id: 'b18', icon: '', name: 'Night Owl', requirement: 'Study at night', check: () => localStorage.getItem('nightStudy') === 'true' },
            { id: 'b19', icon: '', name: 'Early Bird', requirement: 'Study in morning', check: () => localStorage.getItem('morningStudy') === 'true' },
            { id: 'b20', icon: '', name: 'Graduate', requirement: 'Complete all quests', check: () => checkAllQuests() }
        ];

        function calculateAccuracy() {
            const total = parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0;
            const correct = parseInt(localStorage.getItem('correctAnswers')) || 0;
            return total > 0 ? Math.round((correct / total) * 100) : 0;
        }

        function calculateLevel() {
            const xp = parseInt(localStorage.getItem('scienceXP')) || 0;
            return Math.floor(xp / 100) + 1;
        }

        function checkAllTopics() {
            const topicsVisited = JSON.parse(localStorage.getItem('topicsVisited')) || [];
            return topicsVisited.length >= 6;
        }

        function checkExperiments() {
            return [0, 1, 2, 3].every(i => localStorage.getItem('exp_completed_' + i) === 'true');
        }

        function checkAllQuests() {
            const questProgress = JSON.parse(localStorage.getItem('questProgress')) || {};
            return Object.keys(questProgress).length >= 12;
        }

        function openBadgesGallery() {
            renderBadgesGallery();
            document.getElementById('badges-gallery-modal').style.display = 'flex';
        }

        function closeBadgesGallery() {
            document.getElementById('badges-gallery-modal').style.display = 'none';
        }

        function renderBadgesGallery() {
            const grid = document.getElementById('badges-grid');
            let earnedCount = 0;

            grid.innerHTML = allBadges.map(badge => {
                const isEarned = badge.check();
                if (isEarned) earnedCount++;

                return `
                    <div class="badge-item ${isEarned ? 'earned' : 'locked'}">
                        <div class="badge-icon">${badge.icon}</div>
                        <div class="badge-name">${badge.name}</div>
                        <div class="badge-requirement">${badge.requirement}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('earned-badges-count').textContent = earnedCount;
            document.getElementById('total-badges-count').textContent = allBadges.length;
        }

        // Custom Avatar
        const avatarFaces = ['', '', '', '', '', '', '', '', '', '', '', ''];
        const avatarColors = [
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
            'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
            'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
        ];

        let selectedFace = '';
        let selectedColor = avatarColors[0];

        function openAvatarModal() {
            // Load saved avatar
            const savedAvatar = JSON.parse(localStorage.getItem('userAvatar')) || {};
            selectedFace = savedAvatar.face || '';
            selectedColor = savedAvatar.color || avatarColors[0];
            document.getElementById('avatar-name-input').value = savedAvatar.name || '';

            renderAvatarOptions();
            updateAvatarPreview();
            document.getElementById('avatar-modal').style.display = 'flex';
        }

        function closeAvatarModal() {
            document.getElementById('avatar-modal').style.display = 'none';
        }

        function renderAvatarOptions() {
            const faceContainer = document.getElementById('face-options');
            faceContainer.innerHTML = avatarFaces.map(face => `
                <div class="avatar-option ${face === selectedFace ? 'selected' : ''}" onclick="selectFace('${face}')">${face}</div>
            `).join('');

            const colorContainer = document.getElementById('color-options');
            colorContainer.innerHTML = avatarColors.map((color, index) => `
                <div class="color-option ${color === selectedColor ? 'selected' : ''}" style="background: ${color}" onclick="selectColor(${index})"></div>
            `).join('');
        }

        function selectFace(face) {
            selectedFace = face;
            renderAvatarOptions();
            updateAvatarPreview();
        }

        function selectColor(index) {
            selectedColor = avatarColors[index];
            renderAvatarOptions();
            updateAvatarPreview();
        }

        function updateAvatarPreview() {
            const preview = document.getElementById('avatar-preview');
            preview.textContent = selectedFace;
            preview.style.background = selectedColor;
        }

        function saveAvatar() {
            const name = document.getElementById('avatar-name-input').value.trim() || 'Student';
            const avatarData = {
                face: selectedFace,
                color: selectedColor,
                name: name
            };
            localStorage.setItem('userAvatar', JSON.stringify(avatarData));

            closeAvatarModal();
            showAvatarSavedToast();
        }

        function showAvatarSavedToast() {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 30px;
                border-radius: 30px;
                font-weight: 600;
                z-index: 99999;
            `;
            toast.textContent = ' Avatar saved!';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Sound Effects
        let soundSettings = JSON.parse(localStorage.getItem('soundSettings')) || {
            correct: true,
            wrong: true,
            levelup: true,
            achievement: true,
            click: false,
            volume: 70
        };

        function toggleSoundPanel() {
            const panel = document.getElementById('sound-panel');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                updateSoundToggles();
            }
        }

        function updateSoundToggles() {
            Object.keys(soundSettings).forEach(key => {
                if (key !== 'volume') {
                    const toggle = document.getElementById('sound-' + key);
                    if (toggle) {
                        toggle.classList.toggle('on', soundSettings[key]);
                    }
                }
            });
            document.getElementById('master-volume').value = soundSettings.volume;
        }

        function toggleSound(type) {
            soundSettings[type] = !soundSettings[type];
            localStorage.setItem('soundSettings', JSON.stringify(soundSettings));
            updateSoundToggles();
        }

        function updateMasterVolume(value) {
            soundSettings.volume = parseInt(value);
            localStorage.setItem('soundSettings', JSON.stringify(soundSettings));
        }

        function playSound(type) {
            if (!soundSettings[type]) return;

            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();

            gain.gain.value = soundSettings.volume / 100 * 0.3;
            osc.connect(gain);
            gain.connect(ctx.destination);

            switch (type) {
                case 'correct':
                    osc.frequency.value = 523.25; // C5
                    osc.type = 'sine';
                    break;
                case 'wrong':
                    osc.frequency.value = 200;
                    osc.type = 'sawtooth';
                    break;
                case 'levelup':
                    osc.frequency.value = 659.25; // E5
                    osc.type = 'triangle';
                    break;
                case 'achievement':
                    osc.frequency.value = 783.99; // G5
                    osc.type = 'sine';
                    break;
                case 'click':
                    osc.frequency.value = 1000;
                    osc.type = 'square';
                    gain.gain.value = soundSettings.volume / 100 * 0.1;
                    break;
            }

            osc.start();
            osc.stop(ctx.currentTime + 0.15);
        }

        function previewSounds() {
            let delay = 0;
            ['correct', 'wrong', 'levelup', 'achievement'].forEach(type => {
                setTimeout(() => playSound(type), delay);
                delay += 300;
            });
        }

        // Initialize sound toggles
        document.addEventListener('DOMContentLoaded', function() {
            updateSoundToggles();
        });

        console.log(' Badges Gallery, Custom Avatar, and Sound Effects loaded!');
    </script>

    <!-- ========== BATCH 26: Confetti, Activity Heatmap, Parent Mode ========== -->

    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas"></canvas>

    <!-- Activity Heatmap Modal -->
    <div class="heatmap-modal" id="heatmap-modal">
        <div class="heatmap-content">
            <div class="heatmap-header">
                <h2> Learning Activity</h2>
                <p style="color: #666; margin-top: 5px;">Your study activity over the past weeks</p>
            </div>
            <div class="heatmap-legend">
                <span class="legend-item"><span class="legend-box" style="background: #ebedf0;"></span> No activity</span>
                <span class="legend-item"><span class="legend-box" style="background: #9be9a8;"></span> Light</span>
                <span class="legend-item"><span class="legend-box" style="background: #40c463;"></span> Medium</span>
                <span class="legend-item"><span class="legend-box" style="background: #30a14e;"></span> Good</span>
                <span class="legend-item"><span class="legend-box" style="background: #216e39;"></span> Great</span>
            </div>
            <div class="heatmap-grid" id="heatmap-grid">
                <!-- Populated by JavaScript -->
            </div>
            <div class="heatmap-summary" id="heatmap-summary">
                <!-- Populated by JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeHeatmapModal()" style="padding: 10px 30px; border: none; background: #f0f0f0; border-radius: 20px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Parent Mode Modal -->
    <div class="parent-modal" id="parent-modal">
        <div class="parent-content">
            <div class="parent-header">
                <h2> Parent Dashboard</h2>
                <p style="margin: 5px 0 0 0; opacity: 0.9;">Monitor your child's learning progress</p>
            </div>
            <div class="parent-login" id="parent-login">
                <p style="color: #666; margin-bottom: 20px;">Enter PIN to access (default: 1234)</p>
                <input type="password" class="parent-pin-input" id="parent-pin" maxlength="4" placeholder="****">
                <br>
                <button class="parent-pin-btn" onclick="verifyParentPin()">Access Dashboard</button>
                <p id="pin-error" style="color: #f44336; margin-top: 10px; display: none;">Incorrect PIN</p>
                <button onclick="closeParentModal()" style="margin-top: 15px; padding: 10px 20px; border: none; background: transparent; color: #666; cursor: pointer;">Cancel</button>
            </div>
            <div class="parent-dashboard" id="parent-dashboard">
                <div class="dashboard-section">
                    <h3> Overview</h3>
                    <div class="dashboard-stats" id="dashboard-stats">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                <div class="dashboard-section">
                    <h3> Weekly Progress</h3>
                    <div class="progress-chart" id="progress-chart">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                <div class="dashboard-section">
                    <h3> Settings</h3>
                    <div class="parent-settings">
                        <div class="parent-setting">
                            <span>Daily Study Goal</span>
                            <select id="daily-goal-setting" onchange="updateParentSettings()">
                                <option value="15">15 min</option>
                                <option value="30">30 min</option>
                                <option value="45">45 min</option>
                                <option value="60">60 min</option>
                            </select>
                        </div>
                        <div class="parent-setting">
                            <span>Change PIN</span>
                            <input type="password" id="new-pin" maxlength="4" placeholder="New PIN" style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <button onclick="saveParentSettings()" style="padding: 12px; border: none; background: #1976d2; color: white; border-radius: 10px; cursor: pointer;">Save Settings</button>
                    </div>
                </div>
                <button onclick="closeParentModal()" style="margin-top: 10px; padding: 10px 30px; border: none; background: #f0f0f0; border-radius: 20px; cursor: pointer; width: 100%;">Close Dashboard</button>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons for Batch 26 -->
    <button class="floating-heatmap-btn" onclick="openHeatmapModal()" title="Activity Heatmap"></button>
    <button class="floating-parent-btn" onclick="openParentModal()" title="Parent Mode"></button>

    <script>
        // ========== BATCH 26: Confetti, Activity Heatmap, Parent Mode ==========

        // Confetti System
        const confettiCanvas = document.getElementById('confetti-canvas');
        const confettiCtx = confettiCanvas.getContext('2d');
        let confettiParticles = [];
        let confettiAnimating = false;

        function resizeConfettiCanvas() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
        }
        resizeConfettiCanvas();
        window.addEventListener('resize', resizeConfettiCanvas);

        class ConfettiParticle {
            constructor() {
                this.x = Math.random() * confettiCanvas.width;
                this.y = Math.random() * confettiCanvas.height - confettiCanvas.height;
                this.size = Math.random() * 10 + 5;
                this.speedY = Math.random() * 3 + 2;
                this.speedX = Math.random() * 2 - 1;
                this.rotation = Math.random() * 360;
                this.rotationSpeed = Math.random() * 10 - 5;
                this.color = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dfe6e9', '#fd79a8', '#a29bfe'][Math.floor(Math.random() * 8)];
            }

            update() {
                this.y += this.speedY;
                this.x += this.speedX;
                this.rotation += this.rotationSpeed;
            }

            draw() {
                confettiCtx.save();
                confettiCtx.translate(this.x, this.y);
                confettiCtx.rotate(this.rotation * Math.PI / 180);
                confettiCtx.fillStyle = this.color;
                confettiCtx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size / 2);
                confettiCtx.restore();
            }
        }

        function createConfetti(count = 150) {
            confettiParticles = [];
            for (let i = 0; i < count; i++) {
                confettiParticles.push(new ConfettiParticle());
            }
            if (!confettiAnimating) {
                confettiAnimating = true;
                animateConfetti();
            }
        }

        function animateConfetti() {
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);

            confettiParticles.forEach((p, index) => {
                p.update();
                p.draw();
                if (p.y > confettiCanvas.height) {
                    confettiParticles.splice(index, 1);
                }
            });

            if (confettiParticles.length > 0) {
                requestAnimationFrame(animateConfetti);
            } else {
                confettiAnimating = false;
            }
        }

        function celebrateWithConfetti() {
            createConfetti(200);
        }

        // Activity Heatmap
        let activityData = JSON.parse(localStorage.getItem('activityData')) || {};

        function recordActivity(count = 1) {
            const today = new Date().toISOString().split('T')[0];
            activityData[today] = (activityData[today] || 0) + count;
            localStorage.setItem('activityData', JSON.stringify(activityData));
        }

        function openHeatmapModal() {
            renderHeatmap();
            document.getElementById('heatmap-modal').style.display = 'flex';
        }

        function closeHeatmapModal() {
            document.getElementById('heatmap-modal').style.display = 'none';
        }

        function renderHeatmap() {
            const grid = document.getElementById('heatmap-grid');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            // Generate 8 weeks of data (56 days)
            const cells = [];

            // Day labels
            days.forEach(day => {
                cells.push(`<div class="heatmap-day-label">${day}</div>`);
            });

            // Generate cells for past 8 weeks
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 55);

            // Adjust to start from Sunday
            const dayOfWeek = startDate.getDay();
            startDate.setDate(startDate.getDate() - dayOfWeek);

            let totalActivity = 0;
            let activeDays = 0;

            for (let i = 0; i < 56; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const activity = activityData[dateStr] || 0;

                if (activity > 0) {
                    totalActivity += activity;
                    activeDays++;
                }

                let level = '';
                if (activity >= 20) level = 'level-4';
                else if (activity >= 10) level = 'level-3';
                else if (activity >= 5) level = 'level-2';
                else if (activity >= 1) level = 'level-1';

                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                cells.push(`
                    <div class="heatmap-cell ${level}">
                        <div class="heatmap-tooltip">${formattedDate}: ${activity} activities</div>
                    </div>
                `);
            }

            grid.innerHTML = cells.join('');

            // Update summary
            const summary = document.getElementById('heatmap-summary');
            const currentStreak = parseInt(localStorage.getItem('currentStreak')) || 0;
            summary.innerHTML = `
                <div class="heatmap-stat">
                    <div class="heatmap-stat-value">${totalActivity}</div>
                    <div class="heatmap-stat-label">Total Activities</div>
                </div>
                <div class="heatmap-stat">
                    <div class="heatmap-stat-value">${activeDays}</div>
                    <div class="heatmap-stat-label">Active Days</div>
                </div>
                <div class="heatmap-stat">
                    <div class="heatmap-stat-value">${currentStreak}</div>
                    <div class="heatmap-stat-label">Current Streak</div>
                </div>
            `;
        }

        // Parent Mode
        let parentSettings = JSON.parse(localStorage.getItem('parentSettings')) || {
            pin: '1234',
            dailyGoal: 30
        };

        function openParentModal() {
            document.getElementById('parent-login').style.display = 'block';
            document.getElementById('parent-dashboard').classList.remove('active');
            document.getElementById('parent-pin').value = '';
            document.getElementById('pin-error').style.display = 'none';
            document.getElementById('parent-modal').style.display = 'flex';
        }

        function closeParentModal() {
            document.getElementById('parent-modal').style.display = 'none';
        }

        function verifyParentPin() {
            const enteredPin = document.getElementById('parent-pin').value;
            if (enteredPin === parentSettings.pin) {
                document.getElementById('parent-login').style.display = 'none';
                document.getElementById('parent-dashboard').classList.add('active');
                renderParentDashboard();
            } else {
                document.getElementById('pin-error').style.display = 'block';
            }
        }

        function renderParentDashboard() {
            const stats = document.getElementById('dashboard-stats');
            const totalXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            const level = Math.floor(totalXP / 100) + 1;
            const questionsAnswered = parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0;
            const correctAnswers = parseInt(localStorage.getItem('correctAnswers')) || 0;
            const accuracy = questionsAnswered > 0 ? Math.round((correctAnswers / questionsAnswered) * 100) : 0;
            const streak = parseInt(localStorage.getItem('currentStreak')) || 0;

            stats.innerHTML = `
                <div class="dashboard-stat">
                    <div class="dashboard-stat-value">${level}</div>
                    <div class="dashboard-stat-label">Current Level</div>
                </div>
                <div class="dashboard-stat">
                    <div class="dashboard-stat-value">${totalXP}</div>
                    <div class="dashboard-stat-label">Total XP</div>
                </div>
                <div class="dashboard-stat">
                    <div class="dashboard-stat-value">${accuracy}%</div>
                    <div class="dashboard-stat-label">Accuracy</div>
                </div>
                <div class="dashboard-stat">
                    <div class="dashboard-stat-value">${questionsAnswered}</div>
                    <div class="dashboard-stat-label">Questions</div>
                </div>
                <div class="dashboard-stat">
                    <div class="dashboard-stat-value">${correctAnswers}</div>
                    <div class="dashboard-stat-label">Correct</div>
                </div>
                <div class="dashboard-stat">
                    <div class="dashboard-stat-value">${streak}</div>
                    <div class="dashboard-stat-label">Streak</div>
                </div>
            `;

            // Weekly progress chart
            const chart = document.getElementById('progress-chart');
            const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const maxActivity = 20;

            chart.innerHTML = weekDays.map((day, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (6 - i));
                const dateStr = date.toISOString().split('T')[0];
                const activity = activityData[dateStr] || 0;
                const height = Math.min((activity / maxActivity) * 100, 100);

                return `
                    <div class="chart-bar" style="height: ${height}%">
                        <span class="chart-bar-label">${day}</span>
                    </div>
                `;
            }).join('');

            // Load settings
            document.getElementById('daily-goal-setting').value = parentSettings.dailyGoal;
        }

        function updateParentSettings() {
            parentSettings.dailyGoal = parseInt(document.getElementById('daily-goal-setting').value);
        }

        function saveParentSettings() {
            const newPin = document.getElementById('new-pin').value;
            if (newPin && newPin.length === 4) {
                parentSettings.pin = newPin;
            }
            parentSettings.dailyGoal = parseInt(document.getElementById('daily-goal-setting').value);
            localStorage.setItem('parentSettings', JSON.stringify(parentSettings));

            alert('Settings saved!');
            document.getElementById('new-pin').value = '';
        }

        // Auto-record activity when answering questions (hook)
        recordActivity(1);

        console.log(' Confetti, Activity Heatmap, and Parent Mode loaded!');
    </script>

    <!-- ========== BATCH 27: Topic Explorer, Daily Challenge, Skill Tree ========== -->

    <!-- Topic Explorer Modal -->
    <div class="topic-explorer-modal" id="topic-explorer-modal">
        <div class="topic-explorer-content">
            <div class="topic-explorer-header">
                <h2> Topic Explorer</h2>
                <p style="color: #aaa; margin-top: 5px;">Click a topic to explore and learn!</p>
            </div>
            <div class="topic-map" id="topic-map">
                <!-- Populated by JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeTopicExplorer()" style="padding: 10px 30px; border: none; background: rgba(255,255,255,0.2); border-radius: 20px; color: white; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Daily Challenge Modal -->
    <div class="daily-challenge-modal" id="daily-challenge-modal">
        <div class="daily-challenge-content">
            <div class="challenge-header">
                <h2> Daily Challenge</h2>
                <div class="challenge-timer" id="challenge-timer">Resets in: 12:34:56</div>
                <span class="challenge-badge" id="challenge-status">NEW</span>
            </div>
            <div class="challenge-body" id="challenge-body">
                <!-- Populated by JavaScript -->
            </div>
            <div style="text-align: center; padding: 20px;">
                <button onclick="closeDailyChallenge()" style="padding: 10px 30px; border: none; background: #f0f0f0; border-radius: 20px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Skill Tree Modal -->
    <div class="skill-tree-modal" id="skill-tree-modal">
        <div class="skill-tree-content">
            <div class="skill-tree-header">
                <h2> Skill Tree</h2>
                <p style="color: #aaa; margin-top: 5px;">Unlock skills as you progress!</p>
            </div>
            <div class="skill-tree-container" id="skill-tree-container">
                <!-- Populated by JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeSkillTree()" style="padding: 10px 30px; border: none; background: rgba(255,255,255,0.2); border-radius: 20px; color: white; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons for Batch 27 -->
    <button class="floating-explore-btn" onclick="openTopicExplorer()" title="Topic Explorer"></button>
    <button class="floating-challenge-btn" onclick="openDailyChallenge()" title="Daily Challenge"></button>
    <button class="floating-skilltree-btn" onclick="openSkillTree()" title="Skill Tree"></button>

    <script>
        // ========== BATCH 27: Topic Explorer, Daily Challenge, Skill Tree ==========

        // Topic Explorer
        const scienceTopics = [
            { id: 'physics', name: 'Physics', icon: '', color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
            { id: 'chemistry', name: 'Chemistry', icon: '', color: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)' },
            { id: 'biology', name: 'Biology', icon: '', color: 'linear-gradient(135deg, #ee0979 0%, #ff6a00 100%)' },
            { id: 'earth', name: 'Earth Science', icon: '', color: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
            { id: 'space', name: 'Space', icon: '', color: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)' },
            { id: 'ecology', name: 'Ecology', icon: '', color: 'linear-gradient(135deg, #56ab2f 0%, #a8e063 100%)' }
        ];

        let topicProgress = JSON.parse(localStorage.getItem('topicProgress')) || {};

        function openTopicExplorer() {
            renderTopicMap();
            document.getElementById('topic-explorer-modal').style.display = 'flex';
        }

        function closeTopicExplorer() {
            document.getElementById('topic-explorer-modal').style.display = 'none';
        }

        function renderTopicMap() {
            const container = document.getElementById('topic-map');
            container.innerHTML = scienceTopics.map(topic => {
                const progress = topicProgress[topic.id] || 0;
                const isMastered = progress >= 100;

                return `
                    <div class="topic-node ${isMastered ? 'mastered' : ''}" style="background: ${topic.color}" onclick="selectTopic('${topic.id}')">
                        <span class="topic-node-icon">${topic.icon}</span>
                        <span class="topic-node-name">${topic.name}</span>
                        <span class="topic-node-progress">${progress}%</span>
                    </div>
                `;
            }).join('');
        }

        function selectTopic(topicId) {
            const topic = scienceTopics.find(t => t.id === topicId);
            closeTopicExplorer();
            alert('Starting ' + topic.name + ' questions! Feature coming soon.');

            // Record topic visit
            let topicsVisited = JSON.parse(localStorage.getItem('topicsVisited')) || [];
            if (!topicsVisited.includes(topicId)) {
                topicsVisited.push(topicId);
                localStorage.setItem('topicsVisited', JSON.stringify(topicsVisited));
            }
        }

        function updateTopicProgress(topicId, amount = 5) {
            topicProgress[topicId] = Math.min((topicProgress[topicId] || 0) + amount, 100);
            localStorage.setItem('topicProgress', JSON.stringify(topicProgress));
        }

        // Daily Challenge
        const dailyChallenges = [
            { question: 'What is the chemical symbol for water?', options: ['H2O', 'CO2', 'NaCl', 'O2'], correct: 0 },
            { question: 'Which planet is known as the Red Planet?', options: ['Venus', 'Mars', 'Jupiter', 'Saturn'], correct: 1 },
            { question: 'What is the powerhouse of the cell?', options: ['Nucleus', 'Ribosome', 'Mitochondria', 'Golgi Body'], correct: 2 },
            { question: 'What force keeps us on the ground?', options: ['Friction', 'Magnetism', 'Gravity', 'Tension'], correct: 2 },
            { question: 'What gas do plants release during photosynthesis?', options: ['Carbon Dioxide', 'Nitrogen', 'Oxygen', 'Hydrogen'], correct: 2 },
            { question: 'What is the largest organ in the human body?', options: ['Heart', 'Brain', 'Liver', 'Skin'], correct: 3 },
            { question: 'What type of rock is formed from cooled lava?', options: ['Sedimentary', 'Metamorphic', 'Igneous', 'Limestone'], correct: 2 }
        ];

        let challengeAnswered = false;

        function openDailyChallenge() {
            renderDailyChallenge();
            document.getElementById('daily-challenge-modal').style.display = 'flex';
        }

        function closeDailyChallenge() {
            document.getElementById('daily-challenge-modal').style.display = 'none';
        }

        function renderDailyChallenge() {
            const today = new Date().toDateString();
            const lastChallenge = localStorage.getItem('lastChallengeDate');
            challengeAnswered = lastChallenge === today;

            // Get today's challenge based on day of year
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const challenge = dailyChallenges[dayOfYear % dailyChallenges.length];

            const statusBadge = document.getElementById('challenge-status');
            statusBadge.textContent = challengeAnswered ? 'COMPLETED' : 'NEW';
            statusBadge.style.background = challengeAnswered ? '#4CAF50' : '#f12711';

            const body = document.getElementById('challenge-body');

            if (challengeAnswered) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 4rem;"></div>
                        <h3 style="color: #4CAF50;">Challenge Completed!</h3>
                        <p style="color: #666;">Come back tomorrow for a new challenge.</p>
                    </div>
                `;
            } else {
                const letters = ['A', 'B', 'C', 'D'];
                body.innerHTML = `
                    <div class="challenge-question">${challenge.question}</div>
                    <div class="challenge-options">
                        ${challenge.options.map((opt, i) => `
                            <div class="challenge-option" onclick="answerChallenge(${i}, ${challenge.correct})">
                                <span class="challenge-option-letter">${letters[i]}</span>
                                <span>${opt}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="challenge-reward">
                        <div class="challenge-reward-icon"></div>
                        <div class="challenge-reward-text">Reward: 100 XP</div>
                    </div>
                `;
            }

            updateChallengeTimer();
        }

        function answerChallenge(selected, correct) {
            if (challengeAnswered) return;

            const options = document.querySelectorAll('.challenge-option');
            options.forEach((opt, i) => {
                opt.onclick = null;
                if (i === correct) {
                    opt.classList.add('correct');
                } else if (i === selected && selected !== correct) {
                    opt.classList.add('incorrect');
                }
            });

            challengeAnswered = true;
            localStorage.setItem('lastChallengeDate', new Date().toDateString());

            const statusBadge = document.getElementById('challenge-status');
            statusBadge.textContent = 'COMPLETED';
            statusBadge.style.background = '#4CAF50';

            if (selected === correct) {
                const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
                localStorage.setItem('scienceXP', currentXP + 100);

                setTimeout(() => {
                    celebrateWithConfetti();
                    alert(' Correct! You earned 100 XP!');
                }, 500);
            } else {
                setTimeout(() => {
                    alert(' Not quite! The correct answer was highlighted. Try again tomorrow!');
                }, 500);
            }
        }

        function updateChallengeTimer() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);

            const diff = tomorrow - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('challenge-timer').textContent =
                `Resets in: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Skill Tree
        const skillTree = [
            { tier: 1, skills: [
                { id: 's1', name: 'Beginner', icon: '', xpRequired: 0 },
            ]},
            { tier: 2, skills: [
                { id: 's2', name: 'Observer', icon: '', xpRequired: 100 },
                { id: 's3', name: 'Curious', icon: '', xpRequired: 100 },
            ]},
            { tier: 3, skills: [
                { id: 's4', name: 'Thinker', icon: '', xpRequired: 300 },
                { id: 's5', name: 'Explorer', icon: '', xpRequired: 300 },
                { id: 's6', name: 'Reader', icon: '', xpRequired: 300 },
            ]},
            { tier: 4, skills: [
                { id: 's7', name: 'Analyst', icon: '', xpRequired: 600 },
                { id: 's8', name: 'Experimenter', icon: '', xpRequired: 600 },
            ]},
            { tier: 5, skills: [
                { id: 's9', name: 'Scientist', icon: '', xpRequired: 1000 },
            ]},
            { tier: 6, skills: [
                { id: 's10', name: 'Master', icon: '', xpRequired: 1500 },
            ]}
        ];

        function openSkillTree() {
            renderSkillTree();
            document.getElementById('skill-tree-modal').style.display = 'flex';
        }

        function closeSkillTree() {
            document.getElementById('skill-tree-modal').style.display = 'none';
        }

        function renderSkillTree() {
            const container = document.getElementById('skill-tree-container');
            const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;

            container.innerHTML = skillTree.map((tier, tierIndex) => {
                const tierHtml = tier.skills.map(skill => {
                    const isUnlocked = currentXP >= skill.xpRequired;
                    return `
                        <div class="skill-node ${isUnlocked ? 'unlocked' : 'locked'}">
                            <span class="skill-node-icon">${skill.icon}</span>
                            <span class="skill-node-name">${skill.name}</span>
                            <div class="skill-tooltip">
                                ${skill.name}<br>
                                ${isUnlocked ? ' Unlocked!' : ` Requires ${skill.xpRequired} XP`}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    ${tierIndex > 0 ? '<div class="skill-connection-line"></div>' : ''}
                    <div class="skill-tier">${tierHtml}</div>
                `;
            }).join('');
        }

        console.log(' Topic Explorer, Daily Challenge, and Skill Tree loaded!');
    </script>

    <!-- ========== BATCH 28: Achievement Popups, Bonus Events, Milestones ========== -->

    <!-- Achievement Popup -->
    <div class="achievement-popup" id="achievement-popup">
        <div class="achievement-popup-glow"></div>
        <div class="achievement-popup-icon" id="achievement-popup-icon"></div>
        <h2 class="achievement-popup-title" id="achievement-popup-title">Achievement Unlocked!</h2>
        <p class="achievement-popup-desc" id="achievement-popup-desc">You earned a new badge!</p>
        <div class="achievement-popup-reward" id="achievement-popup-reward">+50 XP</div>
        <button class="achievement-popup-close" onclick="closeAchievementPopup()">Awesome!</button>
    </div>
    <div class="achievement-popup-overlay" id="achievement-popup-overlay" onclick="closeAchievementPopup()"></div>

    <!-- Bonus Event Banner -->
    <div class="bonus-event-banner" id="bonus-event-banner">
        <div class="bonus-event-content">
            <span class="bonus-event-icon"></span>
            <span class="bonus-event-text" id="bonus-event-text">DOUBLE XP EVENT!</span>
            <span class="bonus-event-timer" id="bonus-event-timer">29:59</span>
        </div>
        <button class="bonus-event-close" onclick="closeBonusEvent()"></button>
    </div>

    <!-- Learning Milestones Modal -->
    <div class="milestone-modal" id="milestone-modal">
        <div class="milestone-modal-content">
            <div class="milestone-header">
                <h2> Learning Milestones</h2>
                <p style="color: #aaa; margin-top: 5px;">Track your science learning journey!</p>
            </div>
            <div class="milestone-list" id="milestone-list">
                <!-- Populated by JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeMilestoneModal()" style="padding: 12px 40px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Floating Milestone Button -->
    <button class="floating-milestone-btn" onclick="openMilestoneModal()" title="Milestones"></button>

    <script>
        // ========== BATCH 28: Achievement Popups, Bonus Events, Milestones ==========

        // Achievement Popup System
        const achievementQueue = [];
        let isShowingAchievement = false;

        const achievements = {
            first_question: { icon: '', title: 'First Steps', desc: 'Answered your first question!', xp: 25 },
            streak_3: { icon: '', title: 'On Fire!', desc: 'Got 3 questions right in a row!', xp: 50 },
            streak_5: { icon: '', title: 'Unstoppable!', desc: 'Got 5 questions right in a row!', xp: 100 },
            streak_10: { icon: '', title: 'Legendary!', desc: 'Got 10 questions right in a row!', xp: 250 },
            level_5: { icon: '', title: 'Student', desc: 'Reached level 5!', xp: 75 },
            level_10: { icon: '', title: 'Scholar', desc: 'Reached level 10!', xp: 150 },
            questions_10: { icon: '', title: 'Getting Started', desc: 'Answered 10 questions!', xp: 50 },
            questions_50: { icon: '', title: 'Dedicated Learner', desc: 'Answered 50 questions!', xp: 100 },
            questions_100: { icon: '', title: 'Century', desc: 'Answered 100 questions!', xp: 200 },
            daily_login_7: { icon: '', title: 'Week Warrior', desc: 'Logged in 7 days in a row!', xp: 150 },
            all_topics: { icon: '', title: 'Explorer', desc: 'Visited all science topics!', xp: 200 },
            speed_demon: { icon: '', title: 'Speed Demon', desc: 'Answered correctly in under 5 seconds!', xp: 75 },
            night_owl: { icon: '', title: 'Night Owl', desc: 'Study after 10 PM!', xp: 50 },
            early_bird: { icon: '', title: 'Early Bird', desc: 'Study before 7 AM!', xp: 50 },
            perfectionist: { icon: '', title: 'Perfectionist', desc: 'Get 100% on a quiz!', xp: 100 }
        };

        let unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements')) || [];

        function triggerAchievement(achievementId) {
            if (unlockedAchievements.includes(achievementId)) return;

            const achievement = achievements[achievementId];
            if (!achievement) return;

            unlockedAchievements.push(achievementId);
            localStorage.setItem('unlockedAchievements', JSON.stringify(unlockedAchievements));

            achievementQueue.push({ id: achievementId, ...achievement });
            processAchievementQueue();
        }

        function processAchievementQueue() {
            if (isShowingAchievement || achievementQueue.length === 0) return;

            isShowingAchievement = true;
            const achievement = achievementQueue.shift();
            showAchievementPopup(achievement);
        }

        function showAchievementPopup(achievement) {
            document.getElementById('achievement-popup-icon').textContent = achievement.icon;
            document.getElementById('achievement-popup-title').textContent = achievement.title;
            document.getElementById('achievement-popup-desc').textContent = achievement.desc;
            document.getElementById('achievement-popup-reward').textContent = '+' + achievement.xp + ' XP';

            document.getElementById('achievement-popup-overlay').classList.add('show');
            document.getElementById('achievement-popup').classList.add('show');

            // Award XP
            const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            localStorage.setItem('scienceXP', currentXP + achievement.xp);

            // Play celebration sound if enabled
            if (typeof playSound === 'function') {
                playSound('levelUp');
            }
        }

        function closeAchievementPopup() {
            document.getElementById('achievement-popup').classList.remove('show');
            document.getElementById('achievement-popup-overlay').classList.remove('show');

            isShowingAchievement = false;

            // Process next achievement after a short delay
            setTimeout(processAchievementQueue, 500);
        }

        // Check for time-based achievements
        function checkTimeAchievements() {
            const hour = new Date().getHours();
            if (hour >= 22 || hour < 5) {
                triggerAchievement('night_owl');
            }
            if (hour >= 5 && hour < 7) {
                triggerAchievement('early_bird');
            }
        }

        // Bonus Event System
        let bonusEventActive = false;
        let bonusEventTimer = null;
        let bonusMultiplier = 1;

        const bonusEvents = [
            { name: 'DOUBLE XP EVENT!', multiplier: 2, duration: 30 * 60, icon: '' },
            { name: 'TRIPLE XP FRENZY!', multiplier: 3, duration: 15 * 60, icon: '' },
            { name: 'XP BONANZA!', multiplier: 5, duration: 5 * 60, icon: '' },
            { name: 'POWER HOUR!', multiplier: 2, duration: 60 * 60, icon: '' }
        ];

        function startBonusEvent(eventIndex = null) {
            if (bonusEventActive) return;

            const eventIdx = eventIndex !== null ? eventIndex : Math.floor(Math.random() * bonusEvents.length);
            const event = bonusEvents[eventIdx];

            bonusEventActive = true;
            bonusMultiplier = event.multiplier;

            const banner = document.getElementById('bonus-event-banner');
            document.getElementById('bonus-event-text').textContent = event.name;
            document.querySelector('.bonus-event-icon').textContent = event.icon;
            banner.style.display = 'block';

            let timeLeft = event.duration;
            updateBonusTimer(timeLeft);

            bonusEventTimer = setInterval(() => {
                timeLeft--;
                updateBonusTimer(timeLeft);

                if (timeLeft <= 0) {
                    endBonusEvent();
                }
            }, 1000);

            localStorage.setItem('bonusEventData', JSON.stringify({
                eventIdx,
                endTime: Date.now() + (event.duration * 1000)
            }));
        }

        function updateBonusTimer(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('bonus-event-timer').textContent =
                mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
        }

        function endBonusEvent() {
            bonusEventActive = false;
            bonusMultiplier = 1;
            clearInterval(bonusEventTimer);
            document.getElementById('bonus-event-banner').style.display = 'none';
            localStorage.removeItem('bonusEventData');
        }

        function closeBonusEvent() {
            document.getElementById('bonus-event-banner').style.display = 'none';
        }

        function getBonusMultiplier() {
            return bonusMultiplier;
        }

        // Random bonus event trigger (5% chance every question)
        function maybeStartBonusEvent() {
            if (!bonusEventActive && Math.random() < 0.05) {
                startBonusEvent();
            }
        }

        // Restore bonus event on page load
        function restoreBonusEvent() {
            const savedData = localStorage.getItem('bonusEventData');
            if (savedData) {
                const { eventIdx, endTime } = JSON.parse(savedData);
                const timeLeft = Math.floor((endTime - Date.now()) / 1000);

                if (timeLeft > 0) {
                    const event = bonusEvents[eventIdx];
                    bonusEventActive = true;
                    bonusMultiplier = event.multiplier;

                    const banner = document.getElementById('bonus-event-banner');
                    document.getElementById('bonus-event-text').textContent = event.name;
                    document.querySelector('.bonus-event-icon').textContent = event.icon;
                    banner.style.display = 'block';

                    let remaining = timeLeft;
                    updateBonusTimer(remaining);

                    bonusEventTimer = setInterval(() => {
                        remaining--;
                        updateBonusTimer(remaining);
                        if (remaining <= 0) endBonusEvent();
                    }, 1000);
                } else {
                    localStorage.removeItem('bonusEventData');
                }
            }
        }

        // Learning Milestones System
        const learningMilestones = [
            { id: 'm1', name: 'First Answer', desc: 'Answer your first question', target: 1, type: 'questions', icon: '', xp: 25 },
            { id: 'm2', name: 'Getting Started', desc: 'Answer 10 questions', target: 10, type: 'questions', icon: '', xp: 50 },
            { id: 'm3', name: 'Dedicated Student', desc: 'Answer 25 questions', target: 25, type: 'questions', icon: '', xp: 75 },
            { id: 'm4', name: 'Knowledge Seeker', desc: 'Answer 50 questions', target: 50, type: 'questions', icon: '', xp: 100 },
            { id: 'm5', name: 'Century Club', desc: 'Answer 100 questions', target: 100, type: 'questions', icon: '', xp: 200 },
            { id: 'm6', name: 'Rising Star', desc: 'Reach Level 5', target: 5, type: 'level', icon: '', xp: 100 },
            { id: 'm7', name: 'Achiever', desc: 'Reach Level 10', target: 10, type: 'level', icon: '', xp: 200 },
            { id: 'm8', name: 'Expert', desc: 'Reach Level 20', target: 20, type: 'level', icon: '', xp: 400 },
            { id: 'm9', name: 'Streak Starter', desc: 'Get a 3-question streak', target: 3, type: 'streak', icon: '', xp: 50 },
            { id: 'm10', name: 'Streak Master', desc: 'Get a 10-question streak', target: 10, type: 'streak', icon: '', xp: 150 },
            { id: 'm11', name: 'XP Hunter', desc: 'Earn 500 XP', target: 500, type: 'xp', icon: '', xp: 75 },
            { id: 'm12', name: 'XP Champion', desc: 'Earn 2000 XP', target: 2000, type: 'xp', icon: '', xp: 150 },
            { id: 'm13', name: 'Topic Explorer', desc: 'Visit 3 different topics', target: 3, type: 'topics', icon: '', xp: 75 },
            { id: 'm14', name: 'World Traveler', desc: 'Visit all 6 topics', target: 6, type: 'topics', icon: '', xp: 150 },
            { id: 'm15', name: 'Early Adopter', desc: 'Use the app for 7 days', target: 7, type: 'days', icon: '', xp: 100 }
        ];

        let completedMilestones = JSON.parse(localStorage.getItem('completedMilestones')) || [];

        function openMilestoneModal() {
            renderMilestones();
            document.getElementById('milestone-modal').style.display = 'flex';
        }

        function closeMilestoneModal() {
            document.getElementById('milestone-modal').style.display = 'none';
        }

        function getMilestoneProgress(milestone) {
            switch (milestone.type) {
                case 'questions':
                    return parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0;
                case 'level':
                    const xp = parseInt(localStorage.getItem('scienceXP')) || 0;
                    return Math.floor(xp / 100) + 1;
                case 'streak':
                    return parseInt(localStorage.getItem('bestStreak')) || 0;
                case 'xp':
                    return parseInt(localStorage.getItem('scienceXP')) || 0;
                case 'topics':
                    return (JSON.parse(localStorage.getItem('topicsVisited')) || []).length;
                case 'days':
                    return parseInt(localStorage.getItem('totalDaysUsed')) || 1;
                default:
                    return 0;
            }
        }

        function renderMilestones() {
            const container = document.getElementById('milestone-list');

            container.innerHTML = learningMilestones.map(milestone => {
                const progress = getMilestoneProgress(milestone);
                const percentage = Math.min((progress / milestone.target) * 100, 100);
                const isComplete = completedMilestones.includes(milestone.id);
                const justCompleted = percentage >= 100 && !isComplete;

                // Auto-complete milestone if reached
                if (justCompleted) {
                    completedMilestones.push(milestone.id);
                    localStorage.setItem('completedMilestones', JSON.stringify(completedMilestones));

                    // Award XP
                    const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
                    localStorage.setItem('scienceXP', currentXP + milestone.xp);
                }

                return `
                    <div class="milestone-item ${isComplete || justCompleted ? 'completed' : ''}">
                        <div class="milestone-badge ${isComplete || justCompleted ? 'earned' : ''}">${milestone.icon}</div>
                        <div class="milestone-info">
                            <div class="milestone-name">${milestone.name}</div>
                            <div class="milestone-desc">${milestone.desc}</div>
                            <div class="milestone-progress">
                                <div class="milestone-progress-bar" style="width: ${percentage}%"></div>
                            </div>
                            <div class="milestone-stats">${Math.min(progress, milestone.target)}/${milestone.target} ${isComplete || justCompleted ? '' : ''}</div>
                        </div>
                        <div class="milestone-reward">+${milestone.xp} XP</div>
                    </div>
                `;
            }).join('');
        }

        function checkMilestones() {
            learningMilestones.forEach(milestone => {
                if (completedMilestones.includes(milestone.id)) return;

                const progress = getMilestoneProgress(milestone);
                if (progress >= milestone.target) {
                    completedMilestones.push(milestone.id);
                    localStorage.setItem('completedMilestones', JSON.stringify(completedMilestones));

                    // Award XP
                    const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
                    localStorage.setItem('scienceXP', currentXP + milestone.xp);

                    // Trigger achievement popup
                    triggerAchievement('questions_' + milestone.target);
                }
            });
        }

        // Track total days used
        function trackDaysUsed() {
            const lastVisit = localStorage.getItem('lastVisitDate');
            const today = new Date().toDateString();

            if (lastVisit !== today) {
                const totalDays = (parseInt(localStorage.getItem('totalDaysUsed')) || 0) + 1;
                localStorage.setItem('totalDaysUsed', totalDays);
                localStorage.setItem('lastVisitDate', today);
            }
        }

        // Initialize Batch 28
        restoreBonusEvent();
        checkTimeAchievements();
        trackDaysUsed();

        // Demo: Start a bonus event for testing (comment out in production)
        // setTimeout(() => startBonusEvent(0), 3000);

        console.log(' Achievement Popups, Bonus Events, and Milestones loaded!');
    </script>

    <!-- ========== BATCH 29: Study Streaks Calendar, Flash Cards, Focus Mode ========== -->

    <!-- Study Streaks Calendar Modal -->
    <div class="streaks-calendar-modal" id="streaks-calendar-modal">
        <div class="streaks-calendar-content">
            <div class="streaks-calendar-header">
                <h2> Study Streaks</h2>
                <p style="color: #666; margin-top: 5px;">Keep your learning momentum going!</p>
            </div>
            <div class="current-streak-display">
                <div class="streak-stat">
                    <span class="streak-stat-value streak-fire-animation" id="current-streak-value">0</span>
                    <span class="streak-stat-label">Current Streak</span>
                </div>
                <div class="streak-stat" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <span class="streak-stat-value" id="best-streak-value">0</span>
                    <span class="streak-stat-label">Best Streak</span>
                </div>
            </div>
            <div class="calendar-month-nav" style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                <button onclick="changeCalendarMonth(-1)" style="border: none; background: #f0f0f0; padding: 8px 15px; border-radius: 20px; cursor: pointer;"></button>
                <span id="calendar-month-display" style="font-weight: 600;"></span>
                <button onclick="changeCalendarMonth(1)" style="border: none; background: #f0f0f0; padding: 8px 15px; border-radius: 20px; cursor: pointer;"></button>
            </div>
            <div class="calendar-grid" id="streaks-calendar-grid">
                <!-- Populated by JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 25px;">
                <button onclick="closeStreaksCalendar()" style="padding: 12px 40px; border: none; background: linear-gradient(135deg, #f5af19 0%, #f12711 100%); border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Flash Cards Modal -->
    <div class="flashcards-modal" id="flashcards-modal">
        <div class="flashcards-content">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="margin: 0;"> Flash Cards</h2>
                <p style="color: #aaa; margin-top: 5px;">Click the card to flip and reveal the answer!</p>
            </div>
            <div class="flashcard-deck-selector" id="flashcard-deck-selector">
                <!-- Populated by JavaScript -->
            </div>
            <div class="flashcard-container">
                <div class="flashcard" id="flashcard" onclick="flipFlashcard()">
                    <div class="flashcard-face flashcard-front">
                        <div class="flashcard-question" id="flashcard-question">Loading...</div>
                        <div class="flashcard-hint" id="flashcard-hint">Click to reveal answer</div>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <div class="flashcard-answer" id="flashcard-answer">Answer</div>
                    </div>
                </div>
            </div>
            <div class="flashcard-nav">
                <button class="flashcard-nav-btn" onclick="previousFlashcard()"> Previous</button>
                <button class="flashcard-nav-btn" onclick="shuffleFlashcards()"> Shuffle</button>
                <button class="flashcard-nav-btn" onclick="nextFlashcard()">Next </button>
            </div>
            <div class="flashcard-progress" id="flashcard-progress">Card 1 of 10</div>
            <button class="flashcard-create-btn" onclick="openFlashcardCreator()"> Create New Flashcard</button>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeFlashcards()" style="padding: 10px 30px; border: none; background: rgba(255,255,255,0.2); border-radius: 20px; color: white; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Focus Mode Overlay -->
    <div class="focus-mode-overlay" id="focus-mode-overlay">
        <button class="focus-exit-btn" onclick="exitFocusMode()"> Exit Focus Mode</button>
        <div class="focus-timer-label" id="focus-timer-label">Focus Session</div>
        <div class="focus-timer-display" id="focus-timer-display">25:00</div>
        <div class="focus-session-type">
            <button class="focus-type-btn active" onclick="setFocusType('focus')" id="focus-type-focus"> Focus (25m)</button>
            <button class="focus-type-btn" onclick="setFocusType('short')" id="focus-type-short"> Short Break (5m)</button>
            <button class="focus-type-btn" onclick="setFocusType('long')" id="focus-type-long"> Long Break (15m)</button>
        </div>
        <div class="focus-controls">
            <button class="focus-control-btn focus-start-btn" onclick="startFocusTimer()" id="focus-start-btn"></button>
            <button class="focus-control-btn focus-pause-btn" onclick="pauseFocusTimer()" id="focus-pause-btn" style="display: none;"></button>
            <button class="focus-control-btn focus-stop-btn" onclick="resetFocusTimer()"></button>
        </div>
        <div class="focus-motivation" id="focus-motivation">
            <div class="focus-motivation-text" id="motivation-text">"The only way to do great work is to love what you do."</div>
            <div class="focus-motivation-author" id="motivation-author">- Steve Jobs</div>
        </div>
        <div class="focus-stats">
            <div class="focus-stat-item">
                <div class="focus-stat-value" id="focus-sessions-today">0</div>
                <div class="focus-stat-label">Sessions Today</div>
            </div>
            <div class="focus-stat-item">
                <div class="focus-stat-value" id="focus-time-today">0m</div>
                <div class="focus-stat-label">Focus Time</div>
            </div>
            <div class="focus-stat-item">
                <div class="focus-stat-value" id="focus-total-sessions">0</div>
                <div class="focus-stat-label">Total Sessions</div>
            </div>
        </div>
    </div>

    <!-- Floating Buttons for Batch 29 -->
    <button class="floating-streaks-btn" onclick="openStreaksCalendar()" title="Study Streaks"></button>
    <button class="floating-flashcards-btn" onclick="openFlashcards()" title="Flash Cards"></button>
    <button class="floating-focus-btn" onclick="enterFocusMode()" title="Focus Mode"></button>

    <script>
        // ========== BATCH 29: Study Streaks Calendar, Flash Cards, Focus Mode ==========

        // Study Streaks Calendar
        let studyDays = JSON.parse(localStorage.getItem('studyDays')) || [];
        let currentCalendarMonth = new Date();

        function openStreaksCalendar() {
            currentCalendarMonth = new Date();
            renderStreaksCalendar();
            updateStreakStats();
            document.getElementById('streaks-calendar-modal').style.display = 'flex';
        }

        function closeStreaksCalendar() {
            document.getElementById('streaks-calendar-modal').style.display = 'none';
        }

        function recordStudyDay() {
            const today = new Date().toDateString();
            if (!studyDays.includes(today)) {
                studyDays.push(today);
                localStorage.setItem('studyDays', JSON.stringify(studyDays));
                updateStreakStats();
            }
        }

        function calculateCurrentStreak() {
            let streak = 0;
            const today = new Date();

            for (let i = 0; i <= 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateStr = checkDate.toDateString();

                if (studyDays.includes(dateStr)) {
                    streak++;
                } else if (i > 0) {
                    break;
                }
            }
            return streak;
        }

        function calculateBestStreak() {
            if (studyDays.length === 0) return 0;

            const sortedDays = studyDays
                .map(d => new Date(d).getTime())
                .sort((a, b) => a - b);

            let bestStreak = 1;
            let currentStreak = 1;

            for (let i = 1; i < sortedDays.length; i++) {
                const diff = (sortedDays[i] - sortedDays[i-1]) / (1000 * 60 * 60 * 24);
                if (diff === 1) {
                    currentStreak++;
                    bestStreak = Math.max(bestStreak, currentStreak);
                } else if (diff > 1) {
                    currentStreak = 1;
                }
            }
            return bestStreak;
        }

        function updateStreakStats() {
            const currentStreak = calculateCurrentStreak();
            const bestStreak = calculateBestStreak();

            document.getElementById('current-streak-value').textContent = currentStreak;
            document.getElementById('best-streak-value').textContent = bestStreak;

            localStorage.setItem('bestStreak', Math.max(bestStreak, parseInt(localStorage.getItem('bestStreak')) || 0));
        }

        function changeCalendarMonth(delta) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + delta);
            renderStreaksCalendar();
        }

        function renderStreaksCalendar() {
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month-display').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date().toDateString();

            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let html = dayHeaders.map(d => `<div class="calendar-day-header">${d}</div>`).join('');

            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toDateString();
                const isStudied = studyDays.includes(dateStr);
                const isToday = dateStr === today;

                html += `<div class="calendar-day ${isStudied ? 'studied' : ''} ${isToday ? 'today' : ''}">${day}</div>`;
            }

            document.getElementById('streaks-calendar-grid').innerHTML = html;
        }

        // Flash Cards System
        const defaultFlashcardDecks = {
            physics: [
                { q: 'What is the SI unit of force?', a: 'Newton (N)' },
                { q: 'What is the formula for speed?', a: 'Speed = Distance / Time' },
                { q: 'What type of energy does a moving object have?', a: 'Kinetic Energy' },
                { q: 'What is the force that opposes motion?', a: 'Friction' },
                { q: 'What do we call the energy stored in a stretched spring?', a: 'Elastic Potential Energy' }
            ],
            chemistry: [
                { q: 'What is the chemical symbol for water?', a: 'HO' },
                { q: 'What gas do plants release during photosynthesis?', a: 'Oxygen (O)' },
                { q: 'What is the pH of a neutral solution?', a: '7' },
                { q: 'What is the atomic number of Carbon?', a: '6' },
                { q: 'What type of reaction releases heat?', a: 'Exothermic Reaction' }
            ],
            biology: [
                { q: 'What is the powerhouse of the cell?', a: 'Mitochondria' },
                { q: 'What is the largest organ in the human body?', a: 'Skin' },
                { q: 'What carries oxygen in the blood?', a: 'Red Blood Cells (Hemoglobin)' },
                { q: 'What process do plants use to make food?', a: 'Photosynthesis' },
                { q: 'What is the basic unit of life?', a: 'Cell' }
            ],
            earth: [
                { q: 'What are the three types of rocks?', a: 'Igneous, Sedimentary, Metamorphic' },
                { q: 'What causes earthquakes?', a: 'Movement of Tectonic Plates' },
                { q: 'What layer of the atmosphere do we live in?', a: 'Troposphere' },
                { q: 'What percentage of Earth is covered by water?', a: 'About 71%' },
                { q: 'What is the molten rock inside Earth called?', a: 'Magma' }
            ]
        };

        let customFlashcards = JSON.parse(localStorage.getItem('customFlashcards')) || [];
        let currentDeck = 'physics';
        let currentFlashcardIndex = 0;
        let isFlashcardFlipped = false;

        function openFlashcards() {
            renderDeckSelector();
            loadFlashcard();
            document.getElementById('flashcards-modal').style.display = 'flex';
        }

        function closeFlashcards() {
            document.getElementById('flashcards-modal').style.display = 'none';
        }

        function renderDeckSelector() {
            const decks = [
                { id: 'physics', name: ' Physics' },
                { id: 'chemistry', name: ' Chemistry' },
                { id: 'biology', name: ' Biology' },
                { id: 'earth', name: ' Earth' },
                { id: 'custom', name: ' My Cards' }
            ];

            document.getElementById('flashcard-deck-selector').innerHTML = decks.map(deck => `
                <button class="flashcard-deck-btn ${currentDeck === deck.id ? 'active' : ''}"
                        onclick="selectDeck('${deck.id}')">${deck.name}</button>
            `).join('');
        }

        function selectDeck(deckId) {
            currentDeck = deckId;
            currentFlashcardIndex = 0;
            isFlashcardFlipped = false;
            renderDeckSelector();
            loadFlashcard();
        }

        function getCurrentDeckCards() {
            if (currentDeck === 'custom') {
                return customFlashcards.length > 0 ? customFlashcards : [{ q: 'No custom cards yet!', a: 'Click "Create New Flashcard" to add some' }];
            }
            return defaultFlashcardDecks[currentDeck] || [];
        }

        function loadFlashcard() {
            const cards = getCurrentDeckCards();
            const card = cards[currentFlashcardIndex];

            document.getElementById('flashcard').classList.remove('flipped');
            isFlashcardFlipped = false;

            document.getElementById('flashcard-question').textContent = card.q;
            document.getElementById('flashcard-answer').textContent = card.a;
            document.getElementById('flashcard-progress').textContent = `Card ${currentFlashcardIndex + 1} of ${cards.length}`;
        }

        function flipFlashcard() {
            isFlashcardFlipped = !isFlashcardFlipped;
            document.getElementById('flashcard').classList.toggle('flipped');
        }

        function previousFlashcard() {
            const cards = getCurrentDeckCards();
            currentFlashcardIndex = (currentFlashcardIndex - 1 + cards.length) % cards.length;
            loadFlashcard();
        }

        function nextFlashcard() {
            const cards = getCurrentDeckCards();
            currentFlashcardIndex = (currentFlashcardIndex + 1) % cards.length;
            loadFlashcard();
        }

        function shuffleFlashcards() {
            const cards = getCurrentDeckCards();
            currentFlashcardIndex = Math.floor(Math.random() * cards.length);
            loadFlashcard();
        }

        function openFlashcardCreator() {
            const question = prompt('Enter your question:');
            if (!question) return;

            const answer = prompt('Enter the answer:');
            if (!answer) return;

            customFlashcards.push({ q: question, a: answer });
            localStorage.setItem('customFlashcards', JSON.stringify(customFlashcards));

            selectDeck('custom');
            currentFlashcardIndex = customFlashcards.length - 1;
            loadFlashcard();

            alert('Flashcard created successfully!');
        }

        // Focus Mode (Pomodoro Timer)
        const focusDurations = {
            focus: 25 * 60,
            short: 5 * 60,
            long: 15 * 60
        };

        const motivationalQuotes = [
            { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
            { text: "Science is a way of thinking much more than it is a body of knowledge.", author: "Carl Sagan" },
            { text: "The important thing is not to stop questioning.", author: "Albert Einstein" },
            { text: "Nothing in life is to be feared, it is only to be understood.", author: "Marie Curie" },
            { text: "Research is creating new knowledge.", author: "Neil Armstrong" },
            { text: "The good thing about science is that it's true whether you believe it or not.", author: "Neil deGrasse Tyson" },
            { text: "Education is the most powerful weapon which you can use to change the world.", author: "Nelson Mandela" },
            { text: "In the middle of difficulty lies opportunity.", author: "Albert Einstein" }
        ];

        let focusType = 'focus';
        let focusTimeLeft = focusDurations.focus;
        let focusTimerInterval = null;
        let focusRunning = false;

        function enterFocusMode() {
            document.getElementById('focus-mode-overlay').classList.add('active');
            updateFocusStats();
            showRandomMotivation();
        }

        function exitFocusMode() {
            if (focusRunning) {
                if (!confirm('Timer is running! Are you sure you want to exit?')) return;
                pauseFocusTimer();
            }
            document.getElementById('focus-mode-overlay').classList.remove('active');
        }

        function setFocusType(type) {
            if (focusRunning) {
                if (!confirm('This will reset your current timer. Continue?')) return;
                pauseFocusTimer();
            }

            focusType = type;
            focusTimeLeft = focusDurations[type];
            updateFocusDisplay();

            document.querySelectorAll('.focus-type-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`focus-type-${type}`).classList.add('active');

            const labels = { focus: 'Focus Session', short: 'Short Break', long: 'Long Break' };
            document.getElementById('focus-timer-label').textContent = labels[type];
        }

        function updateFocusDisplay() {
            const mins = Math.floor(focusTimeLeft / 60);
            const secs = focusTimeLeft % 60;
            document.getElementById('focus-timer-display').textContent =
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function startFocusTimer() {
            if (focusRunning) return;

            focusRunning = true;
            document.getElementById('focus-start-btn').style.display = 'none';
            document.getElementById('focus-pause-btn').style.display = 'block';

            focusTimerInterval = setInterval(() => {
                focusTimeLeft--;
                updateFocusDisplay();

                if (focusTimeLeft <= 0) {
                    completeFocusSession();
                }
            }, 1000);
        }

        function pauseFocusTimer() {
            focusRunning = false;
            clearInterval(focusTimerInterval);
            document.getElementById('focus-start-btn').style.display = 'block';
            document.getElementById('focus-pause-btn').style.display = 'none';
        }

        function resetFocusTimer() {
            pauseFocusTimer();
            focusTimeLeft = focusDurations[focusType];
            updateFocusDisplay();
        }

        function completeFocusSession() {
            pauseFocusTimer();

            if (focusType === 'focus') {
                // Record completed focus session
                const today = new Date().toDateString();
                let focusStats = JSON.parse(localStorage.getItem('focusStats')) || {};

                if (!focusStats[today]) {
                    focusStats[today] = { sessions: 0, minutes: 0 };
                }
                focusStats[today].sessions++;
                focusStats[today].minutes += 25;

                const totalSessions = (parseInt(localStorage.getItem('totalFocusSessions')) || 0) + 1;
                localStorage.setItem('totalFocusSessions', totalSessions);
                localStorage.setItem('focusStats', JSON.stringify(focusStats));

                // Award XP for completing focus session
                const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
                localStorage.setItem('scienceXP', currentXP + 50);

                alert(' Focus session complete! You earned 50 XP!');

                // Suggest break
                if (confirm('Great work! Take a short break?')) {
                    setFocusType('short');
                }
            } else {
                alert('Break time is over! Ready for another focus session?');
                setFocusType('focus');
            }

            updateFocusStats();
            showRandomMotivation();
            resetFocusTimer();
        }

        function updateFocusStats() {
            const today = new Date().toDateString();
            const focusStats = JSON.parse(localStorage.getItem('focusStats')) || {};
            const todayStats = focusStats[today] || { sessions: 0, minutes: 0 };
            const totalSessions = parseInt(localStorage.getItem('totalFocusSessions')) || 0;

            document.getElementById('focus-sessions-today').textContent = todayStats.sessions;
            document.getElementById('focus-time-today').textContent = todayStats.minutes + 'm';
            document.getElementById('focus-total-sessions').textContent = totalSessions;
        }

        function showRandomMotivation() {
            const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
            document.getElementById('motivation-text').textContent = `"${quote.text}"`;
            document.getElementById('motivation-author').textContent = `- ${quote.author}`;
        }

        // Auto-record study day on load
        recordStudyDay();

        // Keyboard shortcut for focus mode (Ctrl+Shift+F)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'F') {
                e.preventDefault();
                const overlay = document.getElementById('focus-mode-overlay');
                if (overlay.classList.contains('active')) {
                    exitFocusMode();
                } else {
                    enterFocusMode();
                }
            }
        });

        console.log(' Study Streaks, Flash Cards, and Focus Mode loaded!');
    </script>

    <!-- ========== BATCH 30: Science Dictionary, Quiz Generator, Progress Charts ========== -->

    <!-- Science Dictionary Modal -->
    <div class="dictionary-modal" id="dictionary-modal">
        <div class="dictionary-content">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="margin: 0;"> Science Dictionary</h2>
                <p style="color: #666; margin-top: 5px;">Look up science terms and definitions</p>
            </div>
            <input type="text" class="dictionary-search" id="dictionary-search" placeholder=" Search for a term..." oninput="searchDictionary()">
            <div class="dictionary-categories" id="dictionary-categories">
                <!-- Populated by JavaScript -->
            </div>
            <div class="dictionary-results" id="dictionary-results">
                <!-- Populated by JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeDictionary()" style="padding: 12px 40px; border: none; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Quiz Generator Modal -->
    <div class="quiz-generator-modal" id="quiz-generator-modal">
        <div class="quiz-generator-content">
            <div class="quiz-setup" id="quiz-setup">
                <h2 style="margin: 0 0 10px;"> Quiz Generator</h2>
                <p style="color: #aaa;">Create a custom quiz to test your knowledge!</p>

                <div class="quiz-topic-grid" id="quiz-topic-grid">
                    <!-- Populated by JavaScript -->
                </div>

                <div class="quiz-settings">
                    <div class="quiz-setting-row">
                        <span class="quiz-setting-label">Number of Questions</span>
                        <select class="quiz-setting-select" id="quiz-num-questions">
                            <option value="5">5 Questions</option>
                            <option value="10" selected>10 Questions</option>
                            <option value="15">15 Questions</option>
                            <option value="20">20 Questions</option>
                        </select>
                    </div>
                    <div class="quiz-setting-row">
                        <span class="quiz-setting-label">Difficulty</span>
                        <select class="quiz-setting-select" id="quiz-difficulty">
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                </div>

                <button class="quiz-start-btn" onclick="startGeneratedQuiz()"> Start Quiz</button>
            </div>

            <div class="quiz-question-container" id="quiz-question-container">
                <div class="quiz-progress-bar">
                    <div class="quiz-progress-fill" id="quiz-progress-fill" style="width: 0%"></div>
                </div>
                <div class="quiz-question-number" id="quiz-question-number" style="text-align: center; color: #aaa; margin-bottom: 10px;">Question 1 of 10</div>
                <div class="quiz-question-text" id="quiz-question-text">Loading question...</div>
                <div class="quiz-options" id="quiz-options">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="quiz-results" id="quiz-results">
                <h2>Quiz Complete!</h2>
                <div class="quiz-score-circle">
                    <span class="quiz-score-value" id="quiz-score-value">0%</span>
                    <span class="quiz-score-label">Score</span>
                </div>
                <p id="quiz-result-message" style="color: #aaa; margin-bottom: 20px;"></p>
                <p id="quiz-xp-earned" style="color: #4CAF50; font-weight: 600; margin-bottom: 25px;"></p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="restartQuizGenerator()" style="padding: 12px 30px; border: none; background: rgba(255,255,255,0.2); border-radius: 25px; color: white; cursor: pointer;">Try Again</button>
                    <button onclick="closeQuizGenerator()" style="padding: 12px 30px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 25px; color: white; cursor: pointer;">Done</button>
                </div>
            </div>

            <button onclick="closeQuizGenerator()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;"></button>
        </div>
    </div>

    <!-- Progress Charts Modal -->
    <div class="charts-modal" id="charts-modal">
        <div class="charts-content">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="margin: 0;"> Progress Charts</h2>
                <p style="color: #666; margin-top: 5px;">Track your learning journey!</p>
            </div>

            <div class="charts-tabs">
                <button class="chart-tab active" onclick="switchChartTab('xp')">XP Progress</button>
                <button class="chart-tab" onclick="switchChartTab('questions')">Questions</button>
                <button class="chart-tab" onclick="switchChartTab('overview')">Overview</button>
            </div>

            <div id="chart-xp" class="chart-panel">
                <div class="chart-container">
                    <div class="chart-title"> Weekly XP Progress</div>
                    <div class="bar-chart" id="xp-bar-chart">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div id="chart-questions" class="chart-panel" style="display: none;">
                <div class="chart-container">
                    <div class="chart-title"> Questions Answered Per Day</div>
                    <div class="bar-chart" id="questions-bar-chart">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div id="chart-overview" class="chart-panel" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-value" id="overview-total-xp">0</div>
                        <div class="stat-card-label">Total XP</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                        <div class="stat-card-value" id="overview-level">1</div>
                        <div class="stat-card-label">Current Level</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);">
                        <div class="stat-card-value" id="overview-questions">0</div>
                        <div class="stat-card-label">Total Questions</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);">
                        <div class="stat-card-value" id="overview-streak">0</div>
                        <div class="stat-card-label">Best Streak</div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 25px;">
                <button onclick="closeCharts()" style="padding: 12px 40px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Floating Buttons for Batch 30 -->
    <button class="floating-dictionary-btn" onclick="openDictionary()" title="Science Dictionary"></button>
    <button class="floating-quiz-btn" onclick="openQuizGenerator()" title="Quiz Generator"></button>
    <button class="floating-charts-btn" onclick="openCharts()" title="Progress Charts"></button>

    <script>
        // ========== BATCH 30: Science Dictionary, Quiz Generator, Progress Charts ==========

        // Science Dictionary
        const scienceDictionary = [
            // Physics
            { term: 'Force', definition: 'A push or pull that can change the motion of an object. Measured in Newtons (N).', category: 'physics' },
            { term: 'Energy', definition: 'The ability to do work. It can exist in many forms like kinetic, potential, thermal, etc.', category: 'physics' },
            { term: 'Gravity', definition: 'The force that attracts objects with mass toward each other. On Earth, it pulls objects toward the center.', category: 'physics' },
            { term: 'Friction', definition: 'A force that opposes motion between two surfaces in contact.', category: 'physics' },
            { term: 'Mass', definition: 'The amount of matter in an object. Measured in kilograms (kg).', category: 'physics' },
            { term: 'Velocity', definition: 'The speed of an object in a specific direction.', category: 'physics' },
            { term: 'Acceleration', definition: 'The rate of change of velocity over time.', category: 'physics' },
            // Chemistry
            { term: 'Atom', definition: 'The smallest unit of matter that retains the properties of an element.', category: 'chemistry' },
            { term: 'Molecule', definition: 'Two or more atoms bonded together. Example: HO (water).', category: 'chemistry' },
            { term: 'Element', definition: 'A pure substance made of only one type of atom. Examples: Gold, Oxygen.', category: 'chemistry' },
            { term: 'Compound', definition: 'A substance made of two or more different elements chemically combined.', category: 'chemistry' },
            { term: 'Chemical Reaction', definition: 'A process where substances change into new substances with different properties.', category: 'chemistry' },
            { term: 'pH', definition: 'A scale (0-14) measuring how acidic or basic a solution is. 7 is neutral.', category: 'chemistry' },
            { term: 'Oxidation', definition: 'A chemical reaction involving the loss of electrons or gain of oxygen.', category: 'chemistry' },
            // Biology
            { term: 'Cell', definition: 'The basic unit of life. All living things are made of cells.', category: 'biology' },
            { term: 'Photosynthesis', definition: 'The process plants use to convert sunlight, water, and CO into glucose and oxygen.', category: 'biology' },
            { term: 'Respiration', definition: 'The process of breaking down glucose to release energy for cells.', category: 'biology' },
            { term: 'DNA', definition: 'Deoxyribonucleic acid - the molecule that carries genetic information.', category: 'biology' },
            { term: 'Mitochondria', definition: 'The powerhouse of the cell - produces energy (ATP) through cellular respiration.', category: 'biology' },
            { term: 'Nucleus', definition: 'The control center of a cell containing DNA.', category: 'biology' },
            { term: 'Chloroplast', definition: 'Organelle in plant cells where photosynthesis takes place.', category: 'biology' },
            // Earth Science
            { term: 'Tectonic Plates', definition: 'Large pieces of Earth\'s crust that float on the mantle and cause earthquakes.', category: 'earth' },
            { term: 'Rock Cycle', definition: 'The continuous process of rocks changing from one type to another.', category: 'earth' },
            { term: 'Erosion', definition: 'The wearing away and movement of rock and soil by water, wind, or ice.', category: 'earth' },
            { term: 'Atmosphere', definition: 'The layer of gases surrounding Earth, held by gravity.', category: 'earth' },
            { term: 'Water Cycle', definition: 'The continuous movement of water between Earth\'s surface and atmosphere.', category: 'earth' },
            { term: 'Magma', definition: 'Molten rock found beneath Earth\'s surface.', category: 'earth' }
        ];

        let dictionaryCategory = 'all';

        function openDictionary() {
            renderDictionaryCategories();
            renderDictionaryTerms();
            document.getElementById('dictionary-modal').style.display = 'flex';
            document.getElementById('dictionary-search').value = '';
        }

        function closeDictionary() {
            document.getElementById('dictionary-modal').style.display = 'none';
        }

        function renderDictionaryCategories() {
            const categories = [
                { id: 'all', name: 'All', icon: '' },
                { id: 'physics', name: 'Physics', icon: '' },
                { id: 'chemistry', name: 'Chemistry', icon: '' },
                { id: 'biology', name: 'Biology', icon: '' },
                { id: 'earth', name: 'Earth', icon: '' }
            ];

            document.getElementById('dictionary-categories').innerHTML = categories.map(cat => `
                <button class="dictionary-category-btn ${dictionaryCategory === cat.id ? 'active' : ''}"
                        onclick="filterDictionaryCategory('${cat.id}')">${cat.icon} ${cat.name}</button>
            `).join('');
        }

        function filterDictionaryCategory(category) {
            dictionaryCategory = category;
            renderDictionaryCategories();
            renderDictionaryTerms();
        }

        function searchDictionary() {
            renderDictionaryTerms();
        }

        function renderDictionaryTerms() {
            const searchTerm = document.getElementById('dictionary-search').value.toLowerCase();
            const categoryIcons = { physics: '', chemistry: '', biology: '', earth: '' };

            let filtered = scienceDictionary;

            if (dictionaryCategory !== 'all') {
                filtered = filtered.filter(t => t.category === dictionaryCategory);
            }

            if (searchTerm) {
                filtered = filtered.filter(t =>
                    t.term.toLowerCase().includes(searchTerm) ||
                    t.definition.toLowerCase().includes(searchTerm)
                );
            }

            if (filtered.length === 0) {
                document.getElementById('dictionary-results').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                        <p>No terms found. Try a different search!</p>
                    </div>
                `;
                return;
            }

            document.getElementById('dictionary-results').innerHTML = filtered.map(term => `
                <div class="dictionary-term">
                    <div class="dictionary-term-word">
                        ${term.term}
                        <span class="dictionary-term-category">${categoryIcons[term.category]} ${term.category}</span>
                    </div>
                    <div class="dictionary-term-definition">${term.definition}</div>
                </div>
            `).join('');
        }

        // Quiz Generator
        const quizQuestionBank = {
            physics: [
                { q: 'What is the SI unit of force?', o: ['Newton', 'Joule', 'Watt', 'Pascal'], a: 0 },
                { q: 'What type of energy does a moving car have?', o: ['Potential', 'Kinetic', 'Thermal', 'Chemical'], a: 1 },
                { q: 'What force keeps planets in orbit around the Sun?', o: ['Friction', 'Magnetism', 'Gravity', 'Tension'], a: 2 },
                { q: 'Speed with direction is called...', o: ['Acceleration', 'Velocity', 'Force', 'Momentum'], a: 1 },
                { q: 'What is the formula for calculating speed?', o: ['Force  Time', 'Distance  Time', 'Mass  Acceleration', 'Energy  Power'], a: 1 },
                { q: 'Which surface has the most friction?', o: ['Ice', 'Sandpaper', 'Glass', 'Metal'], a: 1 },
                { q: 'What happens to speed when you apply more force?', o: ['Decreases', 'Stays same', 'Increases', 'Becomes zero'], a: 2 }
            ],
            chemistry: [
                { q: 'What is the chemical formula for water?', o: ['H2O', 'CO2', 'NaCl', 'O2'], a: 0 },
                { q: 'Which gas do we breathe in?', o: ['Carbon Dioxide', 'Nitrogen', 'Oxygen', 'Hydrogen'], a: 2 },
                { q: 'What pH value is neutral?', o: ['0', '7', '14', '10'], a: 1 },
                { q: 'What is the atomic number of Carbon?', o: ['4', '6', '8', '12'], a: 1 },
                { q: 'Which of these is a compound?', o: ['Oxygen', 'Gold', 'Water', 'Iron'], a: 2 },
                { q: 'Rusting is an example of...', o: ['Physical change', 'Chemical change', 'No change', 'State change'], a: 1 },
                { q: 'What type of reaction releases heat?', o: ['Endothermic', 'Exothermic', 'Neutral', 'Catalytic'], a: 1 }
            ],
            biology: [
                { q: 'What is the powerhouse of the cell?', o: ['Nucleus', 'Ribosome', 'Mitochondria', 'Golgi Body'], a: 2 },
                { q: 'Which organ pumps blood?', o: ['Lungs', 'Liver', 'Heart', 'Kidney'], a: 2 },
                { q: 'What gas do plants release during photosynthesis?', o: ['CO2', 'Nitrogen', 'Oxygen', 'Hydrogen'], a: 2 },
                { q: 'What carries genetic information?', o: ['RNA', 'DNA', 'Proteins', 'Lipids'], a: 1 },
                { q: 'Where does photosynthesis occur in plants?', o: ['Mitochondria', 'Nucleus', 'Chloroplast', 'Vacuole'], a: 2 },
                { q: 'What is the largest organ in the human body?', o: ['Heart', 'Brain', 'Liver', 'Skin'], a: 3 },
                { q: 'What do red blood cells carry?', o: ['Nutrients', 'Oxygen', 'Water', 'Hormones'], a: 1 }
            ],
            earth: [
                { q: 'What causes earthquakes?', o: ['Wind', 'Tectonic plates', 'Waves', 'Gravity'], a: 1 },
                { q: 'What percentage of Earth is water?', o: ['50%', '60%', '71%', '80%'], a: 2 },
                { q: 'Which layer of Earth is molten?', o: ['Crust', 'Inner Core', 'Outer Core', 'Mantle'], a: 2 },
                { q: 'What type of rock is formed from lava?', o: ['Sedimentary', 'Metamorphic', 'Igneous', 'Limestone'], a: 2 },
                { q: 'What layer of atmosphere do we live in?', o: ['Stratosphere', 'Troposphere', 'Mesosphere', 'Thermosphere'], a: 1 },
                { q: 'What is magma called when it reaches the surface?', o: ['Rock', 'Lava', 'Stone', 'Mineral'], a: 1 },
                { q: 'What drives the water cycle?', o: ['Moon', 'Wind', 'Sun', 'Gravity'], a: 2 }
            ],
            mixed: []
        };

        // Combine all for mixed quizzes
        quizQuestionBank.mixed = [
            ...quizQuestionBank.physics,
            ...quizQuestionBank.chemistry,
            ...quizQuestionBank.biology,
            ...quizQuestionBank.earth
        ];

        let selectedQuizTopic = 'mixed';
        let quizQuestions = [];
        let currentQuizQuestion = 0;
        let quizScore = 0;

        function openQuizGenerator() {
            renderQuizTopics();
            document.getElementById('quiz-setup').style.display = 'block';
            document.getElementById('quiz-question-container').style.display = 'none';
            document.getElementById('quiz-results').style.display = 'none';
            document.getElementById('quiz-generator-modal').style.display = 'flex';
        }

        function closeQuizGenerator() {
            document.getElementById('quiz-generator-modal').style.display = 'none';
        }

        function renderQuizTopics() {
            const topics = [
                { id: 'mixed', name: 'Mixed', icon: '' },
                { id: 'physics', name: 'Physics', icon: '' },
                { id: 'chemistry', name: 'Chemistry', icon: '' },
                { id: 'biology', name: 'Biology', icon: '' },
                { id: 'earth', name: 'Earth', icon: '' }
            ];

            document.getElementById('quiz-topic-grid').innerHTML = topics.map(topic => `
                <div class="quiz-topic-card ${selectedQuizTopic === topic.id ? 'selected' : ''}"
                     onclick="selectQuizTopic('${topic.id}')">
                    <span class="quiz-topic-icon">${topic.icon}</span>
                    <span>${topic.name}</span>
                </div>
            `).join('');
        }

        function selectQuizTopic(topic) {
            selectedQuizTopic = topic;
            renderQuizTopics();
        }

        function startGeneratedQuiz() {
            const numQuestions = parseInt(document.getElementById('quiz-num-questions').value);
            const allQuestions = [...quizQuestionBank[selectedQuizTopic]];

            // Shuffle and select questions
            quizQuestions = allQuestions
                .sort(() => Math.random() - 0.5)
                .slice(0, Math.min(numQuestions, allQuestions.length));

            currentQuizQuestion = 0;
            quizScore = 0;

            document.getElementById('quiz-setup').style.display = 'none';
            document.getElementById('quiz-question-container').style.display = 'block';
            document.getElementById('quiz-results').style.display = 'none';

            showQuizQuestion();
        }

        function showQuizQuestion() {
            if (currentQuizQuestion >= quizQuestions.length) {
                showQuizResults();
                return;
            }

            const question = quizQuestions[currentQuizQuestion];
            const progress = ((currentQuizQuestion) / quizQuestions.length) * 100;

            document.getElementById('quiz-progress-fill').style.width = progress + '%';
            document.getElementById('quiz-question-number').textContent = `Question ${currentQuizQuestion + 1} of ${quizQuestions.length}`;
            document.getElementById('quiz-question-text').textContent = question.q;

            const letters = ['A', 'B', 'C', 'D'];
            document.getElementById('quiz-options').innerHTML = question.o.map((opt, i) => `
                <div class="quiz-option" onclick="answerQuizQuestion(${i}, ${question.a})">
                    <span class="quiz-option-letter">${letters[i]}</span>
                    <span>${opt}</span>
                </div>
            `).join('');
        }

        function answerQuizQuestion(selected, correct) {
            const options = document.querySelectorAll('.quiz-option');
            options.forEach((opt, i) => {
                opt.onclick = null;
                if (i === correct) {
                    opt.classList.add('correct');
                } else if (i === selected && selected !== correct) {
                    opt.classList.add('incorrect');
                }
            });

            if (selected === correct) {
                quizScore++;
            }

            setTimeout(() => {
                currentQuizQuestion++;
                showQuizQuestion();
            }, 1000);
        }

        function showQuizResults() {
            const percentage = Math.round((quizScore / quizQuestions.length) * 100);
            const xpEarned = quizScore * 10;

            document.getElementById('quiz-question-container').style.display = 'none';
            document.getElementById('quiz-results').style.display = 'block';

            document.getElementById('quiz-score-value').textContent = percentage + '%';

            let message = '';
            if (percentage === 100) message = 'Perfect! You\'re a science genius!';
            else if (percentage >= 80) message = 'Excellent work! Keep it up!';
            else if (percentage >= 60) message = 'Good job! Room for improvement!';
            else if (percentage >= 40) message = 'Nice try! Keep practicing!';
            else message = 'Keep studying! You\'ll get better!';

            document.getElementById('quiz-result-message').textContent = message;
            document.getElementById('quiz-xp-earned').textContent = `+${xpEarned} XP earned!`;

            // Award XP
            const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            localStorage.setItem('scienceXP', currentXP + xpEarned);

            // Track questions answered
            const totalQuestions = (parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0) + quizQuestions.length;
            localStorage.setItem('totalQuestionsAnswered', totalQuestions);
        }

        function restartQuizGenerator() {
            document.getElementById('quiz-setup').style.display = 'block';
            document.getElementById('quiz-question-container').style.display = 'none';
            document.getElementById('quiz-results').style.display = 'none';
        }

        // Progress Charts
        function openCharts() {
            renderCharts();
            document.getElementById('charts-modal').style.display = 'flex';
        }

        function closeCharts() {
            document.getElementById('charts-modal').style.display = 'none';
        }

        function switchChartTab(tab) {
            document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.chart-panel').forEach(p => p.style.display = 'none');

            event.target.classList.add('active');
            document.getElementById('chart-' + tab).style.display = 'block';
        }

        function renderCharts() {
            renderXPChart();
            renderQuestionsChart();
            renderOverview();
        }

        function renderXPChart() {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const today = new Date().getDay();
            const xpHistory = JSON.parse(localStorage.getItem('xpHistory')) || {};

            // Generate last 7 days data
            const data = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                const dayName = days[date.getDay()];
                data.push({
                    label: dayName,
                    value: xpHistory[dateStr] || 0
                });
            }

            const maxValue = Math.max(...data.map(d => d.value), 100);

            document.getElementById('xp-bar-chart').innerHTML = data.map(d => {
                const height = maxValue > 0 ? (d.value / maxValue) * 150 : 0;
                return `
                    <div class="bar-item">
                        <div class="bar-value">${d.value}</div>
                        <div class="bar" style="height: ${height}px;"></div>
                        <div class="bar-label">${d.label}</div>
                    </div>
                `;
            }).join('');
        }

        function renderQuestionsChart() {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const questionsHistory = JSON.parse(localStorage.getItem('questionsHistory')) || {};

            const data = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                const dayName = days[date.getDay()];
                data.push({
                    label: dayName,
                    value: questionsHistory[dateStr] || 0
                });
            }

            const maxValue = Math.max(...data.map(d => d.value), 10);

            document.getElementById('questions-bar-chart').innerHTML = data.map(d => {
                const height = maxValue > 0 ? (d.value / maxValue) * 150 : 0;
                return `
                    <div class="bar-item">
                        <div class="bar-value">${d.value}</div>
                        <div class="bar" style="height: ${height}px; background: linear-gradient(180deg, #11998e 0%, #38ef7d 100%);"></div>
                        <div class="bar-label">${d.label}</div>
                    </div>
                `;
            }).join('');
        }

        function renderOverview() {
            const totalXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            const level = Math.floor(totalXP / 100) + 1;
            const totalQuestions = parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0;
            const bestStreak = parseInt(localStorage.getItem('bestStreak')) || 0;

            document.getElementById('overview-total-xp').textContent = totalXP;
            document.getElementById('overview-level').textContent = level;
            document.getElementById('overview-questions').textContent = totalQuestions;
            document.getElementById('overview-streak').textContent = bestStreak;
        }

        // Record XP and questions for charts
        function recordDailyXP(amount) {
            const today = new Date().toDateString();
            const xpHistory = JSON.parse(localStorage.getItem('xpHistory')) || {};
            xpHistory[today] = (xpHistory[today] || 0) + amount;
            localStorage.setItem('xpHistory', JSON.stringify(xpHistory));
        }

        function recordDailyQuestion() {
            const today = new Date().toDateString();
            const questionsHistory = JSON.parse(localStorage.getItem('questionsHistory')) || {};
            questionsHistory[today] = (questionsHistory[today] || 0) + 1;
            localStorage.setItem('questionsHistory', JSON.stringify(questionsHistory));
        }

        console.log(' Science Dictionary, Quiz Generator, and Progress Charts loaded!');
    </script>

    <!-- ========== BATCH 31: Daily Science Facts, Study Goals, Wrong Answer Review ========== -->

    <!-- Daily Science Fact Banner -->
    <div class="science-fact-banner" id="science-fact-banner">
        <button class="science-fact-close" onclick="closeScienceFact()"></button>
        <div class="science-fact-header">
            <span class="science-fact-icon"></span>
            <span class="science-fact-title">Did You Know?</span>
        </div>
        <div class="science-fact-text" id="science-fact-text">Loading fact...</div>
        <span class="science-fact-category" id="science-fact-category">Science</span>
    </div>

    <!-- Study Goals Modal -->
    <div class="goals-modal" id="goals-modal">
        <div class="goals-content">
            <div class="goals-header">
                <h2 style="margin: 0;"> Study Goals</h2>
                <p style="color: #666; margin-top: 5px;">Set and track your learning targets!</p>
            </div>
            <div class="goals-summary">
                <div class="goal-summary-card">
                    <div class="goal-summary-value" id="goals-completed">0</div>
                    <div class="goal-summary-label">Completed</div>
                </div>
                <div class="goal-summary-card">
                    <div class="goal-summary-value" id="goals-active" style="color: #11998e;">0</div>
                    <div class="goal-summary-label">Active</div>
                </div>
                <div class="goal-summary-card">
                    <div class="goal-summary-value" id="goals-xp-earned" style="color: #f5af19;">0</div>
                    <div class="goal-summary-label">XP Earned</div>
                </div>
            </div>
            <div class="goals-list" id="goals-list">
                <!-- Populated by JavaScript -->
            </div>
            <button class="add-goal-btn" onclick="addNewGoal()"> Add Custom Goal</button>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeGoals()" style="padding: 12px 40px; border: none; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Wrong Answer Review Modal -->
    <div class="review-modal" id="review-modal">
        <div class="review-content">
            <div class="review-header">
                <h2 style="margin: 0;"> Wrong Answer Review</h2>
                <p style="color: #aaa; margin-top: 5px;">Learn from your mistakes!</p>
            </div>
            <div class="review-stats">
                <div class="review-stat">
                    <div class="review-stat-value" id="review-total" style="color: #f44336;">0</div>
                    <div class="review-stat-label">To Review</div>
                </div>
                <div class="review-stat">
                    <div class="review-stat-value" id="review-mastered" style="color: #4CAF50;">0</div>
                    <div class="review-stat-label">Mastered</div>
                </div>
            </div>
            <div class="review-list" id="review-list">
                <!-- Populated by JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeReview()" style="padding: 12px 40px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Floating Buttons for Batch 31 -->
    <button class="floating-facts-btn" onclick="showRandomFact()" title="Science Facts"></button>
    <button class="floating-goals-btn" onclick="openGoals()" title="Study Goals"></button>
    <button class="floating-review-btn" onclick="openReview()" title="Review Mistakes"></button>

    <script>
        // ========== BATCH 31: Daily Science Facts, Study Goals, Wrong Answer Review ==========

        // Daily Science Facts
        const scienceFacts = [
            { text: 'A teaspoon of a neutron star would weigh about 6 billion tons!', category: 'Space' },
            { text: 'Honey never spoils. Archaeologists have found 3000-year-old honey in Egyptian tombs that was still edible!', category: 'Biology' },
            { text: 'Water can exist in three states at the same time, called the "triple point".', category: 'Chemistry' },
            { text: 'Sound travels about 4 times faster in water than in air.', category: 'Physics' },
            { text: 'The human brain uses about 20% of the body\'s total energy.', category: 'Biology' },
            { text: 'Lightning strikes the Earth about 100 times every second.', category: 'Earth' },
            { text: 'There are more stars in the universe than grains of sand on all Earth\'s beaches.', category: 'Space' },
            { text: 'Octopuses have three hearts and blue blood.', category: 'Biology' },
            { text: 'Hot water can freeze faster than cold water under certain conditions. This is called the Mpemba effect.', category: 'Physics' },
            { text: 'A single bolt of lightning contains enough energy to cook 100,000 pieces of toast!', category: 'Physics' },
            { text: 'Your stomach acid is strong enough to dissolve metal.', category: 'Biology' },
            { text: 'Venus is the only planet that spins clockwise.', category: 'Space' },
            { text: 'Diamonds can be made from peanut butter!', category: 'Chemistry' },
            { text: 'Bananas are slightly radioactive due to their potassium content.', category: 'Chemistry' },
            { text: 'The Great Wall of China is NOT visible from space with the naked eye.', category: 'Earth' },
            { text: 'A day on Venus is longer than a year on Venus.', category: 'Space' },
            { text: 'Humans share 60% of their DNA with bananas.', category: 'Biology' },
            { text: 'Glass is actually a liquid that flows very, very slowly.', category: 'Chemistry' },
            { text: 'The Eiffel Tower can grow up to 6 inches taller during summer due to heat expansion.', category: 'Physics' },
            { text: 'A cloud can weigh more than a million pounds!', category: 'Earth' }
        ];

        let factShownToday = localStorage.getItem('factShownDate') === new Date().toDateString();

        function showRandomFact() {
            const fact = scienceFacts[Math.floor(Math.random() * scienceFacts.length)];
            document.getElementById('science-fact-text').textContent = fact.text;
            document.getElementById('science-fact-category').textContent = fact.category;
            document.getElementById('science-fact-banner').style.display = 'block';
        }

        function closeScienceFact() {
            document.getElementById('science-fact-banner').style.display = 'none';
        }

        function showDailyFact() {
            if (!factShownToday) {
                setTimeout(() => {
                    showRandomFact();
                    localStorage.setItem('factShownDate', new Date().toDateString());
                    factShownToday = true;
                }, 3000);
            }
        }

        // Study Goals
        const defaultGoals = [
            { id: 'g1', title: 'Answer 10 Questions', icon: '', target: 10, type: 'questions', reward: 50 },
            { id: 'g2', title: 'Earn 100 XP Today', icon: '', target: 100, type: 'daily_xp', reward: 25 },
            { id: 'g3', title: 'Complete a Quiz', icon: '', target: 1, type: 'quizzes', reward: 30 },
            { id: 'g4', title: 'Study for 30 Minutes', icon: '', target: 30, type: 'focus_time', reward: 50 },
            { id: 'g5', title: 'Learn 5 New Terms', icon: '', target: 5, type: 'terms_learned', reward: 40 },
            { id: 'g6', title: 'Get a 5-Question Streak', icon: '', target: 5, type: 'streak', reward: 75 }
        ];

        let userGoals = JSON.parse(localStorage.getItem('userGoals')) || [];
        let completedGoalIds = JSON.parse(localStorage.getItem('completedGoalIds')) || [];
        let goalsXPEarned = parseInt(localStorage.getItem('goalsXPEarned')) || 0;

        function openGoals() {
            renderGoals();
            document.getElementById('goals-modal').style.display = 'flex';
        }

        function closeGoals() {
            document.getElementById('goals-modal').style.display = 'none';
        }

        function getGoalProgress(goal) {
            const today = new Date().toDateString();
            switch (goal.type) {
                case 'questions':
                    const questionsHistory = JSON.parse(localStorage.getItem('questionsHistory')) || {};
                    return questionsHistory[today] || 0;
                case 'daily_xp':
                    const xpHistory = JSON.parse(localStorage.getItem('xpHistory')) || {};
                    return xpHistory[today] || 0;
                case 'quizzes':
                    return parseInt(localStorage.getItem('quizzesToday')) || 0;
                case 'focus_time':
                    const focusStats = JSON.parse(localStorage.getItem('focusStats')) || {};
                    return (focusStats[today] && focusStats[today].minutes) || 0;
                case 'terms_learned':
                    return parseInt(localStorage.getItem('termsLearnedToday')) || 0;
                case 'streak':
                    return parseInt(localStorage.getItem('currentStreak')) || 0;
                case 'custom':
                    return goal.progress || 0;
                default:
                    return 0;
            }
        }

        function renderGoals() {
            const allGoals = [...defaultGoals, ...userGoals];
            let completedCount = 0;
            let activeCount = 0;

            const goalsHtml = allGoals.map(goal => {
                const progress = getGoalProgress(goal);
                const percentage = Math.min((progress / goal.target) * 100, 100);
                const isCompleted = completedGoalIds.includes(goal.id) || percentage >= 100;

                if (isCompleted) completedCount++;
                else activeCount++;

                // Auto-complete goal if reached
                if (percentage >= 100 && !completedGoalIds.includes(goal.id)) {
                    completedGoalIds.push(goal.id);
                    localStorage.setItem('completedGoalIds', JSON.stringify(completedGoalIds));

                    // Award XP
                    const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
                    localStorage.setItem('scienceXP', currentXP + goal.reward);
                    goalsXPEarned += goal.reward;
                    localStorage.setItem('goalsXPEarned', goalsXPEarned);
                }

                return `
                    <div class="goal-item ${isCompleted ? 'completed' : ''}">
                        <div class="goal-item-header">
                            <div class="goal-item-title">
                                <span>${goal.icon}</span>
                                <span>${goal.title}</span>
                                ${isCompleted ? '<span style="color: #4CAF50;"></span>' : ''}
                            </div>
                            <span class="goal-item-reward">+${goal.reward} XP</span>
                        </div>
                        <div class="goal-progress-container">
                            <div class="goal-progress-bar">
                                <div class="goal-progress-fill" style="width: ${percentage}%; ${isCompleted ? 'background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);' : ''}"></div>
                            </div>
                        </div>
                        <div class="goal-progress-text">
                            <span>${Math.min(progress, goal.target)} / ${goal.target}</span>
                            <span>${Math.round(percentage)}%</span>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('goals-list').innerHTML = goalsHtml;
            document.getElementById('goals-completed').textContent = completedCount;
            document.getElementById('goals-active').textContent = activeCount;
            document.getElementById('goals-xp-earned').textContent = goalsXPEarned;
        }

        function addNewGoal() {
            const title = prompt('Enter goal title (e.g., "Read 3 articles"):');
            if (!title) return;

            const target = parseInt(prompt('Enter target number:'));
            if (!target || target < 1) {
                alert('Please enter a valid target number');
                return;
            }

            const newGoal = {
                id: 'custom_' + Date.now(),
                title: title,
                icon: '',
                target: target,
                type: 'custom',
                reward: Math.min(target * 5, 100),
                progress: 0
            };

            userGoals.push(newGoal);
            localStorage.setItem('userGoals', JSON.stringify(userGoals));
            renderGoals();
        }

        // Wrong Answer Review
        let wrongAnswers = JSON.parse(localStorage.getItem('wrongAnswers')) || [];
        let masteredQuestions = JSON.parse(localStorage.getItem('masteredQuestions')) || [];

        function recordWrongAnswer(question, yourAnswer, correctAnswer) {
            const existingIndex = wrongAnswers.findIndex(w => w.question === question);
            if (existingIndex === -1) {
                wrongAnswers.push({
                    question,
                    yourAnswer,
                    correctAnswer,
                    timestamp: Date.now(),
                    attempts: 1
                });
            } else {
                wrongAnswers[existingIndex].attempts++;
                wrongAnswers[existingIndex].yourAnswer = yourAnswer;
            }
            localStorage.setItem('wrongAnswers', JSON.stringify(wrongAnswers));
        }

        function openReview() {
            renderReviewList();
            document.getElementById('review-modal').style.display = 'flex';
        }

        function closeReview() {
            document.getElementById('review-modal').style.display = 'none';
        }

        function renderReviewList() {
            const toReview = wrongAnswers.filter(w => !masteredQuestions.includes(w.question));
            const mastered = masteredQuestions.length;

            document.getElementById('review-total').textContent = toReview.length;
            document.getElementById('review-mastered').textContent = mastered;

            if (toReview.length === 0 && mastered === 0) {
                document.getElementById('review-list').innerHTML = `
                    <div class="review-empty">
                        <div class="review-empty-icon"></div>
                        <h3>No mistakes to review!</h3>
                        <p>Keep up the great work. When you get a question wrong, it will appear here for review.</p>
                    </div>
                `;
                return;
            }

            document.getElementById('review-list').innerHTML = toReview.map((item, index) => `
                <div class="review-item">
                    <div class="review-question">${item.question}</div>
                    <div class="review-answer-row">
                        <div class="review-your-answer">
                            <strong>Your answer:</strong><br>${item.yourAnswer}
                        </div>
                        <div class="review-correct-answer">
                            <strong>Correct:</strong><br>${item.correctAnswer}
                        </div>
                    </div>
                    <div class="review-actions">
                        <button class="review-action-btn review-practice-btn" onclick="practiceQuestion(${index})"> Practice</button>
                        <button class="review-action-btn review-mastered-btn" onclick="markAsMastered(${index})"> I've Got It</button>
                    </div>
                </div>
            `).join('');
        }

        function practiceQuestion(index) {
            const item = wrongAnswers[index];
            alert(`Question: ${item.question}\n\nCorrect Answer: ${item.correctAnswer}\n\nTake your time to remember this!`);
        }

        function markAsMastered(index) {
            const item = wrongAnswers[index];
            masteredQuestions.push(item.question);
            localStorage.setItem('masteredQuestions', JSON.stringify(masteredQuestions));

            // Award XP for mastering
            const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            localStorage.setItem('scienceXP', currentXP + 10);

            renderReviewList();
            alert('Great job! +10 XP for mastering this question!');
        }

        // Reset daily goals at midnight
        function checkDailyReset() {
            const lastReset = localStorage.getItem('lastGoalReset');
            const today = new Date().toDateString();

            if (lastReset !== today) {
                // Reset daily tracking
                localStorage.setItem('quizzesToday', '0');
                localStorage.setItem('termsLearnedToday', '0');
                localStorage.setItem('lastGoalReset', today);

                // Reset daily goals completion (keep custom goals)
                completedGoalIds = completedGoalIds.filter(id => id.startsWith('custom_'));
                localStorage.setItem('completedGoalIds', JSON.stringify(completedGoalIds));
            }
        }

        // Initialize Batch 31
        checkDailyReset();
        showDailyFact();

        console.log(' Science Facts, Study Goals, and Wrong Answer Review loaded!');
    </script>

    <!-- ========== BATCH 32: Science Experiments, Learning Pathways, Quick Start Tutorial ========== -->

    <!-- Science Experiments Modal -->
    <div class="experiments-modal" id="experiments-modal">
        <div class="experiments-content">
            <div style="text-align: center; margin-bottom: 25px;">
                <h2 style="margin: 0;"> Virtual Science Experiments</h2>
                <p style="color: #aaa; margin-top: 5px;">Learn by doing! Try these interactive experiments</p>
            </div>
            <div id="experiments-list">
                <!-- Populated by JavaScript -->
            </div>
            <div id="experiment-simulation" class="experiment-simulation">
                <!-- Populated by JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeExperiments()" style="padding: 12px 40px; border: none; background: rgba(255,255,255,0.2); border-radius: 25px; color: white; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Learning Pathways Modal -->
    <div class="pathways-modal" id="pathways-modal">
        <div class="pathways-content">
            <div style="text-align: center; margin-bottom: 25px;">
                <h2 style="margin: 0;"> Learning Pathways</h2>
                <p style="color: #666; margin-top: 5px;">Follow guided learning tracks to master science!</p>
            </div>
            <div id="pathways-list">
                <!-- Populated by JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 25px;">
                <button onclick="closePathways()" style="padding: 12px 40px; border: none; background: linear-gradient(135deg, #00bcd4 0%, #009688 100%); border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Quick Start Tutorial Overlay -->
    <div class="tutorial-overlay" id="tutorial-overlay">
        <div class="tutorial-content">
            <div class="tutorial-step-indicator" id="tutorial-dots">
                <!-- Populated by JavaScript -->
            </div>
            <div class="tutorial-icon" id="tutorial-icon"></div>
            <h2 class="tutorial-title" id="tutorial-title">Welcome to Science CER!</h2>
            <p class="tutorial-text" id="tutorial-text">Let's take a quick tour to help you get started with your learning journey.</p>
            <div class="tutorial-nav">
                <button class="tutorial-btn tutorial-btn-skip" onclick="skipTutorial()">Skip</button>
                <button class="tutorial-btn tutorial-btn-next" onclick="nextTutorialStep()">Next </button>
            </div>
        </div>
    </div>

    <!-- Floating Buttons for Batch 32 -->
    <button class="floating-experiments-btn" onclick="openExperiments()" title="Science Experiments"></button>
    <button class="floating-pathways-btn" onclick="openPathways()" title="Learning Pathways"></button>

    <script>
        // ========== BATCH 32: Science Experiments, Learning Pathways, Quick Start Tutorial ==========

        // Science Experiments
        const virtualExperiments = [
            {
                id: 'e1',
                title: 'Volcano Eruption',
                icon: '',
                desc: 'Create a chemical reaction that simulates a volcanic eruption!',
                difficulty: 'easy',
                topic: 'Chemistry',
                steps: [
                    'Gather baking soda and vinegar',
                    'Place baking soda in a container',
                    'Slowly pour vinegar over it',
                    'Watch the fizzy eruption!'
                ],
                science: 'When baking soda (base) meets vinegar (acid), they react to produce carbon dioxide gas, creating the bubbling effect!'
            },
            {
                id: 'e2',
                title: 'Density Tower',
                icon: '',
                desc: 'Stack different liquids to learn about density!',
                difficulty: 'easy',
                topic: 'Physics',
                steps: [
                    'Pour honey into a tall glass',
                    'Slowly add dish soap on top',
                    'Carefully pour water next',
                    'Finally, add vegetable oil'
                ],
                science: 'Liquids with different densities don\'t mix! Denser liquids sink to the bottom while lighter ones float on top.'
            },
            {
                id: 'e3',
                title: 'Plant Breathing',
                icon: '',
                desc: 'See how plants release oxygen through photosynthesis!',
                difficulty: 'medium',
                topic: 'Biology',
                steps: [
                    'Place a water plant in a glass of water',
                    'Put it under bright light',
                    'Wait and observe small bubbles',
                    'Those bubbles are oxygen!'
                ],
                science: 'Plants use sunlight, water, and CO2 to make food through photosynthesis. Oxygen is released as a byproduct!'
            },
            {
                id: 'e4',
                title: 'Static Electricity',
                icon: '',
                desc: 'Make objects move without touching them using static!',
                difficulty: 'easy',
                topic: 'Physics',
                steps: [
                    'Rub a balloon on your hair',
                    'Hold it near small paper pieces',
                    'Watch the paper jump to the balloon!',
                    'Try it with a stream of water too'
                ],
                science: 'Rubbing creates an imbalance of electrical charges. Opposite charges attract, pulling the paper toward the balloon!'
            },
            {
                id: 'e5',
                title: 'Crystal Growing',
                icon: '',
                desc: 'Grow your own crystals from a supersaturated solution!',
                difficulty: 'medium',
                topic: 'Chemistry',
                steps: [
                    'Dissolve lots of sugar in hot water',
                    'Hang a string in the solution',
                    'Leave it undisturbed for a week',
                    'Crystals will form on the string!'
                ],
                science: 'As water evaporates, sugar molecules bond together in repeating patterns to form crystals!'
            },
            {
                id: 'e6',
                title: 'Egg in Bottle',
                icon: '',
                desc: 'Push an egg into a bottle using air pressure!',
                difficulty: 'medium',
                topic: 'Physics',
                steps: [
                    'Peel a hard-boiled egg',
                    'Light a paper and drop it in a bottle',
                    'Quickly place the egg on top',
                    'Watch the egg get sucked in!'
                ],
                science: 'The fire uses up oxygen, reducing air pressure inside. Higher outside pressure pushes the egg in!'
            }
        ];

        let currentExperiment = null;

        function openExperiments() {
            renderExperimentsList();
            document.getElementById('experiments-modal').style.display = 'flex';
        }

        function closeExperiments() {
            document.getElementById('experiments-modal').style.display = 'none';
            document.getElementById('experiments-list').style.display = 'block';
            document.getElementById('experiment-simulation').style.display = 'none';
        }

        function renderExperimentsList() {
            document.getElementById('experiments-list').innerHTML = virtualExperiments.map(exp => `
                <div class="experiment-card" onclick="startExperiment('${exp.id}')">
                    <div class="experiment-icon">${exp.icon}</div>
                    <div class="experiment-info">
                        <div class="experiment-title">${exp.title}</div>
                        <div class="experiment-desc">${exp.desc}</div>
                        <span class="experiment-badge ${exp.difficulty}">${exp.difficulty}</span>
                        <span class="experiment-badge" style="background: rgba(102, 126, 234, 0.3); color: #667eea; margin-left: 5px;">${exp.topic}</span>
                    </div>
                </div>
            `).join('');
        }

        function startExperiment(experimentId) {
            const exp = virtualExperiments.find(e => e.id === experimentId);
            if (!exp) return;

            currentExperiment = exp;
            document.getElementById('experiments-list').style.display = 'none';

            const simulation = document.getElementById('experiment-simulation');
            simulation.style.display = 'block';
            simulation.innerHTML = `
                <div class="experiment-animation" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    ${exp.icon}
                </div>
                <h3 style="font-size: 1.5rem; margin-bottom: 10px;">${exp.title}</h3>
                <p style="color: #aaa; margin-bottom: 25px;">${exp.topic} Experiment</p>

                <div class="experiment-steps">
                    <h4 style="margin-bottom: 15px; color: #667eea;">Steps:</h4>
                    ${exp.steps.map((step, i) => `
                        <div class="experiment-step">
                            <div class="experiment-step-num">${i + 1}</div>
                            <span>${step}</span>
                        </div>
                    `).join('')}
                </div>

                <div style="background: rgba(76, 175, 80, 0.2); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #4CAF50; margin-bottom: 10px;"> The Science:</h4>
                    <p style="color: #ccc;">${exp.science}</p>
                </div>

                <button onclick="completeExperiment()" style="padding: 12px 40px; border: none; background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); border-radius: 25px; color: white; font-weight: bold; cursor: pointer;"> I Did This Experiment!</button>
                <br><br>
                <button onclick="backToExperiments()" style="padding: 10px 25px; border: none; background: rgba(255,255,255,0.1); border-radius: 20px; color: white; cursor: pointer;"> Back to List</button>
            `;
        }

        function completeExperiment() {
            const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            localStorage.setItem('scienceXP', currentXP + 25);

            let completedExperiments = JSON.parse(localStorage.getItem('completedExperiments')) || [];
            if (!completedExperiments.includes(currentExperiment.id)) {
                completedExperiments.push(currentExperiment.id);
                localStorage.setItem('completedExperiments', JSON.stringify(completedExperiments));
            }

            alert(' Experiment completed! +25 XP earned!');
            backToExperiments();
        }

        function backToExperiments() {
            document.getElementById('experiments-list').style.display = 'block';
            document.getElementById('experiment-simulation').style.display = 'none';
        }

        // Learning Pathways
        const learningPathways = [
            {
                id: 'physics-path',
                title: 'Physics Fundamentals',
                icon: '',
                category: 'physics',
                lessons: ['Forces', 'Energy', 'Motion', 'Gravity', 'Electricity', 'Waves', 'Heat', 'Light']
            },
            {
                id: 'chemistry-path',
                title: 'Chemistry Basics',
                icon: '',
                category: 'chemistry',
                lessons: ['Atoms', 'Elements', 'Compounds', 'Reactions', 'Acids & Bases', 'States of Matter', 'Solutions', 'Periodic Table']
            },
            {
                id: 'biology-path',
                title: 'Life Science Journey',
                icon: '',
                category: 'biology',
                lessons: ['Cells', 'Plants', 'Animals', 'Human Body', 'Ecosystems', 'Genetics', 'Evolution', 'Microorganisms']
            },
            {
                id: 'earth-path',
                title: 'Earth & Space',
                icon: '',
                category: 'earth',
                lessons: ['Rocks', 'Volcanoes', 'Weather', 'Water Cycle', 'Atmosphere', 'Solar System', 'Stars', 'Earth\'s Layers']
            }
        ];

        let pathwayProgress = JSON.parse(localStorage.getItem('pathwayProgress')) || {};

        function openPathways() {
            renderPathways();
            document.getElementById('pathways-modal').style.display = 'flex';
        }

        function closePathways() {
            document.getElementById('pathways-modal').style.display = 'none';
        }

        function renderPathways() {
            document.getElementById('pathways-list').innerHTML = learningPathways.map(pathway => {
                const progress = pathwayProgress[pathway.id] || 0;
                const percentage = Math.round((progress / pathway.lessons.length) * 100);

                return `
                    <div class="pathway-card ${pathway.category}">
                        <div class="pathway-header">
                            <div class="pathway-title">
                                <span style="font-size: 1.5rem;">${pathway.icon}</span>
                                <span>${pathway.title}</span>
                            </div>
                            <span class="pathway-progress-badge" style="background: ${percentage === 100 ? 'linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%)' : '#e0e0e0'}; color: ${percentage === 100 ? 'white' : '#666'};">
                                ${percentage}% Complete
                            </span>
                        </div>
                        <p style="color: #666; margin-bottom: 10px;">${pathway.lessons.length} lessons  ${pathway.category}</p>
                        <div class="pathway-lessons">
                            ${pathway.lessons.map((lesson, i) => {
                                const isCompleted = i < progress;
                                const isCurrent = i === progress;
                                const isLocked = i > progress;
                                return `
                                    <div class="pathway-lesson ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''} ${isLocked ? 'locked' : ''}"
                                         onclick="${!isLocked ? `startLesson('${pathway.id}', ${i})` : ''}"
                                         title="${lesson}">
                                        ${isCompleted ? '' : i + 1}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function startLesson(pathwayId, lessonIndex) {
            const pathway = learningPathways.find(p => p.id === pathwayId);
            if (!pathway) return;

            const lesson = pathway.lessons[lessonIndex];
            const confirmed = confirm(`Start lesson: "${lesson}"?\n\nThis will open a practice quiz for this topic.`);

            if (confirmed) {
                // Complete the lesson
                pathwayProgress[pathwayId] = Math.max(pathwayProgress[pathwayId] || 0, lessonIndex + 1);
                localStorage.setItem('pathwayProgress', JSON.stringify(pathwayProgress));

                // Award XP
                const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
                localStorage.setItem('scienceXP', currentXP + 15);

                alert(` Lesson "${lesson}" completed! +15 XP earned!`);
                renderPathways();
            }
        }

        // Quick Start Tutorial
        const tutorialSteps = [
            { icon: '', title: 'Welcome to Science CER!', text: 'Let\'s take a quick tour to help you get started with your learning journey.' },
            { icon: '', title: 'Answer Questions', text: 'Practice science questions to earn XP and level up! The more you answer, the smarter you get.' },
            { icon: '', title: 'Take Quizzes', text: 'Test your knowledge with fun quizzes! Choose your topic and challenge yourself.' },
            { icon: '', title: 'Build Streaks', text: 'Answer questions correctly in a row to build streaks and earn bonus XP!' },
            { icon: '', title: 'Earn Achievements', text: 'Complete goals and unlock badges. There are tons of rewards waiting for you!' },
            { icon: '', title: 'You\'re Ready!', text: 'Start exploring and have fun learning science! Click the floating buttons on the right for more features.' }
        ];

        let currentTutorialStep = 0;

        function showTutorial() {
            const hasSeenTutorial = localStorage.getItem('hasSeenTutorial');
            if (!hasSeenTutorial) {
                currentTutorialStep = 0;
                renderTutorialStep();
                document.getElementById('tutorial-overlay').style.display = 'flex';
            }
        }

        function renderTutorialStep() {
            const step = tutorialSteps[currentTutorialStep];

            document.getElementById('tutorial-icon').textContent = step.icon;
            document.getElementById('tutorial-title').textContent = step.title;
            document.getElementById('tutorial-text').textContent = step.text;

            document.getElementById('tutorial-dots').innerHTML = tutorialSteps.map((_, i) =>
                `<div class="tutorial-dot ${i === currentTutorialStep ? 'active' : ''}"></div>`
            ).join('');

            // Change button text on last step
            const nextBtn = document.querySelector('.tutorial-btn-next');
            if (currentTutorialStep === tutorialSteps.length - 1) {
                nextBtn.textContent = 'Get Started! ';
            } else {
                nextBtn.textContent = 'Next ';
            }
        }

        function nextTutorialStep() {
            currentTutorialStep++;
            if (currentTutorialStep >= tutorialSteps.length) {
                completeTutorial();
            } else {
                renderTutorialStep();
            }
        }

        function skipTutorial() {
            completeTutorial();
        }

        function completeTutorial() {
            localStorage.setItem('hasSeenTutorial', 'true');
            document.getElementById('tutorial-overlay').style.display = 'none';

            // Award XP for completing tutorial
            const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            localStorage.setItem('scienceXP', currentXP + 50);
        }

        function resetTutorial() {
            localStorage.removeItem('hasSeenTutorial');
            showTutorial();
        }

        // Initialize Batch 32
        setTimeout(showTutorial, 2000);

        console.log(' Science Experiments, Learning Pathways, and Tutorial loaded!');
    </script>

    <!-- ========== BATCH 33: Keyboard Shortcuts, Level Rewards, Celebrations ========== -->

    <!-- Keyboard Shortcuts Modal -->
    <div class="shortcuts-modal" id="shortcuts-modal">
        <div class="shortcuts-content">
            <div style="text-align: center; margin-bottom: 25px;">
                <h2 style="margin: 0;"> Keyboard Shortcuts</h2>
                <p style="color: #666; margin-top: 5px;">Use these shortcuts to navigate faster!</p>
            </div>
            <div id="shortcuts-list">
                <!-- Populated by JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeShortcuts()" style="padding: 12px 40px; border: none; background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Level Reward Popup -->
    <div class="level-reward-popup" id="level-reward-popup">
        <div class="level-reward-glow"></div>
        <div class="level-reward-badge" id="level-reward-badge"></div>
        <h2 class="level-reward-title" id="level-reward-title">Level Up!</h2>
        <p class="level-reward-desc" id="level-reward-desc">You reached a new level!</p>
        <div class="level-reward-items" id="level-reward-items">
            <!-- Populated by JavaScript -->
        </div>
        <button class="level-reward-claim-btn" onclick="claimLevelReward()">Claim Rewards!</button>
    </div>

    <!-- Floating Shortcuts Button -->
    <button class="floating-shortcuts-btn" onclick="openShortcuts()" title="Keyboard Shortcuts"></button>

    <script>
        // ========== BATCH 33: Keyboard Shortcuts, Level Rewards, Celebrations ==========

        // Keyboard Shortcuts
        const keyboardShortcuts = [
            {
                category: ' Navigation',
                shortcuts: [
                    { keys: ['Ctrl', 'Shift', 'N'], desc: 'Open Study Notes' },
                    { keys: ['Ctrl', 'Shift', 'F'], desc: 'Toggle Focus Mode' },
                    { keys: ['?'], desc: 'Show this shortcuts panel' },
                    { keys: ['Esc'], desc: 'Close any open modal' }
                ]
            },
            {
                category: ' Study',
                shortcuts: [
                    { keys: ['1-4'], desc: 'Select answer option' },
                    { keys: ['Enter'], desc: 'Submit answer / Continue' },
                    { keys: ['Space'], desc: 'Flip flashcard' }
                ]
            },
            {
                category: ' Quick Access',
                shortcuts: [
                    { keys: ['Q'], desc: 'Open Quiz Generator' },
                    { keys: ['D'], desc: 'Open Dictionary' },
                    { keys: ['G'], desc: 'Open Goals' }
                ]
            }
        ];

        function openShortcuts() {
            renderShortcuts();
            document.getElementById('shortcuts-modal').style.display = 'flex';
        }

        function closeShortcuts() {
            document.getElementById('shortcuts-modal').style.display = 'none';
        }

        function renderShortcuts() {
            document.getElementById('shortcuts-list').innerHTML = keyboardShortcuts.map(cat => `
                <div class="shortcuts-category">
                    <div class="shortcuts-category-title">${cat.category}</div>
                    ${cat.shortcuts.map(s => `
                        <div class="shortcut-item">
                            <div class="shortcut-keys">
                                ${s.keys.map(k => `<span class="shortcut-key">${k}</span>`).join(' + ')}
                            </div>
                            <span class="shortcut-desc">${s.desc}</span>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        // Level Rewards System
        const levelRewards = {
            5: { badge: '', title: 'Rising Star!', desc: 'Level 5 Unlocked', xp: 100, powerups: 2 },
            10: { badge: '', title: 'Scholar!', desc: 'Level 10 Unlocked', xp: 200, powerups: 3 },
            15: { badge: '', title: 'Scientist!', desc: 'Level 15 Unlocked', xp: 300, powerups: 4 },
            20: { badge: '', title: 'Genius!', desc: 'Level 20 Unlocked', xp: 500, powerups: 5 },
            25: { badge: '', title: 'Champion!', desc: 'Level 25 Unlocked', xp: 750, powerups: 6 },
            30: { badge: '', title: 'Legend!', desc: 'Level 30 Unlocked', xp: 1000, powerups: 8 },
            50: { badge: '', title: 'Diamond Scholar!', desc: 'Level 50 Unlocked', xp: 2000, powerups: 10 }
        };

        let pendingLevelReward = null;
        let claimedLevelRewards = JSON.parse(localStorage.getItem('claimedLevelRewards')) || [];

        function checkLevelReward(level) {
            if (levelRewards[level] && !claimedLevelRewards.includes(level)) {
                showLevelReward(level);
            }
        }

        function showLevelReward(level) {
            const reward = levelRewards[level];
            pendingLevelReward = { level, ...reward };

            document.getElementById('level-reward-badge').textContent = reward.badge;
            document.getElementById('level-reward-title').textContent = reward.title;
            document.getElementById('level-reward-desc').textContent = reward.desc;

            document.getElementById('level-reward-items').innerHTML = `
                <div class="level-reward-item">
                    <div class="level-reward-item-icon"></div>
                    <div class="level-reward-item-value">+${reward.xp} XP</div>
                </div>
                <div class="level-reward-item">
                    <div class="level-reward-item-icon"></div>
                    <div class="level-reward-item-value">${reward.powerups} Power-ups</div>
                </div>
            `;

            document.getElementById('level-reward-popup').classList.add('show');
            triggerCelebration('level');
        }

        function claimLevelReward() {
            if (!pendingLevelReward) return;

            // Award XP
            const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            localStorage.setItem('scienceXP', currentXP + pendingLevelReward.xp);

            // Award powerups
            const currentPowerups = parseInt(localStorage.getItem('totalPowerups')) || 0;
            localStorage.setItem('totalPowerups', currentPowerups + pendingLevelReward.powerups);

            // Mark as claimed
            claimedLevelRewards.push(pendingLevelReward.level);
            localStorage.setItem('claimedLevelRewards', JSON.stringify(claimedLevelRewards));

            document.getElementById('level-reward-popup').classList.remove('show');
            pendingLevelReward = null;
        }

        // Celebration Effects
        function triggerCelebration(type = 'normal') {
            if (type === 'level') {
                createFireworks(10);
                createSparkles(20);
            } else if (type === 'streak') {
                createSparkles(15);
                createFloatingText(' Streak!', window.innerWidth / 2, window.innerHeight / 2);
            } else if (type === 'correct') {
                createSparkles(5);
            }
        }

        function createFireworks(count) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const x = Math.random() * window.innerWidth;
                    const y = Math.random() * (window.innerHeight / 2);
                    createFirework(x, y);
                }, i * 200);
            }
        }

        function createFirework(x, y) {
            const colors = ['#ff0000', '#ff7300', '#fffb00', '#48ff00', '#00ffd5', '#002bff', '#7a00ff', '#ff00c8'];

            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'celebration-firework';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];

                const angle = (i / 12) * Math.PI * 2;
                const velocity = 100 + Math.random() * 50;
                const vx = Math.cos(angle) * velocity;
                const vy = Math.sin(angle) * velocity;

                document.body.appendChild(particle);

                let posX = x;
                let posY = y;
                let opacity = 1;

                const animate = () => {
                    posX += vx * 0.02;
                    posY += vy * 0.02 + 1;
                    opacity -= 0.02;

                    particle.style.left = posX + 'px';
                    particle.style.top = posY + 'px';
                    particle.style.opacity = opacity;

                    if (opacity > 0) {
                        requestAnimationFrame(animate);
                    } else {
                        particle.remove();
                    }
                };

                requestAnimationFrame(animate);
            }
        }

        function createSparkles(count) {
            const emojis = ['', '', '', '', ''];

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    sparkle.style.left = (Math.random() * window.innerWidth) + 'px';
                    sparkle.style.top = (window.innerHeight / 2 + Math.random() * (window.innerHeight / 2)) + 'px';

                    document.body.appendChild(sparkle);

                    setTimeout(() => sparkle.remove(), 1500);
                }, i * 100);
            }
        }

        function createFloatingText(text, x, y) {
            const floatText = document.createElement('div');
            floatText.className = 'floating-text';
            floatText.textContent = text;
            floatText.style.left = x + 'px';
            floatText.style.top = y + 'px';

            document.body.appendChild(floatText);

            setTimeout(() => floatText.remove(), 1500);
        }

        function showXPGain(amount, x, y) {
            createFloatingText(`+${amount} XP`, x || window.innerWidth / 2, y || window.innerHeight / 2);
        }

        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // ? for shortcuts
            if (e.key === '?' || (e.key === '/' && e.shiftKey)) {
                e.preventDefault();
                openShortcuts();
            }

            // Escape to close modals
            if (e.key === 'Escape') {
                closeShortcuts();
                document.getElementById('level-reward-popup').classList.remove('show');
            }

            // Q for Quiz
            if (e.key === 'q' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
                const activeElement = document.activeElement;
                if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
                    if (typeof openQuizGenerator === 'function') openQuizGenerator();
                }
            }

            // D for Dictionary
            if (e.key === 'd' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
                const activeElement = document.activeElement;
                if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
                    if (typeof openDictionary === 'function') openDictionary();
                }
            }

            // G for Goals
            if (e.key === 'g' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
                const activeElement = document.activeElement;
                if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
                    if (typeof openGoals === 'function') openGoals();
                }
            }
        });

        console.log(' Keyboard Shortcuts, Level Rewards, and Celebrations loaded!');
    </script>

    <!-- ========== BATCH 34: Hint System, Stats Dashboard, Weekly Report ========== -->

    <!-- Hint Bubble -->
    <div class="hint-bubble" id="hint-bubble">
        <button class="hint-close" onclick="closeHint()"></button>
        <div class="hint-icon"></div>
        <div class="hint-text" id="hint-text">Here's a hint...</div>
        <div class="hint-remaining" id="hint-remaining">3 hints remaining today</div>
    </div>

    <!-- Stats Dashboard Modal -->
    <div class="stats-dashboard-modal" id="stats-dashboard-modal">
        <div class="stats-dashboard-content">
            <div class="stats-header-row">
                <h2 style="margin: 0;"> Study Statistics</h2>
                <button onclick="closeStatsDashboard()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;"></button>
            </div>

            <div class="stats-main-grid" id="stats-main-grid">
                <!-- Populated by JavaScript -->
            </div>

            <div class="stats-section">
                <div class="stats-section-title"> Learning Progress</div>
                <div id="stats-learning-progress">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="stats-section">
                <div class="stats-section-title"> Achievements</div>
                <div id="stats-achievements">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeStatsDashboard()" style="padding: 12px 40px; border: none; background: linear-gradient(135deg, #3f51b5 0%, #2196f3 100%); border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Weekly Report Modal -->
    <div class="weekly-report-modal" id="weekly-report-modal">
        <div class="weekly-report-content">
            <div class="weekly-report-header">
                <h2 style="margin: 0;"> Weekly Progress Report</h2>
                <p style="color: #666; margin-top: 5px;" id="weekly-date-range">This Week's Summary</p>
            </div>

            <div class="weekly-report-grade" id="weekly-grade">A</div>
            <p style="text-align: center; font-weight: 600; margin-bottom: 25px;" id="weekly-message">Outstanding Performance!</p>

            <div class="weekly-stats-grid" id="weekly-stats-grid">
                <!-- Populated by JavaScript -->
            </div>

            <div class="weekly-comparison">
                <div class="weekly-comparison-text" id="weekly-comparison-text">You studied more than last week!</div>
                <div class="weekly-comparison-bar">
                    <div class="weekly-comparison-fill" id="weekly-comparison-fill" style="width: 75%"></div>
                </div>
            </div>

            <div style="text-align: center;">
                <button onclick="closeWeeklyReport()" style="padding: 12px 40px; border: none; background: linear-gradient(135deg, #e91e63 0%, #9c27b0 100%); border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Floating Buttons for Batch 34 -->
    <button class="floating-stats-btn" onclick="openStatsDashboard()" title="Study Statistics"></button>
    <button class="floating-report-btn" onclick="openWeeklyReport()" title="Weekly Report"></button>

    <script>
        // ========== BATCH 34: Hint System, Stats Dashboard, Weekly Report ==========

        // Hint System
        const questionHints = {
            physics: [
                "Think about the relationship between force and motion.",
                "Remember: Energy cannot be created or destroyed!",
                "Consider the direction of the force.",
                "Speed has no direction, velocity does!"
            ],
            chemistry: [
                "Check the periodic table for atomic numbers.",
                "Remember: Acids have pH below 7, bases above 7.",
                "Think about what happens during chemical reactions.",
                "Count the atoms on both sides of the equation."
            ],
            biology: [
                "Think about the function of each cell part.",
                "Remember the steps of photosynthesis.",
                "Consider how energy flows through ecosystems.",
                "DNA is the blueprint of life!"
            ],
            earth: [
                "Think about the layers of the Earth.",
                "Remember the water cycle steps.",
                "Consider how tectonic plates move.",
                "Think about rock formation processes."
            ],
            general: [
                "Read the question carefully!",
                "Eliminate obviously wrong answers first.",
                "Trust your first instinct.",
                "Think logically about the options."
            ]
        };

        let hintsUsedToday = parseInt(localStorage.getItem('hintsUsedToday')) || 0;
        const maxHintsPerDay = 5;

        function showHint(category = 'general') {
            if (hintsUsedToday >= maxHintsPerDay) {
                alert('You\'ve used all your hints for today! Come back tomorrow for more.');
                return;
            }

            const hints = questionHints[category] || questionHints.general;
            const hint = hints[Math.floor(Math.random() * hints.length)];

            document.getElementById('hint-text').textContent = hint;
            document.getElementById('hint-remaining').textContent = `${maxHintsPerDay - hintsUsedToday - 1} hints remaining today`;
            document.getElementById('hint-bubble').style.display = 'block';

            hintsUsedToday++;
            localStorage.setItem('hintsUsedToday', hintsUsedToday);
        }

        function closeHint() {
            document.getElementById('hint-bubble').style.display = 'none';
        }

        function resetDailyHints() {
            const lastReset = localStorage.getItem('lastHintReset');
            const today = new Date().toDateString();

            if (lastReset !== today) {
                hintsUsedToday = 0;
                localStorage.setItem('hintsUsedToday', '0');
                localStorage.setItem('lastHintReset', today);
            }
        }

        // Stats Dashboard
        function openStatsDashboard() {
            renderStatsDashboard();
            document.getElementById('stats-dashboard-modal').style.display = 'flex';
        }

        function closeStatsDashboard() {
            document.getElementById('stats-dashboard-modal').style.display = 'none';
        }

        function renderStatsDashboard() {
            const totalXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            const level = Math.floor(totalXP / 100) + 1;
            const totalQuestions = parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0;
            const bestStreak = parseInt(localStorage.getItem('bestStreak')) || 0;
            const totalDays = parseInt(localStorage.getItem('totalDaysUsed')) || 1;
            const focusSessions = parseInt(localStorage.getItem('totalFocusSessions')) || 0;
            const completedExperiments = (JSON.parse(localStorage.getItem('completedExperiments')) || []).length;

            // Main stats grid
            document.getElementById('stats-main-grid').innerHTML = `
                <div class="stats-main-card">
                    <div class="stats-main-icon"></div>
                    <div class="stats-main-value">${totalXP}</div>
                    <div class="stats-main-label">Total XP</div>
                </div>
                <div class="stats-main-card">
                    <div class="stats-main-icon"></div>
                    <div class="stats-main-value">${level}</div>
                    <div class="stats-main-label">Level</div>
                </div>
                <div class="stats-main-card">
                    <div class="stats-main-icon"></div>
                    <div class="stats-main-value">${totalQuestions}</div>
                    <div class="stats-main-label">Questions</div>
                </div>
                <div class="stats-main-card">
                    <div class="stats-main-icon"></div>
                    <div class="stats-main-value">${bestStreak}</div>
                    <div class="stats-main-label">Best Streak</div>
                </div>
            `;

            // Learning progress
            document.getElementById('stats-learning-progress').innerHTML = `
                <div class="stats-row">
                    <span class="stats-row-label">Days Active</span>
                    <span class="stats-row-value">${totalDays} days</span>
                </div>
                <div class="stats-row">
                    <span class="stats-row-label">Focus Sessions</span>
                    <span class="stats-row-value">${focusSessions} sessions</span>
                </div>
                <div class="stats-row">
                    <span class="stats-row-label">Experiments Completed</span>
                    <span class="stats-row-value">${completedExperiments} / 6</span>
                </div>
                <div class="stats-row">
                    <span class="stats-row-label">Average XP/Day</span>
                    <span class="stats-row-value">${Math.round(totalXP / totalDays)} XP</span>
                </div>
                <div class="stats-row">
                    <span class="stats-row-label">Questions/Day</span>
                    <span class="stats-row-value">${(totalQuestions / totalDays).toFixed(1)}</span>
                </div>
            `;

            // Achievements
            const unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements')) || [];
            const completedMilestones = JSON.parse(localStorage.getItem('completedMilestones')) || [];

            document.getElementById('stats-achievements').innerHTML = `
                <div class="stats-row">
                    <span class="stats-row-label">Achievements Unlocked</span>
                    <span class="stats-row-value">${unlockedAchievements.length} / 15</span>
                </div>
                <div class="stats-row">
                    <span class="stats-row-label">Milestones Completed</span>
                    <span class="stats-row-value">${completedMilestones.length} / 15</span>
                </div>
                <div class="stats-row">
                    <span class="stats-row-label">Goals Completed</span>
                    <span class="stats-row-value">${(JSON.parse(localStorage.getItem('completedGoalIds')) || []).length}</span>
                </div>
            `;
        }

        // Weekly Report
        function openWeeklyReport() {
            renderWeeklyReport();
            document.getElementById('weekly-report-modal').style.display = 'flex';
        }

        function closeWeeklyReport() {
            document.getElementById('weekly-report-modal').style.display = 'none';
        }

        function renderWeeklyReport() {
            const xpHistory = JSON.parse(localStorage.getItem('xpHistory')) || {};
            const questionsHistory = JSON.parse(localStorage.getItem('questionsHistory')) || {};

            // Calculate this week's stats
            let weekXP = 0;
            let weekQuestions = 0;
            let daysStudied = 0;

            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();

                if (xpHistory[dateStr]) {
                    weekXP += xpHistory[dateStr];
                    daysStudied++;
                }
                if (questionsHistory[dateStr]) {
                    weekQuestions += questionsHistory[dateStr];
                }
            }

            // Calculate grade
            let grade, gradeClass, message;
            if (weekXP >= 500) {
                grade = 'A+';
                gradeClass = 'a';
                message = 'Outstanding Performance!';
            } else if (weekXP >= 300) {
                grade = 'A';
                gradeClass = 'a';
                message = 'Excellent Work!';
            } else if (weekXP >= 200) {
                grade = 'B';
                gradeClass = 'b';
                message = 'Great Progress!';
            } else if (weekXP >= 100) {
                grade = 'C';
                gradeClass = 'c';
                message = 'Good Effort!';
            } else {
                grade = 'D';
                gradeClass = 'd';
                message = 'Keep Practicing!';
            }

            document.getElementById('weekly-grade').textContent = grade;
            document.getElementById('weekly-grade').className = `weekly-report-grade ${gradeClass}`;
            document.getElementById('weekly-message').textContent = message;

            // Date range
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 6);
            document.getElementById('weekly-date-range').textContent =
                `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;

            // Stats grid
            const avgXP = daysStudied > 0 ? Math.round(weekXP / daysStudied) : 0;

            document.getElementById('weekly-stats-grid').innerHTML = `
                <div class="weekly-stat-card">
                    <div class="weekly-stat-icon"></div>
                    <div class="weekly-stat-value">${weekXP}</div>
                    <div class="weekly-stat-label">XP Earned</div>
                </div>
                <div class="weekly-stat-card">
                    <div class="weekly-stat-icon"></div>
                    <div class="weekly-stat-value">${weekQuestions}</div>
                    <div class="weekly-stat-label">Questions</div>
                </div>
                <div class="weekly-stat-card">
                    <div class="weekly-stat-icon"></div>
                    <div class="weekly-stat-value">${daysStudied}</div>
                    <div class="weekly-stat-label">Days Active</div>
                </div>
                <div class="weekly-stat-card">
                    <div class="weekly-stat-icon"></div>
                    <div class="weekly-stat-value">${avgXP}</div>
                    <div class="weekly-stat-label">Avg XP/Day</div>
                </div>
            `;

            // Comparison
            const comparisonPercent = Math.min((weekXP / 500) * 100, 100);
            document.getElementById('weekly-comparison-fill').style.width = comparisonPercent + '%';

            if (weekXP >= 300) {
                document.getElementById('weekly-comparison-text').textContent = 'Amazing! You\'re crushing it this week!';
            } else if (weekXP >= 150) {
                document.getElementById('weekly-comparison-text').textContent = 'Great work! Keep up the momentum!';
            } else {
                document.getElementById('weekly-comparison-text').textContent = 'You\'re making progress! Aim for 500 XP next week!';
            }
        }

        // Initialize
        resetDailyHints();

        console.log(' Hint System, Stats Dashboard, and Weekly Report loaded!');
    </script>

    <!-- ========== BATCH 35: Note-Taking, Bookmarks, Challenge Mode ========== -->

    <!-- Notes Modal -->
    <div class="notes-modal" id="notes-modal">
        <div class="notes-container">
            <div class="notes-header">
                <h2> My Study Notes</h2>
                <button onclick="closeNotes()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="notes-body">
                <div class="new-note-form">
                    <input type="text" id="note-title-input" placeholder="Note title (e.g., Heat Transfer Summary)">
                    <textarea id="note-content-input" placeholder="Write your notes here..."></textarea>
                    <button onclick="addNewNote()">Save Note</button>
                </div>
                <h3 style="color: #e65100; margin-bottom: 15px;">Your Notes</h3>
                <div id="notes-list"></div>
            </div>
        </div>
    </div>

    <!-- Bookmarks Modal -->
    <div class="bookmarks-modal" id="bookmarks-modal">
        <div class="bookmarks-container">
            <div class="bookmarks-header">
                <h2> Saved Questions</h2>
                <button onclick="closeBookmarks()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="bookmarks-body" id="bookmarks-list">
            </div>
        </div>
    </div>

    <!-- Challenge Mode Modal -->
    <div class="challenge-modal" id="challenge-modal">
        <div class="challenge-container">
            <div class="challenge-header">
                <h2> CHALLENGE MODE</h2>
            </div>

            <!-- Setup Screen -->
            <div id="challenge-setup" class="challenge-setup">
                <h3>Select Difficulty</h3>
                <div class="challenge-difficulty">
                    <button class="difficulty-btn selected" onclick="selectDifficulty('easy', this)">
                        <div class="diff-name">Easy</div>
                        <div class="diff-desc">60 seconds<br>5 questions</div>
                    </button>
                    <button class="difficulty-btn" onclick="selectDifficulty('medium', this)">
                        <div class="diff-name">Medium</div>
                        <div class="diff-desc">45 seconds<br>8 questions</div>
                    </button>
                    <button class="difficulty-btn" onclick="selectDifficulty('hard', this)">
                        <div class="diff-name">Hard</div>
                        <div class="diff-desc">30 seconds<br>10 questions</div>
                    </button>
                </div>
                <div class="challenge-controls">
                    <button class="challenge-start-btn" onclick="startChallenge()">START CHALLENGE</button>
                    <button class="challenge-quit-btn" onclick="closeChallenge()">Cancel</button>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="challenge-game" style="display: none;">
                <div class="challenge-timer" id="challenge-timer">60</div>
                <div class="challenge-score">
                    <div class="challenge-score-item">
                        <div class="label">Correct</div>
                        <div class="value" id="challenge-correct">0</div>
                    </div>
                    <div class="challenge-score-item">
                        <div class="label">Question</div>
                        <div class="value" id="challenge-current">1/5</div>
                    </div>
                    <div class="challenge-score-item">
                        <div class="label">Score</div>
                        <div class="value" id="challenge-points">0</div>
                    </div>
                </div>
                <div class="challenge-question" id="challenge-question-area">
                    <p id="challenge-question-text">Question will appear here...</p>
                    <div class="challenge-options" id="challenge-options"></div>
                </div>
                <div class="challenge-controls">
                    <button class="challenge-quit-btn" onclick="quitChallenge()">Quit Challenge</button>
                </div>
            </div>

            <!-- Result Screen -->
            <div id="challenge-result" class="challenge-result" style="display: none;">
                <h3>CHALLENGE COMPLETE!</h3>
                <div class="final-score" id="challenge-final-score">0</div>
                <p>Points Earned</p>
                <div class="reward" id="challenge-reward">+0 XP Bonus!</div>
                <div class="challenge-controls" style="margin-top: 30px;">
                    <button class="challenge-start-btn" onclick="resetChallenge()">Play Again</button>
                    <button class="challenge-quit-btn" onclick="closeChallenge()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <button class="floating-notes-btn" onclick="openNotes()" title="Study Notes"></button>
    <button class="floating-bookmarks-btn" onclick="openBookmarks()" title="Bookmarks"></button>
    <button class="floating-challenge-btn" onclick="openChallenge()" title="Challenge Mode"></button>

    <script>
        // ========== BATCH 35: Note-Taking, Bookmarks, Challenge Mode ==========

        // Note-Taking System
        let studyNotes = JSON.parse(localStorage.getItem('scienceStudyNotes')) || [];

        function openNotes() {
            document.getElementById('notes-modal').style.display = 'flex';
            renderNotes();
        }

        function closeNotes() {
            document.getElementById('notes-modal').style.display = 'none';
        }

        function addNewNote() {
            const title = document.getElementById('note-title-input').value.trim();
            const content = document.getElementById('note-content-input').value.trim();

            if (!title || !content) {
                alert('Please enter both a title and content for your note.');
                return;
            }

            const note = {
                id: Date.now(),
                title: title,
                content: content,
                date: new Date().toLocaleDateString()
            };

            studyNotes.unshift(note);
            localStorage.setItem('scienceStudyNotes', JSON.stringify(studyNotes));

            document.getElementById('note-title-input').value = '';
            document.getElementById('note-content-input').value = '';

            renderNotes();

            // Award XP for taking notes
            if (typeof addXP === 'function') {
                addXP(5);
            }
        }

        function deleteNote(noteId) {
            studyNotes = studyNotes.filter(n => n.id !== noteId);
            localStorage.setItem('scienceStudyNotes', JSON.stringify(studyNotes));
            renderNotes();
        }

        function renderNotes() {
            const container = document.getElementById('notes-list');

            if (studyNotes.length === 0) {
                container.innerHTML = `
                    <div class="no-notes">
                        <p> No notes yet!</p>
                        <p style="font-size: 0.9rem;">Start taking notes to help remember key concepts.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = studyNotes.map(note => `
                <div class="note-item">
                    <button class="note-delete" onclick="deleteNote(${note.id})"></button>
                    <div class="note-title">${note.title}</div>
                    <div class="note-content">${note.content}</div>
                    <div class="note-date">Created: ${note.date}</div>
                </div>
            `).join('');
        }

        // Bookmarks System
        let questionBookmarks = JSON.parse(localStorage.getItem('scienceBookmarks')) || [];

        function openBookmarks() {
            document.getElementById('bookmarks-modal').style.display = 'flex';
            renderBookmarks();
        }

        function closeBookmarks() {
            document.getElementById('bookmarks-modal').style.display = 'none';
        }

        function toggleBookmark(questionId, topic, questionNum) {
            const existingIndex = questionBookmarks.findIndex(b => b.id === questionId);

            if (existingIndex >= 0) {
                questionBookmarks.splice(existingIndex, 1);
            } else {
                questionBookmarks.push({
                    id: questionId,
                    topic: topic,
                    questionNum: questionNum,
                    date: new Date().toLocaleDateString()
                });
            }

            localStorage.setItem('scienceBookmarks', JSON.stringify(questionBookmarks));
            updateBookmarkButtons();
        }

        function isBookmarked(questionId) {
            return questionBookmarks.some(b => b.id === questionId);
        }

        function updateBookmarkButtons() {
            document.querySelectorAll('.bookmark-btn').forEach(btn => {
                const questionId = btn.dataset.questionId;
                if (isBookmarked(questionId)) {
                    btn.classList.add('bookmarked');
                    btn.innerHTML = '';
                } else {
                    btn.classList.remove('bookmarked');
                    btn.innerHTML = '';
                }
            });
        }

        function removeBookmark(questionId) {
            questionBookmarks = questionBookmarks.filter(b => b.id !== questionId);
            localStorage.setItem('scienceBookmarks', JSON.stringify(questionBookmarks));
            renderBookmarks();
            updateBookmarkButtons();
        }

        function renderBookmarks() {
            const container = document.getElementById('bookmarks-list');

            if (questionBookmarks.length === 0) {
                container.innerHTML = `
                    <div class="no-bookmarks">
                        <p> No bookmarks yet!</p>
                        <p style="font-size: 0.9rem;">Bookmark questions you want to review later.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = questionBookmarks.map(bookmark => `
                <div class="bookmark-item" onclick="goToBookmark('${bookmark.topic}', ${bookmark.questionNum})">
                    <div class="bookmark-info">
                        <div class="bookmark-title">${bookmark.topic} - Question ${bookmark.questionNum}</div>
                        <div class="bookmark-topic">Saved on ${bookmark.date}</div>
                    </div>
                    <div class="bookmark-actions">
                        <button onclick="event.stopPropagation(); removeBookmark('${bookmark.id}')">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function goToBookmark(topic, questionNum) {
            closeBookmarks();
            // Navigate to the bookmarked question
            if (typeof switchTab === 'function') {
                switchTab('cer');
            }
            // Show the topic
            const topicElement = document.getElementById(`topic-${topic.toLowerCase()}`);
            if (topicElement) {
                document.querySelectorAll('.topic-content').forEach(t => t.classList.add('hidden'));
                topicElement.classList.remove('hidden');
            }
        }

        // Challenge Mode System
        let challengeState = {
            difficulty: 'easy',
            timeLimit: 60,
            totalQuestions: 5,
            currentQuestion: 0,
            correct: 0,
            score: 0,
            timer: null,
            timeRemaining: 60,
            questions: []
        };

        const challengeQuestions = [
            { q: "What is the process by which plants make food using sunlight?", options: ["Photosynthesis", "Respiration", "Digestion", "Fermentation"], answer: 0 },
            { q: "Which organ pumps blood throughout the body?", options: ["Lungs", "Heart", "Liver", "Brain"], answer: 1 },
            { q: "What is the chemical symbol for water?", options: ["WA", "H2O", "O2", "HO2"], answer: 1 },
            { q: "Which force pulls objects towards Earth?", options: ["Friction", "Magnetic force", "Gravity", "Tension"], answer: 2 },
            { q: "What type of energy does a moving car have?", options: ["Potential energy", "Chemical energy", "Kinetic energy", "Sound energy"], answer: 2 },
            { q: "Which material is a good conductor of heat?", options: ["Wood", "Plastic", "Metal", "Rubber"], answer: 2 },
            { q: "What do we call the change from liquid to gas?", options: ["Melting", "Evaporation", "Condensation", "Freezing"], answer: 1 },
            { q: "Which planet is closest to the Sun?", options: ["Venus", "Earth", "Mercury", "Mars"], answer: 2 },
            { q: "What type of circuit has only one path for electricity?", options: ["Parallel circuit", "Series circuit", "Open circuit", "Closed circuit"], answer: 1 },
            { q: "Which part of the plant absorbs water from soil?", options: ["Leaves", "Stem", "Roots", "Flowers"], answer: 2 },
            { q: "What is the hard outer layer of Earth called?", options: ["Core", "Mantle", "Crust", "Magma"], answer: 2 },
            { q: "Which gas do humans breathe out?", options: ["Oxygen", "Nitrogen", "Carbon dioxide", "Hydrogen"], answer: 2 },
            { q: "What type of lens is used to correct short-sightedness?", options: ["Convex lens", "Concave lens", "Flat lens", "Prism"], answer: 1 },
            { q: "Which state of matter has a fixed shape and volume?", options: ["Liquid", "Gas", "Solid", "Plasma"], answer: 2 },
            { q: "What is the main source of energy for life on Earth?", options: ["Moon", "Wind", "Sun", "Water"], answer: 2 },
            { q: "Which animal group has feathers?", options: ["Mammals", "Reptiles", "Birds", "Fish"], answer: 2 },
            { q: "What instrument measures temperature?", options: ["Barometer", "Thermometer", "Ruler", "Scale"], answer: 1 },
            { q: "Which vitamin do we get from sunlight?", options: ["Vitamin A", "Vitamin B", "Vitamin C", "Vitamin D"], answer: 3 },
            { q: "What is the boiling point of water in Celsius?", options: ["0C", "50C", "100C", "212C"], answer: 2 },
            { q: "Which organ filters waste from blood?", options: ["Heart", "Lungs", "Kidneys", "Stomach"], answer: 2 }
        ];

        function openChallenge() {
            document.getElementById('challenge-modal').style.display = 'flex';
            document.getElementById('challenge-setup').style.display = 'block';
            document.getElementById('challenge-game').style.display = 'none';
            document.getElementById('challenge-result').style.display = 'none';
        }

        function closeChallenge() {
            document.getElementById('challenge-modal').style.display = 'none';
            if (challengeState.timer) {
                clearInterval(challengeState.timer);
            }
        }

        function selectDifficulty(difficulty, btn) {
            document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            challengeState.difficulty = difficulty;

            if (difficulty === 'easy') {
                challengeState.timeLimit = 60;
                challengeState.totalQuestions = 5;
            } else if (difficulty === 'medium') {
                challengeState.timeLimit = 45;
                challengeState.totalQuestions = 8;
            } else {
                challengeState.timeLimit = 30;
                challengeState.totalQuestions = 10;
            }
        }

        function startChallenge() {
            // Reset state
            challengeState.currentQuestion = 0;
            challengeState.correct = 0;
            challengeState.score = 0;
            challengeState.timeRemaining = challengeState.timeLimit;

            // Shuffle and select questions
            const shuffled = [...challengeQuestions].sort(() => Math.random() - 0.5);
            challengeState.questions = shuffled.slice(0, challengeState.totalQuestions);

            // Show game screen
            document.getElementById('challenge-setup').style.display = 'none';
            document.getElementById('challenge-game').style.display = 'block';
            document.getElementById('challenge-result').style.display = 'none';

            // Start timer
            updateTimerDisplay();
            challengeState.timer = setInterval(() => {
                challengeState.timeRemaining--;
                updateTimerDisplay();

                if (challengeState.timeRemaining <= 0) {
                    endChallenge();
                }
            }, 1000);

            // Show first question
            showChallengeQuestion();
        }

        function updateTimerDisplay() {
            const timerEl = document.getElementById('challenge-timer');
            timerEl.textContent = challengeState.timeRemaining;

            if (challengeState.timeRemaining <= 10) {
                timerEl.classList.add('warning');
            } else {
                timerEl.classList.remove('warning');
            }
        }

        function showChallengeQuestion() {
            const q = challengeState.questions[challengeState.currentQuestion];
            document.getElementById('challenge-question-text').textContent = q.q;
            document.getElementById('challenge-current').textContent = `${challengeState.currentQuestion + 1}/${challengeState.totalQuestions}`;
            document.getElementById('challenge-correct').textContent = challengeState.correct;
            document.getElementById('challenge-points').textContent = challengeState.score;

            const optionsContainer = document.getElementById('challenge-options');
            optionsContainer.innerHTML = q.options.map((opt, i) => `
                <button class="challenge-option" onclick="selectChallengeAnswer(${i})">${opt}</button>
            `).join('');
        }

        function selectChallengeAnswer(selectedIndex) {
            const q = challengeState.questions[challengeState.currentQuestion];
            const options = document.querySelectorAll('.challenge-option');

            options.forEach((opt, i) => {
                opt.disabled = true;
                if (i === q.answer) {
                    opt.classList.add('correct');
                } else if (i === selectedIndex && selectedIndex !== q.answer) {
                    opt.classList.add('incorrect');
                }
            });

            if (selectedIndex === q.answer) {
                challengeState.correct++;
                // More points for harder difficulty and remaining time
                let points = 10;
                if (challengeState.difficulty === 'medium') points = 15;
                if (challengeState.difficulty === 'hard') points = 25;
                points += Math.floor(challengeState.timeRemaining / 5); // Bonus for speed
                challengeState.score += points;
            }

            // Move to next question after delay
            setTimeout(() => {
                challengeState.currentQuestion++;
                if (challengeState.currentQuestion >= challengeState.totalQuestions) {
                    endChallenge();
                } else {
                    showChallengeQuestion();
                }
            }, 1000);
        }

        function endChallenge() {
            clearInterval(challengeState.timer);

            document.getElementById('challenge-game').style.display = 'none';
            document.getElementById('challenge-result').style.display = 'block';

            document.getElementById('challenge-final-score').textContent = challengeState.score;

            // Calculate XP reward
            let xpReward = challengeState.score;
            if (challengeState.correct === challengeState.totalQuestions) {
                xpReward += 50; // Perfect bonus
            }

            document.getElementById('challenge-reward').textContent = `+${xpReward} XP Bonus!`;

            // Award XP
            if (typeof addXP === 'function') {
                addXP(xpReward);
            }

            // Track stats
            let challengeStats = JSON.parse(localStorage.getItem('challengeStats')) || { played: 0, won: 0, totalScore: 0 };
            challengeStats.played++;
            challengeStats.totalScore += challengeState.score;
            if (challengeState.correct >= challengeState.totalQuestions / 2) {
                challengeStats.won++;
            }
            localStorage.setItem('challengeStats', JSON.stringify(challengeStats));
        }

        function quitChallenge() {
            if (confirm('Are you sure you want to quit? Your progress will be lost.')) {
                clearInterval(challengeState.timer);
                closeChallenge();
            }
        }

        function resetChallenge() {
            document.getElementById('challenge-setup').style.display = 'block';
            document.getElementById('challenge-game').style.display = 'none';
            document.getElementById('challenge-result').style.display = 'none';
        }

        // Keyboard shortcut for challenge mode
        document.addEventListener('keydown', function(e) {
            if (e.key === 'c' && e.ctrlKey && e.shiftKey) {
                e.preventDefault();
                openChallenge();
            }
        });

        console.log(' Note-Taking, Bookmarks, and Challenge Mode loaded!');
    </script>

    <!-- ========== BATCH 36: Sound Effects, Parent Dashboard, Study Timer ========== -->

    <!-- Parent Dashboard Modal -->
    <div class="parent-dashboard-modal" id="parent-dashboard-modal">
        <div class="parent-dashboard-container">
            <div class="parent-dashboard-header">
                <h2> Parent Dashboard</h2>
                <button onclick="closeParentDashboard()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="parent-dashboard-body">
                <div class="parent-stats-grid">
                    <div class="parent-stat-card">
                        <div class="stat-label">Total Study Time</div>
                        <div class="stat-value" id="parent-total-time">0h</div>
                        <div class="stat-trend positive" id="parent-time-trend">This week</div>
                    </div>
                    <div class="parent-stat-card">
                        <div class="stat-label">Questions Answered</div>
                        <div class="stat-value" id="parent-questions">0</div>
                        <div class="stat-trend positive" id="parent-questions-trend">Total</div>
                    </div>
                    <div class="parent-stat-card">
                        <div class="stat-label">Current Level</div>
                        <div class="stat-value" id="parent-level">1</div>
                        <div class="stat-trend" id="parent-xp-trend">XP Progress</div>
                    </div>
                    <div class="parent-stat-card">
                        <div class="stat-label">Study Streak</div>
                        <div class="stat-value" id="parent-streak">0</div>
                        <div class="stat-trend" id="parent-streak-trend">Days</div>
                    </div>
                </div>

                <div class="parent-section">
                    <h3>Weekly Progress</h3>
                    <p style="color: #666; margin-bottom: 15px;">Goal: Study at least 30 minutes daily</p>
                    <div class="parent-progress-bar">
                        <div class="parent-progress-fill" id="parent-weekly-progress" style="width: 0%;"></div>
                        <span class="parent-progress-text" id="parent-weekly-text">0/7 days</span>
                    </div>
                </div>

                <div class="parent-section">
                    <h3>Recent Activity</h3>
                    <div class="activity-log" id="parent-activity-log">
                        <p style="color: #999; text-align: center;">No recent activity</p>
                    </div>
                </div>

                <div class="parent-section">
                    <h3>Performance Summary</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <p style="color: #666; margin-bottom: 5px;">Accuracy Rate</p>
                            <div class="parent-progress-bar" style="height: 20px;">
                                <div class="parent-progress-fill" id="parent-accuracy-bar" style="width: 0%;"></div>
                                <span class="parent-progress-text" id="parent-accuracy-text">0%</span>
                            </div>
                        </div>
                        <div>
                            <p style="color: #666; margin-bottom: 5px;">Challenge Wins</p>
                            <div class="parent-progress-bar" style="height: 20px;">
                                <div class="parent-progress-fill" id="parent-challenge-bar" style="width: 0%; background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);"></div>
                                <span class="parent-progress-text" id="parent-challenge-text">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Study Timer Modal -->
    <div class="study-timer-modal" id="study-timer-modal">
        <div class="study-timer-container">
            <div class="study-timer-header">
                <h2> Study Timer</h2>
            </div>
            <div class="study-timer-body">
                <div class="timer-display" id="study-timer-display">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn primary" id="timer-start-btn" onclick="toggleStudyTimer()">Start</button>
                    <button class="timer-btn danger" onclick="resetStudyTimer()">Reset</button>
                    <button class="timer-btn" onclick="closeStudyTimer()">Close</button>
                </div>
                <div class="study-stats-today">
                    <h4>Today's Study Stats</h4>
                    <div class="study-stats-row">
                        <span class="label">Time Studied Today</span>
                        <span class="value" id="today-study-time">0 min</span>
                    </div>
                    <div class="study-stats-row">
                        <span class="label">Sessions Completed</span>
                        <span class="value" id="today-sessions">0</span>
                    </div>
                    <div class="study-stats-row">
                        <span class="label">Daily Goal (30 min)</span>
                        <span class="value" id="daily-goal-status">Not reached</span>
                    </div>
                    <div class="daily-goal-progress">
                        <div class="daily-goal-fill" id="daily-goal-fill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <button class="sound-toggle" id="sound-toggle" onclick="toggleSound()" title="Toggle Sound"></button>
    <button class="floating-parent-btn" onclick="openParentDashboard()" title="Parent Dashboard"></button>
    <button class="floating-timer-btn" id="floating-timer-btn" onclick="openStudyTimer()" title="Study Timer"></button>

    <script>
        // ========== BATCH 36: Sound Effects, Parent Dashboard, Study Timer ==========

        // Sound Effects System
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (!soundEnabled) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (type === 'correct') {
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
            } else if (type === 'incorrect') {
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'levelup') {
                const notes = [523.25, 659.25, 783.99, 1046.50];
                notes.forEach((freq, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.15);
                    gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.15);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.15 + 0.3);
                    osc.start(audioContext.currentTime + i * 0.15);
                    osc.stop(audioContext.currentTime + i * 0.15 + 0.3);
                });
            } else if (type === 'click') {
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.05);
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('soundEnabled', soundEnabled);
            updateSoundButton();
            if (soundEnabled) {
                playSound('click');
            }
        }

        function updateSoundButton() {
            const btn = document.getElementById('sound-toggle');
            if (soundEnabled) {
                btn.textContent = '';
                btn.classList.remove('muted');
            } else {
                btn.textContent = '';
                btn.classList.add('muted');
            }
        }

        updateSoundButton();

        // Parent Dashboard System
        function openParentDashboard() {
            document.getElementById('parent-dashboard-modal').style.display = 'flex';
            updateParentDashboard();
        }

        function closeParentDashboard() {
            document.getElementById('parent-dashboard-modal').style.display = 'none';
        }

        function updateParentDashboard() {
            // Get study time data
            const studyData = JSON.parse(localStorage.getItem('studyTimeData')) || { totalMinutes: 0, sessions: 0, dailyMinutes: {} };
            const totalHours = Math.floor(studyData.totalMinutes / 60);
            const totalMins = studyData.totalMinutes % 60;
            document.getElementById('parent-total-time').textContent = totalHours > 0 ? `${totalHours}h ${totalMins}m` : `${totalMins}m`;

            // Get XP and level
            const xp = parseInt(localStorage.getItem('scienceXP')) || 0;
            const level = parseInt(localStorage.getItem('scienceLevel')) || 1;
            document.getElementById('parent-level').textContent = level;
            document.getElementById('parent-xp-trend').textContent = `${xp} XP total`;

            // Get questions answered
            const questionsAnswered = parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0;
            document.getElementById('parent-questions').textContent = questionsAnswered;

            // Get streak
            const streak = parseInt(localStorage.getItem('studyStreak')) || 0;
            document.getElementById('parent-streak').textContent = streak;

            // Calculate weekly progress
            const today = new Date();
            let daysStudied = 0;
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                if (studyData.dailyMinutes && studyData.dailyMinutes[dateKey] >= 30) {
                    daysStudied++;
                }
            }
            document.getElementById('parent-weekly-progress').style.width = `${(daysStudied / 7) * 100}%`;
            document.getElementById('parent-weekly-text').textContent = `${daysStudied}/7 days`;

            // Get accuracy
            const correctAnswers = parseInt(localStorage.getItem('correctAnswers')) || 0;
            const accuracy = questionsAnswered > 0 ? Math.round((correctAnswers / questionsAnswered) * 100) : 0;
            document.getElementById('parent-accuracy-bar').style.width = `${accuracy}%`;
            document.getElementById('parent-accuracy-text').textContent = `${accuracy}%`;

            // Get challenge stats
            const challengeStats = JSON.parse(localStorage.getItem('challengeStats')) || { played: 0, won: 0 };
            const winRate = challengeStats.played > 0 ? Math.round((challengeStats.won / challengeStats.played) * 100) : 0;
            document.getElementById('parent-challenge-bar').style.width = `${winRate}%`;
            document.getElementById('parent-challenge-text').textContent = `${winRate}%`;

            // Get activity log
            const activityLog = JSON.parse(localStorage.getItem('activityLog')) || [];
            const activityContainer = document.getElementById('parent-activity-log');
            if (activityLog.length > 0) {
                activityContainer.innerHTML = activityLog.slice(0, 10).map(activity => `
                    <div class="activity-item">
                        <span class="activity-text">${activity.text}</span>
                        <span class="activity-time">${activity.time}</span>
                    </div>
                `).join('');
            }
        }

        function logActivity(text) {
            const activityLog = JSON.parse(localStorage.getItem('activityLog')) || [];
            activityLog.unshift({
                text: text,
                time: new Date().toLocaleString()
            });
            // Keep only last 50 activities
            if (activityLog.length > 50) activityLog.pop();
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
        }

        // Study Timer System
        let studyTimerInterval = null;
        let studyTimerSeconds = 0;
        let isTimerRunning = false;

        function openStudyTimer() {
            document.getElementById('study-timer-modal').style.display = 'flex';
            updateTodayStats();
        }

        function closeStudyTimer() {
            document.getElementById('study-timer-modal').style.display = 'none';
        }

        function toggleStudyTimer() {
            if (isTimerRunning) {
                pauseStudyTimer();
            } else {
                startStudyTimer();
            }
        }

        function startStudyTimer() {
            isTimerRunning = true;
            document.getElementById('timer-start-btn').textContent = 'Pause';
            document.getElementById('floating-timer-btn').classList.add('timer-running');

            studyTimerInterval = setInterval(() => {
                studyTimerSeconds++;
                updateTimerDisplay2();

                // Save every minute
                if (studyTimerSeconds % 60 === 0) {
                    saveStudyTime(1);
                    updateTodayStats();
                }
            }, 1000);

            playSound('click');
        }

        function pauseStudyTimer() {
            isTimerRunning = false;
            document.getElementById('timer-start-btn').textContent = 'Resume';
            document.getElementById('floating-timer-btn').classList.remove('timer-running');
            clearInterval(studyTimerInterval);

            // Save remaining seconds as partial minute
            const remainingSeconds = studyTimerSeconds % 60;
            if (remainingSeconds >= 30) {
                saveStudyTime(1);
            }

            playSound('click');
        }

        function resetStudyTimer() {
            if (isTimerRunning) {
                pauseStudyTimer();
            }

            // Save session if significant time was spent
            if (studyTimerSeconds >= 60) {
                const studyData = JSON.parse(localStorage.getItem('studyTimeData')) || { totalMinutes: 0, sessions: 0, dailyMinutes: {} };
                studyData.sessions++;
                localStorage.setItem('studyTimeData', JSON.stringify(studyData));
                logActivity(`Completed study session (${formatTime(studyTimerSeconds)})`);
            }

            studyTimerSeconds = 0;
            updateTimerDisplay2();
            document.getElementById('timer-start-btn').textContent = 'Start';
            updateTodayStats();

            playSound('click');
        }

        function updateTimerDisplay2() {
            const hours = Math.floor(studyTimerSeconds / 3600);
            const minutes = Math.floor((studyTimerSeconds % 3600) / 60);
            const seconds = studyTimerSeconds % 60;
            document.getElementById('study-timer-display').textContent =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m ${seconds}s`;
        }

        function saveStudyTime(minutes) {
            const studyData = JSON.parse(localStorage.getItem('studyTimeData')) || { totalMinutes: 0, sessions: 0, dailyMinutes: {} };
            studyData.totalMinutes += minutes;

            const today = new Date().toISOString().split('T')[0];
            studyData.dailyMinutes = studyData.dailyMinutes || {};
            studyData.dailyMinutes[today] = (studyData.dailyMinutes[today] || 0) + minutes;

            localStorage.setItem('studyTimeData', JSON.stringify(studyData));

            // Award XP for study time
            if (typeof addXP === 'function' && studyData.dailyMinutes[today] % 5 === 0) {
                addXP(2);
            }
        }

        function updateTodayStats() {
            const studyData = JSON.parse(localStorage.getItem('studyTimeData')) || { totalMinutes: 0, sessions: 0, dailyMinutes: {} };
            const today = new Date().toISOString().split('T')[0];
            const todayMinutes = studyData.dailyMinutes?.[today] || 0;

            document.getElementById('today-study-time').textContent = `${todayMinutes} min`;
            document.getElementById('today-sessions').textContent = studyData.sessions || 0;

            const goalReached = todayMinutes >= 30;
            document.getElementById('daily-goal-status').textContent = goalReached ? 'Reached! ' : 'Not yet';
            document.getElementById('daily-goal-status').style.color = goalReached ? '#4CAF50' : 'white';

            const progress = Math.min((todayMinutes / 30) * 100, 100);
            document.getElementById('daily-goal-fill').style.width = `${progress}%`;
        }

        console.log(' Sound Effects, Parent Dashboard, and Study Timer loaded!');
    </script>

    <!-- ========== BATCH 37: Motivational Messages, Topic Mastery, Science Quotes ========== -->

    <!-- Motivation Toast -->
    <div class="motivation-toast" id="motivation-toast">
        <span class="motivation-icon"></span>
        <span id="motivation-text">You're doing great!</span>
    </div>

    <!-- Topic Mastery Modal -->
    <div class="mastery-modal" id="mastery-modal">
        <div class="mastery-container">
            <div class="mastery-header">
                <h2> Topic Mastery</h2>
                <button onclick="closeMastery()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="mastery-body" id="mastery-body">
            </div>
        </div>
    </div>

    <!-- Science Quotes Modal -->
    <div class="quotes-modal" id="quotes-modal">
        <div class="quotes-container">
            <div class="quotes-header">
                <h2> Science Wisdom</h2>
            </div>
            <div class="quotes-body">
                <div class="quote-text" id="quote-text">"The important thing is not to stop questioning."</div>
                <div class="quote-author" id="quote-author">Albert Einstein</div>
            </div>
            <div class="quotes-controls">
                <button class="quote-btn primary" onclick="nextQuote()">Next Quote</button>
                <button class="quote-btn" onclick="closeQuotes()">Close</button>
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <button class="floating-mastery-btn" onclick="openMastery()" title="Topic Mastery"></button>
    <button class="floating-quotes-btn" onclick="openQuotes()" title="Science Quotes"></button>

    <script>
        // ========== BATCH 37: Motivational Messages, Topic Mastery, Science Quotes ==========

        // Motivational Messages System
        const motivationalMessages = [
            { icon: '', text: "You're doing great! Keep it up!" },
            { icon: '', text: "Every question makes you smarter!" },
            { icon: '', text: "You're on fire today!" },
            { icon: '', text: "Practice makes perfect!" },
            { icon: '', text: "Your brain is getting stronger!" },
            { icon: '', text: "Champions never give up!" },
            { icon: '', text: "You're becoming a science expert!" },
            { icon: '', text: "What an amazing streak!" },
            { icon: '', text: "Fantastic work! You're crushing it!" },
            { icon: '', text: "Mistakes help us learn. Keep going!" },
            { icon: '', text: "Hard work pays off!" },
            { icon: '', text: "You're a science superhero!" },
            { icon: '', text: "Future scientist in the making!" },
            { icon: '', text: "Your knowledge is growing!" },
            { icon: '', text: "You're a star student!" }
        ];

        let motivationTimeout = null;

        function showMotivation(customMessage = null) {
            const toast = document.getElementById('motivation-toast');
            const textEl = document.getElementById('motivation-text');
            const iconEl = toast.querySelector('.motivation-icon');

            let message;
            if (customMessage) {
                message = { icon: '', text: customMessage };
            } else {
                message = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
            }

            iconEl.textContent = message.icon;
            textEl.textContent = message.text;

            toast.classList.add('show');

            if (motivationTimeout) clearTimeout(motivationTimeout);
            motivationTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Show motivation on certain events
        let questionsAnsweredForMotivation = 0;

        function triggerMotivationCheck() {
            questionsAnsweredForMotivation++;
            // Show motivation every 3 questions
            if (questionsAnsweredForMotivation % 3 === 0) {
                setTimeout(() => showMotivation(), 500);
            }
        }

        // Topic Mastery System
        const scienceTopics = [
            { id: 'heat', name: 'Heat & Temperature', icon: '' },
            { id: 'light', name: 'Light & Shadows', icon: '' },
            { id: 'electricity', name: 'Electricity & Circuits', icon: '' },
            { id: 'forces', name: 'Forces & Motion', icon: '' },
            { id: 'plants', name: 'Plants & Photosynthesis', icon: '' },
            { id: 'animals', name: 'Animals & Classification', icon: '' },
            { id: 'human-body', name: 'Human Body Systems', icon: '' },
            { id: 'matter', name: 'Matter & Materials', icon: '' },
            { id: 'water-cycle', name: 'Water Cycle', icon: '' },
            { id: 'earth', name: 'Earth & Space', icon: '' }
        ];

        function openMastery() {
            document.getElementById('mastery-modal').style.display = 'flex';
            renderMasteryTopics();
        }

        function closeMastery() {
            document.getElementById('mastery-modal').style.display = 'none';
        }

        function getMasteryData() {
            return JSON.parse(localStorage.getItem('topicMastery')) || {};
        }

        function updateTopicMastery(topicId, correct) {
            const mastery = getMasteryData();
            if (!mastery[topicId]) {
                mastery[topicId] = { correct: 0, total: 0 };
            }
            mastery[topicId].total++;
            if (correct) mastery[topicId].correct++;
            localStorage.setItem('topicMastery', JSON.stringify(mastery));
        }

        function getStars(percentage) {
            if (percentage >= 90) return '';
            if (percentage >= 75) return '';
            if (percentage >= 60) return '';
            if (percentage >= 40) return '';
            if (percentage >= 20) return '';
            return '';
        }

        function renderMasteryTopics() {
            const container = document.getElementById('mastery-body');
            const mastery = getMasteryData();

            container.innerHTML = scienceTopics.map(topic => {
                const data = mastery[topic.id] || { correct: 0, total: 0 };
                const percentage = data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0;
                const stars = getStars(percentage);

                return `
                    <div class="mastery-topic">
                        <div class="mastery-topic-header">
                            <span class="mastery-topic-name">${topic.icon} ${topic.name}</span>
                            <div class="mastery-level">
                                <span class="mastery-stars">${stars}</span>
                                <span class="mastery-percentage">${percentage}%</span>
                            </div>
                        </div>
                        <div class="mastery-progress-bar">
                            <div class="mastery-progress-fill" style="width: ${percentage}%;"></div>
                        </div>
                        <div class="mastery-stats">
                            <span>${data.correct} correct</span>
                            <span>${data.total} attempted</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Science Quotes System
        const scienceQuotes = [
            { text: "The important thing is not to stop questioning.", author: "Albert Einstein" },
            { text: "Science is a way of thinking much more than it is a body of knowledge.", author: "Carl Sagan" },
            { text: "Somewhere, something incredible is waiting to be known.", author: "Carl Sagan" },
            { text: "The good thing about science is that it's true whether or not you believe in it.", author: "Neil deGrasse Tyson" },
            { text: "Research is what I'm doing when I don't know what I'm doing.", author: "Wernher von Braun" },
            { text: "Nothing in life is to be feared, it is only to be understood.", author: "Marie Curie" },
            { text: "Equipped with his five senses, man explores the universe around him.", author: "Edwin Hubble" },
            { text: "I have not failed. I've just found 10,000 ways that won't work.", author: "Thomas Edison" },
            { text: "In science there is only physics; all the rest is stamp collecting.", author: "Lord Kelvin" },
            { text: "Science is magic that works.", author: "Kurt Vonnegut" },
            { text: "The universe is made of stories, not of atoms.", author: "Muriel Rukeyser" },
            { text: "The scientist is not a person who gives the right answers, but one who asks the right questions.", author: "Claude Lvi-Strauss" },
            { text: "An experiment is a question which science poses to Nature.", author: "Max Planck" },
            { text: "Every great advance in science has issued from a new audacity of imagination.", author: "John Dewey" },
            { text: "Be curious. Read widely. Try new things.", author: "Neil Gaiman" },
            { text: "The only true wisdom is in knowing you know nothing.", author: "Socrates" },
            { text: "Science knows no country, because knowledge belongs to humanity.", author: "Louis Pasteur" },
            { text: "I think, at a child's birth, if a mother could ask a fairy godmother to endow it with the most useful gift, that gift should be curiosity.", author: "Eleanor Roosevelt" },
            { text: "Logic will get you from A to B. Imagination will take you everywhere.", author: "Albert Einstein" },
            { text: "The important thing is to never stop questioning.", author: "Albert Einstein" }
        ];

        let currentQuoteIndex = 0;

        function openQuotes() {
            document.getElementById('quotes-modal').style.display = 'flex';
            showRandomQuote();
        }

        function closeQuotes() {
            document.getElementById('quotes-modal').style.display = 'none';
        }

        function showRandomQuote() {
            currentQuoteIndex = Math.floor(Math.random() * scienceQuotes.length);
            displayQuote();
        }

        function nextQuote() {
            currentQuoteIndex = (currentQuoteIndex + 1) % scienceQuotes.length;
            displayQuote();
        }

        function displayQuote() {
            const quote = scienceQuotes[currentQuoteIndex];
            document.getElementById('quote-text').textContent = `"${quote.text}"`;
            document.getElementById('quote-author').textContent = quote.author;
        }

        // Show a random quote on page load sometimes
        if (Math.random() < 0.2) { // 20% chance
            setTimeout(() => {
                showMotivation(scienceQuotes[Math.floor(Math.random() * scienceQuotes.length)].text);
            }, 3000);
        }

        console.log(' Motivational Messages, Topic Mastery, and Science Quotes loaded!');
    </script>

    <!-- ========== BATCH 38: Power-ups, Daily Login Reward, Quick Review ========== -->

    <!-- Power-ups Modal -->
    <div class="powerups-modal" id="powerups-modal">
        <div class="powerups-container">
            <div class="powerups-header">
                <h2> Power-ups Shop</h2>
                <button onclick="closePowerups()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="powerups-body" id="powerups-body">
            </div>
        </div>
    </div>

    <!-- Daily Login Reward Modal -->
    <div class="daily-reward-modal" id="daily-reward-modal">
        <div class="daily-reward-container">
            <div class="daily-reward-header">
                <h2> Daily Reward!</h2>
            </div>
            <div class="daily-reward-body">
                <div class="daily-streak-display" id="daily-streak-num">1</div>
                <div class="daily-streak-label">Day Streak</div>
                <div class="daily-reward-box">
                    <span class="reward-icon" id="reward-icon"></span>
                    <span class="reward-amount" id="reward-amount">+10 XP</span>
                </div>
                <button class="daily-reward-btn" onclick="claimDailyReward()">Claim Reward!</button>
            </div>
        </div>
    </div>

    <!-- Quick Review Modal -->
    <div class="quick-review-modal" id="quick-review-modal">
        <div class="quick-review-container">
            <div class="quick-review-header">
                <h2> Quick Review</h2>
                <button onclick="closeQuickReview()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="quick-review-body" id="quick-review-body">
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <button class="floating-powerups-btn" onclick="openPowerups()" title="Power-ups"></button>
    <button class="floating-review-btn" onclick="openQuickReview()" title="Quick Review"></button>

    <script>
        // ========== BATCH 38: Power-ups, Daily Login Reward, Quick Review ==========

        // Power-ups System
        const powerupDefinitions = [
            { id: 'double-xp', name: 'Double XP', icon: '2', desc: 'Double XP for your next 5 questions!', cost: 50, duration: 5 },
            { id: 'hint-pack', name: 'Hint Pack', icon: '', desc: 'Get 5 extra hints to use on tough questions.', cost: 30, amount: 5 },
            { id: 'streak-shield', name: 'Streak Shield', icon: '', desc: 'Protect your streak from one wrong answer!', cost: 75, amount: 1 },
            { id: 'time-freeze', name: 'Time Freeze', icon: '', desc: 'Freeze the timer in Challenge Mode for 10 seconds!', cost: 40, amount: 1 },
            { id: 'bonus-spin', name: 'Bonus Spin', icon: '', desc: 'Spin for a random bonus (10-100 XP)!', cost: 25, amount: 1 }
        ];

        function getPowerups() {
            return JSON.parse(localStorage.getItem('sciencePowerups')) || {};
        }

        function savePowerups(powerups) {
            localStorage.setItem('sciencePowerups', JSON.stringify(powerups));
        }

        function openPowerups() {
            document.getElementById('powerups-modal').style.display = 'flex';
            renderPowerups();
        }

        function closePowerups() {
            document.getElementById('powerups-modal').style.display = 'none';
        }

        function renderPowerups() {
            const container = document.getElementById('powerups-body');
            const owned = getPowerups();
            const xp = parseInt(localStorage.getItem('scienceXP')) || 0;

            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px; color: #ffd700; font-size: 1.2rem;">
                    Your XP: <strong>${xp}</strong>
                </div>
                ${powerupDefinitions.map(powerup => {
                    const count = owned[powerup.id] || 0;
                    const canAfford = xp >= powerup.cost;
                    return `
                        <div class="powerup-card ${count > 0 ? 'owned' : ''}">
                            <div class="powerup-icon">${powerup.icon}</div>
                            <div class="powerup-info">
                                <div class="powerup-name">${powerup.name}</div>
                                <div class="powerup-desc">${powerup.desc}</div>
                                <div class="powerup-count">Owned: ${count}</div>
                            </div>
                            <div class="powerup-action">
                                <button class="powerup-btn" onclick="buyPowerup('${powerup.id}')" ${!canAfford ? 'disabled' : ''}>
                                    Buy
                                </button>
                                <div class="powerup-cost">${powerup.cost} XP</div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function buyPowerup(powerupId) {
            const powerup = powerupDefinitions.find(p => p.id === powerupId);
            const xp = parseInt(localStorage.getItem('scienceXP')) || 0;

            if (xp < powerup.cost) {
                alert('Not enough XP!');
                return;
            }

            // Deduct XP
            localStorage.setItem('scienceXP', xp - powerup.cost);

            // Add powerup
            const owned = getPowerups();
            owned[powerupId] = (owned[powerupId] || 0) + (powerup.amount || 1);
            savePowerups(owned);

            // Special handling for bonus spin
            if (powerupId === 'bonus-spin') {
                const bonus = Math.floor(Math.random() * 91) + 10; // 10-100
                localStorage.setItem('scienceXP', parseInt(localStorage.getItem('scienceXP')) + bonus);
                owned[powerupId]--;
                savePowerups(owned);
                alert(` You won ${bonus} XP!`);
            }

            renderPowerups();
            if (typeof playSound === 'function') playSound('correct');
        }

        function usePowerup(powerupId) {
            const owned = getPowerups();
            if (!owned[powerupId] || owned[powerupId] <= 0) return false;
            owned[powerupId]--;
            savePowerups(owned);
            return true;
        }

        // Daily Login Reward System
        function checkDailyReward() {
            const lastLogin = localStorage.getItem('lastLoginDate');
            const today = new Date().toISOString().split('T')[0];

            if (lastLogin !== today) {
                // Calculate streak
                const lastDate = lastLogin ? new Date(lastLogin) : null;
                const todayDate = new Date(today);
                let streak = parseInt(localStorage.getItem('loginStreak')) || 0;

                if (lastDate) {
                    const diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                    if (diffDays === 1) {
                        streak++;
                    } else if (diffDays > 1) {
                        streak = 1;
                    }
                } else {
                    streak = 1;
                }

                localStorage.setItem('loginStreak', streak);
                localStorage.setItem('pendingDailyReward', 'true');

                // Show reward modal
                showDailyReward(streak);
            }
        }

        function showDailyReward(streak) {
            document.getElementById('daily-streak-num').textContent = streak;

            // Calculate reward based on streak
            let reward = 10 + (streak * 5);
            if (streak >= 7) reward += 20; // Weekly bonus
            if (streak >= 30) reward += 50; // Monthly bonus

            let icon = '';
            if (streak >= 7) icon = '';
            if (streak >= 30) icon = '';

            document.getElementById('reward-icon').textContent = icon;
            document.getElementById('reward-amount').textContent = `+${reward} XP`;
            document.getElementById('daily-reward-modal').dataset.reward = reward;

            document.getElementById('daily-reward-modal').style.display = 'flex';
        }

        function claimDailyReward() {
            const reward = parseInt(document.getElementById('daily-reward-modal').dataset.reward) || 10;
            const today = new Date().toISOString().split('T')[0];

            localStorage.setItem('lastLoginDate', today);
            localStorage.removeItem('pendingDailyReward');

            // Add XP
            if (typeof addXP === 'function') {
                addXP(reward);
            } else {
                const currentXP = parseInt(localStorage.getItem('scienceXP')) || 0;
                localStorage.setItem('scienceXP', currentXP + reward);
            }

            document.getElementById('daily-reward-modal').style.display = 'none';

            if (typeof playSound === 'function') playSound('levelup');
            if (typeof showMotivation === 'function') showMotivation(`Welcome back! +${reward} XP!`);
        }

        // Quick Review System
        function openQuickReview() {
            document.getElementById('quick-review-modal').style.display = 'flex';
            renderQuickReview();
        }

        function closeQuickReview() {
            document.getElementById('quick-review-modal').style.display = 'none';
        }

        function getWrongAnswers() {
            return JSON.parse(localStorage.getItem('wrongAnswersLog')) || [];
        }

        function logWrongAnswer(topic, question, yourAnswer, correctAnswer) {
            const log = getWrongAnswers();
            log.unshift({
                topic: topic,
                question: question,
                yourAnswer: yourAnswer,
                correctAnswer: correctAnswer,
                date: new Date().toLocaleDateString()
            });
            // Keep only last 50
            if (log.length > 50) log.pop();
            localStorage.setItem('wrongAnswersLog', JSON.stringify(log));
        }

        function clearWrongAnswer(index) {
            const log = getWrongAnswers();
            log.splice(index, 1);
            localStorage.setItem('wrongAnswersLog', JSON.stringify(log));
            renderQuickReview();
        }

        function renderQuickReview() {
            const container = document.getElementById('quick-review-body');
            const wrongAnswers = getWrongAnswers();

            if (wrongAnswers.length === 0) {
                container.innerHTML = `
                    <div class="review-empty">
                        <div class="review-empty-icon"></div>
                        <h3>No Wrong Answers!</h3>
                        <p>Great job! You haven't made any mistakes yet.<br>Keep up the excellent work!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <p style="color: #666; margin-bottom: 15px;">Review your mistakes to learn from them. Click the  to mark as mastered.</p>
                ${wrongAnswers.map((item, index) => `
                    <div class="review-card">
                        <div class="review-card-header">
                            <span class="review-topic">${item.topic}</span>
                            <span class="review-date">${item.date}</span>
                        </div>
                        <div class="review-question">${item.question}</div>
                        <div class="review-answers">
                            <div class="review-answer wrong">
                                <strong>Your Answer:</strong><br>${item.yourAnswer}
                            </div>
                            <div class="review-answer correct">
                                <strong>Correct Answer:</strong><br>${item.correctAnswer}
                            </div>
                        </div>
                        <button onclick="clearWrongAnswer(${index})" style="margin-top: 10px; background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                             I've learned this
                        </button>
                    </div>
                `).join('')}
            `;
        }

        // Check for daily reward on load
        setTimeout(checkDailyReward, 1000);

        console.log(' Power-ups, Daily Login Reward, and Quick Review loaded!');
    </script>

    <!-- ========== BATCH 39: Science Jokes, Mind Map, Favorite Topics ========== -->

    <!-- Jokes Modal -->
    <div class="jokes-modal" id="jokes-modal">
        <div class="jokes-container">
            <div class="jokes-header">
                <h2> Science Jokes</h2>
            </div>
            <div class="jokes-body">
                <div class="joke-setup" id="joke-setup">Why did the biology teacher break up with the physics teacher?</div>
                <div class="joke-punchline" id="joke-punchline">Because there was no chemistry!</div>
            </div>
            <div class="jokes-controls">
                <button class="joke-btn" id="reveal-btn" onclick="revealPunchline()">Tell Me! </button>
                <button class="joke-btn" onclick="nextJoke()">Next Joke</button>
                <button class="joke-btn" onclick="closeJokes()">Close</button>
            </div>
        </div>
    </div>

    <!-- Mind Map Modal -->
    <div class="mindmap-modal" id="mindmap-modal">
        <div class="mindmap-container">
            <div class="mindmap-header">
                <h2> Science Mind Map</h2>
                <button onclick="closeMindmap()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="mindmap-body">
                <select id="mindmap-topic-select" onchange="showMindmapTopic(this.value)" style="width: 100%; padding: 12px; border-radius: 10px; font-size: 1rem; margin-bottom: 20px; border: 2px solid #00bcd4;">
                    <option value="heat">Heat & Temperature</option>
                    <option value="light">Light</option>
                    <option value="electricity">Electricity</option>
                    <option value="matter">Matter</option>
                    <option value="plants">Plants</option>
                </select>
                <div class="mindmap-tree" id="mindmap-content">
                </div>
            </div>
        </div>
    </div>

    <!-- Favorites Modal -->
    <div class="favorites-modal" id="favorites-modal">
        <div class="favorites-container">
            <div class="favorites-header">
                <h2> Favorite Topics</h2>
                <button onclick="closeFavorites()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="favorites-body" id="favorites-body">
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <button class="floating-jokes-btn" onclick="openJokes()" title="Science Jokes"></button>
    <button class="floating-mindmap-btn" onclick="openMindmap()" title="Mind Map"></button>
    <button class="floating-favorites-btn" onclick="openFavorites()" title="Favorites"></button>

    <script>
        // ========== BATCH 39: Science Jokes, Mind Map, Favorite Topics ==========

        // Science Jokes System
        const scienceJokes = [
            { setup: "Why did the biology teacher break up with the physics teacher?", punchline: "Because there was no chemistry!" },
            { setup: "What did the science book say to the math book?", punchline: "Wow, you've got a lot of problems!" },
            { setup: "Why can you never trust atoms?", punchline: "Because they make up everything!" },
            { setup: "What do you call a fish without eyes?", punchline: "A fsh!" },
            { setup: "Why did the sun go to school?", punchline: "To get brighter!" },
            { setup: "What's a light year?", punchline: "The same as a regular year, but with fewer calories!" },
            { setup: "Why are chemists great at solving problems?", punchline: "They have all the solutions!" },
            { setup: "What did the limestone say to the geologist?", punchline: "Don't take me for granite!" },
            { setup: "Why did the photon check into a hotel?", punchline: "Because it was traveling light!" },
            { setup: "What do you do with a sick chemist?", punchline: "If you can't helium, and you can't curium, you might as well barium!" },
            { setup: "How does the moon cut his hair?", punchline: "Eclipse it!" },
            { setup: "Why is the mushroom always invited to parties?", punchline: "Because he's a fungi!" },
            { setup: "What is a tornado's favorite game?", punchline: "Twister!" },
            { setup: "Why do plants hate math?", punchline: "It gives them square roots!" },
            { setup: "What do planets like to read?", punchline: "Comet books!" }
        ];

        let currentJokeIndex = 0;

        function openJokes() {
            document.getElementById('jokes-modal').style.display = 'flex';
            showRandomJoke();
        }

        function closeJokes() {
            document.getElementById('jokes-modal').style.display = 'none';
        }

        function showRandomJoke() {
            currentJokeIndex = Math.floor(Math.random() * scienceJokes.length);
            displayJoke();
        }

        function nextJoke() {
            currentJokeIndex = (currentJokeIndex + 1) % scienceJokes.length;
            displayJoke();
        }

        function displayJoke() {
            const joke = scienceJokes[currentJokeIndex];
            document.getElementById('joke-setup').textContent = joke.setup;
            document.getElementById('joke-punchline').textContent = joke.punchline;
            document.getElementById('joke-punchline').classList.remove('revealed');
            document.getElementById('reveal-btn').style.display = 'inline-block';
        }

        function revealPunchline() {
            document.getElementById('joke-punchline').classList.add('revealed');
            document.getElementById('reveal-btn').style.display = 'none';
        }

        // Mind Map System
        const mindmapData = {
            heat: {
                title: "Heat & Temperature",
                branches: [
                    { title: "Heat Transfer", leaves: ["Conduction", "Convection", "Radiation"] },
                    { title: "Conductors", leaves: ["Metal", "Good conductors", "Transfer heat quickly"] },
                    { title: "Insulators", leaves: ["Plastic", "Wood", "Rubber", "Poor conductors"] },
                    { title: "Applications", leaves: ["Cooking", "Insulation", "Cooling systems"] }
                ]
            },
            light: {
                title: "Light",
                branches: [
                    { title: "Properties", leaves: ["Travels in straight lines", "Can be reflected", "Can be refracted"] },
                    { title: "Shadows", leaves: ["Umbra", "Penumbra", "Opaque objects"] },
                    { title: "Mirrors", leaves: ["Plane mirrors", "Reflection", "Virtual images"] },
                    { title: "Lenses", leaves: ["Convex", "Concave", "Magnification"] }
                ]
            },
            electricity: {
                title: "Electricity",
                branches: [
                    { title: "Circuits", leaves: ["Series circuit", "Parallel circuit", "Open/closed"] },
                    { title: "Components", leaves: ["Battery", "Bulb", "Switch", "Wire"] },
                    { title: "Conductors", leaves: ["Metals", "Water", "Graphite"] },
                    { title: "Safety", leaves: ["Insulators", "Circuit breakers", "Proper wiring"] }
                ]
            },
            matter: {
                title: "Matter",
                branches: [
                    { title: "States", leaves: ["Solid", "Liquid", "Gas"] },
                    { title: "Properties", leaves: ["Mass", "Volume", "Density"] },
                    { title: "Changes", leaves: ["Melting", "Boiling", "Condensation", "Freezing"] },
                    { title: "Mixtures", leaves: ["Solutions", "Suspensions", "Separation methods"] }
                ]
            },
            plants: {
                title: "Plants",
                branches: [
                    { title: "Parts", leaves: ["Roots", "Stem", "Leaves", "Flowers"] },
                    { title: "Photosynthesis", leaves: ["Sunlight", "Carbon dioxide", "Water", "Glucose"] },
                    { title: "Transport", leaves: ["Xylem", "Phloem", "Water", "Nutrients"] },
                    { title: "Reproduction", leaves: ["Seeds", "Pollination", "Germination"] }
                ]
            }
        };

        function openMindmap() {
            document.getElementById('mindmap-modal').style.display = 'flex';
            showMindmapTopic('heat');
        }

        function closeMindmap() {
            document.getElementById('mindmap-modal').style.display = 'none';
        }

        function showMindmapTopic(topic) {
            const data = mindmapData[topic];
            const container = document.getElementById('mindmap-content');

            container.innerHTML = `
                <div class="mindmap-root">${data.title}</div>
                <div class="mindmap-branches">
                    ${data.branches.map(branch => `
                        <div class="mindmap-branch">
                            <div class="mindmap-branch-title">${branch.title}</div>
                            <div class="mindmap-leaves">
                                ${branch.leaves.map(leaf => `
                                    <span class="mindmap-leaf">${leaf}</span>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Favorite Topics System
        const availableTopics = [
            { id: 'heat', name: 'Heat & Temperature', icon: '' },
            { id: 'light', name: 'Light & Shadows', icon: '' },
            { id: 'electricity', name: 'Electricity', icon: '' },
            { id: 'forces', name: 'Forces & Motion', icon: '' },
            { id: 'plants', name: 'Plants', icon: '' },
            { id: 'animals', name: 'Animals', icon: '' },
            { id: 'human-body', name: 'Human Body', icon: '' },
            { id: 'matter', name: 'Matter & Materials', icon: '' },
            { id: 'water-cycle', name: 'Water Cycle', icon: '' },
            { id: 'earth', name: 'Earth & Space', icon: '' }
        ];

        function getFavoriteTopics() {
            return JSON.parse(localStorage.getItem('favoriteTopics')) || [];
        }

        function saveFavoriteTopics(favorites) {
            localStorage.setItem('favoriteTopics', JSON.stringify(favorites));
        }

        function openFavorites() {
            document.getElementById('favorites-modal').style.display = 'flex';
            renderFavorites();
        }

        function closeFavorites() {
            document.getElementById('favorites-modal').style.display = 'none';
        }

        function addFavoriteTopic(topicId) {
            const favorites = getFavoriteTopics();
            if (!favorites.includes(topicId)) {
                favorites.push(topicId);
                saveFavoriteTopics(favorites);
                renderFavorites();
            }
        }

        function removeFavoriteTopic(topicId) {
            let favorites = getFavoriteTopics();
            favorites = favorites.filter(f => f !== topicId);
            saveFavoriteTopics(favorites);
            renderFavorites();
        }

        function renderFavorites() {
            const container = document.getElementById('favorites-body');
            const favorites = getFavoriteTopics();
            const favTopics = availableTopics.filter(t => favorites.includes(t.id));
            const nonFavTopics = availableTopics.filter(t => !favorites.includes(t.id));

            if (favTopics.length === 0) {
                container.innerHTML = `
                    <div class="no-favorites">
                        <p style="font-size: 3rem; margin-bottom: 15px;"></p>
                        <p>No favorite topics yet!</p>
                        <p style="font-size: 0.9rem;">Add topics you want quick access to.</p>
                    </div>
                    <h4 style="color: #ff5722; margin: 20px 0 10px;">Available Topics</h4>
                    ${nonFavTopics.map(topic => `
                        <div class="favorite-topic-card" onclick="addFavoriteTopic('${topic.id}')">
                            <div class="favorite-topic-info">
                                <span class="favorite-topic-icon">${topic.icon}</span>
                                <span class="favorite-topic-name">${topic.name}</span>
                            </div>
                            <div class="favorite-topic-actions">
                                <button style="background: #4CAF50;">+ Add</button>
                            </div>
                        </div>
                    `).join('')}
                `;
                return;
            }

            container.innerHTML = `
                <h4 style="color: #ff5722; margin-bottom: 15px;">Your Favorites</h4>
                ${favTopics.map(topic => `
                    <div class="favorite-topic-card">
                        <div class="favorite-topic-info">
                            <span class="favorite-topic-icon">${topic.icon}</span>
                            <span class="favorite-topic-name">${topic.name}</span>
                        </div>
                        <div class="favorite-topic-actions">
                            <button onclick="event.stopPropagation(); removeFavoriteTopic('${topic.id}')">Remove</button>
                        </div>
                    </div>
                `).join('')}
                ${nonFavTopics.length > 0 ? `
                    <h4 style="color: #999; margin: 20px 0 10px;">Add More</h4>
                    ${nonFavTopics.map(topic => `
                        <div class="favorite-topic-card" onclick="addFavoriteTopic('${topic.id}')" style="opacity: 0.7;">
                            <div class="favorite-topic-info">
                                <span class="favorite-topic-icon">${topic.icon}</span>
                                <span class="favorite-topic-name">${topic.name}</span>
                            </div>
                            <div class="favorite-topic-actions">
                                <button style="background: #4CAF50;">+ Add</button>
                            </div>
                        </div>
                    `).join('')}
                ` : ''}
            `;
        }

        console.log(' Science Jokes, Mind Map, and Favorite Topics loaded!');
    </script>

    <!-- ========== BATCH 40: Leaderboard, Confetti, Study Reminders ========== -->

    <!-- Leaderboard Modal -->
    <div class="leaderboard-modal" id="leaderboard-modal">
        <div class="leaderboard-container">
            <div class="leaderboard-header">
                <h2> Leaderboard</h2>
            </div>
            <div class="leaderboard-body" id="leaderboard-body">
            </div>
            <div style="padding: 15px; text-align: center;">
                <button onclick="closeLeaderboard()" style="background: white; color: #333; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Confetti Container -->
    <div class="confetti-container" id="confetti-container"></div>

    <!-- Reminders Modal -->
    <div class="reminders-modal" id="reminders-modal">
        <div class="reminders-container">
            <div class="reminders-header">
                <h2> Study Reminders</h2>
                <button onclick="closeReminders()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="reminders-body">
                <div class="reminder-option">
                    <div class="reminder-info">
                        <span class="reminder-icon"></span>
                        <span class="reminder-text">Daily Study Reminder</span>
                    </div>
                    <div class="reminder-toggle" id="daily-reminder-toggle" onclick="toggleReminder('daily')"></div>
                </div>
                <div class="reminder-option">
                    <div class="reminder-info">
                        <span class="reminder-icon"></span>
                        <span class="reminder-text">Goal Progress Alerts</span>
                    </div>
                    <div class="reminder-toggle" id="goal-reminder-toggle" onclick="toggleReminder('goal')"></div>
                </div>
                <div class="reminder-option">
                    <div class="reminder-info">
                        <span class="reminder-icon"></span>
                        <span class="reminder-text">Streak Protection Alert</span>
                    </div>
                    <div class="reminder-toggle" id="streak-reminder-toggle" onclick="toggleReminder('streak')"></div>
                </div>
                <div class="reminder-time-select">
                    <label>Preferred Study Time</label>
                    <input type="time" id="reminder-time" value="16:00" onchange="saveReminderTime()">
                </div>
                <p style="color: #666; font-size: 0.85rem; margin-top: 15px; text-align: center;">
                    Note: Browser notifications require permission. Click "Allow" when prompted.
                </p>
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <button class="floating-leaderboard-btn" onclick="openLeaderboard()" title="Leaderboard"></button>
    <button class="floating-reminders-btn" onclick="openReminders()" title="Study Reminders"></button>

    <script>
        // ========== BATCH 40: Leaderboard, Confetti, Study Reminders ==========

        // Leaderboard System (simulated other users)
        const simulatedUsers = [
            { name: 'ScienceWiz', avatar: '', level: 25, xp: 4500 },
            { name: 'AtomicKid', avatar: '', level: 22, xp: 3900 },
            { name: 'BioExplorer', avatar: '', level: 20, xp: 3500 },
            { name: 'PhysicsPro', avatar: '', level: 18, xp: 3100 },
            { name: 'ChemChamp', avatar: '', level: 16, xp: 2700 },
            { name: 'EarthLover', avatar: '', level: 14, xp: 2300 },
            { name: 'StarGazer', avatar: '', level: 12, xp: 1900 },
            { name: 'NatureNinja', avatar: '', level: 10, xp: 1500 },
            { name: 'LabRat', avatar: '', level: 8, xp: 1100 },
            { name: 'CuriousKid', avatar: '', level: 5, xp: 500 }
        ];

        function openLeaderboard() {
            document.getElementById('leaderboard-modal').style.display = 'flex';
            renderLeaderboard();
        }

        function closeLeaderboard() {
            document.getElementById('leaderboard-modal').style.display = 'none';
        }

        function renderLeaderboard() {
            const container = document.getElementById('leaderboard-body');
            const userXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            const userLevel = parseInt(localStorage.getItem('scienceLevel')) || 1;
            const userName = localStorage.getItem('userName') || 'You';

            // Add current user to leaderboard
            const allUsers = [...simulatedUsers, { name: userName, avatar: '', level: userLevel, xp: userXP, isCurrentUser: true }];

            // Sort by XP
            allUsers.sort((a, b) => b.xp - a.xp);

            container.innerHTML = allUsers.map((user, index) => {
                let rankClass = '';
                let rankDisplay = index + 1;
                if (index === 0) { rankClass = 'gold'; rankDisplay = ''; }
                else if (index === 1) { rankClass = 'silver'; rankDisplay = ''; }
                else if (index === 2) { rankClass = 'bronze'; rankDisplay = ''; }

                return `
                    <div class="leaderboard-item ${user.isCurrentUser ? 'current-user' : ''}">
                        <span class="leaderboard-rank ${rankClass}">${rankDisplay}</span>
                        <span class="leaderboard-avatar">${user.avatar}</span>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${user.name} ${user.isCurrentUser ? '(You)' : ''}</div>
                            <div class="leaderboard-stats">Level ${user.level}</div>
                        </div>
                        <span class="leaderboard-xp">${user.xp.toLocaleString()} XP</span>
                    </div>
                `;
            }).join('');
        }

        // Confetti System
        const confettiColors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#1dd1a1', '#ffeaa7', '#fd79a8'];

        function launchConfetti() {
            const container = document.getElementById('confetti-container');
            const count = 100;

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';

                    // Random shapes
                    const shapes = ['circle', 'square', 'triangle'];
                    const shape = shapes[Math.floor(Math.random() * shapes.length)];
                    if (shape === 'circle') {
                        confetti.style.borderRadius = '50%';
                    } else if (shape === 'triangle') {
                        confetti.style.width = '0';
                        confetti.style.height = '0';
                        confetti.style.borderLeft = '5px solid transparent';
                        confetti.style.borderRight = '5px solid transparent';
                        confetti.style.borderBottom = '10px solid ' + confettiColors[Math.floor(Math.random() * confettiColors.length)];
                        confetti.style.backgroundColor = 'transparent';
                    }

                    container.appendChild(confetti);

                    // Remove after animation
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 30);
            }
        }

        // Auto-launch confetti on special achievements
        function celebrateAchievement(type) {
            launchConfetti();
            if (typeof playSound === 'function') playSound('levelup');
        }

        // Study Reminders System
        function getReminderSettings() {
            return JSON.parse(localStorage.getItem('reminderSettings')) || {
                daily: false,
                goal: false,
                streak: false,
                time: '16:00'
            };
        }

        function saveReminderSettings(settings) {
            localStorage.setItem('reminderSettings', JSON.stringify(settings));
        }

        function openReminders() {
            document.getElementById('reminders-modal').style.display = 'flex';
            loadReminderSettings();
        }

        function closeReminders() {
            document.getElementById('reminders-modal').style.display = 'none';
        }

        function loadReminderSettings() {
            const settings = getReminderSettings();

            document.getElementById('daily-reminder-toggle').classList.toggle('active', settings.daily);
            document.getElementById('goal-reminder-toggle').classList.toggle('active', settings.goal);
            document.getElementById('streak-reminder-toggle').classList.toggle('active', settings.streak);
            document.getElementById('reminder-time').value = settings.time;
        }

        function toggleReminder(type) {
            const settings = getReminderSettings();
            settings[type] = !settings[type];
            saveReminderSettings(settings);

            const toggle = document.getElementById(`${type}-reminder-toggle`);
            toggle.classList.toggle('active', settings[type]);

            // Request notification permission if any reminder is enabled
            if (settings[type] && 'Notification' in window) {
                Notification.requestPermission();
            }
        }

        function saveReminderTime() {
            const settings = getReminderSettings();
            settings.time = document.getElementById('reminder-time').value;
            saveReminderSettings(settings);
        }

        // Check for study reminder
        function checkStudyReminder() {
            const settings = getReminderSettings();
            if (!settings.daily) return;

            const now = new Date();
            const [hours, minutes] = settings.time.split(':');
            const reminderTime = new Date();
            reminderTime.setHours(parseInt(hours), parseInt(minutes), 0);

            // Check if current time is within 5 minutes of reminder time
            const diff = Math.abs(now - reminderTime) / 1000 / 60;
            if (diff < 5) {
                const lastReminder = localStorage.getItem('lastReminderDate');
                const today = now.toISOString().split('T')[0];

                if (lastReminder !== today) {
                    showNotification('Study Time! ', 'It\'s time for your daily science practice!');
                    localStorage.setItem('lastReminderDate', today);
                }
            }
        }

        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body, icon: '' });
            }
        }

        // Check reminders every minute
        setInterval(checkStudyReminder, 60000);

        console.log(' Leaderboard, Confetti, and Study Reminders loaded!');
    </script>

    <!-- ========== BATCH 41: Profile Customization, Difficulty Indicator, Science News ========== -->

    <!-- Profile Modal -->
    <div class="profile-modal" id="profile-modal">
        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-avatar-display" id="profile-avatar-preview"></div>
                <div class="profile-name-display" id="profile-name-preview">Student</div>
            </div>
            <div class="profile-body">
                <div class="profile-section">
                    <label>Your Name</label>
                    <input type="text" id="profile-name-input" placeholder="Enter your name" maxlength="20">
                </div>
                <div class="profile-section">
                    <label>Choose Your Avatar</label>
                    <div class="avatar-picker" id="avatar-picker">
                    </div>
                </div>
                <button class="profile-save-btn" onclick="saveProfile()">Save Profile</button>
                <button onclick="closeProfile()" style="background: #f5f5f5; color: #333; border: none; padding: 12px; border-radius: 30px; width: 100%; margin-top: 10px; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Science News Modal -->
    <div class="news-modal" id="news-modal">
        <div class="news-container">
            <div class="news-header">
                <h2> Science News</h2>
                <button onclick="closeNews()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="news-body" id="news-body">
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <button class="floating-profile-btn" onclick="openProfile()" title="My Profile"></button>
    <button class="floating-news-btn" onclick="openNews()" title="Science News"></button>

    <script>
        // ========== BATCH 41: Profile Customization, Difficulty Indicator, Science News ==========

        // Profile System
        const availableAvatars = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];

        let selectedAvatar = localStorage.getItem('userAvatar') || '';

        function openProfile() {
            document.getElementById('profile-modal').style.display = 'flex';
            loadProfileSettings();
            renderAvatarPicker();
        }

        function closeProfile() {
            document.getElementById('profile-modal').style.display = 'none';
        }

        function loadProfileSettings() {
            const name = localStorage.getItem('userName') || 'Student';
            selectedAvatar = localStorage.getItem('userAvatar') || '';

            document.getElementById('profile-name-input').value = name;
            document.getElementById('profile-avatar-preview').textContent = selectedAvatar;
            document.getElementById('profile-name-preview').textContent = name;
        }

        function renderAvatarPicker() {
            const container = document.getElementById('avatar-picker');
            container.innerHTML = availableAvatars.map(avatar => `
                <div class="avatar-option ${avatar === selectedAvatar ? 'selected' : ''}" onclick="selectAvatar('${avatar}')">
                    ${avatar}
                </div>
            `).join('');
        }

        function selectAvatar(avatar) {
            selectedAvatar = avatar;
            document.getElementById('profile-avatar-preview').textContent = avatar;
            renderAvatarPicker();
        }

        function saveProfile() {
            const name = document.getElementById('profile-name-input').value.trim() || 'Student';

            localStorage.setItem('userName', name);
            localStorage.setItem('userAvatar', selectedAvatar);

            document.getElementById('profile-name-preview').textContent = name;

            closeProfile();

            if (typeof showMotivation === 'function') {
                showMotivation('Profile saved! Welcome, ' + name + '!');
            }

            // Update leaderboard display
            if (typeof renderLeaderboard === 'function') {
                renderLeaderboard();
            }
        }

        // Difficulty Indicator System
        function getDifficultyBadge(level) {
            if (level === 'easy') {
                return '<span class="difficulty-badge easy"><span class="difficulty-stars"></span> Easy</span>';
            } else if (level === 'medium') {
                return '<span class="difficulty-badge medium"><span class="difficulty-stars"></span> Medium</span>';
            } else {
                return '<span class="difficulty-badge hard"><span class="difficulty-stars"></span> Hard</span>';
            }
        }

        function getRandomDifficulty() {
            const rand = Math.random();
            if (rand < 0.4) return 'easy';
            if (rand < 0.75) return 'medium';
            return 'hard';
        }

        // Science News System
        const scienceNews = [
            {
                emoji: '',
                category: 'Space',
                title: 'New Exoplanet Discovered!',
                summary: 'Scientists have discovered a new planet orbiting a distant star that may have conditions suitable for life.',
                date: 'Today'
            },
            {
                emoji: '',
                category: 'Paleontology',
                title: 'Dinosaur Footprints Found',
                summary: 'A new set of dinosaur footprints was discovered, revealing new information about how these ancient creatures moved.',
                date: 'Yesterday'
            },
            {
                emoji: '',
                category: 'Biology',
                title: 'New Species of Deep Sea Fish',
                summary: 'Marine biologists have identified a new species of fish living in the deepest parts of the ocean.',
                date: '2 days ago'
            },
            {
                emoji: '',
                category: 'Energy',
                title: 'Solar Power Breakthrough',
                summary: 'Engineers have developed more efficient solar panels that could make renewable energy cheaper than ever.',
                date: '3 days ago'
            },
            {
                emoji: '',
                category: 'Geology',
                title: 'Volcano Activity Monitored',
                summary: 'Scientists are using new technology to better predict volcanic eruptions and keep people safe.',
                date: '4 days ago'
            },
            {
                emoji: '',
                category: 'Technology',
                title: 'Robot Helps Scientists',
                summary: 'A new robot has been designed to help scientists explore dangerous environments like active volcanoes.',
                date: '5 days ago'
            },
            {
                emoji: '',
                category: 'Ocean',
                title: 'Ocean Cleanup Progress',
                summary: 'The project to clean plastic from the ocean has removed thousands of tonnes of waste this year.',
                date: '1 week ago'
            },
            {
                emoji: '',
                category: 'Astronomy',
                title: 'Meteor Shower Coming!',
                summary: 'A spectacular meteor shower will be visible next week. The best viewing time is after midnight.',
                date: '1 week ago'
            }
        ];

        function openNews() {
            document.getElementById('news-modal').style.display = 'flex';
            renderNews();
        }

        function closeNews() {
            document.getElementById('news-modal').style.display = 'none';
        }

        function renderNews() {
            const container = document.getElementById('news-body');

            container.innerHTML = scienceNews.map(news => `
                <div class="news-card">
                    <div class="news-card-header">
                        <span class="news-category">${news.category}</span>
                        <span class="news-date">${news.date}</span>
                    </div>
                    <div style="display: flex; align-items: flex-start;">
                        <span class="news-emoji">${news.emoji}</span>
                        <div>
                            <div class="news-title">${news.title}</div>
                            <div class="news-summary">${news.summary}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        console.log(' Profile Customization, Difficulty Indicator, and Science News loaded!');
    </script>

    <!-- ========== BATCH 42: Trivia Game, Study Breaks, Progress Milestones ========== -->

    <!-- Trivia Modal -->
    <div class="trivia-modal" id="trivia-modal">
        <div class="trivia-container">
            <div class="trivia-header">
                <h2> Quick Trivia</h2>
            </div>
            <div class="trivia-body">
                <div class="trivia-score" id="trivia-score">0 / 5</div>
                <div class="trivia-question" id="trivia-question">Loading question...</div>
                <div class="trivia-options" id="trivia-options"></div>
            </div>
            <div class="trivia-controls">
                <button class="trivia-btn" onclick="closeTrivia()">Close</button>
            </div>
        </div>
    </div>

    <!-- Break Modal -->
    <div class="break-modal" id="break-modal">
        <div class="break-container">
            <div class="break-header">
                <h2> Study Break</h2>
            </div>
            <div class="break-body">
                <div class="break-activity" id="break-activity">
                    <div class="break-activity-icon"></div>
                    <div class="break-activity-title">Stretch Break</div>
                    <div class="break-activity-desc">Stand up and stretch your arms above your head!</div>
                </div>
                <div class="break-timer" id="break-timer">2:00</div>
                <button class="break-btn" id="break-start-btn" onclick="toggleBreak()">Start Break</button>
                <button class="break-btn" onclick="newBreakActivity()">Different Activity</button>
                <button class="break-btn" onclick="closeBreak()">Close</button>
            </div>
        </div>
    </div>

    <!-- Milestones Modal -->
    <div class="milestones-modal" id="milestones-modal">
        <div class="milestones-container">
            <div class="milestones-header">
                <h2> Milestones</h2>
                <button onclick="closeMilestones()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="milestones-body" id="milestones-body">
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <button class="floating-trivia-btn" onclick="openTrivia()" title="Quick Trivia"></button>
    <button class="floating-break-btn" onclick="openBreak()" title="Study Break"></button>
    <button class="floating-milestones-btn" onclick="openMilestones()" title="Milestones"></button>

    <script>
        // ========== BATCH 42: Trivia Game, Study Breaks, Progress Milestones ==========

        // Quick Trivia Game
        const triviaQuestions = [
            { q: "How many planets are in our solar system?", options: ["7", "8", "9", "10"], answer: 1 },
            { q: "What gas do plants breathe in?", options: ["Oxygen", "Nitrogen", "Carbon Dioxide", "Hydrogen"], answer: 2 },
            { q: "What is the largest organ in the human body?", options: ["Heart", "Brain", "Skin", "Liver"], answer: 2 },
            { q: "What force keeps us on the ground?", options: ["Magnetism", "Friction", "Gravity", "Tension"], answer: 2 },
            { q: "Which animal can regenerate its limbs?", options: ["Frog", "Starfish", "Snake", "Bird"], answer: 1 },
            { q: "What is H2O commonly known as?", options: ["Salt", "Water", "Sugar", "Air"], answer: 1 },
            { q: "How many bones are in the adult human body?", options: ["106", "156", "206", "256"], answer: 2 },
            { q: "What planet is known as the Red Planet?", options: ["Venus", "Jupiter", "Mars", "Saturn"], answer: 2 },
            { q: "What do bees make?", options: ["Milk", "Honey", "Silk", "Wax only"], answer: 1 },
            { q: "Which sense do dogs rely on most?", options: ["Sight", "Hearing", "Smell", "Touch"], answer: 2 }
        ];

        let triviaState = {
            questions: [],
            current: 0,
            score: 0
        };

        function openTrivia() {
            document.getElementById('trivia-modal').style.display = 'flex';
            startTrivia();
        }

        function closeTrivia() {
            document.getElementById('trivia-modal').style.display = 'none';
        }

        function startTrivia() {
            triviaState.questions = [...triviaQuestions].sort(() => Math.random() - 0.5).slice(0, 5);
            triviaState.current = 0;
            triviaState.score = 0;
            showTriviaQuestion();
        }

        function showTriviaQuestion() {
            if (triviaState.current >= triviaState.questions.length) {
                showTriviaResult();
                return;
            }

            const q = triviaState.questions[triviaState.current];
            document.getElementById('trivia-score').textContent = `${triviaState.score} / ${triviaState.questions.length}`;
            document.getElementById('trivia-question').textContent = q.q;
            document.getElementById('trivia-options').innerHTML = q.options.map((opt, i) => `
                <button class="trivia-option" onclick="answerTrivia(${i})">${opt}</button>
            `).join('');
        }

        function answerTrivia(selected) {
            const q = triviaState.questions[triviaState.current];
            const options = document.querySelectorAll('.trivia-option');

            options.forEach((opt, i) => {
                opt.disabled = true;
                if (i === q.answer) opt.classList.add('correct');
                if (i === selected && selected !== q.answer) opt.classList.add('wrong');
            });

            if (selected === q.answer) triviaState.score++;

            setTimeout(() => {
                triviaState.current++;
                showTriviaQuestion();
            }, 1000);
        }

        function showTriviaResult() {
            document.getElementById('trivia-score').textContent = `Final: ${triviaState.score} / ${triviaState.questions.length}`;
            document.getElementById('trivia-question').textContent = triviaState.score >= 4 ? ' Excellent!' : triviaState.score >= 2 ? ' Good job!' : ' Keep practicing!';
            document.getElementById('trivia-options').innerHTML = `<button class="trivia-option" onclick="startTrivia()">Play Again</button>`;

            // Award XP
            if (typeof addXP === 'function') addXP(triviaState.score * 5);
        }

        // Study Break Activities
        const breakActivities = [
            { icon: '', title: 'Stretch Break', desc: 'Stand up and stretch your arms above your head, then touch your toes!' },
            { icon: '', title: 'Eye Rest', desc: 'Look at something 20 feet away for 20 seconds to rest your eyes.' },
            { icon: '', title: 'Hydration', desc: 'Take a moment to drink some water and stay hydrated!' },
            { icon: '', title: 'Walk Around', desc: 'Take a short walk around your room or house.' },
            { icon: '', title: 'Deep Breathing', desc: 'Take 5 deep breaths - breathe in for 4 counts, out for 4 counts.' },
            { icon: '', title: 'Quick Exercise', desc: 'Do 10 jumping jacks or march in place for 30 seconds!' },
            { icon: '', title: 'Dance Break', desc: 'Put on your favorite song and dance for 2 minutes!' },
            { icon: '', title: 'Brain Teaser', desc: 'Think of 5 words that start with the same letter.' }
        ];

        let breakTimer = null;
        let breakSeconds = 120;

        function openBreak() {
            document.getElementById('break-modal').style.display = 'flex';
            newBreakActivity();
        }

        function closeBreak() {
            document.getElementById('break-modal').style.display = 'none';
            if (breakTimer) clearInterval(breakTimer);
            breakTimer = null;
        }

        function newBreakActivity() {
            const activity = breakActivities[Math.floor(Math.random() * breakActivities.length)];
            document.getElementById('break-activity').innerHTML = `
                <div class="break-activity-icon">${activity.icon}</div>
                <div class="break-activity-title">${activity.title}</div>
                <div class="break-activity-desc">${activity.desc}</div>
            `;
            breakSeconds = 120;
            updateBreakTimer();
            document.getElementById('break-start-btn').textContent = 'Start Break';
            if (breakTimer) {
                clearInterval(breakTimer);
                breakTimer = null;
            }
        }

        function toggleBreak() {
            const btn = document.getElementById('break-start-btn');
            if (breakTimer) {
                clearInterval(breakTimer);
                breakTimer = null;
                btn.textContent = 'Resume';
            } else {
                breakTimer = setInterval(() => {
                    breakSeconds--;
                    updateBreakTimer();
                    if (breakSeconds <= 0) {
                        clearInterval(breakTimer);
                        breakTimer = null;
                        btn.textContent = 'Start Break';
                        if (typeof showMotivation === 'function') showMotivation('Break complete! Ready to learn more?');
                    }
                }, 1000);
                btn.textContent = 'Pause';
            }
        }

        function updateBreakTimer() {
            const mins = Math.floor(breakSeconds / 60);
            const secs = breakSeconds % 60;
            document.getElementById('break-timer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Progress Milestones
        const milestones = [
            { icon: '', title: 'First Steps', desc: 'Answer your first question', target: 1, key: 'totalQuestionsAnswered' },
            { icon: '', title: 'Getting Warmed Up', desc: 'Answer 10 questions', target: 10, key: 'totalQuestionsAnswered' },
            { icon: '', title: 'Dedicated Learner', desc: 'Answer 50 questions', target: 50, key: 'totalQuestionsAnswered' },
            { icon: '', title: 'Century Club', desc: 'Answer 100 questions', target: 100, key: 'totalQuestionsAnswered' },
            { icon: '', title: 'Rising Star', desc: 'Reach Level 5', target: 5, key: 'scienceLevel' },
            { icon: '', title: 'Sky High', desc: 'Reach Level 10', target: 10, key: 'scienceLevel' },
            { icon: '', title: 'Science Royalty', desc: 'Reach Level 20', target: 20, key: 'scienceLevel' },
            { icon: '', title: 'XP Hunter', desc: 'Earn 500 XP', target: 500, key: 'scienceXP' },
            { icon: '', title: 'XP Master', desc: 'Earn 2000 XP', target: 2000, key: 'scienceXP' },
            { icon: '', title: 'Daily Dedication', desc: 'Complete a 7-day streak', target: 7, key: 'loginStreak' }
        ];

        function openMilestones() {
            document.getElementById('milestones-modal').style.display = 'flex';
            renderMilestones();
        }

        function closeMilestones() {
            document.getElementById('milestones-modal').style.display = 'none';
        }

        function renderMilestones() {
            const container = document.getElementById('milestones-body');

            container.innerHTML = milestones.map(m => {
                const current = parseInt(localStorage.getItem(m.key)) || 0;
                const progress = Math.min((current / m.target) * 100, 100);
                const completed = current >= m.target;

                return `
                    <div class="milestone-card ${completed ? 'completed' : ''}">
                        ${completed ? '<div class="milestone-badge"></div>' : ''}
                        <div class="milestone-icon">${m.icon}</div>
                        <div class="milestone-info">
                            <div class="milestone-title">${m.title}</div>
                            <div class="milestone-desc">${m.desc}</div>
                            ${!completed ? `
                                <div class="milestone-progress">
                                    <div class="milestone-progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <div style="font-size: 0.8rem; color: #999; margin-top: 4px;">${current} / ${m.target}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        console.log(' Trivia Game, Study Breaks, and Progress Milestones loaded!');
    </script>

    <!-- ===== Batch 43: Vocabulary Builder, Experiment Simulator, Streak Bonus ===== -->
    <button class="floating-vocab-btn" onclick="openVocabModal()" title="Vocabulary Builder"></button>
    <button class="floating-experiment-btn" onclick="openExperimentModal()" title="Science Experiments"></button>

    <!-- Streak Bonus Indicator -->
    <div class="streak-bonus-indicator" id="streak-bonus-indicator">
        <div class="streak-bonus-content">
            <span class="streak-fire"></span>
            <div class="streak-info">
                <h4>Answer Streak!</h4>
                <div class="streak-multiplier" id="streak-multiplier">x1.0</div>
                <div class="streak-count" id="streak-count-display">0 in a row</div>
            </div>
        </div>
    </div>

    <!-- Vocabulary Builder Modal -->
    <div class="vocab-modal" id="vocab-modal">
        <div class="vocab-content">
            <button class="modal-close-btn" onclick="closeVocabModal()">&times;</button>
            <div class="vocab-header">
                <h2> Science Vocabulary</h2>
                <p style="color: #aaa;">Learn important science terms!</p>
            </div>
            <div class="vocab-progress">
                <span style="color: #4a90d9; font-weight: bold;">Your Progress</span>
                <div style="color: #aaa; font-size: 0.9rem; margin-top: 5px;">
                    <span id="vocab-learned-count">0</span> / <span id="vocab-total-count">0</span> terms learned
                </div>
                <div class="vocab-progress-bar">
                    <div class="vocab-progress-fill" id="vocab-progress-fill" style="width: 0%"></div>
                </div>
            </div>
            <div class="vocab-category-tabs" id="vocab-category-tabs"></div>
            <div id="vocab-cards-container"></div>
        </div>
    </div>

    <!-- Experiment Simulator Modal -->
    <div class="experiment-modal" id="experiment-modal">
        <div class="experiment-content">
            <button class="modal-close-btn" onclick="closeExperimentModal()">&times;</button>
            <div class="experiment-header">
                <h2> Science Experiments</h2>
                <p style="color: #aaa;">Try virtual experiments to learn science concepts!</p>
            </div>
            <div class="experiment-list" id="experiment-list"></div>
            <div class="experiment-workspace" id="experiment-workspace"></div>
        </div>
    </div>

    <script>
        // ===== Batch 43: Vocabulary Builder, Experiment Simulator, Streak Bonus =====

        // Science Vocabulary Data
        const vocabularyData = {
            'Matter': [
                { term: 'Atom', definition: 'The smallest unit of matter that retains the properties of an element.', example: 'Everything around us is made of atoms.' },
                { term: 'Molecule', definition: 'A group of atoms bonded together, representing the smallest unit of a chemical compound.', example: 'Water (HO) is a molecule made of 2 hydrogen atoms and 1 oxygen atom.' },
                { term: 'Solid', definition: 'A state of matter with a definite shape and volume, where particles are tightly packed.', example: 'Ice is water in its solid state.' },
                { term: 'Liquid', definition: 'A state of matter with a definite volume but no fixed shape, taking the shape of its container.', example: 'Water is a liquid at room temperature.' },
                { term: 'Gas', definition: 'A state of matter with no fixed shape or volume, where particles move freely.', example: 'The air we breathe is made of gases.' }
            ],
            'Energy': [
                { term: 'Kinetic Energy', definition: 'The energy of motion. Moving objects have kinetic energy.', example: 'A rolling ball has kinetic energy.' },
                { term: 'Potential Energy', definition: 'Stored energy that can be converted to other forms.', example: 'A book on a shelf has gravitational potential energy.' },
                { term: 'Heat', definition: 'A form of energy transferred between objects due to temperature difference.', example: 'Heat flows from a hot cup to your cold hands.' },
                { term: 'Light', definition: 'A form of electromagnetic energy that we can see.', example: 'The sun produces light energy.' },
                { term: 'Sound', definition: 'Energy produced by vibrations that travels through matter as waves.', example: 'Sound waves carry the music from speakers to your ears.' }
            ],
            'Forces': [
                { term: 'Gravity', definition: 'A force that pulls objects toward each other. Earth\'s gravity pulls things down.', example: 'Gravity keeps us on the ground and makes things fall.' },
                { term: 'Friction', definition: 'A force that opposes motion between surfaces in contact.', example: 'Friction helps you walk without slipping.' },
                { term: 'Magnetism', definition: 'A force produced by magnets that attracts or repels certain materials.', example: 'Magnets stick to refrigerators because of magnetism.' },
                { term: 'Buoyancy', definition: 'The upward force exerted by a fluid that opposes the weight of an object.', example: 'Buoyancy makes boats float on water.' }
            ],
            'Life Science': [
                { term: 'Photosynthesis', definition: 'The process by which plants make food using sunlight, water, and carbon dioxide.', example: 'Plants use photosynthesis to produce glucose and oxygen.' },
                { term: 'Respiration', definition: 'The process of using oxygen to release energy from food in living cells.', example: 'We breathe to get oxygen for respiration.' },
                { term: 'Habitat', definition: 'The natural home or environment of a plant or animal.', example: 'A pond is a habitat for frogs and fish.' },
                { term: 'Food Chain', definition: 'A series showing how energy passes from one organism to another.', example: 'Grass  Grasshopper  Frog  Snake is a food chain.' },
                { term: 'Adaptation', definition: 'A feature that helps an organism survive in its environment.', example: 'Thick fur is an adaptation for polar bears in cold climates.' }
            ],
            'Earth Science': [
                { term: 'Erosion', definition: 'The process of wearing away rock and soil by wind, water, or ice.', example: 'Rivers cause erosion of riverbanks over time.' },
                { term: 'Water Cycle', definition: 'The continuous movement of water between Earth\'s surface and atmosphere.', example: 'Evaporation, condensation, and precipitation are parts of the water cycle.' },
                { term: 'Volcano', definition: 'An opening in Earth\'s crust through which lava, ash, and gases erupt.', example: 'Mount Fuji is a famous volcano in Japan.' },
                { term: 'Atmosphere', definition: 'The layer of gases surrounding Earth.', example: 'The atmosphere protects us from harmful radiation.' }
            ]
        };

        // Experiment Data
        const experimentsData = [
            {
                id: 'density',
                icon: '',
                title: 'Density Tower',
                desc: 'See how liquids layer based on density',
                steps: [
                    'Pour honey into the bottom of a glass.',
                    'Slowly pour dish soap on top of the honey.',
                    'Gently add water to the glass.',
                    'Finally, carefully add vegetable oil.',
                    'Observe how the liquids form layers!'
                ],
                result: { icon: '', text: 'The liquids stack in layers because they have different densities! Honey is the densest (heaviest), so it sinks to the bottom. Oil is the least dense (lightest), so it floats on top.' }
            },
            {
                id: 'volcano',
                icon: '',
                title: 'Baking Soda Volcano',
                desc: 'Create a fizzy eruption with a chemical reaction',
                steps: [
                    'Build a small mound of clay or playdough with a hole in the center.',
                    'Add 2 tablespoons of baking soda into the hole.',
                    'Add a few drops of red food coloring.',
                    'Pour vinegar into the hole.',
                    'Watch the volcano erupt!'
                ],
                result: { icon: '', text: 'The baking soda (base) and vinegar (acid) react together to produce carbon dioxide gas! The bubbles create the "lava" effect. This is called an acid-base reaction.' }
            },
            {
                id: 'rainbow',
                icon: '',
                title: 'Walking Rainbow',
                desc: 'Watch water travel through paper towels',
                steps: [
                    'Place 6 cups in a row.',
                    'Fill cups 1, 3, and 5 with water.',
                    'Add red food coloring to cup 1, yellow to cup 3, blue to cup 5.',
                    'Fold paper towels and place them between adjacent cups.',
                    'Wait and watch the colors "walk" into the empty cups!'
                ],
                result: { icon: '', text: 'This demonstrates capillary action! Water molecules climb up tiny spaces in the paper towel. When the colors mix in the empty cups, you get orange, green, and purple - the secondary colors!' }
            },
            {
                id: 'magnet',
                icon: '',
                title: 'Magnetic Field Explorer',
                desc: 'Visualize invisible magnetic forces',
                steps: [
                    'Place a bar magnet on a flat surface.',
                    'Put a piece of white paper over the magnet.',
                    'Sprinkle iron filings evenly over the paper.',
                    'Gently tap the paper.',
                    'Observe the pattern that forms!'
                ],
                result: { icon: '', text: 'The iron filings line up along the magnetic field lines! You can see that the field is strongest at the poles (ends) of the magnet. This invisible force is what makes magnets attract or repel each other.' }
            },
            {
                id: 'static',
                icon: '',
                title: 'Static Electricity',
                desc: 'Make objects move without touching them',
                steps: [
                    'Cut small pieces of paper or tissue.',
                    'Rub a balloon vigorously on your hair or wool sweater.',
                    'Bring the balloon near the paper pieces.',
                    'Watch the paper jump to the balloon!',
                    'Try bending a stream of water with the charged balloon!'
                ],
                result: { icon: '', text: 'Rubbing the balloon creates static electricity by transferring electrons. The balloon becomes negatively charged and attracts the neutral paper pieces. This is the same force that makes your hair stand up!' }
            }
        ];

        let currentVocabCategory = 'Matter';
        let learnedVocab = JSON.parse(localStorage.getItem('learnedVocab')) || {};
        let currentExperiment = null;
        let answerStreak = parseInt(localStorage.getItem('answerStreak')) || 0;

        // Vocabulary Functions
        function openVocabModal() {
            document.getElementById('vocab-modal').style.display = 'flex';
            initVocabCategories();
            displayVocabCards();
            updateVocabProgress();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeVocabModal() {
            document.getElementById('vocab-modal').style.display = 'none';
        }

        function initVocabCategories() {
            const tabsContainer = document.getElementById('vocab-category-tabs');
            const categories = Object.keys(vocabularyData);

            tabsContainer.innerHTML = categories.map(cat => `
                <button class="vocab-tab ${cat === currentVocabCategory ? 'active' : ''}" onclick="selectVocabCategory('${cat}')">
                    ${cat}
                </button>
            `).join('');
        }

        function selectVocabCategory(category) {
            currentVocabCategory = category;
            document.querySelectorAll('.vocab-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent.trim() === category);
            });
            displayVocabCards();
        }

        function displayVocabCards() {
            const container = document.getElementById('vocab-cards-container');
            const terms = vocabularyData[currentVocabCategory] || [];

            container.innerHTML = terms.map((item, index) => {
                const termKey = `${currentVocabCategory}-${index}`;
                const isLearned = learnedVocab[termKey] || false;

                return `
                    <div class="vocab-card">
                        <div class="vocab-term">${item.term}</div>
                        <div class="vocab-definition">${item.definition}</div>
                        <div class="vocab-example">"${item.example}"</div>
                        <div class="vocab-learned">
                            <input type="checkbox" id="vocab-${termKey}" ${isLearned ? 'checked' : ''} onchange="toggleVocabLearned('${termKey}')">
                            <label for="vocab-${termKey}">I've learned this term</label>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleVocabLearned(termKey) {
            learnedVocab[termKey] = !learnedVocab[termKey];
            localStorage.setItem('learnedVocab', JSON.stringify(learnedVocab));
            updateVocabProgress();

            if (learnedVocab[termKey] && typeof addXP === 'function') {
                addXP(5);
                showToast(' New term learned! +5 XP', 'success');
            }
        }

        function updateVocabProgress() {
            let totalTerms = 0;
            let learnedCount = 0;

            Object.keys(vocabularyData).forEach(category => {
                vocabularyData[category].forEach((_, index) => {
                    totalTerms++;
                    if (learnedVocab[`${category}-${index}`]) learnedCount++;
                });
            });

            document.getElementById('vocab-learned-count').textContent = learnedCount;
            document.getElementById('vocab-total-count').textContent = totalTerms;

            const percentage = totalTerms > 0 ? (learnedCount / totalTerms) * 100 : 0;
            document.getElementById('vocab-progress-fill').style.width = `${percentage}%`;
        }

        // Experiment Functions
        function openExperimentModal() {
            document.getElementById('experiment-modal').style.display = 'flex';
            displayExperimentList();
            document.getElementById('experiment-workspace').classList.remove('active');
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeExperimentModal() {
            document.getElementById('experiment-modal').style.display = 'none';
            currentExperiment = null;
        }

        function displayExperimentList() {
            const container = document.getElementById('experiment-list');

            container.innerHTML = experimentsData.map(exp => `
                <div class="experiment-card ${currentExperiment === exp.id ? 'active' : ''}" onclick="selectExperiment('${exp.id}')">
                    <div class="experiment-icon">${exp.icon}</div>
                    <div class="experiment-title">${exp.title}</div>
                    <div class="experiment-desc">${exp.desc}</div>
                </div>
            `).join('');
        }

        function selectExperiment(expId) {
            currentExperiment = expId;
            displayExperimentList();

            const experiment = experimentsData.find(e => e.id === expId);
            if (!experiment) return;

            const workspace = document.getElementById('experiment-workspace');
            workspace.classList.add('active');

            workspace.innerHTML = `
                <h3 style="color: #ce93d8; margin-bottom: 20px;">${experiment.icon} ${experiment.title}</h3>
                <div class="experiment-steps">
                    ${experiment.steps.map((step, i) => `
                        <div class="experiment-step">
                            <div class="experiment-step-num">Step ${i + 1}</div>
                            <div style="color: #ddd;">${step}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="experiment-controls">
                    <button class="experiment-btn" onclick="completeExperiment('${expId}')"> I Completed This Experiment!</button>
                </div>
                <div class="experiment-result" id="experiment-result-${expId}">
                    <div class="experiment-result-icon">${experiment.result.icon}</div>
                    <div class="experiment-result-text">${experiment.result.text}</div>
                </div>
            `;
        }

        function completeExperiment(expId) {
            const resultDiv = document.getElementById(`experiment-result-${expId}`);
            if (resultDiv) {
                resultDiv.classList.add('show');

                // Track completed experiments
                const completedExperiments = JSON.parse(localStorage.getItem('completedExperiments')) || [];
                if (!completedExperiments.includes(expId)) {
                    completedExperiments.push(expId);
                    localStorage.setItem('completedExperiments', JSON.stringify(completedExperiments));

                    if (typeof addXP === 'function') addXP(25);
                    showToast(' Experiment completed! +25 XP', 'success');
                    if (typeof playLevelUpSound === 'function') playLevelUpSound();
                }
            }
        }

        // Streak Bonus System
        function updateStreakBonus(isCorrect) {
            const indicator = document.getElementById('streak-bonus-indicator');

            if (isCorrect) {
                answerStreak++;
            } else {
                answerStreak = 0;
            }

            localStorage.setItem('answerStreak', answerStreak);

            if (answerStreak >= 3) {
                const multiplier = getStreakMultiplier();
                document.getElementById('streak-multiplier').textContent = `x${multiplier.toFixed(1)}`;
                document.getElementById('streak-count-display').textContent = `${answerStreak} in a row!`;
                indicator.classList.add('show');
            } else {
                indicator.classList.remove('show');
            }
        }

        function getStreakMultiplier() {
            if (answerStreak >= 10) return 2.0;
            if (answerStreak >= 7) return 1.7;
            if (answerStreak >= 5) return 1.5;
            if (answerStreak >= 3) return 1.2;
            return 1.0;
        }

        function getStreakBonusXP(baseXP) {
            return Math.round(baseXP * getStreakMultiplier());
        }

        // Initialize streak display on load
        function initStreakDisplay() {
            if (answerStreak >= 3) {
                const multiplier = getStreakMultiplier();
                document.getElementById('streak-multiplier').textContent = `x${multiplier.toFixed(1)}`;
                document.getElementById('streak-count-display').textContent = `${answerStreak} in a row!`;
                document.getElementById('streak-bonus-indicator').classList.add('show');
            }
        }

        // Helper toast function if not available
        if (typeof showToast !== 'function') {
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    padding: 15px 25px;
                    border-radius: 10px;
                    color: white;
                    font-weight: bold;
                    z-index: 99999;
                    animation: fadeInOut 3s ease forwards;
                    background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        }

        // Initialize on load
        setTimeout(initStreakDisplay, 500);

        console.log(' Vocabulary Builder, Experiment Simulator, and Streak Bonus loaded!');
    </script>

    <!-- ===== Batch 44: Question History, Science Calculator, Weekly Challenges ===== -->
    <button class="floating-history-btn" onclick="openHistoryModal()" title="Question History"></button>
    <button class="floating-calculator-btn" onclick="openCalculatorModal()" title="Science Calculator"></button>
    <button class="floating-weekly-btn" onclick="openWeeklyModal()" title="Weekly Challenges"></button>

    <!-- Question History Modal -->
    <div class="history-modal" id="history-modal">
        <div class="history-content">
            <button class="modal-close-btn" onclick="closeHistoryModal()">&times;</button>
            <div class="history-header">
                <h2> Question History</h2>
                <p style="color: #aaa;">Review your past answers</p>
            </div>
            <div class="history-stats" id="history-stats"></div>
            <div class="history-filter-tabs" id="history-filter-tabs"></div>
            <div id="history-items-container"></div>
        </div>
    </div>

    <!-- Science Calculator Modal -->
    <div class="calculator-modal" id="calculator-modal">
        <div class="calculator-content">
            <button class="modal-close-btn" onclick="closeCalculatorModal()">&times;</button>
            <div class="calculator-header">
                <h2> Science Calculator</h2>
            </div>
            <div class="calculator-display">
                <div class="calculator-expression" id="calc-expression"></div>
                <div class="calculator-result" id="calc-result">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn clear" onclick="clearCalc()">C</button>
                <button class="calc-btn function" onclick="appendCalc('(')">(</button>
                <button class="calc-btn function" onclick="appendCalc(')')">)</button>
                <button class="calc-btn operator" onclick="appendCalc('/')"></button>
                <button class="calc-btn number" onclick="appendCalc('7')">7</button>
                <button class="calc-btn number" onclick="appendCalc('8')">8</button>
                <button class="calc-btn number" onclick="appendCalc('9')">9</button>
                <button class="calc-btn operator" onclick="appendCalc('*')"></button>
                <button class="calc-btn number" onclick="appendCalc('4')">4</button>
                <button class="calc-btn number" onclick="appendCalc('5')">5</button>
                <button class="calc-btn number" onclick="appendCalc('6')">6</button>
                <button class="calc-btn operator" onclick="appendCalc('-')"></button>
                <button class="calc-btn number" onclick="appendCalc('1')">1</button>
                <button class="calc-btn number" onclick="appendCalc('2')">2</button>
                <button class="calc-btn number" onclick="appendCalc('3')">3</button>
                <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
                <button class="calc-btn number" onclick="appendCalc('0')">0</button>
                <button class="calc-btn number" onclick="appendCalc('.')">.</button>
                <button class="calc-btn equals" onclick="calculateResult()">=</button>
            </div>
            <div class="calculator-formulas">
                <div class="formula-title"> Quick Formulas</div>
                <div class="formula-item" onclick="showFormula('speed')">
                    <div class="formula-name">Speed</div>
                    <div class="formula-equation">Speed = Distance  Time</div>
                </div>
                <div class="formula-item" onclick="showFormula('density')">
                    <div class="formula-name">Density</div>
                    <div class="formula-equation">Density = Mass  Volume</div>
                </div>
                <div class="formula-item" onclick="showFormula('area')">
                    <div class="formula-name">Rectangle Area</div>
                    <div class="formula-equation">Area = Length  Width</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Challenge Modal -->
    <div class="weekly-challenge-modal" id="weekly-challenge-modal">
        <div class="weekly-challenge-content">
            <button class="modal-close-btn" onclick="closeWeeklyModal()">&times;</button>
            <div class="weekly-challenge-header">
                <h2> Weekly Challenges</h2>
                <p style="color: #aaa;">Complete challenges for bonus rewards!</p>
            </div>
            <div class="challenge-timer">
                <div class="challenge-timer-label">Challenges reset in</div>
                <div class="challenge-timer-value" id="challenge-timer">--:--:--</div>
            </div>
            <div id="weekly-challenges-container"></div>
        </div>
    </div>

    <script>
        // ===== Batch 44: Question History, Science Calculator, Weekly Challenges =====

        // Question History System
        let questionHistory = JSON.parse(localStorage.getItem('questionHistory')) || [];
        let historyFilter = 'all';

        function openHistoryModal() {
            document.getElementById('history-modal').style.display = 'flex';
            displayHistoryStats();
            initHistoryFilters();
            displayHistoryItems();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').style.display = 'none';
        }

        function addToHistory(question, userAnswer, correctAnswer, isCorrect) {
            const historyItem = {
                id: Date.now(),
                question: question,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                timestamp: new Date().toISOString()
            };

            questionHistory.unshift(historyItem);

            // Keep only last 100 items
            if (questionHistory.length > 100) {
                questionHistory = questionHistory.slice(0, 100);
            }

            localStorage.setItem('questionHistory', JSON.stringify(questionHistory));
        }

        function displayHistoryStats() {
            const total = questionHistory.length;
            const correct = questionHistory.filter(h => h.isCorrect).length;
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

            document.getElementById('history-stats').innerHTML = `
                <div class="history-stat">
                    <div class="history-stat-value">${total}</div>
                    <div class="history-stat-label">Questions</div>
                </div>
                <div class="history-stat">
                    <div class="history-stat-value">${correct}</div>
                    <div class="history-stat-label">Correct</div>
                </div>
                <div class="history-stat">
                    <div class="history-stat-value">${accuracy}%</div>
                    <div class="history-stat-label">Accuracy</div>
                </div>
            `;
        }

        function initHistoryFilters() {
            document.getElementById('history-filter-tabs').innerHTML = `
                <button class="history-filter-btn ${historyFilter === 'all' ? 'active' : ''}" onclick="setHistoryFilter('all')">All</button>
                <button class="history-filter-btn ${historyFilter === 'correct' ? 'active' : ''}" onclick="setHistoryFilter('correct')">Correct</button>
                <button class="history-filter-btn ${historyFilter === 'incorrect' ? 'active' : ''}" onclick="setHistoryFilter('incorrect')">Incorrect</button>
            `;
        }

        function setHistoryFilter(filter) {
            historyFilter = filter;
            initHistoryFilters();
            displayHistoryItems();
        }

        function displayHistoryItems() {
            const container = document.getElementById('history-items-container');
            let filteredHistory = questionHistory;

            if (historyFilter === 'correct') {
                filteredHistory = questionHistory.filter(h => h.isCorrect);
            } else if (historyFilter === 'incorrect') {
                filteredHistory = questionHistory.filter(h => !h.isCorrect);
            }

            if (filteredHistory.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                        <p>No questions in history yet!</p>
                        <p style="font-size: 0.9rem;">Start answering questions to build your history.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredHistory.slice(0, 20).map(item => {
                const date = new Date(item.timestamp);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="history-item ${item.isCorrect ? 'correct' : 'incorrect'}">
                        <div class="history-question">${item.question}</div>
                        <div class="history-answer-info">
                            <div class="history-answer">
                                Your answer: <span class="${item.isCorrect ? 'correct-answer' : 'wrong-answer'}">${item.userAnswer}</span>
                                ${!item.isCorrect ? `<br>Correct: <span class="correct-answer">${item.correctAnswer}</span>` : ''}
                            </div>
                            <div class="history-date">${dateStr}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Science Calculator
        let calcExpression = '';

        function openCalculatorModal() {
            document.getElementById('calculator-modal').style.display = 'flex';
            clearCalc();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeCalculatorModal() {
            document.getElementById('calculator-modal').style.display = 'none';
        }

        function appendCalc(value) {
            calcExpression += value;
            updateCalcDisplay();
        }

        function clearCalc() {
            calcExpression = '';
            document.getElementById('calc-expression').textContent = '';
            document.getElementById('calc-result').textContent = '0';
        }

        function updateCalcDisplay() {
            const displayExpr = calcExpression
                .replace(/\*/g, '')
                .replace(/\//g, '')
                .replace(/-/g, '');
            document.getElementById('calc-expression').textContent = displayExpr;
        }

        function calculateResult() {
            try {
                if (calcExpression === '') return;

                // Safe evaluation for basic math
                const sanitized = calcExpression.replace(/[^0-9+\-*/().]/g, '');
                const result = Function('"use strict"; return (' + sanitized + ')')();

                if (isNaN(result) || !isFinite(result)) {
                    document.getElementById('calc-result').textContent = 'Error';
                } else {
                    const displayResult = Number.isInteger(result) ? result : parseFloat(result.toFixed(8));
                    document.getElementById('calc-result').textContent = displayResult;
                }
            } catch (e) {
                document.getElementById('calc-result').textContent = 'Error';
            }
        }

        function showFormula(type) {
            let message = '';
            switch(type) {
                case 'speed':
                    message = ' Speed Formula:\nSpeed = Distance  Time\n\nExample: If you travel 100 km in 2 hours,\nSpeed = 100  2 = 50 km/h';
                    break;
                case 'density':
                    message = ' Density Formula:\nDensity = Mass  Volume\n\nExample: If an object has mass 200g and volume 50cm,\nDensity = 200  50 = 4 g/cm';
                    break;
                case 'area':
                    message = ' Rectangle Area Formula:\nArea = Length  Width\n\nExample: If length is 5m and width is 3m,\nArea = 5  3 = 15 m';
                    break;
            }
            alert(message);
        }

        // Weekly Challenges System
        const weeklyChallenges = [
            {
                id: 'answer50',
                icon: '',
                title: 'Question Master',
                desc: 'Answer 50 questions this week',
                target: 50,
                key: 'weeklyQuestionsAnswered',
                reward: 200
            },
            {
                id: 'streak5',
                icon: '',
                title: 'Streak Builder',
                desc: 'Get a 5-answer streak',
                target: 5,
                key: 'weeklyMaxStreak',
                reward: 100
            },
            {
                id: 'correct30',
                icon: '',
                title: 'Accuracy Champion',
                desc: 'Get 30 correct answers',
                target: 30,
                key: 'weeklyCorrectAnswers',
                reward: 150
            },
            {
                id: 'vocab10',
                icon: '',
                title: 'Vocabulary Scholar',
                desc: 'Learn 10 vocabulary terms',
                target: 10,
                key: 'weeklyVocabLearned',
                reward: 100
            },
            {
                id: 'experiment2',
                icon: '',
                title: 'Junior Scientist',
                desc: 'Complete 2 virtual experiments',
                target: 2,
                key: 'weeklyExperiments',
                reward: 125
            }
        ];

        let weeklyProgress = JSON.parse(localStorage.getItem('weeklyProgress')) || {};
        let weeklyResetTime = parseInt(localStorage.getItem('weeklyResetTime')) || 0;

        function openWeeklyModal() {
            document.getElementById('weekly-challenge-modal').style.display = 'flex';
            checkWeeklyReset();
            displayWeeklyChallenges();
            updateChallengeTimer();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeWeeklyModal() {
            document.getElementById('weekly-challenge-modal').style.display = 'none';
        }

        function checkWeeklyReset() {
            const now = Date.now();
            if (now > weeklyResetTime) {
                // Reset weekly progress
                weeklyProgress = {};
                // Set next reset to coming Sunday midnight
                const nextSunday = new Date();
                nextSunday.setDate(nextSunday.getDate() + (7 - nextSunday.getDay()));
                nextSunday.setHours(0, 0, 0, 0);
                weeklyResetTime = nextSunday.getTime();

                localStorage.setItem('weeklyProgress', JSON.stringify(weeklyProgress));
                localStorage.setItem('weeklyResetTime', weeklyResetTime);
            }
        }

        function updateChallengeTimer() {
            const now = Date.now();
            const remaining = weeklyResetTime - now;

            if (remaining <= 0) {
                document.getElementById('challenge-timer').textContent = 'Resetting...';
                return;
            }

            const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
            const hours = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));

            document.getElementById('challenge-timer').textContent = `${days}d ${hours}h ${minutes}m`;
        }

        function displayWeeklyChallenges() {
            const container = document.getElementById('weekly-challenges-container');

            container.innerHTML = weeklyChallenges.map(challenge => {
                const current = weeklyProgress[challenge.key] || 0;
                const progress = Math.min((current / challenge.target) * 100, 100);
                const isCompleted = current >= challenge.target;
                const claimedKey = `claimed_${challenge.id}`;
                const isClaimed = weeklyProgress[claimedKey] || false;

                return `
                    <div class="challenge-card ${isCompleted ? 'completed' : ''}">
                        <div class="challenge-icon">${challenge.icon}</div>
                        <div class="challenge-title">${challenge.title}</div>
                        <div class="challenge-desc">${challenge.desc}</div>
                        <div class="challenge-progress">
                            <div class="challenge-progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #aaa; font-size: 0.85rem;">${current} / ${challenge.target}</span>
                            <div class="challenge-reward">
                                ${isCompleted && !isClaimed
                                    ? `<button onclick="claimChallengeReward('${challenge.id}', ${challenge.reward})" style="background: #ffc107; color: #333; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold;">Claim ${challenge.reward} XP</button>`
                                    : isClaimed
                                        ? `<span style="color: #4caf50;"> Claimed</span>`
                                        : `<span> ${challenge.reward} XP</span>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function claimChallengeReward(challengeId, reward) {
            const claimedKey = `claimed_${challengeId}`;
            if (weeklyProgress[claimedKey]) return;

            weeklyProgress[claimedKey] = true;
            localStorage.setItem('weeklyProgress', JSON.stringify(weeklyProgress));

            if (typeof addXP === 'function') addXP(reward);
            showToast(` Challenge completed! +${reward} XP`, 'success');
            if (typeof playLevelUpSound === 'function') playLevelUpSound();

            displayWeeklyChallenges();
        }

        function updateWeeklyProgress(key, value = 1) {
            checkWeeklyReset();
            weeklyProgress[key] = (weeklyProgress[key] || 0) + value;
            localStorage.setItem('weeklyProgress', JSON.stringify(weeklyProgress));
        }

        // Update timer every minute
        setInterval(updateChallengeTimer, 60000);

        // Initialize weekly reset check on load
        checkWeeklyReset();

        console.log(' Question History, Science Calculator, and Weekly Challenges loaded!');
    </script>

    <!-- ===== Batch 45: Science Flashcards, Learning Paths, Speed Quiz ===== -->
    <button class="floating-flashcards-btn" onclick="openFlashcardsModal()" title="Flashcards"></button>
    <button class="floating-paths-btn" onclick="openPathsModal()" title="Learning Paths"></button>
    <button class="floating-speedquiz-btn" onclick="openSpeedQuizModal()" title="Speed Quiz"></button>

    <!-- Flashcards Modal -->
    <div class="flashcards-modal" id="flashcards-modal">
        <div class="flashcards-content">
            <button class="modal-close-btn" onclick="closeFlashcardsModal()">&times;</button>
            <div class="flashcards-header">
                <h2> Science Flashcards</h2>
                <p style="color: #aaa;">Click the card to flip and reveal the answer!</p>
            </div>
            <div class="flashcard-container">
                <div class="flashcard" id="flashcard" onclick="flipFlashcard()">
                    <div class="flashcard-face flashcard-front" id="flashcard-front"></div>
                    <div class="flashcard-face flashcard-back" id="flashcard-back"></div>
                </div>
            </div>
            <div class="flashcard-progress" id="flashcard-progress"></div>
            <div class="flashcard-controls">
                <button class="flashcard-btn prev" onclick="prevFlashcard()"> Previous</button>
                <button class="flashcard-btn next" onclick="nextFlashcard()">Next </button>
            </div>
        </div>
    </div>

    <!-- Learning Paths Modal -->
    <div class="paths-modal" id="paths-modal">
        <div class="paths-content">
            <button class="modal-close-btn" onclick="closePathsModal()">&times;</button>
            <div class="paths-header">
                <h2> Learning Paths</h2>
                <p style="color: #aaa;">Follow structured paths to master science topics!</p>
            </div>
            <div id="learning-paths-container"></div>
        </div>
    </div>

    <!-- Speed Quiz Modal -->
    <div class="speed-quiz-modal" id="speed-quiz-modal">
        <div class="speed-quiz-content">
            <button class="modal-close-btn" onclick="closeSpeedQuizModal()">&times;</button>
            <div class="speed-quiz-header">
                <h2> Speed Quiz</h2>
                <p style="color: #aaa;">Answer as many questions as you can before time runs out!</p>
            </div>
            <div id="speed-quiz-area"></div>
        </div>
    </div>

    <script>
        // ===== Batch 45: Science Flashcards, Learning Paths, Speed Quiz =====

        // Flashcard Data
        const flashcardsData = [
            { category: 'Matter', question: 'What are the three states of matter?', answer: 'Solid, Liquid, and Gas' },
            { category: 'Matter', question: 'What is the smallest particle of an element?', answer: 'An atom' },
            { category: 'Energy', question: 'What is the energy of motion called?', answer: 'Kinetic energy' },
            { category: 'Energy', question: 'What type of energy is stored in food?', answer: 'Chemical energy' },
            { category: 'Forces', question: 'What force pulls objects toward the Earth?', answer: 'Gravity' },
            { category: 'Forces', question: 'What force opposes motion between surfaces?', answer: 'Friction' },
            { category: 'Light', question: 'What happens when light passes through a prism?', answer: 'It separates into a spectrum of colors (rainbow)' },
            { category: 'Light', question: 'What are the primary colors of light?', answer: 'Red, Green, and Blue' },
            { category: 'Heat', question: 'How does heat transfer through direct contact?', answer: 'Conduction' },
            { category: 'Heat', question: 'Does heat flow from hot to cold or cold to hot?', answer: 'Hot to cold' },
            { category: 'Plants', question: 'What process do plants use to make food?', answer: 'Photosynthesis' },
            { category: 'Plants', question: 'What gas do plants release during photosynthesis?', answer: 'Oxygen' },
            { category: 'Electricity', question: 'What is a complete path for electricity called?', answer: 'An electrical circuit' },
            { category: 'Electricity', question: 'What materials allow electricity to flow through them?', answer: 'Conductors' },
            { category: 'Animals', question: 'What do we call animals that eat only plants?', answer: 'Herbivores' },
            { category: 'Animals', question: 'What are animals with backbones called?', answer: 'Vertebrates' }
        ];

        let currentFlashcardIndex = 0;
        let isFlashcardFlipped = false;

        function openFlashcardsModal() {
            document.getElementById('flashcards-modal').style.display = 'flex';
            currentFlashcardIndex = 0;
            isFlashcardFlipped = false;
            displayFlashcard();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeFlashcardsModal() {
            document.getElementById('flashcards-modal').style.display = 'none';
        }

        function displayFlashcard() {
            const card = flashcardsData[currentFlashcardIndex];
            const flashcard = document.getElementById('flashcard');

            flashcard.classList.remove('flipped');
            isFlashcardFlipped = false;

            document.getElementById('flashcard-front').innerHTML = `
                <div class="flashcard-category">${card.category}</div>
                <div class="flashcard-question">${card.question}</div>
                <div class="flashcard-hint">Click to reveal answer</div>
            `;

            document.getElementById('flashcard-back').innerHTML = `
                <div class="flashcard-category">Answer</div>
                <div class="flashcard-answer">${card.answer}</div>
            `;

            document.getElementById('flashcard-progress').textContent =
                `Card ${currentFlashcardIndex + 1} of ${flashcardsData.length}`;
        }

        function flipFlashcard() {
            const flashcard = document.getElementById('flashcard');
            flashcard.classList.toggle('flipped');
            isFlashcardFlipped = !isFlashcardFlipped;
            if (typeof playClickSound === 'function') playClickSound();
        }

        function nextFlashcard() {
            currentFlashcardIndex = (currentFlashcardIndex + 1) % flashcardsData.length;
            displayFlashcard();
        }

        function prevFlashcard() {
            currentFlashcardIndex = (currentFlashcardIndex - 1 + flashcardsData.length) % flashcardsData.length;
            displayFlashcard();
        }

        // Learning Paths Data
        const learningPathsData = [
            {
                id: 'matter',
                icon: '',
                title: 'Matter Explorer',
                desc: 'Learn about states of matter and changes',
                steps: [
                    { title: 'States of Matter', key: 'matter_states' },
                    { title: 'Properties of Matter', key: 'matter_properties' },
                    { title: 'Changes in Matter', key: 'matter_changes' },
                    { title: 'Matter Quiz', key: 'matter_quiz' }
                ]
            },
            {
                id: 'energy',
                icon: '',
                title: 'Energy Master',
                desc: 'Understand different forms of energy',
                steps: [
                    { title: 'Types of Energy', key: 'energy_types' },
                    { title: 'Energy Transfer', key: 'energy_transfer' },
                    { title: 'Conservation of Energy', key: 'energy_conservation' },
                    { title: 'Energy Quiz', key: 'energy_quiz' }
                ]
            },
            {
                id: 'life',
                icon: '',
                title: 'Life Science Journey',
                desc: 'Explore plants, animals, and ecosystems',
                steps: [
                    { title: 'Plant Life', key: 'life_plants' },
                    { title: 'Animal Classifications', key: 'life_animals' },
                    { title: 'Food Chains & Webs', key: 'life_food' },
                    { title: 'Ecosystems', key: 'life_ecosystems' },
                    { title: 'Life Science Quiz', key: 'life_quiz' }
                ]
            }
        ];

        let pathProgress = JSON.parse(localStorage.getItem('pathProgress')) || {};

        function openPathsModal() {
            document.getElementById('paths-modal').style.display = 'flex';
            displayLearningPaths();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closePathsModal() {
            document.getElementById('paths-modal').style.display = 'none';
        }

        function displayLearningPaths() {
            const container = document.getElementById('learning-paths-container');

            container.innerHTML = learningPathsData.map(path => {
                const completedSteps = path.steps.filter(s => pathProgress[s.key]).length;
                const progress = (completedSteps / path.steps.length) * 100;
                const currentStepIndex = path.steps.findIndex(s => !pathProgress[s.key]);

                return `
                    <div class="learning-path">
                        <div class="path-header">
                            <div class="path-icon">${path.icon}</div>
                            <div class="path-info">
                                <h3>${path.title}</h3>
                                <p>${path.desc}</p>
                            </div>
                        </div>
                        <div class="path-steps">
                            ${path.steps.map((step, i) => {
                                const isCompleted = pathProgress[step.key];
                                const isCurrent = i === currentStepIndex;
                                return `
                                    <div class="path-step ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}" onclick="completePathStep('${step.key}')">
                                        <div class="step-number">${isCompleted ? '' : i + 1}</div>
                                        <div class="step-content">
                                            <div class="step-title">${step.title}</div>
                                        </div>
                                        <div class="step-status">${isCompleted ? '' : isCurrent ? '' : ''}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="path-progress-bar">
                            <div class="path-progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div style="text-align: center; margin-top: 10px; color: #aaa; font-size: 0.85rem;">
                            ${completedSteps} / ${path.steps.length} steps completed
                        </div>
                    </div>
                `;
            }).join('');
        }

        function completePathStep(stepKey) {
            if (!pathProgress[stepKey]) {
                pathProgress[stepKey] = true;
                localStorage.setItem('pathProgress', JSON.stringify(pathProgress));

                if (typeof addXP === 'function') addXP(15);
                showToast(' Step completed! +15 XP', 'success');
            }
            displayLearningPaths();
        }

        // Speed Quiz System
        const speedQuizQuestions = [
            { q: 'What is the boiling point of water in Celsius?', options: ['50C', '100C', '150C', '200C'], answer: 1 },
            { q: 'Which planet is closest to the Sun?', options: ['Venus', 'Earth', 'Mercury', 'Mars'], answer: 2 },
            { q: 'What gas do plants absorb from the air?', options: ['Oxygen', 'Nitrogen', 'Carbon dioxide', 'Hydrogen'], answer: 2 },
            { q: 'What is the largest organ in the human body?', options: ['Heart', 'Liver', 'Brain', 'Skin'], answer: 3 },
            { q: 'How many legs does an insect have?', options: ['4', '6', '8', '10'], answer: 1 },
            { q: 'What type of animal is a frog?', options: ['Reptile', 'Mammal', 'Amphibian', 'Fish'], answer: 2 },
            { q: 'What force keeps planets in orbit around the Sun?', options: ['Magnetism', 'Friction', 'Gravity', 'Electricity'], answer: 2 },
            { q: 'What is H2O commonly known as?', options: ['Salt', 'Sugar', 'Water', 'Air'], answer: 2 },
            { q: 'Which metal is liquid at room temperature?', options: ['Iron', 'Mercury', 'Gold', 'Silver'], answer: 1 },
            { q: 'What do we call a scientist who studies rocks?', options: ['Biologist', 'Geologist', 'Chemist', 'Physicist'], answer: 1 },
            { q: 'How many bones are in an adult human body?', options: ['106', '156', '206', '256'], answer: 2 },
            { q: 'What is the process of water turning into vapor called?', options: ['Condensation', 'Evaporation', 'Precipitation', 'Freezing'], answer: 1 },
            { q: 'What color is chlorophyll?', options: ['Red', 'Yellow', 'Green', 'Blue'], answer: 2 },
            { q: 'Which is NOT a renewable energy source?', options: ['Solar', 'Wind', 'Coal', 'Hydro'], answer: 2 },
            { q: 'What is the chemical symbol for gold?', options: ['Go', 'Gd', 'Au', 'Ag'], answer: 2 }
        ];

        let speedQuizState = {
            isActive: false,
            difficulty: 'medium',
            timeRemaining: 60,
            score: 0,
            questionsAnswered: 0,
            correctAnswers: 0,
            currentQuestion: null,
            usedQuestions: [],
            timerInterval: null
        };

        function openSpeedQuizModal() {
            document.getElementById('speed-quiz-modal').style.display = 'flex';
            showSpeedStartScreen();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeSpeedQuizModal() {
            document.getElementById('speed-quiz-modal').style.display = 'none';
            endSpeedQuiz();
        }

        function showSpeedStartScreen() {
            const area = document.getElementById('speed-quiz-area');
            area.innerHTML = `
                <div class="speed-start-screen">
                    <div style="font-size: 4rem; margin-bottom: 20px;"></div>
                    <p style="color: #aaa; font-size: 1.1rem;">Answer as many questions as possible!</p>
                    <div class="speed-difficulty-select">
                        <button class="difficulty-btn ${speedQuizState.difficulty === 'easy' ? 'selected' : ''}" onclick="setSpeedDifficulty('easy')">Easy (90s)</button>
                        <button class="difficulty-btn ${speedQuizState.difficulty === 'medium' ? 'selected' : ''}" onclick="setSpeedDifficulty('medium')">Medium (60s)</button>
                        <button class="difficulty-btn ${speedQuizState.difficulty === 'hard' ? 'selected' : ''}" onclick="setSpeedDifficulty('hard')">Hard (30s)</button>
                    </div>
                    <button class="speed-start-btn" onclick="startSpeedQuiz()">Start Quiz!</button>
                </div>
            `;
        }

        function setSpeedDifficulty(difficulty) {
            speedQuizState.difficulty = difficulty;
            showSpeedStartScreen();
        }

        function startSpeedQuiz() {
            speedQuizState.isActive = true;
            speedQuizState.score = 0;
            speedQuizState.questionsAnswered = 0;
            speedQuizState.correctAnswers = 0;
            speedQuizState.usedQuestions = [];

            switch(speedQuizState.difficulty) {
                case 'easy': speedQuizState.timeRemaining = 90; break;
                case 'medium': speedQuizState.timeRemaining = 60; break;
                case 'hard': speedQuizState.timeRemaining = 30; break;
            }

            loadSpeedQuestion();
            startSpeedTimer();
        }

        function startSpeedTimer() {
            speedQuizState.timerInterval = setInterval(() => {
                speedQuizState.timeRemaining--;
                updateSpeedTimerDisplay();

                if (speedQuizState.timeRemaining <= 0) {
                    endSpeedQuiz();
                }
            }, 1000);
        }

        function updateSpeedTimerDisplay() {
            const timerEl = document.getElementById('speed-timer');
            if (timerEl) {
                timerEl.textContent = speedQuizState.timeRemaining;
                timerEl.className = 'speed-timer';
                if (speedQuizState.timeRemaining <= 10) {
                    timerEl.classList.add('danger');
                } else if (speedQuizState.timeRemaining <= 20) {
                    timerEl.classList.add('warning');
                }
            }
        }

        function loadSpeedQuestion() {
            // Get unused questions
            const availableQuestions = speedQuizQuestions.filter((_, i) => !speedQuizState.usedQuestions.includes(i));

            if (availableQuestions.length === 0) {
                speedQuizState.usedQuestions = [];
            }

            const remainingIndices = speedQuizQuestions.map((_, i) => i).filter(i => !speedQuizState.usedQuestions.includes(i));
            const randomIndex = remainingIndices[Math.floor(Math.random() * remainingIndices.length)];

            speedQuizState.usedQuestions.push(randomIndex);
            speedQuizState.currentQuestion = { ...speedQuizQuestions[randomIndex], index: randomIndex };

            displaySpeedQuestion();
        }

        function displaySpeedQuestion() {
            const area = document.getElementById('speed-quiz-area');
            const q = speedQuizState.currentQuestion;

            area.innerHTML = `
                <div class="speed-timer-display">
                    <div class="speed-timer" id="speed-timer">${speedQuizState.timeRemaining}</div>
                    <div class="speed-score">
                        <div class="speed-score-value">${speedQuizState.score}</div>
                        <div class="speed-score-label">Points</div>
                    </div>
                </div>
                <div class="speed-question">
                    <div class="speed-question-text">${q.q}</div>
                </div>
                <div class="speed-options">
                    ${q.options.map((opt, i) => `
                        <button class="speed-option" onclick="answerSpeedQuestion(${i})">${opt}</button>
                    `).join('')}
                </div>
            `;
        }

        function answerSpeedQuestion(selectedIndex) {
            if (!speedQuizState.isActive) return;

            const q = speedQuizState.currentQuestion;
            const isCorrect = selectedIndex === q.answer;

            speedQuizState.questionsAnswered++;
            if (isCorrect) {
                speedQuizState.correctAnswers++;
                speedQuizState.score += 10;
                speedQuizState.timeRemaining += 2; // Bonus time for correct answer
            }

            // Show feedback briefly
            const options = document.querySelectorAll('.speed-option');
            options[q.answer].classList.add('correct');
            if (!isCorrect) {
                options[selectedIndex].classList.add('incorrect');
            }

            // Disable options
            options.forEach(opt => opt.onclick = null);

            // Load next question after brief delay
            setTimeout(() => {
                if (speedQuizState.isActive) {
                    loadSpeedQuestion();
                }
            }, 500);
        }

        function endSpeedQuiz() {
            speedQuizState.isActive = false;
            if (speedQuizState.timerInterval) {
                clearInterval(speedQuizState.timerInterval);
                speedQuizState.timerInterval = null;
            }

            showSpeedResults();
        }

        function showSpeedResults() {
            const area = document.getElementById('speed-quiz-area');
            const accuracy = speedQuizState.questionsAnswered > 0
                ? Math.round((speedQuizState.correctAnswers / speedQuizState.questionsAnswered) * 100)
                : 0;

            // Award XP based on score
            const xpEarned = Math.round(speedQuizState.score * 1.5);
            if (typeof addXP === 'function' && xpEarned > 0) addXP(xpEarned);

            area.innerHTML = `
                <div class="speed-results">
                    <div style="font-size: 4rem;"></div>
                    <h3 style="color: #ff8a65;">Time's Up!</h3>
                    <div class="speed-results-score">${speedQuizState.score} Points</div>
                    <div class="speed-results-stats">
                        <div class="speed-stat">
                            <div class="speed-stat-value">${speedQuizState.questionsAnswered}</div>
                            <div class="speed-stat-label">Questions</div>
                        </div>
                        <div class="speed-stat">
                            <div class="speed-stat-value">${speedQuizState.correctAnswers}</div>
                            <div class="speed-stat-label">Correct</div>
                        </div>
                        <div class="speed-stat">
                            <div class="speed-stat-value">${accuracy}%</div>
                            <div class="speed-stat-label">Accuracy</div>
                        </div>
                        <div class="speed-stat">
                            <div class="speed-stat-value">+${xpEarned}</div>
                            <div class="speed-stat-label">XP Earned</div>
                        </div>
                    </div>
                    <button class="speed-start-btn" onclick="showSpeedStartScreen()">Play Again</button>
                </div>
            `;
        }

        console.log(' Flashcards, Learning Paths, and Speed Quiz loaded!');
    </script>

    <!-- ===== Batch 46: Daily Facts, Quiz Battle, Topic Summaries ===== -->
    <button class="floating-facts-btn" onclick="openDailyFactsModal()" title="Daily Facts"></button>
    <button class="floating-battle-btn" onclick="openQuizBattleModal()" title="Quiz Battle"></button>
    <button class="floating-summaries-btn" onclick="openSummariesModal()" title="Topic Summaries"></button>

    <!-- Daily Facts Modal -->
    <div class="daily-facts-modal" id="daily-facts-modal">
        <div class="daily-facts-content">
            <button class="modal-close-btn" onclick="closeDailyFactsModal()">&times;</button>
            <div class="daily-facts-header">
                <h2> Daily Science Fact</h2>
                <p style="color: #aaa;">Learn something new every day!</p>
            </div>
            <div id="daily-facts-container"></div>
        </div>
    </div>

    <!-- Quiz Battle Modal -->
    <div class="quiz-battle-modal" id="quiz-battle-modal">
        <div class="quiz-battle-content">
            <button class="modal-close-btn" onclick="closeQuizBattleModal()">&times;</button>
            <div class="quiz-battle-header">
                <h2> Quiz Battle</h2>
                <p style="color: #aaa;">Challenge an AI opponent!</p>
            </div>
            <div id="quiz-battle-area"></div>
        </div>
    </div>

    <!-- Topic Summaries Modal -->
    <div class="summaries-modal" id="summaries-modal">
        <div class="summaries-content">
            <button class="modal-close-btn" onclick="closeSummariesModal()">&times;</button>
            <div class="summaries-header">
                <h2> Topic Summaries</h2>
                <p style="color: #aaa;">Quick reference guides for science topics</p>
            </div>
            <div class="summary-tabs" id="summary-tabs"></div>
            <div id="summary-content"></div>
        </div>
    </div>

    <script>
        // ===== Batch 46: Daily Facts, Quiz Battle, Topic Summaries =====

        // Daily Facts Data
        const dailyFactsData = [
            { icon: '', fact: 'Earth is the only planet not named after a Greek or Roman god.', category: 'Space' },
            { icon: '', fact: 'Water can exist in three states at the same temperature (triple point): 0.01C.', category: 'Chemistry' },
            { icon: '', fact: 'Butterflies taste with their feet to identify plants for laying eggs.', category: 'Biology' },
            { icon: '', fact: 'Lightning strikes the Earth about 100 times every second.', category: 'Weather' },
            { icon: '', fact: 'The human brain uses about 20% of the body\'s total energy.', category: 'Biology' },
            { icon: '', fact: 'A rainbow is actually a full circle, but we only see half from the ground.', category: 'Light' },
            { icon: '', fact: 'Octopuses have three hearts and blue blood.', category: 'Biology' },
            { icon: '', fact: 'The coldest temperature ever recorded on Earth was -89.2C in Antarctica.', category: 'Weather' },
            { icon: '', fact: 'Saturn is so light it would float if you could put it in a giant bathtub.', category: 'Space' },
            { icon: '', fact: 'A teaspoon of neutron star would weigh about 6 billion tons.', category: 'Space' },
            { icon: '', fact: 'Sound travels 4 times faster in water than in air.', category: 'Physics' },
            { icon: '', fact: 'Babies are born with about 300 bones, but adults only have 206.', category: 'Biology' },
            { icon: '', fact: 'Trees release oxygen during the day and carbon dioxide at night.', category: 'Biology' },
            { icon: '', fact: 'Fire needs oxygen to burn - that\'s why you can smother flames with a blanket.', category: 'Chemistry' },
            { icon: '', fact: 'The Earth\'s magnetic field protects us from solar radiation.', category: 'Earth Science' }
        ];

        let factsStreak = parseInt(localStorage.getItem('factsStreak')) || 0;
        let lastFactDate = localStorage.getItem('lastFactDate') || '';
        let viewedFacts = JSON.parse(localStorage.getItem('viewedFacts')) || [];

        function openDailyFactsModal() {
            document.getElementById('daily-facts-modal').style.display = 'flex';
            displayDailyFact();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeDailyFactsModal() {
            document.getElementById('daily-facts-modal').style.display = 'none';
        }

        function displayDailyFact() {
            const today = new Date().toDateString();
            const container = document.getElementById('daily-facts-container');

            // Check streak
            if (lastFactDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (lastFactDate === yesterday.toDateString()) {
                    factsStreak++;
                } else if (lastFactDate !== '') {
                    factsStreak = 1;
                } else {
                    factsStreak = 1;
                }

                lastFactDate = today;
                localStorage.setItem('factsStreak', factsStreak);
                localStorage.setItem('lastFactDate', lastFactDate);

                // Award XP for checking daily
                if (typeof addXP === 'function') addXP(5);
            }

            // Get today's fact based on date
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const factIndex = dayOfYear % dailyFactsData.length;
            const todaysFact = dailyFactsData[factIndex];

            // Store viewed fact
            if (!viewedFacts.includes(factIndex)) {
                viewedFacts.push(factIndex);
                if (viewedFacts.length > 30) viewedFacts = viewedFacts.slice(-30);
                localStorage.setItem('viewedFacts', JSON.stringify(viewedFacts));
            }

            container.innerHTML = `
                <div class="fact-of-day">
                    <div class="fact-date">Today's Fact - ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</div>
                    <div class="fact-icon">${todaysFact.icon}</div>
                    <div class="fact-text">${todaysFact.fact}</div>
                    <div class="fact-category">${todaysFact.category}</div>
                </div>
                <div class="fact-streak">
                    <div class="fact-streak-item">
                        <div class="fact-streak-value"> ${factsStreak}</div>
                        <div class="fact-streak-label">Day Streak</div>
                    </div>
                    <div class="fact-streak-item">
                        <div class="fact-streak-value">${viewedFacts.length}</div>
                        <div class="fact-streak-label">Facts Learned</div>
                    </div>
                </div>
                <div class="past-facts">
                    <div class="past-facts-title">Recent Facts</div>
                    ${viewedFacts.slice(-5).reverse().map((idx, i) => {
                        if (i === 0) return '';
                        const fact = dailyFactsData[idx];
                        return `
                            <div class="past-fact-item">
                                <p>${fact.icon} ${fact.fact}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Quiz Battle System
        const battleQuestions = [
            { q: 'What is the chemical formula for water?', options: ['CO2', 'H2O', 'O2', 'NaCl'], answer: 1 },
            { q: 'How many continents are there?', options: ['5', '6', '7', '8'], answer: 2 },
            { q: 'What is the largest mammal?', options: ['Elephant', 'Blue Whale', 'Giraffe', 'Hippo'], answer: 1 },
            { q: 'What planet is known as the Red Planet?', options: ['Venus', 'Jupiter', 'Mars', 'Saturn'], answer: 2 },
            { q: 'What is the hardest natural substance?', options: ['Gold', 'Iron', 'Diamond', 'Platinum'], answer: 2 },
            { q: 'What gas do humans exhale?', options: ['Oxygen', 'Nitrogen', 'Carbon Dioxide', 'Helium'], answer: 2 },
            { q: 'How many teeth does an adult human have?', options: ['28', '30', '32', '34'], answer: 2 },
            { q: 'What is the speed of light?', options: ['300 km/s', '300,000 km/s', '30,000 km/s', '3,000 km/s'], answer: 1 }
        ];

        let battleState = {
            isActive: false,
            playerScore: 0,
            opponentScore: 0,
            currentQuestion: 0,
            questions: [],
            opponentNames: ['ScienceBot', 'BrainMaster', 'QuizWiz', 'EinsteinJr', 'NewtonAI'],
            currentOpponent: ''
        };

        function openQuizBattleModal() {
            document.getElementById('quiz-battle-modal').style.display = 'flex';
            showBattleStartScreen();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeQuizBattleModal() {
            document.getElementById('quiz-battle-modal').style.display = 'none';
            battleState.isActive = false;
        }

        function showBattleStartScreen() {
            const area = document.getElementById('quiz-battle-area');
            area.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 5rem; margin-bottom: 20px;"></div>
                    <p style="color: #aaa; font-size: 1.1rem; margin-bottom: 20px;">Challenge an AI opponent in a 5-question battle!</p>
                    <p style="color: #ef9a9a; font-size: 0.9rem;">Answer faster and more accurately to win!</p>
                    <button class="battle-start-btn" onclick="startBattle()">Find Opponent</button>
                </div>
            `;
        }

        function startBattle() {
            battleState.isActive = true;
            battleState.playerScore = 0;
            battleState.opponentScore = 0;
            battleState.currentQuestion = 0;
            battleState.currentOpponent = battleState.opponentNames[Math.floor(Math.random() * battleState.opponentNames.length)];

            // Shuffle and pick 5 questions
            const shuffled = [...battleQuestions].sort(() => Math.random() - 0.5);
            battleState.questions = shuffled.slice(0, 5);

            loadBattleQuestion();
        }

        function loadBattleQuestion() {
            if (battleState.currentQuestion >= battleState.questions.length) {
                endBattle();
                return;
            }

            displayBattleQuestion();
        }

        function displayBattleQuestion() {
            const area = document.getElementById('quiz-battle-area');
            const q = battleState.questions[battleState.currentQuestion];

            area.innerHTML = `
                <div class="battle-players">
                    <div class="battle-player">
                        <div class="battle-avatar"></div>
                        <div class="battle-name">You</div>
                        <div class="battle-score">${battleState.playerScore}</div>
                    </div>
                    <div class="battle-vs">VS</div>
                    <div class="battle-player">
                        <div class="battle-avatar opponent"></div>
                        <div class="battle-name">${battleState.currentOpponent}</div>
                        <div class="battle-score opponent">${battleState.opponentScore}</div>
                    </div>
                </div>
                <div style="text-align: center; color: #aaa; margin-bottom: 15px;">Question ${battleState.currentQuestion + 1} of ${battleState.questions.length}</div>
                <div class="battle-question">
                    <div class="battle-question-text">${q.q}</div>
                </div>
                <div class="battle-options">
                    ${q.options.map((opt, i) => `
                        <button class="battle-option" onclick="answerBattle(${i})">${opt}</button>
                    `).join('')}
                </div>
            `;
        }

        function answerBattle(selectedIndex) {
            if (!battleState.isActive) return;

            const q = battleState.questions[battleState.currentQuestion];
            const isCorrect = selectedIndex === q.answer;

            // Simulate opponent answer (60-80% accuracy)
            const opponentCorrect = Math.random() < 0.7;

            if (isCorrect) battleState.playerScore++;
            if (opponentCorrect) battleState.opponentScore++;

            battleState.currentQuestion++;

            setTimeout(() => loadBattleQuestion(), 800);
        }

        function endBattle() {
            battleState.isActive = false;
            const area = document.getElementById('quiz-battle-area');

            let resultIcon, resultText, resultClass;
            if (battleState.playerScore > battleState.opponentScore) {
                resultIcon = '';
                resultText = 'Victory!';
                resultClass = 'win';
                if (typeof addXP === 'function') addXP(50);
            } else if (battleState.playerScore < battleState.opponentScore) {
                resultIcon = '';
                resultText = 'Defeat';
                resultClass = 'lose';
                if (typeof addXP === 'function') addXP(15);
            } else {
                resultIcon = '';
                resultText = 'Draw!';
                resultClass = 'draw';
                if (typeof addXP === 'function') addXP(25);
            }

            area.innerHTML = `
                <div class="battle-result">
                    <div class="battle-result-icon">${resultIcon}</div>
                    <div class="battle-result-text ${resultClass}">${resultText}</div>
                    <div style="color: #aaa; margin-bottom: 20px;">
                        You: ${battleState.playerScore} - ${battleState.currentOpponent}: ${battleState.opponentScore}
                    </div>
                    <button class="battle-start-btn" onclick="showBattleStartScreen()">Battle Again</button>
                </div>
            `;
        }

        // Topic Summaries
        const topicSummaries = {
            'Matter': {
                icon: '',
                title: 'States of Matter',
                description: 'Matter is anything that has mass and takes up space. It exists in three main states: solid, liquid, and gas.',
                keyPoints: [
                    'Solids have a fixed shape and volume. Particles are tightly packed.',
                    'Liquids have a fixed volume but take the shape of their container.',
                    'Gases have no fixed shape or volume. Particles move freely.',
                    'Matter can change states through heating or cooling.'
                ],
                examples: ['Ice (solid)  Water (liquid)  Steam (gas)', 'Chocolate melting in the sun']
            },
            'Energy': {
                icon: '',
                title: 'Forms of Energy',
                description: 'Energy is the ability to do work or cause change. It cannot be created or destroyed, only transformed.',
                keyPoints: [
                    'Kinetic energy is the energy of motion.',
                    'Potential energy is stored energy that can be released.',
                    'Energy can change from one form to another.',
                    'Common forms: light, heat, sound, electrical, chemical.'
                ],
                examples: ['A ball rolling down a hill converts potential to kinetic', 'Food converts chemical energy to movement']
            },
            'Forces': {
                icon: '',
                title: 'Forces and Motion',
                description: 'A force is a push or pull that can change an object\'s motion, shape, or direction.',
                keyPoints: [
                    'Gravity pulls objects toward Earth\'s center.',
                    'Friction opposes motion between surfaces.',
                    'Balanced forces result in no change in motion.',
                    'Unbalanced forces cause acceleration.'
                ],
                examples: ['Gravity keeps planets orbiting the Sun', 'Friction allows us to walk without slipping']
            },
            'Light': {
                icon: '',
                title: 'Light and Optics',
                description: 'Light is a form of energy that travels in waves. It allows us to see the world around us.',
                keyPoints: [
                    'Light travels in straight lines.',
                    'White light is made of all colors of the spectrum.',
                    'Light can be reflected, refracted, or absorbed.',
                    'Primary colors of light: red, green, blue.'
                ],
                examples: ['Rainbows form when light refracts through water drops', 'Mirrors reflect light to create images']
            },
            'Plants': {
                icon: '',
                title: 'Plant Life',
                description: 'Plants are living organisms that make their own food through photosynthesis using sunlight, water, and carbon dioxide.',
                keyPoints: [
                    'Photosynthesis converts sunlight into food (glucose).',
                    'Plants release oxygen as a byproduct.',
                    'Roots absorb water and minerals from soil.',
                    'Leaves capture sunlight for photosynthesis.'
                ],
                examples: ['Trees produce oxygen we breathe', 'Sunflowers turn toward the sun']
            }
        };

        let currentSummaryTopic = 'Matter';

        function openSummariesModal() {
            document.getElementById('summaries-modal').style.display = 'flex';
            initSummaryTabs();
            displaySummary();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeSummariesModal() {
            document.getElementById('summaries-modal').style.display = 'none';
        }

        function initSummaryTabs() {
            const tabs = document.getElementById('summary-tabs');
            const topics = Object.keys(topicSummaries);

            tabs.innerHTML = topics.map(topic => `
                <button class="summary-tab ${topic === currentSummaryTopic ? 'active' : ''}" onclick="selectSummaryTopic('${topic}')">
                    ${topicSummaries[topic].icon} ${topic}
                </button>
            `).join('');
        }

        function selectSummaryTopic(topic) {
            currentSummaryTopic = topic;
            initSummaryTabs();
            displaySummary();
        }

        function displaySummary() {
            const content = document.getElementById('summary-content');
            const summary = topicSummaries[currentSummaryTopic];

            content.innerHTML = `
                <div class="summary-card">
                    <div class="summary-title">${summary.icon} ${summary.title}</div>
                    <div class="summary-description">${summary.description}</div>
                    <div class="summary-key-points">
                        <h4>Key Points</h4>
                        ${summary.keyPoints.map(point => `
                            <div class="key-point">
                                <span class="key-point-icon"></span>
                                <span class="key-point-text">${point}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="summary-examples">
                        <h4>Examples</h4>
                        ${summary.examples.map(ex => `
                            <div class="example-item"> ${ex}</div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        console.log(' Daily Facts, Quiz Battle, and Topic Summaries loaded!');
    </script>

    <!-- ===== Batch 47: Achievement Badges, Word Search, Topic Quizzes ===== -->
    <button class="floating-badges-btn" onclick="openBadgesModal()" title="Achievement Badges"></button>
    <button class="floating-wordsearch-btn" onclick="openWordsearchModal()" title="Word Search"></button>
    <button class="floating-topicquiz-btn" onclick="openTopicQuizModal()" title="Topic Quiz"></button>

    <!-- Achievement Badges Modal -->
    <div class="badges-modal" id="badges-modal">
        <div class="badges-content">
            <button class="modal-close-btn" onclick="closeBadgesModal()">&times;</button>
            <div class="badges-header">
                <h2> Achievement Badges</h2>
                <p style="color: #aaa;">Collect badges for your accomplishments!</p>
            </div>
            <div class="badges-progress" id="badges-progress"></div>
            <div class="badges-grid" id="badges-grid"></div>
        </div>
    </div>

    <!-- Word Search Modal -->
    <div class="wordsearch-modal" id="wordsearch-modal">
        <div class="wordsearch-content">
            <button class="modal-close-btn" onclick="closeWordsearchModal()">&times;</button>
            <div class="wordsearch-header">
                <h2> Science Word Search</h2>
                <p style="color: #aaa;">Find the hidden science words!</p>
            </div>
            <div class="wordsearch-words" id="wordsearch-words"></div>
            <div class="wordsearch-grid" id="wordsearch-grid"></div>
            <div class="wordsearch-score" id="wordsearch-score"></div>
            <button class="wordsearch-btn" onclick="generateWordsearch()">New Puzzle</button>
        </div>
    </div>

    <!-- Topic Quiz Modal -->
    <div class="topicquiz-modal" id="topicquiz-modal">
        <div class="topicquiz-content">
            <button class="modal-close-btn" onclick="closeTopicQuizModal()">&times;</button>
            <div class="topicquiz-header">
                <h2> Topic Quiz</h2>
                <p style="color: #aaa;">Test your knowledge on specific topics!</p>
            </div>
            <div id="topicquiz-area"></div>
        </div>
    </div>

    <script>
        // ===== Batch 47: Achievement Badges, Word Search, Topic Quizzes =====

        // Achievement Badges Data
        const achievementBadges = [
            { id: 'first_question', icon: '', name: 'First Steps', desc: 'Answer your first question', condition: () => (parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0) >= 1 },
            { id: 'ten_questions', icon: '', name: 'Getting Started', desc: 'Answer 10 questions', condition: () => (parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0) >= 10 },
            { id: 'fifty_questions', icon: '', name: 'Quiz Master', desc: 'Answer 50 questions', condition: () => (parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0) >= 50 },
            { id: 'streak_5', icon: '', name: 'On Fire', desc: 'Get a 5-answer streak', condition: () => (parseInt(localStorage.getItem('answerStreak')) || 0) >= 5 },
            { id: 'streak_10', icon: '', name: 'Unstoppable', desc: 'Get a 10-answer streak', condition: () => (parseInt(localStorage.getItem('answerStreak')) || 0) >= 10 },
            { id: 'vocab_5', icon: '', name: 'Word Learner', desc: 'Learn 5 vocabulary terms', condition: () => Object.values(JSON.parse(localStorage.getItem('learnedVocab')) || {}).filter(v => v).length >= 5 },
            { id: 'experiment_1', icon: '', name: 'Junior Scientist', desc: 'Complete 1 experiment', condition: () => (JSON.parse(localStorage.getItem('completedExperiments')) || []).length >= 1 },
            { id: 'daily_3', icon: '', name: 'Consistent', desc: 'Check facts 3 days in a row', condition: () => (parseInt(localStorage.getItem('factsStreak')) || 0) >= 3 },
            { id: 'battle_win', icon: '', name: 'Champion', desc: 'Win a quiz battle', condition: () => (parseInt(localStorage.getItem('battlesWon')) || 0) >= 1 }
        ];

        let unlockedBadges = JSON.parse(localStorage.getItem('unlockedBadges')) || [];

        function openBadgesModal() {
            document.getElementById('badges-modal').style.display = 'flex';
            checkAndUnlockBadges();
            displayBadges();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeBadgesModal() {
            document.getElementById('badges-modal').style.display = 'none';
        }

        function checkAndUnlockBadges() {
            let newUnlocks = false;
            achievementBadges.forEach(badge => {
                if (!unlockedBadges.includes(badge.id) && badge.condition()) {
                    unlockedBadges.push(badge.id);
                    newUnlocks = true;
                }
            });

            if (newUnlocks) {
                localStorage.setItem('unlockedBadges', JSON.stringify(unlockedBadges));
            }
        }

        function displayBadges() {
            const progress = document.getElementById('badges-progress');
            const grid = document.getElementById('badges-grid');

            progress.innerHTML = `
                <div class="badges-count">${unlockedBadges.length} / ${achievementBadges.length}</div>
                <div style="color: #aaa; font-size: 0.9rem;">Badges Unlocked</div>
            `;

            grid.innerHTML = achievementBadges.map(badge => {
                const isUnlocked = unlockedBadges.includes(badge.id);
                return `
                    <div class="badge-item ${isUnlocked ? 'unlocked' : 'locked'}">
                        ${!isUnlocked ? '<span class="badge-lock-icon"></span>' : ''}
                        <div class="badge-icon">${badge.icon}</div>
                        <div class="badge-name">${badge.name}</div>
                        <div class="badge-desc">${badge.desc}</div>
                    </div>
                `;
            }).join('');
        }

        // Word Search Game
        const wordsearchWordSets = [
            ['ATOM', 'CELL', 'HEAT', 'MASS', 'WAVE'],
            ['LIGHT', 'FORCE', 'PLANT', 'SOLID', 'GAS'],
            ['ENERGY', 'MATTER', 'LIQUID', 'MOTION', 'SOUND']
        ];

        let currentWordsearch = {
            grid: [],
            words: [],
            found: [],
            selectedCells: []
        };

        function openWordsearchModal() {
            document.getElementById('wordsearch-modal').style.display = 'flex';
            generateWordsearch();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeWordsearchModal() {
            document.getElementById('wordsearch-modal').style.display = 'none';
        }

        function generateWordsearch() {
            const size = 8;
            const wordSet = wordsearchWordSets[Math.floor(Math.random() * wordsearchWordSets.length)];
            currentWordsearch.words = wordSet;
            currentWordsearch.found = [];
            currentWordsearch.selectedCells = [];

            // Create empty grid
            currentWordsearch.grid = Array(size).fill(null).map(() => Array(size).fill(''));

            // Place words
            wordSet.forEach(word => {
                placeWord(word, size);
            });

            // Fill remaining cells with random letters
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    if (currentWordsearch.grid[i][j] === '') {
                        currentWordsearch.grid[i][j] = letters[Math.floor(Math.random() * letters.length)];
                    }
                }
            }

            renderWordsearch();
        }

        function placeWord(word, size) {
            const directions = [
                [0, 1],  // horizontal
                [1, 0],  // vertical
                [1, 1]   // diagonal
            ];

            for (let attempts = 0; attempts < 50; attempts++) {
                const dir = directions[Math.floor(Math.random() * directions.length)];
                const startRow = Math.floor(Math.random() * (size - word.length * Math.abs(dir[0])));
                const startCol = Math.floor(Math.random() * (size - word.length * Math.abs(dir[1])));

                if (canPlaceWord(word, startRow, startCol, dir)) {
                    for (let i = 0; i < word.length; i++) {
                        currentWordsearch.grid[startRow + i * dir[0]][startCol + i * dir[1]] = word[i];
                    }
                    return;
                }
            }
        }

        function canPlaceWord(word, row, col, dir) {
            for (let i = 0; i < word.length; i++) {
                const r = row + i * dir[0];
                const c = col + i * dir[1];
                if (r < 0 || r >= 8 || c < 0 || c >= 8) return false;
                const cell = currentWordsearch.grid[r][c];
                if (cell !== '' && cell !== word[i]) return false;
            }
            return true;
        }

        function renderWordsearch() {
            const gridEl = document.getElementById('wordsearch-grid');
            const wordsEl = document.getElementById('wordsearch-words');
            const scoreEl = document.getElementById('wordsearch-score');

            gridEl.style.gridTemplateColumns = `repeat(8, 35px)`;
            gridEl.innerHTML = currentWordsearch.grid.map((row, i) =>
                row.map((cell, j) => {
                    const isFound = currentWordsearch.found.some(f =>
                        f.cells.some(c => c.row === i && c.col === j)
                    );
                    return `<div class="wordsearch-cell ${isFound ? 'found' : ''}" data-row="${i}" data-col="${j}" onclick="selectWordsearchCell(${i}, ${j})">${cell}</div>`;
                }).join('')
            ).join('');

            wordsEl.innerHTML = currentWordsearch.words.map(word =>
                `<span class="wordsearch-word ${currentWordsearch.found.some(f => f.word === word) ? 'found' : ''}">${word}</span>`
            ).join('');

            scoreEl.textContent = `Found: ${currentWordsearch.found.length} / ${currentWordsearch.words.length}`;

            if (currentWordsearch.found.length === currentWordsearch.words.length) {
                if (typeof addXP === 'function') addXP(20);
                showToast(' All words found! +20 XP', 'success');
            }
        }

        function selectWordsearchCell(row, col) {
            const cell = { row, col };
            const existingIndex = currentWordsearch.selectedCells.findIndex(c => c.row === row && c.col === col);

            if (existingIndex >= 0) {
                currentWordsearch.selectedCells.splice(existingIndex, 1);
            } else {
                currentWordsearch.selectedCells.push(cell);
            }

            // Check if selection forms a word
            const selectedWord = currentWordsearch.selectedCells.map(c => currentWordsearch.grid[c.row][c.col]).join('');

            if (currentWordsearch.words.includes(selectedWord) && !currentWordsearch.found.some(f => f.word === selectedWord)) {
                currentWordsearch.found.push({ word: selectedWord, cells: [...currentWordsearch.selectedCells] });
                currentWordsearch.selectedCells = [];
                if (typeof playCorrectSound === 'function') playCorrectSound();
            }

            // Also check reversed
            const reversedWord = selectedWord.split('').reverse().join('');
            if (currentWordsearch.words.includes(reversedWord) && !currentWordsearch.found.some(f => f.word === reversedWord)) {
                currentWordsearch.found.push({ word: reversedWord, cells: [...currentWordsearch.selectedCells] });
                currentWordsearch.selectedCells = [];
                if (typeof playCorrectSound === 'function') playCorrectSound();
            }

            renderWordsearch();

            // Highlight selected cells
            currentWordsearch.selectedCells.forEach(c => {
                const cellEl = document.querySelector(`[data-row="${c.row}"][data-col="${c.col}"]`);
                if (cellEl) cellEl.classList.add('selected');
            });
        }

        // Topic Quiz System
        const topicQuizData = {
            'Matter': {
                icon: '',
                questions: [
                    { q: 'What state of matter has a definite shape and volume?', options: ['Solid', 'Liquid', 'Gas', 'Plasma'], answer: 0 },
                    { q: 'What happens to water when heated to 100C?', options: ['Freezes', 'Stays liquid', 'Evaporates', 'Condenses'], answer: 2 },
                    { q: 'Which of these is NOT a state of matter?', options: ['Solid', 'Liquid', 'Energy', 'Gas'], answer: 2 },
                    { q: 'What do we call the change from liquid to gas?', options: ['Melting', 'Freezing', 'Evaporation', 'Condensation'], answer: 2 },
                    { q: 'What is everything made of?', options: ['Energy', 'Matter', 'Light', 'Air'], answer: 1 }
                ]
            },
            'Energy': {
                icon: '',
                questions: [
                    { q: 'What type of energy does a moving car have?', options: ['Potential', 'Kinetic', 'Chemical', 'Nuclear'], answer: 1 },
                    { q: 'What is the main source of energy for Earth?', options: ['Moon', 'Wind', 'Sun', 'Ocean'], answer: 2 },
                    { q: 'What type of energy is stored in food?', options: ['Kinetic', 'Chemical', 'Nuclear', 'Electrical'], answer: 1 },
                    { q: 'What happens to energy when it is used?', options: ['It disappears', 'It is destroyed', 'It transforms', 'It multiplies'], answer: 2 },
                    { q: 'Which uses electrical energy?', options: ['Candle', 'Campfire', 'Light bulb', 'Sunlight'], answer: 2 }
                ]
            },
            'Light': {
                icon: '',
                questions: [
                    { q: 'What happens when light hits a mirror?', options: ['Absorbed', 'Reflected', 'Refracted', 'Destroyed'], answer: 1 },
                    { q: 'What are the primary colors of light?', options: ['Red, Yellow, Blue', 'Red, Green, Blue', 'Cyan, Magenta, Yellow', 'Orange, Green, Purple'], answer: 1 },
                    { q: 'How does light travel?', options: ['In circles', 'In waves', 'In straight lines', 'In random patterns'], answer: 2 },
                    { q: 'What splits white light into colors?', options: ['Mirror', 'Prism', 'Lens', 'Paper'], answer: 1 },
                    { q: 'What do we see when all colors of light combine?', options: ['Black', 'White', 'Rainbow', 'Nothing'], answer: 1 }
                ]
            },
            'Plants': {
                icon: '',
                questions: [
                    { q: 'What process do plants use to make food?', options: ['Respiration', 'Photosynthesis', 'Digestion', 'Absorption'], answer: 1 },
                    { q: 'What gas do plants release during photosynthesis?', options: ['Carbon dioxide', 'Nitrogen', 'Oxygen', 'Hydrogen'], answer: 2 },
                    { q: 'What part of the plant absorbs water?', options: ['Leaves', 'Stem', 'Roots', 'Flower'], answer: 2 },
                    { q: 'What do plants need for photosynthesis?', options: ['Darkness', 'Sunlight', 'Cold', 'Wind'], answer: 1 },
                    { q: 'Where does photosynthesis mainly occur?', options: ['Roots', 'Stem', 'Leaves', 'Flower'], answer: 2 }
                ]
            }
        };

        let topicQuizState = {
            selectedTopic: null,
            currentQuestion: 0,
            score: 0,
            questions: []
        };

        function openTopicQuizModal() {
            document.getElementById('topicquiz-modal').style.display = 'flex';
            showTopicSelection();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeTopicQuizModal() {
            document.getElementById('topicquiz-modal').style.display = 'none';
        }

        function showTopicSelection() {
            const area = document.getElementById('topicquiz-area');
            const topics = Object.keys(topicQuizData);

            area.innerHTML = `
                <p style="text-align: center; color: #aaa; margin-bottom: 20px;">Choose a topic to test your knowledge:</p>
                <div class="topic-select-grid">
                    ${topics.map(topic => `
                        <button class="topic-select-btn ${topicQuizState.selectedTopic === topic ? 'selected' : ''}" onclick="selectQuizTopic('${topic}')">
                            <div class="topic-select-icon">${topicQuizData[topic].icon}</div>
                            <div>${topic}</div>
                        </button>
                    `).join('')}
                </div>
                <button class="topicquiz-start-btn" onclick="startTopicQuiz()" ${!topicQuizState.selectedTopic ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                    Start Quiz
                </button>
            `;
        }

        function selectQuizTopic(topic) {
            topicQuizState.selectedTopic = topic;
            showTopicSelection();
        }

        function startTopicQuiz() {
            if (!topicQuizState.selectedTopic) return;

            topicQuizState.currentQuestion = 0;
            topicQuizState.score = 0;
            topicQuizState.questions = [...topicQuizData[topicQuizState.selectedTopic].questions].sort(() => Math.random() - 0.5);

            displayTopicQuizQuestion();
        }

        function displayTopicQuizQuestion() {
            const area = document.getElementById('topicquiz-area');
            const q = topicQuizState.questions[topicQuizState.currentQuestion];

            area.innerHTML = `
                <div class="topicquiz-question">
                    <div class="topicquiz-progress">
                        <span>${topicQuizData[topicQuizState.selectedTopic].icon} ${topicQuizState.selectedTopic}</span>
                        <span>Question ${topicQuizState.currentQuestion + 1} / ${topicQuizState.questions.length}</span>
                    </div>
                    <div class="topicquiz-question-text">${q.q}</div>
                </div>
                <div class="topicquiz-options">
                    ${q.options.map((opt, i) => `
                        <button class="topicquiz-option" onclick="answerTopicQuiz(${i})">${opt}</button>
                    `).join('')}
                </div>
            `;
        }

        function answerTopicQuiz(selectedIndex) {
            const q = topicQuizState.questions[topicQuizState.currentQuestion];
            if (selectedIndex === q.answer) {
                topicQuizState.score++;
            }

            topicQuizState.currentQuestion++;

            if (topicQuizState.currentQuestion >= topicQuizState.questions.length) {
                showTopicQuizResults();
            } else {
                displayTopicQuizQuestion();
            }
        }

        function showTopicQuizResults() {
            const area = document.getElementById('topicquiz-area');
            const percentage = Math.round((topicQuizState.score / topicQuizState.questions.length) * 100);
            const xpEarned = topicQuizState.score * 10;

            if (typeof addXP === 'function') addXP(xpEarned);

            let resultIcon = '';
            let message = 'Excellent!';
            if (percentage < 40) {
                resultIcon = '';
                message = 'Keep practicing!';
            } else if (percentage < 70) {
                resultIcon = '';
                message = 'Good job!';
            }

            area.innerHTML = `
                <div class="topicquiz-result">
                    <div class="topicquiz-result-icon">${resultIcon}</div>
                    <div class="topicquiz-result-score">${topicQuizState.score} / ${topicQuizState.questions.length}</div>
                    <p style="color: #9fa8da; font-size: 1.2rem;">${message}</p>
                    <p style="color: #aaa;">+${xpEarned} XP earned</p>
                    <button class="topicquiz-start-btn" onclick="showTopicSelection()">Try Another Topic</button>
                </div>
            `;
        }

        console.log(' Achievement Badges, Word Search, and Topic Quizzes loaded!');
    </script>

    <!-- ===== Batch 48: Science Riddles, Focus Mode, Quick Tips ===== -->
    <button class="floating-riddles-btn" onclick="openRiddlesModal()" title="Science Riddles"></button>
    <button class="floating-tips-btn" onclick="openTipsModal()" title="Quick Tips"></button>
    <button class="focus-toggle-btn" onclick="toggleFocusMode()"> Focus Mode</button>

    <!-- Science Riddles Modal -->
    <div class="riddles-modal" id="riddles-modal">
        <div class="riddles-content">
            <button class="modal-close-btn" onclick="closeRiddlesModal()">&times;</button>
            <div class="riddles-header">
                <h2> Science Riddles</h2>
                <p style="color: #aaa;">Can you solve these brain teasers?</p>
            </div>
            <div id="riddle-container"></div>
        </div>
    </div>

    <!-- Focus Mode Overlay -->
    <div class="focus-mode-overlay" id="focus-mode-overlay">
        <div class="focus-mode-content">
            <div class="focus-timer-display" id="focus-timer">25:00</div>
            <div class="focus-message">Stay focused! You're doing great! </div>
            <div class="focus-stats">
                <div class="focus-stat">
                    <div class="focus-stat-value" id="focus-sessions">0</div>
                    <div class="focus-stat-label">Sessions Today</div>
                </div>
                <div class="focus-stat">
                    <div class="focus-stat-value" id="focus-total-time">0m</div>
                    <div class="focus-stat-label">Total Focus Time</div>
                </div>
            </div>
            <button class="focus-exit-btn" onclick="exitFocusMode()">Exit Focus Mode</button>
        </div>
    </div>

    <!-- Quick Tips Modal -->
    <div class="tips-modal" id="tips-modal">
        <div class="tips-content">
            <button class="modal-close-btn" onclick="closeTipsModal()">&times;</button>
            <div class="tips-header">
                <h2> Quick Tips</h2>
                <p style="color: #aaa;">Science tips and tricks to help you learn!</p>
            </div>
            <div class="tips-category-tabs" id="tips-tabs"></div>
            <div id="tips-container"></div>
        </div>
    </div>

    <script>
        // ===== Batch 48: Science Riddles, Focus Mode, Quick Tips =====

        // Science Riddles Data
        const scienceRiddles = [
            { icon: '', question: 'I am always running but never get tired. I have a bed but never sleep. What am I?', hint: 'You can find me flowing through landscapes.', answer: 'A river' },
            { icon: '', question: 'I give you light but I am not a lamp. I give you heat but I am not a fire. What am I?', hint: 'Look up during the day!', answer: 'The Sun' },
            { icon: '', question: 'I change my shape every night but I am always there. Sometimes I am full, sometimes I disappear. What am I?', hint: 'Look up at night.', answer: 'The Moon' },
            { icon: '', question: 'I can fall but I cannot climb. I am not living but I make plants grow. What am I?', hint: 'I come from clouds.', answer: 'Rain' },
            { icon: '', question: 'You cannot see me but you can feel me. I can be gentle or very strong. What am I?', hint: 'I move trees and flags.', answer: 'Wind' },
            { icon: '', question: 'I am water but I am not wet. I can float or I can sink. What am I?', hint: 'I form when it is very cold.', answer: 'Ice' },
            { icon: '', question: 'I have all the colors but I am not a painting. I appear after the rain. What am I?', hint: 'I need sunlight and water to appear.', answer: 'A rainbow' },
            { icon: '', question: 'I am bright but I only last a second. I am loud but I make no sound. What am I?', hint: 'I come with thunder.', answer: 'Lightning' },
            { icon: '', question: 'I can pull things toward me without touching them. Metals are my best friends. What am I?', hint: 'I stick to refrigerators!', answer: 'A magnet' },
            { icon: '', question: 'I dance and glow but I am not alive. I need air to survive. What am I?', hint: 'I can be warm and dangerous.', answer: 'Fire' }
        ];

        let currentRiddleIndex = 0;
        let riddleHintShown = false;
        let riddleAnswerShown = false;

        function openRiddlesModal() {
            document.getElementById('riddles-modal').style.display = 'flex';
            displayRiddle();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeRiddlesModal() {
            document.getElementById('riddles-modal').style.display = 'none';
        }

        function displayRiddle() {
            const riddle = scienceRiddles[currentRiddleIndex];
            const container = document.getElementById('riddle-container');

            riddleHintShown = false;
            riddleAnswerShown = false;

            container.innerHTML = `
                <div class="riddle-card">
                    <div class="riddle-icon">${riddle.icon}</div>
                    <div class="riddle-question">"${riddle.question}"</div>
                    <div class="riddle-hint" id="riddle-hint"> Hint: ${riddle.hint}</div>
                    <div class="riddle-answer" id="riddle-answer">
                        <div class="riddle-answer-label">Answer:</div>
                        <div class="riddle-answer-text">${riddle.answer}</div>
                    </div>
                    <div class="riddle-controls">
                        <button class="riddle-btn hint" onclick="showRiddleHint()">Show Hint</button>
                        <button class="riddle-btn reveal" onclick="revealRiddleAnswer()">Reveal Answer</button>
                        <button class="riddle-btn next" onclick="nextRiddle()">Next Riddle </button>
                    </div>
                </div>
                <div class="riddle-progress">Riddle ${currentRiddleIndex + 1} of ${scienceRiddles.length}</div>
            `;
        }

        function showRiddleHint() {
            if (!riddleHintShown) {
                document.getElementById('riddle-hint').classList.add('show');
                riddleHintShown = true;
            }
        }

        function revealRiddleAnswer() {
            if (!riddleAnswerShown) {
                document.getElementById('riddle-answer').classList.add('show');
                riddleAnswerShown = true;
                if (typeof addXP === 'function') addXP(5);
            }
        }

        function nextRiddle() {
            currentRiddleIndex = (currentRiddleIndex + 1) % scienceRiddles.length;
            displayRiddle();
        }

        // Focus Mode System
        let focusState = {
            isActive: false,
            timeRemaining: 25 * 60, // 25 minutes default
            timerInterval: null,
            sessionsToday: parseInt(localStorage.getItem('focusSessionsToday')) || 0,
            totalMinutes: parseInt(localStorage.getItem('focusTotalMinutes')) || 0,
            lastDate: localStorage.getItem('focusLastDate') || ''
        };

        function toggleFocusMode() {
            if (focusState.isActive) {
                exitFocusMode();
            } else {
                startFocusMode();
            }
        }

        function startFocusMode() {
            // Check if new day
            const today = new Date().toDateString();
            if (focusState.lastDate !== today) {
                focusState.sessionsToday = 0;
                focusState.lastDate = today;
                localStorage.setItem('focusLastDate', today);
            }

            focusState.isActive = true;
            focusState.timeRemaining = 25 * 60;

            document.getElementById('focus-mode-overlay').classList.add('active');
            updateFocusDisplay();

            focusState.timerInterval = setInterval(() => {
                focusState.timeRemaining--;
                updateFocusDisplay();

                if (focusState.timeRemaining <= 0) {
                    completeFocusSession();
                }
            }, 1000);

            if (typeof playClickSound === 'function') playClickSound();
        }

        function updateFocusDisplay() {
            const minutes = Math.floor(focusState.timeRemaining / 60);
            const seconds = focusState.timeRemaining % 60;
            document.getElementById('focus-timer').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            document.getElementById('focus-sessions').textContent = focusState.sessionsToday;
            document.getElementById('focus-total-time').textContent = `${focusState.totalMinutes}m`;
        }

        function completeFocusSession() {
            focusState.sessionsToday++;
            focusState.totalMinutes += 25;

            localStorage.setItem('focusSessionsToday', focusState.sessionsToday);
            localStorage.setItem('focusTotalMinutes', focusState.totalMinutes);

            if (typeof addXP === 'function') addXP(30);
            showToast(' Focus session complete! +30 XP', 'success');

            exitFocusMode();
        }

        function exitFocusMode() {
            focusState.isActive = false;
            if (focusState.timerInterval) {
                clearInterval(focusState.timerInterval);
                focusState.timerInterval = null;
            }

            document.getElementById('focus-mode-overlay').classList.remove('active');
        }

        // Quick Tips Data
        const quickTipsData = {
            'Study': [
                { title: 'Spaced Repetition', text: 'Review material at increasing intervals. Study today, tomorrow, then in a few days. This helps move information to long-term memory!' },
                { title: 'Active Recall', text: 'Instead of re-reading, test yourself! Try to remember information without looking. This strengthens memory pathways.' },
                { title: 'Teach Others', text: 'Explain what you learned to someone else. Teaching is one of the best ways to solidify your understanding.' }
            ],
            'Science': [
                { title: 'Make Observations', text: 'Great scientists observe carefully! Pay attention to details around you and ask "why?" about everything.' },
                { title: 'Experiment at Home', text: 'Try safe experiments at home! Mixing baking soda and vinegar, growing plants, or making a simple circuit are great starts.' },
                { title: 'Connect Concepts', text: 'Science topics are connected! Energy, matter, and forces all relate to each other. Look for these connections.' }
            ],
            'Memory': [
                { title: 'Use Mnemonics', text: 'Create memory tricks! For example, "My Very Eager Mother Just Served Us Nachos" helps remember planet order.' },
                { title: 'Visualize', text: 'Create mental pictures of what you\'re learning. Our brains remember images better than text!' },
                { title: 'Chunk Information', text: 'Break large amounts of information into smaller groups. Like phone numbers: easier to remember in parts!' }
            ],
            'Focus': [
                { title: 'Take Breaks', text: 'Study for 25-30 minutes, then take a 5-minute break. Your brain needs rest to process information!' },
                { title: 'Remove Distractions', text: 'Put away your phone and find a quiet spot. A focused mind learns much faster!' },
                { title: 'Set Small Goals', text: 'Instead of "study science," try "learn 3 facts about plants." Small, specific goals are easier to achieve!' }
            ]
        };

        let currentTipsCategory = 'Study';

        function openTipsModal() {
            document.getElementById('tips-modal').style.display = 'flex';
            initTipsTabs();
            displayTips();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeTipsModal() {
            document.getElementById('tips-modal').style.display = 'none';
        }

        function initTipsTabs() {
            const tabs = document.getElementById('tips-tabs');
            const categories = Object.keys(quickTipsData);

            tabs.innerHTML = categories.map(cat => `
                <button class="tips-tab ${cat === currentTipsCategory ? 'active' : ''}" onclick="selectTipsCategory('${cat}')">
                    ${cat}
                </button>
            `).join('');
        }

        function selectTipsCategory(category) {
            currentTipsCategory = category;
            initTipsTabs();
            displayTips();
        }

        function displayTips() {
            const container = document.getElementById('tips-container');
            const tips = quickTipsData[currentTipsCategory] || [];

            container.innerHTML = tips.map(tip => `
                <div class="tip-card">
                    <div class="tip-category">${currentTipsCategory}</div>
                    <div class="tip-title">${tip.title}</div>
                    <div class="tip-text">${tip.text}</div>
                </div>
            `).join('');
        }

        console.log(' Science Riddles, Focus Mode, and Quick Tips loaded!');
    </script>

    <!-- ===== Batch 49: Matching Game, Progress Report, Reference Cards ===== -->
    <button class="floating-matching-btn" onclick="openMatchingModal()" title="Matching Game"></button>
    <button class="floating-report-btn" onclick="openProgressReportModal()" title="Progress Report"></button>
    <button class="floating-reference-btn" onclick="openReferenceModal()" title="Reference Cards"></button>

    <!-- Matching Game Modal -->
    <div class="matching-modal" id="matching-modal">
        <div class="matching-content">
            <button class="modal-close-btn" onclick="closeMatchingModal()">&times;</button>
            <div class="matching-header">
                <h2> Science Matching</h2>
                <p style="color: #aaa;">Match the pairs of related terms!</p>
            </div>
            <div class="matching-stats">
                <div class="matching-stat">
                    <div class="matching-stat-value" id="matching-moves">0</div>
                    <div class="matching-stat-label">Moves</div>
                </div>
                <div class="matching-stat">
                    <div class="matching-stat-value" id="matching-pairs">0/8</div>
                    <div class="matching-stat-label">Pairs Found</div>
                </div>
            </div>
            <div class="matching-grid" id="matching-grid"></div>
            <button class="matching-btn" onclick="startMatchingGame()">New Game</button>
        </div>
    </div>

    <!-- Progress Report Modal -->
    <div class="progress-report-modal" id="progress-report-modal">
        <div class="progress-report-content">
            <button class="modal-close-btn" onclick="closeProgressReportModal()">&times;</button>
            <div class="progress-report-header">
                <h2> Progress Report</h2>
                <p style="color: #aaa;">Your learning journey at a glance</p>
            </div>
            <div id="progress-report-container"></div>
        </div>
    </div>

    <!-- Reference Cards Modal -->
    <div class="reference-modal" id="reference-modal">
        <div class="reference-content">
            <button class="modal-close-btn" onclick="closeReferenceModal()">&times;</button>
            <div class="reference-header">
                <h2> Quick Reference</h2>
                <p style="color: #aaa;">Science formulas and facts at your fingertips!</p>
            </div>
            <div class="reference-tabs" id="reference-tabs"></div>
            <div id="reference-cards-container"></div>
        </div>
    </div>

    <script>
        // ===== Batch 49: Matching Game, Progress Report, Reference Cards =====

        // Matching Game Data
        const matchingPairs = [
            { term: 'Solid', match: 'Fixed Shape' },
            { term: 'Liquid', match: 'Takes Container Shape' },
            { term: 'Gas', match: 'No Fixed Volume' },
            { term: 'Gravity', match: 'Pulls Objects Down' },
            { term: 'Photosynthesis', match: 'Plants Make Food' },
            { term: 'Conductor', match: 'Allows Electricity' },
            { term: 'Kinetic', match: 'Energy of Motion' },
            { term: 'Friction', match: 'Opposes Movement' }
        ];

        let matchingState = {
            cards: [],
            flippedCards: [],
            matchedPairs: 0,
            moves: 0,
            canFlip: true
        };

        function openMatchingModal() {
            document.getElementById('matching-modal').style.display = 'flex';
            startMatchingGame();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeMatchingModal() {
            document.getElementById('matching-modal').style.display = 'none';
        }

        function startMatchingGame() {
            matchingState.matchedPairs = 0;
            matchingState.moves = 0;
            matchingState.flippedCards = [];
            matchingState.canFlip = true;

            // Create cards array with terms and matches
            const cards = [];
            matchingPairs.forEach((pair, idx) => {
                cards.push({ id: idx * 2, text: pair.term, pairId: idx, type: 'term' });
                cards.push({ id: idx * 2 + 1, text: pair.match, pairId: idx, type: 'match' });
            });

            // Shuffle cards
            matchingState.cards = cards.sort(() => Math.random() - 0.5);

            updateMatchingDisplay();
        }

        function updateMatchingDisplay() {
            document.getElementById('matching-moves').textContent = matchingState.moves;
            document.getElementById('matching-pairs').textContent = `${matchingState.matchedPairs}/${matchingPairs.length}`;

            const grid = document.getElementById('matching-grid');
            grid.innerHTML = matchingState.cards.map((card, idx) => {
                const isFlipped = matchingState.flippedCards.includes(idx);
                const isMatched = card.matched;
                return `<div class="matching-card ${isFlipped ? 'flipped' : ''} ${isMatched ? 'matched' : ''}" data-idx="${idx}" onclick="flipMatchingCard(${idx})">${card.text}</div>`;
            }).join('');
        }

        function flipMatchingCard(idx) {
            if (!matchingState.canFlip) return;
            if (matchingState.flippedCards.includes(idx)) return;
            if (matchingState.cards[idx].matched) return;
            if (matchingState.flippedCards.length >= 2) return;

            matchingState.flippedCards.push(idx);
            updateMatchingDisplay();

            if (matchingState.flippedCards.length === 2) {
                matchingState.moves++;
                matchingState.canFlip = false;

                const [first, second] = matchingState.flippedCards;
                const card1 = matchingState.cards[first];
                const card2 = matchingState.cards[second];

                if (card1.pairId === card2.pairId && card1.type !== card2.type) {
                    // Match found
                    card1.matched = true;
                    card2.matched = true;
                    matchingState.matchedPairs++;
                    matchingState.flippedCards = [];
                    matchingState.canFlip = true;

                    if (typeof playCorrectSound === 'function') playCorrectSound();

                    if (matchingState.matchedPairs === matchingPairs.length) {
                        const xpEarned = Math.max(50 - matchingState.moves, 20);
                        if (typeof addXP === 'function') addXP(xpEarned);
                        setTimeout(() => showToast(` You won! +${xpEarned} XP`, 'success'), 300);
                    }

                    updateMatchingDisplay();
                } else {
                    // No match
                    setTimeout(() => {
                        matchingState.flippedCards = [];
                        matchingState.canFlip = true;
                        updateMatchingDisplay();
                    }, 1000);
                }
            }
        }

        // Progress Report
        function openProgressReportModal() {
            document.getElementById('progress-report-modal').style.display = 'flex';
            displayProgressReport();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeProgressReportModal() {
            document.getElementById('progress-report-modal').style.display = 'none';
        }

        function displayProgressReport() {
            const container = document.getElementById('progress-report-container');

            // Gather stats from localStorage
            const totalQuestions = parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0;
            const correctAnswers = parseInt(localStorage.getItem('correctAnswersTotal')) || Math.floor(totalQuestions * 0.7);
            const currentXP = parseInt(localStorage.getItem('userXP')) || 0;
            const currentLevel = parseInt(localStorage.getItem('userLevel')) || 1;
            const vocabLearned = Object.values(JSON.parse(localStorage.getItem('learnedVocab')) || {}).filter(v => v).length;
            const experiments = (JSON.parse(localStorage.getItem('completedExperiments')) || []).length;
            const focusTime = parseInt(localStorage.getItem('focusTotalMinutes')) || 0;
            const badges = (JSON.parse(localStorage.getItem('unlockedBadges')) || []).length;

            const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;

            // Simulated weekly activity data
            const weeklyData = [
                { day: 'Mon', value: Math.floor(Math.random() * 20) + 5 },
                { day: 'Tue', value: Math.floor(Math.random() * 20) + 5 },
                { day: 'Wed', value: Math.floor(Math.random() * 20) + 5 },
                { day: 'Thu', value: Math.floor(Math.random() * 20) + 5 },
                { day: 'Fri', value: Math.floor(Math.random() * 20) + 5 },
                { day: 'Sat', value: Math.floor(Math.random() * 20) + 5 },
                { day: 'Sun', value: Math.floor(Math.random() * 20) + 5 }
            ];
            const maxValue = Math.max(...weeklyData.map(d => d.value));

            container.innerHTML = `
                <div class="report-section">
                    <div class="report-section-title"> Overall Progress</div>
                    <div class="report-stat-grid">
                        <div class="report-stat-item">
                            <div class="report-stat-value">${currentLevel}</div>
                            <div class="report-stat-label">Level</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-value">${currentXP}</div>
                            <div class="report-stat-label">Total XP</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-value">${totalQuestions}</div>
                            <div class="report-stat-label">Questions</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-value">${accuracy}%</div>
                            <div class="report-stat-label">Accuracy</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <div class="report-section-title"> Learning Activities</div>
                    <div class="report-stat-grid">
                        <div class="report-stat-item">
                            <div class="report-stat-value">${vocabLearned}</div>
                            <div class="report-stat-label">Vocab Learned</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-value">${experiments}</div>
                            <div class="report-stat-label">Experiments</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-value">${focusTime}m</div>
                            <div class="report-stat-label">Focus Time</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-value">${badges}</div>
                            <div class="report-stat-label">Badges</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <div class="report-section-title"> Weekly Activity</div>
                    <div class="report-chart">
                        ${weeklyData.map(d => `
                            <div class="chart-bar" style="height: ${(d.value / maxValue) * 100}%;">
                                <span class="chart-bar-label">${d.day}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Reference Cards
        const referenceData = {
            'Formulas': [
                { title: 'Speed', formula: 'Speed = Distance  Time', explanation: 'To find how fast something is moving, divide the distance by the time taken.', example: 'A car travels 100 km in 2 hours. Speed = 100  2 = 50 km/h' },
                { title: 'Density', formula: 'Density = Mass  Volume', explanation: 'Density tells us how much mass is packed into a certain volume.', example: 'An object has mass 200g and volume 50cm. Density = 200  50 = 4 g/cm' },
                { title: 'Area (Rectangle)', formula: 'Area = Length  Width', explanation: 'To find the area of a rectangle, multiply its length by its width.', example: 'A rectangle is 5m long and 3m wide. Area = 5  3 = 15 m' }
            ],
            'Facts': [
                { title: 'States of Matter', formula: 'Solid  Liquid  Gas', explanation: 'Matter changes state when heated: solids melt to liquids, liquids evaporate to gases.', example: 'Ice (solid) melts at 0C, water (liquid) boils at 100C to become steam (gas)' },
                { title: 'Photosynthesis', formula: 'CO + HO + Light  Glucose + O', explanation: 'Plants use carbon dioxide, water, and sunlight to make food (glucose) and release oxygen.', example: 'Trees absorb CO and release O, which we breathe!' },
                { title: 'Energy Conservation', formula: 'Energy In = Energy Out', explanation: 'Energy cannot be created or destroyed, only transformed from one form to another.', example: 'A ball at the top of a hill has potential energy. When rolling down, it becomes kinetic energy.' }
            ],
            'Units': [
                { title: 'Length', formula: 'km  m  cm  mm', explanation: '1 km = 1000 m, 1 m = 100 cm, 1 cm = 10 mm', example: '5 km = 5000 m = 500,000 cm' },
                { title: 'Mass', formula: 'kg  g  mg', explanation: '1 kg = 1000 g, 1 g = 1000 mg', example: '2.5 kg = 2500 g' },
                { title: 'Volume', formula: 'L  mL  cm', explanation: '1 L = 1000 mL = 1000 cm', example: '500 mL = 0.5 L = 500 cm' }
            ]
        };

        let currentReferenceCategory = 'Formulas';

        function openReferenceModal() {
            document.getElementById('reference-modal').style.display = 'flex';
            initReferenceTabs();
            displayReferenceCards();
            if (typeof playClickSound === 'function') playClickSound();
        }

        function closeReferenceModal() {
            document.getElementById('reference-modal').style.display = 'none';
        }

        function initReferenceTabs() {
            const tabs = document.getElementById('reference-tabs');
            const categories = Object.keys(referenceData);

            tabs.innerHTML = categories.map(cat => `
                <button class="reference-tab ${cat === currentReferenceCategory ? 'active' : ''}" onclick="selectReferenceCategory('${cat}')">
                    ${cat}
                </button>
            `).join('');
        }

        function selectReferenceCategory(category) {
            currentReferenceCategory = category;
            initReferenceTabs();
            displayReferenceCards();
        }

        function displayReferenceCards() {
            const container = document.getElementById('reference-cards-container');
            const cards = referenceData[currentReferenceCategory] || [];

            container.innerHTML = cards.map(card => `
                <div class="reference-card">
                    <div class="reference-card-title">${card.title}</div>
                    <div class="reference-formula">${card.formula}</div>
                    <div class="reference-explanation">${card.explanation}</div>
                    <div class="reference-example"> ${card.example}</div>
                </div>
            `).join('');
        }

        console.log(' Matching Game, Progress Report, and Reference Cards loaded!');
    </script>

    <!-- ========== Batch 50: Crossword Puzzle, Mistake Review, Sound Settings ========== -->

    <!-- Crossword Puzzle Floating Button -->
    <button class="floating-crossword-btn" onclick="openCrossword()" title="Science Crossword"></button>

    <!-- Mistake Review Floating Button -->
    <button class="floating-mistakes-btn" onclick="openMistakeReview()" title="Review Mistakes"></button>

    <!-- Sound Settings Floating Button -->
    <button class="floating-sound-btn" onclick="openSoundSettings()" title="Sound Settings"></button>

    <!-- Crossword Puzzle Modal -->
    <div class="crossword-modal" id="crossword-modal">
        <div class="crossword-content">
            <div class="crossword-header">
                <h2> Science Crossword</h2>
                <button onclick="closeCrossword()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div class="crossword-grid" id="crossword-grid"></div>
            <div class="crossword-clues" id="crossword-clues"></div>
            <button class="crossword-check-btn" onclick="checkCrossword()">Check Answers</button>
        </div>
    </div>

    <!-- Mistake Review Modal -->
    <div class="mistake-review-modal" id="mistake-review-modal">
        <div class="mistake-review-content">
            <div class="mistake-review-header">
                <h2> Review Your Mistakes</h2>
                <button onclick="closeMistakeReview()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div class="mistake-stats" id="mistake-stats"></div>
            <div class="mistake-list" id="mistake-list"></div>
        </div>
    </div>

    <!-- Sound Settings Modal -->
    <div class="sound-toggle-modal" id="sound-toggle-modal">
        <div class="sound-toggle-content">
            <div class="sound-toggle-header">
                <h2> Sound Settings</h2>
                <button onclick="closeSoundSettings()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>

            <div class="sound-option">
                <div class="sound-option-info">
                    <span class="sound-option-icon"></span>
                    <div>
                        <div class="sound-option-label">Correct Answer</div>
                        <div class="sound-option-desc">Play sound on correct answers</div>
                    </div>
                </div>
                <label class="sound-toggle-switch">
                    <input type="checkbox" id="sound-correct" checked onchange="saveSoundSettings()">
                    <span class="sound-slider"></span>
                </label>
            </div>

            <div class="sound-option">
                <div class="sound-option-info">
                    <span class="sound-option-icon"></span>
                    <div>
                        <div class="sound-option-label">Wrong Answer</div>
                        <div class="sound-option-desc">Play sound on wrong answers</div>
                    </div>
                </div>
                <label class="sound-toggle-switch">
                    <input type="checkbox" id="sound-wrong" checked onchange="saveSoundSettings()">
                    <span class="sound-slider"></span>
                </label>
            </div>

            <div class="sound-option">
                <div class="sound-option-info">
                    <span class="sound-option-icon"></span>
                    <div>
                        <div class="sound-option-label">XP & Level Up</div>
                        <div class="sound-option-desc">Play sound when gaining XP</div>
                    </div>
                </div>
                <label class="sound-toggle-switch">
                    <input type="checkbox" id="sound-xp" checked onchange="saveSoundSettings()">
                    <span class="sound-slider"></span>
                </label>
            </div>

            <div class="sound-option">
                <div class="sound-option-info">
                    <span class="sound-option-icon"></span>
                    <div>
                        <div class="sound-option-label">Notifications</div>
                        <div class="sound-option-desc">Sound for alerts and reminders</div>
                    </div>
                </div>
                <label class="sound-toggle-switch">
                    <input type="checkbox" id="sound-notify" checked onchange="saveSoundSettings()">
                    <span class="sound-slider"></span>
                </label>
            </div>

            <div class="volume-control">
                <div class="volume-label">
                    <span> Master Volume</span>
                    <span id="volume-percent">70%</span>
                </div>
                <input type="range" class="volume-slider" id="master-volume" min="0" max="100" value="70" oninput="updateVolume()">
            </div>

            <button class="sound-test-btn" onclick="testSound()"> Test Sound</button>
        </div>
    </div>

    <script>
        // ========== Crossword Puzzle System ==========
        const crosswordPuzzle = {
            grid: [
                ['S', 'O', 'L', 'I', 'D', '#', 'M'],
                ['#', '#', 'I', '#', '#', '#', 'A'],
                ['G', 'A', 'S', '#', 'H', 'E', 'T'],
                ['#', '#', 'U', '#', 'E', '#', 'T'],
                ['L', 'I', 'Q', 'U', 'A', 'T', 'E'],
                ['#', '#', 'I', '#', 'T', '#', 'R'],
                ['P', 'L', 'A', 'N', 'T', 'S', '#']
            ],
            across: [
                { num: 1, clue: 'State of matter with fixed shape (5)', row: 0, col: 0, answer: 'SOLID' },
                { num: 3, clue: 'State of matter that can be compressed (3)', row: 2, col: 0, answer: 'GAS' },
                { num: 5, clue: 'State of matter that flows (7)', row: 4, col: 0, answer: 'LIQUATE' },
                { num: 7, clue: 'Living things that make their own food (6)', row: 6, col: 0, answer: 'PLANTS' }
            ],
            down: [
                { num: 1, clue: 'Form of energy from the sun (5)', row: 0, col: 2, answer: 'LIGHT' },
                { num: 2, clue: 'Substance made of atoms (6)', row: 0, col: 6, answer: 'MATTER' },
                { num: 4, clue: 'Energy that makes things warm (4)', row: 2, col: 4, answer: 'HEAT' }
            ]
        };

        let crosswordAnswers = {};

        function openCrossword() {
            document.getElementById('crossword-modal').style.display = 'flex';
            initCrossword();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closeCrossword() {
            document.getElementById('crossword-modal').style.display = 'none';
        }

        function initCrossword() {
            const grid = document.getElementById('crossword-grid');
            const cluesDiv = document.getElementById('crossword-clues');
            const puzzle = crosswordPuzzle;

            grid.style.gridTemplateColumns = `repeat(${puzzle.grid[0].length}, 35px)`;

            let gridHTML = '';
            for (let row = 0; row < puzzle.grid.length; row++) {
                for (let col = 0; col < puzzle.grid[row].length; col++) {
                    const cell = puzzle.grid[row][col];
                    if (cell === '#') {
                        gridHTML += '<input class="crossword-cell blocked" disabled>';
                    } else {
                        const cellId = `cell-${row}-${col}`;
                        const saved = crosswordAnswers[cellId] || '';
                        gridHTML += `<input class="crossword-cell" id="${cellId}" maxlength="1" value="${saved}" onkeyup="handleCrosswordInput(event, ${row}, ${col})">`;
                    }
                }
            }
            grid.innerHTML = gridHTML;

            cluesDiv.innerHTML = `
                <div class="clues-section">
                    <h3>Across </h3>
                    ${puzzle.across.map(c => `<div class="clue-item" data-num="${c.num}" data-dir="across">${c.num}. ${c.clue}</div>`).join('')}
                </div>
                <div class="clues-section">
                    <h3>Down </h3>
                    ${puzzle.down.map(c => `<div class="clue-item" data-num="${c.num}" data-dir="down">${c.num}. ${c.clue}</div>`).join('')}
                </div>
            `;
        }

        function handleCrosswordInput(e, row, col) {
            const cellId = `cell-${row}-${col}`;
            crosswordAnswers[cellId] = e.target.value.toUpperCase();

            // Auto-move to next cell on valid input
            if (e.key.length === 1 && e.key.match(/[a-zA-Z]/)) {
                const nextCol = col + 1;
                if (nextCol < crosswordPuzzle.grid[0].length) {
                    const nextCell = document.getElementById(`cell-${row}-${nextCol}`);
                    if (nextCell && !nextCell.disabled) nextCell.focus();
                }
            }
        }

        function checkCrossword() {
            const puzzle = crosswordPuzzle;
            let correct = 0;
            let total = 0;

            for (let row = 0; row < puzzle.grid.length; row++) {
                for (let col = 0; col < puzzle.grid[row].length; col++) {
                    const expected = puzzle.grid[row][col];
                    if (expected !== '#') {
                        total++;
                        const cellId = `cell-${row}-${col}`;
                        const cell = document.getElementById(cellId);
                        const answer = cell.value.toUpperCase();

                        if (answer === expected) {
                            cell.classList.add('correct');
                            correct++;
                        } else {
                            cell.classList.remove('correct');
                        }
                    }
                }
            }

            if (correct === total) {
                const xpEarned = 100;
                if (typeof addXP === 'function') addXP(xpEarned);
                alert(` Perfect! You solved the crossword!\n+${xpEarned} XP earned!`);
                if (typeof playSound === 'function' && getSoundSetting('xp')) playSound('levelup');
            } else {
                alert(`You got ${correct}/${total} letters correct. Keep trying!`);
                if (typeof playSound === 'function' && getSoundSetting('wrong')) playSound('error');
            }
        }

        // ========== Mistake Review System ==========
        let mistakeHistory = JSON.parse(localStorage.getItem('mistakeHistory') || '[]');

        function openMistakeReview() {
            document.getElementById('mistake-review-modal').style.display = 'flex';
            renderMistakeReview();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closeMistakeReview() {
            document.getElementById('mistake-review-modal').style.display = 'none';
        }

        function recordMistake(question, yourAnswer, correctAnswer, topic) {
            const mistake = {
                id: Date.now(),
                question: question,
                yourAnswer: yourAnswer,
                correctAnswer: correctAnswer,
                topic: topic || 'General',
                timestamp: new Date().toISOString(),
                practiced: false
            };

            mistakeHistory.push(mistake);
            // Keep only last 50 mistakes
            if (mistakeHistory.length > 50) {
                mistakeHistory = mistakeHistory.slice(-50);
            }
            localStorage.setItem('mistakeHistory', JSON.stringify(mistakeHistory));
        }

        function renderMistakeReview() {
            const statsDiv = document.getElementById('mistake-stats');
            const listDiv = document.getElementById('mistake-list');

            const totalMistakes = mistakeHistory.length;
            const practicedCount = mistakeHistory.filter(m => m.practiced).length;
            const topicCounts = {};
            mistakeHistory.forEach(m => {
                topicCounts[m.topic] = (topicCounts[m.topic] || 0) + 1;
            });
            const topTopic = Object.entries(topicCounts).sort((a, b) => b[1] - a[1])[0];

            statsDiv.innerHTML = `
                <div class="mistake-stat">
                    <div class="mistake-stat-value">${totalMistakes}</div>
                    <div class="mistake-stat-label">Total Mistakes</div>
                </div>
                <div class="mistake-stat">
                    <div class="mistake-stat-value">${practicedCount}</div>
                    <div class="mistake-stat-label">Practiced</div>
                </div>
                <div class="mistake-stat">
                    <div class="mistake-stat-value">${topTopic ? topTopic[0].substring(0, 8) : 'N/A'}</div>
                    <div class="mistake-stat-label">Focus Area</div>
                </div>
            `;

            if (totalMistakes === 0) {
                listDiv.innerHTML = `
                    <div class="no-mistakes">
                        <div class="no-mistakes-icon"></div>
                        <h3>No mistakes yet!</h3>
                        <p>Keep practicing and any wrong answers will appear here for review.</p>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = mistakeHistory.slice().reverse().map(mistake => `
                <div class="mistake-item" id="mistake-${mistake.id}">
                    <div class="mistake-question">${mistake.question}</div>
                    <div class="mistake-answers">
                        <span class="mistake-your-answer">Your answer: ${mistake.yourAnswer}</span>
                        <span class="mistake-correct-answer">Correct: ${mistake.correctAnswer}</span>
                    </div>
                    <button class="mistake-practice-btn" onclick="markAsPracticed(${mistake.id})">
                        ${mistake.practiced ? ' Practiced' : ' Mark as Practiced'}
                    </button>
                </div>
            `).join('');
        }

        function markAsPracticed(id) {
            const mistake = mistakeHistory.find(m => m.id === id);
            if (mistake) {
                mistake.practiced = true;
                localStorage.setItem('mistakeHistory', JSON.stringify(mistakeHistory));
                renderMistakeReview();
                if (typeof playSound === 'function' && getSoundSetting('correct')) playSound('success');
            }
        }

        function clearMistakeHistory() {
            if (confirm('Are you sure you want to clear all mistake history?')) {
                mistakeHistory = [];
                localStorage.setItem('mistakeHistory', JSON.stringify(mistakeHistory));
                renderMistakeReview();
            }
        }

        // ========== Sound Settings System ==========
        let soundSettings = JSON.parse(localStorage.getItem('soundSettings') || '{}');
        if (Object.keys(soundSettings).length === 0) {
            soundSettings = {
                correct: true,
                wrong: true,
                xp: true,
                notify: true,
                volume: 70
            };
            localStorage.setItem('soundSettings', JSON.stringify(soundSettings));
        }

        function openSoundSettings() {
            document.getElementById('sound-toggle-modal').style.display = 'flex';
            loadSoundSettings();
        }

        function closeSoundSettings() {
            document.getElementById('sound-toggle-modal').style.display = 'none';
        }

        function loadSoundSettings() {
            document.getElementById('sound-correct').checked = soundSettings.correct !== false;
            document.getElementById('sound-wrong').checked = soundSettings.wrong !== false;
            document.getElementById('sound-xp').checked = soundSettings.xp !== false;
            document.getElementById('sound-notify').checked = soundSettings.notify !== false;
            document.getElementById('master-volume').value = soundSettings.volume || 70;
            document.getElementById('volume-percent').textContent = `${soundSettings.volume || 70}%`;
        }

        function saveSoundSettings() {
            soundSettings = {
                correct: document.getElementById('sound-correct').checked,
                wrong: document.getElementById('sound-wrong').checked,
                xp: document.getElementById('sound-xp').checked,
                notify: document.getElementById('sound-notify').checked,
                volume: parseInt(document.getElementById('master-volume').value)
            };
            localStorage.setItem('soundSettings', JSON.stringify(soundSettings));
        }

        function updateVolume() {
            const volume = document.getElementById('master-volume').value;
            document.getElementById('volume-percent').textContent = `${volume}%`;
            saveSoundSettings();
        }

        function getSoundSetting(type) {
            return soundSettings[type] !== false;
        }

        function getVolume() {
            return (soundSettings.volume || 70) / 100;
        }

        function testSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
            gainNode.gain.setValueAtTime(getVolume() * 0.3, audioContext.currentTime);

            oscillator.start(audioContext.currentTime);
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
            oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
            oscillator.stop(audioContext.currentTime + 0.4);
        }

        // Enhanced playSound function that respects settings
        const originalPlaySound = typeof playSound === 'function' ? playSound : null;
        window.playSound = function(type) {
            const volume = getVolume();
            if (volume === 0) return;

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            switch(type) {
                case 'success':
                case 'correct':
                    if (!getSoundSetting('correct')) return;
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(volume * 0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;

                case 'error':
                case 'wrong':
                    if (!getSoundSetting('wrong')) return;
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(volume * 0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;

                case 'levelup':
                case 'xp':
                    if (!getSoundSetting('xp')) return;
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(392, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.2);
                    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.3);
                    gainNode.gain.setValueAtTime(volume * 0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                    break;

                case 'pop':
                case 'notify':
                    if (!getSoundSetting('notify')) return;
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(volume * 0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
            }
        };

        console.log(' Crossword Puzzle, Mistake Review, and Sound Settings loaded!');
    </script>

    <!-- ========== Batch 51: Study Scheduler, Concept Map, Bookmarks ========== -->

    <!-- Study Scheduler Floating Button -->
    <button class="floating-scheduler-btn" onclick="openScheduler()" title="Study Scheduler"></button>

    <!-- Concept Map Floating Button -->
    <button class="floating-concept-btn" onclick="openConceptMap()" title="Concept Map"></button>

    <!-- Bookmarks Floating Button -->
    <button class="floating-bookmark-btn" onclick="openBookmarks()" title="Bookmarks"></button>

    <!-- Study Scheduler Modal -->
    <div class="scheduler-modal" id="scheduler-modal">
        <div class="scheduler-content">
            <div class="scheduler-header">
                <h2> Study Scheduler</h2>
                <button onclick="closeScheduler()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div class="scheduler-form">
                <label>Topic</label>
                <select id="schedule-topic">
                    <option value="Matter">Matter</option>
                    <option value="Heat">Heat</option>
                    <option value="Light">Light</option>
                    <option value="Energy">Energy</option>
                    <option value="Forces">Forces</option>
                    <option value="Life Science">Life Science</option>
                    <option value="Plants">Plants</option>
                </select>
                <label>Date</label>
                <input type="date" id="schedule-date">
                <label>Time</label>
                <input type="time" id="schedule-time" value="16:00">
                <label>Duration (minutes)</label>
                <input type="number" id="schedule-duration" value="30" min="10" max="120">
                <button class="add-schedule-btn" onclick="addSchedule()">Add to Schedule</button>
            </div>
            <h3 style="color:#4dd0e1;margin-bottom:10px;">Upcoming Sessions</h3>
            <div class="schedule-list" id="schedule-list"></div>
        </div>
    </div>

    <!-- Concept Map Modal -->
    <div class="concept-map-modal" id="concept-map-modal">
        <div class="concept-map-content">
            <div class="concept-map-header">
                <h2> Concept Map</h2>
                <button onclick="closeConceptMap()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div class="concept-topic-select" id="concept-topics"></div>
            <div class="concept-map-container" id="concept-map-container"></div>
            <div class="concept-details" id="concept-details"></div>
        </div>
    </div>

    <!-- Bookmarks Modal -->
    <div class="bookmark-modal" id="bookmark-modal">
        <div class="bookmark-content">
            <div class="bookmark-header">
                <h2> Bookmarks</h2>
                <button onclick="closeBookmarks()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div class="bookmark-stats" id="bookmark-stats"></div>
            <div class="bookmark-list" id="bookmark-list"></div>
        </div>
    </div>

    <script>
        // ========== Study Scheduler System ==========
        let studySchedule = JSON.parse(localStorage.getItem('studySchedule') || '[]');

        function openScheduler() {
            document.getElementById('scheduler-modal').style.display = 'flex';
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('schedule-date').value = tomorrow.toISOString().split('T')[0];
            renderSchedule();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closeScheduler() {
            document.getElementById('scheduler-modal').style.display = 'none';
        }

        function addSchedule() {
            const topic = document.getElementById('schedule-topic').value;
            const date = document.getElementById('schedule-date').value;
            const time = document.getElementById('schedule-time').value;
            const duration = document.getElementById('schedule-duration').value;

            if (!date) {
                alert('Please select a date');
                return;
            }

            const session = {
                id: Date.now(),
                topic: topic,
                date: date,
                time: time,
                duration: parseInt(duration),
                completed: false
            };

            studySchedule.push(session);
            studySchedule.sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
            localStorage.setItem('studySchedule', JSON.stringify(studySchedule));
            renderSchedule();

            if (typeof playSound === 'function' && getSoundSetting('correct')) playSound('success');
        }

        function renderSchedule() {
            const list = document.getElementById('schedule-list');
            const now = new Date();

            // Filter out past sessions
            studySchedule = studySchedule.filter(s => new Date(s.date + 'T' + s.time) >= now || s.completed);
            localStorage.setItem('studySchedule', JSON.stringify(studySchedule));

            if (studySchedule.length === 0) {
                list.innerHTML = '<p style="color:#888;text-align:center;padding:20px;">No scheduled sessions. Add one above!</p>';
                return;
            }

            list.innerHTML = studySchedule.map(session => {
                const sessionDate = new Date(session.date + 'T' + session.time);
                const formattedDate = sessionDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                const formattedTime = sessionDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="schedule-item">
                        <div class="schedule-info">
                            <div class="schedule-topic">${session.topic}</div>
                            <div class="schedule-time">${formattedDate} at ${formattedTime} (${session.duration} min)</div>
                        </div>
                        <button class="schedule-delete" onclick="deleteSchedule(${session.id})"></button>
                    </div>
                `;
            }).join('');
        }

        function deleteSchedule(id) {
            studySchedule = studySchedule.filter(s => s.id !== id);
            localStorage.setItem('studySchedule', JSON.stringify(studySchedule));
            renderSchedule();
        }

        // Check for upcoming study sessions
        function checkScheduleReminders() {
            const now = new Date();
            studySchedule.forEach(session => {
                const sessionTime = new Date(session.date + 'T' + session.time);
                const timeDiff = sessionTime - now;

                // Remind 5 minutes before
                if (timeDiff > 0 && timeDiff <= 5 * 60 * 1000 && !session.reminded) {
                    session.reminded = true;
                    localStorage.setItem('studySchedule', JSON.stringify(studySchedule));

                    if (Notification.permission === 'granted') {
                        new Notification('Study Time Soon!', {
                            body: `Your ${session.topic} study session starts in 5 minutes!`,
                            icon: ''
                        });
                    }
                }
            });
        }

        // Check reminders every minute
        setInterval(checkScheduleReminders, 60000);

        // ========== Concept Map System ==========
        const conceptMaps = {
            'Matter': {
                main: 'Matter',
                description: 'Matter is anything that has mass and takes up space.',
                nodes: [
                    { name: 'Solid', type: 'sub', desc: 'Has fixed shape and volume. Particles are closely packed.' },
                    { name: 'Liquid', type: 'sub', desc: 'Has fixed volume but takes shape of container. Particles are loosely packed.' },
                    { name: 'Gas', type: 'sub', desc: 'No fixed shape or volume. Particles are far apart and move freely.' },
                    { name: 'Properties', type: 'normal', desc: 'Mass, volume, density, and state are properties of matter.' },
                    { name: 'Changes', type: 'normal', desc: 'Matter can change state through heating or cooling.' }
                ]
            },
            'Energy': {
                main: 'Energy',
                description: 'Energy is the ability to do work or cause change.',
                nodes: [
                    { name: 'Light', type: 'sub', desc: 'Energy that allows us to see. Travels in straight lines.' },
                    { name: 'Heat', type: 'sub', desc: 'Energy that flows from hot to cold objects.' },
                    { name: 'Sound', type: 'sub', desc: 'Energy that travels through vibrations.' },
                    { name: 'Electrical', type: 'normal', desc: 'Energy from moving electrons in a circuit.' },
                    { name: 'Kinetic', type: 'normal', desc: 'Energy of moving objects.' }
                ]
            },
            'Forces': {
                main: 'Forces',
                description: 'A force is a push or pull that can change motion.',
                nodes: [
                    { name: 'Gravity', type: 'sub', desc: 'Force that pulls objects toward Earth.' },
                    { name: 'Friction', type: 'sub', desc: 'Force that opposes motion between surfaces.' },
                    { name: 'Magnetic', type: 'sub', desc: 'Force between magnets or magnetic materials.' },
                    { name: 'Balanced', type: 'normal', desc: 'Equal forces in opposite directions - no change in motion.' },
                    { name: 'Unbalanced', type: 'normal', desc: 'Unequal forces cause change in motion.' }
                ]
            },
            'Life Science': {
                main: 'Living Things',
                description: 'Living things grow, reproduce, and respond to their environment.',
                nodes: [
                    { name: 'Plants', type: 'sub', desc: 'Make their own food through photosynthesis.' },
                    { name: 'Animals', type: 'sub', desc: 'Get energy by eating other organisms.' },
                    { name: 'Cells', type: 'normal', desc: 'Basic unit of life. All living things have cells.' },
                    { name: 'Habitats', type: 'normal', desc: 'Places where organisms live and get what they need.' },
                    { name: 'Food Chains', type: 'normal', desc: 'Shows how energy flows from one organism to another.' }
                ]
            }
        };

        let currentConceptTopic = 'Matter';

        function openConceptMap() {
            document.getElementById('concept-map-modal').style.display = 'flex';
            renderConceptTopics();
            renderConceptMap();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closeConceptMap() {
            document.getElementById('concept-map-modal').style.display = 'none';
        }

        function renderConceptTopics() {
            const container = document.getElementById('concept-topics');
            container.innerHTML = Object.keys(conceptMaps).map(topic =>
                `<button class="concept-topic-btn ${topic === currentConceptTopic ? 'active' : ''}" onclick="selectConceptTopic('${topic}')">${topic}</button>`
            ).join('');
        }

        function selectConceptTopic(topic) {
            currentConceptTopic = topic;
            renderConceptTopics();
            renderConceptMap();
            document.getElementById('concept-details').classList.remove('show');
        }

        function renderConceptMap() {
            const container = document.getElementById('concept-map-container');
            const map = conceptMaps[currentConceptTopic];

            container.innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div class="concept-node main" onclick="showConceptDetails('main')">${map.main}</div>
                </div>
                <div style="text-align:center;display:flex;flex-wrap:wrap;justify-content:center;">
                    ${map.nodes.map((node, i) =>
                        `<div class="concept-node ${node.type}" onclick="showConceptDetails(${i})">${node.name}</div>`
                    ).join('')}
                </div>
            `;
        }

        function showConceptDetails(index) {
            const details = document.getElementById('concept-details');
            const map = conceptMaps[currentConceptTopic];

            if (index === 'main') {
                details.innerHTML = `<h4>${map.main}</h4><p>${map.description}</p>`;
            } else {
                const node = map.nodes[index];
                details.innerHTML = `<h4>${node.name}</h4><p>${node.desc}</p>`;
            }

            details.classList.add('show');
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        // ========== Bookmark System ==========
        let bookmarks = JSON.parse(localStorage.getItem('questionBookmarks') || '[]');

        function openBookmarks() {
            document.getElementById('bookmark-modal').style.display = 'flex';
            renderBookmarks();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closeBookmarks() {
            document.getElementById('bookmark-modal').style.display = 'none';
        }

        function addBookmark(question, topic, questionId) {
            const existing = bookmarks.find(b => b.questionId === questionId);
            if (existing) {
                alert('This question is already bookmarked!');
                return;
            }

            const bookmark = {
                id: Date.now(),
                question: question,
                topic: topic || 'General',
                questionId: questionId,
                timestamp: new Date().toISOString()
            };

            bookmarks.push(bookmark);
            localStorage.setItem('questionBookmarks', JSON.stringify(bookmarks));

            if (typeof playSound === 'function' && getSoundSetting('correct')) playSound('success');
            alert('Question bookmarked!');
        }

        function removeBookmark(id) {
            bookmarks = bookmarks.filter(b => b.id !== id);
            localStorage.setItem('questionBookmarks', JSON.stringify(bookmarks));
            renderBookmarks();
        }

        function renderBookmarks() {
            const statsDiv = document.getElementById('bookmark-stats');
            const listDiv = document.getElementById('bookmark-list');

            const topicCounts = {};
            bookmarks.forEach(b => {
                topicCounts[b.topic] = (topicCounts[b.topic] || 0) + 1;
            });
            const topTopic = Object.entries(topicCounts).sort((a, b) => b[1] - a[1])[0];

            statsDiv.innerHTML = `
                <div class="bookmark-stat">
                    <div class="bookmark-stat-value">${bookmarks.length}</div>
                    <div class="bookmark-stat-label">Bookmarks</div>
                </div>
                <div class="bookmark-stat">
                    <div class="bookmark-stat-value">${Object.keys(topicCounts).length}</div>
                    <div class="bookmark-stat-label">Topics</div>
                </div>
                <div class="bookmark-stat">
                    <div class="bookmark-stat-value">${topTopic ? topTopic[0].substring(0, 8) : 'N/A'}</div>
                    <div class="bookmark-stat-label">Most Saved</div>
                </div>
            `;

            if (bookmarks.length === 0) {
                listDiv.innerHTML = `
                    <div class="no-bookmarks">
                        <div class="no-bookmarks-icon"></div>
                        <h3>No bookmarks yet!</h3>
                        <p>Bookmark questions you want to revisit later.</p>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = bookmarks.slice().reverse().map(bookmark => `
                <div class="bookmark-item">
                    <div class="bookmark-question">${bookmark.question.substring(0, 100)}${bookmark.question.length > 100 ? '...' : ''}</div>
                    <div class="bookmark-meta">
                        <span class="bookmark-topic">${bookmark.topic}</span>
                        <div class="bookmark-actions">
                            <button class="bookmark-action-btn bookmark-goto" onclick="goToBookmark('${bookmark.questionId}')">Go to</button>
                            <button class="bookmark-action-btn bookmark-remove" onclick="removeBookmark(${bookmark.id})">Remove</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function goToBookmark(questionId) {
            closeBookmarks();
            const element = document.getElementById(questionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.style.boxShadow = '0 0 20px rgba(255, 193, 7, 0.5)';
                setTimeout(() => {
                    element.style.boxShadow = '';
                }, 2000);
            }
        }

        console.log(' Study Scheduler, Concept Map, and Bookmarks loaded!');
    </script>

    <!-- ========== Batch 52: Scoreboard, Question Timer, Motivation Quotes ========== -->

    <!-- Scoreboard Floating Button -->
    <button class="floating-scoreboard-btn" onclick="openScoreboard()" title="Scoreboard"></button>

    <!-- Motivation Quotes Floating Button -->
    <button class="floating-motivation-btn" onclick="openMotivation()" title="Daily Motivation"></button>

    <!-- Scoreboard Modal -->
    <div class="scoreboard-modal" id="scoreboard-modal">
        <div class="scoreboard-content">
            <div class="scoreboard-header">
                <h2> Scoreboard</h2>
                <button onclick="closeScoreboard()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div class="scoreboard-tabs">
                <button class="scoreboard-tab active" onclick="switchScoreTab('daily')">Today</button>
                <button class="scoreboard-tab" onclick="switchScoreTab('weekly')">This Week</button>
                <button class="scoreboard-tab" onclick="switchScoreTab('alltime')">All Time</button>
            </div>
            <div id="scoreboard-list"></div>
        </div>
    </div>

    <!-- Motivation Quotes Modal -->
    <div class="motivation-modal" id="motivation-modal">
        <div class="motivation-content">
            <div class="motivation-header">
                <h2> Daily Motivation</h2>
                <button onclick="closeMotivation()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div class="quote-icon" id="quote-icon"></div>
            <div class="quote-text" id="quote-text"></div>
            <div class="quote-author" id="quote-author"></div>
            <div class="quote-category" id="quote-category"></div>
            <button class="new-quote-btn" onclick="showRandomQuote()"> New Quote</button>
        </div>
    </div>

    <script>
        // ========== Scoreboard System ==========
        let scoreHistory = JSON.parse(localStorage.getItem('scoreHistory') || '[]');
        let currentScoreTab = 'daily';

        function openScoreboard() {
            document.getElementById('scoreboard-modal').style.display = 'flex';
            renderScoreboard();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closeScoreboard() {
            document.getElementById('scoreboard-modal').style.display = 'none';
        }

        function recordScore(score, gameType) {
            const entry = {
                id: Date.now(),
                score: score,
                gameType: gameType || 'Quiz',
                timestamp: new Date().toISOString(),
                playerName: localStorage.getItem('playerName') || 'Student'
            };
            scoreHistory.push(entry);
            // Keep only last 100 scores
            if (scoreHistory.length > 100) {
                scoreHistory = scoreHistory.slice(-100);
            }
            localStorage.setItem('scoreHistory', JSON.stringify(scoreHistory));
        }

        function switchScoreTab(tab) {
            currentScoreTab = tab;
            document.querySelectorAll('.scoreboard-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderScoreboard();
        }

        function renderScoreboard() {
            const list = document.getElementById('scoreboard-list');
            const now = new Date();
            let filteredScores = [];

            if (currentScoreTab === 'daily') {
                const today = now.toDateString();
                filteredScores = scoreHistory.filter(s => new Date(s.timestamp).toDateString() === today);
            } else if (currentScoreTab === 'weekly') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredScores = scoreHistory.filter(s => new Date(s.timestamp) >= weekAgo);
            } else {
                filteredScores = [...scoreHistory];
            }

            // Sort by score descending
            filteredScores.sort((a, b) => b.score - a.score);
            const topScores = filteredScores.slice(0, 10);

            if (topScores.length === 0) {
                list.innerHTML = '<p style="color:#888;text-align:center;padding:30px;">No scores recorded yet. Start playing to see your scores here!</p>';
                return;
            }

            list.innerHTML = topScores.map((entry, i) => {
                let rankClass = 'normal';
                if (i === 0) rankClass = 'gold';
                else if (i === 1) rankClass = 'silver';
                else if (i === 2) rankClass = 'bronze';

                const date = new Date(entry.timestamp);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                return `
                    <div class="score-entry">
                        <div class="score-rank ${rankClass}">${i + 1}</div>
                        <div class="score-info">
                            <div class="score-name">${entry.playerName}</div>
                            <div class="score-date">${entry.gameType}  ${dateStr}</div>
                        </div>
                        <div class="score-value">${entry.score}</div>
                    </div>
                `;
            }).join('');
        }

        // ========== Question Timer System ==========
        let questionTimers = {};

        function startQuestionTimer(questionId, seconds = 60) {
            // Clear existing timer if any
            if (questionTimers[questionId]) {
                clearInterval(questionTimers[questionId].interval);
            }

            const timerData = {
                timeLeft: seconds,
                totalTime: seconds,
                interval: null
            };

            // Create timer element if it doesn't exist
            const question = document.getElementById(questionId);
            if (!question) return;

            let timerEl = question.querySelector('.question-timer');
            if (!timerEl) {
                timerEl = document.createElement('div');
                timerEl.className = 'question-timer';
                question.style.position = 'relative';
                question.appendChild(timerEl);
            }

            timerEl.textContent = seconds;
            timerEl.className = 'question-timer';

            timerData.interval = setInterval(() => {
                timerData.timeLeft--;
                timerEl.textContent = timerData.timeLeft;

                // Update color based on time remaining
                const percentLeft = timerData.timeLeft / timerData.totalTime;
                if (percentLeft <= 0.2) {
                    timerEl.className = 'question-timer danger';
                } else if (percentLeft <= 0.5) {
                    timerEl.className = 'question-timer warning';
                }

                if (timerData.timeLeft <= 0) {
                    clearInterval(timerData.interval);
                    timerEl.textContent = '0';
                    if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('error');
                }
            }, 1000);

            questionTimers[questionId] = timerData;
        }

        function stopQuestionTimer(questionId) {
            if (questionTimers[questionId]) {
                clearInterval(questionTimers[questionId].interval);
                const question = document.getElementById(questionId);
                if (question) {
                    const timerEl = question.querySelector('.question-timer');
                    if (timerEl) timerEl.remove();
                }
                delete questionTimers[questionId];
            }
        }

        function getQuestionTimeUsed(questionId) {
            if (questionTimers[questionId]) {
                return questionTimers[questionId].totalTime - questionTimers[questionId].timeLeft;
            }
            return 0;
        }

        // ========== Motivation Quotes System ==========
        const motivationQuotes = [
            { text: "The more that you read, the more things you will know. The more that you learn, the more places you'll go.", author: "Dr. Seuss", category: "Learning", icon: "" },
            { text: "Science is not only a disciple of reason but also one of romance and passion.", author: "Stephen Hawking", category: "Science", icon: "" },
            { text: "Mistakes are proof that you are trying.", author: "Unknown", category: "Growth", icon: "" },
            { text: "The expert in anything was once a beginner.", author: "Helen Hayes", category: "Progress", icon: "" },
            { text: "Every accomplishment starts with the decision to try.", author: "John F. Kennedy", category: "Motivation", icon: "" },
            { text: "The only way to do great work is to love what you do.", author: "Steve Jobs", category: "Passion", icon: "" },
            { text: "Curiosity is the wick in the candle of learning.", author: "William Arthur Ward", category: "Curiosity", icon: "" },
            { text: "Education is the most powerful weapon which you can use to change the world.", author: "Nelson Mandela", category: "Education", icon: "" },
            { text: "Success is the sum of small efforts repeated day in and day out.", author: "Robert Collier", category: "Persistence", icon: "" },
            { text: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson", category: "Perseverance", icon: "" },
            { text: "The beautiful thing about learning is that no one can take it away from you.", author: "B.B. King", category: "Learning", icon: "" },
            { text: "It does not matter how slowly you go as long as you do not stop.", author: "Confucius", category: "Progress", icon: "" },
            { text: "Science knows no country, because knowledge belongs to humanity.", author: "Louis Pasteur", category: "Science", icon: "" },
            { text: "Believe you can and you're halfway there.", author: "Theodore Roosevelt", category: "Belief", icon: "" },
            { text: "The only impossible journey is the one you never begin.", author: "Tony Robbins", category: "Action", icon: "" }
        ];

        let currentQuoteIndex = 0;

        function openMotivation() {
            document.getElementById('motivation-modal').style.display = 'flex';
            showDailyQuote();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closeMotivation() {
            document.getElementById('motivation-modal').style.display = 'none';
        }

        function showDailyQuote() {
            // Use day of year to get consistent daily quote
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = now - start;
            const dayOfYear = Math.floor(diff / (1000 * 60 * 60 * 24));
            currentQuoteIndex = dayOfYear % motivationQuotes.length;
            displayQuote(currentQuoteIndex);
        }

        function showRandomQuote() {
            currentQuoteIndex = Math.floor(Math.random() * motivationQuotes.length);
            displayQuote(currentQuoteIndex);
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function displayQuote(index) {
            const quote = motivationQuotes[index];
            document.getElementById('quote-icon').textContent = quote.icon;
            document.getElementById('quote-text').textContent = `"${quote.text}"`;
            document.getElementById('quote-author').textContent = ` ${quote.author}`;
            document.getElementById('quote-category').textContent = quote.category;
        }

        // Show motivation quote on first visit of the day
        function checkDailyMotivation() {
            const lastVisit = localStorage.getItem('lastMotivationDate');
            const today = new Date().toDateString();

            if (lastVisit !== today) {
                localStorage.setItem('lastMotivationDate', today);
                // Show quote after a short delay
                setTimeout(() => {
                    openMotivation();
                }, 2000);
            }
        }

        // Check for daily motivation on page load
        setTimeout(checkDailyMotivation, 3000);

        console.log(' Scoreboard, Question Timer, and Motivation Quotes loaded!');
    </script>

    <!-- ========== Batch 53: Study Notes, Hint System, Topic Progress ========== -->

    <!-- Study Notes Floating Button -->
    <button class="floating-notes-btn" onclick="openNotes()" title="Study Notes"></button>

    <!-- Topic Progress Floating Button -->
    <button class="floating-progress-btn" onclick="openTopicProgress()" title="Topic Progress"></button>

    <!-- Study Notes Modal -->
    <div class="notes-modal" id="notes-modal">
        <div class="notes-content">
            <div class="notes-header">
                <h2> Study Notes</h2>
                <button onclick="closeNotes()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div class="note-editor">
                <input type="text" class="note-title-input" id="note-title" placeholder="Note title...">
                <textarea class="note-text-input" id="note-text" placeholder="Write your notes here..."></textarea>
                <button class="save-note-btn" onclick="saveNote()"> Save Note</button>
            </div>
            <h3 style="color:#ffb74d;margin-bottom:10px;font-size:1rem;">Your Notes</h3>
            <div class="notes-list" id="notes-list"></div>
        </div>
    </div>

    <!-- Topic Progress Modal -->
    <div class="progress-modal" id="progress-modal">
        <div class="progress-content">
            <div class="progress-header">
                <h2> Topic Progress</h2>
                <button onclick="closeTopicProgress()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div class="overall-progress">
                <div class="overall-percent" id="overall-percent">0%</div>
                <div class="overall-label">Overall Mastery</div>
            </div>
            <div id="topic-progress-list"></div>
        </div>
    </div>

    <script>
        // ========== Study Notes System ==========
        let studyNotes = JSON.parse(localStorage.getItem('studyNotes') || '[]');

        function openNotes() {
            document.getElementById('notes-modal').style.display = 'flex';
            renderNotes();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closeNotes() {
            document.getElementById('notes-modal').style.display = 'none';
        }

        function saveNote() {
            const title = document.getElementById('note-title').value.trim();
            const text = document.getElementById('note-text').value.trim();

            if (!text) {
                alert('Please write something in your note!');
                return;
            }

            const note = {
                id: Date.now(),
                title: title || 'Untitled Note',
                text: text,
                timestamp: new Date().toISOString()
            };

            studyNotes.push(note);
            // Keep only last 50 notes
            if (studyNotes.length > 50) {
                studyNotes = studyNotes.slice(-50);
            }
            localStorage.setItem('studyNotes', JSON.stringify(studyNotes));

            // Clear inputs
            document.getElementById('note-title').value = '';
            document.getElementById('note-text').value = '';

            renderNotes();
            if (typeof playSound === 'function' && getSoundSetting('correct')) playSound('success');
        }

        function deleteNote(id) {
            if (confirm('Delete this note?')) {
                studyNotes = studyNotes.filter(n => n.id !== id);
                localStorage.setItem('studyNotes', JSON.stringify(studyNotes));
                renderNotes();
            }
        }

        function renderNotes() {
            const list = document.getElementById('notes-list');

            if (studyNotes.length === 0) {
                list.innerHTML = '<p style="color:#888;text-align:center;padding:20px;">No notes yet. Start writing!</p>';
                return;
            }

            list.innerHTML = studyNotes.slice().reverse().map(note => {
                const date = new Date(note.timestamp);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                return `
                    <div class="note-item">
                        <div class="note-item-title">${note.title}</div>
                        <div class="note-item-text">${note.text.substring(0, 200)}${note.text.length > 200 ? '...' : ''}</div>
                        <div class="note-item-meta">
                            <span class="note-item-date">${dateStr}</span>
                            <button class="note-delete-btn" onclick="deleteNote(${note.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== Hint System ==========
        let hintUsage = JSON.parse(localStorage.getItem('hintUsage') || '{}');
        const hintCost = 10; // XP cost per hint

        const hintDatabase = {
            'matter': [
                'Think about what happens to particles when heated or cooled.',
                'Consider the arrangement of particles in each state.',
                'Remember: solids have fixed shape, liquids flow, gases expand.'
            ],
            'heat': [
                'Heat always flows from hotter to cooler objects.',
                'Good conductors transfer heat quickly, poor conductors slowly.',
                'Think about what materials feel cold vs warm to touch.'
            ],
            'light': [
                'Light travels in straight lines.',
                'Transparent materials let all light through, opaque block it.',
                'Shadows form because light cannot pass through opaque objects.'
            ],
            'energy': [
                'Energy cannot be created or destroyed, only transformed.',
                'Think about the source and what it changes into.',
                'Electrical energy requires a complete circuit to flow.'
            ],
            'forces': [
                'Forces always come in pairs - action and reaction.',
                'Friction opposes motion between surfaces.',
                'Gravity pulls everything toward the center of Earth.'
            ],
            'life': [
                'All living things need food, water, and air.',
                'Plants make food through photosynthesis.',
                'Think about how energy flows in food chains.'
            ],
            'plants': [
                'Plants need sunlight, water, carbon dioxide for photosynthesis.',
                'Roots absorb water, leaves capture sunlight.',
                'The green color comes from chlorophyll.'
            ]
        };

        function getHint(topic, questionId) {
            const currentXP = parseInt(localStorage.getItem('userXP')) || 0;

            // Check if already used hint for this question
            if (hintUsage[questionId]) {
                showHintDisplay(questionId, hintUsage[questionId]);
                return;
            }

            // Check if user has enough XP
            if (currentXP < hintCost) {
                alert(`You need ${hintCost} XP to get a hint. You have ${currentXP} XP.`);
                return;
            }

            // Deduct XP
            const newXP = currentXP - hintCost;
            localStorage.setItem('userXP', newXP);
            if (typeof updateXPDisplay === 'function') updateXPDisplay();

            // Get random hint for topic
            const topicKey = topic.toLowerCase().replace(/\s+/g, '');
            const hints = hintDatabase[topicKey] || hintDatabase['matter'];
            const hint = hints[Math.floor(Math.random() * hints.length)];

            // Save hint usage
            hintUsage[questionId] = hint;
            localStorage.setItem('hintUsage', JSON.stringify(hintUsage));

            showHintDisplay(questionId, hint);
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function showHintDisplay(questionId, hint) {
            const question = document.getElementById(questionId);
            if (!question) return;

            let hintDiv = question.querySelector('.hint-display');
            if (!hintDiv) {
                hintDiv = document.createElement('div');
                hintDiv.className = 'hint-display';
                question.appendChild(hintDiv);
            }

            hintDiv.innerHTML = `
                <span class="hint-icon"></span>
                <span class="hint-text">${hint}</span>
                <div class="hint-cost">Hint used (${hintCost} XP)</div>
            `;
            hintDiv.classList.add('show');
        }

        function createHintButton(topic, questionId) {
            return `<button class="hint-btn" onclick="getHint('${topic}', '${questionId}')"> Get Hint (-${hintCost} XP)</button>`;
        }

        // ========== Topic Progress System ==========
        let topicProgressData = JSON.parse(localStorage.getItem('topicProgress') || '{}');

        const topicList = [
            { id: 'matter', name: 'Matter', class: 'matter' },
            { id: 'heat', name: 'Heat', class: 'heat' },
            { id: 'light', name: 'Light', class: 'light' },
            { id: 'energy', name: 'Energy', class: 'energy' },
            { id: 'forces', name: 'Forces', class: 'forces' },
            { id: 'life', name: 'Life Science', class: 'life' },
            { id: 'plants', name: 'Plants', class: 'plants' }
        ];

        function openTopicProgress() {
            document.getElementById('progress-modal').style.display = 'flex';
            renderTopicProgress();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closeTopicProgress() {
            document.getElementById('progress-modal').style.display = 'none';
        }

        function updateTopicProgress(topicId, correct, total) {
            if (!topicProgressData[topicId]) {
                topicProgressData[topicId] = { correct: 0, total: 0 };
            }
            topicProgressData[topicId].correct += correct;
            topicProgressData[topicId].total += total;
            localStorage.setItem('topicProgress', JSON.stringify(topicProgressData));
        }

        function recordTopicAnswer(topicId, isCorrect) {
            if (!topicProgressData[topicId]) {
                topicProgressData[topicId] = { correct: 0, total: 0 };
            }
            topicProgressData[topicId].total += 1;
            if (isCorrect) topicProgressData[topicId].correct += 1;
            localStorage.setItem('topicProgress', JSON.stringify(topicProgressData));
        }

        function renderTopicProgress() {
            const list = document.getElementById('topic-progress-list');
            let totalCorrect = 0;
            let totalQuestions = 0;

            const progressHTML = topicList.map(topic => {
                const data = topicProgressData[topic.id] || { correct: 0, total: 0 };
                const percent = data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0;

                totalCorrect += data.correct;
                totalQuestions += data.total;

                return `
                    <div class="topic-progress-item">
                        <div class="topic-progress-header">
                            <span class="topic-progress-name">${topic.name}</span>
                            <span class="topic-progress-percent">${percent}%</span>
                        </div>
                        <div class="topic-progress-bar">
                            <div class="topic-progress-fill ${topic.class}" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            list.innerHTML = progressHTML;

            // Update overall
            const overallPercent = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            document.getElementById('overall-percent').textContent = `${overallPercent}%`;
        }

        console.log(' Study Notes, Hint System, and Topic Progress loaded!');
    </script>

    <!-- ========== Batch 54: Dictionary, Practice Mode, Streak Calendar ========== -->

    <!-- Dictionary Floating Button -->
    <button class="floating-dictionary-btn" onclick="openDictionary()" title="Science Dictionary"></button>

    <!-- Practice Mode Floating Button -->
    <button class="floating-practice-btn" onclick="openPractice()" title="Practice Mode"></button>

    <!-- Streak Calendar Floating Button -->
    <button class="floating-calendar-btn" onclick="openStreakCalendar()" title="Study Streak"></button>

    <!-- Science Dictionary Modal -->
    <div class="dictionary-modal" id="dictionary-modal">
        <div class="dictionary-content">
            <div class="dictionary-header">
                <h2> Science Dictionary</h2>
                <button onclick="closeDictionary()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <input type="text" class="dictionary-search" id="dictionary-search" placeholder="Search for a term..." oninput="filterDictionary()">
            <div class="dictionary-list" id="dictionary-list"></div>
        </div>
    </div>

    <!-- Practice Mode Modal -->
    <div class="practice-modal" id="practice-modal">
        <div class="practice-content">
            <div class="practice-header">
                <h2> Practice Mode</h2>
                <button onclick="closePractice()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div class="practice-stats">
                <div class="practice-stat">
                    <div class="practice-stat-value" id="practice-correct">0</div>
                    <div class="practice-stat-label">Correct</div>
                </div>
                <div class="practice-stat">
                    <div class="practice-stat-value" id="practice-total">0</div>
                    <div class="practice-stat-label">Total</div>
                </div>
                <div class="practice-stat">
                    <div class="practice-stat-value" id="practice-streak">0</div>
                    <div class="practice-stat-label">Streak</div>
                </div>
            </div>
            <div class="practice-question-box" id="practice-question-box"></div>
            <button class="practice-next-btn" id="practice-next-btn" onclick="nextPracticeQuestion()" style="display:none;">Next Question </button>
        </div>
    </div>

    <!-- Streak Calendar Modal -->
    <div class="calendar-modal" id="calendar-modal">
        <div class="calendar-content">
            <div class="calendar-header">
                <h2> Study Streak</h2>
                <button onclick="closeStreakCalendar()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div class="streak-summary">
                <div class="streak-box">
                    <div class="streak-value" id="current-streak">0</div>
                    <div class="streak-label">Current Streak</div>
                </div>
                <div class="streak-box">
                    <div class="streak-value" id="longest-streak">0</div>
                    <div class="streak-label">Longest Streak</div>
                </div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    </div>

    <script>
        // ========== Science Dictionary System ==========
        const scienceDictionary = [
            { term: 'Matter', definition: 'Anything that has mass and takes up space.', category: 'Matter' },
            { term: 'Solid', definition: 'State of matter with fixed shape and volume. Particles are tightly packed.', category: 'Matter' },
            { term: 'Liquid', definition: 'State of matter with fixed volume but takes shape of container.', category: 'Matter' },
            { term: 'Gas', definition: 'State of matter with no fixed shape or volume. Particles move freely.', category: 'Matter' },
            { term: 'Heat', definition: 'A form of energy that flows from warmer to cooler objects.', category: 'Heat' },
            { term: 'Conductor', definition: 'Material that allows heat or electricity to pass through easily.', category: 'Heat' },
            { term: 'Insulator', definition: 'Material that does not allow heat or electricity to pass through easily.', category: 'Heat' },
            { term: 'Light', definition: 'A form of energy that allows us to see. Travels in straight lines.', category: 'Light' },
            { term: 'Transparent', definition: 'Material that lets all light pass through (e.g., clear glass).', category: 'Light' },
            { term: 'Opaque', definition: 'Material that blocks all light from passing through.', category: 'Light' },
            { term: 'Translucent', definition: 'Material that lets some light pass through but scatters it.', category: 'Light' },
            { term: 'Energy', definition: 'The ability to do work or cause change.', category: 'Energy' },
            { term: 'Photosynthesis', definition: 'Process by which plants make food using sunlight, water, and carbon dioxide.', category: 'Plants' },
            { term: 'Chlorophyll', definition: 'Green pigment in plants that captures light energy for photosynthesis.', category: 'Plants' },
            { term: 'Force', definition: 'A push or pull that can change the motion or shape of an object.', category: 'Forces' },
            { term: 'Gravity', definition: 'Force that pulls objects toward the center of Earth.', category: 'Forces' },
            { term: 'Friction', definition: 'Force that opposes motion between two surfaces in contact.', category: 'Forces' },
            { term: 'Cell', definition: 'The basic unit of life. All living things are made of cells.', category: 'Life Science' },
            { term: 'Habitat', definition: 'The natural home or environment of an animal or plant.', category: 'Life Science' },
            { term: 'Food Chain', definition: 'Shows how energy flows from one organism to another through eating.', category: 'Life Science' }
        ];

        function openDictionary() {
            document.getElementById('dictionary-modal').style.display = 'flex';
            document.getElementById('dictionary-search').value = '';
            renderDictionary(scienceDictionary);
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closeDictionary() {
            document.getElementById('dictionary-modal').style.display = 'none';
        }

        function filterDictionary() {
            const search = document.getElementById('dictionary-search').value.toLowerCase();
            const filtered = scienceDictionary.filter(item =>
                item.term.toLowerCase().includes(search) ||
                item.definition.toLowerCase().includes(search)
            );
            renderDictionary(filtered);
        }

        function renderDictionary(items) {
            const list = document.getElementById('dictionary-list');
            if (items.length === 0) {
                list.innerHTML = '<p style="color:#888;text-align:center;padding:20px;">No terms found.</p>';
                return;
            }
            list.innerHTML = items.map(item => `
                <div class="dictionary-item">
                    <div class="dictionary-term">${item.term}</div>
                    <div class="dictionary-definition">${item.definition}</div>
                    <span class="dictionary-category">${item.category}</span>
                </div>
            `).join('');
        }

        // ========== Practice Mode System ==========
        const practiceQuestions = [
            { q: 'What state of matter has a fixed shape and volume?', options: ['Solid', 'Liquid', 'Gas', 'Plasma'], answer: 0, topic: 'Matter' },
            { q: 'Which material is a good conductor of heat?', options: ['Wood', 'Plastic', 'Metal', 'Rubber'], answer: 2, topic: 'Heat' },
            { q: 'Light travels in...', options: ['Curved lines', 'Zigzag lines', 'Straight lines', 'Wavy lines'], answer: 2, topic: 'Light' },
            { q: 'What do plants need for photosynthesis?', options: ['Darkness', 'Sunlight, water, CO2', 'Only water', 'Only soil'], answer: 1, topic: 'Plants' },
            { q: 'Which force pulls objects toward Earth?', options: ['Friction', 'Magnetism', 'Gravity', 'Air resistance'], answer: 2, topic: 'Forces' },
            { q: 'What is the basic unit of life?', options: ['Atom', 'Molecule', 'Cell', 'Organ'], answer: 2, topic: 'Life Science' },
            { q: 'An opaque material...', options: ['Lets all light through', 'Blocks all light', 'Scatters light', 'Bends light'], answer: 1, topic: 'Light' },
            { q: 'Heat flows from...', options: ['Cold to hot', 'Hot to cold', 'Equally in all directions', 'Does not flow'], answer: 1, topic: 'Heat' },
            { q: 'The green pigment in plants is called...', options: ['Melanin', 'Chlorophyll', 'Hemoglobin', 'Carotene'], answer: 1, topic: 'Plants' },
            { q: 'Friction opposes...', options: ['Gravity', 'Motion', 'Light', 'Sound'], answer: 1, topic: 'Forces' }
        ];

        let practiceState = {
            correct: 0,
            total: 0,
            streak: 0,
            currentQuestion: null,
            answered: false
        };

        function openPractice() {
            document.getElementById('practice-modal').style.display = 'flex';
            practiceState = { correct: 0, total: 0, streak: 0, currentQuestion: null, answered: false };
            updatePracticeStats();
            nextPracticeQuestion();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closePractice() {
            document.getElementById('practice-modal').style.display = 'none';
        }

        function nextPracticeQuestion() {
            practiceState.answered = false;
            document.getElementById('practice-next-btn').style.display = 'none';

            // Get random question
            const randomIndex = Math.floor(Math.random() * practiceQuestions.length);
            practiceState.currentQuestion = practiceQuestions[randomIndex];
            const q = practiceState.currentQuestion;

            document.getElementById('practice-question-box').innerHTML = `
                <div class="practice-question">${q.q}</div>
                <div class="practice-options">
                    ${q.options.map((opt, i) => `
                        <div class="practice-option" onclick="selectPracticeAnswer(${i})" id="practice-opt-${i}">${opt}</div>
                    `).join('')}
                </div>
            `;
        }

        function selectPracticeAnswer(index) {
            if (practiceState.answered) return;
            practiceState.answered = true;
            practiceState.total++;

            const q = practiceState.currentQuestion;
            const correct = index === q.answer;

            // Highlight answers
            document.getElementById(`practice-opt-${index}`).classList.add(correct ? 'correct' : 'wrong');
            if (!correct) {
                document.getElementById(`practice-opt-${q.answer}`).classList.add('correct');
            }

            if (correct) {
                practiceState.correct++;
                practiceState.streak++;
                if (typeof playSound === 'function' && getSoundSetting('correct')) playSound('success');
            } else {
                practiceState.streak = 0;
                if (typeof playSound === 'function' && getSoundSetting('wrong')) playSound('error');
            }

            updatePracticeStats();
            document.getElementById('practice-next-btn').style.display = 'block';

            // Record for topic progress
            if (typeof recordTopicAnswer === 'function') {
                recordTopicAnswer(q.topic.toLowerCase().replace(/\s+/g, ''), correct);
            }
        }

        function updatePracticeStats() {
            document.getElementById('practice-correct').textContent = practiceState.correct;
            document.getElementById('practice-total').textContent = practiceState.total;
            document.getElementById('practice-streak').textContent = practiceState.streak;
        }

        // ========== Streak Calendar System ==========
        let studyDays = JSON.parse(localStorage.getItem('studyDays') || '[]');
        let currentStreak = parseInt(localStorage.getItem('currentStreak')) || 0;
        let longestStreak = parseInt(localStorage.getItem('longestStreak')) || 0;

        function openStreakCalendar() {
            document.getElementById('calendar-modal').style.display = 'flex';
            updateStreakData();
            renderCalendar();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closeStreakCalendar() {
            document.getElementById('calendar-modal').style.display = 'none';
        }

        function recordStudyDay() {
            const today = new Date().toDateString();
            if (!studyDays.includes(today)) {
                studyDays.push(today);
                localStorage.setItem('studyDays', JSON.stringify(studyDays));
                updateStreakData();
            }
        }

        function updateStreakData() {
            const today = new Date();
            let streak = 0;
            let checkDate = new Date(today);

            // Count consecutive days backwards from today
            while (true) {
                const dateStr = checkDate.toDateString();
                if (studyDays.includes(dateStr)) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }

            currentStreak = streak;
            if (currentStreak > longestStreak) {
                longestStreak = currentStreak;
            }

            localStorage.setItem('currentStreak', currentStreak);
            localStorage.setItem('longestStreak', longestStreak);

            document.getElementById('current-streak').textContent = currentStreak;
            document.getElementById('longest-streak').textContent = longestStreak;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            // Day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let html = days.map(d => `<div class="calendar-day-header">${d}</div>`).join('');

            // Get first day of month
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startPadding = firstDay.getDay();

            // Add empty cells for padding
            for (let i = 0; i < startPadding; i++) {
                html += '<div class="calendar-day inactive"></div>';
            }

            // Add days
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = date.toDateString();
                const isToday = date.toDateString() === today.toDateString();
                const isActive = studyDays.includes(dateStr);

                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (isActive) classes += ' active';

                html += `<div class="${classes}">${day}</div>`;
            }

            grid.innerHTML = html;
        }

        // Record study day on any activity
        setTimeout(() => {
            recordStudyDay();
        }, 5000);

        console.log(' Dictionary, Practice Mode, and Streak Calendar loaded!');
    </script>

    <!-- ========== Batch 55: Quick Review, Answer Explanation, Parent Report ========== -->

    <!-- Quick Review Floating Button -->
    <button class="floating-review-btn" onclick="openQuickReview()" title="Quick Review"></button>

    <!-- Parent Report Floating Button -->
    <button class="floating-report-parent-btn" onclick="openParentReport()" title="Parent Report"></button>

    <!-- Quick Review Modal -->
    <div class="quick-review-modal" id="quick-review-modal">
        <div class="quick-review-content">
            <div class="quick-review-header">
                <h2> Quick Review</h2>
                <button onclick="closeQuickReview()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div class="review-progress" id="review-progress"></div>
            <div class="review-card" id="review-card" onclick="flipReviewCard()">
                <div class="review-front" id="review-front"></div>
                <div class="review-back" id="review-back"></div>
            </div>
            <p style="color:#888;text-align:center;font-size:0.85rem;margin-top:10px;">Tap card to flip</p>
            <div class="review-controls">
                <button class="review-btn learn" onclick="markAsLearning()"> Still Learning</button>
                <button class="review-btn know" onclick="markAsKnown()"> I Know This</button>
            </div>
        </div>
    </div>

    <!-- Parent Report Modal -->
    <div class="report-modal" id="report-modal">
        <div class="report-content">
            <div class="report-header">
                <h2> Parent Report</h2>
                <button onclick="closeParentReport()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <div id="report-summary"></div>
            <button class="export-btn" onclick="exportReport()"> Export Report (Copy to Clipboard)</button>
        </div>
    </div>

    <script>
        // ========== Quick Review System ==========
        const reviewCards = [
            { front: 'What are the three states of matter?', back: 'Solid, Liquid, and Gas' },
            { front: 'What is a good conductor of heat?', back: 'Metals (like copper, iron, aluminum)' },
            { front: 'How does light travel?', back: 'In straight lines' },
            { front: 'What do plants need for photosynthesis?', back: 'Sunlight, water, and carbon dioxide' },
            { front: 'What force pulls objects toward Earth?', back: 'Gravity' },
            { front: 'What is the basic unit of life?', back: 'Cell' },
            { front: 'What type of material blocks all light?', back: 'Opaque' },
            { front: 'What is friction?', back: 'A force that opposes motion between surfaces' },
            { front: 'Where does photosynthesis mainly occur?', back: 'In the leaves (chloroplasts)' },
            { front: 'Heat flows from...?', back: 'Hot objects to cold objects' }
        ];

        let reviewState = {
            currentIndex: 0,
            known: [],
            learning: [],
            deck: []
        };

        function openQuickReview() {
            document.getElementById('quick-review-modal').style.display = 'flex';
            // Shuffle cards
            reviewState.deck = [...reviewCards].sort(() => Math.random() - 0.5);
            reviewState.currentIndex = 0;
            reviewState.known = [];
            reviewState.learning = [];
            showReviewCard();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closeQuickReview() {
            document.getElementById('quick-review-modal').style.display = 'none';
        }

        function showReviewCard() {
            const card = reviewState.deck[reviewState.currentIndex];
            if (!card) {
                showReviewSummary();
                return;
            }

            document.getElementById('review-front').textContent = card.front;
            document.getElementById('review-back').textContent = card.back;
            document.getElementById('review-card').classList.remove('flipped');

            // Update progress dots
            const progress = document.getElementById('review-progress');
            progress.innerHTML = reviewState.deck.map((_, i) => {
                let classes = 'review-dot';
                if (i < reviewState.currentIndex) classes += ' done';
                if (i === reviewState.currentIndex) classes += ' current';
                return `<div class="${classes}"></div>`;
            }).join('');
        }

        function flipReviewCard() {
            document.getElementById('review-card').classList.toggle('flipped');
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function markAsKnown() {
            reviewState.known.push(reviewState.deck[reviewState.currentIndex]);
            reviewState.currentIndex++;
            showReviewCard();
            if (typeof playSound === 'function' && getSoundSetting('correct')) playSound('success');
        }

        function markAsLearning() {
            reviewState.learning.push(reviewState.deck[reviewState.currentIndex]);
            reviewState.currentIndex++;
            showReviewCard();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function showReviewSummary() {
            const total = reviewState.deck.length;
            const knownCount = reviewState.known.length;
            const percent = Math.round((knownCount / total) * 100);

            document.getElementById('review-card').innerHTML = `
                <div class="review-front" style="display:block;">
                    <div style="font-size:3rem;margin-bottom:20px;"></div>
                    <h3 style="color:#ec407a;margin-bottom:15px;">Review Complete!</h3>
                    <p style="color:#ddd;">You knew <strong>${knownCount}/${total}</strong> cards (${percent}%)</p>
                    <p style="color:#888;margin-top:10px;">${knownCount === total ? 'Perfect score! Amazing!' : 'Keep practicing the ones you\'re still learning!'}</p>
                </div>
            `;

            // Add XP for review
            const xpEarned = knownCount * 5;
            if (typeof addXP === 'function') addXP(xpEarned);

            document.querySelector('.review-controls').innerHTML = `
                <button class="review-btn know" onclick="openQuickReview()"> Review Again</button>
            `;
        }

        // ========== Answer Explanation System ==========
        const explanationDatabase = {
            'solid': 'Solids have a fixed shape because their particles are tightly packed and vibrate in place. They cannot be compressed easily.',
            'liquid': 'Liquids take the shape of their container because particles can slide past each other. They have a fixed volume.',
            'gas': 'Gases have no fixed shape or volume. Particles move freely and far apart, which is why gases can be compressed.',
            'conductor': 'Good conductors like metals have free electrons that quickly transfer heat energy from hot to cold regions.',
            'insulator': 'Insulators like wood and plastic have tightly bound electrons that resist heat flow, keeping things warm or cold.',
            'photosynthesis': 'Plants use chlorophyll to capture light energy. Carbon dioxide enters through stomata, water through roots. Glucose and oxygen are produced.',
            'gravity': 'Gravity is the force of attraction between masses. On Earth, it pulls everything toward the center at 9.8 m/s.',
            'friction': 'Friction occurs when surfaces rub together. It converts kinetic energy to heat and always opposes motion.',
            'light': 'Light is electromagnetic radiation. It travels at 300,000 km/s in a vacuum and slower through materials.',
            'opaque': 'Opaque materials absorb or reflect all light. No light passes through, creating shadows behind them.'
        };

        function showExplanation(keyword, container) {
            const key = keyword.toLowerCase();
            const explanation = explanationDatabase[key] || 'This concept relates to the fundamental principles of science. Understanding the key terms helps build a strong foundation.';

            const explanationDiv = document.createElement('div');
            explanationDiv.className = 'explanation-box show';
            explanationDiv.innerHTML = `
                <div class="explanation-title"> Why is this correct?</div>
                <div class="explanation-text">${explanation}</div>
            `;

            container.appendChild(explanationDiv);
        }

        // ========== Parent Report System ==========
        function openParentReport() {
            document.getElementById('report-modal').style.display = 'flex';
            generateReport();
            if (typeof playSound === 'function' && getSoundSetting('notify')) playSound('pop');
        }

        function closeParentReport() {
            document.getElementById('report-modal').style.display = 'none';
        }

        function generateReport() {
            const totalQuestions = parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0;
            const correctAnswers = parseInt(localStorage.getItem('totalCorrectAnswers')) || 0;
            const userXP = parseInt(localStorage.getItem('userXP')) || 0;
            const userLevel = parseInt(localStorage.getItem('userLevel')) || 1;
            const studyDaysArr = JSON.parse(localStorage.getItem('studyDays') || '[]');
            const currentStreakVal = parseInt(localStorage.getItem('currentStreak')) || 0;
            const longestStreakVal = parseInt(localStorage.getItem('longestStreak')) || 0;

            const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;

            // Get topic progress
            const topicProgressDataReport = JSON.parse(localStorage.getItem('topicProgress') || '{}');
            let topicHTML = '';
            Object.keys(topicProgressDataReport).forEach(topic => {
                const data = topicProgressDataReport[topic];
                const percent = data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0;
                topicHTML += `
                    <div class="report-stat-item">
                        <div class="report-stat-label">${topic.charAt(0).toUpperCase() + topic.slice(1)}</div>
                        <div class="report-stat-value">${percent}%</div>
                    </div>
                `;
            });

            const summaryDiv = document.getElementById('report-summary');
            summaryDiv.innerHTML = `
                <div class="report-section">
                    <div class="report-section-title"> Overall Progress</div>
                    <div class="report-stat-grid">
                        <div class="report-stat-item">
                            <div class="report-stat-label">Questions Answered</div>
                            <div class="report-stat-value">${totalQuestions}</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-label">Accuracy Rate</div>
                            <div class="report-stat-value">${accuracy}%</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-label">Experience Points</div>
                            <div class="report-stat-value">${userXP} XP</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-label">Current Level</div>
                            <div class="report-stat-value">Level ${userLevel}</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <div class="report-section-title"> Study Consistency</div>
                    <div class="report-stat-grid">
                        <div class="report-stat-item">
                            <div class="report-stat-label">Current Streak</div>
                            <div class="report-stat-value">${currentStreakVal} days</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-label">Longest Streak</div>
                            <div class="report-stat-value">${longestStreakVal} days</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-label">Total Study Days</div>
                            <div class="report-stat-value">${studyDaysArr.length}</div>
                        </div>
                    </div>
                </div>

                ${topicHTML ? `
                <div class="report-section">
                    <div class="report-section-title"> Topic Performance</div>
                    <div class="report-stat-grid">
                        ${topicHTML}
                    </div>
                </div>
                ` : ''}
            `;
        }

        function exportReport() {
            const totalQuestions = parseInt(localStorage.getItem('totalQuestionsAnswered')) || 0;
            const correctAnswers = parseInt(localStorage.getItem('totalCorrectAnswers')) || 0;
            const userXP = parseInt(localStorage.getItem('userXP')) || 0;
            const userLevel = parseInt(localStorage.getItem('userLevel')) || 1;
            const currentStreakVal = parseInt(localStorage.getItem('currentStreak')) || 0;
            const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;

            const reportText = `
Science CER Study Report
========================
Date: ${new Date().toLocaleDateString()}

OVERALL PROGRESS
- Questions Answered: ${totalQuestions}
- Correct Answers: ${correctAnswers}
- Accuracy Rate: ${accuracy}%
- Experience Points: ${userXP} XP
- Current Level: ${userLevel}
- Study Streak: ${currentStreakVal} days

This report was generated from the Science CER Practice App.
            `.trim();

            navigator.clipboard.writeText(reportText).then(() => {
                alert('Report copied to clipboard! You can paste it into an email or document.');
                if (typeof playSound === 'function' && getSoundSetting('correct')) playSound('success');
            }).catch(() => {
                alert('Could not copy to clipboard. Please try again.');
            });
        }

        console.log(' Quick Review, Answer Explanation, and Parent Report loaded!');
    </script>

    <!-- Batch 56: Timed Challenge, Learning Reminders, Science News -->
    <div id="timed-challenge-btn" class="timed-challenge-btn" onclick="openTimedChallenge()" title="Timed Challenge">
        
    </div>

    <div id="learning-reminder-btn" class="learning-reminder-btn" onclick="openLearningReminders()" title="Learning Reminders">
        
    </div>

    <div id="science-news-btn" class="science-news-btn" onclick="openScienceNews()" title="Science News">
        
    </div>

    <!-- Timed Challenge Modal -->
    <div id="timed-challenge-modal" class="timed-challenge-modal">
        <div class="timed-challenge-content">
            <div class="timed-challenge-header">
                <h2> Timed Challenge</h2>
                <button class="close-timed-challenge" onclick="closeTimedChallenge()"></button>
            </div>
            <div id="challenge-setup" class="challenge-setup">
                <h3>Choose Your Challenge</h3>
                <div class="challenge-options">
                    <div class="challenge-option" onclick="startChallenge(5, 60)">
                        <div class="challenge-icon"></div>
                        <div class="challenge-label">Quick Sprint</div>
                        <div class="challenge-desc">5 questions in 60 seconds</div>
                        <div class="challenge-reward">+50 XP</div>
                    </div>
                    <div class="challenge-option" onclick="startChallenge(10, 90)">
                        <div class="challenge-icon"></div>
                        <div class="challenge-label">Power Run</div>
                        <div class="challenge-desc">10 questions in 90 seconds</div>
                        <div class="challenge-reward">+100 XP</div>
                    </div>
                    <div class="challenge-option" onclick="startChallenge(15, 120)">
                        <div class="challenge-icon"></div>
                        <div class="challenge-label">Marathon</div>
                        <div class="challenge-desc">15 questions in 120 seconds</div>
                        <div class="challenge-reward">+200 XP</div>
                    </div>
                </div>
                <div class="challenge-stats">
                    <h4>Your Best Times</h4>
                    <div id="challenge-best-times"></div>
                </div>
            </div>
            <div id="challenge-active" class="challenge-active" style="display: none;">
                <div class="challenge-timer-bar">
                    <div id="challenge-timer-fill" class="challenge-timer-fill"></div>
                </div>
                <div class="challenge-timer-display">
                    <span id="challenge-time-left">60</span>s remaining
                </div>
                <div class="challenge-progress">
                    Question <span id="challenge-current">1</span> of <span id="challenge-total">5</span>
                </div>
                <div id="challenge-question" class="challenge-question"></div>
                <div id="challenge-options" class="challenge-options-grid"></div>
            </div>
            <div id="challenge-results" class="challenge-results" style="display: none;">
                <div class="results-icon"></div>
                <h3 id="results-title">Challenge Complete!</h3>
                <div class="results-stats">
                    <div class="result-stat">
                        <span class="stat-value" id="result-correct">0</span>
                        <span class="stat-label">Correct</span>
                    </div>
                    <div class="result-stat">
                        <span class="stat-value" id="result-time">0s</span>
                        <span class="stat-label">Time Used</span>
                    </div>
                    <div class="result-stat">
                        <span class="stat-value" id="result-xp">+0 XP</span>
                        <span class="stat-label">Earned</span>
                    </div>
                </div>
                <button class="challenge-retry-btn" onclick="showChallengeSetup()">Try Again</button>
            </div>
        </div>
    </div>

    <!-- Learning Reminders Modal -->
    <div id="learning-reminders-modal" class="learning-reminders-modal">
        <div class="learning-reminders-content">
            <div class="learning-reminders-header">
                <h2> Learning Reminders</h2>
                <button class="close-learning-reminders" onclick="closeLearningReminders()"></button>
            </div>
            <div class="reminders-body">
                <div class="reminder-toggle">
                    <label class="toggle-label">
                        <span>Enable Daily Reminders</span>
                        <input type="checkbox" id="reminder-enabled" onchange="toggleReminders()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="reminder-settings" id="reminder-settings">
                    <div class="reminder-time-setting">
                        <label>Reminder Time</label>
                        <input type="time" id="reminder-time" value="16:00" onchange="saveReminderSettings()">
                    </div>
                    <div class="reminder-days-setting">
                        <label>Reminder Days</label>
                        <div class="reminder-days">
                            <label class="day-checkbox"><input type="checkbox" data-day="0" checked><span>Sun</span></label>
                            <label class="day-checkbox"><input type="checkbox" data-day="1" checked><span>Mon</span></label>
                            <label class="day-checkbox"><input type="checkbox" data-day="2" checked><span>Tue</span></label>
                            <label class="day-checkbox"><input type="checkbox" data-day="3" checked><span>Wed</span></label>
                            <label class="day-checkbox"><input type="checkbox" data-day="4" checked><span>Thu</span></label>
                            <label class="day-checkbox"><input type="checkbox" data-day="5" checked><span>Fri</span></label>
                            <label class="day-checkbox"><input type="checkbox" data-day="6" checked><span>Sat</span></label>
                        </div>
                    </div>
                    <div class="reminder-message-setting">
                        <label>Reminder Message</label>
                        <select id="reminder-message" onchange="saveReminderSettings()">
                            <option value="study">Time to study science! </option>
                            <option value="practice">Practice makes perfect! </option>
                            <option value="challenge">Ready for a challenge? </option>
                            <option value="review">Time to review your notes! </option>
                        </select>
                    </div>
                </div>
                <div class="reminder-preview">
                    <h4>Next Reminder</h4>
                    <div id="next-reminder-display">Not scheduled</div>
                </div>
                <div class="reminder-history">
                    <h4>Recent Notifications</h4>
                    <div id="reminder-history-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Science News Modal -->
    <div id="science-news-modal" class="science-news-modal">
        <div class="science-news-content">
            <div class="science-news-header">
                <h2> Science News & Facts</h2>
                <button class="close-science-news" onclick="closeScienceNews()"></button>
            </div>
            <div class="news-body">
                <div class="news-tabs">
                    <button class="news-tab active" onclick="showNewsTab('daily')">Daily Fact</button>
                    <button class="news-tab" onclick="showNewsTab('explore')">Explore</button>
                    <button class="news-tab" onclick="showNewsTab('saved')">Saved</button>
                </div>
                <div id="news-daily" class="news-section">
                    <div class="daily-fact-card">
                        <div class="fact-category" id="daily-fact-category">Loading...</div>
                        <div class="fact-content" id="daily-fact-content"></div>
                        <div class="fact-actions">
                            <button class="fact-action" onclick="saveFact()"> Save</button>
                            <button class="fact-action" onclick="shareFact()"> Share</button>
                            <button class="fact-action" onclick="getNewFact()"> New Fact</button>
                        </div>
                    </div>
                    <div class="fact-streak">
                        <span class="streak-icon"></span>
                        <span id="fact-streak-count">0</span> day reading streak
                    </div>
                </div>
                <div id="news-explore" class="news-section" style="display: none;">
                    <div class="explore-categories">
                        <button class="explore-cat" onclick="exploreFacts('matter')"> Matter</button>
                        <button class="explore-cat" onclick="exploreFacts('energy')"> Energy</button>
                        <button class="explore-cat" onclick="exploreFacts('life')"> Life Science</button>
                        <button class="explore-cat" onclick="exploreFacts('space')"> Space</button>
                        <button class="explore-cat" onclick="exploreFacts('earth')"> Earth</button>
                    </div>
                    <div id="explore-facts-list" class="explore-facts-list"></div>
                </div>
                <div id="news-saved" class="news-section" style="display: none;">
                    <div id="saved-facts-list" class="saved-facts-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== BATCH 56: Timed Challenge, Learning Reminders, Science News =====

        // Timed Challenge Data
        const challengeQuestions = [
            { q: "What is the boiling point of water?", options: ["100C", "0C", "50C", "200C"], answer: 0 },
            { q: "What state is ice?", options: ["Gas", "Liquid", "Solid", "Plasma"], answer: 2 },
            { q: "Light travels in...", options: ["Curves", "Zigzags", "Straight lines", "Circles"], answer: 2 },
            { q: "What do plants need for photosynthesis?", options: ["Only water", "Sunlight, water, CO2", "Only air", "Darkness"], answer: 1 },
            { q: "Sound cannot travel through...", options: ["Air", "Water", "Vacuum", "Metal"], answer: 2 },
            { q: "What force pulls objects down?", options: ["Magnetism", "Friction", "Gravity", "Electricity"], answer: 2 },
            { q: "Which is a conductor?", options: ["Plastic", "Wood", "Copper", "Rubber"], answer: 2 },
            { q: "Evaporation changes liquid to...", options: ["Solid", "Gas", "Plasma", "Liquid"], answer: 1 },
            { q: "The Sun is a...", options: ["Planet", "Moon", "Star", "Asteroid"], answer: 2 },
            { q: "What organ pumps blood?", options: ["Brain", "Lungs", "Heart", "Liver"], answer: 2 },
            { q: "Melting point of ice is...", options: ["100C", "0C", "-10C", "50C"], answer: 1 },
            { q: "Which is transparent?", options: ["Wood", "Glass", "Metal", "Brick"], answer: 1 },
            { q: "Plants make their own...", options: ["Water", "Soil", "Food", "Air"], answer: 2 },
            { q: "What reflects light best?", options: ["Black paper", "Mirror", "Carpet", "Cloth"], answer: 1 },
            { q: "Condensation forms...", options: ["Ice", "Steam", "Water droplets", "Fog only"], answer: 2 },
            { q: "Friction creates...", options: ["Cold", "Heat", "Light", "Sound only"], answer: 1 },
            { q: "Which material is magnetic?", options: ["Aluminum", "Iron", "Gold", "Silver"], answer: 1 },
            { q: "Water vapor is...", options: ["Solid", "Liquid", "Gas", "Plasma"], answer: 2 },
            { q: "Which needs batteries?", options: ["Candle", "Torch", "Sun", "Fire"], answer: 1 },
            { q: "Roots absorb...", options: ["Light", "Water", "Air", "Heat"], answer: 1 }
        ];

        let challengeState = {
            active: false,
            questions: [],
            currentIndex: 0,
            totalQuestions: 0,
            timeLimit: 0,
            timeLeft: 0,
            startTime: 0,
            correct: 0,
            timer: null,
            xpReward: 0
        };

        // Science Facts Database
        const scienceFacts = {
            matter: [
                { fact: "Water is the only substance on Earth that naturally exists in all three states: solid (ice), liquid (water), and gas (steam).", icon: "" },
                { fact: "A diamond is the hardest natural substance on Earth, made entirely of carbon atoms.", icon: "" },
                { fact: "Glass is actually a liquid that flows very, very slowly - so slowly you can't see it!", icon: "" },
                { fact: "Honey never spoils! Archaeologists have found 3,000-year-old honey in Egyptian tombs that was still edible.", icon: "" },
                { fact: "Gold is so soft that a single gram can be beaten into a sheet covering one square meter.", icon: "" }
            ],
            energy: [
                { fact: "Lightning is five times hotter than the surface of the Sun!", icon: "" },
                { fact: "A single bolt of lightning contains enough energy to toast 100,000 slices of bread.", icon: "" },
                { fact: "The Sun produces more energy in one second than humanity has used in all of history.", icon: "" },
                { fact: "Sound travels about 4 times faster in water than in air.", icon: "" },
                { fact: "Light from the Sun takes about 8 minutes to reach Earth.", icon: "" }
            ],
            life: [
                { fact: "A human body contains enough iron to make a 3-inch nail.", icon: "" },
                { fact: "Octopuses have three hearts and blue blood!", icon: "" },
                { fact: "A single tree can absorb about 48 pounds of carbon dioxide per year.", icon: "" },
                { fact: "Your brain uses about 20% of your body's total energy.", icon: "" },
                { fact: "Butterflies taste with their feet!", icon: "" }
            ],
            space: [
                { fact: "A day on Venus is longer than its year! It takes 243 Earth days to rotate but only 225 to orbit the Sun.", icon: "" },
                { fact: "There are more stars in the universe than grains of sand on all of Earth's beaches.", icon: "" },
                { fact: "Footprints on the Moon will last for millions of years because there's no wind to blow them away.", icon: "" },
                { fact: "Jupiter is so big that all other planets could fit inside it!", icon: "" },
                { fact: "Neutron stars are so dense that a teaspoon would weigh about 6 billion tons.", icon: "" }
            ],
            earth: [
                { fact: "Earth's core is as hot as the surface of the Sun - about 5,500C!", icon: "" },
                { fact: "The deepest part of the ocean (Mariana Trench) is deeper than Mount Everest is tall.", icon: "" },
                { fact: "Rainbows are actually full circles, but we usually only see half from the ground.", icon: "" },
                { fact: "Antarctica contains about 70% of Earth's fresh water, frozen in ice.", icon: "" },
                { fact: "Earthquakes can make the Earth ring like a bell!", icon: "" }
            ]
        };

        const reminderMessages = {
            study: "Time to study science! ",
            practice: "Practice makes perfect! ",
            challenge: "Ready for a challenge? ",
            review: "Time to review your notes! "
        };

        // Timed Challenge Functions
        function openTimedChallenge() {
            document.getElementById('timed-challenge-modal').classList.add('active');
            showChallengeSetup();
            loadBestTimes();
        }

        function closeTimedChallenge() {
            document.getElementById('timed-challenge-modal').classList.remove('active');
            if (challengeState.timer) {
                clearInterval(challengeState.timer);
                challengeState.timer = null;
            }
            challengeState.active = false;
        }

        function showChallengeSetup() {
            document.getElementById('challenge-setup').style.display = 'block';
            document.getElementById('challenge-active').style.display = 'none';
            document.getElementById('challenge-results').style.display = 'none';
        }

        function loadBestTimes() {
            const bestTimes = JSON.parse(localStorage.getItem('challengeBestTimes') || '{}');
            const container = document.getElementById('challenge-best-times');

            const challenges = [
                { key: '5-60', label: 'Quick Sprint', icon: '' },
                { key: '10-90', label: 'Power Run', icon: '' },
                { key: '15-120', label: 'Marathon', icon: '' }
            ];

            container.innerHTML = challenges.map(c => {
                const best = bestTimes[c.key];
                return `<div class="best-time-item">
                    <span>${c.icon} ${c.label}</span>
                    <span>${best ? best.correct + '/' + best.total + ' in ' + best.time + 's' : 'Not attempted'}</span>
                </div>`;
            }).join('');
        }

        function startChallenge(numQuestions, timeLimit) {
            // Shuffle and select questions
            const shuffled = [...challengeQuestions].sort(() => Math.random() - 0.5);
            challengeState.questions = shuffled.slice(0, numQuestions);
            challengeState.totalQuestions = numQuestions;
            challengeState.timeLimit = timeLimit;
            challengeState.timeLeft = timeLimit;
            challengeState.currentIndex = 0;
            challengeState.correct = 0;
            challengeState.startTime = Date.now();
            challengeState.active = true;
            challengeState.xpReward = numQuestions === 5 ? 50 : numQuestions === 10 ? 100 : 200;

            document.getElementById('challenge-setup').style.display = 'none';
            document.getElementById('challenge-active').style.display = 'block';
            document.getElementById('challenge-results').style.display = 'none';

            document.getElementById('challenge-total').textContent = numQuestions;
            document.getElementById('challenge-time-left').textContent = timeLimit;

            showChallengeQuestion();
            startChallengeTimer();
        }

        function startChallengeTimer() {
            const timerFill = document.getElementById('challenge-timer-fill');
            timerFill.style.width = '100%';

            challengeState.timer = setInterval(() => {
                challengeState.timeLeft--;
                document.getElementById('challenge-time-left').textContent = challengeState.timeLeft;

                const percent = (challengeState.timeLeft / challengeState.timeLimit) * 100;
                timerFill.style.width = percent + '%';

                if (percent < 25) {
                    timerFill.style.background = 'linear-gradient(90deg, #e53935, #ff5252)';
                } else if (percent < 50) {
                    timerFill.style.background = 'linear-gradient(90deg, #fb8c00, #ffa726)';
                }

                if (challengeState.timeLeft <= 0) {
                    endChallenge();
                }
            }, 1000);
        }

        function showChallengeQuestion() {
            const q = challengeState.questions[challengeState.currentIndex];
            document.getElementById('challenge-current').textContent = challengeState.currentIndex + 1;
            document.getElementById('challenge-question').textContent = q.q;

            const optionsContainer = document.getElementById('challenge-options');
            optionsContainer.innerHTML = q.options.map((opt, i) =>
                `<button class="challenge-opt-btn" onclick="submitChallengeAnswer(${i})">${opt}</button>`
            ).join('');
        }

        function submitChallengeAnswer(answerIndex) {
            if (!challengeState.active) return;

            const q = challengeState.questions[challengeState.currentIndex];
            if (answerIndex === q.answer) {
                challengeState.correct++;
            }

            challengeState.currentIndex++;

            if (challengeState.currentIndex >= challengeState.totalQuestions) {
                endChallenge();
            } else {
                showChallengeQuestion();
            }
        }

        function endChallenge() {
            clearInterval(challengeState.timer);
            challengeState.timer = null;
            challengeState.active = false;

            const timeUsed = Math.round((Date.now() - challengeState.startTime) / 1000);
            const perfectBonus = challengeState.correct === challengeState.totalQuestions ? 50 : 0;
            const xpEarned = Math.round((challengeState.correct / challengeState.totalQuestions) * challengeState.xpReward) + perfectBonus;

            // Save best time
            const key = challengeState.totalQuestions + '-' + challengeState.timeLimit;
            const bestTimes = JSON.parse(localStorage.getItem('challengeBestTimes') || '{}');
            if (!bestTimes[key] || challengeState.correct > bestTimes[key].correct ||
                (challengeState.correct === bestTimes[key].correct && timeUsed < bestTimes[key].time)) {
                bestTimes[key] = {
                    correct: challengeState.correct,
                    total: challengeState.totalQuestions,
                    time: timeUsed
                };
                localStorage.setItem('challengeBestTimes', JSON.stringify(bestTimes));
            }

            // Update XP
            let totalXP = parseInt(localStorage.getItem('scienceXP') || '0');
            totalXP += xpEarned;
            localStorage.setItem('scienceXP', totalXP);

            // Show results
            document.getElementById('challenge-active').style.display = 'none';
            document.getElementById('challenge-results').style.display = 'block';

            document.getElementById('result-correct').textContent = challengeState.correct + '/' + challengeState.totalQuestions;
            document.getElementById('result-time').textContent = timeUsed + 's';
            document.getElementById('result-xp').textContent = '+' + xpEarned + ' XP';

            if (challengeState.correct === challengeState.totalQuestions) {
                document.getElementById('results-title').textContent = 'Perfect Score! ';
            } else if (challengeState.correct >= challengeState.totalQuestions * 0.8) {
                document.getElementById('results-title').textContent = 'Excellent Work! ';
            } else if (challengeState.correct >= challengeState.totalQuestions * 0.5) {
                document.getElementById('results-title').textContent = 'Good Effort! ';
            } else {
                document.getElementById('results-title').textContent = 'Keep Practicing! ';
            }
        }

        // Learning Reminders Functions
        function openLearningReminders() {
            document.getElementById('learning-reminders-modal').classList.add('active');
            loadReminderSettings();
            updateNextReminderDisplay();
            loadReminderHistory();
        }

        function closeLearningReminders() {
            document.getElementById('learning-reminders-modal').classList.remove('active');
        }

        function loadReminderSettings() {
            const settings = JSON.parse(localStorage.getItem('reminderSettings') || '{}');
            document.getElementById('reminder-enabled').checked = settings.enabled || false;
            document.getElementById('reminder-time').value = settings.time || '16:00';
            document.getElementById('reminder-message').value = settings.message || 'study';

            const days = settings.days || [0, 1, 2, 3, 4, 5, 6];
            document.querySelectorAll('.day-checkbox input').forEach(cb => {
                cb.checked = days.includes(parseInt(cb.dataset.day));
                cb.onchange = saveReminderSettings;
            });

            document.getElementById('reminder-settings').style.opacity = settings.enabled ? '1' : '0.5';
        }

        function toggleReminders() {
            const enabled = document.getElementById('reminder-enabled').checked;
            document.getElementById('reminder-settings').style.opacity = enabled ? '1' : '0.5';
            saveReminderSettings();

            if (enabled && 'Notification' in window) {
                Notification.requestPermission();
            }
        }

        function saveReminderSettings() {
            const days = [];
            document.querySelectorAll('.day-checkbox input:checked').forEach(cb => {
                days.push(parseInt(cb.dataset.day));
            });

            const settings = {
                enabled: document.getElementById('reminder-enabled').checked,
                time: document.getElementById('reminder-time').value,
                message: document.getElementById('reminder-message').value,
                days: days
            };

            localStorage.setItem('reminderSettings', JSON.stringify(settings));
            updateNextReminderDisplay();
            scheduleReminder();
        }

        function updateNextReminderDisplay() {
            const settings = JSON.parse(localStorage.getItem('reminderSettings') || '{}');
            const display = document.getElementById('next-reminder-display');

            if (!settings.enabled || !settings.days || settings.days.length === 0) {
                display.textContent = 'Not scheduled';
                display.className = '';
                return;
            }

            const now = new Date();
            const [hours, minutes] = settings.time.split(':').map(Number);

            for (let i = 0; i <= 7; i++) {
                const checkDate = new Date(now);
                checkDate.setDate(checkDate.getDate() + i);
                checkDate.setHours(hours, minutes, 0, 0);

                if (settings.days.includes(checkDate.getDay()) && checkDate > now) {
                    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    const dayName = i === 0 ? 'Today' : i === 1 ? 'Tomorrow' : dayNames[checkDate.getDay()];
                    display.textContent = dayName + ' at ' + settings.time;
                    display.className = 'scheduled';
                    return;
                }
            }

            display.textContent = 'Not scheduled';
        }

        function loadReminderHistory() {
            const history = JSON.parse(localStorage.getItem('reminderHistory') || '[]');
            const container = document.getElementById('reminder-history-list');

            if (history.length === 0) {
                container.innerHTML = '<div class="no-history">No reminders sent yet</div>';
                return;
            }

            container.innerHTML = history.slice(0, 5).map(item => `
                <div class="history-item">
                    <span class="history-time">${new Date(item.time).toLocaleDateString()}</span>
                    <span class="history-msg">${item.message}</span>
                </div>
            `).join('');
        }

        function scheduleReminder() {
            // Check reminders every minute
            if (window.reminderInterval) clearInterval(window.reminderInterval);

            window.reminderInterval = setInterval(() => {
                const settings = JSON.parse(localStorage.getItem('reminderSettings') || '{}');
                if (!settings.enabled) return;

                const now = new Date();
                const currentTime = now.getHours().toString().padStart(2, '0') + ':' +
                                   now.getMinutes().toString().padStart(2, '0');

                if (currentTime === settings.time && settings.days.includes(now.getDay())) {
                    const lastReminder = localStorage.getItem('lastReminderDate');
                    const today = now.toDateString();

                    if (lastReminder !== today) {
                        showReminder(settings.message);
                        localStorage.setItem('lastReminderDate', today);
                    }
                }
            }, 60000);
        }

        function showReminder(messageKey) {
            const message = reminderMessages[messageKey] || reminderMessages.study;

            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Science Learning Reminder', {
                    body: message,
                    icon: ''
                });
            }

            // Save to history
            const history = JSON.parse(localStorage.getItem('reminderHistory') || '[]');
            history.unshift({ time: Date.now(), message: message });
            localStorage.setItem('reminderHistory', JSON.stringify(history.slice(0, 20)));
        }

        // Science News Functions
        let currentFact = null;

        function openScienceNews() {
            document.getElementById('science-news-modal').classList.add('active');
            loadDailyFact();
            loadSavedFacts();
            updateFactStreak();
        }

        function closeScienceNews() {
            document.getElementById('science-news-modal').classList.remove('active');
        }

        function showNewsTab(tab) {
            document.querySelectorAll('.news-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.news-section').forEach(s => s.style.display = 'none');

            event.target.classList.add('active');
            document.getElementById('news-' + tab).style.display = 'block';
        }

        function loadDailyFact() {
            const today = new Date().toDateString();
            const savedDaily = JSON.parse(localStorage.getItem('dailyFact') || '{}');

            if (savedDaily.date === today && savedDaily.fact) {
                currentFact = savedDaily;
                displayFact(savedDaily.category, savedDaily.fact);
            } else {
                getNewFact();
            }

            // Update streak
            const lastVisit = localStorage.getItem('lastFactVisit');
            if (lastVisit !== today) {
                localStorage.setItem('lastFactVisit', today);

                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (lastVisit === yesterday.toDateString()) {
                    let streak = parseInt(localStorage.getItem('factStreak') || '0');
                    streak++;
                    localStorage.setItem('factStreak', streak);
                } else if (lastVisit !== today) {
                    localStorage.setItem('factStreak', '1');
                }
            }
            updateFactStreak();
        }

        function getNewFact() {
            const categories = Object.keys(scienceFacts);
            const randomCat = categories[Math.floor(Math.random() * categories.length)];
            const facts = scienceFacts[randomCat];
            const randomFact = facts[Math.floor(Math.random() * facts.length)];

            currentFact = {
                category: randomCat,
                fact: randomFact.fact,
                icon: randomFact.icon,
                date: new Date().toDateString()
            };

            localStorage.setItem('dailyFact', JSON.stringify(currentFact));
            displayFact(randomCat, randomFact.fact, randomFact.icon);
        }

        function displayFact(category, fact, icon) {
            const catNames = { matter: ' Matter', energy: ' Energy', life: ' Life Science', space: ' Space', earth: ' Earth Science' };
            document.getElementById('daily-fact-category').textContent = catNames[category] || category;
            document.getElementById('daily-fact-content').textContent = (icon || '') + ' ' + fact;
        }

        function updateFactStreak() {
            const streak = localStorage.getItem('factStreak') || '0';
            document.getElementById('fact-streak-count').textContent = streak;
        }

        function saveFact() {
            if (!currentFact) return;

            const saved = JSON.parse(localStorage.getItem('savedFacts') || '[]');
            const exists = saved.some(f => f.fact === currentFact.fact);

            if (!exists) {
                saved.unshift({
                    ...currentFact,
                    savedDate: Date.now()
                });
                localStorage.setItem('savedFacts', JSON.stringify(saved.slice(0, 50)));
                alert('Fact saved! ');
                loadSavedFacts();
            } else {
                alert('This fact is already saved!');
            }
        }

        function shareFact() {
            if (!currentFact) return;

            if (navigator.share) {
                navigator.share({
                    title: 'Science Fact',
                    text: currentFact.fact
                });
            } else {
                navigator.clipboard.writeText(currentFact.fact);
                alert('Fact copied to clipboard! ');
            }
        }

        function exploreFacts(category) {
            const facts = scienceFacts[category] || [];
            const container = document.getElementById('explore-facts-list');

            container.innerHTML = facts.map(f => `
                <div class="explore-fact-card">
                    <span class="explore-fact-icon">${f.icon}</span>
                    <p>${f.fact}</p>
                </div>
            `).join('');
        }

        function loadSavedFacts() {
            const saved = JSON.parse(localStorage.getItem('savedFacts') || '[]');
            const container = document.getElementById('saved-facts-list');

            if (saved.length === 0) {
                container.innerHTML = '<div class="no-saved">No saved facts yet. Save interesting facts to review later!</div>';
                return;
            }

            container.innerHTML = saved.map((f, i) => `
                <div class="saved-fact-card">
                    <p>${f.fact}</p>
                    <div class="saved-fact-actions">
                        <span class="saved-date">${new Date(f.savedDate).toLocaleDateString()}</span>
                        <button onclick="removeSavedFact(${i})"></button>
                    </div>
                </div>
            `).join('');
        }

        function removeSavedFact(index) {
            const saved = JSON.parse(localStorage.getItem('savedFacts') || '[]');
            saved.splice(index, 1);
            localStorage.setItem('savedFacts', JSON.stringify(saved));
            loadSavedFacts();
        }

        // Initialize on load
        scheduleReminder();

        console.log(' Timed Challenge, Learning Reminders, and Science News loaded!');
    </script>

    <!-- Batch 57: Learning Pathways, Word Scramble, Study Goals -->
    <div id="learning-pathways-btn" class="learning-pathways-btn" onclick="openLearningPathways()" title="Learning Pathways">
        
    </div>

    <div id="word-scramble-btn" class="word-scramble-btn" onclick="openWordScramble()" title="Word Scramble">
        
    </div>

    <div id="study-goals-btn" class="study-goals-btn" onclick="openStudyGoals()" title="Study Goals">
        
    </div>

    <!-- Learning Pathways Modal -->
    <div id="learning-pathways-modal" class="learning-pathways-modal">
        <div class="learning-pathways-content">
            <div class="learning-pathways-header">
                <h2> Learning Pathways</h2>
                <button class="close-learning-pathways" onclick="closeLearningPathways()"></button>
            </div>
            <div class="pathways-body">
                <p style="color: #666; margin-bottom: 20px;">Follow guided paths to master each topic step by step!</p>
                <div id="pathways-list"></div>
            </div>
        </div>
    </div>

    <!-- Word Scramble Modal -->
    <div id="word-scramble-modal" class="word-scramble-modal">
        <div class="word-scramble-content">
            <div class="word-scramble-header">
                <h2> Word Scramble</h2>
                <button class="close-word-scramble" onclick="closeWordScramble()"></button>
            </div>
            <div class="scramble-body">
                <div class="scramble-score">
                    <div class="score-item">
                        <div class="score-value" id="scramble-correct">0</div>
                        <div class="score-label">Correct</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value" id="scramble-streak">0</div>
                        <div class="score-label">Streak</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value" id="scramble-best">0</div>
                        <div class="score-label">Best</div>
                    </div>
                </div>
                <div class="scrambled-word" id="scrambled-display">LOADING</div>
                <div class="scramble-hint" id="scramble-hint">Hint will appear here</div>
                <div class="scramble-input-container">
                    <input type="text" class="scramble-input" id="scramble-answer" placeholder="Type your answer" autocomplete="off">
                </div>
                <div>
                    <button class="scramble-btn" onclick="checkScrambleAnswer()"> Check</button>
                    <button class="scramble-btn" onclick="skipScrambleWord()"> Skip</button>
                    <button class="scramble-btn" onclick="showScrambleHint()"> Hint (-5 XP)</button>
                </div>
                <div class="scramble-feedback" id="scramble-feedback" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Study Goals Modal -->
    <div id="study-goals-modal" class="study-goals-modal">
        <div class="study-goals-content">
            <div class="study-goals-header">
                <h2> Study Goals</h2>
                <button class="close-study-goals" onclick="closeStudyGoals()"></button>
            </div>
            <div class="goals-body">
                <div class="goal-setter">
                    <h4> Set a New Goal</h4>
                    <div class="goal-input-row">
                        <select id="goal-type">
                            <option value="daily">Daily Goal</option>
                            <option value="weekly">Weekly Goal</option>
                        </select>
                        <select id="goal-category">
                            <option value="questions">Answer Questions</option>
                            <option value="xp">Earn XP</option>
                            <option value="streak">Maintain Streak</option>
                            <option value="topics">Study Topics</option>
                        </select>
                    </div>
                    <div class="goal-input-row">
                        <input type="number" id="goal-target" placeholder="Target (e.g. 10)" min="1">
                        <button class="add-goal-btn" onclick="addStudyGoal()">Add Goal</button>
                    </div>
                </div>
                <div class="goals-summary" id="goals-summary">
                    <div class="summary-stat">
                        <div class="summary-value" id="goals-completed">0</div>
                        <div class="summary-label">Goals Completed</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-value" id="goals-active">0</div>
                        <div class="summary-label">Active Goals</div>
                    </div>
                </div>
                <div class="goals-list" id="goals-list"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== BATCH 57: Learning Pathways, Word Scramble, Study Goals =====

        // Learning Pathways Data
        const learningPathways = [
            {
                id: 'matter-basics',
                name: 'Matter Fundamentals',
                icon: '',
                description: 'Learn about states of matter and their properties',
                steps: [
                    { name: 'What is Matter?', completed: false },
                    { name: 'Three States of Matter', completed: false },
                    { name: 'Properties of Solids', completed: false },
                    { name: 'Properties of Liquids', completed: false },
                    { name: 'Properties of Gases', completed: false },
                    { name: 'Matter Quiz', completed: false }
                ]
            },
            {
                id: 'heat-energy',
                name: 'Heat & Temperature',
                icon: '',
                description: 'Understand heat transfer and temperature',
                steps: [
                    { name: 'What is Heat?', completed: false },
                    { name: 'Heat vs Temperature', completed: false },
                    { name: 'Conduction', completed: false },
                    { name: 'Convection', completed: false },
                    { name: 'Radiation', completed: false },
                    { name: 'Heat Quiz', completed: false }
                ]
            },
            {
                id: 'light-path',
                name: 'Light & Shadows',
                icon: '',
                description: 'Explore how light behaves and creates shadows',
                steps: [
                    { name: 'Sources of Light', completed: false },
                    { name: 'How Light Travels', completed: false },
                    { name: 'Reflection', completed: false },
                    { name: 'Shadows Formation', completed: false },
                    { name: 'Transparent & Opaque', completed: false },
                    { name: 'Light Quiz', completed: false }
                ]
            },
            {
                id: 'plants-life',
                name: 'Plant Life Cycle',
                icon: '',
                description: 'Discover how plants grow and reproduce',
                steps: [
                    { name: 'Parts of a Plant', completed: false },
                    { name: 'What Plants Need', completed: false },
                    { name: 'Photosynthesis Basics', completed: false },
                    { name: 'Seeds & Germination', completed: false },
                    { name: 'Plant Reproduction', completed: false },
                    { name: 'Plants Quiz', completed: false }
                ]
            },
            {
                id: 'forces-motion',
                name: 'Forces & Motion',
                icon: '',
                description: 'Learn about forces that make things move',
                steps: [
                    { name: 'What is a Force?', completed: false },
                    { name: 'Push and Pull', completed: false },
                    { name: 'Gravity', completed: false },
                    { name: 'Friction', completed: false },
                    { name: 'Balanced Forces', completed: false },
                    { name: 'Forces Quiz', completed: false }
                ]
            }
        ];

        // Word Scramble Data
        const scrambleWords = [
            { word: 'SOLID', hint: 'A state of matter with fixed shape' },
            { word: 'LIQUID', hint: 'A state of matter that flows' },
            { word: 'GAS', hint: 'A state of matter that fills containers' },
            { word: 'HEAT', hint: 'Energy that makes things warm' },
            { word: 'LIGHT', hint: 'Energy that helps us see' },
            { word: 'PLANT', hint: 'A living thing that makes food from sunlight' },
            { word: 'WATER', hint: 'H2O - essential for life' },
            { word: 'ENERGY', hint: 'The ability to do work' },
            { word: 'FORCE', hint: 'A push or pull' },
            { word: 'GRAVITY', hint: 'Force that pulls things down' },
            { word: 'FRICTION', hint: 'Force that slows things down' },
            { word: 'SHADOW', hint: 'Dark area blocked from light' },
            { word: 'MATTER', hint: 'Anything that has mass and takes up space' },
            { word: 'ATOM', hint: 'Tiny particle that makes up matter' },
            { word: 'MELTING', hint: 'Solid changing to liquid' },
            { word: 'BOILING', hint: 'Liquid changing to gas quickly' },
            { word: 'FREEZING', hint: 'Liquid changing to solid' },
            { word: 'SEED', hint: 'Where a new plant begins' },
            { word: 'ROOT', hint: 'Part of plant that absorbs water' },
            { word: 'LEAF', hint: 'Part of plant that makes food' }
        ];

        let scrambleState = {
            currentWord: null,
            correct: 0,
            streak: 0,
            best: 0,
            hintShown: false
        };

        // Learning Pathways Functions
        function openLearningPathways() {
            document.getElementById('learning-pathways-modal').classList.add('active');
            renderPathways();
        }

        function closeLearningPathways() {
            document.getElementById('learning-pathways-modal').classList.remove('active');
        }

        function renderPathways() {
            const savedProgress = JSON.parse(localStorage.getItem('pathwayProgress') || '{}');
            const container = document.getElementById('pathways-list');

            container.innerHTML = learningPathways.map(pathway => {
                const progress = savedProgress[pathway.id] || { completedSteps: [] };
                const completedCount = progress.completedSteps.length;
                const totalSteps = pathway.steps.length;
                const percent = Math.round((completedCount / totalSteps) * 100);
                const isCompleted = completedCount === totalSteps;

                return `
                    <div class="pathway-card ${isCompleted ? 'completed' : ''}" onclick="togglePathway('${pathway.id}')">
                        <div class="pathway-header">
                            <div class="pathway-icon">${pathway.icon}</div>
                            <div class="pathway-info">
                                <h4>${pathway.name} ${isCompleted ? '' : ''}</h4>
                                <p style="margin: 0; color: #666; font-size: 0.9rem;">${pathway.description}</p>
                            </div>
                        </div>
                        <div class="pathway-progress-bar">
                            <div class="pathway-progress-fill" style="width: ${percent}%"></div>
                        </div>
                        <small style="color: #666;">${completedCount}/${totalSteps} steps completed (${percent}%)</small>
                        <div class="pathway-steps" id="steps-${pathway.id}" style="display: none;">
                            ${pathway.steps.map((step, i) => {
                                const stepCompleted = progress.completedSteps.includes(i);
                                return `<div class="pathway-step">
                                    <span class="step-status">${stepCompleted ? '' : ''}</span>
                                    <span class="step-name">${step.name}</span>
                                    <button onclick="event.stopPropagation(); toggleStep('${pathway.id}', ${i})"
                                            style="padding: 5px 10px; border: none; border-radius: 10px;
                                                   background: ${stepCompleted ? '#ffcdd2' : '#c8e6c9'}; cursor: pointer;">
                                        ${stepCompleted ? 'Undo' : 'Complete'}
                                    </button>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function togglePathway(pathwayId) {
            const stepsEl = document.getElementById('steps-' + pathwayId);
            stepsEl.style.display = stepsEl.style.display === 'none' ? 'block' : 'none';
        }

        function toggleStep(pathwayId, stepIndex) {
            const savedProgress = JSON.parse(localStorage.getItem('pathwayProgress') || '{}');
            if (!savedProgress[pathwayId]) {
                savedProgress[pathwayId] = { completedSteps: [] };
            }

            const steps = savedProgress[pathwayId].completedSteps;
            const idx = steps.indexOf(stepIndex);

            if (idx === -1) {
                steps.push(stepIndex);
                // Award XP for completing a step
                let xp = parseInt(localStorage.getItem('scienceXP') || '0');
                xp += 15;
                localStorage.setItem('scienceXP', xp);
            } else {
                steps.splice(idx, 1);
            }

            localStorage.setItem('pathwayProgress', JSON.stringify(savedProgress));
            renderPathways();
        }

        // Word Scramble Functions
        function openWordScramble() {
            document.getElementById('word-scramble-modal').classList.add('active');
            loadScrambleStats();
            newScrambleWord();
        }

        function closeWordScramble() {
            document.getElementById('word-scramble-modal').classList.remove('active');
        }

        function loadScrambleStats() {
            const stats = JSON.parse(localStorage.getItem('scrambleStats') || '{}');
            scrambleState.correct = stats.correct || 0;
            scrambleState.best = stats.best || 0;
            scrambleState.streak = 0;

            document.getElementById('scramble-correct').textContent = scrambleState.correct;
            document.getElementById('scramble-best').textContent = scrambleState.best;
            document.getElementById('scramble-streak').textContent = scrambleState.streak;
        }

        function scrambleWord(word) {
            const arr = word.split('');
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            // Make sure it's actually scrambled
            if (arr.join('') === word && word.length > 1) {
                return scrambleWord(word);
            }
            return arr.join('');
        }

        function newScrambleWord() {
            const randomWord = scrambleWords[Math.floor(Math.random() * scrambleWords.length)];
            scrambleState.currentWord = randomWord;
            scrambleState.hintShown = false;

            document.getElementById('scrambled-display').textContent = scrambleWord(randomWord.word);
            document.getElementById('scramble-hint').textContent = 'Click "Hint" for help (-5 XP)';
            document.getElementById('scramble-answer').value = '';
            document.getElementById('scramble-feedback').style.display = 'none';
            document.getElementById('scramble-answer').focus();
        }

        function checkScrambleAnswer() {
            const answer = document.getElementById('scramble-answer').value.toUpperCase().trim();
            const feedback = document.getElementById('scramble-feedback');

            if (answer === scrambleState.currentWord.word) {
                feedback.textContent = ' Correct! +10 XP';
                feedback.className = 'scramble-feedback correct';
                scrambleState.correct++;
                scrambleState.streak++;

                if (scrambleState.streak > scrambleState.best) {
                    scrambleState.best = scrambleState.streak;
                }

                // Award XP
                let xp = parseInt(localStorage.getItem('scienceXP') || '0');
                xp += 10;
                localStorage.setItem('scienceXP', xp);

                // Save stats
                localStorage.setItem('scrambleStats', JSON.stringify({
                    correct: scrambleState.correct,
                    best: scrambleState.best
                }));

                document.getElementById('scramble-correct').textContent = scrambleState.correct;
                document.getElementById('scramble-streak').textContent = scrambleState.streak;
                document.getElementById('scramble-best').textContent = scrambleState.best;

                setTimeout(newScrambleWord, 1500);
            } else {
                feedback.textContent = ' Try again!';
                feedback.className = 'scramble-feedback incorrect';
                scrambleState.streak = 0;
                document.getElementById('scramble-streak').textContent = 0;
            }

            feedback.style.display = 'block';
        }

        function skipScrambleWord() {
            const feedback = document.getElementById('scramble-feedback');
            feedback.textContent = 'The answer was: ' + scrambleState.currentWord.word;
            feedback.className = 'scramble-feedback incorrect';
            feedback.style.display = 'block';
            scrambleState.streak = 0;
            document.getElementById('scramble-streak').textContent = 0;

            setTimeout(newScrambleWord, 2000);
        }

        function showScrambleHint() {
            if (!scrambleState.hintShown) {
                let xp = parseInt(localStorage.getItem('scienceXP') || '0');
                if (xp >= 5) {
                    xp -= 5;
                    localStorage.setItem('scienceXP', xp);
                    scrambleState.hintShown = true;
                }
            }
            document.getElementById('scramble-hint').textContent = ' ' + scrambleState.currentWord.hint;
        }

        // Enter key for scramble input
        document.addEventListener('DOMContentLoaded', function() {
            const scrambleInput = document.getElementById('scramble-answer');
            if (scrambleInput) {
                scrambleInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkScrambleAnswer();
                    }
                });
            }
        });

        // Study Goals Functions
        function openStudyGoals() {
            document.getElementById('study-goals-modal').classList.add('active');
            renderGoals();
            updateGoalsSummary();
        }

        function closeStudyGoals() {
            document.getElementById('study-goals-modal').classList.remove('active');
        }

        function addStudyGoal() {
            const type = document.getElementById('goal-type').value;
            const category = document.getElementById('goal-category').value;
            const target = parseInt(document.getElementById('goal-target').value);

            if (!target || target < 1) {
                alert('Please enter a valid target number');
                return;
            }

            const goals = JSON.parse(localStorage.getItem('studyGoals') || '[]');

            const categoryNames = {
                questions: 'Answer Questions',
                xp: 'Earn XP',
                streak: 'Maintain Streak Days',
                topics: 'Study Topics'
            };

            const newGoal = {
                id: Date.now(),
                type: type,
                category: category,
                categoryName: categoryNames[category],
                target: target,
                current: 0,
                createdAt: Date.now(),
                completed: false
            };

            goals.push(newGoal);
            localStorage.setItem('studyGoals', JSON.stringify(goals));

            document.getElementById('goal-target').value = '';
            renderGoals();
            updateGoalsSummary();
        }

        function renderGoals() {
            const goals = JSON.parse(localStorage.getItem('studyGoals') || '[]');
            const container = document.getElementById('goals-list');

            // Clean up old daily goals
            const now = new Date();
            const today = now.toDateString();

            const activeGoals = goals.filter(goal => {
                if (goal.type === 'daily') {
                    return new Date(goal.createdAt).toDateString() === today;
                }
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return new Date(goal.createdAt) > weekAgo;
            });

            localStorage.setItem('studyGoals', JSON.stringify(activeGoals));

            if (activeGoals.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No active goals. Set a goal above to get started!</p>';
                return;
            }

            container.innerHTML = activeGoals.map(goal => {
                const percent = Math.min(100, Math.round((goal.current / goal.target) * 100));
                const isCompleted = goal.current >= goal.target;

                return `
                    <div class="goal-card ${isCompleted ? 'completed' : ''}">
                        <div class="goal-card-header">
                            <span class="goal-type-badge ${goal.type}">${goal.type === 'daily' ? ' Daily' : ' Weekly'}</span>
                            <span class="goal-progress-text">${goal.current}/${goal.target}</span>
                        </div>
                        <div class="goal-description">${goal.categoryName}</div>
                        <div class="goal-progress-container">
                            <div class="goal-progress-bar" style="width: ${percent}%"></div>
                        </div>
                        <div class="goal-actions">
                            ${!isCompleted ? `<button class="goal-action-btn increment" onclick="incrementGoal(${goal.id})">+1 Progress</button>` : '<span style="color: #2e7d32; font-weight: bold;"> Completed!</span>'}
                            <button class="goal-action-btn delete" onclick="deleteGoal(${goal.id})"> Remove</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function incrementGoal(goalId) {
            const goals = JSON.parse(localStorage.getItem('studyGoals') || '[]');
            const goal = goals.find(g => g.id === goalId);

            if (goal && goal.current < goal.target) {
                goal.current++;

                if (goal.current >= goal.target && !goal.completed) {
                    goal.completed = true;
                    // Award XP for completing a goal
                    let xp = parseInt(localStorage.getItem('scienceXP') || '0');
                    xp += goal.type === 'daily' ? 25 : 100;
                    localStorage.setItem('scienceXP', xp);
                    alert(' Goal completed! +' + (goal.type === 'daily' ? 25 : 100) + ' XP');
                }

                localStorage.setItem('studyGoals', JSON.stringify(goals));
                renderGoals();
                updateGoalsSummary();
            }
        }

        function deleteGoal(goalId) {
            let goals = JSON.parse(localStorage.getItem('studyGoals') || '[]');
            goals = goals.filter(g => g.id !== goalId);
            localStorage.setItem('studyGoals', JSON.stringify(goals));
            renderGoals();
            updateGoalsSummary();
        }

        function updateGoalsSummary() {
            const goals = JSON.parse(localStorage.getItem('studyGoals') || '[]');
            const completedCount = goals.filter(g => g.completed).length;
            const activeCount = goals.filter(g => !g.completed).length;

            document.getElementById('goals-completed').textContent = completedCount;
            document.getElementById('goals-active').textContent = activeCount;
        }

        console.log(' Learning Pathways, Word Scramble, and Study Goals loaded!');
    </script>

    <!-- Batch 58: Fill-in-Blank, Topic Summary, Study Timer -->
    <div id="fill-blank-btn" class="fill-blank-btn" onclick="openFillBlank()" title="Fill in the Blank">
        
    </div>

    <div id="topic-summary-btn" class="topic-summary-btn" onclick="openTopicSummary()" title="Topic Summary">
        
    </div>

    <div id="study-timer-btn" class="study-timer-btn" onclick="openStudyTimer()" title="Study Timer">
        
    </div>

    <!-- Fill-in-Blank Modal -->
    <div id="fill-blank-modal" class="fill-blank-modal">
        <div class="fill-blank-content">
            <div class="fill-blank-header">
                <h2> Fill in the Blank</h2>
                <button class="close-fill-blank" onclick="closeFillBlank()"></button>
            </div>
            <div class="fill-blank-body">
                <div class="fill-blank-score">
                    <div class="score-item">
                        <div class="score-value" id="blank-correct">0</div>
                        <div class="score-label">Correct</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value" id="blank-total">0</div>
                        <div class="score-label">Attempted</div>
                    </div>
                </div>
                <div class="blank-sentence" id="blank-sentence">Loading...</div>
                <div class="fill-blank-actions">
                    <button class="fill-blank-btn-action" onclick="checkBlankAnswer()"> Check Answer</button>
                    <button class="fill-blank-btn-action" onclick="skipBlankQuestion()"> Skip</button>
                </div>
                <div class="fill-blank-feedback" id="blank-feedback" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Topic Summary Modal -->
    <div id="topic-summary-modal" class="topic-summary-modal">
        <div class="topic-summary-content">
            <div class="topic-summary-header">
                <h2> Topic Summaries</h2>
                <button class="close-topic-summary" onclick="closeTopicSummary()"></button>
            </div>
            <div class="summary-body">
                <div class="summary-tabs" id="summary-tabs"></div>
                <div class="summary-card" id="summary-content"></div>
            </div>
        </div>
    </div>

    <!-- Study Timer Modal -->
    <div id="study-timer-modal" class="study-timer-modal">
        <div class="study-timer-content">
            <div class="study-timer-header">
                <h2> Study Timer</h2>
                <button class="close-study-timer" onclick="closeStudyTimer()"></button>
            </div>
            <div class="timer-body">
                <div class="timer-display" id="timer-display">25:00</div>
                <div class="timer-label" id="timer-label">Focus Time</div>
                <div class="timer-presets">
                    <button class="timer-preset active" onclick="setTimerPreset(25)">25 min</button>
                    <button class="timer-preset" onclick="setTimerPreset(15)">15 min</button>
                    <button class="timer-preset" onclick="setTimerPreset(10)">10 min</button>
                    <button class="timer-preset" onclick="setTimerPreset(5)">5 min</button>
                </div>
                <div class="timer-controls">
                    <button class="timer-control-btn start" id="timer-start-btn" onclick="toggleTimer()"></button>
                    <button class="timer-control-btn reset" onclick="resetTimer()"></button>
                </div>
                <div class="timer-stats">
                    <div class="timer-stat-item">
                        <span>Sessions Today:</span>
                        <span id="timer-sessions">0</span>
                    </div>
                    <div class="timer-stat-item">
                        <span>Total Focus Time:</span>
                        <span id="timer-focus-time">0 min</span>
                    </div>
                    <div class="timer-stat-item">
                        <span>XP Earned:</span>
                        <span class="timer-xp-earned" id="timer-xp">+0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== BATCH 58: Fill-in-Blank, Topic Summary, Study Timer =====

        // Fill-in-Blank Questions
        const fillBlankQuestions = [
            { sentence: "Water boils at ___ degrees Celsius.", answer: "100", hint: "Temperature" },
            { sentence: "A ___ has a fixed shape and volume.", answer: "solid", hint: "State of matter" },
            { sentence: "Plants make food through ___.", answer: "photosynthesis", hint: "Process" },
            { sentence: "Light travels in ___ lines.", answer: "straight", hint: "Direction" },
            { sentence: "___ is the force that pulls objects toward Earth.", answer: "gravity", hint: "Force" },
            { sentence: "Water freezes at ___ degrees Celsius.", answer: "0", hint: "Temperature" },
            { sentence: "A ___ allows light to pass through completely.", answer: "transparent", hint: "Material property" },
            { sentence: "Heat transfers through metal by ___.", answer: "conduction", hint: "Heat transfer" },
            { sentence: "Plants need ___, water, and carbon dioxide for photosynthesis.", answer: "sunlight", hint: "Energy source" },
            { sentence: "The ___ is the part of a plant that absorbs water.", answer: "root", hint: "Plant part" },
            { sentence: "___ is when a liquid changes to gas.", answer: "evaporation", hint: "Process" },
            { sentence: "A shadow is formed when light is ___.", answer: "blocked", hint: "Prevented" },
            { sentence: "Gas particles move ___ and spread out.", answer: "freely", hint: "Movement" },
            { sentence: "___ slows down moving objects.", answer: "friction", hint: "Force" },
            { sentence: "Metals are good ___ of heat and electricity.", answer: "conductors", hint: "Property" }
        ];

        // Topic Summaries
        const topicSummaries = {
            matter: {
                title: ' Matter',
                points: [
                    { icon: '', text: 'Matter is anything that has mass and takes up space' },
                    { icon: '', text: 'Solids have fixed shape and volume' },
                    { icon: '', text: 'Liquids have fixed volume but take the shape of their container' },
                    { icon: '', text: 'Gases have no fixed shape or volume - they spread out' },
                    { icon: '', text: 'Matter can change states when heated or cooled' }
                ]
            },
            heat: {
                title: ' Heat',
                points: [
                    { icon: '', text: 'Heat is a form of energy that flows from hot to cold' },
                    { icon: '', text: 'Conduction: Heat transfers through direct contact' },
                    { icon: '', text: 'Convection: Heat transfers through fluid movement' },
                    { icon: '', text: 'Radiation: Heat transfers through waves (like sunlight)' },
                    { icon: '', text: 'Insulators slow down heat transfer (wood, plastic)' }
                ]
            },
            light: {
                title: ' Light',
                points: [
                    { icon: '', text: 'Light travels in straight lines' },
                    { icon: '', text: 'Transparent materials let all light through' },
                    { icon: '', text: 'Translucent materials let some light through' },
                    { icon: '', text: 'Opaque materials block all light' },
                    { icon: '', text: 'Shadows form when light is blocked by opaque objects' }
                ]
            },
            plants: {
                title: ' Plants',
                points: [
                    { icon: '', text: 'Plants are living things that make their own food' },
                    { icon: '', text: 'Photosynthesis: Plants use sunlight, water, and CO2 to make food' },
                    { icon: '', text: 'Roots absorb water, stems transport, leaves make food' },
                    { icon: '', text: 'Flowers help plants reproduce through seeds' },
                    { icon: '', text: 'Seeds germinate when given water, warmth, and air' }
                ]
            },
            forces: {
                title: ' Forces',
                points: [
                    { icon: '', text: 'A force is a push or pull that can change motion' },
                    { icon: '', text: 'Gravity pulls objects toward Earth' },
                    { icon: '', text: 'Friction opposes motion between surfaces' },
                    { icon: '', text: 'Balanced forces = no change in motion' },
                    { icon: '', text: 'Unbalanced forces cause objects to speed up, slow down, or change direction' }
                ]
            }
        };

        let blankState = {
            currentQuestion: null,
            correct: 0,
            total: 0
        };

        let timerState = {
            running: false,
            seconds: 25 * 60,
            preset: 25,
            interval: null,
            sessionsToday: 0,
            totalMinutes: 0,
            xpEarned: 0
        };

        // Fill-in-Blank Functions
        function openFillBlank() {
            document.getElementById('fill-blank-modal').classList.add('active');
            loadBlankStats();
            newBlankQuestion();
        }

        function closeFillBlank() {
            document.getElementById('fill-blank-modal').classList.remove('active');
        }

        function loadBlankStats() {
            const stats = JSON.parse(localStorage.getItem('fillBlankStats') || '{}');
            blankState.correct = stats.correct || 0;
            blankState.total = stats.total || 0;
            document.getElementById('blank-correct').textContent = blankState.correct;
            document.getElementById('blank-total').textContent = blankState.total;
        }

        function newBlankQuestion() {
            const q = fillBlankQuestions[Math.floor(Math.random() * fillBlankQuestions.length)];
            blankState.currentQuestion = q;

            const parts = q.sentence.split('___');
            const html = parts[0] + '<input type="text" class="blank-input" id="blank-answer" placeholder="?" autocomplete="off">' + parts[1];
            document.getElementById('blank-sentence').innerHTML = html;
            document.getElementById('blank-feedback').style.display = 'none';

            setTimeout(() => {
                const input = document.getElementById('blank-answer');
                if (input) {
                    input.focus();
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') checkBlankAnswer();
                    });
                }
            }, 100);
        }

        function checkBlankAnswer() {
            const input = document.getElementById('blank-answer');
            const answer = input.value.toLowerCase().trim();
            const correct = blankState.currentQuestion.answer.toLowerCase();
            const feedback = document.getElementById('blank-feedback');

            blankState.total++;

            if (answer === correct) {
                blankState.correct++;
                feedback.textContent = ' Correct! +10 XP';
                feedback.style.background = '#c8e6c9';
                feedback.style.color = '#2e7d32';

                let xp = parseInt(localStorage.getItem('scienceXP') || '0');
                xp += 10;
                localStorage.setItem('scienceXP', xp);

                setTimeout(newBlankQuestion, 1500);
            } else {
                feedback.textContent = ' The answer was: ' + blankState.currentQuestion.answer;
                feedback.style.background = '#ffcdd2';
                feedback.style.color = '#c62828';

                setTimeout(newBlankQuestion, 2500);
            }

            feedback.style.display = 'block';
            document.getElementById('blank-correct').textContent = blankState.correct;
            document.getElementById('blank-total').textContent = blankState.total;

            localStorage.setItem('fillBlankStats', JSON.stringify({
                correct: blankState.correct,
                total: blankState.total
            }));
        }

        function skipBlankQuestion() {
            const feedback = document.getElementById('blank-feedback');
            feedback.textContent = 'Skipped. Answer: ' + blankState.currentQuestion.answer;
            feedback.style.background = '#fff3e0';
            feedback.style.color = '#e65100';
            feedback.style.display = 'block';

            setTimeout(newBlankQuestion, 2000);
        }

        // Topic Summary Functions
        function openTopicSummary() {
            document.getElementById('topic-summary-modal').classList.add('active');
            renderSummaryTabs();
            showSummary('matter');
        }

        function closeTopicSummary() {
            document.getElementById('topic-summary-modal').classList.remove('active');
        }

        function renderSummaryTabs() {
            const tabs = document.getElementById('summary-tabs');
            tabs.innerHTML = Object.keys(topicSummaries).map(key => {
                const topic = topicSummaries[key];
                return `<button class="summary-tab ${key === 'matter' ? 'active' : ''}"
                                onclick="showSummary('${key}')">${topic.title}</button>`;
            }).join('');
        }

        function showSummary(topicKey) {
            const topic = topicSummaries[topicKey];
            const content = document.getElementById('summary-content');

            document.querySelectorAll('.summary-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.includes(topic.title.substring(2))) {
                    tab.classList.add('active');
                }
            });

            content.innerHTML = `
                <h3>${topic.title}</h3>
                <ul class="summary-points">
                    ${topic.points.map(p => `
                        <li>
                            <span class="summary-icon">${p.icon}</span>
                            <span>${p.text}</span>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        // Study Timer Functions
        function openStudyTimer() {
            document.getElementById('study-timer-modal').classList.add('active');
            loadTimerStats();
            updateTimerDisplay();
        }

        function closeStudyTimer() {
            document.getElementById('study-timer-modal').classList.remove('active');
        }

        function loadTimerStats() {
            const today = new Date().toDateString();
            const stats = JSON.parse(localStorage.getItem('timerStats') || '{}');

            if (stats.date === today) {
                timerState.sessionsToday = stats.sessions || 0;
                timerState.totalMinutes = stats.minutes || 0;
                timerState.xpEarned = stats.xp || 0;
            } else {
                timerState.sessionsToday = 0;
                timerState.totalMinutes = 0;
                timerState.xpEarned = 0;
            }

            updateTimerStats();
        }

        function setTimerPreset(minutes) {
            if (timerState.running) return;

            timerState.preset = minutes;
            timerState.seconds = minutes * 60;
            updateTimerDisplay();

            document.querySelectorAll('.timer-preset').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(minutes + ' min')) {
                    btn.classList.add('active');
                }
            });
        }

        function updateTimerDisplay() {
            const mins = Math.floor(timerState.seconds / 60);
            const secs = timerState.seconds % 60;
            document.getElementById('timer-display').textContent =
                mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
        }

        function toggleTimer() {
            if (timerState.running) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            timerState.running = true;
            document.getElementById('timer-start-btn').textContent = '';
            document.getElementById('timer-start-btn').classList.remove('start');
            document.getElementById('timer-start-btn').classList.add('pause');
            document.getElementById('timer-label').textContent = 'Focus Time - Keep Going!';

            timerState.interval = setInterval(() => {
                timerState.seconds--;
                updateTimerDisplay();

                if (timerState.seconds <= 0) {
                    completeSession();
                }
            }, 1000);
        }

        function pauseTimer() {
            timerState.running = false;
            clearInterval(timerState.interval);
            document.getElementById('timer-start-btn').textContent = '';
            document.getElementById('timer-start-btn').classList.remove('pause');
            document.getElementById('timer-start-btn').classList.add('start');
            document.getElementById('timer-label').textContent = 'Paused';
        }

        function resetTimer() {
            pauseTimer();
            timerState.seconds = timerState.preset * 60;
            updateTimerDisplay();
            document.getElementById('timer-label').textContent = 'Focus Time';
        }

        function completeSession() {
            pauseTimer();

            // Award XP based on session length
            const xpAward = timerState.preset >= 25 ? 50 : timerState.preset >= 15 ? 30 : 20;
            timerState.sessionsToday++;
            timerState.totalMinutes += timerState.preset;
            timerState.xpEarned += xpAward;

            let xp = parseInt(localStorage.getItem('scienceXP') || '0');
            xp += xpAward;
            localStorage.setItem('scienceXP', xp);

            saveTimerStats();
            updateTimerStats();

            document.getElementById('timer-label').textContent = ' Session Complete! +' + xpAward + ' XP';
            timerState.seconds = timerState.preset * 60;
            updateTimerDisplay();

            // Notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Study Session Complete!', {
                    body: 'Great job! You earned +' + xpAward + ' XP',
                    icon: ''
                });
            }
        }

        function saveTimerStats() {
            localStorage.setItem('timerStats', JSON.stringify({
                date: new Date().toDateString(),
                sessions: timerState.sessionsToday,
                minutes: timerState.totalMinutes,
                xp: timerState.xpEarned
            }));
        }

        function updateTimerStats() {
            document.getElementById('timer-sessions').textContent = timerState.sessionsToday;
            document.getElementById('timer-focus-time').textContent = timerState.totalMinutes + ' min';
            document.getElementById('timer-xp').textContent = '+' + timerState.xpEarned;
        }

        console.log(' Fill-in-Blank, Topic Summary, and Study Timer loaded!');
    </script>

    <!-- Batch 59: Memory Game, Experiment Lab, Quiz Battle -->
    <div id="memory-game-btn" class="memory-game-btn" onclick="openMemoryGame()" title="Memory Game">
        
    </div>

    <div id="experiment-lab-btn" class="experiment-lab-btn" onclick="openExperimentLab()" title="Experiment Lab">
        
    </div>

    <div id="quiz-battle-btn" class="quiz-battle-btn" onclick="openQuizBattle()" title="Quiz Battle">
        
    </div>

    <!-- Memory Game Modal -->
    <div id="memory-game-modal" class="memory-game-modal">
        <div class="memory-game-content">
            <div class="memory-game-header">
                <h2> Memory Match</h2>
                <button class="close-memory-game" onclick="closeMemoryGame()"></button>
            </div>
            <div class="memory-body">
                <div class="memory-stats">
                    <div class="score-item">
                        <div class="score-value" id="memory-moves">0</div>
                        <div class="score-label">Moves</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value" id="memory-pairs">0/8</div>
                        <div class="score-label">Pairs</div>
                    </div>
                </div>
                <div class="memory-grid" id="memory-grid"></div>
                <button class="start-battle-btn" style="margin-top: 15px; width: 100%;" onclick="startMemoryGame()"> New Game</button>
            </div>
        </div>
    </div>

    <!-- Experiment Lab Modal -->
    <div id="experiment-lab-modal" class="experiment-lab-modal">
        <div class="experiment-lab-content">
            <div class="experiment-lab-header">
                <h2> Experiment Lab</h2>
                <button class="close-experiment-lab" onclick="closeExperimentLab()"></button>
            </div>
            <div class="experiment-body">
                <div id="experiment-list" class="experiment-list"></div>
                <div id="experiment-detail" class="experiment-detail"></div>
            </div>
        </div>
    </div>

    <!-- Quiz Battle Modal -->
    <div id="quiz-battle-modal" class="quiz-battle-modal">
        <div class="quiz-battle-content">
            <div class="quiz-battle-header">
                <h2> Quiz Battle</h2>
                <button class="close-quiz-battle" onclick="closeQuizBattle()"></button>
            </div>
            <div class="battle-body">
                <div id="battle-setup" class="battle-setup" style="text-align: center; padding: 30px;">
                    <p style="font-size: 1.1rem; margin-bottom: 20px;">Battle against the Science Bot! Answer quickly and correctly to win!</p>
                    <button class="start-battle-btn" onclick="startQuizBattle()"> Start Battle!</button>
                </div>
                <div id="battle-game" style="display: none;">
                    <div class="battle-scoreboard">
                        <div class="battle-player">
                            <div class="battle-player-icon"></div>
                            <div>You</div>
                            <div class="battle-player-score" id="player-score">0</div>
                        </div>
                        <div class="battle-vs">VS</div>
                        <div class="battle-player">
                            <div class="battle-player-icon"></div>
                            <div>Bot</div>
                            <div class="battle-player-score" id="bot-score">0</div>
                        </div>
                    </div>
                    <div class="battle-question" id="battle-question-area"></div>
                </div>
                <div id="battle-result" class="battle-result" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== BATCH 59: Memory Game, Experiment Lab, Quiz Battle =====

        // Memory Game Pairs (science concepts)
        const memoryPairs = [
            { id: 1, content: '', match: 'Solid' },
            { id: 2, content: '', match: 'Liquid' },
            { id: 3, content: '', match: 'Gas' },
            { id: 4, content: '', match: 'Light' },
            { id: 5, content: '', match: 'Heat' },
            { id: 6, content: '', match: 'Plant' },
            { id: 7, content: '', match: 'Gravity' },
            { id: 8, content: '', match: 'Friction' }
        ];

        let memoryState = {
            cards: [],
            flipped: [],
            matched: [],
            moves: 0
        };

        // Experiments Data
        const experiments = [
            {
                id: 1,
                title: 'Rainbow in a Glass',
                icon: '',
                desc: 'Create a colorful density tower',
                materials: ['Honey', 'Corn syrup', 'Dish soap', 'Water', 'Oil'],
                steps: ['Pour honey into the glass first', 'Slowly add corn syrup', 'Add dish soap carefully', 'Pour water down the side', 'Finally add oil on top'],
                result: 'The liquids stack because they have different densities! Heavier liquids sink to the bottom.'
            },
            {
                id: 2,
                title: 'Dancing Raisins',
                icon: '',
                desc: 'Watch raisins dance up and down',
                materials: ['Clear soda', 'Raisins', 'Tall glass'],
                steps: ['Fill the glass with soda', 'Drop 5-6 raisins into the glass', 'Wait and watch what happens'],
                result: 'CO2 bubbles attach to raisins and lift them up. At the surface, bubbles pop and raisins sink!'
            },
            {
                id: 3,
                title: 'Invisible Ink',
                icon: '',
                desc: 'Write secret messages',
                materials: ['Lemon juice', 'Water', 'Cotton swab', 'Paper', 'Lamp or iron'],
                steps: ['Mix lemon juice with a little water', 'Dip cotton swab in the mixture', 'Write a message on paper', 'Let it dry completely', 'Hold near a warm lamp to reveal'],
                result: 'Heat causes the lemon juice to oxidize and turn brown, making your message visible!'
            },
            {
                id: 4,
                title: 'Balloon Rocket',
                icon: '',
                desc: 'Launch a balloon across the room',
                materials: ['Balloon', 'String', 'Straw', 'Tape'],
                steps: ['Thread string through the straw', 'Tie string across the room', 'Blow up balloon (don\'t tie it)', 'Tape balloon to straw', 'Let go and watch it fly!'],
                result: 'Air rushing out pushes the balloon forward - this is Newton\'s Third Law of Motion!'
            },
            {
                id: 5,
                title: 'Grow Crystals',
                icon: '',
                desc: 'Make your own crystals',
                materials: ['Hot water', 'Sugar or salt', 'String', 'Pencil', 'Jar'],
                steps: ['Dissolve lots of sugar in hot water', 'Tie string to pencil', 'Lower string into solution', 'Place in a safe spot', 'Wait several days'],
                result: 'As water evaporates, sugar molecules join together to form beautiful crystals!'
            }
        ];

        // Quiz Battle Questions
        const battleQuestions = [
            { q: "What state of matter has no fixed shape or volume?", options: ["Solid", "Liquid", "Gas", "Plasma"], answer: 2 },
            { q: "What do plants need for photosynthesis?", options: ["Darkness", "Cold", "Sunlight", "Ice"], answer: 2 },
            { q: "What force keeps us on the ground?", options: ["Friction", "Magnetism", "Gravity", "Wind"], answer: 2 },
            { q: "What transfers heat through direct contact?", options: ["Radiation", "Conduction", "Convection", "Reflection"], answer: 1 },
            { q: "What material lets light pass through?", options: ["Opaque", "Transparent", "Black", "Wood"], answer: 1 },
            { q: "What is the boiling point of water?", options: ["50C", "0C", "100C", "200C"], answer: 2 },
            { q: "What part of a plant absorbs water?", options: ["Leaves", "Flowers", "Roots", "Stems"], answer: 2 },
            { q: "What slows down moving objects?", options: ["Gravity", "Friction", "Light", "Sound"], answer: 1 },
            { q: "What is ice?", options: ["Liquid water", "Gas water", "Solid water", "Plasma"], answer: 2 },
            { q: "What do shadows need to form?", options: ["Wind", "Water", "Light blocked", "Heat"], answer: 2 }
        ];

        let battleState = {
            playerScore: 0,
            botScore: 0,
            currentQuestion: 0,
            questions: [],
            answered: false
        };

        // Memory Game Functions
        function openMemoryGame() {
            document.getElementById('memory-game-modal').classList.add('active');
            startMemoryGame();
        }

        function closeMemoryGame() {
            document.getElementById('memory-game-modal').classList.remove('active');
        }

        function startMemoryGame() {
            memoryState = { cards: [], flipped: [], matched: [], moves: 0 };

            // Create card pairs
            const cards = [];
            memoryPairs.forEach(pair => {
                cards.push({ id: pair.id, type: 'icon', content: pair.content, pairId: pair.id });
                cards.push({ id: pair.id + 100, type: 'text', content: pair.match, pairId: pair.id });
            });

            // Shuffle
            memoryState.cards = cards.sort(() => Math.random() - 0.5);

            renderMemoryGrid();
            updateMemoryStats();
        }

        function renderMemoryGrid() {
            const grid = document.getElementById('memory-grid');
            grid.innerHTML = memoryState.cards.map((card, i) => `
                <div class="memory-card ${memoryState.matched.includes(card.pairId) ? 'matched' : ''}"
                     data-index="${i}" onclick="flipMemoryCard(${i})">
                    <span class="memory-card-back">${memoryState.flipped.includes(i) || memoryState.matched.includes(card.pairId) ? card.content : '?'}</span>
                </div>
            `).join('');
        }

        function flipMemoryCard(index) {
            if (memoryState.flipped.length >= 2) return;
            if (memoryState.flipped.includes(index)) return;
            if (memoryState.matched.includes(memoryState.cards[index].pairId)) return;

            memoryState.flipped.push(index);
            renderMemoryGrid();

            if (memoryState.flipped.length === 2) {
                memoryState.moves++;
                updateMemoryStats();

                const card1 = memoryState.cards[memoryState.flipped[0]];
                const card2 = memoryState.cards[memoryState.flipped[1]];

                if (card1.pairId === card2.pairId) {
                    memoryState.matched.push(card1.pairId);

                    if (memoryState.matched.length === memoryPairs.length) {
                        // Game won!
                        let xp = parseInt(localStorage.getItem('scienceXP') || '0');
                        xp += 30;
                        localStorage.setItem('scienceXP', xp);
                        setTimeout(() => alert(' You won in ' + memoryState.moves + ' moves! +30 XP'), 500);
                    }

                    memoryState.flipped = [];
                    renderMemoryGrid();
                } else {
                    setTimeout(() => {
                        memoryState.flipped = [];
                        renderMemoryGrid();
                    }, 1000);
                }
            }
        }

        function updateMemoryStats() {
            document.getElementById('memory-moves').textContent = memoryState.moves;
            document.getElementById('memory-pairs').textContent = memoryState.matched.length + '/' + memoryPairs.length;
        }

        // Experiment Lab Functions
        function openExperimentLab() {
            document.getElementById('experiment-lab-modal').classList.add('active');
            showExperimentList();
        }

        function closeExperimentLab() {
            document.getElementById('experiment-lab-modal').classList.remove('active');
        }

        function showExperimentList() {
            const list = document.getElementById('experiment-list');
            const detail = document.getElementById('experiment-detail');

            list.style.display = 'grid';
            detail.style.display = 'none';

            list.innerHTML = experiments.map(exp => `
                <div class="experiment-card" onclick="showExperiment(${exp.id})">
                    <h4><span>${exp.icon}</span> ${exp.title}</h4>
                    <p>${exp.desc}</p>
                </div>
            `).join('');
        }

        function showExperiment(id) {
            const exp = experiments.find(e => e.id === id);
            const list = document.getElementById('experiment-list');
            const detail = document.getElementById('experiment-detail');

            list.style.display = 'none';
            detail.style.display = 'block';

            detail.innerHTML = `
                <button class="back-to-experiments" onclick="showExperimentList()"> Back to Experiments</button>
                <h3>${exp.icon} ${exp.title}</h3>
                <p style="color: #666; margin-bottom: 15px;">${exp.desc}</p>

                <div style="background: #e3f2fd; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                    <h5 style="margin: 0 0 10px 0; color: #1565c0;"> Materials Needed:</h5>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${exp.materials.map(m => `<li>${m}</li>`).join('')}
                    </ul>
                </div>

                <div class="experiment-steps">
                    <h5> Steps:</h5>
                    <ol>
                        ${exp.steps.map(s => `<li>${s}</li>`).join('')}
                    </ol>
                </div>

                <div class="experiment-result">
                    <h5 style="margin: 0 0 10px 0; color: #e65100;"> What Happens:</h5>
                    <p style="margin: 0;">${exp.result}</p>
                </div>

                <button class="start-battle-btn" style="width: 100%; margin-top: 15px; background: linear-gradient(135deg, #1565c0, #1e88e5);"
                        onclick="completeExperiment(${exp.id})">
                     I Did This Experiment! (+20 XP)
                </button>
            `;
        }

        function completeExperiment(id) {
            const completed = JSON.parse(localStorage.getItem('completedExperiments') || '[]');
            if (!completed.includes(id)) {
                completed.push(id);
                localStorage.setItem('completedExperiments', JSON.stringify(completed));

                let xp = parseInt(localStorage.getItem('scienceXP') || '0');
                xp += 20;
                localStorage.setItem('scienceXP', xp);

                alert(' Experiment completed! +20 XP');
            } else {
                alert('You already completed this experiment!');
            }
        }

        // Quiz Battle Functions
        function openQuizBattle() {
            document.getElementById('quiz-battle-modal').classList.add('active');
            showBattleSetup();
        }

        function closeQuizBattle() {
            document.getElementById('quiz-battle-modal').classList.remove('active');
        }

        function showBattleSetup() {
            document.getElementById('battle-setup').style.display = 'block';
            document.getElementById('battle-game').style.display = 'none';
            document.getElementById('battle-result').style.display = 'none';
        }

        function startQuizBattle() {
            battleState = {
                playerScore: 0,
                botScore: 0,
                currentQuestion: 0,
                questions: [...battleQuestions].sort(() => Math.random() - 0.5).slice(0, 5),
                answered: false
            };

            document.getElementById('battle-setup').style.display = 'none';
            document.getElementById('battle-game').style.display = 'block';
            document.getElementById('battle-result').style.display = 'none';

            updateBattleScores();
            showBattleQuestion();
        }

        function showBattleQuestion() {
            if (battleState.currentQuestion >= battleState.questions.length) {
                endBattle();
                return;
            }

            const q = battleState.questions[battleState.currentQuestion];
            battleState.answered = false;

            document.getElementById('battle-question-area').innerHTML = `
                <div class="battle-question-text">${q.q}</div>
                <div class="battle-options">
                    ${q.options.map((opt, i) => `
                        <div class="battle-option" onclick="answerBattle(${i})">${opt}</div>
                    `).join('')}
                </div>
            `;

            // Bot answers after random delay (simulating thinking)
            setTimeout(() => {
                if (!battleState.answered) {
                    // Bot has 70% chance of getting it right
                    const botCorrect = Math.random() < 0.7;
                    if (botCorrect) {
                        battleState.botScore++;
                        updateBattleScores();
                    }
                }
            }, Math.random() * 2000 + 1500);
        }

        function answerBattle(index) {
            if (battleState.answered) return;
            battleState.answered = true;

            const q = battleState.questions[battleState.currentQuestion];
            const options = document.querySelectorAll('.battle-option');

            options.forEach((opt, i) => {
                if (i === q.answer) {
                    opt.classList.add('correct');
                } else if (i === index && index !== q.answer) {
                    opt.classList.add('wrong');
                }
                opt.style.pointerEvents = 'none';
            });

            if (index === q.answer) {
                battleState.playerScore++;
            }

            updateBattleScores();
            battleState.currentQuestion++;

            setTimeout(showBattleQuestion, 1500);
        }

        function updateBattleScores() {
            document.getElementById('player-score').textContent = battleState.playerScore;
            document.getElementById('bot-score').textContent = battleState.botScore;
        }

        function endBattle() {
            document.getElementById('battle-game').style.display = 'none';
            document.getElementById('battle-result').style.display = 'block';

            let resultHtml, xpAward;

            if (battleState.playerScore > battleState.botScore) {
                resultHtml = '<div class="battle-result-icon"></div><h3>You Win!</h3>';
                xpAward = 50;
            } else if (battleState.playerScore < battleState.botScore) {
                resultHtml = '<div class="battle-result-icon"></div><h3>Bot Wins!</h3>';
                xpAward = 10;
            } else {
                resultHtml = '<div class="battle-result-icon"></div><h3>It\'s a Tie!</h3>';
                xpAward = 25;
            }

            resultHtml += `<p>Your Score: ${battleState.playerScore} | Bot Score: ${battleState.botScore}</p>`;
            resultHtml += `<p style="color: #4caf50; font-weight: bold;">+${xpAward} XP</p>`;
            resultHtml += `<button class="start-battle-btn" onclick="startQuizBattle()"> Battle Again</button>`;

            document.getElementById('battle-result').innerHTML = resultHtml;

            let xp = parseInt(localStorage.getItem('scienceXP') || '0');
            xp += xpAward;
            localStorage.setItem('scienceXP', xp);
        }

        console.log(' Memory Game, Experiment Lab, and Quiz Battle loaded!');
    </script>

    <!-- Batch 60: Leaderboard, Achievements, Sound Effects -->
    <div id="leaderboard-btn" class="leaderboard-btn" onclick="openLeaderboard()" title="Leaderboard">
        
    </div>

    <div id="achievements-btn" class="achievements-btn" onclick="openAchievements()" title="Achievements">
        
    </div>

    <div id="sound-fx-btn" class="sound-fx-btn" onclick="openSoundFX()" title="Sound Settings">
        
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal" class="leaderboard-modal">
        <div class="leaderboard-content">
            <div class="leaderboard-header">
                <h2> Leaderboard</h2>
                <button class="close-leaderboard" onclick="closeLeaderboard()"></button>
            </div>
            <div class="leaderboard-body" id="leaderboard-body">
            </div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div id="achievements-modal" class="achievements-modal">
        <div class="achievements-content">
            <div class="achievements-header">
                <h2> Achievements</h2>
                <button class="close-achievements" onclick="closeAchievements()"></button>
            </div>
            <div class="achievements-body" id="achievements-body">
            </div>
        </div>
    </div>

    <!-- Sound FX Modal -->
    <div id="sound-fx-modal" class="sound-fx-modal">
        <div class="sound-fx-content">
            <div class="sound-fx-header">
                <h2> Sound Settings</h2>
                <button class="close-sound-fx" onclick="closeSoundFX()"></button>
            </div>
            <div class="sound-fx-body">
                <div class="sound-option">
                    <div class="sound-option-info">
                        <span class="sound-option-icon"></span>
                        <span>Correct Answer</span>
                    </div>
                    <label class="sound-toggle">
                        <input type="checkbox" id="sound-correct" checked onchange="saveSoundSettings()">
                        <span class="sound-slider"></span>
                    </label>
                </div>
                <div class="sound-option">
                    <div class="sound-option-info">
                        <span class="sound-option-icon"></span>
                        <span>Wrong Answer</span>
                    </div>
                    <label class="sound-toggle">
                        <input type="checkbox" id="sound-wrong" checked onchange="saveSoundSettings()">
                        <span class="sound-slider"></span>
                    </label>
                </div>
                <div class="sound-option">
                    <div class="sound-option-info">
                        <span class="sound-option-icon"></span>
                        <span>Level Up</span>
                    </div>
                    <label class="sound-toggle">
                        <input type="checkbox" id="sound-levelup" checked onchange="saveSoundSettings()">
                        <span class="sound-slider"></span>
                    </label>
                </div>
                <div class="sound-option">
                    <div class="sound-option-info">
                        <span class="sound-option-icon"></span>
                        <span>Achievement</span>
                    </div>
                    <label class="sound-toggle">
                        <input type="checkbox" id="sound-achievement" checked onchange="saveSoundSettings()">
                        <span class="sound-slider"></span>
                    </label>
                </div>
                <div class="volume-control">
                    <div style="display: flex; justify-content: space-between;">
                        <span> Volume</span>
                        <span id="volume-value">70%</span>
                    </div>
                    <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70" oninput="updateVolume()">
                </div>
                <button class="start-battle-btn" style="width: 100%; margin-top: 15px; background: linear-gradient(135deg, #00838f, #00acc1);" onclick="testAllSounds()">
                     Test All Sounds
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== BATCH 60: Leaderboard, Achievements, Sound Effects =====

        // Simulated leaderboard data (with your actual XP)
        const samplePlayers = [
            { name: 'ScienceWhiz', xp: 2500 },
            { name: 'QuantumKid', xp: 2100 },
            { name: 'BioExplorer', xp: 1800 },
            { name: 'ChemMaster', xp: 1500 },
            { name: 'PhysicsNerd', xp: 1200 },
            { name: 'NatureLover', xp: 900 },
            { name: 'SpaceFan', xp: 600 },
            { name: 'EarthScientist', xp: 400 }
        ];

        // Achievements definitions
        const achievements = [
            { id: 'first_question', name: 'First Steps', desc: 'Answer your first question', icon: '', check: () => getAnswerCount() >= 1 },
            { id: 'ten_questions', name: 'Getting Started', desc: 'Answer 10 questions', icon: '', check: () => getAnswerCount() >= 10 },
            { id: 'fifty_questions', name: 'Dedicated Learner', desc: 'Answer 50 questions', icon: '', check: () => getAnswerCount() >= 50 },
            { id: 'hundred_xp', name: 'XP Collector', desc: 'Earn 100 XP', icon: '', check: () => getXP() >= 100 },
            { id: 'five_hundred_xp', name: 'XP Hunter', desc: 'Earn 500 XP', icon: '', check: () => getXP() >= 500 },
            { id: 'thousand_xp', name: 'XP Master', desc: 'Earn 1000 XP', icon: '', check: () => getXP() >= 1000 },
            { id: 'first_experiment', name: 'Junior Scientist', desc: 'Complete an experiment', icon: '', check: () => getExperimentCount() >= 1 },
            { id: 'battle_winner', name: 'Battle Champion', desc: 'Win a quiz battle', icon: '', check: () => getBattleWins() >= 1 },
            { id: 'memory_master', name: 'Memory Master', desc: 'Complete memory game', icon: '', check: () => getMemoryWins() >= 1 },
            { id: 'streak_three', name: 'On Fire', desc: 'Get a 3-day streak', icon: '', check: () => getStreak() >= 3 },
            { id: 'early_bird', name: 'Early Bird', desc: 'Study before 8 AM', icon: '', check: () => checkEarlyBird() },
            { id: 'night_owl', name: 'Night Owl', desc: 'Study after 9 PM', icon: '', check: () => checkNightOwl() }
        ];

        // Audio context for sound effects
        let audioContext = null;

        // Helper functions for achievements
        function getAnswerCount() {
            return parseInt(localStorage.getItem('totalAnswers') || '0');
        }

        function getXP() {
            return parseInt(localStorage.getItem('scienceXP') || '0');
        }

        function getExperimentCount() {
            const completed = JSON.parse(localStorage.getItem('completedExperiments') || '[]');
            return completed.length;
        }

        function getBattleWins() {
            return parseInt(localStorage.getItem('battleWins') || '0');
        }

        function getMemoryWins() {
            return parseInt(localStorage.getItem('memoryWins') || '0');
        }

        function getStreak() {
            return parseInt(localStorage.getItem('factStreak') || '0');
        }

        function checkEarlyBird() {
            const hour = new Date().getHours();
            if (hour < 8) {
                localStorage.setItem('earlyBirdAchieved', 'true');
            }
            return localStorage.getItem('earlyBirdAchieved') === 'true';
        }

        function checkNightOwl() {
            const hour = new Date().getHours();
            if (hour >= 21) {
                localStorage.setItem('nightOwlAchieved', 'true');
            }
            return localStorage.getItem('nightOwlAchieved') === 'true';
        }

        // Leaderboard Functions
        function openLeaderboard() {
            document.getElementById('leaderboard-modal').classList.add('active');
            renderLeaderboard();
        }

        function closeLeaderboard() {
            document.getElementById('leaderboard-modal').classList.remove('active');
        }

        function renderLeaderboard() {
            const yourXP = getXP();
            const yourName = localStorage.getItem('playerName') || 'You';

            // Create combined list
            const allPlayers = [...samplePlayers, { name: yourName, xp: yourXP, isYou: true }];
            allPlayers.sort((a, b) => b.xp - a.xp);

            const body = document.getElementById('leaderboard-body');
            body.innerHTML = allPlayers.slice(0, 10).map((player, i) => {
                const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                const rankIcon = i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : (i + 1);

                return `
                    <div class="leaderboard-entry ${player.isYou ? 'you' : ''}">
                        <div class="leaderboard-rank ${rankClass}">${rankIcon}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${player.name} ${player.isYou ? '(You)' : ''}</div>
                            <div class="leaderboard-xp">${player.xp.toLocaleString()} XP</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Achievements Functions
        function openAchievements() {
            document.getElementById('achievements-modal').classList.add('active');
            renderAchievements();
        }

        function closeAchievements() {
            document.getElementById('achievements-modal').classList.remove('active');
        }

        function renderAchievements() {
            const unlockedIds = JSON.parse(localStorage.getItem('unlockedAchievements') || '[]');
            const body = document.getElementById('achievements-body');

            // Check for new achievements
            achievements.forEach(ach => {
                if (!unlockedIds.includes(ach.id) && ach.check()) {
                    unlockedIds.push(ach.id);
                    playSoundEffect('achievement');
                }
            });

            localStorage.setItem('unlockedAchievements', JSON.stringify(unlockedIds));

            const unlockedCount = unlockedIds.length;
            body.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: #efebe9; border-radius: 10px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #5d4037;">${unlockedCount}/${achievements.length}</div>
                    <div style="color: #8d6e63;">Achievements Unlocked</div>
                </div>
                ${achievements.map(ach => {
                    const unlocked = unlockedIds.includes(ach.id);
                    return `
                        <div class="achievement-card ${unlocked ? 'unlocked' : ''}">
                            <div class="achievement-icon">${ach.icon}</div>
                            <div class="achievement-info">
                                <h4>${ach.name}</h4>
                                <p>${ach.desc}</p>
                            </div>
                            <div class="achievement-status ${unlocked ? 'unlocked' : 'locked'}">
                                ${unlocked ? ' Unlocked' : ' Locked'}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        // Sound Effects Functions
        function openSoundFX() {
            document.getElementById('sound-fx-modal').classList.add('active');
            loadSoundSettings();
        }

        function closeSoundFX() {
            document.getElementById('sound-fx-modal').classList.remove('active');
        }

        function loadSoundSettings() {
            const settings = JSON.parse(localStorage.getItem('soundSettings') || '{}');
            document.getElementById('sound-correct').checked = settings.correct !== false;
            document.getElementById('sound-wrong').checked = settings.wrong !== false;
            document.getElementById('sound-levelup').checked = settings.levelup !== false;
            document.getElementById('sound-achievement').checked = settings.achievement !== false;
            document.getElementById('volume-slider').value = settings.volume || 70;
            document.getElementById('volume-value').textContent = (settings.volume || 70) + '%';
        }

        function saveSoundSettings() {
            const settings = {
                correct: document.getElementById('sound-correct').checked,
                wrong: document.getElementById('sound-wrong').checked,
                levelup: document.getElementById('sound-levelup').checked,
                achievement: document.getElementById('sound-achievement').checked,
                volume: parseInt(document.getElementById('volume-slider').value)
            };
            localStorage.setItem('soundSettings', JSON.stringify(settings));
        }

        function updateVolume() {
            const volume = document.getElementById('volume-slider').value;
            document.getElementById('volume-value').textContent = volume + '%';
            saveSoundSettings();
        }

        function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        function playSoundEffect(type) {
            const settings = JSON.parse(localStorage.getItem('soundSettings') || '{}');
            if (settings[type] === false) return;

            const volume = (settings.volume || 70) / 100;
            const ctx = getAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            gainNode.gain.value = volume * 0.3;

            if (type === 'correct') {
                oscillator.frequency.value = 523.25;
                oscillator.type = 'sine';
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
            } else if (type === 'wrong') {
                oscillator.frequency.value = 200;
                oscillator.type = 'sawtooth';
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            } else if (type === 'levelup') {
                oscillator.frequency.value = 440;
                oscillator.type = 'sine';
                setTimeout(() => oscillator.frequency.value = 554.37, 100);
                setTimeout(() => oscillator.frequency.value = 659.25, 200);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            } else if (type === 'achievement') {
                oscillator.frequency.value = 392;
                oscillator.type = 'triangle';
                setTimeout(() => oscillator.frequency.value = 523.25, 150);
                setTimeout(() => oscillator.frequency.value = 659.25, 300);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.6);
            }

            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.6);
        }

        function testAllSounds() {
            playSoundEffect('correct');
            setTimeout(() => playSoundEffect('wrong'), 700);
            setTimeout(() => playSoundEffect('levelup'), 1400);
            setTimeout(() => playSoundEffect('achievement'), 2100);
        }

        console.log(' Leaderboard, Achievements, and Sound Effects loaded!');
    </script>

    <!-- Batch 61: Daily Challenge Button -->
    <button class="daily-challenge-btn" id="daily-challenge-btn" onclick="openDailyChallenge()" title="Daily Challenge"></button>

    <!-- Daily Challenge Modal -->
    <div class="daily-challenge-modal" id="daily-challenge-modal">
        <div class="daily-challenge-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0; color: #ff5722;"> Daily Challenge</h2>
                <button onclick="closeDailyChallenge()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="daily-bonus-badge"> 2x XP Bonus!</div>
            <div id="daily-challenge-content"></div>
        </div>
    </div>

    <!-- Vocabulary Builder Button -->
    <button class="vocab-builder-btn" id="vocab-builder-btn" onclick="openVocabBuilder()" title="Vocabulary Builder"></button>

    <!-- Vocabulary Modal -->
    <div class="vocab-modal" id="vocab-modal">
        <div class="vocab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #3f51b5;"> Vocabulary Builder</h2>
                <button onclick="closeVocabBuilder()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <select class="vocab-category-select" id="vocab-category" onchange="loadVocabCategory()">
                <option value="physics">Physics Terms</option>
                <option value="chemistry">Chemistry Terms</option>
                <option value="biology">Biology Terms</option>
                <option value="earth">Earth Science Terms</option>
            </select>
            <p style="text-align: center; color: #666; font-size: 0.9rem;">Click card to flip</p>
            <div class="flashcard" id="vocab-flashcard" onclick="flipFlashcard()">
                <div class="flashcard-inner" id="flashcard-inner">
                    <div class="flashcard-front" id="flashcard-front">Term</div>
                    <div class="flashcard-back" id="flashcard-back">Definition</div>
                </div>
            </div>
            <div class="vocab-nav">
                <button class="vocab-nav-btn" onclick="prevVocab()"> Previous</button>
                <span class="vocab-progress" id="vocab-progress">1 / 10</span>
                <button class="vocab-nav-btn" onclick="nextVocab()">Next </button>
            </div>
            <button onclick="markVocabLearned()" style="width: 100%; margin-top: 15px; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1rem;"> Mark as Learned</button>
        </div>
    </div>

    <!-- Progress Charts Button -->
    <button class="progress-charts-btn" id="progress-charts-btn" onclick="openProgressCharts()" title="Progress Charts"></button>

    <!-- Progress Charts Modal -->
    <div class="charts-modal" id="charts-modal">
        <div class="charts-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #00bcd4;"> Your Progress</h2>
                <button onclick="closeProgressCharts()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div id="charts-content"></div>
        </div>
    </div>

    <script>
        // Batch 61: Daily Challenge
        const dailyChallengeQuestions = [
            { q: "What is the powerhouse of the cell?", options: ["Nucleus", "Mitochondria", "Ribosome", "Golgi body"], answer: 1 },
            { q: "What is the chemical symbol for gold?", options: ["Go", "Gd", "Au", "Ag"], answer: 2 },
            { q: "What planet is known as the Red Planet?", options: ["Venus", "Mars", "Jupiter", "Saturn"], answer: 1 },
            { q: "What is the speed of light in a vacuum?", options: ["300,000 km/s", "150,000 km/s", "500,000 km/s", "1,000,000 km/s"], answer: 0 },
            { q: "What is the hardest natural substance?", options: ["Iron", "Quartz", "Diamond", "Platinum"], answer: 2 },
            { q: "Which gas do plants absorb from the atmosphere?", options: ["Oxygen", "Nitrogen", "Carbon dioxide", "Hydrogen"], answer: 2 },
            { q: "What is the largest organ in the human body?", options: ["Heart", "Liver", "Brain", "Skin"], answer: 3 },
            { q: "What is H2O commonly known as?", options: ["Salt", "Water", "Sugar", "Acid"], answer: 1 },
            { q: "Which planet has the most moons?", options: ["Jupiter", "Saturn", "Uranus", "Neptune"], answer: 1 },
            { q: "What type of energy does the Sun produce?", options: ["Nuclear", "Chemical", "Mechanical", "Electrical"], answer: 0 },
            { q: "What is the process by which plants make food?", options: ["Respiration", "Photosynthesis", "Digestion", "Fermentation"], answer: 1 },
            { q: "What is the center of an atom called?", options: ["Electron", "Proton", "Nucleus", "Neutron"], answer: 2 },
            { q: "What force keeps planets in orbit?", options: ["Magnetism", "Friction", "Gravity", "Electricity"], answer: 2 },
            { q: "What is the boiling point of water in Celsius?", options: ["50C", "100C", "150C", "200C"], answer: 1 },
            { q: "What vitamin does sunlight help produce?", options: ["Vitamin A", "Vitamin C", "Vitamin D", "Vitamin E"], answer: 2 }
        ];

        function getDailyQuestion() {
            const today = new Date().toDateString();
            const seed = today.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            return dailyChallengeQuestions[seed % dailyChallengeQuestions.length];
        }

        function openDailyChallenge() {
            const modal = document.getElementById('daily-challenge-modal');
            const content = document.getElementById('daily-challenge-content');
            const today = new Date().toDateString();
            const completed = localStorage.getItem('dailyChallengeCompleted');

            if (completed === today) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;"></div>
                        <h3 style="color: #4caf50;">Challenge Completed!</h3>
                        <p>You've already completed today's challenge.</p>
                        <p style="margin-top: 15px;">Come back tomorrow for a new challenge!</p>
                    </div>
                `;
            } else {
                const question = getDailyQuestion();
                let optionsHtml = question.options.map((opt, i) =>
                    `<button class="daily-option" onclick="checkDailyAnswer(${i}, ${question.answer})">${opt}</button>`
                ).join('');

                content.innerHTML = `
                    <div class="daily-question-box">
                        <h3 style="margin: 0 0 15px 0; color: #e65100;">${question.q}</h3>
                        ${optionsHtml}
                    </div>
                `;
            }

            modal.style.display = 'flex';
        }

        function checkDailyAnswer(selected, correct) {
            const options = document.querySelectorAll('.daily-option');
            options.forEach((opt, i) => {
                opt.disabled = true;
                if (i === correct) opt.classList.add('correct');
                if (i === selected && selected !== correct) opt.classList.add('wrong');
            });

            const today = new Date().toDateString();
            localStorage.setItem('dailyChallengeCompleted', today);
            document.getElementById('daily-challenge-btn').classList.add('completed');

            const content = document.getElementById('daily-challenge-content');
            const isCorrect = selected === correct;
            const xpEarned = isCorrect ? 20 : 5;

            setTimeout(() => {
                content.innerHTML += `
                    <div style="text-align: center; margin-top: 20px; padding: 20px; background: ${isCorrect ? '#c8e6c9' : '#ffcdd2'}; border-radius: 15px;">
                        <div style="font-size: 3rem;">${isCorrect ? '' : ''}</div>
                        <h3>${isCorrect ? 'Correct!' : 'Not quite!'}</h3>
                        <p>+${xpEarned} XP earned (2x bonus!)</p>
                    </div>
                `;
                addXP(xpEarned);
            }, 500);
        }

        function closeDailyChallenge() {
            document.getElementById('daily-challenge-modal').style.display = 'none';
        }

        function initDailyChallengeBtn() {
            const today = new Date().toDateString();
            const completed = localStorage.getItem('dailyChallengeCompleted');
            if (completed === today) {
                document.getElementById('daily-challenge-btn').classList.add('completed');
            }
        }

        // Vocabulary Builder
        const vocabularyData = {
            physics: [
                { term: "Velocity", def: "The rate of change of position with respect to time, including direction" },
                { term: "Acceleration", def: "The rate of change of velocity with respect to time" },
                { term: "Momentum", def: "The product of mass and velocity of an object" },
                { term: "Inertia", def: "The tendency of an object to resist changes in its state of motion" },
                { term: "Force", def: "A push or pull that can cause an object to accelerate" },
                { term: "Energy", def: "The capacity to do work or cause change" },
                { term: "Wavelength", def: "The distance between consecutive peaks of a wave" },
                { term: "Frequency", def: "The number of wave cycles that pass a point per second" },
                { term: "Amplitude", def: "The maximum displacement from equilibrium in a wave" },
                { term: "Resistance", def: "Opposition to the flow of electric current" }
            ],
            chemistry: [
                { term: "Atom", def: "The smallest unit of matter that retains the properties of an element" },
                { term: "Molecule", def: "Two or more atoms bonded together chemically" },
                { term: "Ion", def: "An atom or molecule with a net electric charge" },
                { term: "Isotope", def: "Atoms of the same element with different numbers of neutrons" },
                { term: "Catalyst", def: "A substance that speeds up a reaction without being consumed" },
                { term: "Oxidation", def: "The loss of electrons in a chemical reaction" },
                { term: "Reduction", def: "The gain of electrons in a chemical reaction" },
                { term: "pH", def: "A measure of the acidity or basicity of a solution" },
                { term: "Solubility", def: "The ability of a substance to dissolve in a solvent" },
                { term: "Compound", def: "A substance made of two or more different elements chemically bonded" }
            ],
            biology: [
                { term: "Cell", def: "The basic structural and functional unit of all living organisms" },
                { term: "DNA", def: "Deoxyribonucleic acid, the molecule carrying genetic instructions" },
                { term: "Gene", def: "A segment of DNA that codes for a specific protein or trait" },
                { term: "Enzyme", def: "A protein that catalyzes biochemical reactions" },
                { term: "Mitosis", def: "Cell division that produces two identical daughter cells" },
                { term: "Meiosis", def: "Cell division that produces four gametes with half the chromosomes" },
                { term: "Photosynthesis", def: "The process by which plants convert light energy into chemical energy" },
                { term: "Respiration", def: "The process of breaking down glucose to release energy" },
                { term: "Osmosis", def: "The movement of water across a semipermeable membrane" },
                { term: "Homeostasis", def: "The maintenance of stable internal conditions in an organism" }
            ],
            earth: [
                { term: "Tectonic Plates", def: "Large slabs of Earth's lithosphere that move and interact" },
                { term: "Erosion", def: "The wearing away of land by wind, water, or ice" },
                { term: "Weathering", def: "The breakdown of rocks by physical or chemical processes" },
                { term: "Magma", def: "Molten rock beneath Earth's surface" },
                { term: "Sediment", def: "Particles of rock transported and deposited by wind or water" },
                { term: "Atmosphere", def: "The layer of gases surrounding Earth" },
                { term: "Hydrosphere", def: "All of Earth's water, including oceans, lakes, and ice" },
                { term: "Lithosphere", def: "Earth's rigid outer layer, including the crust and upper mantle" },
                { term: "Fossil", def: "Preserved remains or traces of ancient organisms" },
                { term: "Mineral", def: "A naturally occurring inorganic solid with a specific composition" }
            ]
        };

        let currentVocabCategory = 'physics';
        let currentVocabIndex = 0;
        let learnedVocab = JSON.parse(localStorage.getItem('learnedVocab') || '{}');

        function openVocabBuilder() {
            document.getElementById('vocab-modal').style.display = 'flex';
            loadVocabCategory();
        }

        function closeVocabBuilder() {
            document.getElementById('vocab-modal').style.display = 'none';
        }

        function loadVocabCategory() {
            currentVocabCategory = document.getElementById('vocab-category').value;
            currentVocabIndex = 0;
            updateFlashcard();
        }

        function updateFlashcard() {
            const vocab = vocabularyData[currentVocabCategory];
            const current = vocab[currentVocabIndex];
            document.getElementById('flashcard-front').textContent = current.term;
            document.getElementById('flashcard-back').textContent = current.def;
            document.getElementById('vocab-progress').textContent = `${currentVocabIndex + 1} / ${vocab.length}`;
            document.getElementById('vocab-flashcard').classList.remove('flipped');
        }

        function flipFlashcard() {
            document.getElementById('vocab-flashcard').classList.toggle('flipped');
        }

        function nextVocab() {
            const vocab = vocabularyData[currentVocabCategory];
            currentVocabIndex = (currentVocabIndex + 1) % vocab.length;
            updateFlashcard();
        }

        function prevVocab() {
            const vocab = vocabularyData[currentVocabCategory];
            currentVocabIndex = (currentVocabIndex - 1 + vocab.length) % vocab.length;
            updateFlashcard();
        }

        function markVocabLearned() {
            const key = `${currentVocabCategory}_${currentVocabIndex}`;
            if (!learnedVocab[key]) {
                learnedVocab[key] = true;
                localStorage.setItem('learnedVocab', JSON.stringify(learnedVocab));
                addXP(5);
                alert('Term marked as learned! +5 XP');
            } else {
                alert('You already learned this term!');
            }
        }

        // Progress Charts
        function openProgressCharts() {
            const modal = document.getElementById('charts-modal');
            const content = document.getElementById('charts-content');

            const stats = JSON.parse(localStorage.getItem('appStats') || '{}');
            const totalAnswers = parseInt(localStorage.getItem('totalAnswersCount') || '0');
            const correctAnswers = parseInt(localStorage.getItem('correctAnswersCount') || '0');
            const xp = parseInt(localStorage.getItem('userXP') || '0');
            const streak = parseInt(localStorage.getItem('loginStreak') || '0');
            const accuracy = totalAnswers > 0 ? Math.round((correctAnswers / totalAnswers) * 100) : 0;

            // Weekly activity (simulated based on current stats)
            const weekData = [];
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const today = new Date().getDay();
            for (let i = 0; i < 7; i++) {
                const dayActivity = JSON.parse(localStorage.getItem(`activity_day_${i}`) || '0');
                weekData.push({ day: days[i], value: dayActivity || Math.floor(Math.random() * 15) + (i <= today ? 5 : 0) });
            }
            const maxActivity = Math.max(...weekData.map(d => d.value), 1);

            content.innerHTML = `
                <div class="charts-grid">
                    <div class="mini-stat">
                        <div class="mini-stat-value">${totalAnswers}</div>
                        <div class="mini-stat-label">Questions Answered</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-value">${correctAnswers}</div>
                        <div class="mini-stat-label">Correct Answers</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-value">${xp}</div>
                        <div class="mini-stat-label">Total XP</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-value">${streak}</div>
                        <div class="mini-stat-label">Day Streak</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h4 style="margin: 0 0 15px 0; color: #00838f;"> Weekly Activity</h4>
                    <div class="bar-chart">
                        ${weekData.map(d => `
                            <div class="bar-item">
                                <div class="bar-value">${d.value}</div>
                                <div class="bar" style="height: ${(d.value / maxActivity) * 120}px;"></div>
                                <div class="bar-label">${d.day}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="chart-container">
                    <h4 style="margin: 0 0 15px 0; color: #00838f;"> Accuracy Rate</h4>
                    <div class="stat-ring" style="background: conic-gradient(#00bcd4 ${accuracy * 3.6}deg, #e0e0e0 ${accuracy * 3.6}deg);">
                        <div class="stat-ring-inner">
                            <div class="stat-ring-value">${accuracy}%</div>
                            <div class="stat-ring-label">Accuracy</div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h4 style="margin: 0 0 10px 0; color: #00838f;"> Vocabulary Progress</h4>
                    <p style="margin: 0; color: #666;">Terms learned: ${Object.keys(learnedVocab).length} / 40</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; margin-top: 10px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #00bcd4, #4dd0e1); height: 100%; width: ${(Object.keys(learnedVocab).length / 40) * 100}%; border-radius: 5px;"></div>
                    </div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        function closeProgressCharts() {
            document.getElementById('charts-modal').style.display = 'none';
        }

        // Track daily activity
        function trackActivity() {
            const today = new Date().getDay();
            const current = parseInt(localStorage.getItem(`activity_day_${today}`) || '0');
            localStorage.setItem(`activity_day_${today}`, current + 1);
        }

        // Initialize
        initDailyChallengeBtn();
        console.log(' Daily Challenge, Vocabulary Builder, and Progress Charts loaded!');
    </script>

    <!-- Batch 62: Study Planner Button -->
    <button class="study-planner-btn" onclick="openStudyPlanner()" title="Study Planner"></button>

    <!-- Study Planner Modal -->
    <div class="planner-modal" id="planner-modal">
        <div class="planner-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #673ab7;"> Study Planner</h2>
                <button onclick="closeStudyPlanner()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="planner-week" id="planner-week"></div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" class="add-task-input" id="new-task-input" placeholder="Add study task..." style="flex: 1; min-width: 200px;">
                <select class="planner-day-select" id="task-day-select">
                    <option value="0">Monday</option>
                    <option value="1">Tuesday</option>
                    <option value="2">Wednesday</option>
                    <option value="3">Thursday</option>
                    <option value="4">Friday</option>
                    <option value="5">Saturday</option>
                    <option value="6">Sunday</option>
                </select>
                <button onclick="addPlannerTask()" style="padding: 10px 20px; background: #673ab7; color: white; border: none; border-radius: 10px; cursor: pointer;">Add</button>
            </div>
            <button onclick="clearAllTasks()" style="margin-top: 15px; padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 10px; cursor: pointer;">Clear All Tasks</button>
        </div>
    </div>

    <!-- Topic Quiz Generator Button -->
    <button class="topic-quiz-btn" onclick="openTopicQuiz()" title="Topic Quiz"></button>

    <!-- Topic Quiz Modal -->
    <div class="topic-quiz-modal" id="topic-quiz-modal">
        <div class="topic-quiz-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #e91e63;"> Topic Quiz</h2>
                <button onclick="closeTopicQuiz()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div id="topic-quiz-content"></div>
        </div>
    </div>

    <!-- Concept Map Button -->
    <button class="concept-map-btn" onclick="openConceptMap()" title="Concept Map"></button>

    <!-- Concept Map Modal -->
    <div class="concept-modal" id="concept-modal">
        <div class="concept-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #009688;"> Concept Map</h2>
                <button onclick="closeConceptMap()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <select class="concept-select" id="concept-topic-select" onchange="loadConceptMap()">
                <option value="cells">Cell Biology</option>
                <option value="forces">Forces & Motion</option>
                <option value="atoms">Atomic Structure</option>
                <option value="ecology">Ecology</option>
                <option value="energy">Energy Types</option>
            </select>
            <div class="concept-map-area" id="concept-map-area"></div>
            <div class="concept-info" id="concept-info">Click a concept to learn more</div>
        </div>
    </div>

    <script>
        // Batch 62: Study Planner
        let plannerTasks = JSON.parse(localStorage.getItem('plannerTasks') || '{}');
        const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        function openStudyPlanner() {
            document.getElementById('planner-modal').style.display = 'flex';
            renderPlanner();
        }

        function closeStudyPlanner() {
            document.getElementById('planner-modal').style.display = 'none';
        }

        function renderPlanner() {
            const week = document.getElementById('planner-week');
            week.innerHTML = dayNames.map((day, i) => {
                const tasks = plannerTasks[i] || [];
                return `
                    <div class="planner-day">
                        <div class="planner-day-header">${day}</div>
                        ${tasks.map((t, j) => `<div class="planner-task" onclick="removeTask(${i}, ${j})">${t}</div>`).join('')}
                    </div>
                `;
            }).join('');
        }

        function addPlannerTask() {
            const input = document.getElementById('new-task-input');
            const day = parseInt(document.getElementById('task-day-select').value);
            const task = input.value.trim();
            if (task) {
                if (!plannerTasks[day]) plannerTasks[day] = [];
                plannerTasks[day].push(task);
                localStorage.setItem('plannerTasks', JSON.stringify(plannerTasks));
                input.value = '';
                renderPlanner();
                addXP(2);
            }
        }

        function removeTask(day, index) {
            if (confirm('Remove this task?')) {
                plannerTasks[day].splice(index, 1);
                localStorage.setItem('plannerTasks', JSON.stringify(plannerTasks));
                renderPlanner();
            }
        }

        function clearAllTasks() {
            if (confirm('Clear all tasks from the planner?')) {
                plannerTasks = {};
                localStorage.setItem('plannerTasks', JSON.stringify(plannerTasks));
                renderPlanner();
            }
        }

        // Topic Quiz Generator
        const topicQuizzes = {
            physics: {
                icon: '', name: 'Physics',
                questions: [
                    { q: "What is the SI unit of force?", opts: ["Joule", "Newton", "Watt", "Pascal"], a: 1 },
                    { q: "Speed with direction is called?", opts: ["Acceleration", "Velocity", "Momentum", "Force"], a: 1 },
                    { q: "What type of energy is stored in a battery?", opts: ["Kinetic", "Nuclear", "Chemical", "Sound"], a: 2 },
                    { q: "Light travels fastest through?", opts: ["Water", "Glass", "Vacuum", "Air"], a: 2 },
                    { q: "What is measured in Hertz?", opts: ["Wavelength", "Frequency", "Amplitude", "Speed"], a: 1 }
                ]
            },
            chemistry: {
                icon: '', name: 'Chemistry',
                questions: [
                    { q: "What is the pH of pure water?", opts: ["0", "7", "14", "1"], a: 1 },
                    { q: "Which particle has no charge?", opts: ["Proton", "Electron", "Neutron", "Ion"], a: 2 },
                    { q: "What is the symbol for sodium?", opts: ["So", "Na", "Sd", "S"], a: 1 },
                    { q: "Rusting is an example of?", opts: ["Physical change", "Oxidation", "Reduction", "Sublimation"], a: 1 },
                    { q: "Noble gases are in group?", opts: ["1", "7", "18", "2"], a: 2 }
                ]
            },
            biology: {
                icon: '', name: 'Biology',
                questions: [
                    { q: "Where does photosynthesis occur?", opts: ["Mitochondria", "Chloroplast", "Nucleus", "Ribosome"], a: 1 },
                    { q: "What carries oxygen in blood?", opts: ["Plasma", "White cells", "Platelets", "Hemoglobin"], a: 3 },
                    { q: "DNA stands for?", opts: ["Deoxyribose acid", "Deoxyribonucleic acid", "Dinucleic acid", "None"], a: 1 },
                    { q: "The basic unit of life is?", opts: ["Atom", "Molecule", "Cell", "Tissue"], a: 2 },
                    { q: "Enzymes are made of?", opts: ["Carbohydrates", "Lipids", "Proteins", "Nucleic acids"], a: 2 }
                ]
            },
            earth: {
                icon: '', name: 'Earth Science',
                questions: [
                    { q: "What causes tides?", opts: ["Wind", "Moon's gravity", "Earth's rotation", "Sun"], a: 1 },
                    { q: "The outer layer of Earth is?", opts: ["Mantle", "Core", "Crust", "Magma"], a: 2 },
                    { q: "Fossils are found in which rock?", opts: ["Igneous", "Sedimentary", "Metamorphic", "Volcanic"], a: 1 },
                    { q: "What scale measures earthquakes?", opts: ["pH", "Richter", "Kelvin", "Decibel"], a: 1 },
                    { q: "Water cycle includes?", opts: ["Evaporation only", "Condensation only", "All water movements", "Rain only"], a: 2 }
                ]
            }
        };

        let selectedQuizTopic = null;
        let currentTopicQuiz = [];
        let topicQuizIndex = 0;
        let topicQuizScore = 0;

        function openTopicQuiz() {
            document.getElementById('topic-quiz-modal').style.display = 'flex';
            showTopicSelection();
        }

        function closeTopicQuiz() {
            document.getElementById('topic-quiz-modal').style.display = 'none';
        }

        function showTopicSelection() {
            const content = document.getElementById('topic-quiz-content');
            content.innerHTML = `
                <p style="color: #666; margin-bottom: 15px;">Select a topic to quiz yourself:</p>
                <div class="topic-select-grid">
                    ${Object.entries(topicQuizzes).map(([key, val]) => `
                        <div class="topic-card" onclick="selectQuizTopic('${key}')">
                            <div class="topic-card-icon">${val.icon}</div>
                            <div>${val.name}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="quiz-settings">
                    <div class="quiz-setting-row">
                        <span>Number of questions:</span>
                        <select class="quiz-count-select" id="quiz-count">
                            <option value="3">3 Questions</option>
                            <option value="5" selected>5 Questions</option>
                        </select>
                    </div>
                </div>
                <button onclick="startTopicQuiz()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); color: white; border: none; border-radius: 15px; font-size: 1.1rem; cursor: pointer;">Start Quiz</button>
            `;
        }

        function selectQuizTopic(topic) {
            selectedQuizTopic = topic;
            document.querySelectorAll('.topic-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        function startTopicQuiz() {
            if (!selectedQuizTopic) {
                alert('Please select a topic first!');
                return;
            }
            const count = parseInt(document.getElementById('quiz-count').value);
            const allQ = topicQuizzes[selectedQuizTopic].questions;
            currentTopicQuiz = [...allQ].sort(() => Math.random() - 0.5).slice(0, count);
            topicQuizIndex = 0;
            topicQuizScore = 0;
            showTopicQuestion();
        }

        function showTopicQuestion() {
            const content = document.getElementById('topic-quiz-content');
            const q = currentTopicQuiz[topicQuizIndex];
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span style="color: #666;">Question ${topicQuizIndex + 1} of ${currentTopicQuiz.length}</span>
                    <span style="color: #e91e63; font-weight: bold;">Score: ${topicQuizScore}</span>
                </div>
                <div style="background: #fce4ec; padding: 20px; border-radius: 15px; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #880e4f;">${q.q}</h3>
                </div>
                ${q.opts.map((opt, i) => `
                    <button onclick="answerTopicQuiz(${i}, ${q.a})" style="display: block; width: 100%; padding: 15px; margin: 10px 0; background: white; border: 2px solid #e91e63; border-radius: 10px; cursor: pointer; text-align: left; font-size: 1rem; transition: all 0.3s ease;">${opt}</button>
                `).join('')}
            `;
        }

        function answerTopicQuiz(selected, correct) {
            const isCorrect = selected === correct;
            if (isCorrect) topicQuizScore++;

            topicQuizIndex++;
            if (topicQuizIndex < currentTopicQuiz.length) {
                setTimeout(showTopicQuestion, 500);
            } else {
                showTopicQuizResults();
            }
        }

        function showTopicQuizResults() {
            const content = document.getElementById('topic-quiz-content');
            const percent = Math.round((topicQuizScore / currentTopicQuiz.length) * 100);
            const xpEarned = topicQuizScore * 5;
            addXP(xpEarned);

            content.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">${percent >= 80 ? '' : percent >= 50 ? '' : ''}</div>
                    <h2 style="color: #e91e63;">${topicQuizzes[selectedQuizTopic].name} Quiz Complete!</h2>
                    <p style="font-size: 1.5rem; margin: 20px 0;">${topicQuizScore} / ${currentTopicQuiz.length} correct</p>
                    <p style="color: #4caf50; font-weight: bold;">+${xpEarned} XP earned!</p>
                    <button onclick="showTopicSelection()" style="margin-top: 20px; padding: 15px 30px; background: #e91e63; color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 1rem;">Try Another Topic</button>
                </div>
            `;
        }

        // Concept Map
        const conceptMaps = {
            cells: {
                central: 'Cell',
                nodes: [
                    { name: 'Nucleus', x: 20, y: 10, info: 'Contains DNA and controls cell activities' },
                    { name: 'Mitochondria', x: 60, y: 10, info: 'Powerhouse - produces ATP energy' },
                    { name: 'Cell Membrane', x: 10, y: 50, info: 'Controls what enters and exits the cell' },
                    { name: 'Cytoplasm', x: 70, y: 50, info: 'Jelly-like substance filling the cell' },
                    { name: 'Ribosomes', x: 20, y: 85, info: 'Makes proteins from amino acids' },
                    { name: 'ER', x: 60, y: 85, info: 'Transports materials in the cell' }
                ]
            },
            forces: {
                central: 'Forces',
                nodes: [
                    { name: 'Gravity', x: 15, y: 10, info: 'Attracts objects with mass toward each other' },
                    { name: 'Friction', x: 65, y: 10, info: 'Opposes motion between surfaces' },
                    { name: 'Tension', x: 10, y: 50, info: 'Pulling force through a rope or string' },
                    { name: 'Normal', x: 70, y: 50, info: 'Support force perpendicular to surface' },
                    { name: 'Applied', x: 20, y: 85, info: 'Force applied by a person or object' },
                    { name: 'Air Resistance', x: 55, y: 85, info: 'Friction from air on moving objects' }
                ]
            },
            atoms: {
                central: 'Atom',
                nodes: [
                    { name: 'Proton', x: 20, y: 15, info: 'Positive charge, found in nucleus' },
                    { name: 'Neutron', x: 60, y: 15, info: 'No charge, found in nucleus' },
                    { name: 'Electron', x: 10, y: 50, info: 'Negative charge, orbits nucleus' },
                    { name: 'Nucleus', x: 70, y: 50, info: 'Center containing protons and neutrons' },
                    { name: 'Shell', x: 20, y: 85, info: 'Energy levels where electrons orbit' },
                    { name: 'Ion', x: 60, y: 85, info: 'Atom with gained or lost electrons' }
                ]
            },
            ecology: {
                central: 'Ecosystem',
                nodes: [
                    { name: 'Producer', x: 15, y: 10, info: 'Makes own food through photosynthesis' },
                    { name: 'Consumer', x: 65, y: 10, info: 'Eats other organisms for energy' },
                    { name: 'Decomposer', x: 10, y: 50, info: 'Breaks down dead organic matter' },
                    { name: 'Food Chain', x: 70, y: 50, info: 'Energy flow from one organism to next' },
                    { name: 'Habitat', x: 20, y: 85, info: 'Place where an organism lives' },
                    { name: 'Niche', x: 60, y: 85, info: 'Role of organism in ecosystem' }
                ]
            },
            energy: {
                central: 'Energy',
                nodes: [
                    { name: 'Kinetic', x: 15, y: 10, info: 'Energy of motion' },
                    { name: 'Potential', x: 65, y: 10, info: 'Stored energy due to position' },
                    { name: 'Thermal', x: 10, y: 50, info: 'Heat energy from particle movement' },
                    { name: 'Chemical', x: 70, y: 50, info: 'Energy stored in chemical bonds' },
                    { name: 'Electrical', x: 20, y: 85, info: 'Energy from moving electrons' },
                    { name: 'Light', x: 60, y: 85, info: 'Electromagnetic radiation energy' }
                ]
            }
        };

        function openConceptMap() {
            document.getElementById('concept-modal').style.display = 'flex';
            loadConceptMap();
        }

        function closeConceptMap() {
            document.getElementById('concept-modal').style.display = 'none';
        }

        function loadConceptMap() {
            const topic = document.getElementById('concept-topic-select').value;
            const map = conceptMaps[topic];
            const area = document.getElementById('concept-map-area');

            area.innerHTML = `
                <div class="concept-node central" style="left: 50%; top: 50%; transform: translate(-50%, -50%);" onclick="showConceptInfo('${map.central}', 'The central concept connecting all related ideas')">${map.central}</div>
                ${map.nodes.map(n => `
                    <div class="concept-node" style="left: ${n.x}%; top: ${n.y}%;" onclick="showConceptInfo('${n.name}', '${n.info}')">${n.name}</div>
                `).join('')}
            `;
            document.getElementById('concept-info').innerHTML = 'Click a concept to learn more';
        }

        function showConceptInfo(name, info) {
            document.getElementById('concept-info').innerHTML = `<strong>${name}:</strong> ${info}`;
            addXP(1);
        }

        console.log(' Study Planner, Topic Quiz, and Concept Map loaded!');
    </script>

    <!-- Batch 63: Quick Notes Button -->
    <button class="quick-notes-btn" onclick="openQuickNotes()" title="Quick Notes"></button>

    <!-- Quick Notes Modal -->
    <div class="notes-modal" id="notes-modal">
        <div class="notes-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #ff9800;"> Quick Notes</h2>
                <button onclick="closeQuickNotes()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <textarea class="note-input-area" id="note-input" placeholder="Write a quick note..."></textarea>
            <button onclick="saveQuickNote()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer;">Save Note</button>
            <h4 style="margin-top: 25px; color: #666;">Your Notes</h4>
            <div id="notes-list"></div>
        </div>
    </div>

    <!-- Formula Sheet Button -->
    <button class="formula-sheet-btn" onclick="openFormulaSheet()" title="Formula Sheet"></button>

    <!-- Formula Sheet Modal -->
    <div class="formula-modal" id="formula-modal">
        <div class="formula-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #795548;"> Formula Sheet</h2>
                <button onclick="closeFormulaSheet()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <select class="formula-select" id="formula-category-select" onchange="loadFormulas()">
                <option value="physics">Physics Formulas</option>
                <option value="chemistry">Chemistry Formulas</option>
                <option value="biology">Biology Equations</option>
                <option value="math">Math Formulas</option>
            </select>
            <div id="formula-list"></div>
        </div>
    </div>

    <!-- Question Archive Button -->
    <button class="archive-btn" onclick="openArchive()" title="Question Archive"></button>

    <!-- Question Archive Modal -->
    <div class="archive-modal" id="archive-modal">
        <div class="archive-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #607d8b;"> Question Archive</h2>
                <button onclick="closeArchive()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <p style="color: #666; margin-bottom: 15px;">Browse past daily challenge questions</p>
            <div id="archive-list"></div>
        </div>
    </div>

    <script>
        // Batch 63: Quick Notes
        let quickNotes = JSON.parse(localStorage.getItem('quickNotes') || '[]');

        function openQuickNotes() {
            document.getElementById('notes-modal').style.display = 'flex';
            renderNotes();
        }

        function closeQuickNotes() {
            document.getElementById('notes-modal').style.display = 'none';
        }

        function saveQuickNote() {
            const input = document.getElementById('note-input');
            const text = input.value.trim();
            if (text) {
                quickNotes.unshift({
                    text: text,
                    time: new Date().toLocaleString()
                });
                localStorage.setItem('quickNotes', JSON.stringify(quickNotes));
                input.value = '';
                renderNotes();
                addXP(3);
            }
        }

        function renderNotes() {
            const list = document.getElementById('notes-list');
            if (quickNotes.length === 0) {
                list.innerHTML = '<p style="color: #999; text-align: center;">No notes yet. Start taking notes!</p>';
                return;
            }
            list.innerHTML = quickNotes.map((note, i) => `
                <div class="note-card">
                    <button class="note-card-delete" onclick="deleteNote(${i})"></button>
                    <div class="note-card-time">${note.time}</div>
                    <div class="note-card-text">${note.text}</div>
                </div>
            `).join('');
        }

        function deleteNote(index) {
            if (confirm('Delete this note?')) {
                quickNotes.splice(index, 1);
                localStorage.setItem('quickNotes', JSON.stringify(quickNotes));
                renderNotes();
            }
        }

        // Formula Sheet
        const formulas = {
            physics: [
                { name: 'Speed', eq: 'v = d / t' },
                { name: 'Acceleration', eq: 'a = (v - u) / t' },
                { name: 'Force', eq: 'F = m  a' },
                { name: 'Weight', eq: 'W = m  g' },
                { name: 'Work', eq: 'W = F  d' },
                { name: 'Power', eq: 'P = W / t' },
                { name: 'Kinetic Energy', eq: 'KE = mv' },
                { name: 'Potential Energy', eq: 'PE = mgh' },
                { name: 'Pressure', eq: 'P = F / A' },
                { name: 'Density', eq: ' = m / V' },
                { name: 'Momentum', eq: 'p = m  v' },
                { name: 'Ohm\'s Law', eq: 'V = I  R' }
            ],
            chemistry: [
                { name: 'Moles', eq: 'n = m / M' },
                { name: 'Concentration', eq: 'C = n / V' },
                { name: 'Dilution', eq: 'CV = CV' },
                { name: 'Percent Composition', eq: '% = (mass part / total)  100' },
                { name: 'Ideal Gas', eq: 'PV = nRT' },
                { name: 'pH', eq: 'pH = -log[H]' },
                { name: 'Density', eq: 'D = m / V' },
                { name: 'Rate of Reaction', eq: 'Rate = [conc] / t' }
            ],
            biology: [
                { name: 'Photosynthesis', eq: '6CO + 6HO  CHO + 6O' },
                { name: 'Respiration', eq: 'CHO + 6O  6CO + 6HO + ATP' },
                { name: 'Magnification', eq: 'M = Image size / Actual size' },
                { name: 'BMI', eq: 'BMI = weight(kg) / height(m)' },
                { name: 'Heart Rate', eq: 'Max HR = 220 - age' },
                { name: 'Genetics Ratio', eq: 'Punnet Square 3:1 dominant' }
            ],
            math: [
                { name: 'Area (Rectangle)', eq: 'A = l  w' },
                { name: 'Area (Circle)', eq: 'A = r' },
                { name: 'Area (Triangle)', eq: 'A =   b  h' },
                { name: 'Circumference', eq: 'C = 2r' },
                { name: 'Volume (Cube)', eq: 'V = s' },
                { name: 'Volume (Cylinder)', eq: 'V = rh' },
                { name: 'Pythagoras', eq: 'a + b = c' },
                { name: 'Quadratic', eq: 'x = (-b  (b-4ac)) / 2a' },
                { name: 'Slope', eq: 'm = (y - y) / (x - x)' },
                { name: 'Percentage', eq: '% = (part / whole)  100' }
            ]
        };

        function openFormulaSheet() {
            document.getElementById('formula-modal').style.display = 'flex';
            loadFormulas();
        }

        function closeFormulaSheet() {
            document.getElementById('formula-modal').style.display = 'none';
        }

        function loadFormulas() {
            const category = document.getElementById('formula-category-select').value;
            const list = document.getElementById('formula-list');
            const categoryFormulas = formulas[category];

            list.innerHTML = `
                <div class="formula-category">
                    ${categoryFormulas.map(f => `
                        <div class="formula-item">
                            <span class="formula-name">${f.name}</span>
                            <span class="formula-equation">${f.eq}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Question Archive
        const archiveQuestions = [
            { date: 'Jan 13', q: 'What is the powerhouse of the cell?', answer: 'Mitochondria', status: 'correct' },
            { date: 'Jan 12', q: 'What is the chemical symbol for gold?', answer: 'Au', status: 'correct' },
            { date: 'Jan 11', q: 'What planet is known as the Red Planet?', answer: 'Mars', status: 'wrong' },
            { date: 'Jan 10', q: 'What is the speed of light in a vacuum?', answer: '300,000 km/s', status: 'correct' },
            { date: 'Jan 9', q: 'What is the hardest natural substance?', answer: 'Diamond', status: 'unanswered' },
            { date: 'Jan 8', q: 'Which gas do plants absorb?', answer: 'Carbon dioxide', status: 'correct' },
            { date: 'Jan 7', q: 'What is the largest organ in the human body?', answer: 'Skin', status: 'correct' },
            { date: 'Jan 6', q: 'What is H2O commonly known as?', answer: 'Water', status: 'correct' },
            { date: 'Jan 5', q: 'Which planet has the most moons?', answer: 'Saturn', status: 'wrong' },
            { date: 'Jan 4', q: 'What type of energy does the Sun produce?', answer: 'Nuclear', status: 'correct' }
        ];

        function openArchive() {
            document.getElementById('archive-modal').style.display = 'flex';
            renderArchive();
        }

        function closeArchive() {
            document.getElementById('archive-modal').style.display = 'none';
        }

        function renderArchive() {
            const list = document.getElementById('archive-list');
            list.innerHTML = archiveQuestions.map(q => `
                <div class="archive-question" onclick="showArchiveAnswer('${q.q}', '${q.answer}')">
                    <div class="archive-question-date">${q.date}</div>
                    <div class="archive-question-text">${q.q}</div>
                    <div class="archive-question-status ${q.status}">
                        ${q.status === 'correct' ? ' Answered correctly' : q.status === 'wrong' ? ' Answered incorrectly' : ' Not attempted'}
                    </div>
                </div>
            `).join('');
        }

        function showArchiveAnswer(question, answer) {
            alert(`Question: ${question}\n\nAnswer: ${answer}`);
        }

        console.log(' Quick Notes, Formula Sheet, and Question Archive loaded!');
    </script>

    <!-- Batch 64: Science Facts Carousel Button -->
    <button class="facts-carousel-btn" onclick="openFactsCarousel()" title="Science Facts"></button>

    <!-- Science Facts Modal -->
    <div class="facts-modal" id="facts-modal">
        <div class="facts-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #8e24aa;"> Did You Know?</h2>
                <button onclick="closeFactsCarousel()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="fact-card" id="fact-card">
                <div class="fact-icon" id="fact-icon"></div>
                <div class="fact-text" id="fact-text">Loading...</div>
                <div class="fact-category" id="fact-category">Science</div>
            </div>
            <div class="fact-nav">
                <button class="fact-nav-btn" onclick="prevFact()"></button>
                <button class="fact-nav-btn" onclick="nextFact()"></button>
            </div>
        </div>
    </div>

    <!-- Practice Mode Button -->
    <button class="practice-mode-btn" onclick="openPracticeMode()" title="Practice Mode"></button>

    <!-- Practice Mode Modal -->
    <div class="practice-modal" id="practice-modal">
        <div class="practice-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #00897b;"> Practice Mode</h2>
                <button onclick="closePracticeMode()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div id="practice-content"></div>
        </div>
    </div>

    <!-- Badge Collection Button -->
    <button class="badge-collection-btn" onclick="openBadgeCollection()" title="Badge Collection"></button>

    <!-- Badge Collection Modal -->
    <div class="badge-modal" id="badge-modal">
        <div class="badge-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #ff8f00;"> Badge Collection</h2>
                <button onclick="closeBadgeCollection()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div id="badge-collection-content"></div>
        </div>
    </div>

    <script>
        // Batch 64: Science Facts Carousel
        const scienceFacts = [
            { icon: '', text: 'Human DNA is about 99.9% identical to the DNA of every other human.', category: 'Biology' },
            { icon: '', text: 'Lightning strikes the Earth about 100 times every second.', category: 'Physics' },
            { icon: '', text: 'The ocean produces over 50% of the world\'s oxygen.', category: 'Earth Science' },
            { icon: '', text: 'Water is the only substance that exists naturally in three states.', category: 'Chemistry' },
            { icon: '', text: 'A human skeleton regenerates itself completely every 10 years.', category: 'Biology' },
            { icon: '', text: 'The Sun is so large that about 1.3 million Earths could fit inside it.', category: 'Astronomy' },
            { icon: '', text: 'Tooth enamel is the hardest substance in the human body.', category: 'Biology' },
            { icon: '', text: 'Sound travels about 4.3 times faster in water than in air.', category: 'Physics' },
            { icon: '', text: 'Earth\'s core is as hot as the surface of the Sun, about 5,500C.', category: 'Earth Science' },
            { icon: '', text: 'An atom is 99.9999999% empty space.', category: 'Chemistry' },
            { icon: '', text: 'Octopuses have three hearts and blue blood.', category: 'Biology' },
            { icon: '', text: 'A day on Venus is longer than a year on Venus.', category: 'Astronomy' },
            { icon: '', text: 'Diamonds can be made from peanut butter.', category: 'Chemistry' },
            { icon: '', text: 'The Earth\'s magnetic field flips about every 200,000-300,000 years.', category: 'Earth Science' },
            { icon: '', text: 'A single human cell contains about 6 feet of DNA.', category: 'Biology' }
        ];

        let currentFactIndex = 0;

        function openFactsCarousel() {
            document.getElementById('facts-modal').style.display = 'flex';
            showFact();
        }

        function closeFactsCarousel() {
            document.getElementById('facts-modal').style.display = 'none';
        }

        function showFact() {
            const fact = scienceFacts[currentFactIndex];
            document.getElementById('fact-icon').textContent = fact.icon;
            document.getElementById('fact-text').textContent = fact.text;
            document.getElementById('fact-category').textContent = fact.category;
        }

        function nextFact() {
            currentFactIndex = (currentFactIndex + 1) % scienceFacts.length;
            showFact();
            addXP(1);
        }

        function prevFact() {
            currentFactIndex = (currentFactIndex - 1 + scienceFacts.length) % scienceFacts.length;
            showFact();
        }

        // Practice Mode
        const practiceQuestions = {
            easy: [
                { q: 'What color is the sky on a clear day?', opts: ['Blue', 'Red', 'Green', 'Yellow'], a: 0 },
                { q: 'How many legs does a spider have?', opts: ['6', '8', '10', '4'], a: 1 },
                { q: 'What do plants need to make food?', opts: ['Darkness', 'Sunlight', 'Wind', 'Rain only'], a: 1 },
                { q: 'What is the largest planet?', opts: ['Earth', 'Mars', 'Jupiter', 'Saturn'], a: 2 },
                { q: 'What do we breathe?', opts: ['Carbon dioxide', 'Nitrogen', 'Oxygen', 'Hydrogen'], a: 2 }
            ],
            medium: [
                { q: 'What is the chemical formula for water?', opts: ['CO2', 'H2O', 'NaCl', 'O2'], a: 1 },
                { q: 'Which organelle produces energy?', opts: ['Nucleus', 'Ribosome', 'Mitochondria', 'Golgi'], a: 2 },
                { q: 'What is Newton\'s first law about?', opts: ['Gravity', 'Inertia', 'Energy', 'Friction'], a: 1 },
                { q: 'What gas do plants release?', opts: ['Carbon dioxide', 'Nitrogen', 'Oxygen', 'Methane'], a: 2 },
                { q: 'What is the pH of neutral water?', opts: ['0', '7', '14', '1'], a: 1 }
            ],
            hard: [
                { q: 'What is the powerhouse equation?', opts: ['E=mc', 'F=ma', 'ATP synthesis', 'PV=nRT'], a: 2 },
                { q: 'Which subatomic particle has no charge?', opts: ['Proton', 'Electron', 'Neutron', 'Positron'], a: 2 },
                { q: 'What is the speed of light?', opts: ['300 m/s', '310 m/s', '310 m/s', '310 m/s'], a: 2 },
                { q: 'What is Avogadro\'s number?', opts: ['6.0210', '6.6710', '3.14', '9.8'], a: 0 },
                { q: 'What type of bond shares electrons?', opts: ['Ionic', 'Covalent', 'Metallic', 'Hydrogen'], a: 1 }
            ]
        };

        let selectedDifficulty = null;
        let practiceIndex = 0;
        let practiceScore = 0;
        let currentPracticeSet = [];

        function openPracticeMode() {
            document.getElementById('practice-modal').style.display = 'flex';
            showDifficultySelection();
        }

        function closePracticeMode() {
            document.getElementById('practice-modal').style.display = 'none';
        }

        function showDifficultySelection() {
            const content = document.getElementById('practice-content');
            content.innerHTML = `
                <p style="color: #666; margin-bottom: 15px;">Select your difficulty level:</p>
                <div class="difficulty-grid">
                    <div class="difficulty-card easy" onclick="selectDifficulty('easy', this)">
                        <div class="difficulty-icon"></div>
                        <div>Easy</div>
                    </div>
                    <div class="difficulty-card medium" onclick="selectDifficulty('medium', this)">
                        <div class="difficulty-icon"></div>
                        <div>Medium</div>
                    </div>
                    <div class="difficulty-card hard" onclick="selectDifficulty('hard', this)">
                        <div class="difficulty-icon"></div>
                        <div>Hard</div>
                    </div>
                </div>
                <button onclick="startPractice()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #00897b 0%, #00695c 100%); color: white; border: none; border-radius: 15px; font-size: 1.1rem; cursor: pointer; margin-top: 15px;">Start Practice</button>
            `;
        }

        function selectDifficulty(level, element) {
            selectedDifficulty = level;
            document.querySelectorAll('.difficulty-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
        }

        function startPractice() {
            if (!selectedDifficulty) {
                alert('Please select a difficulty level!');
                return;
            }
            currentPracticeSet = [...practiceQuestions[selectedDifficulty]].sort(() => Math.random() - 0.5);
            practiceIndex = 0;
            practiceScore = 0;
            showPracticeQuestion();
        }

        function showPracticeQuestion() {
            const content = document.getElementById('practice-content');
            const q = currentPracticeSet[practiceIndex];
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span style="color: #666;">Question ${practiceIndex + 1} of ${currentPracticeSet.length}</span>
                    <span style="color: #00897b; font-weight: bold;">Score: ${practiceScore}</span>
                </div>
                <div class="practice-question">
                    <h3 style="margin: 0; color: #00695c;">${q.q}</h3>
                </div>
                ${q.opts.map((opt, i) => `
                    <button class="practice-option" onclick="answerPractice(${i}, ${q.a})">${opt}</button>
                `).join('')}
            `;
        }

        function answerPractice(selected, correct) {
            if (selected === correct) practiceScore++;
            practiceIndex++;
            if (practiceIndex < currentPracticeSet.length) {
                setTimeout(showPracticeQuestion, 300);
            } else {
                showPracticeResults();
            }
        }

        function showPracticeResults() {
            const content = document.getElementById('practice-content');
            const percent = Math.round((practiceScore / currentPracticeSet.length) * 100);
            const xpMultiplier = selectedDifficulty === 'hard' ? 3 : selectedDifficulty === 'medium' ? 2 : 1;
            const xpEarned = practiceScore * 5 * xpMultiplier;
            addXP(xpEarned);

            content.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">${percent >= 80 ? '' : percent >= 50 ? '' : ''}</div>
                    <h2 style="color: #00897b;">Practice Complete!</h2>
                    <p style="font-size: 1.5rem; margin: 20px 0;">${practiceScore} / ${currentPracticeSet.length} correct</p>
                    <p style="color: #4caf50; font-weight: bold;">+${xpEarned} XP earned! (${xpMultiplier}x ${selectedDifficulty} bonus)</p>
                    <button onclick="showDifficultySelection()" style="margin-top: 20px; padding: 15px 30px; background: #00897b; color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 1rem;">Practice Again</button>
                </div>
            `;
        }

        // Badge Collection
        const badges = [
            { id: 'first_login', name: 'Welcome!', icon: '', desc: 'First time login', unlocked: true },
            { id: 'first_question', name: 'Curious', icon: '', desc: 'Answer first question', unlocked: true },
            { id: 'streak_3', name: '3-Day Streak', icon: '', desc: '3 consecutive days', unlocked: true },
            { id: 'streak_7', name: 'Week Warrior', icon: '', desc: '7 consecutive days', unlocked: false },
            { id: 'xp_100', name: 'XP Hunter', icon: '', desc: 'Earn 100 XP', unlocked: true },
            { id: 'xp_500', name: 'XP Master', icon: '', desc: 'Earn 500 XP', unlocked: false },
            { id: 'perfect_quiz', name: 'Perfect!', icon: '', desc: '100% on a quiz', unlocked: true },
            { id: 'daily_10', name: 'Daily Hero', icon: '', desc: '10 daily challenges', unlocked: false },
            { id: 'notes_5', name: 'Note Taker', icon: '', desc: 'Save 5 notes', unlocked: true },
            { id: 'vocab_20', name: 'Wordsmith', icon: '', desc: 'Learn 20 words', unlocked: false },
            { id: 'hard_mode', name: 'Challenger', icon: '', desc: 'Complete hard practice', unlocked: false },
            { id: 'explorer', name: 'Explorer', icon: '', desc: 'Try all features', unlocked: false }
        ];

        function openBadgeCollection() {
            document.getElementById('badge-modal').style.display = 'flex';
            renderBadges();
        }

        function closeBadgeCollection() {
            document.getElementById('badge-modal').style.display = 'none';
        }

        function renderBadges() {
            const content = document.getElementById('badge-collection-content');
            const unlockedCount = badges.filter(b => b.unlocked).length;

            content.innerHTML = `
                <p style="color: #666; margin-bottom: 10px;">Collect badges by completing achievements!</p>
                <p style="color: #ff8f00; font-weight: bold; margin-bottom: 15px;">${unlockedCount} / ${badges.length} badges unlocked</p>
                <div class="badge-progress">
                    <div class="badge-progress-fill" style="width: ${(unlockedCount / badges.length) * 100}%;"></div>
                </div>
                <div class="badge-grid" style="margin-top: 20px;">
                    ${badges.map(b => `
                        <div class="badge-item ${b.unlocked ? 'unlocked' : 'locked'}" title="${b.desc}">
                            <div class="badge-icon">${b.icon}</div>
                            <div class="badge-name">${b.name}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        console.log(' Science Facts Carousel, Practice Mode, and Badge Collection loaded!');
    </script>

    <!-- Batch 65: Speed Quiz Button -->
    <button class="speed-quiz-btn" onclick="openSpeedQuiz()" title="Speed Quiz"></button>

    <!-- Speed Quiz Modal -->
    <div class="speed-modal" id="speed-modal">
        <div class="speed-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0; color: #d32f2f;"> Speed Quiz</h2>
                <button onclick="closeSpeedQuiz()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div id="speed-quiz-content"></div>
        </div>
    </div>

    <!-- Review Mistakes Button -->
    <button class="review-mistakes-btn" onclick="openReviewMistakes()" title="Review Mistakes"></button>

    <!-- Review Mistakes Modal -->
    <div class="mistakes-modal" id="mistakes-modal">
        <div class="mistakes-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #f44336;"> Review Mistakes</h2>
                <button onclick="closeReviewMistakes()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div id="mistakes-list"></div>
        </div>
    </div>

    <!-- Science Jokes Button -->
    <button class="jokes-btn" onclick="openScienceJokes()" title="Science Jokes"></button>

    <!-- Science Jokes Modal -->
    <div class="jokes-modal" id="jokes-modal">
        <div class="jokes-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #ff8f00;"> Science Jokes</h2>
                <button onclick="closeScienceJokes()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div class="joke-card" id="joke-card">
                <div class="joke-setup" id="joke-setup">Loading...</div>
                <div class="joke-punchline" id="joke-punchline"></div>
            </div>
            <button class="reveal-joke-btn" id="reveal-btn" onclick="revealPunchline()">Reveal Answer!</button>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px;">
                <button onclick="prevJoke()" style="padding: 10px 20px; background: #fff8e1; border: 2px solid #ffb300; border-radius: 20px; cursor: pointer;"> Previous</button>
                <button onclick="nextJoke()" style="padding: 10px 20px; background: #fff8e1; border: 2px solid #ffb300; border-radius: 20px; cursor: pointer;">Next </button>
            </div>
        </div>
    </div>

    <script>
        // Batch 65: Speed Quiz
        const speedQuizQuestions = [
            { q: 'H2O is?', opts: ['Water', 'Salt', 'Acid', 'Gas'], a: 0 },
            { q: 'Largest planet?', opts: ['Earth', 'Jupiter', 'Mars', 'Sun'], a: 1 },
            { q: 'Plants make?', opts: ['CO2', 'O2', 'N2', 'H2'], a: 1 },
            { q: 'Force unit?', opts: ['Watt', 'Joule', 'Newton', 'Volt'], a: 2 },
            { q: 'DNA shape?', opts: ['Helix', 'Circle', 'Square', 'Line'], a: 0 },
            { q: 'Speed of light?', opts: ['Slow', 'Fast', 'Medium', 'Varies'], a: 1 },
            { q: 'Cell powerhouse?', opts: ['Nucleus', 'Mitochondria', 'Ribosome', 'Membrane'], a: 1 },
            { q: 'Freezing point?', opts: ['0C', '100C', '50C', '-50C'], a: 0 },
            { q: 'Gravity discoverer?', opts: ['Einstein', 'Newton', 'Galileo', 'Darwin'], a: 1 },
            { q: 'Periodic table has?', opts: ['50', '100', '118', '200'], a: 2 },
            { q: 'Sound in vacuum?', opts: ['Fast', 'Slow', 'None', 'Normal'], a: 2 },
            { q: 'Blood color?', opts: ['Blue', 'Red', 'Green', 'Yellow'], a: 1 },
            { q: 'Sun is a?', opts: ['Planet', 'Star', 'Moon', 'Comet'], a: 1 },
            { q: 'Bones in body?', opts: ['106', '206', '306', '406'], a: 1 },
            { q: 'Photosynthesis needs?', opts: ['Dark', 'Light', 'Cold', 'Heat'], a: 1 }
        ];

        let speedTimer = null;
        let speedTimeLeft = 0;
        let speedQuestions = [];
        let speedIndex = 0;
        let speedScore = 0;
        let speedCorrect = 0;

        function openSpeedQuiz() {
            document.getElementById('speed-modal').style.display = 'flex';
            showSpeedStart();
        }

        function closeSpeedQuiz() {
            if (speedTimer) clearInterval(speedTimer);
            document.getElementById('speed-modal').style.display = 'none';
        }

        function showSpeedStart() {
            const content = document.getElementById('speed-quiz-content');
            content.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 4rem; margin-bottom: 15px;"></div>
                    <h3>Race Against Time!</h3>
                    <p style="color: #666; margin: 15px 0;">Answer as many questions as you can in 60 seconds!</p>
                    <div style="background: #ffebee; padding: 15px; border-radius: 10px; margin: 20px 0;">
                        <p style="margin: 0;"> 60 seconds</p>
                        <p style="margin: 5px 0 0 0;"> Quick fire questions</p>
                    </div>
                    <button onclick="startSpeedQuiz()" style="padding: 15px 40px; background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); color: white; border: none; border-radius: 25px; font-size: 1.2rem; cursor: pointer;">START!</button>
                </div>
            `;
        }

        function startSpeedQuiz() {
            speedQuestions = [...speedQuizQuestions].sort(() => Math.random() - 0.5);
            speedIndex = 0;
            speedScore = 0;
            speedCorrect = 0;
            speedTimeLeft = 60;
            showSpeedQuestion();
            speedTimer = setInterval(updateSpeedTimer, 1000);
        }

        function updateSpeedTimer() {
            speedTimeLeft--;
            const timerEl = document.getElementById('speed-timer');
            if (timerEl) {
                timerEl.textContent = speedTimeLeft;
                if (speedTimeLeft <= 10) timerEl.classList.add('warning');
            }
            if (speedTimeLeft <= 0) {
                clearInterval(speedTimer);
                showSpeedResults();
            }
        }

        function showSpeedQuestion() {
            const content = document.getElementById('speed-quiz-content');
            const q = speedQuestions[speedIndex % speedQuestions.length];
            content.innerHTML = `
                <div class="speed-timer ${speedTimeLeft <= 10 ? 'warning' : ''}" id="speed-timer">${speedTimeLeft}</div>
                <div class="speed-score-display">
                    <div class="speed-stat">
                        <div class="speed-stat-value">${speedCorrect}</div>
                        <div>Correct</div>
                    </div>
                    <div class="speed-stat">
                        <div class="speed-stat-value">${speedIndex}</div>
                        <div>Attempted</div>
                    </div>
                </div>
                <div class="speed-question">
                    <h3 style="margin: 0; color: #b71c1c;">${q.q}</h3>
                </div>
                ${q.opts.map((opt, i) => `
                    <button class="speed-option" onclick="answerSpeedQuiz(${i}, ${q.a})">${opt}</button>
                `).join('')}
            `;
        }

        function answerSpeedQuiz(selected, correct) {
            if (selected === correct) {
                speedCorrect++;
                speedScore += 10;
            }
            speedIndex++;
            if (speedTimeLeft > 0) {
                showSpeedQuestion();
            }
        }

        function showSpeedResults() {
            const content = document.getElementById('speed-quiz-content');
            const xpEarned = speedScore;
            addXP(xpEarned);

            content.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 4rem; margin-bottom: 15px;"></div>
                    <h2 style="color: #d32f2f;">Time's Up!</h2>
                    <div class="speed-score-display">
                        <div class="speed-stat">
                            <div class="speed-stat-value">${speedCorrect}</div>
                            <div>Correct</div>
                        </div>
                        <div class="speed-stat">
                            <div class="speed-stat-value">${speedIndex}</div>
                            <div>Attempted</div>
                        </div>
                        <div class="speed-stat">
                            <div class="speed-stat-value">${speedIndex > 0 ? Math.round((speedCorrect / speedIndex) * 100) : 0}%</div>
                            <div>Accuracy</div>
                        </div>
                    </div>
                    <p style="color: #4caf50; font-weight: bold; font-size: 1.2rem;">+${xpEarned} XP earned!</p>
                    <button onclick="startSpeedQuiz()" style="margin-top: 15px; padding: 12px 30px; background: #d32f2f; color: white; border: none; border-radius: 25px; cursor: pointer;">Try Again</button>
                </div>
            `;
        }

        // Review Mistakes
        let mistakesHistory = JSON.parse(localStorage.getItem('mistakesHistory') || '[]');

        // Sample mistakes if none exist
        if (mistakesHistory.length === 0) {
            mistakesHistory = [
                { q: 'What is the largest planet in our solar system?', yourAnswer: 'Saturn', correctAnswer: 'Jupiter' },
                { q: 'What gas do plants absorb during photosynthesis?', yourAnswer: 'Oxygen', correctAnswer: 'Carbon dioxide' },
                { q: 'Which planet is known as the Red Planet?', yourAnswer: 'Venus', correctAnswer: 'Mars' },
                { q: 'What is the chemical symbol for gold?', yourAnswer: 'Go', correctAnswer: 'Au' },
                { q: 'How many chromosomes do humans have?', yourAnswer: '48', correctAnswer: '46' }
            ];
        }

        function openReviewMistakes() {
            document.getElementById('mistakes-modal').style.display = 'flex';
            renderMistakes();
        }

        function closeReviewMistakes() {
            document.getElementById('mistakes-modal').style.display = 'none';
        }

        function renderMistakes() {
            const list = document.getElementById('mistakes-list');
            if (mistakesHistory.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 30px; color: #666;"><div style="font-size: 3rem; margin-bottom: 15px;"></div><p>No mistakes to review! Keep up the great work!</p></div>';
                return;
            }
            list.innerHTML = `
                <p style="color: #666; margin-bottom: 15px;">Learn from your mistakes to improve!</p>
                ${mistakesHistory.map(m => `
                    <div class="mistake-card">
                        <div class="mistake-question">${m.q}</div>
                        <div class="mistake-answers">
                            <span class="your-answer">Your: ${m.yourAnswer}</span>
                            <span class="correct-answer">Correct: ${m.correctAnswer}</span>
                        </div>
                    </div>
                `).join('')}
                <button onclick="clearMistakes()" style="width: 100%; margin-top: 15px; padding: 12px; background: #f44336; color: white; border: none; border-radius: 10px; cursor: pointer;">Clear All Mistakes</button>
            `;
        }

        function clearMistakes() {
            if (confirm('Clear all mistake history?')) {
                mistakesHistory = [];
                localStorage.setItem('mistakesHistory', JSON.stringify(mistakesHistory));
                renderMistakes();
            }
        }

        // Science Jokes
        const scienceJokes = [
            { setup: 'Why can you never trust atoms?', punchline: 'Because they make up everything!' },
            { setup: 'What did the biologist wear on their first date?', punchline: 'Designer genes!' },
            { setup: 'Why did the physics teacher break up with the biology teacher?', punchline: 'There was no chemistry!' },
            { setup: 'What do you call an educated tube?', punchline: 'A graduated cylinder!' },
            { setup: 'Why are chemists great at solving problems?', punchline: 'They have all the solutions!' },
            { setup: 'What did one ion say to another?', punchline: 'I\'ve got my ion you!' },
            { setup: 'Why did the photon check into a hotel?', punchline: 'It was traveling light!' },
            { setup: 'What\'s a physicist\'s favorite food?', punchline: 'Fission chips!' },
            { setup: 'Why do biologists look forward to casual Fridays?', punchline: 'They\'re allowed to wear genes to work!' },
            { setup: 'What did the scientist say when he found 2 isotopes of helium?', punchline: 'HeHe!' },
            { setup: 'Why can\'t you trust an atom?', punchline: 'They literally make up everything!' },
            { setup: 'What do you call a tooth in a glass of water?', punchline: 'A one molar solution!' }
        ];

        let currentJokeIndex = 0;

        function openScienceJokes() {
            document.getElementById('jokes-modal').style.display = 'flex';
            showJoke();
        }

        function closeScienceJokes() {
            document.getElementById('jokes-modal').style.display = 'none';
        }

        function showJoke() {
            const joke = scienceJokes[currentJokeIndex];
            document.getElementById('joke-setup').textContent = joke.setup;
            document.getElementById('joke-punchline').textContent = joke.punchline;
            document.getElementById('joke-punchline').classList.remove('revealed');
            document.getElementById('reveal-btn').style.display = 'block';
        }

        function revealPunchline() {
            document.getElementById('joke-punchline').classList.add('revealed');
            document.getElementById('reveal-btn').style.display = 'none';
            addXP(1);
        }

        function nextJoke() {
            currentJokeIndex = (currentJokeIndex + 1) % scienceJokes.length;
            showJoke();
        }

        function prevJoke() {
            currentJokeIndex = (currentJokeIndex - 1 + scienceJokes.length) % scienceJokes.length;
            showJoke();
        }

        console.log(' Speed Quiz, Review Mistakes, and Science Jokes loaded!');
    </script>

    <!-- Batch 66: Topic Explorer Button -->
    <button class="topic-explorer-btn" onclick="openTopicExplorer()" title="Topic Explorer"></button>

    <!-- Topic Explorer Modal -->
    <div class="explorer-modal" id="explorer-modal">
        <div class="explorer-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #1565c0;"> Topic Explorer</h2>
                <button onclick="closeTopicExplorer()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div id="explorer-content"></div>
        </div>
    </div>

    <!-- Question Bank Button -->
    <button class="question-bank-btn" onclick="openQuestionBank()" title="Question Bank"></button>

    <!-- Question Bank Modal -->
    <div class="bank-modal" id="bank-modal">
        <div class="bank-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #5e35b1;"> Question Bank</h2>
                <button onclick="closeQuestionBank()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div id="bank-content"></div>
        </div>
    </div>

    <!-- Study Streak Calendar Button -->
    <button class="streak-calendar-btn" onclick="openStreakCalendar()" title="Study Streak"></button>

    <!-- Study Streak Calendar Modal -->
    <div class="calendar-modal" id="calendar-modal">
        <div class="calendar-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #43a047;"> Study Streak</h2>
                <button onclick="closeStreakCalendar()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div id="calendar-content"></div>
        </div>
    </div>

    <script>
        // Batch 66: Topic Explorer
        const explorerTopics = {
            physics: {
                icon: '',
                name: 'Physics',
                description: 'The study of matter, energy, and their interactions',
                facts: [
                    'Light is both a particle and a wave',
                    'Nothing can travel faster than the speed of light',
                    'Gravity bends light around massive objects',
                    'Energy cannot be created or destroyed, only transformed',
                    'Sound cannot travel through a vacuum'
                ]
            },
            chemistry: {
                icon: '',
                name: 'Chemistry',
                description: 'The study of matter and the changes it undergoes',
                facts: [
                    'There are 118 known elements on the periodic table',
                    'Water is the only substance that naturally exists in all three states',
                    'Diamonds and graphite are both made of pure carbon',
                    'The human body contains enough carbon to make 9,000 pencils',
                    'Gold is so malleable that one gram can be stretched to 165 meters'
                ]
            },
            biology: {
                icon: '',
                name: 'Biology',
                description: 'The study of living organisms and life processes',
                facts: [
                    'Human DNA is 99.9% identical to every other human',
                    'Your brain uses 20% of your body\'s oxygen and calories',
                    'Red blood cells travel 12,000 miles daily through your body',
                    'The average person has 100,000 hairs on their head',
                    'Your bones are stronger than steel by weight'
                ]
            },
            earth: {
                icon: '',
                name: 'Earth Science',
                description: 'The study of Earth and its atmosphere',
                facts: [
                    'Earth\'s core is as hot as the surface of the Sun',
                    'More than 70% of Earth\'s surface is covered by water',
                    'The oldest rocks on Earth are about 4 billion years old',
                    'Earth\'s atmosphere extends about 6,200 miles into space',
                    'Lightning strikes Earth about 100 times per second'
                ]
            }
        };

        function openTopicExplorer() {
            document.getElementById('explorer-modal').style.display = 'flex';
            showTopicSelection();
        }

        function closeTopicExplorer() {
            document.getElementById('explorer-modal').style.display = 'none';
        }

        function showTopicSelection() {
            const content = document.getElementById('explorer-content');
            content.innerHTML = `
                <p style="color: #666; margin-bottom: 15px;">Choose a topic to explore in depth:</p>
                <div class="explorer-topic-grid">
                    ${Object.entries(explorerTopics).map(([key, topic]) => `
                        <div class="explorer-topic-card" onclick="exploreTopic('${key}')">
                            <div class="explorer-topic-icon">${topic.icon}</div>
                            <div style="font-weight: bold;">${topic.name}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function exploreTopic(topicKey) {
            const topic = explorerTopics[topicKey];
            const content = document.getElementById('explorer-content');
            content.innerHTML = `
                <button onclick="showTopicSelection()" style="margin-bottom: 15px; padding: 8px 16px; background: #e3f2fd; border: none; border-radius: 20px; cursor: pointer;"> Back to Topics</button>
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3rem;">${topic.icon}</div>
                    <h3 style="margin: 10px 0; color: #1565c0;">${topic.name}</h3>
                    <p style="color: #666;">${topic.description}</p>
                </div>
                <div class="topic-detail-box">
                    <h4 style="margin: 0 0 15px 0; color: #0d47a1;">Key Facts</h4>
                    ${topic.facts.map(fact => `<div class="topic-fact">${fact}</div>`).join('')}
                </div>
            `;
            addXP(3);
        }

        // Question Bank
        const questionBankData = [
            { category: 'Physics', q: 'What is the SI unit of force?', a: 'Newton' },
            { category: 'Physics', q: 'What is the speed of light?', a: '310 m/s' },
            { category: 'Physics', q: 'What is Newton\'s first law?', a: 'Law of Inertia' },
            { category: 'Chemistry', q: 'What is the pH of neutral water?', a: '7' },
            { category: 'Chemistry', q: 'What is the chemical symbol for gold?', a: 'Au' },
            { category: 'Chemistry', q: 'How many elements are in the periodic table?', a: '118' },
            { category: 'Biology', q: 'What is the powerhouse of the cell?', a: 'Mitochondria' },
            { category: 'Biology', q: 'What carries genetic information?', a: 'DNA' },
            { category: 'Biology', q: 'How many chromosomes do humans have?', a: '46' },
            { category: 'Earth', q: 'What causes tides?', a: 'Moon\'s gravity' },
            { category: 'Earth', q: 'What is the outer layer of Earth?', a: 'Crust' },
            { category: 'Earth', q: 'What scale measures earthquakes?', a: 'Richter scale' }
        ];

        let bankFilter = 'all';

        function openQuestionBank() {
            document.getElementById('bank-modal').style.display = 'flex';
            renderQuestionBank();
        }

        function closeQuestionBank() {
            document.getElementById('bank-modal').style.display = 'none';
        }

        function setFilter(filter) {
            bankFilter = filter;
            renderQuestionBank();
        }

        function renderQuestionBank() {
            const content = document.getElementById('bank-content');
            const categories = ['all', 'Physics', 'Chemistry', 'Biology', 'Earth'];
            const filtered = bankFilter === 'all' ? questionBankData : questionBankData.filter(q => q.category === bankFilter);

            content.innerHTML = `
                <div class="bank-filter">
                    ${categories.map(cat => `
                        <button class="bank-filter-btn ${bankFilter === cat ? 'active' : ''}" onclick="setFilter('${cat}')">${cat === 'all' ? 'All' : cat}</button>
                    `).join('')}
                </div>
                <p style="color: #666; margin-bottom: 10px;">${filtered.length} questions found</p>
                ${filtered.map(q => `
                    <div class="bank-question-card" onclick="alert('Answer: ${q.a}')">
                        <div class="bank-question-category">${q.category}</div>
                        <div>${q.q}</div>
                    </div>
                `).join('')}
            `;
        }

        // Study Streak Calendar
        function openStreakCalendar() {
            document.getElementById('calendar-modal').style.display = 'flex';
            renderCalendar();
        }

        function closeStreakCalendar() {
            document.getElementById('calendar-modal').style.display = 'none';
        }

        function renderCalendar() {
            const content = document.getElementById('calendar-content');
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const today = now.getDate();

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            // Simulate active days (streak data)
            const activeDays = [1, 2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 13];
            const currentStreak = parseInt(localStorage.getItem('loginStreak') || '5');
            const longestStreak = parseInt(localStorage.getItem('longestStreak') || '12');
            const totalDays = activeDays.length;

            let calendarHTML = `
                <h3 style="text-align: center; color: #2e7d32; margin-bottom: 15px;">${monthNames[month]} ${year}</h3>
                <div class="calendar-grid">
                    <div class="calendar-day-header">S</div>
                    <div class="calendar-day-header">M</div>
                    <div class="calendar-day-header">T</div>
                    <div class="calendar-day-header">W</div>
                    <div class="calendar-day-header">T</div>
                    <div class="calendar-day-header">F</div>
                    <div class="calendar-day-header">S</div>
            `;

            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="calendar-day empty"></div>';
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const isActive = activeDays.includes(day);
                const isToday = day === today;
                calendarHTML += `<div class="calendar-day ${isActive ? 'active' : ''} ${isToday ? 'today' : ''}">${day}</div>`;
            }

            calendarHTML += `
                </div>
                <div class="streak-stats">
                    <div class="streak-stat">
                        <div class="streak-stat-value">${currentStreak}</div>
                        <div class="streak-stat-label">Current Streak</div>
                    </div>
                    <div class="streak-stat">
                        <div class="streak-stat-value">${longestStreak}</div>
                        <div class="streak-stat-label">Longest Streak</div>
                    </div>
                    <div class="streak-stat">
                        <div class="streak-stat-value">${totalDays}</div>
                        <div class="streak-stat-label">Total Days</div>
                    </div>
                </div>
            `;

            content.innerHTML = calendarHTML;
        }

        console.log(' Topic Explorer, Question Bank, and Study Streak Calendar loaded!');
    </script>

    <!-- Batch 67: Hint System Button -->
    <button class="hint-system-btn" onclick="openHintSystem()" title="Hint Quiz"></button>

    <!-- Hint System Modal -->
    <div class="hint-modal" id="hint-modal">
        <div class="hint-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #00acc1;"> Hint Quiz</h2>
                <button onclick="closeHintSystem()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div id="hint-quiz-content"></div>
        </div>
    </div>

    <!-- Revision Notes Button -->
    <button class="revision-notes-btn" onclick="openRevisionNotes()" title="Revision Notes"></button>

    <!-- Revision Notes Modal -->
    <div class="revision-modal" id="revision-modal">
        <div class="revision-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #7cb342;"> Revision Notes</h2>
                <button onclick="closeRevisionNotes()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div id="revision-content"></div>
        </div>
    </div>

    <!-- Score History Button -->
    <button class="score-history-btn" onclick="openScoreHistory()" title="Score History"></button>

    <!-- Score History Modal -->
    <div class="history-modal" id="history-modal">
        <div class="history-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #ab47bc;"> Score History</h2>
                <button onclick="closeScoreHistory()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            <div id="history-content"></div>
        </div>
    </div>

    <script>
        // Batch 67: Hint System
        const hintQuestions = [
            { q: 'What is the powerhouse of the cell?', opts: ['Nucleus', 'Mitochondria', 'Ribosome', 'Golgi'], a: 1, hint: 'It produces ATP energy' },
            { q: 'What is the chemical symbol for gold?', opts: ['Go', 'Gd', 'Au', 'Ag'], a: 2, hint: 'It comes from the Latin word "Aurum"' },
            { q: 'What force keeps planets in orbit?', opts: ['Magnetism', 'Friction', 'Gravity', 'Electricity'], a: 2, hint: 'Isaac Newton discovered this force' },
            { q: 'What is the pH of neutral water?', opts: ['0', '7', '14', '1'], a: 1, hint: 'It\'s right in the middle of the scale' },
            { q: 'Which planet is largest?', opts: ['Saturn', 'Neptune', 'Jupiter', 'Uranus'], a: 2, hint: 'It has a famous red spot' }
        ];

        let hintQIndex = 0;
        let hintShown = false;
        let eliminatedOptions = [];
        let hintsRemaining = 3;

        function openHintSystem() {
            document.getElementById('hint-modal').style.display = 'flex';
            hintQIndex = 0;
            hintsRemaining = 3;
            showHintQuestion();
        }

        function closeHintSystem() {
            document.getElementById('hint-modal').style.display = 'none';
        }

        function showHintQuestion() {
            const content = document.getElementById('hint-quiz-content');
            const q = hintQuestions[hintQIndex];
            hintShown = false;
            eliminatedOptions = [];

            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: #666;">Question ${hintQIndex + 1} of ${hintQuestions.length}</span>
                    <span style="color: #00acc1; font-weight: bold;">Hints: ${hintsRemaining}</span>
                </div>
                <div class="hint-question-box">
                    <h3 style="margin: 0; color: #00838f;">${q.q}</h3>
                </div>
                <div id="hint-options">
                    ${q.opts.map((opt, i) => `
                        <button class="hint-option" id="hint-opt-${i}" onclick="answerHintQuiz(${i}, ${q.a})">${opt}</button>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="useHint()" style="flex: 1; padding: 12px; background: ${hintsRemaining > 0 ? '#00acc1' : '#ccc'}; color: white; border: none; border-radius: 10px; cursor: ${hintsRemaining > 0 ? 'pointer' : 'not-allowed'};" ${hintsRemaining <= 0 ? 'disabled' : ''}> Use Hint</button>
                    <button onclick="eliminate5050()" style="flex: 1; padding: 12px; background: ${hintsRemaining > 0 ? '#ff9800' : '#ccc'}; color: white; border: none; border-radius: 10px; cursor: ${hintsRemaining > 0 ? 'pointer' : 'not-allowed'};" ${hintsRemaining <= 0 ? 'disabled' : ''}>50/50</button>
                </div>
                <div id="hint-display" style="display: none;"></div>
            `;
        }

        function useHint() {
            if (hintsRemaining <= 0 || hintShown) return;
            hintsRemaining--;
            hintShown = true;
            const q = hintQuestions[hintQIndex];
            document.getElementById('hint-display').style.display = 'block';
            document.getElementById('hint-display').innerHTML = `
                <div class="hint-box">
                    <div class="hint-icon"></div>
                    <div class="hint-text">${q.hint}</div>
                </div>
            `;
            showHintQuestion();
        }

        function eliminate5050() {
            if (hintsRemaining <= 0 || eliminatedOptions.length > 0) return;
            hintsRemaining--;
            const q = hintQuestions[hintQIndex];
            const wrongOptions = [0, 1, 2, 3].filter(i => i !== q.a);
            eliminatedOptions = wrongOptions.sort(() => Math.random() - 0.5).slice(0, 2);
            eliminatedOptions.forEach(i => {
                document.getElementById(`hint-opt-${i}`).classList.add('eliminated');
                document.getElementById(`hint-opt-${i}`).disabled = true;
            });
            showHintQuestion();
        }

        function answerHintQuiz(selected, correct) {
            const isCorrect = selected === correct;
            hintQIndex++;
            if (hintQIndex < hintQuestions.length) {
                setTimeout(showHintQuestion, 500);
            } else {
                showHintResults(isCorrect);
            }
            if (isCorrect) addXP(10);
        }

        function showHintResults(lastCorrect) {
            const content = document.getElementById('hint-quiz-content');
            content.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 4rem; margin-bottom: 15px;"></div>
                    <h2 style="color: #00acc1;">Quiz Complete!</h2>
                    <p>You used ${3 - hintsRemaining} hints</p>
                    <button onclick="openHintSystem()" style="margin-top: 20px; padding: 12px 30px; background: #00acc1; color: white; border: none; border-radius: 25px; cursor: pointer;">Play Again</button>
                </div>
            `;
        }

        // Revision Notes
        const revisionNotes = {
            physics: {
                name: 'Physics',
                notes: [
                    { title: 'Newton\'s Laws', content: '1st: Objects at rest stay at rest. 2nd: F=ma. 3rd: Every action has an equal and opposite reaction.' },
                    { title: 'Energy Types', content: 'Kinetic (motion), Potential (stored), Thermal (heat), Electrical, Chemical, Nuclear, Sound, Light.' },
                    { title: 'Waves', content: 'Transverse waves move perpendicular to energy. Longitudinal waves move parallel. Wave speed = frequency  wavelength.' },
                    { title: 'Electricity', content: 'Current (I) = Charge/Time. Voltage (V) = Energy/Charge. Resistance (R) opposes current. Ohm\'s Law: V=IR.' }
                ]
            },
            chemistry: {
                name: 'Chemistry',
                notes: [
                    { title: 'Atomic Structure', content: 'Atoms have protons (+), neutrons (neutral) in nucleus, and electrons (-) in shells. Atomic number = protons.' },
                    { title: 'Chemical Bonding', content: 'Ionic: electron transfer. Covalent: electron sharing. Metallic: sea of electrons.' },
                    { title: 'Acids & Bases', content: 'Acids: pH < 7, donate H+. Bases: pH > 7, accept H+. Neutralization produces salt + water.' },
                    { title: 'Reactions', content: 'Exothermic releases energy. Endothermic absorbs energy. Catalysts speed up reactions without being consumed.' }
                ]
            },
            biology: {
                name: 'Biology',
                notes: [
                    { title: 'Cell Structure', content: 'Nucleus: DNA storage. Mitochondria: energy. Ribosomes: protein synthesis. Cell membrane: barrier.' },
                    { title: 'Photosynthesis', content: '6CO + 6HO + light  CHO + 6O. Occurs in chloroplasts using chlorophyll.' },
                    { title: 'Respiration', content: 'CHO + 6O  6CO + 6HO + ATP. Occurs in mitochondria. Releases energy for cells.' },
                    { title: 'DNA & Genetics', content: 'DNA = deoxyribonucleic acid. Double helix structure. A-T, G-C base pairs. Genes code for proteins.' }
                ]
            },
            earth: {
                name: 'Earth Science',
                notes: [
                    { title: 'Rock Cycle', content: 'Igneous: cooled magma. Sedimentary: compressed sediments. Metamorphic: heat/pressure changed.' },
                    { title: 'Plate Tectonics', content: 'Earth\'s crust is broken into plates. Convergent, divergent, and transform boundaries cause earthquakes/volcanoes.' },
                    { title: 'Atmosphere', content: '78% nitrogen, 21% oxygen. Layers: troposphere, stratosphere, mesosphere, thermosphere, exosphere.' },
                    { title: 'Water Cycle', content: 'Evaporation  Condensation  Precipitation  Collection. Drives weather patterns globally.' }
                ]
            }
        };

        function openRevisionNotes() {
            document.getElementById('revision-modal').style.display = 'flex';
            renderRevisionNotes('physics');
        }

        function closeRevisionNotes() {
            document.getElementById('revision-modal').style.display = 'none';
        }

        function renderRevisionNotes(topic) {
            const content = document.getElementById('revision-content');
            const notes = revisionNotes[topic];

            content.innerHTML = `
                <select class="revision-topic-select" onchange="renderRevisionNotes(this.value)">
                    ${Object.entries(revisionNotes).map(([key, val]) => `
                        <option value="${key}" ${key === topic ? 'selected' : ''}>${val.name}</option>
                    `).join('')}
                </select>
                <h3 style="color: #558b2f; margin-bottom: 15px;">${notes.name} Key Points</h3>
                ${notes.notes.map(note => `
                    <div class="revision-card">
                        <div class="revision-card-title">${note.title}</div>
                        <div class="revision-card-content">${note.content}</div>
                    </div>
                `).join('')}
            `;
        }

        // Score History
        const scoreHistory = [
            { date: 'Jan 13', type: 'Daily Challenge', score: '100%' },
            { date: 'Jan 12', type: 'Speed Quiz', score: '85%' },
            { date: 'Jan 12', type: 'Topic Quiz', score: '4/5' },
            { date: 'Jan 11', type: 'Practice Mode', score: '90%' },
            { date: 'Jan 10', type: 'Daily Challenge', score: '100%' },
            { date: 'Jan 9', type: 'Speed Quiz', score: '70%' },
            { date: 'Jan 8', type: 'Topic Quiz', score: '3/5' },
            { date: 'Jan 7', type: 'Practice Mode', score: '95%' }
        ];

        function openScoreHistory() {
            document.getElementById('history-modal').style.display = 'flex';
            renderScoreHistory();
        }

        function closeScoreHistory() {
            document.getElementById('history-modal').style.display = 'none';
        }

        function renderScoreHistory() {
            const content = document.getElementById('history-content');
            const scores = [85, 70, 100, 90, 75, 95, 80];

            content.innerHTML = `
                <div class="history-chart">
                    ${scores.map(s => `<div class="history-bar" style="height: ${s}%;"></div>`).join('')}
                </div>
                <p style="text-align: center; color: #666; margin-bottom: 15px;">Last 7 sessions</p>
                ${scoreHistory.map(entry => `
                    <div class="history-entry">
                        <div>
                            <div class="history-entry-type">${entry.type}</div>
                            <div class="history-entry-date">${entry.date}</div>
                        </div>
                        <div class="history-entry-score">${entry.score}</div>
                    </div>
                `).join('')}
            `;
        }

        console.log(' Hint System, Revision Notes, and Score History loaded!');
    </script>

    <!-- Batch 68: Matching Game Button -->
    <button class="matching-game-btn" onclick="openMatchingGame()" title="Matching Game">
        
    </button>

    <!-- Matching Game Modal -->
    <div class="matching-modal" id="matchingModal">
        <div class="matching-modal-content">
            <div class="matching-modal-header">
                <h3> Matching Game</h3>
                <button class="matching-close-btn" onclick="closeMatchingGame()"></button>
            </div>
            <div class="matching-modal-body">
                <div class="matching-stats">
                    <span id="matchingScore">Matches: 0/6</span>
                    <span id="matchingTimer">Time: 0s</span>
                </div>
                <div class="matching-columns" id="matchingColumns"></div>
                <div class="matching-actions">
                    <button class="matching-action-btn" onclick="startMatchingGame()"> New Game</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Random Question Generator Button -->
    <button class="random-question-btn" onclick="openRandomQuestion()" title="Random Question">
        
    </button>

    <!-- Random Question Modal -->
    <div class="random-modal" id="randomQuestionModal">
        <div class="random-modal-content">
            <div class="random-modal-header">
                <h3> Random Question</h3>
                <button class="random-close-btn" onclick="closeRandomQuestion()"></button>
            </div>
            <div class="random-modal-body">
                <div class="random-question-box" id="randomQuestionBox">
                    <div class="random-category" id="randomCategory">Physics</div>
                    <div class="random-question" id="randomQuestionText">Click generate to get a random question!</div>
                    <div class="random-options" id="randomOptions"></div>
                    <div class="random-feedback" id="randomFeedback"></div>
                </div>
                <div class="random-actions">
                    <button class="random-action-btn generate" onclick="generateRandomQuestion()"> Generate</button>
                    <button class="random-action-btn stats" onclick="showRandomStats()"> Stats</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Study Tips Button -->
    <button class="study-tips-btn" onclick="openStudyTips()" title="Study Tips">
        
    </button>

    <!-- Study Tips Modal -->
    <div class="tips-modal" id="studyTipsModal">
        <div class="tips-modal-content">
            <div class="tips-modal-header">
                <h3> Study Tips</h3>
                <button class="tips-close-btn" onclick="closeStudyTips()"></button>
            </div>
            <div class="tips-modal-body">
                <div class="tips-categories">
                    <button class="tips-cat-btn active" onclick="showTipCategory('memory')"> Memory</button>
                    <button class="tips-cat-btn" onclick="showTipCategory('focus')"> Focus</button>
                    <button class="tips-cat-btn" onclick="showTipCategory('exam')"> Exam</button>
                </div>
                <div class="tips-container" id="tipsContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // Batch 68: Matching Game, Random Question Generator, Study Tips

        // Matching Game Data
        const matchingPairs = [
            { term: 'Photosynthesis', definition: 'Plants make food using sunlight' },
            { term: 'Gravity', definition: 'Force that attracts objects to Earth' },
            { term: 'Atom', definition: 'Smallest unit of matter' },
            { term: 'Evaporation', definition: 'Liquid becomes gas' },
            { term: 'Friction', definition: 'Force that resists motion' },
            { term: 'Ecosystem', definition: 'Community of living organisms' },
            { term: 'Magnetism', definition: 'Force from magnetic fields' },
            { term: 'Condensation', definition: 'Gas becomes liquid' },
            { term: 'Reflection', definition: 'Light bounces off surface' },
            { term: 'Respiration', definition: 'Cells release energy from food' },
            { term: 'Density', definition: 'Mass per unit volume' },
            { term: 'Velocity', definition: 'Speed in a direction' }
        ];

        let matchingState = {
            selected: null,
            matches: 0,
            timer: 0,
            interval: null,
            pairs: []
        };

        function openMatchingGame() {
            document.getElementById('matchingModal').classList.add('active');
            startMatchingGame();
        }

        function closeMatchingGame() {
            document.getElementById('matchingModal').classList.remove('active');
            if (matchingState.interval) clearInterval(matchingState.interval);
        }

        function startMatchingGame() {
            matchingState.matches = 0;
            matchingState.timer = 0;
            matchingState.selected = null;
            if (matchingState.interval) clearInterval(matchingState.interval);

            // Select 6 random pairs
            const shuffled = [...matchingPairs].sort(() => Math.random() - 0.5);
            matchingState.pairs = shuffled.slice(0, 6);

            // Create shuffled terms and definitions
            const terms = matchingState.pairs.map((p, i) => ({ text: p.term, idx: i, type: 'term' }));
            const defs = matchingState.pairs.map((p, i) => ({ text: p.definition, idx: i, type: 'def' }));
            terms.sort(() => Math.random() - 0.5);
            defs.sort(() => Math.random() - 0.5);

            const container = document.getElementById('matchingColumns');
            container.innerHTML = `
                <div class="matching-column">
                    <h4>Terms</h4>
                    ${terms.map(t => `
                        <div class="matching-item term" data-idx="${t.idx}" onclick="selectMatchingItem(this, 'term', ${t.idx})">
                            ${t.text}
                        </div>
                    `).join('')}
                </div>
                <div class="matching-column">
                    <h4>Definitions</h4>
                    ${defs.map(d => `
                        <div class="matching-item def" data-idx="${d.idx}" onclick="selectMatchingItem(this, 'def', ${d.idx})">
                            ${d.text}
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('matchingScore').textContent = 'Matches: 0/6';

            matchingState.interval = setInterval(() => {
                matchingState.timer++;
                document.getElementById('matchingTimer').textContent = `Time: ${matchingState.timer}s`;
            }, 1000);
        }

        function selectMatchingItem(el, type, idx) {
            if (el.classList.contains('matched')) return;

            if (!matchingState.selected) {
                document.querySelectorAll('.matching-item').forEach(i => i.classList.remove('selected'));
                el.classList.add('selected');
                matchingState.selected = { el, type, idx };
            } else {
                if (matchingState.selected.type === type) {
                    document.querySelectorAll('.matching-item').forEach(i => i.classList.remove('selected'));
                    el.classList.add('selected');
                    matchingState.selected = { el, type, idx };
                } else {
                    // Check match
                    if (matchingState.selected.idx === idx) {
                        matchingState.selected.el.classList.add('matched');
                        matchingState.selected.el.classList.remove('selected');
                        el.classList.add('matched');
                        matchingState.matches++;
                        document.getElementById('matchingScore').textContent = `Matches: ${matchingState.matches}/6`;

                        if (matchingState.matches === 6) {
                            clearInterval(matchingState.interval);
                            const xp = Math.max(10, 60 - matchingState.timer);
                            addXP(xp);
                            setTimeout(() => {
                                alert(` Perfect! Completed in ${matchingState.timer}s! +${xp} XP`);
                            }, 300);
                        }
                    } else {
                        matchingState.selected.el.classList.add('wrong');
                        el.classList.add('wrong');
                        setTimeout(() => {
                            matchingState.selected.el.classList.remove('wrong', 'selected');
                            el.classList.remove('wrong');
                        }, 500);
                    }
                    matchingState.selected = null;
                }
            }
        }

        // Random Question Generator
        const randomQuestions = [
            { category: 'Physics', q: 'What is the unit of force?', options: ['Newton', 'Joule', 'Watt', 'Pascal'], answer: 0 },
            { category: 'Physics', q: 'Light travels fastest in which medium?', options: ['Water', 'Glass', 'Vacuum', 'Air'], answer: 2 },
            { category: 'Physics', q: 'What type of energy does a moving car have?', options: ['Potential', 'Kinetic', 'Thermal', 'Chemical'], answer: 1 },
            { category: 'Chemistry', q: 'What is the chemical symbol for Gold?', options: ['Go', 'Gd', 'Au', 'Ag'], answer: 2 },
            { category: 'Chemistry', q: 'How many elements are in H2O?', options: ['1', '2', '3', '4'], answer: 1 },
            { category: 'Chemistry', q: 'What gas do plants release during photosynthesis?', options: ['CO2', 'N2', 'O2', 'H2'], answer: 2 },
            { category: 'Biology', q: 'What is the powerhouse of the cell?', options: ['Nucleus', 'Ribosome', 'Mitochondria', 'Golgi'], answer: 2 },
            { category: 'Biology', q: 'How many chambers does the human heart have?', options: ['2', '3', '4', '5'], answer: 2 },
            { category: 'Biology', q: 'What carries oxygen in blood?', options: ['Plasma', 'White cells', 'Red cells', 'Platelets'], answer: 2 },
            { category: 'Earth Science', q: 'What layer of Earth do we live on?', options: ['Core', 'Mantle', 'Crust', 'Asthenosphere'], answer: 2 },
            { category: 'Earth Science', q: 'What causes tides?', options: ['Wind', 'Moon gravity', 'Earth rotation', 'Sun heat'], answer: 1 },
            { category: 'Earth Science', q: 'What is magma called when it reaches surface?', options: ['Rock', 'Lava', 'Ite', 'Stone'], answer: 1 }
        ];

        let randomQStats = JSON.parse(localStorage.getItem('randomQStats') || '{"correct":0,"total":0}');
        let currentRandomQ = null;

        function openRandomQuestion() {
            document.getElementById('randomQuestionModal').classList.add('active');
            document.getElementById('randomFeedback').innerHTML = '';
            document.getElementById('randomOptions').innerHTML = '<p style="color:#888;text-align:center;">Click Generate to start!</p>';
        }

        function closeRandomQuestion() {
            document.getElementById('randomQuestionModal').classList.remove('active');
        }

        function generateRandomQuestion() {
            currentRandomQ = randomQuestions[Math.floor(Math.random() * randomQuestions.length)];
            document.getElementById('randomCategory').textContent = currentRandomQ.category;
            document.getElementById('randomQuestionText').textContent = currentRandomQ.q;
            document.getElementById('randomFeedback').innerHTML = '';

            document.getElementById('randomOptions').innerHTML = currentRandomQ.options.map((opt, i) => `
                <button class="random-option-btn" onclick="answerRandomQ(${i})">${opt}</button>
            `).join('');
        }

        function answerRandomQ(idx) {
            if (!currentRandomQ) return;

            randomQStats.total++;
            const feedback = document.getElementById('randomFeedback');
            const btns = document.querySelectorAll('.random-option-btn');

            btns.forEach((btn, i) => {
                btn.disabled = true;
                if (i === currentRandomQ.answer) btn.style.background = '#4caf50';
                if (i === idx && idx !== currentRandomQ.answer) btn.style.background = '#f44336';
            });

            if (idx === currentRandomQ.answer) {
                randomQStats.correct++;
                feedback.innerHTML = '<span style="color:#4caf50;"> Correct! +10 XP</span>';
                addXP(10);
            } else {
                feedback.innerHTML = `<span style="color:#f44336;"> Wrong! Answer: ${currentRandomQ.options[currentRandomQ.answer]}</span>`;
            }

            localStorage.setItem('randomQStats', JSON.stringify(randomQStats));
            currentRandomQ = null;
        }

        function showRandomStats() {
            const pct = randomQStats.total > 0 ? Math.round((randomQStats.correct / randomQStats.total) * 100) : 0;
            document.getElementById('randomQuestionText').textContent = ` Your Stats`;
            document.getElementById('randomCategory').textContent = 'Statistics';
            document.getElementById('randomOptions').innerHTML = `
                <div style="text-align:center;padding:15px;">
                    <p><strong>Total Questions:</strong> ${randomQStats.total}</p>
                    <p><strong>Correct:</strong> ${randomQStats.correct}</p>
                    <p><strong>Accuracy:</strong> ${pct}%</p>
                    <div style="background:#eee;height:20px;border-radius:10px;margin-top:10px;">
                        <div style="background:linear-gradient(90deg,#4caf50,#8bc34a);height:100%;width:${pct}%;border-radius:10px;transition:width 0.5s;"></div>
                    </div>
                </div>
            `;
            document.getElementById('randomFeedback').innerHTML = '';
        }

        // Study Tips
        const studyTips = {
            memory: [
                { icon: '', title: 'Spaced Repetition', tip: 'Review material at increasing intervals: 1 day, 3 days, 1 week, 2 weeks.' },
                { icon: '', title: 'Visual Mnemonics', tip: 'Create mental images or drawings to remember concepts.' },
                { icon: '', title: 'Teach Others', tip: 'Explaining concepts to someone else strengthens your memory.' },
                { icon: '', title: 'Connect Ideas', tip: 'Link new information to things you already know well.' }
            ],
            focus: [
                { icon: '', title: 'Pomodoro Technique', tip: 'Study for 25 mins, break for 5 mins. Repeat 4 times, then longer break.' },
                { icon: '', title: 'Remove Distractions', tip: 'Put phone away and close unnecessary browser tabs while studying.' },
                { icon: '', title: 'Set Clear Goals', tip: 'Define exactly what you want to accomplish in each study session.' },
                { icon: '', title: 'Get Enough Sleep', tip: '8 hours of sleep helps consolidate memories and improve focus.' }
            ],
            exam: [
                { icon: '', title: 'Practice Past Papers', tip: 'Solve previous exam questions under timed conditions.' },
                { icon: '', title: 'Understand Mark Schemes', tip: 'Learn what examiners look for in answers.' },
                { icon: '', title: 'Time Management', tip: 'Allocate time per question based on marks available.' },
                { icon: '', title: 'Read Questions Carefully', tip: 'Underline key words and ensure you answer what is asked.' }
            ]
        };

        function openStudyTips() {
            document.getElementById('studyTipsModal').classList.add('active');
            showTipCategory('memory');
        }

        function closeStudyTips() {
            document.getElementById('studyTipsModal').classList.remove('active');
        }

        function showTipCategory(category) {
            document.querySelectorAll('.tips-cat-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const tips = studyTips[category];
            document.getElementById('tipsContainer').innerHTML = tips.map(t => `
                <div class="tip-card">
                    <div class="tip-icon">${t.icon}</div>
                    <div class="tip-content">
                        <h4>${t.title}</h4>
                        <p>${t.tip}</p>
                    </div>
                </div>
            `).join('');
        }

        console.log(' Matching Game, Random Question Generator, and Study Tips loaded!');
    </script>

    <!-- Batch 69: Memory Card Game Button -->
    <button class="memory-card-btn" onclick="openMemoryGame()" title="Memory Card Game">
        
    </button>

    <!-- Memory Card Game Modal -->
    <div class="memory-modal" id="memoryGameModal">
        <div class="memory-modal-content">
            <div class="memory-modal-header">
                <h3> Memory Card Game</h3>
                <button class="memory-close-btn" onclick="closeMemoryGame()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="memory-modal-body">
                <div class="memory-stats">
                    <span id="memoryMoves">Moves: 0</span>
                    <span id="memoryPairs">Pairs: 0/8</span>
                </div>
                <div class="memory-grid" id="memoryGrid"></div>
                <button onclick="startMemoryGame()" style="width:100%;padding:12px;background:linear-gradient(135deg,#e91e63,#f48fb1);color:white;border:none;border-radius:10px;font-size:1rem;cursor:pointer;margin-top:10px;"> New Game</button>
            </div>
        </div>
    </div>

    <!-- Science Glossary Button -->
    <button class="glossary-btn" onclick="openGlossary()" title="Science Glossary">
        
    </button>

    <!-- Glossary Modal -->
    <div class="glossary-modal" id="glossaryModal">
        <div class="glossary-modal-content">
            <div class="glossary-modal-header">
                <h3> Science Glossary</h3>
                <button onclick="closeGlossary()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="glossary-modal-body">
                <input type="text" class="glossary-search" id="glossarySearch" placeholder=" Search terms..." oninput="filterGlossary()">
                <div class="glossary-list" id="glossaryList"></div>
            </div>
        </div>
    </div>

    <!-- Achievement Progress Button -->
    <button class="achieve-progress-btn" onclick="openAchieveProgress()" title="Achievement Progress">
        
    </button>

    <!-- Achievement Progress Modal -->
    <div class="achieve-modal" id="achieveProgressModal">
        <div class="achieve-modal-content">
            <div class="achieve-modal-header">
                <h3> Achievement Progress</h3>
                <button onclick="closeAchieveProgress()" style="background:none;border:none;color:#333;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="achieve-modal-body" id="achieveProgressList"></div>
        </div>
    </div>

    <script>
        // Batch 69: Memory Card Game, Science Glossary, Achievement Progress

        // Memory Card Game
        const memoryEmojis = ['', '', '', '', '', '', '', ''];
        let memoryCards = [];
        let memoryFlipped = [];
        let memoryMatched = 0;
        let memoryMoves = 0;
        let memoryLocked = false;

        function openMemoryGame() {
            document.getElementById('memoryGameModal').classList.add('active');
            startMemoryGame();
        }

        function closeMemoryGame() {
            document.getElementById('memoryGameModal').classList.remove('active');
        }

        function startMemoryGame() {
            memoryMatched = 0;
            memoryMoves = 0;
            memoryFlipped = [];
            memoryLocked = false;

            // Create pairs and shuffle
            memoryCards = [...memoryEmojis, ...memoryEmojis]
                .sort(() => Math.random() - 0.5)
                .map((emoji, idx) => ({ id: idx, emoji, matched: false }));

            document.getElementById('memoryMoves').textContent = 'Moves: 0';
            document.getElementById('memoryPairs').textContent = 'Pairs: 0/8';
            renderMemoryGrid();
        }

        function renderMemoryGrid() {
            document.getElementById('memoryGrid').innerHTML = memoryCards.map((card, i) => `
                <div class="memory-card ${card.matched ? 'matched' : ''}"
                     data-idx="${i}"
                     onclick="flipMemoryCard(${i})">
                    ${card.matched ? card.emoji : '?'}
                </div>
            `).join('');
        }

        function flipMemoryCard(idx) {
            if (memoryLocked || memoryCards[idx].matched || memoryFlipped.includes(idx)) return;

            memoryFlipped.push(idx);
            const cards = document.querySelectorAll('.memory-card');
            cards[idx].classList.add('flipped');
            cards[idx].textContent = memoryCards[idx].emoji;

            if (memoryFlipped.length === 2) {
                memoryMoves++;
                document.getElementById('memoryMoves').textContent = `Moves: ${memoryMoves}`;
                memoryLocked = true;

                const [first, second] = memoryFlipped;
                if (memoryCards[first].emoji === memoryCards[second].emoji) {
                    memoryCards[first].matched = true;
                    memoryCards[second].matched = true;
                    cards[first].classList.add('matched');
                    cards[second].classList.add('matched');
                    memoryMatched++;
                    document.getElementById('memoryPairs').textContent = `Pairs: ${memoryMatched}/8`;

                    if (memoryMatched === 8) {
                        const xp = Math.max(10, 50 - memoryMoves);
                        addXP(xp);
                        setTimeout(() => alert(` Amazing! Completed in ${memoryMoves} moves! +${xp} XP`), 300);
                    }
                    memoryFlipped = [];
                    memoryLocked = false;
                } else {
                    setTimeout(() => {
                        cards[first].classList.remove('flipped');
                        cards[second].classList.remove('flipped');
                        cards[first].textContent = '?';
                        cards[second].textContent = '?';
                        memoryFlipped = [];
                        memoryLocked = false;
                    }, 800);
                }
            }
        }

        // Science Glossary
        const scienceGlossary = [
            { term: 'Acceleration', def: 'Rate of change of velocity over time' },
            { term: 'Atom', def: 'Smallest unit of matter that retains element properties' },
            { term: 'Biodiversity', def: 'Variety of life forms in an ecosystem' },
            { term: 'Cell', def: 'Basic structural unit of all living organisms' },
            { term: 'Density', def: 'Mass per unit volume of a substance' },
            { term: 'Ecosystem', def: 'Community of organisms and their environment' },
            { term: 'Energy', def: 'Capacity to do work or cause change' },
            { term: 'Force', def: 'Push or pull that can change motion' },
            { term: 'Gravity', def: 'Force of attraction between masses' },
            { term: 'Habitat', def: 'Natural environment where organism lives' },
            { term: 'Inertia', def: 'Tendency of object to resist change in motion' },
            { term: 'Kinetic Energy', def: 'Energy of motion' },
            { term: 'Light', def: 'Electromagnetic radiation visible to eye' },
            { term: 'Mass', def: 'Amount of matter in an object' },
            { term: 'Molecule', def: 'Group of atoms bonded together' },
            { term: 'Nucleus', def: 'Central part of atom or cell' },
            { term: 'Osmosis', def: 'Movement of water across membrane' },
            { term: 'Photosynthesis', def: 'Process plants use to make food from sunlight' },
            { term: 'Potential Energy', def: 'Stored energy due to position' },
            { term: 'Radiation', def: 'Energy transmitted as waves or particles' },
            { term: 'Respiration', def: 'Process of releasing energy from food' },
            { term: 'Species', def: 'Group of organisms that can reproduce together' },
            { term: 'Velocity', def: 'Speed in a specific direction' },
            { term: 'Wavelength', def: 'Distance between wave peaks' }
        ];

        function openGlossary() {
            document.getElementById('glossaryModal').classList.add('active');
            document.getElementById('glossarySearch').value = '';
            renderGlossary(scienceGlossary);
        }

        function closeGlossary() {
            document.getElementById('glossaryModal').classList.remove('active');
        }

        function renderGlossary(terms) {
            document.getElementById('glossaryList').innerHTML = terms.map(t => `
                <div class="glossary-item">
                    <div class="glossary-term">${t.term}</div>
                    <div class="glossary-def">${t.def}</div>
                </div>
            `).join('');
        }

        function filterGlossary() {
            const query = document.getElementById('glossarySearch').value.toLowerCase();
            const filtered = scienceGlossary.filter(t =>
                t.term.toLowerCase().includes(query) || t.def.toLowerCase().includes(query)
            );
            renderGlossary(filtered);
        }

        // Achievement Progress
        const achievements = [
            { icon: '', title: 'First Steps', desc: 'Answer your first question', target: 1, key: 'questionsAnswered' },
            { icon: '', title: 'Scholar', desc: 'Answer 50 questions', target: 50, key: 'questionsAnswered' },
            { icon: '', title: 'Champion', desc: 'Answer 200 questions', target: 200, key: 'questionsAnswered' },
            { icon: '', title: 'Streak Master', desc: 'Reach a 7-day streak', target: 7, key: 'maxStreak' },
            { icon: '', title: 'XP Hunter', desc: 'Earn 500 XP', target: 500, key: 'totalXP' },
            { icon: '', title: 'XP Legend', desc: 'Earn 2000 XP', target: 2000, key: 'totalXP' },
            { icon: '', title: 'Sharp Shooter', desc: '90% accuracy on 20+ questions', target: 90, key: 'accuracy' },
            { icon: '', title: 'Explorer', desc: 'Try 5 different features', target: 5, key: 'featuresUsed' }
        ];

        function openAchieveProgress() {
            document.getElementById('achieveProgressModal').classList.add('active');
            renderAchieveProgress();
        }

        function closeAchieveProgress() {
            document.getElementById('achieveProgressModal').classList.remove('active');
        }

        function renderAchieveProgress() {
            const stats = JSON.parse(localStorage.getItem('achieveStats') || '{"questionsAnswered":0,"maxStreak":0,"totalXP":0,"accuracy":0,"featuresUsed":0}');

            document.getElementById('achieveProgressList').innerHTML = achievements.map(a => {
                const current = stats[a.key] || 0;
                const pct = Math.min(100, Math.round((current / a.target) * 100));
                const complete = pct >= 100;

                return `
                    <div class="achieve-item" style="${complete ? 'background:#e8f5e9;' : ''}">
                        <div class="achieve-icon">${a.icon}</div>
                        <div class="achieve-info">
                            <div class="achieve-title">${a.title} ${complete ? '' : ''}</div>
                            <div class="achieve-desc">${a.desc}</div>
                            <div class="achieve-bar">
                                <div class="achieve-fill" style="width:${pct}%;${complete ? 'background:#4caf50;' : ''}"></div>
                            </div>
                            <div class="achieve-pct">${current}/${a.target} (${pct}%)</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Track feature usage
        function trackFeatureUse(feature) {
            let stats = JSON.parse(localStorage.getItem('achieveStats') || '{"questionsAnswered":0,"maxStreak":0,"totalXP":0,"accuracy":0,"featuresUsed":0}');
            let usedFeatures = JSON.parse(localStorage.getItem('usedFeatures') || '[]');
            if (!usedFeatures.includes(feature)) {
                usedFeatures.push(feature);
                localStorage.setItem('usedFeatures', JSON.stringify(usedFeatures));
                stats.featuresUsed = usedFeatures.length;
                localStorage.setItem('achieveStats', JSON.stringify(stats));
            }
        }

        console.log(' Memory Card Game, Science Glossary, and Achievement Progress loaded!');
    </script>

    <!-- Batch 70: True/False Quiz Button -->
    <button class="tf-quiz-btn" onclick="openTFQuiz()" title="True/False Quiz">
        
    </button>

    <!-- True/False Quiz Modal -->
    <div class="tf-modal" id="tfQuizModal">
        <div class="tf-modal-content">
            <div class="tf-modal-header">
                <h3> True or False</h3>
                <button onclick="closeTFQuiz()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="tf-modal-body">
                <div class="tf-question" id="tfQuestion">Loading question...</div>
                <div class="tf-buttons">
                    <button class="tf-btn true" onclick="answerTF(true)"> TRUE</button>
                    <button class="tf-btn false" onclick="answerTF(false)"> FALSE</button>
                </div>
                <div class="tf-score" id="tfScore">Score: 0/0</div>
                <button onclick="nextTFQuestion()" style="width:100%;margin-top:15px;padding:12px;background:linear-gradient(135deg,#00bcd4,#4dd0e1);color:white;border:none;border-radius:10px;cursor:pointer;">Next Question</button>
            </div>
        </div>
    </div>

    <!-- Science News Button -->
    <button class="news-btn" onclick="openScienceNews()" title="Science News">
        
    </button>

    <!-- Science News Modal -->
    <div class="news-modal" id="newsModal">
        <div class="news-modal-content">
            <div class="news-modal-header">
                <h3> Science News</h3>
                <button onclick="closeScienceNews()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="news-modal-body" id="newsContainer"></div>
        </div>
    </div>

    <!-- Pomodoro Timer Button -->
    <button class="pomodoro-btn" onclick="openPomodoro()" title="Study Timer">
        
    </button>

    <!-- Pomodoro Timer Modal -->
    <div class="pomodoro-modal" id="pomodoroModal">
        <div class="pomodoro-modal-content">
            <div class="pomodoro-modal-header">
                <h3> Study Timer</h3>
                <button onclick="closePomodoro()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="pomodoro-modal-body">
                <div class="pomodoro-label" id="pomodoroLabel">Study Session</div>
                <div class="pomodoro-timer" id="pomodoroTimer">25:00</div>
                <div class="pomodoro-controls">
                    <button class="pomodoro-control-btn start" id="pomodoroStartBtn" onclick="togglePomodoro()"> Start</button>
                    <button class="pomodoro-control-btn reset" onclick="resetPomodoro()"> Reset</button>
                </div>
                <div class="pomodoro-stats" id="pomodoroStats">Sessions completed today: 0</div>
            </div>
        </div>
    </div>

    <script>
        // Batch 70: True/False Quiz, Science News, Pomodoro Timer

        // True/False Quiz
        const tfQuestions = [
            { q: 'Water boils at 100C at sea level.', answer: true },
            { q: 'Sound travels faster in air than in water.', answer: false },
            { q: 'The Sun is a star.', answer: true },
            { q: 'Plants release oxygen during photosynthesis.', answer: true },
            { q: 'Electrons are larger than protons.', answer: false },
            { q: 'The human body has 206 bones.', answer: true },
            { q: 'Lightning is hotter than the Sun\'s surface.', answer: true },
            { q: 'Oil floats on water because it is denser.', answer: false },
            { q: 'The Moon has its own light.', answer: false },
            { q: 'Diamonds are made of carbon.', answer: true },
            { q: 'Blood is always red inside the body.', answer: true },
            { q: 'Venus is the hottest planet in our solar system.', answer: true },
            { q: 'Bats are blind.', answer: false },
            { q: 'Glass is made mainly from sand.', answer: true },
            { q: 'Humans use only 10% of their brains.', answer: false }
        ];

        let tfState = { current: null, correct: 0, total: 0 };

        function openTFQuiz() {
            document.getElementById('tfQuizModal').classList.add('active');
            nextTFQuestion();
        }

        function closeTFQuiz() {
            document.getElementById('tfQuizModal').classList.remove('active');
        }

        function nextTFQuestion() {
            tfState.current = tfQuestions[Math.floor(Math.random() * tfQuestions.length)];
            document.getElementById('tfQuestion').textContent = tfState.current.q;
            document.querySelectorAll('.tf-btn').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
            });
        }

        function answerTF(answer) {
            if (!tfState.current) return;

            tfState.total++;
            const btns = document.querySelectorAll('.tf-btn');
            btns.forEach(btn => btn.disabled = true);

            if (answer === tfState.current.answer) {
                tfState.correct++;
                document.getElementById('tfQuestion').innerHTML += '<br><span style="color:#4caf50;"> Correct! +10 XP</span>';
                addXP(10);
            } else {
                const correctAns = tfState.current.answer ? 'TRUE' : 'FALSE';
                document.getElementById('tfQuestion').innerHTML += `<br><span style="color:#f44336;"> Wrong! Answer: ${correctAns}</span>`;
            }

            document.getElementById('tfScore').textContent = `Score: ${tfState.correct}/${tfState.total}`;
            tfState.current = null;
        }

        // Science News Feed
        const scienceNews = [
            { title: 'Water on Mars', content: 'Scientists have found evidence of liquid water beneath the surface of Mars, increasing the possibility of microbial life.', category: 'Space' },
            { title: 'New Element Discovered', content: 'Researchers have synthesized a new superheavy element, expanding our understanding of the periodic table.', category: 'Chemistry' },
            { title: 'Brain-Computer Interface', content: 'A breakthrough in neural technology allows paralyzed patients to control computers with their thoughts.', category: 'Biology' },
            { title: 'Renewable Energy Record', content: 'Solar panels have achieved a new efficiency record of 47%, making clean energy more viable than ever.', category: 'Physics' },
            { title: 'Deep Sea Discovery', content: 'A new species of bioluminescent fish has been found in the Mariana Trench, the deepest part of the ocean.', category: 'Biology' },
            { title: 'Quantum Computing', content: 'A quantum computer has solved a problem in minutes that would take traditional computers thousands of years.', category: 'Physics' },
            { title: 'Climate Breakthrough', content: 'Scientists develop a new material that can capture carbon dioxide from the air more efficiently.', category: 'Earth Science' },
            { title: 'Gene Editing Advances', content: 'CRISPR technology has been used to successfully treat genetic disorders in clinical trials.', category: 'Biology' }
        ];

        function openScienceNews() {
            document.getElementById('newsModal').classList.add('active');
            renderNews();
        }

        function closeScienceNews() {
            document.getElementById('newsModal').classList.remove('active');
        }

        function renderNews() {
            document.getElementById('newsContainer').innerHTML = scienceNews.map(n => `
                <div class="news-item">
                    <div class="news-title">${n.title}</div>
                    <div class="news-content">${n.content}</div>
                    <span class="news-category">${n.category}</span>
                </div>
            `).join('');
        }

        // Pomodoro Timer
        let pomodoroState = {
            timeLeft: 25 * 60,
            isRunning: false,
            interval: null,
            isBreak: false,
            sessionsToday: parseInt(localStorage.getItem('pomodoroSessions') || '0')
        };

        function openPomodoro() {
            document.getElementById('pomodoroModal').classList.add('active');
            updatePomodoroDisplay();
            document.getElementById('pomodoroStats').textContent = `Sessions completed today: ${pomodoroState.sessionsToday}`;
        }

        function closePomodoro() {
            document.getElementById('pomodoroModal').classList.remove('active');
        }

        function togglePomodoro() {
            if (pomodoroState.isRunning) {
                clearInterval(pomodoroState.interval);
                pomodoroState.isRunning = false;
                document.getElementById('pomodoroStartBtn').innerHTML = ' Start';
                document.getElementById('pomodoroStartBtn').classList.remove('pause');
                document.getElementById('pomodoroStartBtn').classList.add('start');
            } else {
                pomodoroState.isRunning = true;
                document.getElementById('pomodoroStartBtn').innerHTML = ' Pause';
                document.getElementById('pomodoroStartBtn').classList.remove('start');
                document.getElementById('pomodoroStartBtn').classList.add('pause');

                pomodoroState.interval = setInterval(() => {
                    pomodoroState.timeLeft--;
                    updatePomodoroDisplay();

                    if (pomodoroState.timeLeft <= 0) {
                        clearInterval(pomodoroState.interval);
                        pomodoroState.isRunning = false;

                        if (!pomodoroState.isBreak) {
                            pomodoroState.sessionsToday++;
                            localStorage.setItem('pomodoroSessions', pomodoroState.sessionsToday);
                            document.getElementById('pomodoroStats').textContent = `Sessions completed today: ${pomodoroState.sessionsToday}`;
                            addXP(25);
                            alert(' Study session complete! +25 XP. Take a 5-minute break!');
                            pomodoroState.isBreak = true;
                            pomodoroState.timeLeft = 5 * 60;
                        } else {
                            alert(' Break is over! Ready for another session?');
                            pomodoroState.isBreak = false;
                            pomodoroState.timeLeft = 25 * 60;
                        }

                        updatePomodoroDisplay();
                        document.getElementById('pomodoroStartBtn').innerHTML = ' Start';
                        document.getElementById('pomodoroStartBtn').classList.remove('pause');
                        document.getElementById('pomodoroStartBtn').classList.add('start');
                    }
                }, 1000);
            }
        }

        function resetPomodoro() {
            clearInterval(pomodoroState.interval);
            pomodoroState.isRunning = false;
            pomodoroState.isBreak = false;
            pomodoroState.timeLeft = 25 * 60;
            updatePomodoroDisplay();
            document.getElementById('pomodoroStartBtn').innerHTML = ' Start';
            document.getElementById('pomodoroStartBtn').classList.remove('pause');
            document.getElementById('pomodoroStartBtn').classList.add('start');
        }

        function updatePomodoroDisplay() {
            const mins = Math.floor(pomodoroState.timeLeft / 60);
            const secs = pomodoroState.timeLeft % 60;
            document.getElementById('pomodoroTimer').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            document.getElementById('pomodoroLabel').textContent = pomodoroState.isBreak ? 'Break Time' : 'Study Session';
        }

        console.log(' True/False Quiz, Science News, and Pomodoro Timer loaded!');
    </script>

    <!-- Batch 71: Word Scramble Button -->
    <button class="scramble-btn" onclick="openScramble()" title="Word Scramble">
        
    </button>

    <!-- Word Scramble Modal -->
    <div class="scramble-modal" id="scrambleModal">
        <div class="scramble-modal-content">
            <div class="scramble-modal-header">
                <h3> Word Scramble</h3>
                <button onclick="closeScramble()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="scramble-modal-body">
                <div class="scramble-word" id="scrambledWord">LOADING</div>
                <div class="scramble-hint" id="scrambleHint">Hint: Loading...</div>
                <input type="text" class="scramble-input" id="scrambleInput" placeholder="Type your answer..." onkeyup="checkScramble(event)">
                <div class="scramble-result" id="scrambleResult"></div>
                <button onclick="newScramble()" style="width:100%;padding:12px;background:linear-gradient(135deg,#673ab7,#9575cd);color:white;border:none;border-radius:10px;cursor:pointer;"> New Word</button>
            </div>
        </div>
    </div>

    <!-- Science Heroes Button -->
    <button class="heroes-btn" onclick="openHeroes()" title="Science Heroes">
        
    </button>

    <!-- Science Heroes Modal -->
    <div class="heroes-modal" id="heroesModal">
        <div class="heroes-modal-content">
            <div class="heroes-modal-header">
                <h3> Science Heroes</h3>
                <button onclick="closeHeroes()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="heroes-modal-body" id="heroesContainer"></div>
        </div>
    </div>

    <!-- Quick Review Button -->
    <button class="quick-review-btn" onclick="openQuickReview()" title="Quick Review">
        
    </button>

    <!-- Quick Review Modal -->
    <div class="review-modal" id="quickReviewModal">
        <div class="review-modal-content">
            <div class="review-modal-header">
                <h3> Quick Review</h3>
                <button onclick="closeQuickReview()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="review-modal-body">
                <div class="review-topics" id="reviewTopics"></div>
                <div class="review-content" id="reviewContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Batch 71: Word Scramble, Science Heroes, Quick Review

        // Word Scramble
        const scrambleWords = [
            { word: 'GRAVITY', hint: 'Force that pulls objects toward Earth' },
            { word: 'ELECTRON', hint: 'Negatively charged particle' },
            { word: 'PHOTON', hint: 'Particle of light' },
            { word: 'NUCLEUS', hint: 'Center of an atom or cell' },
            { word: 'DENSITY', hint: 'Mass per unit volume' },
            { word: 'MOLECULE', hint: 'Bonded group of atoms' },
            { word: 'FRICTION', hint: 'Force resisting motion' },
            { word: 'OSMOSIS', hint: 'Water movement through membrane' },
            { word: 'VELOCITY', hint: 'Speed with direction' },
            { word: 'ECOSYSTEM', hint: 'Living community and environment' },
            { word: 'CHLOROPHYLL', hint: 'Green pigment in plants' },
            { word: 'MITOCHONDRIA', hint: 'Cell powerhouse' }
        ];

        let currentScramble = null;

        function openScramble() {
            document.getElementById('scrambleModal').classList.add('active');
            newScramble();
        }

        function closeScramble() {
            document.getElementById('scrambleModal').classList.remove('active');
        }

        function scrambleString(str) {
            return str.split('').sort(() => Math.random() - 0.5).join('');
        }

        function newScramble() {
            currentScramble = scrambleWords[Math.floor(Math.random() * scrambleWords.length)];
            let scrambled = scrambleString(currentScramble.word);
            while (scrambled === currentScramble.word) {
                scrambled = scrambleString(currentScramble.word);
            }
            document.getElementById('scrambledWord').textContent = scrambled;
            document.getElementById('scrambleHint').textContent = `Hint: ${currentScramble.hint}`;
            document.getElementById('scrambleInput').value = '';
            document.getElementById('scrambleResult').innerHTML = '';
            document.getElementById('scrambleInput').disabled = false;
        }

        function checkScramble(event) {
            if (!currentScramble) return;
            const input = document.getElementById('scrambleInput').value.toUpperCase().trim();

            if (event.key === 'Enter' || input === currentScramble.word) {
                if (input === currentScramble.word) {
                    document.getElementById('scrambleResult').innerHTML = '<span style="color:#4caf50;"> Correct! +15 XP</span>';
                    document.getElementById('scrambleResult').style.background = '#e8f5e9';
                    document.getElementById('scrambleInput').disabled = true;
                    addXP(15);
                } else if (event.key === 'Enter') {
                    document.getElementById('scrambleResult').innerHTML = `<span style="color:#f44336;"> Wrong! Answer: ${currentScramble.word}</span>`;
                    document.getElementById('scrambleResult').style.background = '#ffebee';
                }
            }
        }

        // Science Heroes
        const scienceHeroes = [
            { avatar: '', name: 'Marie Curie', desc: 'Discovered radioactivity and won 2 Nobel Prizes', field: 'Physics/Chemistry' },
            { avatar: '', name: 'Albert Einstein', desc: 'Developed theory of relativity (E=mc)', field: 'Physics' },
            { avatar: '', name: 'Charles Darwin', desc: 'Theory of evolution by natural selection', field: 'Biology' },
            { avatar: '', name: 'Galileo Galilei', desc: 'Father of modern observational astronomy', field: 'Astronomy' },
            { avatar: '', name: 'Nikola Tesla', desc: 'Invented AC electrical system', field: 'Engineering' },
            { avatar: '', name: 'Isaac Newton', desc: 'Laws of motion and universal gravitation', field: 'Physics' },
            { avatar: '', name: 'Louis Pasteur', desc: 'Germ theory and pasteurization', field: 'Microbiology' },
            { avatar: '', name: 'Dmitri Mendeleev', desc: 'Created the periodic table', field: 'Chemistry' },
            { avatar: '', name: 'Stephen Hawking', desc: 'Black hole theory and cosmology', field: 'Physics' },
            { avatar: '', name: 'Jane Goodall', desc: 'Pioneering study of chimpanzees', field: 'Primatology' }
        ];

        function openHeroes() {
            document.getElementById('heroesModal').classList.add('active');
            renderHeroes();
        }

        function closeHeroes() {
            document.getElementById('heroesModal').classList.remove('active');
        }

        function renderHeroes() {
            document.getElementById('heroesContainer').innerHTML = scienceHeroes.map(h => `
                <div class="hero-card">
                    <div class="hero-avatar">${h.avatar}</div>
                    <div class="hero-info">
                        <h4>${h.name}</h4>
                        <p>${h.desc}</p>
                        <span class="hero-field">${h.field}</span>
                    </div>
                </div>
            `).join('');
        }

        // Quick Review
        const quickReviews = {
            'Forces': {
                title: 'Forces',
                points: [
                    'Force = Mass  Acceleration (F = ma)',
                    'Friction opposes motion between surfaces',
                    'Gravity pulls objects toward Earth (9.8 m/s)',
                    'Normal force acts perpendicular to surfaces',
                    'Balanced forces = no change in motion'
                ]
            },
            'Cells': {
                title: 'Cells',
                points: [
                    'Cell membrane controls what enters/exits',
                    'Nucleus contains DNA (control center)',
                    'Mitochondria produce energy (ATP)',
                    'Ribosomes make proteins',
                    'Plant cells have cell walls and chloroplasts'
                ]
            },
            'Atoms': {
                title: 'Atoms',
                points: [
                    'Protons (+) and neutrons in nucleus',
                    'Electrons (-) orbit in shells',
                    'Atomic number = number of protons',
                    'Mass number = protons + neutrons',
                    'Isotopes have different neutron counts'
                ]
            },
            'Energy': {
                title: 'Energy',
                points: [
                    'Energy cannot be created or destroyed',
                    'Kinetic energy = energy of motion',
                    'Potential energy = stored energy',
                    'Work = Force  Distance',
                    'Power = Work  Time'
                ]
            }
        };

        function openQuickReview() {
            document.getElementById('quickReviewModal').classList.add('active');
            renderReviewTopics();
            showReview('Forces');
        }

        function closeQuickReview() {
            document.getElementById('quickReviewModal').classList.remove('active');
        }

        function renderReviewTopics() {
            const topics = Object.keys(quickReviews);
            document.getElementById('reviewTopics').innerHTML = topics.map(t => `
                <button class="review-topic-btn" onclick="showReview('${t}')">${t}</button>
            `).join('');
        }

        function showReview(topic) {
            document.querySelectorAll('.review-topic-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === topic);
            });

            const review = quickReviews[topic];
            document.getElementById('reviewContent').innerHTML = `
                <h4> ${review.title}</h4>
                <ul>
                    ${review.points.map(p => `<li>${p}</li>`).join('')}
                </ul>
            `;
        }

        console.log(' Word Scramble, Science Heroes, and Quick Review loaded!');
    </script>

    <!-- Batch 72: Fill in the Blanks Button -->
    <button class="blanks-btn" onclick="openBlanks()" title="Fill in the Blanks">
        
    </button>

    <!-- Fill in the Blanks Modal -->
    <div class="blanks-modal" id="blanksModal">
        <div class="blanks-modal-content">
            <div class="blanks-modal-header">
                <h3> Fill in the Blanks</h3>
                <button onclick="closeBlanks()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="blanks-modal-body">
                <div class="blanks-sentence" id="blanksSentence"></div>
                <div class="blanks-result" id="blanksResult"></div>
                <button onclick="checkBlanks()" style="width:100%;padding:12px;background:#4caf50;color:white;border:none;border-radius:10px;cursor:pointer;margin-bottom:10px;"> Check Answer</button>
                <button onclick="newBlanks()" style="width:100%;padding:12px;background:linear-gradient(135deg,#f44336,#ef9a9a);color:white;border:none;border-radius:10px;cursor:pointer;"> New Question</button>
            </div>
        </div>
    </div>

    <!-- Experiment Ideas Button -->
    <button class="experiment-btn" onclick="openExperiments()" title="Experiment Ideas">
        
    </button>

    <!-- Experiment Ideas Modal -->
    <div class="experiment-modal" id="experimentModal">
        <div class="experiment-modal-content">
            <div class="experiment-modal-header">
                <h3> Experiment Ideas</h3>
                <button onclick="closeExperiments()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="experiment-modal-body" id="experimentContainer"></div>
        </div>
    </div>

    <!-- Topic Progress Button -->
    <button class="topic-progress-btn" onclick="openTopicProgress()" title="Topic Progress">
        
    </button>

    <!-- Topic Progress Modal -->
    <div class="progress-modal" id="topicProgressModal">
        <div class="progress-modal-content">
            <div class="progress-modal-header">
                <h3> Topic Progress</h3>
                <button onclick="closeTopicProgress()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="progress-modal-body" id="topicProgressContainer"></div>
        </div>
    </div>

    <script>
        // Batch 72: Fill in the Blanks, Experiment Ideas, Topic Progress

        // Fill in the Blanks
        const blanksQuestions = [
            { sentence: 'The force of _____ pulls objects toward Earth.', answer: 'gravity' },
            { sentence: 'Plants use _____ to make food from sunlight.', answer: 'photosynthesis' },
            { sentence: 'The _____ is the control center of the cell.', answer: 'nucleus' },
            { sentence: 'Water is made of hydrogen and _____.', answer: 'oxygen' },
            { sentence: 'The unit of force is the _____.', answer: 'newton' },
            { sentence: 'Sound cannot travel through a _____.', answer: 'vacuum' },
            { sentence: '_____ are negatively charged particles.', answer: 'electrons' },
            { sentence: 'The powerhouse of the cell is the _____.', answer: 'mitochondria' },
            { sentence: 'Light travels fastest in a _____.', answer: 'vacuum' },
            { sentence: 'The chemical symbol for gold is _____.', answer: 'au' }
        ];

        let currentBlanks = null;

        function openBlanks() {
            document.getElementById('blanksModal').classList.add('active');
            newBlanks();
        }

        function closeBlanks() {
            document.getElementById('blanksModal').classList.remove('active');
        }

        function newBlanks() {
            currentBlanks = blanksQuestions[Math.floor(Math.random() * blanksQuestions.length)];
            const parts = currentBlanks.sentence.split('_____');
            document.getElementById('blanksSentence').innerHTML =
                parts[0] + '<input type="text" class="blanks-input" id="blanksInput" placeholder="...">' + parts[1];
            document.getElementById('blanksResult').innerHTML = '';
        }

        function checkBlanks() {
            if (!currentBlanks) return;
            const input = document.getElementById('blanksInput').value.toLowerCase().trim();
            const result = document.getElementById('blanksResult');

            if (input === currentBlanks.answer) {
                result.innerHTML = '<span style="color:#4caf50;"> Correct! +10 XP</span>';
                addXP(10);
            } else {
                result.innerHTML = `<span style="color:#f44336;"> Wrong! Answer: ${currentBlanks.answer}</span>`;
            }
        }

        // Experiment Ideas
        const experiments = [
            {
                title: ' Baking Soda Volcano',
                materials: 'Baking soda, vinegar, dish soap, food coloring',
                steps: 'Mix baking soda with dish soap, add food coloring, pour vinegar for eruption!',
                difficulty: 'Easy'
            },
            {
                title: ' Rainbow in a Glass',
                materials: 'Sugar, water, food coloring, tall glass',
                steps: 'Create sugar solutions of different concentrations, layer them carefully with food coloring.',
                difficulty: 'Medium'
            },
            {
                title: ' Floating Egg',
                materials: 'Egg, salt, two glasses of water',
                steps: 'Dissolve salt in one glass. The egg sinks in plain water but floats in salt water!',
                difficulty: 'Easy'
            },
            {
                title: ' Growing Crystals',
                materials: 'Sugar or salt, hot water, string, pencil',
                steps: 'Make supersaturated solution, hang string in it, watch crystals form over days.',
                difficulty: 'Medium'
            },
            {
                title: ' Lemon Battery',
                materials: 'Lemon, copper coin, zinc nail, LED',
                steps: 'Insert copper and zinc into lemon, connect to LED. Chemical energy creates electricity!',
                difficulty: 'Hard'
            },
            {
                title: ' Static Electricity',
                materials: 'Balloon, wool cloth, small paper pieces',
                steps: 'Rub balloon on wool, watch it attract paper pieces. Electrons transfer!',
                difficulty: 'Easy'
            }
        ];

        function openExperiments() {
            document.getElementById('experimentModal').classList.add('active');
            renderExperiments();
        }

        function closeExperiments() {
            document.getElementById('experimentModal').classList.remove('active');
        }

        function renderExperiments() {
            document.getElementById('experimentContainer').innerHTML = experiments.map(e => `
                <div class="experiment-card">
                    <div class="experiment-title">${e.title}</div>
                    <div class="experiment-materials"><strong>Materials:</strong> ${e.materials}</div>
                    <div class="experiment-steps">${e.steps}</div>
                    <span class="experiment-difficulty">${e.difficulty}</span>
                </div>
            `).join('');
        }

        // Topic Progress
        const topicList = [
            { name: 'Forces & Motion', icon: '' },
            { name: 'Cells & Life', icon: '' },
            { name: 'Atoms & Elements', icon: '' },
            { name: 'Energy & Waves', icon: '' },
            { name: 'Earth & Space', icon: '' },
            { name: 'Chemical Reactions', icon: '' }
        ];

        function openTopicProgress() {
            document.getElementById('topicProgressModal').classList.add('active');
            renderTopicProgress();
        }

        function closeTopicProgress() {
            document.getElementById('topicProgressModal').classList.remove('active');
        }

        function renderTopicProgress() {
            const progress = JSON.parse(localStorage.getItem('topicProgress') || '{}');

            document.getElementById('topicProgressContainer').innerHTML = topicList.map(t => {
                const pct = progress[t.name] || Math.floor(Math.random() * 60 + 10);
                return `
                    <div class="progress-topic">
                        <div class="progress-topic-header">
                            <span class="progress-topic-name">${t.icon} ${t.name}</span>
                            <span class="progress-pct">${pct}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:${pct}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize some progress
        if (!localStorage.getItem('topicProgress')) {
            const initialProgress = {};
            topicList.forEach(t => {
                initialProgress[t.name] = Math.floor(Math.random() * 40 + 5);
            });
            localStorage.setItem('topicProgress', JSON.stringify(initialProgress));
        }

        console.log(' Fill in the Blanks, Experiment Ideas, and Topic Progress loaded!');
    </script>

    <!-- Batch 73: Quiz Race Button -->
    <button class="race-btn" onclick="openQuizRace()" title="Quiz Race">
        
    </button>

    <!-- Quiz Race Modal -->
    <div class="race-modal" id="raceModal">
        <div class="race-modal-content">
            <div class="race-modal-header">
                <h3> Quiz Race</h3>
                <button onclick="closeQuizRace()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="race-modal-body">
                <div class="race-timer-bar">
                    <div class="race-timer-fill" id="raceTimerFill" style="width:100%"></div>
                </div>
                <div class="race-question" id="raceQuestion">Click Start to begin!</div>
                <div class="race-options" id="raceOptions"></div>
                <div class="race-score" id="raceScore">Score: 0 | Time: 30s</div>
                <button onclick="startQuizRace()" id="raceStartBtn" style="width:100%;margin-top:15px;padding:12px;background:#4caf50;color:white;border:none;border-radius:10px;cursor:pointer;"> Start Race!</button>
            </div>
        </div>
    </div>

    <!-- Study Buddy Button -->
    <button class="buddy-btn" onclick="openStudyBuddy()" title="Study Buddy">
        
    </button>

    <!-- Study Buddy Modal -->
    <div class="buddy-modal" id="buddyModal">
        <div class="buddy-modal-content">
            <div class="buddy-modal-header">
                <h3> Study Buddy</h3>
                <button onclick="closeStudyBuddy()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="buddy-modal-body">
                <div class="buddy-avatar"></div>
                <div class="buddy-message" id="buddyMessage">Hi there! Ready to learn some science?</div>
                <div class="buddy-actions">
                    <button class="buddy-action-btn" style="background:#e91e63;color:white;" onclick="getBuddyTip()"> Get Tip</button>
                    <button class="buddy-action-btn" style="background:#9c27b0;color:white;" onclick="getBuddyMotivation()"> Motivate Me</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Facts Cards Button -->
    <button class="facts-cards-btn" onclick="openFactsCards()" title="Quick Facts">
        
    </button>

    <!-- Quick Facts Cards Modal -->
    <div class="facts-modal" id="factsCardsModal">
        <div class="facts-modal-content">
            <div class="facts-modal-header">
                <h3> Quick Facts</h3>
                <button onclick="closeFactsCards()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="facts-modal-body">
                <div class="facts-card" id="factsCard">
                    <div class="facts-card-icon" id="factsIcon"></div>
                    <div class="facts-card-text" id="factsText">Loading fact...</div>
                </div>
                <div class="facts-nav">
                    <button class="facts-nav-btn" onclick="prevFact()"> Prev</button>
                    <span class="facts-counter" id="factsCounter">1/15</span>
                    <button class="facts-nav-btn" onclick="nextFact()">Next </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Batch 73: Quiz Race, Study Buddy, Quick Facts Cards

        // Quiz Race
        const raceQuestions = [
            { q: 'Unit of force?', opts: ['Newton', 'Joule', 'Watt', 'Volt'], answer: 0 },
            { q: 'Powerhouse of cell?', opts: ['Nucleus', 'Mitochondria', 'Ribosome', 'Golgi'], answer: 1 },
            { q: 'Symbol for Gold?', opts: ['Go', 'Gd', 'Au', 'Ag'], answer: 2 },
            { q: 'Planet closest to Sun?', opts: ['Venus', 'Mercury', 'Mars', 'Earth'], answer: 1 },
            { q: 'What gives plants green color?', opts: ['Chlorophyll', 'Melanin', 'Hemoglobin', 'Keratin'], answer: 0 },
            { q: 'Speed of light medium?', opts: ['Water', 'Air', 'Glass', 'Vacuum'], answer: 3 },
            { q: 'H2O is?', opts: ['Salt', 'Water', 'Sugar', 'Acid'], answer: 1 },
            { q: 'Electrons are?', opts: ['Positive', 'Negative', 'Neutral', 'Variable'], answer: 1 },
            { q: 'Largest organ?', opts: ['Heart', 'Liver', 'Skin', 'Brain'], answer: 2 },
            { q: 'Diamond is made of?', opts: ['Silicon', 'Carbon', 'Iron', 'Gold'], answer: 1 }
        ];

        let raceState = { score: 0, timeLeft: 30, interval: null, current: null, active: false };

        function openQuizRace() {
            document.getElementById('raceModal').classList.add('active');
            resetQuizRace();
        }

        function closeQuizRace() {
            document.getElementById('raceModal').classList.remove('active');
            if (raceState.interval) clearInterval(raceState.interval);
        }

        function resetQuizRace() {
            raceState.score = 0;
            raceState.timeLeft = 30;
            raceState.active = false;
            if (raceState.interval) clearInterval(raceState.interval);
            document.getElementById('raceTimerFill').style.width = '100%';
            document.getElementById('raceQuestion').textContent = 'Click Start to begin!';
            document.getElementById('raceOptions').innerHTML = '';
            document.getElementById('raceScore').textContent = 'Score: 0 | Time: 30s';
            document.getElementById('raceStartBtn').style.display = 'block';
        }

        function startQuizRace() {
            raceState.active = true;
            document.getElementById('raceStartBtn').style.display = 'none';
            nextRaceQuestion();

            raceState.interval = setInterval(() => {
                raceState.timeLeft--;
                const pct = (raceState.timeLeft / 30) * 100;
                document.getElementById('raceTimerFill').style.width = pct + '%';
                document.getElementById('raceScore').textContent = `Score: ${raceState.score} | Time: ${raceState.timeLeft}s`;

                if (raceState.timeLeft <= 0) {
                    clearInterval(raceState.interval);
                    raceState.active = false;
                    const xp = raceState.score * 5;
                    addXP(xp);
                    document.getElementById('raceQuestion').textContent = ` Race Over! Final Score: ${raceState.score}`;
                    document.getElementById('raceOptions').innerHTML = `<p style="text-align:center;grid-column:span 2;">+${xp} XP earned!</p>`;
                    document.getElementById('raceStartBtn').style.display = 'block';
                    document.getElementById('raceStartBtn').textContent = ' Play Again';
                }
            }, 1000);
        }

        function nextRaceQuestion() {
            raceState.current = raceQuestions[Math.floor(Math.random() * raceQuestions.length)];
            document.getElementById('raceQuestion').textContent = raceState.current.q;
            document.getElementById('raceOptions').innerHTML = raceState.current.opts.map((opt, i) => `
                <button class="race-option" onclick="answerRace(${i})">${opt}</button>
            `).join('');
        }

        function answerRace(idx) {
            if (!raceState.active) return;
            if (idx === raceState.current.answer) {
                raceState.score++;
                document.getElementById('raceScore').textContent = `Score: ${raceState.score} | Time: ${raceState.timeLeft}s`;
            }
            nextRaceQuestion();
        }

        // Study Buddy
        const buddyTips = [
            "Break big topics into smaller chunks. It's easier to digest!",
            "Use mnemonics to remember lists and sequences.",
            "Draw diagrams! Visual learning sticks better.",
            "Teach what you learn to someone else - it reinforces memory.",
            "Take short breaks every 25 minutes using the Pomodoro technique.",
            "Connect new concepts to things you already know.",
            "Practice with past exam questions regularly.",
            "Get enough sleep - your brain consolidates learning during rest!"
        ];

        const buddyMotivations = [
            "You're doing amazing! Every question brings you closer to success! ",
            "Scientists never give up - and neither should you! ",
            "Your brain is growing stronger with every problem you solve! ",
            "Remember: Einstein failed before he succeeded. Keep going! ",
            "You've got this! One step at a time leads to great discoveries! ",
            "Learning is a journey, not a race. Enjoy the process! ",
            "Every expert was once a beginner. You're on your way! "
        ];

        function openStudyBuddy() {
            document.getElementById('buddyModal').classList.add('active');
            document.getElementById('buddyMessage').textContent = "Hi there! Ready to learn some science? ";
        }

        function closeStudyBuddy() {
            document.getElementById('buddyModal').classList.remove('active');
        }

        function getBuddyTip() {
            const tip = buddyTips[Math.floor(Math.random() * buddyTips.length)];
            document.getElementById('buddyMessage').textContent = " " + tip;
        }

        function getBuddyMotivation() {
            const mot = buddyMotivations[Math.floor(Math.random() * buddyMotivations.length)];
            document.getElementById('buddyMessage').textContent = mot;
        }

        // Quick Facts Cards
        const quickFacts = [
            { icon: '', fact: 'Lightning is 5 times hotter than the surface of the sun!' },
            { icon: '', fact: 'Human DNA stretched out would reach the sun and back 600 times!' },
            { icon: '', fact: 'Earth is the only planet not named after a Greek or Roman god.' },
            { icon: '', fact: 'Hot water freezes faster than cold water - the Mpemba effect!' },
            { icon: '', fact: 'Babies have about 300 bones, adults have only 206.' },
            { icon: '', fact: 'A teaspoon of neutron star weighs about 6 billion tons!' },
            { icon: '', fact: 'The ocean produces over 50% of the world\'s oxygen.' },
            { icon: '', fact: 'A butterfly tastes with its feet!' },
            { icon: '', fact: 'Sunlight takes about 8 minutes to reach Earth.' },
            { icon: '', fact: 'Your brain uses about 20% of your body\'s energy.' },
            { icon: '', fact: 'It rains diamonds on Saturn and Jupiter!' },
            { icon: '', fact: 'Tooth enamel is the hardest substance in your body.' },
            { icon: '', fact: 'The Moon is slowly moving away from Earth - about 3.8 cm per year.' },
            { icon: '', fact: 'Fire needs oxygen. In space, flames are round, not teardrop-shaped!' },
            { icon: '', fact: 'Octopuses have three hearts and blue blood!' }
        ];

        let currentFactIdx = 0;

        function openFactsCards() {
            document.getElementById('factsCardsModal').classList.add('active');
            showFact(0);
        }

        function closeFactsCards() {
            document.getElementById('factsCardsModal').classList.remove('active');
        }

        function showFact(idx) {
            currentFactIdx = idx;
            const fact = quickFacts[idx];
            document.getElementById('factsIcon').textContent = fact.icon;
            document.getElementById('factsText').textContent = fact.fact;
            document.getElementById('factsCounter').textContent = `${idx + 1}/${quickFacts.length}`;
        }

        function prevFact() {
            const newIdx = currentFactIdx > 0 ? currentFactIdx - 1 : quickFacts.length - 1;
            showFact(newIdx);
        }

        function nextFact() {
            const newIdx = currentFactIdx < quickFacts.length - 1 ? currentFactIdx + 1 : 0;
            showFact(newIdx);
        }

        console.log(' Quiz Race, Study Buddy, and Quick Facts Cards loaded!');
    </script>

    <!-- Batch 74: Equation Builder Button -->
    <button class="equation-btn" onclick="openEquationBuilder()" title="Equation Builder">
        
    </button>

    <!-- Equation Builder Modal -->
    <div class="equation-modal" id="equationModal">
        <div class="equation-modal-content">
            <div class="equation-modal-header">
                <h3> Equation Builder</h3>
                <button onclick="closeEquationBuilder()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="equation-modal-body">
                <div class="equation-display" id="equationDisplay">0</div>
                <div class="equation-keypad">
                    <button class="equation-key" onclick="eqInput('7')">7</button>
                    <button class="equation-key" onclick="eqInput('8')">8</button>
                    <button class="equation-key" onclick="eqInput('9')">9</button>
                    <button class="equation-key" onclick="eqInput('/')"></button>
                    <button class="equation-key" onclick="eqInput('4')">4</button>
                    <button class="equation-key" onclick="eqInput('5')">5</button>
                    <button class="equation-key" onclick="eqInput('6')">6</button>
                    <button class="equation-key" onclick="eqInput('*')"></button>
                    <button class="equation-key" onclick="eqInput('1')">1</button>
                    <button class="equation-key" onclick="eqInput('2')">2</button>
                    <button class="equation-key" onclick="eqInput('3')">3</button>
                    <button class="equation-key" onclick="eqInput('-')">-</button>
                    <button class="equation-key" onclick="eqInput('0')">0</button>
                    <button class="equation-key" onclick="eqInput('.')">.</button>
                    <button class="equation-key action" onclick="eqCalculate()">=</button>
                    <button class="equation-key" onclick="eqInput('+')">+</button>
                    <button class="equation-key action" onclick="eqClear()" style="grid-column: span 2;">Clear</button>
                    <button class="equation-key" onclick="eqInput('(')">(</button>
                    <button class="equation-key" onclick="eqInput(')')">)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Science Riddles Button -->
    <button class="riddles-btn" onclick="openRiddles()" title="Science Riddles">
        
    </button>

    <!-- Science Riddles Modal -->
    <div class="riddles-modal" id="riddlesModal">
        <div class="riddles-modal-content">
            <div class="riddles-modal-header">
                <h3> Science Riddles</h3>
                <button onclick="closeRiddles()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="riddles-modal-body">
                <div class="riddle-box">
                    <div class="riddle-question" id="riddleQuestion">Loading riddle...</div>
                    <div class="riddle-hint" id="riddleHint" onclick="showRiddleHint()"> Click for hint</div>
                </div>
                <div class="riddle-answer-area">
                    <input type="text" class="riddle-input" id="riddleInput" placeholder="Your answer...">
                    <button onclick="checkRiddle()" style="width:100%;padding:12px;background:#ff9800;color:white;border:none;border-radius:10px;cursor:pointer;">Check Answer</button>
                    <div class="riddle-result" id="riddleResult"></div>
                </div>
                <button onclick="newRiddle()" style="width:100%;margin-top:15px;padding:12px;background:#666;color:white;border:none;border-radius:10px;cursor:pointer;"> New Riddle</button>
            </div>
        </div>
    </div>

    <!-- Weekly Goals Button -->
    <button class="goals-btn" onclick="openWeeklyGoals()" title="Weekly Goals">
        
    </button>

    <!-- Weekly Goals Modal -->
    <div class="goals-modal" id="goalsModal">
        <div class="goals-modal-content">
            <div class="goals-modal-header">
                <h3> Weekly Goals</h3>
                <button onclick="closeWeeklyGoals()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="goals-modal-body">
                <div id="goalsList"></div>
                <div class="goal-add">
                    <input type="text" class="goal-input" id="goalInput" placeholder="Add new goal...">
                    <button class="goal-add-btn" onclick="addGoal()">+ Add</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Batch 74: Equation Builder, Science Riddles, Weekly Goals

        // Equation Builder
        let equationStr = '';

        function openEquationBuilder() {
            document.getElementById('equationModal').classList.add('active');
            eqClear();
        }

        function closeEquationBuilder() {
            document.getElementById('equationModal').classList.remove('active');
        }

        function eqInput(val) {
            equationStr += val;
            updateEqDisplay();
        }

        function eqClear() {
            equationStr = '';
            document.getElementById('equationDisplay').textContent = '0';
        }

        function updateEqDisplay() {
            let display = equationStr.replace(/\*/g, '').replace(/\//g, '');
            document.getElementById('equationDisplay').textContent = display || '0';
        }

        function eqCalculate() {
            try {
                const result = eval(equationStr);
                document.getElementById('equationDisplay').textContent = result;
                equationStr = result.toString();
            } catch (e) {
                document.getElementById('equationDisplay').textContent = 'Error';
                equationStr = '';
            }
        }

        // Science Riddles
        const scienceRiddles = [
            { q: "I have no mouth but I can roar. I have no legs but I can soar. What am I?", a: "wind", hint: "Moving air" },
            { q: "I'm not alive but I grow. I don't have lungs but I need air. What am I?", a: "fire", hint: "Hot and orange" },
            { q: "I have a head and tail but no body. What am I?", a: "coin", hint: "Money" },
            { q: "The more you take, the more you leave behind. What am I?", a: "footsteps", hint: "Walking" },
            { q: "I travel around the world but stay in a corner. What am I?", a: "stamp", hint: "On letters" },
            { q: "I can be cracked, made, told, and played. What am I?", a: "joke", hint: "Makes you laugh" },
            { q: "I have cities but no houses, forests but no trees, water but no fish. What am I?", a: "map", hint: "Shows places" },
            { q: "I go up but never come down. What am I?", a: "age", hint: "Birthday count" },
            { q: "I'm full of holes but can hold water. What am I?", a: "sponge", hint: "In the kitchen" },
            { q: "The more of me there is, the less you see. What am I?", a: "darkness", hint: "No light" }
        ];

        let currentRiddle = null;

        function openRiddles() {
            document.getElementById('riddlesModal').classList.add('active');
            newRiddle();
        }

        function closeRiddles() {
            document.getElementById('riddlesModal').classList.remove('active');
        }

        function newRiddle() {
            currentRiddle = scienceRiddles[Math.floor(Math.random() * scienceRiddles.length)];
            document.getElementById('riddleQuestion').textContent = currentRiddle.q;
            document.getElementById('riddleHint').textContent = ' Click for hint';
            document.getElementById('riddleInput').value = '';
            document.getElementById('riddleResult').innerHTML = '';
        }

        function showRiddleHint() {
            document.getElementById('riddleHint').textContent = ' Hint: ' + currentRiddle.hint;
        }

        function checkRiddle() {
            const input = document.getElementById('riddleInput').value.toLowerCase().trim();
            const result = document.getElementById('riddleResult');

            if (input === currentRiddle.a) {
                result.innerHTML = '<span style="color:#4caf50;"> Correct! +15 XP</span>';
                addXP(15);
            } else {
                result.innerHTML = `<span style="color:#f44336;"> Wrong! Answer: ${currentRiddle.a}</span>`;
            }
        }

        // Weekly Goals
        let weeklyGoals = JSON.parse(localStorage.getItem('weeklyGoals') || '[]');

        // Add default goals if empty
        if (weeklyGoals.length === 0) {
            weeklyGoals = [
                { text: 'Complete 10 quiz questions', completed: false },
                { text: 'Learn 5 new science terms', completed: false },
                { text: 'Review Forces topic', completed: false },
                { text: 'Try one home experiment', completed: false }
            ];
            localStorage.setItem('weeklyGoals', JSON.stringify(weeklyGoals));
        }

        function openWeeklyGoals() {
            document.getElementById('goalsModal').classList.add('active');
            renderGoals();
        }

        function closeWeeklyGoals() {
            document.getElementById('goalsModal').classList.remove('active');
        }

        function renderGoals() {
            document.getElementById('goalsList').innerHTML = weeklyGoals.map((g, i) => `
                <div class="goal-item">
                    <input type="checkbox" class="goal-checkbox" ${g.completed ? 'checked' : ''} onchange="toggleGoal(${i})">
                    <span class="goal-text ${g.completed ? 'completed' : ''}">${g.text}</span>
                    <button onclick="deleteGoal(${i})" style="background:none;border:none;color:#f44336;cursor:pointer;font-size:1.2rem;"></button>
                </div>
            `).join('');
        }

        function toggleGoal(idx) {
            weeklyGoals[idx].completed = !weeklyGoals[idx].completed;
            if (weeklyGoals[idx].completed) {
                addXP(10);
            }
            localStorage.setItem('weeklyGoals', JSON.stringify(weeklyGoals));
            renderGoals();
        }

        function addGoal() {
            const input = document.getElementById('goalInput');
            if (input.value.trim()) {
                weeklyGoals.push({ text: input.value.trim(), completed: false });
                localStorage.setItem('weeklyGoals', JSON.stringify(weeklyGoals));
                input.value = '';
                renderGoals();
            }
        }

        function deleteGoal(idx) {
            weeklyGoals.splice(idx, 1);
            localStorage.setItem('weeklyGoals', JSON.stringify(weeklyGoals));
            renderGoals();
        }

        console.log(' Equation Builder, Science Riddles, and Weekly Goals loaded!');
    </script>

    <!-- Batch 75: Concept Connector Button -->
    <button class="connector-btn" onclick="openConceptConnector()" title="Concept Connector">
        
    </button>

    <!-- Concept Connector Modal -->
    <div class="connector-modal" id="connectorModal">
        <div class="connector-modal-content">
            <div class="connector-modal-header">
                <h3> Concept Connector</h3>
                <button onclick="closeConceptConnector()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="connector-modal-body">
                <div class="concept-main" id="conceptMain">
                    <h4 id="mainConcept">Energy</h4>
                    <p id="conceptDesc">The capacity to do work</p>
                </div>
                <h5 style="color:#00bcd4;margin-bottom:10px;">Related Concepts:</h5>
                <div class="concept-related" id="relatedConcepts"></div>
            </div>
        </div>
    </div>

    <!-- Mini Quiz Generator Button -->
    <button class="miniquiz-btn" onclick="openMiniQuiz()" title="Mini Quiz">
        
    </button>

    <!-- Mini Quiz Modal -->
    <div class="miniquiz-modal" id="miniquizModal">
        <div class="miniquiz-modal-content">
            <div class="miniquiz-modal-header">
                <h3> Mini Quiz</h3>
                <button onclick="closeMiniQuiz()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="miniquiz-modal-body">
                <div class="miniquiz-topics" id="miniquizTopics"></div>
                <div class="miniquiz-question" id="miniquizQuestion">Select a topic to start!</div>
                <div class="miniquiz-options" id="miniquizOptions"></div>
            </div>
        </div>
    </div>

    <!-- Learning Path Button -->
    <button class="path-btn" onclick="openLearningPath()" title="Learning Path">
        
    </button>

    <!-- Learning Path Modal -->
    <div class="path-modal" id="pathModal">
        <div class="path-modal-content">
            <div class="path-modal-header">
                <h3> Learning Path</h3>
                <button onclick="closeLearningPath()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="path-modal-body" id="pathContainer"></div>
        </div>
    </div>

    <script>
        // Batch 75: Concept Connector, Mini Quiz, Learning Path

        // Concept Connector
        const conceptMap = {
            'Energy': { desc: 'The capacity to do work', related: ['Force', 'Motion', 'Heat', 'Electricity'] },
            'Force': { desc: 'Push or pull on an object', related: ['Energy', 'Motion', 'Gravity', 'Friction'] },
            'Motion': { desc: 'Change in position over time', related: ['Energy', 'Force', 'Velocity', 'Acceleration'] },
            'Cells': { desc: 'Basic unit of life', related: ['Nucleus', 'Mitochondria', 'DNA', 'Proteins'] },
            'Atoms': { desc: 'Smallest unit of matter', related: ['Electrons', 'Protons', 'Neutrons', 'Molecules'] },
            'Gravity': { desc: 'Force of attraction between masses', related: ['Force', 'Mass', 'Weight', 'Planets'] },
            'Electricity': { desc: 'Flow of electric charge', related: ['Energy', 'Electrons', 'Circuits', 'Voltage'] },
            'Light': { desc: 'Electromagnetic radiation', related: ['Energy', 'Waves', 'Reflection', 'Refraction'] }
        };

        let currentConcept = 'Energy';

        function openConceptConnector() {
            document.getElementById('connectorModal').classList.add('active');
            showConcept('Energy');
        }

        function closeConceptConnector() {
            document.getElementById('connectorModal').classList.remove('active');
        }

        function showConcept(name) {
            currentConcept = name;
            const concept = conceptMap[name];
            document.getElementById('mainConcept').textContent = name;
            document.getElementById('conceptDesc').textContent = concept.desc;
            document.getElementById('relatedConcepts').innerHTML = concept.related.map(r => `
                <div class="concept-link" onclick="showConcept('${r}')">${r}</div>
            `).join('');
        }

        // Mini Quiz Generator
        const miniQuizData = {
            'Physics': [
                { q: 'What is the SI unit of force?', opts: ['Newton', 'Joule', 'Watt', 'Pascal'], ans: 0 },
                { q: 'What type of energy does a moving object have?', opts: ['Potential', 'Kinetic', 'Thermal', 'Nuclear'], ans: 1 },
                { q: 'Speed with direction is called?', opts: ['Velocity', 'Acceleration', 'Force', 'Momentum'], ans: 0 }
            ],
            'Biology': [
                { q: 'What organelle produces energy?', opts: ['Nucleus', 'Ribosome', 'Mitochondria', 'Golgi'], ans: 2 },
                { q: 'What molecule carries genetic info?', opts: ['RNA', 'DNA', 'ATP', 'Protein'], ans: 1 },
                { q: 'Green pigment in plants?', opts: ['Melanin', 'Chlorophyll', 'Hemoglobin', 'Keratin'], ans: 1 }
            ],
            'Chemistry': [
                { q: 'What is H2O?', opts: ['Salt', 'Water', 'Acid', 'Base'], ans: 1 },
                { q: 'Symbol for Gold?', opts: ['Go', 'Gd', 'Au', 'Ag'], ans: 2 },
                { q: 'How many elements in periodic table?', opts: ['92', '108', '118', '126'], ans: 2 }
            ]
        };

        let currentMiniTopic = null;
        let currentMiniQ = null;

        function openMiniQuiz() {
            document.getElementById('miniquizModal').classList.add('active');
            renderMiniTopics();
        }

        function closeMiniQuiz() {
            document.getElementById('miniquizModal').classList.remove('active');
        }

        function renderMiniTopics() {
            document.getElementById('miniquizTopics').innerHTML = Object.keys(miniQuizData).map(t => `
                <button class="miniquiz-topic" onclick="selectMiniTopic('${t}')">${t}</button>
            `).join('');
        }

        function selectMiniTopic(topic) {
            currentMiniTopic = topic;
            document.querySelectorAll('.miniquiz-topic').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === topic);
            });
            generateMiniQuestion();
        }

        function generateMiniQuestion() {
            const questions = miniQuizData[currentMiniTopic];
            currentMiniQ = questions[Math.floor(Math.random() * questions.length)];
            document.getElementById('miniquizQuestion').textContent = currentMiniQ.q;
            document.getElementById('miniquizOptions').innerHTML = currentMiniQ.opts.map((opt, i) => `
                <button class="miniquiz-option" onclick="answerMiniQuiz(${i})">${opt}</button>
            `).join('');
        }

        function answerMiniQuiz(idx) {
            const btns = document.querySelectorAll('.miniquiz-option');
            btns.forEach((btn, i) => {
                btn.disabled = true;
                if (i === currentMiniQ.ans) btn.style.background = '#4caf50';
                if (i === idx && idx !== currentMiniQ.ans) btn.style.background = '#f44336';
            });
            if (idx === currentMiniQ.ans) {
                addXP(10);
            }
            setTimeout(generateMiniQuestion, 1500);
        }

        // Learning Path
        const learningPath = [
            { title: 'Start Your Journey', desc: 'Complete your first quiz', completed: true },
            { title: 'Learn the Basics', desc: 'Study forces and motion', completed: true },
            { title: 'Explore Cells', desc: 'Understand cell structure', completed: true },
            { title: 'Discover Atoms', desc: 'Learn atomic structure', completed: false },
            { title: 'Master Energy', desc: 'Understand energy transfer', completed: false },
            { title: 'Chemical Reactions', desc: 'Learn about reactions', completed: false },
            { title: 'Become a Scientist', desc: 'Complete all topics', completed: false }
        ];

        function openLearningPath() {
            document.getElementById('pathModal').classList.add('active');
            renderLearningPath();
        }

        function closeLearningPath() {
            document.getElementById('pathModal').classList.remove('active');
        }

        function renderLearningPath() {
            document.getElementById('pathContainer').innerHTML = learningPath.map((step, i) => `
                <div class="path-step">
                    <div class="path-indicator">
                        <div class="path-dot ${step.completed ? 'completed' : ''}">${step.completed ? '' : i + 1}</div>
                        ${i < learningPath.length - 1 ? '<div class="path-line"></div>' : ''}
                    </div>
                    <div class="path-content" style="${step.completed ? 'opacity:0.7;' : ''}">
                        <div class="path-title">${step.title}</div>
                        <div class="path-desc">${step.desc}</div>
                    </div>
                </div>
            `).join('');
        }

        console.log(' Concept Connector, Mini Quiz, and Learning Path loaded!');
    </script>

    <!-- Batch 76: Diagram Viewer Button -->
    <button class="diagram-btn" onclick="openDiagramViewer()" title="Diagram Viewer">
        
    </button>

    <!-- Diagram Viewer Modal -->
    <div class="diagram-modal" id="diagramModal">
        <div class="diagram-modal-content">
            <div class="diagram-modal-header">
                <h3> Diagram Viewer</h3>
                <button onclick="closeDiagramViewer()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="diagram-modal-body">
                <div class="diagram-tabs" id="diagramTabs"></div>
                <div class="diagram-display" id="diagramDisplay"></div>
            </div>
        </div>
    </div>

    <!-- Question Bookmark Button -->
    <button class="bookmark-btn" onclick="openBookmarks()" title="Bookmarked Questions">
        
    </button>

    <!-- Bookmark Modal -->
    <div class="bookmark-modal" id="bookmarkModal">
        <div class="bookmark-modal-content">
            <div class="bookmark-modal-header">
                <h3> Bookmarked Questions</h3>
                <button onclick="closeBookmarks()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="bookmark-modal-body" id="bookmarkList"></div>
        </div>
    </div>

    <!-- Sound Toggle Button -->
    <button class="sound-btn" id="soundToggleBtn" onclick="toggleSound()" title="Sound Effects">
        
    </button>

    <script>
        // Batch 76: Diagram Viewer, Question Bookmark, Sound Toggle

        // Diagram Viewer
        const diagrams = {
            'Cell': {
                image: '',
                label: 'Animal Cell',
                parts: ['Nucleus - Control center', 'Mitochondria - Powerhouse', 'Cell Membrane - Boundary', 'Cytoplasm - Jelly-like fluid', 'Ribosomes - Protein makers']
            },
            'Atom': {
                image: '',
                label: 'Atomic Structure',
                parts: ['Nucleus - Protons + Neutrons', 'Electrons - Orbit in shells', 'Protons - Positive charge', 'Neutrons - No charge', 'Electron Cloud - Probability zone']
            },
            'Heart': {
                image: '',
                label: 'Human Heart',
                parts: ['Right Atrium - Receives blood', 'Right Ventricle - Pumps to lungs', 'Left Atrium - Receives from lungs', 'Left Ventricle - Pumps to body', 'Valves - Prevent backflow']
            },
            'Circuit': {
                image: '',
                label: 'Simple Circuit',
                parts: ['Battery - Power source', 'Wire - Conductor', 'Switch - On/Off control', 'Resistor - Controls current', 'Light Bulb - Load/Output']
            },
            'Solar': {
                image: '',
                label: 'Solar System',
                parts: ['Sun - Star at center', 'Inner Planets - Mercury to Mars', 'Asteroid Belt - Between Mars & Jupiter', 'Outer Planets - Jupiter to Neptune', 'Dwarf Planets - Pluto, etc.']
            }
        };

        function openDiagramViewer() {
            document.getElementById('diagramModal').classList.add('active');
            renderDiagramTabs();
            showDiagram('Cell');
        }

        function closeDiagramViewer() {
            document.getElementById('diagramModal').classList.remove('active');
        }

        function renderDiagramTabs() {
            document.getElementById('diagramTabs').innerHTML = Object.keys(diagrams).map(d => `
                <button class="diagram-tab" onclick="showDiagram('${d}')">${d}</button>
            `).join('');
        }

        function showDiagram(name) {
            document.querySelectorAll('.diagram-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent === name);
            });

            const d = diagrams[name];
            document.getElementById('diagramDisplay').innerHTML = `
                <div class="diagram-image">${d.image}</div>
                <div class="diagram-label">${d.label}</div>
                <div class="diagram-parts">
                    ${d.parts.map(p => `<p> ${p}</p>`).join('')}
                </div>
            `;
        }

        // Question Bookmark
        let bookmarkedQuestions = JSON.parse(localStorage.getItem('bookmarkedQuestions') || '[]');

        // Add sample bookmarks if empty
        if (bookmarkedQuestions.length === 0) {
            bookmarkedQuestions = [
                { q: 'What is the unit of force?', a: 'Newton' },
                { q: 'What is the powerhouse of the cell?', a: 'Mitochondria' },
                { q: 'What gas do plants release?', a: 'Oxygen' }
            ];
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarkedQuestions));
        }

        function openBookmarks() {
            document.getElementById('bookmarkModal').classList.add('active');
            renderBookmarks();
        }

        function closeBookmarks() {
            document.getElementById('bookmarkModal').classList.remove('active');
        }

        function renderBookmarks() {
            const list = document.getElementById('bookmarkList');
            if (bookmarkedQuestions.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#888;">No bookmarked questions yet!</p>';
                return;
            }
            list.innerHTML = bookmarkedQuestions.map((b, i) => `
                <div class="bookmark-item">
                    <button class="bookmark-remove" onclick="removeBookmark(${i})"></button>
                    <div class="bookmark-question">${b.q}</div>
                    <div class="bookmark-answer">Answer: ${b.a}</div>
                </div>
            `).join('');
        }

        function addBookmark(question, answer) {
            bookmarkedQuestions.push({ q: question, a: answer });
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarkedQuestions));
        }

        function removeBookmark(idx) {
            bookmarkedQuestions.splice(idx, 1);
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarkedQuestions));
            renderBookmarks();
        }

        // Sound Toggle
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
        updateSoundButton();

        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('soundEnabled', soundEnabled);
            updateSoundButton();
        }

        function updateSoundButton() {
            const btn = document.getElementById('soundToggleBtn');
            btn.textContent = soundEnabled ? '' : '';
            btn.classList.toggle('muted', !soundEnabled);
        }

        function playSound(type) {
            if (!soundEnabled) return;
            // Audio feedback simulation with Web Audio API
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);

                if (type === 'correct') {
                    osc.frequency.value = 523.25; // C5
                    gain.gain.value = 0.3;
                } else if (type === 'wrong') {
                    osc.frequency.value = 220; // A3
                    gain.gain.value = 0.2;
                } else {
                    osc.frequency.value = 440; // A4
                    gain.gain.value = 0.15;
                }

                osc.start();
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc.stop(ctx.currentTime + 0.2);
            } catch (e) {
                // Audio not supported
            }
        }

        console.log(' Diagram Viewer, Question Bookmarks, and Sound Toggle loaded!');
    </script>

    <!-- Batch 77: Speed Reading Button -->
    <button class="speed-read-btn" onclick="openSpeedReading()" title="Speed Reading"></button>

    <!-- Speed Reading Modal -->
    <div class="speed-read-modal" id="speedReadModal">
        <div class="speed-read-content">
            <div class="speed-read-header">
                <h3 style="margin:0;"> Speed Reading</h3>
                <button onclick="closeSpeedReading()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="speed-read-body">
                <div class="speed-wpm-selector">
                    <button class="speed-wpm-btn active" onclick="setWPM(150)">150 WPM</button>
                    <button class="speed-wpm-btn" onclick="setWPM(200)">200 WPM</button>
                    <button class="speed-wpm-btn" onclick="setWPM(300)">300 WPM</button>
                    <button class="speed-wpm-btn" onclick="setWPM(400)">400 WPM</button>
                </div>
                <div class="speed-read-display" id="speedReadDisplay">Press Start to begin!</div>
                <div class="speed-read-controls">
                    <button onclick="startSpeedRead()" style="background:#00bcd4;color:white;"> Start</button>
                    <button onclick="pauseSpeedRead()" style="background:#ff9800;color:white;"> Pause</button>
                    <button onclick="resetSpeedRead()" style="background:#f44336;color:white;"> Reset</button>
                    <button onclick="nextPassage()" style="background:#4caf50;color:white;">Next </button>
                </div>
                <p style="text-align:center;margin-top:15px;color:#666;font-size:0.9rem;" id="speedReadProgress">Passage 1 of 5</p>
            </div>
        </div>
    </div>

    <!-- Formula Cards Button -->
    <button class="formula-btn" onclick="openFormulas()" title="Formula Cards"></button>

    <!-- Formula Cards Modal -->
    <div class="formula-modal" id="formulaModal">
        <div class="formula-content">
            <div class="formula-header">
                <h3 style="margin:0;"> Formula Cards</h3>
                <button onclick="closeFormulas()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="formula-body">
                <div class="formula-card" id="formulaCard">
                    <div class="formula-name" id="formulaName">Loading...</div>
                    <div class="formula-equation" id="formulaEquation">...</div>
                    <div class="formula-description" id="formulaDesc">...</div>
                </div>
                <div class="formula-nav">
                    <button onclick="prevFormula()"> Prev</button>
                    <button onclick="nextFormula()">Next </button>
                </div>
                <div class="formula-counter" id="formulaCounter">1 / 12</div>
            </div>
        </div>
    </div>

    <!-- Daily Streak Button -->
    <button class="streak-btn" onclick="openStreak()" title="Daily Streak"></button>

    <!-- Daily Streak Modal -->
    <div class="streak-modal" id="streakModal">
        <div class="streak-content">
            <div class="streak-header">
                <h3 style="margin:0;"> Daily Streak</h3>
                <button onclick="closeStreak()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="streak-body">
                <div class="streak-number" id="streakNumber">0</div>
                <div class="streak-label">Day Streak!</div>
                <div class="streak-calendar" id="streakCalendar"></div>
                <div class="streak-message" id="streakMessage">Start studying to build your streak!</div>
            </div>
        </div>
    </div>

    <script>
        // Speed Reading System
        const passages = [
            "The cell is the basic unit of life. All living organisms are composed of cells. Cells contain genetic material that controls their functions. The cell membrane protects the cell and regulates what enters and exits. Inside the cell, the cytoplasm contains organelles that perform specific tasks.",
            "Energy cannot be created or destroyed, only transformed from one form to another. This is the law of conservation of energy. In photosynthesis, light energy is converted to chemical energy. In respiration, chemical energy is converted to ATP for cellular processes.",
            "The periodic table organizes elements by atomic number and properties. Elements in the same group have similar chemical properties. Metals are found on the left side, nonmetals on the right. The noble gases are unreactive due to their full outer electron shells.",
            "Force equals mass times acceleration. This is Newton's second law of motion. When forces are balanced, objects remain stationary or move at constant velocity. Unbalanced forces cause acceleration. Gravity is a force that attracts objects with mass toward each other.",
            "The water cycle describes how water moves through Earth's systems. Evaporation turns liquid water into vapor. Condensation forms clouds when water vapor cools. Precipitation returns water to Earth's surface as rain, snow, or hail."
        ];

        let currentPassageIndex = 0;
        let currentWordIndex = 0;
        let speedReadInterval = null;
        let wordsPerMinute = 150;
        let isPaused = false;

        function openSpeedReading() {
            document.getElementById('speedReadModal').classList.add('active');
            updateSpeedReadProgress();
        }

        function closeSpeedReading() {
            document.getElementById('speedReadModal').classList.remove('active');
            pauseSpeedRead();
        }

        function setWPM(wpm) {
            wordsPerMinute = wpm;
            document.querySelectorAll('.speed-wpm-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(wpm));
            });
        }

        function startSpeedRead() {
            if (speedReadInterval) return;
            const words = passages[currentPassageIndex].split(' ');
            isPaused = false;

            speedReadInterval = setInterval(() => {
                if (currentWordIndex < words.length) {
                    document.getElementById('speedReadDisplay').textContent = words[currentWordIndex];
                    currentWordIndex++;
                } else {
                    pauseSpeedRead();
                    document.getElementById('speedReadDisplay').textContent = ' Passage Complete!';
                    addXP(10);
                }
            }, (60 / wordsPerMinute) * 1000);
        }

        function pauseSpeedRead() {
            if (speedReadInterval) {
                clearInterval(speedReadInterval);
                speedReadInterval = null;
                isPaused = true;
            }
        }

        function resetSpeedRead() {
            pauseSpeedRead();
            currentWordIndex = 0;
            document.getElementById('speedReadDisplay').textContent = 'Press Start to begin!';
        }

        function nextPassage() {
            pauseSpeedRead();
            currentPassageIndex = (currentPassageIndex + 1) % passages.length;
            currentWordIndex = 0;
            document.getElementById('speedReadDisplay').textContent = 'Press Start to begin!';
            updateSpeedReadProgress();
        }

        function updateSpeedReadProgress() {
            document.getElementById('speedReadProgress').textContent = `Passage ${currentPassageIndex + 1} of ${passages.length}`;
        }

        // Formula Cards System
        const formulas = [
            { name: 'Speed', equation: 'v = d / t', desc: 'Speed equals distance divided by time' },
            { name: 'Force', equation: 'F = m  a', desc: 'Force equals mass times acceleration' },
            { name: 'Work', equation: 'W = F  d', desc: 'Work equals force times distance' },
            { name: 'Power', equation: 'P = W / t', desc: 'Power equals work divided by time' },
            { name: 'Kinetic Energy', equation: 'KE = mv', desc: 'Half mass times velocity squared' },
            { name: 'Potential Energy', equation: 'PE = mgh', desc: 'Mass times gravity times height' },
            { name: 'Density', equation: ' = m / V', desc: 'Density equals mass divided by volume' },
            { name: 'Pressure', equation: 'P = F / A', desc: 'Pressure equals force divided by area' },
            { name: 'Ohms Law', equation: 'V = I  R', desc: 'Voltage equals current times resistance' },
            { name: 'Wave Speed', equation: 'v = f  ', desc: 'Wave speed equals frequency times wavelength' },
            { name: 'Weight', equation: 'W = m  g', desc: 'Weight equals mass times gravity' },
            { name: 'Momentum', equation: 'p = m  v', desc: 'Momentum equals mass times velocity' }
        ];

        let currentFormulaIndex = 0;

        function openFormulas() {
            document.getElementById('formulaModal').classList.add('active');
            updateFormulaDisplay();
        }

        function closeFormulas() {
            document.getElementById('formulaModal').classList.remove('active');
        }

        function updateFormulaDisplay() {
            const f = formulas[currentFormulaIndex];
            document.getElementById('formulaName').textContent = f.name;
            document.getElementById('formulaEquation').textContent = f.equation;
            document.getElementById('formulaDesc').textContent = f.desc;
            document.getElementById('formulaCounter').textContent = `${currentFormulaIndex + 1} / ${formulas.length}`;
        }

        function nextFormula() {
            currentFormulaIndex = (currentFormulaIndex + 1) % formulas.length;
            updateFormulaDisplay();
        }

        function prevFormula() {
            currentFormulaIndex = (currentFormulaIndex - 1 + formulas.length) % formulas.length;
            updateFormulaDisplay();
        }

        // Daily Streak System
        function openStreak() {
            document.getElementById('streakModal').classList.add('active');
            updateStreakDisplay();
        }

        function closeStreak() {
            document.getElementById('streakModal').classList.remove('active');
        }

        function getStreakData() {
            const data = JSON.parse(localStorage.getItem('dailyStreakData') || '{}');
            return {
                streak: data.streak || 0,
                lastDate: data.lastDate || null,
                activeDays: data.activeDays || []
            };
        }

        function saveStreakData(data) {
            localStorage.setItem('dailyStreakData', JSON.stringify(data));
        }

        function checkAndUpdateStreak() {
            const data = getStreakData();
            const today = new Date().toISOString().split('T')[0];

            if (data.lastDate === today) return data.streak;

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            if (data.lastDate === yesterdayStr) {
                data.streak++;
            } else if (data.lastDate !== today) {
                data.streak = 1;
            }

            data.lastDate = today;
            if (!data.activeDays.includes(today)) {
                data.activeDays.push(today);
                if (data.activeDays.length > 30) data.activeDays.shift();
            }

            saveStreakData(data);
            return data.streak;
        }

        function updateStreakDisplay() {
            const data = getStreakData();
            document.getElementById('streakNumber').textContent = data.streak;

            // Generate calendar for last 14 days
            const calendar = document.getElementById('streakCalendar');
            calendar.innerHTML = '';
            const today = new Date();

            for (let i = 13; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayNum = date.getDate();

                const dayEl = document.createElement('div');
                dayEl.className = 'streak-day';
                if (data.activeDays.includes(dateStr)) dayEl.classList.add('active');
                if (i === 0) dayEl.classList.add('today');
                dayEl.textContent = dayNum;
                calendar.appendChild(dayEl);
            }

            // Update message based on streak
            const messages = [
                { min: 0, msg: 'Start studying to build your streak!' },
                { min: 1, msg: 'Great start! Keep it going!' },
                { min: 3, msg: '3 days strong! You\'re on fire!' },
                { min: 7, msg: 'One week streak! Amazing dedication!' },
                { min: 14, msg: '2 weeks! You\'re unstoppable!' },
                { min: 30, msg: 'One month streak! Science champion!' }
            ];

            const message = messages.reverse().find(m => data.streak >= m.min);
            document.getElementById('streakMessage').textContent = message.msg;
        }

        // Initialize streak on page load
        checkAndUpdateStreak();
        updateFormulaDisplay();

        console.log(' Speed Reading, Formula Cards, and Daily Streak loaded!');
    </script>

    <!-- Batch 78: Science Crossword Button -->
    <button class="crossword-btn" onclick="openCrossword()" title="Science Crossword"></button>

    <!-- Science Crossword Modal -->
    <div class="crossword-modal" id="crosswordModal">
        <div class="crossword-content">
            <div class="crossword-header">
                <h3 style="margin:0;"> Science Crossword</h3>
                <button onclick="closeCrossword()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="crossword-body">
                <div class="crossword-grid" id="crosswordGrid"></div>
                <div class="crossword-clues" id="crosswordClues"></div>
                <button onclick="checkCrossword()" style="width:100%;padding:12px;background:#009688;color:white;border:none;border-radius:8px;font-weight:bold;margin-top:10px;cursor:pointer;">Check Answers</button>
                <button onclick="newCrossword()" style="width:100%;padding:12px;background:#4db6ac;color:white;border:none;border-radius:8px;font-weight:bold;margin-top:8px;cursor:pointer;">New Puzzle</button>
            </div>
        </div>
    </div>

    <!-- Element Quiz Button -->
    <button class="element-quiz-btn" onclick="openElementQuiz()" title="Element Quiz"></button>

    <!-- Element Quiz Modal -->
    <div class="element-quiz-modal" id="elementQuizModal">
        <div class="element-quiz-content">
            <div class="element-quiz-header">
                <h3 style="margin:0;"> Element Quiz</h3>
                <button onclick="closeElementQuiz()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="element-quiz-body">
                <div class="element-display">
                    <div class="element-number" id="elementNumber">1</div>
                    <div class="element-symbol" id="elementSymbol">H</div>
                </div>
                <p style="text-align:center;color:#666;margin-bottom:15px;">What is this element?</p>
                <div class="element-options" id="elementOptions"></div>
                <div class="element-score" id="elementScore">Score: 0 / 0</div>
            </div>
        </div>
    </div>

    <!-- Study Mode Button -->
    <button class="study-mode-btn" onclick="startStudyMode()" title="Study Mode"></button>

    <!-- Study Mode Overlay -->
    <div class="study-mode-overlay" id="studyModeOverlay">
        <div class="study-mode-container">
            <div class="study-mode-title"> Focus Mode</div>
            <div class="study-mode-quote" id="studyModeQuote">"The important thing is not to stop questioning."</div>
            <div class="study-mode-author" id="studyModeAuthor">- Albert Einstein</div>
            <div class="study-mode-timer" id="studyModeTimer">00:00</div>
            <button class="study-mode-btn-exit" onclick="exitStudyMode()">Exit Study Mode</button>
        </div>
    </div>

    <script>
        // Science Crossword System
        const crosswordPuzzles = [
            {
                words: [
                    { word: 'FORCE', row: 0, col: 0, dir: 'across', clue: '1 Across: Push or pull on an object' },
                    { word: 'CELL', row: 0, col: 0, dir: 'down', clue: '1 Down: Basic unit of life' },
                    { word: 'ATOM', row: 2, col: 1, dir: 'across', clue: '2 Across: Smallest particle of an element' }
                ],
                grid: [
                    ['F','O','R','C','E'],
                    ['','','','E',''],
                    ['','A','T','O','M'],
                    ['','','','L',''],
                    ['','','','','']
                ]
            },
            {
                words: [
                    { word: 'MASS', row: 0, col: 0, dir: 'across', clue: '1 Across: Amount of matter in an object' },
                    { word: 'MOON', row: 0, col: 0, dir: 'down', clue: '1 Down: Earth\'s natural satellite' },
                    { word: 'ENERGY', row: 2, col: 0, dir: 'across', clue: '2 Across: Ability to do work' }
                ],
                grid: [
                    ['M','A','S','S',''],
                    ['O','','','',''],
                    ['O','N','E','R','G'],
                    ['N','','','','Y'],
                    ['','','','','']
                ]
            }
        ];

        let currentPuzzle = 0;
        let userAnswers = [];

        function openCrossword() {
            document.getElementById('crosswordModal').classList.add('active');
            renderCrossword();
        }

        function closeCrossword() {
            document.getElementById('crosswordModal').classList.remove('active');
        }

        function renderCrossword() {
            const puzzle = crosswordPuzzles[currentPuzzle];
            const grid = document.getElementById('crosswordGrid');
            grid.innerHTML = '';
            userAnswers = [];

            for (let r = 0; r < 5; r++) {
                for (let c = 0; c < 5; c++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.maxLength = 1;
                    input.className = 'crossword-cell';
                    input.dataset.row = r;
                    input.dataset.col = c;

                    if (puzzle.grid[r][c] === '') {
                        input.disabled = true;
                        input.value = '';
                    }
                    grid.appendChild(input);
                }
            }

            const cluesDiv = document.getElementById('crosswordClues');
            cluesDiv.innerHTML = puzzle.words.map(w => `<div class="crossword-clue">${w.clue}</div>`).join('');
        }

        function checkCrossword() {
            const puzzle = crosswordPuzzles[currentPuzzle];
            const inputs = document.querySelectorAll('.crossword-cell:not(:disabled)');
            let correct = 0;
            let total = 0;

            inputs.forEach(input => {
                const r = parseInt(input.dataset.row);
                const c = parseInt(input.dataset.col);
                const expected = puzzle.grid[r][c];

                if (expected !== '') {
                    total++;
                    if (input.value.toUpperCase() === expected) {
                        correct++;
                        input.style.backgroundColor = '#c8e6c9';
                    } else {
                        input.style.backgroundColor = '#ffcdd2';
                    }
                }
            });

            if (correct === total) {
                addXP(20);
                alert('Perfect! All answers correct! +20 XP');
            } else {
                alert(`${correct} out of ${total} correct. Keep trying!`);
            }
        }

        function newCrossword() {
            currentPuzzle = (currentPuzzle + 1) % crosswordPuzzles.length;
            renderCrossword();
        }

        // Element Quiz System
        const elements = [
            { symbol: 'H', number: 1, name: 'Hydrogen' },
            { symbol: 'He', number: 2, name: 'Helium' },
            { symbol: 'C', number: 6, name: 'Carbon' },
            { symbol: 'N', number: 7, name: 'Nitrogen' },
            { symbol: 'O', number: 8, name: 'Oxygen' },
            { symbol: 'Na', number: 11, name: 'Sodium' },
            { symbol: 'Mg', number: 12, name: 'Magnesium' },
            { symbol: 'Al', number: 13, name: 'Aluminum' },
            { symbol: 'Si', number: 14, name: 'Silicon' },
            { symbol: 'Cl', number: 17, name: 'Chlorine' },
            { symbol: 'K', number: 19, name: 'Potassium' },
            { symbol: 'Ca', number: 20, name: 'Calcium' },
            { symbol: 'Fe', number: 26, name: 'Iron' },
            { symbol: 'Cu', number: 29, name: 'Copper' },
            { symbol: 'Zn', number: 30, name: 'Zinc' },
            { symbol: 'Ag', number: 47, name: 'Silver' },
            { symbol: 'Au', number: 79, name: 'Gold' },
            { symbol: 'Pb', number: 82, name: 'Lead' }
        ];

        let elementQuizScore = { correct: 0, total: 0 };
        let currentElement = null;

        function openElementQuiz() {
            document.getElementById('elementQuizModal').classList.add('active');
            elementQuizScore = { correct: 0, total: 0 };
            nextElement();
        }

        function closeElementQuiz() {
            document.getElementById('elementQuizModal').classList.remove('active');
        }

        function nextElement() {
            currentElement = elements[Math.floor(Math.random() * elements.length)];
            document.getElementById('elementSymbol').textContent = currentElement.symbol;
            document.getElementById('elementNumber').textContent = currentElement.number;

            // Generate options
            const options = [currentElement.name];
            while (options.length < 4) {
                const rand = elements[Math.floor(Math.random() * elements.length)].name;
                if (!options.includes(rand)) options.push(rand);
            }

            // Shuffle
            options.sort(() => Math.random() - 0.5);

            const optionsDiv = document.getElementById('elementOptions');
            optionsDiv.innerHTML = options.map(opt =>
                `<button class="element-option" onclick="checkElementAnswer('${opt}')">${opt}</button>`
            ).join('');

            updateElementScore();
        }

        function checkElementAnswer(answer) {
            const buttons = document.querySelectorAll('.element-option');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === currentElement.name) {
                    btn.classList.add('correct');
                } else if (btn.textContent === answer && answer !== currentElement.name) {
                    btn.classList.add('wrong');
                }
            });

            elementQuizScore.total++;
            if (answer === currentElement.name) {
                elementQuizScore.correct++;
                addXP(5);
            }

            updateElementScore();
            setTimeout(nextElement, 1500);
        }

        function updateElementScore() {
            document.getElementById('elementScore').textContent = `Score: ${elementQuizScore.correct} / ${elementQuizScore.total}`;
        }

        // Study Mode System
        const studyQuotes = [
            { quote: "The important thing is not to stop questioning.", author: "Albert Einstein" },
            { quote: "Science is a way of thinking much more than it is a body of knowledge.", author: "Carl Sagan" },
            { quote: "Nothing in life is to be feared, it is only to be understood.", author: "Marie Curie" },
            { quote: "The good thing about science is that it's true whether or not you believe in it.", author: "Neil deGrasse Tyson" },
            { quote: "Research is what I'm doing when I don't know what I'm doing.", author: "Wernher von Braun" },
            { quote: "Science knows no country, because knowledge belongs to humanity.", author: "Louis Pasteur" }
        ];

        let studyModeInterval = null;
        let studyModeSeconds = 0;

        function startStudyMode() {
            document.getElementById('studyModeOverlay').classList.add('active');
            const q = studyQuotes[Math.floor(Math.random() * studyQuotes.length)];
            document.getElementById('studyModeQuote').textContent = `"${q.quote}"`;
            document.getElementById('studyModeAuthor').textContent = `- ${q.author}`;
            studyModeSeconds = 0;
            updateStudyModeTimer();

            studyModeInterval = setInterval(() => {
                studyModeSeconds++;
                updateStudyModeTimer();
                // Every 5 minutes, give XP
                if (studyModeSeconds % 300 === 0) {
                    addXP(25);
                }
            }, 1000);
        }

        function updateStudyModeTimer() {
            const mins = Math.floor(studyModeSeconds / 60).toString().padStart(2, '0');
            const secs = (studyModeSeconds % 60).toString().padStart(2, '0');
            document.getElementById('studyModeTimer').textContent = `${mins}:${secs}`;
        }

        function exitStudyMode() {
            document.getElementById('studyModeOverlay').classList.remove('active');
            if (studyModeInterval) {
                clearInterval(studyModeInterval);
                studyModeInterval = null;
            }
            const mins = Math.floor(studyModeSeconds / 60);
            if (mins > 0) {
                alert(`Great focus session! You studied for ${mins} minute${mins > 1 ? 's' : ''}.`);
            }
        }

        console.log(' Science Crossword, Element Quiz, and Study Mode loaded!');
    </script>

    <!-- Batch 79: Science Bingo Button -->
    <button class="bingo-btn" onclick="openBingo()" title="Science Bingo"></button>

    <!-- Science Bingo Modal -->
    <div class="bingo-modal" id="bingoModal">
        <div class="bingo-content">
            <div class="bingo-header">
                <h3 style="margin:0;"> Science Bingo</h3>
                <button onclick="closeBingo()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="bingo-body">
                <div class="bingo-call">
                    <p style="margin:0 0 5px 0;color:#666;">Current Call:</p>
                    <div class="bingo-call-term" id="bingoCallTerm">Click New Call!</div>
                </div>
                <div class="bingo-grid" id="bingoGrid"></div>
                <button onclick="newBingoCall()" style="width:100%;padding:12px;background:#e91e63;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">New Call</button>
                <button onclick="newBingoCard()" style="width:100%;padding:12px;background:#f48fb1;color:white;border:none;border-radius:8px;font-weight:bold;margin-top:8px;cursor:pointer;">New Card</button>
            </div>
        </div>
    </div>

    <!-- Concept Map Button -->
    <button class="concept-map-btn" onclick="openConceptMap()" title="Concept Map"></button>

    <!-- Concept Map Modal -->
    <div class="concept-map-modal" id="conceptMapModal">
        <div class="concept-map-content">
            <div class="concept-map-header">
                <h3 style="margin:0;"> Concept Map</h3>
                <button onclick="closeConceptMap()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="concept-map-body">
                <div style="margin-bottom:15px;">
                    <select id="conceptMapTopic" onchange="renderConceptMap()" style="width:100%;padding:10px;border:2px solid #00695c;border-radius:8px;font-size:1rem;">
                        <option value="energy">Energy</option>
                        <option value="cells">Cells</option>
                        <option value="forces">Forces</option>
                        <option value="matter">Matter</option>
                    </select>
                </div>
                <div id="conceptMapDisplay"></div>
            </div>
        </div>
    </div>

    <!-- Progress Graph Button -->
    <button class="progress-graph-btn" onclick="openProgressGraph()" title="Progress Graph"></button>

    <!-- Progress Graph Modal -->
    <div class="progress-graph-modal" id="progressGraphModal">
        <div class="progress-graph-content">
            <div class="progress-graph-header">
                <h3 style="margin:0;"> Progress Graph</h3>
                <button onclick="closeProgressGraph()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="progress-graph-body">
                <div class="graph-container" id="graphContainer"></div>
                <div class="graph-stats" id="graphStats"></div>
            </div>
        </div>
    </div>

    <script>
        // Science Bingo System
        const bingoTerms = [
            'Cell', 'Atom', 'Force', 'Energy', 'Mass', 'Gravity', 'Electron', 'Proton',
            'Neutron', 'Molecule', 'Element', 'Compound', 'Mixture', 'Solution', 'Reaction',
            'Photosynthesis', 'Respiration', 'Mitosis', 'DNA', 'Gene', 'Ecosystem', 'Habitat',
            'Species', 'Adaptation', 'Evolution', 'Friction', 'Velocity', 'Acceleration',
            'Momentum', 'Pressure', 'Density', 'Volume'
        ];

        let bingoCard = [];
        let calledTerms = [];

        function openBingo() {
            document.getElementById('bingoModal').classList.add('active');
            if (bingoCard.length === 0) newBingoCard();
        }

        function closeBingo() {
            document.getElementById('bingoModal').classList.remove('active');
        }

        function newBingoCard() {
            // Shuffle and pick 24 terms (center is FREE)
            const shuffled = [...bingoTerms].sort(() => Math.random() - 0.5);
            bingoCard = shuffled.slice(0, 24);
            bingoCard.splice(12, 0, 'FREE');
            calledTerms = [];
            document.getElementById('bingoCallTerm').textContent = 'Click New Call!';
            renderBingoCard();
        }

        function renderBingoCard() {
            const grid = document.getElementById('bingoGrid');
            grid.innerHTML = bingoCard.map((term, i) => {
                const isFree = term === 'FREE';
                const isMarked = calledTerms.includes(term) || isFree;
                return `<div class="bingo-cell ${isMarked ? 'marked' : ''} ${isFree ? 'free' : ''}"
                    onclick="markBingoCell(${i})">${term}</div>`;
            }).join('');
            checkBingo();
        }

        function markBingoCell(index) {
            const term = bingoCard[index];
            if (term === 'FREE') return;
            if (calledTerms.includes(term)) {
                calledTerms = calledTerms.filter(t => t !== term);
            } else {
                calledTerms.push(term);
            }
            renderBingoCard();
        }

        function newBingoCall() {
            const uncalled = bingoTerms.filter(t => !calledTerms.includes(t));
            if (uncalled.length === 0) {
                document.getElementById('bingoCallTerm').textContent = 'All terms called!';
                return;
            }
            const term = uncalled[Math.floor(Math.random() * uncalled.length)];
            document.getElementById('bingoCallTerm').textContent = term;
        }

        function checkBingo() {
            // Check rows, columns, and diagonals
            const lines = [
                [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24],
                [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24],
                [0,6,12,18,24], [4,8,12,16,20]
            ];

            for (const line of lines) {
                if (line.every(i => calledTerms.includes(bingoCard[i]) || bingoCard[i] === 'FREE')) {
                    addXP(30);
                    alert('BINGO! You win! +30 XP');
                    newBingoCard();
                    return;
                }
            }
        }

        // Concept Map System
        const conceptMaps = {
            energy: {
                central: 'ENERGY',
                branches: [
                    { node: 'Kinetic', children: ['Motion', 'Speed'] },
                    { node: 'Potential', children: ['Height', 'Stored'] },
                    { node: 'Thermal', children: ['Heat', 'Temperature'] },
                    { node: 'Chemical', children: ['Food', 'Fuel'] }
                ]
            },
            cells: {
                central: 'CELL',
                branches: [
                    { node: 'Nucleus', children: ['DNA', 'Control'] },
                    { node: 'Mitochondria', children: ['Energy', 'ATP'] },
                    { node: 'Membrane', children: ['Protection', 'Transport'] },
                    { node: 'Cytoplasm', children: ['Fluid', 'Organelles'] }
                ]
            },
            forces: {
                central: 'FORCES',
                branches: [
                    { node: 'Gravity', children: ['Weight', 'Attraction'] },
                    { node: 'Friction', children: ['Resistance', 'Heat'] },
                    { node: 'Magnetism', children: ['Poles', 'Attraction'] },
                    { node: 'Tension', children: ['Pulling', 'Stretch'] }
                ]
            },
            matter: {
                central: 'MATTER',
                branches: [
                    { node: 'Solid', children: ['Fixed shape', 'Dense'] },
                    { node: 'Liquid', children: ['Flows', 'Volume'] },
                    { node: 'Gas', children: ['Expands', 'Compressible'] },
                    { node: 'Plasma', children: ['Charged', 'Hot'] }
                ]
            }
        };

        function openConceptMap() {
            document.getElementById('conceptMapModal').classList.add('active');
            renderConceptMap();
        }

        function closeConceptMap() {
            document.getElementById('conceptMapModal').classList.remove('active');
        }

        function renderConceptMap() {
            const topic = document.getElementById('conceptMapTopic').value;
            const map = conceptMaps[topic];
            const display = document.getElementById('conceptMapDisplay');

            let html = `<div class="concept-row"><span class="concept-node central">${map.central}</span></div>`;
            html += '<div class="concept-row"><span class="concept-arrow"></span></div>';

            map.branches.forEach((branch, i) => {
                html += `<div class="concept-row">
                    <span class="concept-node">${branch.node}</span>
                    <span class="concept-arrow"></span>
                    ${branch.children.map(c => `<span class="concept-node">${c}</span>`).join('')}
                </div>`;
            });

            display.innerHTML = html;
        }

        // Progress Graph System
        function openProgressGraph() {
            document.getElementById('progressGraphModal').classList.add('active');
            renderProgressGraph();
        }

        function closeProgressGraph() {
            document.getElementById('progressGraphModal').classList.remove('active');
        }

        function renderProgressGraph() {
            // Get daily data from localStorage
            const dailyData = JSON.parse(localStorage.getItem('dailyProgressData') || '{}');
            const today = new Date();
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            // Generate data for last 7 days
            const graphData = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const key = date.toISOString().split('T')[0];
                const dayName = days[date.getDay()];
                const questions = dailyData[key] || Math.floor(Math.random() * 20); // Demo data
                graphData.push({ day: dayName, value: questions });
            }

            const maxVal = Math.max(...graphData.map(d => d.value), 1);
            const container = document.getElementById('graphContainer');
            container.innerHTML = graphData.map(d => `
                <div class="graph-bar" style="height: ${(d.value / maxVal) * 150}px;">
                    <span class="graph-bar-value">${d.value}</span>
                    <span class="graph-bar-label">${d.day}</span>
                </div>
            `).join('');

            // Stats
            const totalQuestions = graphData.reduce((sum, d) => sum + d.value, 0);
            const avgDaily = Math.round(totalQuestions / 7);
            const totalXP = parseInt(localStorage.getItem('scienceXP')) || 0;
            const currentLevel = parseInt(localStorage.getItem('scienceLevel')) || 1;

            document.getElementById('graphStats').innerHTML = `
                <div class="graph-stat">
                    <div class="graph-stat-value">${totalQuestions}</div>
                    <div class="graph-stat-label">Questions This Week</div>
                </div>
                <div class="graph-stat">
                    <div class="graph-stat-value">${avgDaily}</div>
                    <div class="graph-stat-label">Daily Average</div>
                </div>
                <div class="graph-stat">
                    <div class="graph-stat-value">${totalXP}</div>
                    <div class="graph-stat-label">Total XP</div>
                </div>
                <div class="graph-stat">
                    <div class="graph-stat-value">Lv ${currentLevel}</div>
                    <div class="graph-stat-label">Current Level</div>
                </div>
            `;
        }

        // Initialize
        newBingoCard();
        renderConceptMap();

        console.log(' Science Bingo, Concept Map, and Progress Graph loaded!');
    </script>

    <!-- Batch 80: Timer Challenge Button -->
    <button class="timer-challenge-btn" onclick="openTimerChallenge()" title="Timer Challenge"></button>

    <!-- Timer Challenge Modal -->
    <div class="timer-challenge-modal" id="timerChallengeModal">
        <div class="timer-challenge-content">
            <div class="timer-challenge-header">
                <h3 style="margin:0;"> Timer Challenge</h3>
                <button onclick="closeTimerChallenge()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="timer-challenge-body">
                <div class="timer-display" id="timerDisplay">10</div>
                <div class="timer-question" id="timerQuestion">Click Start to begin!</div>
                <div class="timer-options" id="timerOptions"></div>
                <button onclick="startTimerChallenge()" id="timerStartBtn" style="width:100%;padding:15px;background:#d32f2f;color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;margin-top:15px;">Start Challenge</button>
                <div class="timer-score" id="timerScore">Best Streak: 0</div>
            </div>
        </div>
    </div>

    <!-- Keyword Search Button -->
    <button class="keyword-search-btn" onclick="openKeywordSearch()" title="Keyword Search"></button>

    <!-- Keyword Search Modal -->
    <div class="keyword-search-modal" id="keywordSearchModal">
        <div class="keyword-search-content">
            <div class="keyword-search-header">
                <h3 style="margin:0;"> Keyword Search</h3>
                <button onclick="closeKeywordSearch()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="keyword-search-body">
                <input type="text" class="keyword-input" id="keywordInput" placeholder="Search science terms..." oninput="searchKeywords()">
                <div class="keyword-results" id="keywordResults"></div>
            </div>
        </div>
    </div>

    <!-- Note Taker Button -->
    <button class="note-taker-btn" onclick="openNoteTaker()" title="Note Taker"></button>

    <!-- Note Taker Modal -->
    <div class="note-taker-modal" id="noteTakerModal">
        <div class="note-taker-content">
            <div class="note-taker-header">
                <h3 style="margin:0;"> Note Taker</h3>
                <button onclick="closeNoteTaker()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="note-taker-body">
                <textarea class="note-textarea" id="noteTextarea" placeholder="Write your science notes here..."></textarea>
                <button onclick="saveNote()" style="width:100%;padding:12px;background:#ffa000;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin-bottom:15px;">Save Note</button>
                <h4 style="margin:0 0 10px 0;color:#ffa000;">Saved Notes</h4>
                <div class="note-list" id="noteList"></div>
            </div>
        </div>
    </div>

    <script>
        // Timer Challenge System
        const timerQuestions = [
            { q: 'What is the chemical symbol for water?', a: 'H2O', options: ['H2O', 'CO2', 'NaCl', 'O2'] },
            { q: 'What force keeps us on Earth?', a: 'Gravity', options: ['Gravity', 'Friction', 'Magnetism', 'Tension'] },
            { q: 'What is the powerhouse of the cell?', a: 'Mitochondria', options: ['Nucleus', 'Mitochondria', 'Ribosome', 'Membrane'] },
            { q: 'What gas do plants release?', a: 'Oxygen', options: ['Carbon dioxide', 'Nitrogen', 'Oxygen', 'Hydrogen'] },
            { q: 'What is the unit of force?', a: 'Newton', options: ['Joule', 'Watt', 'Newton', 'Pascal'] },
            { q: 'How many planets are in our solar system?', a: '8', options: ['7', '8', '9', '10'] },
            { q: 'What is the hardest natural substance?', a: 'Diamond', options: ['Gold', 'Iron', 'Diamond', 'Quartz'] },
            { q: 'What is the speed of light?', a: '300,000 km/s', options: ['150,000 km/s', '300,000 km/s', '500,000 km/s', '1,000,000 km/s'] },
            { q: 'What type of energy does food contain?', a: 'Chemical', options: ['Kinetic', 'Thermal', 'Chemical', 'Nuclear'] },
            { q: 'What is the formula for force?', a: 'F = ma', options: ['F = ma', 'E = mc', 'V = IR', 'P = IV'] }
        ];

        let timerInterval = null;
        let timerSeconds = 10;
        let timerStreak = 0;
        let timerBestStreak = parseInt(localStorage.getItem('timerBestStreak')) || 0;
        let currentTimerQuestion = null;

        function openTimerChallenge() {
            document.getElementById('timerChallengeModal').classList.add('active');
            document.getElementById('timerScore').textContent = `Best Streak: ${timerBestStreak}`;
        }

        function closeTimerChallenge() {
            document.getElementById('timerChallengeModal').classList.remove('active');
            stopTimerChallenge();
        }

        function startTimerChallenge() {
            timerStreak = 0;
            document.getElementById('timerStartBtn').style.display = 'none';
            nextTimerQuestion();
        }

        function nextTimerQuestion() {
            currentTimerQuestion = timerQuestions[Math.floor(Math.random() * timerQuestions.length)];
            document.getElementById('timerQuestion').textContent = currentTimerQuestion.q;

            const shuffled = [...currentTimerQuestion.options].sort(() => Math.random() - 0.5);
            document.getElementById('timerOptions').innerHTML = shuffled.map(opt =>
                `<button class="timer-option" onclick="checkTimerAnswer('${opt}')">${opt}</button>`
            ).join('');

            timerSeconds = Math.max(5, 10 - Math.floor(timerStreak / 2)); // Gets faster
            updateTimerDisplay();

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                if (timerSeconds <= 0) {
                    endTimerChallenge('Time\'s up!');
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            display.textContent = timerSeconds;
            display.classList.toggle('warning', timerSeconds <= 3);
        }

        function checkTimerAnswer(answer) {
            if (answer === currentTimerQuestion.a) {
                timerStreak++;
                addXP(5);
                nextTimerQuestion();
            } else {
                endTimerChallenge('Wrong answer!');
            }
        }

        function endTimerChallenge(reason) {
            stopTimerChallenge();
            if (timerStreak > timerBestStreak) {
                timerBestStreak = timerStreak;
                localStorage.setItem('timerBestStreak', timerBestStreak);
            }
            document.getElementById('timerQuestion').textContent = `${reason} Streak: ${timerStreak}`;
            document.getElementById('timerOptions').innerHTML = '';
            document.getElementById('timerStartBtn').style.display = 'block';
            document.getElementById('timerScore').textContent = `Best Streak: ${timerBestStreak}`;
        }

        function stopTimerChallenge() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Keyword Search System
        const scienceKeywords = [
            { term: 'Atom', definition: 'The smallest unit of an element that retains its chemical properties' },
            { term: 'Cell', definition: 'The basic structural and functional unit of all living organisms' },
            { term: 'DNA', definition: 'Deoxyribonucleic acid - carries genetic information' },
            { term: 'Energy', definition: 'The capacity to do work or cause change' },
            { term: 'Force', definition: 'A push or pull that can change an object\'s motion' },
            { term: 'Gravity', definition: 'The force that attracts objects with mass toward each other' },
            { term: 'Habitat', definition: 'The natural environment where an organism lives' },
            { term: 'Ion', definition: 'An atom or molecule with an electric charge' },
            { term: 'Kinetic', definition: 'Energy of motion' },
            { term: 'Light', definition: 'Electromagnetic radiation visible to the human eye' },
            { term: 'Mass', definition: 'The amount of matter in an object' },
            { term: 'Neutron', definition: 'A subatomic particle with no charge' },
            { term: 'Organism', definition: 'Any living thing' },
            { term: 'Photosynthesis', definition: 'Process by which plants convert light to chemical energy' },
            { term: 'Quantum', definition: 'The smallest discrete unit of a physical property' },
            { term: 'Respiration', definition: 'Process of breaking down food to release energy' },
            { term: 'Species', definition: 'A group of organisms that can reproduce together' },
            { term: 'Temperature', definition: 'A measure of the average kinetic energy of particles' },
            { term: 'Ultraviolet', definition: 'Electromagnetic radiation with wavelength shorter than visible light' },
            { term: 'Velocity', definition: 'Speed in a given direction' },
            { term: 'Wave', definition: 'A disturbance that transfers energy through matter or space' },
            { term: 'Xenon', definition: 'A noble gas element used in lighting' },
            { term: 'Yield', definition: 'The amount of product obtained in a chemical reaction' },
            { term: 'Zero', definition: 'Absolute zero is the lowest possible temperature (-273.15C)' }
        ];

        function openKeywordSearch() {
            document.getElementById('keywordSearchModal').classList.add('active');
            document.getElementById('keywordInput').value = '';
            searchKeywords();
        }

        function closeKeywordSearch() {
            document.getElementById('keywordSearchModal').classList.remove('active');
        }

        function searchKeywords() {
            const query = document.getElementById('keywordInput').value.toLowerCase();
            const filtered = scienceKeywords.filter(k =>
                k.term.toLowerCase().includes(query) ||
                k.definition.toLowerCase().includes(query)
            );

            document.getElementById('keywordResults').innerHTML = filtered.map(k => `
                <div class="keyword-item">
                    <div class="keyword-term">${k.term}</div>
                    <div class="keyword-definition">${k.definition}</div>
                </div>
            `).join('') || '<p style="text-align:center;color:#999;">No results found</p>';
        }

        // Note Taker System
        function openNoteTaker() {
            document.getElementById('noteTakerModal').classList.add('active');
            renderNotes();
        }

        function closeNoteTaker() {
            document.getElementById('noteTakerModal').classList.remove('active');
        }

        function getNotes() {
            return JSON.parse(localStorage.getItem('scienceNotes') || '[]');
        }

        function saveNote() {
            const text = document.getElementById('noteTextarea').value.trim();
            if (!text) return;

            const notes = getNotes();
            notes.unshift({
                text: text,
                date: new Date().toLocaleString()
            });

            if (notes.length > 50) notes.pop();
            localStorage.setItem('scienceNotes', JSON.stringify(notes));

            document.getElementById('noteTextarea').value = '';
            renderNotes();
            addXP(2);
        }

        function deleteNote(index) {
            const notes = getNotes();
            notes.splice(index, 1);
            localStorage.setItem('scienceNotes', JSON.stringify(notes));
            renderNotes();
        }

        function renderNotes() {
            const notes = getNotes();
            document.getElementById('noteList').innerHTML = notes.length > 0 ?
                notes.map((n, i) => `
                    <div class="note-item">
                        <button class="note-delete" onclick="deleteNote(${i})"></button>
                        <div class="note-item-text">${n.text}</div>
                        <div class="note-item-date">${n.date}</div>
                    </div>
                `).join('') :
                '<p style="text-align:center;color:#999;">No notes yet. Start writing!</p>';
        }

        console.log(' Timer Challenge, Keyword Search, and Note Taker loaded!');
    </script>

    <!-- Batch 81: Science Joke Button -->
    <button class="joke-btn" onclick="openJoke()" title="Science Joke"></button>

    <!-- Science Joke Modal -->
    <div class="joke-modal" id="jokeModal">
        <div class="joke-content">
            <div class="joke-header">
                <h3 style="margin:0;"> Science Joke</h3>
                <button onclick="closeJoke()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="joke-body">
                <div class="joke-text" id="jokeText">Loading...</div>
                <div class="joke-punchline" id="jokePunchline" style="display:none;"></div>
                <button onclick="showPunchline()" id="punchlineBtn" style="padding:12px 30px;background:#ff6f00;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin-bottom:10px;">Show Answer</button>
                <button onclick="newJoke()" style="padding:12px 30px;background:#ffb74d;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">Next Joke</button>
            </div>
        </div>
    </div>

    <!-- Lab Safety Button -->
    <button class="lab-safety-btn" onclick="openLabSafety()" title="Lab Safety"></button>

    <!-- Lab Safety Modal -->
    <div class="lab-safety-modal" id="labSafetyModal">
        <div class="lab-safety-content">
            <div class="lab-safety-header">
                <h3 style="margin:0;"> Lab Safety Quiz</h3>
                <button onclick="closeLabSafety()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="lab-safety-body">
                <div class="safety-question" id="safetyQuestion">Loading...</div>
                <div class="safety-options" id="safetyOptions"></div>
                <p style="text-align:center;margin-top:15px;color:#666;" id="safetyScore">Score: 0 / 0</p>
            </div>
        </div>
    </div>

    <!-- Quick Convert Button -->
    <button class="convert-btn" onclick="openConvert()" title="Quick Convert"></button>

    <!-- Quick Convert Modal -->
    <div class="convert-modal" id="convertModal">
        <div class="convert-content">
            <div class="convert-header">
                <h3 style="margin:0;"> Quick Convert</h3>
                <button onclick="closeConvert()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="convert-body">
                <select class="convert-type-select" id="convertType" onchange="updateConvertUnits()">
                    <option value="length">Length</option>
                    <option value="mass">Mass</option>
                    <option value="temperature">Temperature</option>
                    <option value="time">Time</option>
                </select>
                <div class="convert-input-group">
                    <input type="number" class="convert-input" id="convertInput" placeholder="Enter value" oninput="doConversion()">
                    <span class="convert-unit" id="convertFromUnit">m</span>
                </div>
                <div class="convert-result">
                    <div class="convert-result-value" id="convertResultValue">0</div>
                    <div class="convert-result-unit" id="convertResultUnit">cm</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Science Joke System
        const scienceJokes = [
            { setup: 'Why do biologists look forward to casual Fridays?', punchline: 'They\'re allowed to wear genes to work!' },
            { setup: 'What do you call an acid with an attitude?', punchline: 'A-mean-o acid!' },
            { setup: 'Why can\'t you trust atoms?', punchline: 'They make up everything!' },
            { setup: 'What did the scientist say when he found 2 isotopes of helium?', punchline: 'HeHe!' },
            { setup: 'Why did the physicist break up with the biologist?', punchline: 'There was no chemistry!' },
            { setup: 'What\'s a physicist\'s favorite food?', punchline: 'Fission chips!' },
            { setup: 'Why are chemists great for solving problems?', punchline: 'They have all the solutions!' },
            { setup: 'What do you do with a sick chemist?', punchline: 'If you can\'t helium, and you can\'t curium, then you might as well barium!' },
            { setup: 'Why did the germ cross the microscope?', punchline: 'To get to the other slide!' },
            { setup: 'What did one ion say to the other?', punchline: 'I\'ve got my ion you!' }
        ];

        let currentJoke = null;

        function openJoke() {
            document.getElementById('jokeModal').classList.add('active');
            newJoke();
        }

        function closeJoke() {
            document.getElementById('jokeModal').classList.remove('active');
        }

        function newJoke() {
            currentJoke = scienceJokes[Math.floor(Math.random() * scienceJokes.length)];
            document.getElementById('jokeText').textContent = currentJoke.setup;
            document.getElementById('jokePunchline').style.display = 'none';
            document.getElementById('jokePunchline').textContent = currentJoke.punchline;
            document.getElementById('punchlineBtn').style.display = 'inline-block';
        }

        function showPunchline() {
            document.getElementById('jokePunchline').style.display = 'block';
            document.getElementById('punchlineBtn').style.display = 'none';
        }

        // Lab Safety Quiz System
        const safetyQuestions = [
            { q: 'What should you always wear when handling chemicals?', a: 'Safety goggles', options: ['Sunglasses', 'Safety goggles', 'Reading glasses', 'Nothing'] },
            { q: 'What do you do if chemicals splash in your eyes?', a: 'Use the eyewash station', options: ['Rub your eyes', 'Use the eyewash station', 'Ignore it', 'Use soap'] },
            { q: 'Which direction should you point a test tube when heating it?', a: 'Away from yourself and others', options: ['Towards yourself', 'Towards your partner', 'Away from yourself and others', 'Straight up'] },
            { q: 'What should you do with long hair in the lab?', a: 'Tie it back', options: ['Leave it loose', 'Tie it back', 'Cut it', 'Cover with hands'] },
            { q: 'Where should you eat or drink in the science building?', a: 'Only in designated areas', options: ['In the lab', 'Only in designated areas', 'Anywhere', 'At your lab bench'] },
            { q: 'What should you do before leaving the lab?', a: 'Wash your hands', options: ['Just leave', 'Wash your hands', 'Touch your face', 'Take samples home'] },
            { q: 'What do you use to pick up broken glass?', a: 'A dustpan and brush', options: ['Your hands', 'A dustpan and brush', 'Paper towels', 'Leave it'] },
            { q: 'What should you wear on your feet in the lab?', a: 'Closed-toe shoes', options: ['Sandals', 'Flip-flops', 'Closed-toe shoes', 'No shoes'] }
        ];

        let safetyScore = { correct: 0, total: 0 };
        let currentSafetyQuestion = null;

        function openLabSafety() {
            document.getElementById('labSafetyModal').classList.add('active');
            safetyScore = { correct: 0, total: 0 };
            nextSafetyQuestion();
        }

        function closeLabSafety() {
            document.getElementById('labSafetyModal').classList.remove('active');
        }

        function nextSafetyQuestion() {
            currentSafetyQuestion = safetyQuestions[Math.floor(Math.random() * safetyQuestions.length)];
            document.getElementById('safetyQuestion').textContent = currentSafetyQuestion.q;

            const shuffled = [...currentSafetyQuestion.options].sort(() => Math.random() - 0.5);
            document.getElementById('safetyOptions').innerHTML = shuffled.map(opt =>
                `<button class="safety-option" onclick="checkSafetyAnswer('${opt}')">${opt}</button>`
            ).join('');

            updateSafetyScore();
        }

        function checkSafetyAnswer(answer) {
            const buttons = document.querySelectorAll('.safety-option');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === currentSafetyQuestion.a) {
                    btn.classList.add('correct');
                } else if (btn.textContent === answer && answer !== currentSafetyQuestion.a) {
                    btn.classList.add('wrong');
                }
            });

            safetyScore.total++;
            if (answer === currentSafetyQuestion.a) {
                safetyScore.correct++;
                addXP(5);
            }

            updateSafetyScore();
            setTimeout(nextSafetyQuestion, 1500);
        }

        function updateSafetyScore() {
            document.getElementById('safetyScore').textContent = `Score: ${safetyScore.correct} / ${safetyScore.total}`;
        }

        // Quick Convert System
        const conversions = {
            length: { from: 'm', to: 'cm', factor: 100, toName: 'centimeters' },
            mass: { from: 'kg', to: 'g', factor: 1000, toName: 'grams' },
            temperature: { from: 'C', to: 'F', formula: (c) => (c * 9/5) + 32, toName: 'Fahrenheit' },
            time: { from: 'hr', to: 'min', factor: 60, toName: 'minutes' }
        };

        function openConvert() {
            document.getElementById('convertModal').classList.add('active');
            updateConvertUnits();
        }

        function closeConvert() {
            document.getElementById('convertModal').classList.remove('active');
        }

        function updateConvertUnits() {
            const type = document.getElementById('convertType').value;
            const conv = conversions[type];
            document.getElementById('convertFromUnit').textContent = conv.from;
            document.getElementById('convertResultUnit').textContent = conv.toName;
            document.getElementById('convertInput').value = '';
            document.getElementById('convertResultValue').textContent = '0';
        }

        function doConversion() {
            const type = document.getElementById('convertType').value;
            const conv = conversions[type];
            const input = parseFloat(document.getElementById('convertInput').value) || 0;

            let result;
            if (conv.formula) {
                result = conv.formula(input);
            } else {
                result = input * conv.factor;
            }

            document.getElementById('convertResultValue').textContent = result.toFixed(2);
        }

        console.log(' Science Joke, Lab Safety Quiz, and Quick Convert loaded!');
    </script>

    <!-- Batch 82: Science Timeline Button -->
    <button class="timeline-btn" onclick="openTimeline()" title="Science Timeline"></button>

    <!-- Science Timeline Modal -->
    <div class="timeline-modal" id="timelineModal">
        <div class="timeline-content">
            <div class="timeline-header">
                <h3 style="margin:0;"> Science Timeline</h3>
                <button onclick="closeTimeline()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="timeline-body" id="timelineBody"></div>
        </div>
    </div>

    <!-- Lab Equipment Button -->
    <button class="equipment-btn" onclick="openEquipment()" title="Lab Equipment"></button>

    <!-- Lab Equipment Modal -->
    <div class="equipment-modal" id="equipmentModal">
        <div class="equipment-content">
            <div class="equipment-header">
                <h3 style="margin:0;"> Lab Equipment</h3>
                <button onclick="closeEquipment()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="equipment-body">
                <div class="equipment-card" id="equipmentCard">
                    <div class="equipment-icon" id="equipmentIcon"></div>
                    <div class="equipment-name" id="equipmentName">Loading...</div>
                    <div class="equipment-use" id="equipmentUse">...</div>
                </div>
                <div class="equipment-nav">
                    <button onclick="prevEquipment()"> Prev</button>
                    <button onclick="nextEquipment()">Next </button>
                </div>
                <p style="text-align:center;color:#666;margin-top:10px;" id="equipmentCounter">1 / 10</p>
            </div>
        </div>
    </div>

    <!-- Quick Quiz Button -->
    <button class="quick-quiz-btn" onclick="openQuickQuiz()" title="Quick Quiz"></button>

    <!-- Quick Quiz Modal -->
    <div class="quick-quiz-modal" id="quickQuizModal">
        <div class="quick-quiz-content">
            <div class="quick-quiz-header">
                <h3 style="margin:0;"> Quick Quiz</h3>
                <button onclick="closeQuickQuiz()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="quick-quiz-body">
                <div class="quick-quiz-question" id="quickQuizQuestion">Loading...</div>
                <div class="quick-quiz-options" id="quickQuizOptions"></div>
                <div class="quick-quiz-counter" id="quickQuizCounter">0 correct</div>
            </div>
        </div>
    </div>

    <script>
        // Science Timeline System
        const timelineEvents = [
            { year: '1543', title: 'Heliocentric Model', desc: 'Copernicus proposes that Earth orbits the Sun' },
            { year: '1665', title: 'Cell Discovery', desc: 'Robert Hooke observes cells in cork using a microscope' },
            { year: '1687', title: 'Laws of Motion', desc: 'Newton publishes his three laws of motion and gravity' },
            { year: '1859', title: 'Evolution Theory', desc: 'Darwin publishes On the Origin of Species' },
            { year: '1869', title: 'Periodic Table', desc: 'Mendeleev creates the periodic table of elements' },
            { year: '1896', title: 'Radioactivity', desc: 'Becquerel discovers radioactivity in uranium' },
            { year: '1905', title: 'Special Relativity', desc: 'Einstein publishes theory of special relativity and E=mc' },
            { year: '1953', title: 'DNA Structure', desc: 'Watson and Crick discover the double helix structure of DNA' },
            { year: '1969', title: 'Moon Landing', desc: 'Neil Armstrong becomes first human on the Moon' },
            { year: '2012', title: 'Higgs Boson', desc: 'CERN confirms discovery of the Higgs boson particle' }
        ];

        function openTimeline() {
            document.getElementById('timelineModal').classList.add('active');
            renderTimeline();
        }

        function closeTimeline() {
            document.getElementById('timelineModal').classList.remove('active');
        }

        function renderTimeline() {
            document.getElementById('timelineBody').innerHTML = timelineEvents.map(e => `
                <div class="timeline-item">
                    <div class="timeline-year">${e.year}</div>
                    <div class="timeline-event">
                        <div class="timeline-title">${e.title}</div>
                        <div class="timeline-desc">${e.desc}</div>
                    </div>
                </div>
            `).join('');
        }

        // Lab Equipment System
        const labEquipment = [
            { icon: '', name: 'Microscope', use: 'Used to magnify small objects that cannot be seen with the naked eye' },
            { icon: '', name: 'Test Tube', use: 'Used to hold, mix, or heat small quantities of chemicals' },
            { icon: '', name: 'Beaker', use: 'Used to hold and measure liquids, can be heated' },
            { icon: '', name: 'Petri Dish', use: 'Used to culture bacteria or other microorganisms' },
            { icon: '', name: 'Thermometer', use: 'Used to measure temperature of substances' },
            { icon: '', name: 'Balance Scale', use: 'Used to measure the mass of objects precisely' },
            { icon: '', name: 'Bunsen Burner', use: 'Used to heat substances using a gas flame' },
            { icon: '', name: 'Magnet', use: 'Used to test magnetic properties or separate materials' },
            { icon: '', name: 'Ruler/Meter Stick', use: 'Used to measure length and distance' },
            { icon: '', name: 'Light Source', use: 'Used in experiments requiring light or for illumination' }
        ];

        let currentEquipmentIndex = 0;

        function openEquipment() {
            document.getElementById('equipmentModal').classList.add('active');
            updateEquipmentDisplay();
        }

        function closeEquipment() {
            document.getElementById('equipmentModal').classList.remove('active');
        }

        function updateEquipmentDisplay() {
            const e = labEquipment[currentEquipmentIndex];
            document.getElementById('equipmentIcon').textContent = e.icon;
            document.getElementById('equipmentName').textContent = e.name;
            document.getElementById('equipmentUse').textContent = e.use;
            document.getElementById('equipmentCounter').textContent = `${currentEquipmentIndex + 1} / ${labEquipment.length}`;
        }

        function nextEquipment() {
            currentEquipmentIndex = (currentEquipmentIndex + 1) % labEquipment.length;
            updateEquipmentDisplay();
        }

        function prevEquipment() {
            currentEquipmentIndex = (currentEquipmentIndex - 1 + labEquipment.length) % labEquipment.length;
            updateEquipmentDisplay();
        }

        // Quick Quiz System
        const quickQuizQuestions = [
            { q: 'H2O is?', a: 'Water', options: ['Water', 'Oxygen', 'Hydrogen', 'Salt'] },
            { q: 'Speed unit?', a: 'm/s', options: ['kg', 'm/s', 'N', 'J'] },
            { q: 'Cell powerhouse?', a: 'Mitochondria', options: ['Nucleus', 'Mitochondria', 'Ribosome', 'Vacuole'] },
            { q: 'Planets count?', a: '8', options: ['7', '8', '9', '10'] },
            { q: 'Photosynthesis gas in?', a: 'CO2', options: ['O2', 'CO2', 'N2', 'H2'] },
            { q: 'F = m  ?', a: 'a', options: ['v', 'a', 't', 'd'] },
            { q: 'Largest organ?', a: 'Skin', options: ['Heart', 'Liver', 'Skin', 'Brain'] },
            { q: 'Diamond is made of?', a: 'Carbon', options: ['Iron', 'Carbon', 'Silicon', 'Gold'] },
            { q: 'Sound needs?', a: 'Medium', options: ['Light', 'Medium', 'Vacuum', 'Heat'] },
            { q: 'Blood type O is?', a: 'Universal donor', options: ['Rare', 'Universal donor', 'Most common', 'Dangerous'] }
        ];

        let quickQuizCorrect = 0;

        function openQuickQuiz() {
            document.getElementById('quickQuizModal').classList.add('active');
            quickQuizCorrect = 0;
            nextQuickQuiz();
        }

        function closeQuickQuiz() {
            document.getElementById('quickQuizModal').classList.remove('active');
        }

        function nextQuickQuiz() {
            const q = quickQuizQuestions[Math.floor(Math.random() * quickQuizQuestions.length)];
            document.getElementById('quickQuizQuestion').textContent = q.q;

            const shuffled = [...q.options].sort(() => Math.random() - 0.5);
            document.getElementById('quickQuizOptions').innerHTML = shuffled.map(opt =>
                `<button class="quick-quiz-option" onclick="checkQuickQuiz('${opt}', '${q.a}')">${opt}</button>`
            ).join('');

            document.getElementById('quickQuizCounter').textContent = `${quickQuizCorrect} correct`;
        }

        function checkQuickQuiz(answer, correct) {
            const buttons = document.querySelectorAll('.quick-quiz-option');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === correct) {
                    btn.classList.add('correct');
                } else if (btn.textContent === answer && answer !== correct) {
                    btn.classList.add('wrong');
                }
            });

            if (answer === correct) {
                quickQuizCorrect++;
                addXP(3);
            }

            document.getElementById('quickQuizCounter').textContent = `${quickQuizCorrect} correct`;
            setTimeout(nextQuickQuiz, 1000);
        }

        console.log(' Science Timeline, Lab Equipment, and Quick Quiz loaded!');
    </script>

    <!-- Batch 83: Science Quote Button -->
    <button class="quote-btn" onclick="openQuote()" title="Science Quote"></button>

    <!-- Science Quote Modal -->
    <div class="quote-modal" id="quoteModal">
        <div class="quote-content">
            <div class="quote-header">
                <h3 style="margin:0;"> Science Quote</h3>
                <button onclick="closeQuote()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="quote-body">
                <div class="quote-text" id="quoteText">"Loading..."</div>
                <div class="quote-author" id="quoteAuthor">- Loading</div>
                <button onclick="newQuote()" style="margin-top:20px;padding:12px 30px;background:#6a1b9a;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">New Quote</button>
            </div>
        </div>
    </div>

    <!-- Practice Mode Button -->
    <button class="practice-btn" onclick="openPractice()" title="Practice Mode"></button>

    <!-- Practice Mode Modal -->
    <div class="practice-modal" id="practiceModal">
        <div class="practice-content">
            <div class="practice-header">
                <h3 style="margin:0;"> Practice Mode</h3>
                <button onclick="closePractice()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="practice-body">
                <select class="practice-topic-select" id="practiceTopic" onchange="startPractice()">
                    <option value="physics">Physics</option>
                    <option value="biology">Biology</option>
                    <option value="chemistry">Chemistry</option>
                </select>
                <div class="practice-question" id="practiceQuestion">Select a topic to start!</div>
                <div class="practice-options" id="practiceOptions"></div>
                <p style="text-align:center;margin-top:15px;color:#1976d2;font-weight:bold;" id="practiceScore">Score: 0</p>
            </div>
        </div>
    </div>

    <!-- Daily Challenge Button -->
    <button class="daily-challenge-btn" onclick="openDailyChallenge()" title="Daily Challenge"></button>

    <!-- Daily Challenge Modal -->
    <div class="daily-challenge-modal" id="dailyChallengeModal">
        <div class="daily-challenge-content">
            <div class="daily-challenge-header">
                <h3 style="margin:0;"> Daily Challenge</h3>
                <button onclick="closeDailyChallenge()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="daily-challenge-body">
                <div class="challenge-info">
                    <div class="challenge-date" id="challengeDate">Today's Challenge</div>
                    <div class="challenge-title" id="challengeTitle">Loading...</div>
                    <div class="challenge-desc" id="challengeDesc">...</div>
                </div>
                <div class="challenge-progress">
                    <div class="challenge-progress-bar">
                        <div class="challenge-progress-fill" id="challengeProgressFill" style="width: 0%;"></div>
                    </div>
                    <span id="challengeProgressText">0 / 5 completed</span>
                </div>
                <button onclick="startDailyChallenge()" id="challengeStartBtn" style="width:100%;padding:15px;background:#f57c00;color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">Start Challenge</button>
                <div class="challenge-reward" id="challengeReward">Reward: 50 XP</div>
            </div>
        </div>
    </div>

    <script>
        // Science Quote System
        const scienceQuotes = [
            { text: "The important thing is not to stop questioning. Curiosity has its own reason for existing.", author: "Albert Einstein" },
            { text: "Science is a way of thinking much more than it is a body of knowledge.", author: "Carl Sagan" },
            { text: "Nothing in life is to be feared, it is only to be understood.", author: "Marie Curie" },
            { text: "The good thing about science is that it's true whether or not you believe in it.", author: "Neil deGrasse Tyson" },
            { text: "Somewhere, something incredible is waiting to be known.", author: "Carl Sagan" },
            { text: "In science, there are no shortcuts to truth.", author: "Karl Popper" },
            { text: "Research is what I'm doing when I don't know what I'm doing.", author: "Wernher von Braun" },
            { text: "Science is not only a disciple of reason but also one of romance and passion.", author: "Stephen Hawking" },
            { text: "The science of today is the technology of tomorrow.", author: "Edward Teller" },
            { text: "Science knows no country, because knowledge belongs to humanity.", author: "Louis Pasteur" }
        ];

        function openQuote() {
            document.getElementById('quoteModal').classList.add('active');
            newQuote();
        }

        function closeQuote() {
            document.getElementById('quoteModal').classList.remove('active');
        }

        function newQuote() {
            const q = scienceQuotes[Math.floor(Math.random() * scienceQuotes.length)];
            document.getElementById('quoteText').textContent = `"${q.text}"`;
            document.getElementById('quoteAuthor').textContent = `- ${q.author}`;
        }

        // Practice Mode System
        const practiceQuestions = {
            physics: [
                { q: 'What is the unit of force?', a: 'Newton', options: ['Joule', 'Newton', 'Watt', 'Pascal'] },
                { q: 'What is Newton\'s first law about?', a: 'Inertia', options: ['Inertia', 'Acceleration', 'Action-Reaction', 'Gravity'] },
                { q: 'What type of energy is stored energy?', a: 'Potential', options: ['Kinetic', 'Potential', 'Thermal', 'Nuclear'] }
            ],
            biology: [
                { q: 'What organelle produces ATP?', a: 'Mitochondria', options: ['Nucleus', 'Mitochondria', 'Ribosome', 'Vacuole'] },
                { q: 'What is the process of cell division?', a: 'Mitosis', options: ['Osmosis', 'Mitosis', 'Photosynthesis', 'Respiration'] },
                { q: 'DNA stands for?', a: 'Deoxyribonucleic acid', options: ['Deoxyribonucleic acid', 'Dinitrogen acid', 'Double nucleic acid', 'Direct nuclear acid'] }
            ],
            chemistry: [
                { q: 'What is the atomic number of Carbon?', a: '6', options: ['4', '6', '8', '12'] },
                { q: 'What is H2O commonly called?', a: 'Water', options: ['Hydrogen', 'Oxygen', 'Water', 'Salt'] },
                { q: 'What type of bond shares electrons?', a: 'Covalent', options: ['Ionic', 'Covalent', 'Metallic', 'Hydrogen'] }
            ]
        };

        let practiceScore = 0;

        function openPractice() {
            document.getElementById('practiceModal').classList.add('active');
            practiceScore = 0;
            startPractice();
        }

        function closePractice() {
            document.getElementById('practiceModal').classList.remove('active');
        }

        function startPractice() {
            const topic = document.getElementById('practiceTopic').value;
            const questions = practiceQuestions[topic];
            const q = questions[Math.floor(Math.random() * questions.length)];

            document.getElementById('practiceQuestion').textContent = q.q;

            const shuffled = [...q.options].sort(() => Math.random() - 0.5);
            document.getElementById('practiceOptions').innerHTML = shuffled.map(opt =>
                `<button class="practice-option" onclick="checkPractice('${opt}', '${q.a}')">${opt}</button>`
            ).join('');

            document.getElementById('practiceScore').textContent = `Score: ${practiceScore}`;
        }

        function checkPractice(answer, correct) {
            const buttons = document.querySelectorAll('.practice-option');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === correct) {
                    btn.classList.add('correct');
                } else if (btn.textContent === answer && answer !== correct) {
                    btn.classList.add('wrong');
                }
            });

            if (answer === correct) {
                practiceScore++;
                addXP(5);
            }

            document.getElementById('practiceScore').textContent = `Score: ${practiceScore}`;
            setTimeout(startPractice, 1500);
        }

        // Daily Challenge System
        const dailyChallenges = [
            { title: 'Speed Master', desc: 'Answer 5 physics questions correctly', goal: 5 },
            { title: 'Cell Explorer', desc: 'Answer 5 biology questions correctly', goal: 5 },
            { title: 'Element Hunter', desc: 'Answer 5 chemistry questions correctly', goal: 5 },
            { title: 'Science Sprint', desc: 'Complete 5 quick quizzes', goal: 5 },
            { title: 'Knowledge Seeker', desc: 'Answer any 5 questions correctly', goal: 5 }
        ];

        let challengeProgress = 0;
        let todayChallenge = null;

        function openDailyChallenge() {
            document.getElementById('dailyChallengeModal').classList.add('active');
            loadDailyChallenge();
        }

        function closeDailyChallenge() {
            document.getElementById('dailyChallengeModal').classList.remove('active');
        }

        function loadDailyChallenge() {
            const today = new Date().toDateString();
            const stored = JSON.parse(localStorage.getItem('dailyChallengeData') || '{}');

            if (stored.date !== today) {
                // New day, new challenge
                todayChallenge = dailyChallenges[Math.floor(Math.random() * dailyChallenges.length)];
                challengeProgress = 0;
                localStorage.setItem('dailyChallengeData', JSON.stringify({
                    date: today,
                    challenge: todayChallenge,
                    progress: 0,
                    completed: false
                }));
            } else {
                todayChallenge = stored.challenge;
                challengeProgress = stored.progress || 0;
            }

            document.getElementById('challengeDate').textContent = new Date().toLocaleDateString();
            document.getElementById('challengeTitle').textContent = todayChallenge.title;
            document.getElementById('challengeDesc').textContent = todayChallenge.desc;
            updateChallengeProgress();
        }

        function updateChallengeProgress() {
            const percent = Math.min((challengeProgress / todayChallenge.goal) * 100, 100);
            document.getElementById('challengeProgressFill').style.width = `${percent}%`;
            document.getElementById('challengeProgressText').textContent = `${challengeProgress} / ${todayChallenge.goal} completed`;

            if (challengeProgress >= todayChallenge.goal) {
                document.getElementById('challengeStartBtn').textContent = 'Challenge Complete!';
                document.getElementById('challengeStartBtn').disabled = true;
                document.getElementById('challengeReward').innerHTML = ' Reward Claimed: 50 XP';
            }
        }

        function startDailyChallenge() {
            challengeProgress++;
            addXP(10);

            const stored = JSON.parse(localStorage.getItem('dailyChallengeData') || '{}');
            stored.progress = challengeProgress;
            if (challengeProgress >= todayChallenge.goal) {
                stored.completed = true;
                addXP(40); // Bonus for completing
            }
            localStorage.setItem('dailyChallengeData', JSON.stringify(stored));

            updateChallengeProgress();
        }

        console.log(' Science Quote, Practice Mode, and Daily Challenge loaded!');
    </script>

    <!-- Batch 84: Vocab Builder Button -->
    <button class="vocab-btn" onclick="openVocab()" title="Vocab Builder"></button>

    <!-- Vocab Builder Modal -->
    <div class="vocab-modal" id="vocabModal">
        <div class="vocab-content">
            <div class="vocab-header">
                <h3 style="margin:0;"> Vocab Builder</h3>
                <button onclick="closeVocab()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="vocab-body">
                <div class="vocab-card">
                    <div class="vocab-word" id="vocabWord">Loading...</div>
                    <div class="vocab-definition" id="vocabDef">...</div>
                </div>
                <div class="vocab-buttons">
                    <button onclick="showVocabDef()" style="background:#5c6bc0;color:white;">Show Definition</button>
                    <button onclick="nextVocab()" style="background:#9fa8da;color:white;">Next Word</button>
                </div>
                <p style="text-align:center;margin-top:15px;color:#5c6bc0;font-weight:bold;" id="vocabProgress">1 / 20</p>
            </div>
        </div>
    </div>

    <!-- Experiment Log Button -->
    <button class="exp-log-btn" onclick="openExpLog()" title="Experiment Log"></button>

    <!-- Experiment Log Modal -->
    <div class="exp-log-modal" id="expLogModal">
        <div class="exp-log-content">
            <div class="exp-log-header">
                <h3 style="margin:0;"> Experiment Log</h3>
                <button onclick="closeExpLog()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="exp-log-body">
                <input type="text" class="exp-log-input" id="expLogTitle" placeholder="Experiment Title">
                <textarea class="exp-log-textarea" id="expLogNotes" placeholder="Observations and Results..."></textarea>
                <button onclick="saveExpLog()" style="width:100%;padding:12px;background:#388e3c;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin-bottom:15px;">Save Experiment</button>
                <h4 style="margin:0 0 10px 0;color:#388e3c;">Previous Experiments</h4>
                <div class="exp-log-list" id="expLogList"></div>
            </div>
        </div>
    </div>

    <!-- Brain Break Button -->
    <button class="brain-break-btn" onclick="openBrainBreak()" title="Brain Break"></button>

    <!-- Brain Break Modal -->
    <div class="brain-break-modal" id="brainBreakModal">
        <div class="brain-break-content">
            <div class="brain-break-header">
                <h3 style="margin:0;"> Brain Break</h3>
                <button onclick="closeBrainBreak()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"></button>
            </div>
            <div class="brain-break-body">
                <div class="brain-break-activity" id="brainBreakIcon"></div>
                <div class="brain-break-title" id="brainBreakTitle">Take a Break!</div>
                <div class="brain-break-desc" id="brainBreakDesc">Choose an activity</div>
                <div class="brain-break-timer" id="brainBreakTimer">1:00</div>
                <button onclick="startBrainBreak()" id="brainBreakStartBtn" style="padding:15px 30px;background:#e91e63;color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">Start Break</button>
            </div>
        </div>
    </div>

    <script>
        // Vocab Builder System
        const vocabWords = [
            { word: 'Hypothesis', def: 'A proposed explanation that can be tested' },
            { word: 'Variable', def: 'A factor that can change in an experiment' },
            { word: 'Control', def: 'A standard for comparison in an experiment' },
            { word: 'Organism', def: 'Any living thing' },
            { word: 'Photosynthesis', def: 'Process where plants make food using light' },
            { word: 'Ecosystem', def: 'A community of organisms and their environment' },
            { word: 'Catalyst', def: 'A substance that speeds up a reaction' },
            { word: 'Isotope', def: 'Atoms with same protons but different neutrons' },
            { word: 'Momentum', def: 'Mass times velocity of an object' },
            { word: 'Amplitude', def: 'Maximum displacement of a wave' },
            { word: 'Frequency', def: 'Number of waves passing a point per second' },
            { word: 'Nucleus', def: 'Control center of a cell containing DNA' },
            { word: 'Chromosome', def: 'Structure containing genetic information' },
            { word: 'Oxidation', def: 'Loss of electrons in a chemical reaction' },
            { word: 'Reduction', def: 'Gain of electrons in a chemical reaction' },
            { word: 'Inertia', def: 'Tendency of an object to resist change in motion' },
            { word: 'Diffusion', def: 'Movement of particles from high to low concentration' },
            { word: 'Solute', def: 'Substance dissolved in a solution' },
            { word: 'Enzyme', def: 'Biological catalyst that speeds up reactions' },
            { word: 'Polymer', def: 'Large molecule made of repeating units' }
        ];

        let vocabIndex = 0;

        function openVocab() {
            document.getElementById('vocabModal').classList.add('active');
            vocabIndex = 0;
            updateVocabCard();
        }

        function closeVocab() {
            document.getElementById('vocabModal').classList.remove('active');
        }

        function updateVocabCard() {
            const v = vocabWords[vocabIndex];
            document.getElementById('vocabWord').textContent = v.word;
            document.getElementById('vocabDef').textContent = v.def;
            document.getElementById('vocabDef').classList.remove('show');
            document.getElementById('vocabProgress').textContent = `${vocabIndex + 1} / ${vocabWords.length}`;
        }

        function showVocabDef() {
            document.getElementById('vocabDef').classList.add('show');
            addXP(2);
        }

        function nextVocab() {
            vocabIndex = (vocabIndex + 1) % vocabWords.length;
            updateVocabCard();
        }

        // Experiment Log System
        function openExpLog() {
            document.getElementById('expLogModal').classList.add('active');
            renderExpLogs();
        }

        function closeExpLog() {
            document.getElementById('expLogModal').classList.remove('active');
        }

        function getExpLogs() {
            return JSON.parse(localStorage.getItem('experimentLogs') || '[]');
        }

        function saveExpLog() {
            const title = document.getElementById('expLogTitle').value.trim();
            const notes = document.getElementById('expLogNotes').value.trim();

            if (!title) {
                alert('Please enter an experiment title');
                return;
            }

            const logs = getExpLogs();
            logs.unshift({
                title: title,
                notes: notes,
                date: new Date().toLocaleString()
            });

            if (logs.length > 20) logs.pop();
            localStorage.setItem('experimentLogs', JSON.stringify(logs));

            document.getElementById('expLogTitle').value = '';
            document.getElementById('expLogNotes').value = '';
            renderExpLogs();
            addXP(10);
        }

        function renderExpLogs() {
            const logs = getExpLogs();
            document.getElementById('expLogList').innerHTML = logs.length > 0 ?
                logs.map(log => `
                    <div class="exp-log-item">
                        <div class="exp-log-item-title">${log.title}</div>
                        <div class="exp-log-item-notes">${log.notes || 'No notes'}</div>
                        <div class="exp-log-item-date">${log.date}</div>
                    </div>
                `).join('') :
                '<p style="text-align:center;color:#999;">No experiments logged yet</p>';
        }

        // Brain Break System
        const brainBreakActivities = [
            { icon: '', title: 'Deep Breathing', desc: 'Take 5 slow, deep breaths', duration: 60 },
            { icon: '', title: 'Quick Walk', desc: 'Walk around for a minute', duration: 60 },
            { icon: '', title: 'Stretch', desc: 'Stretch your arms and legs', duration: 45 },
            { icon: '', title: 'Eye Rest', desc: 'Close your eyes and relax', duration: 30 },
            { icon: '', title: 'Shoulder Rolls', desc: 'Roll your shoulders 10 times', duration: 30 },
            { icon: '', title: 'Hum a Song', desc: 'Hum your favorite tune', duration: 45 }
        ];

        let currentBreakActivity = null;
        let breakInterval = null;
        let breakSeconds = 0;

        function openBrainBreak() {
            document.getElementById('brainBreakModal').classList.add('active');
            selectRandomActivity();
        }

        function closeBrainBreak() {
            document.getElementById('brainBreakModal').classList.remove('active');
            if (breakInterval) {
                clearInterval(breakInterval);
                breakInterval = null;
            }
        }

        function selectRandomActivity() {
            currentBreakActivity = brainBreakActivities[Math.floor(Math.random() * brainBreakActivities.length)];
            document.getElementById('brainBreakIcon').textContent = currentBreakActivity.icon;
            document.getElementById('brainBreakTitle').textContent = currentBreakActivity.title;
            document.getElementById('brainBreakDesc').textContent = currentBreakActivity.desc;
            breakSeconds = currentBreakActivity.duration;
            updateBreakTimer();
            document.getElementById('brainBreakStartBtn').textContent = 'Start Break';
            document.getElementById('brainBreakStartBtn').disabled = false;
        }

        function updateBreakTimer() {
            const mins = Math.floor(breakSeconds / 60);
            const secs = breakSeconds % 60;
            document.getElementById('brainBreakTimer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function startBrainBreak() {
            document.getElementById('brainBreakStartBtn').textContent = 'Taking a break...';
            document.getElementById('brainBreakStartBtn').disabled = true;

            breakInterval = setInterval(() => {
                breakSeconds--;
                updateBreakTimer();

                if (breakSeconds <= 0) {
                    clearInterval(breakInterval);
                    breakInterval = null;
                    document.getElementById('brainBreakTitle').textContent = 'Break Complete!';
                    document.getElementById('brainBreakStartBtn').textContent = 'New Activity';
                    document.getElementById('brainBreakStartBtn').disabled = false;
                    document.getElementById('brainBreakStartBtn').onclick = selectRandomActivity;
                    addXP(5);
                }
            }, 1000);
        }

        console.log(' Vocab Builder, Experiment Log, and Brain Break loaded!');

        // ========== BATCH 85: Word of the Day, Lab Report Builder, Quick Reference ==========

        // Word of the Day Button
        const wotdBtn = document.createElement('button');
        wotdBtn.className = 'wotd-btn';
        wotdBtn.innerHTML = '';
        wotdBtn.title = 'Word of the Day';
        wotdBtn.onclick = () => openWotdModal();
        document.body.appendChild(wotdBtn);

        // Word of the Day Modal
        const wotdModal = document.createElement('div');
        wotdModal.className = 'wotd-modal';
        wotdModal.id = 'wotdModal';
        wotdModal.innerHTML = `
            <div class="wotd-content">
                <h3 style="color: #00897b; margin-bottom: 20px;"> Word of the Day</h3>
                <div class="wotd-word" id="wotdWord">Loading...</div>
                <div class="wotd-pronunciation" id="wotdPronunciation"></div>
                <div class="wotd-definition" id="wotdDefinition"></div>
                <div class="wotd-example" id="wotdExample"></div>
                <button onclick="closeWotdModal()" style="margin-top: 20px; padding: 12px 30px; background: #00897b; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold;">Got It! +10 XP</button>
            </div>
        `;
        document.body.appendChild(wotdModal);

        const wordsOfTheDay = [
            { word: 'Photosynthesis', pron: '/fotosnss/', def: 'The process by which plants convert light energy into chemical energy, using carbon dioxide and water to produce glucose and oxygen.', ex: 'Example: Plants use photosynthesis to make their own food from sunlight.' },
            { word: 'Mitochondria', pron: '/matkndri/', def: 'Organelles found in cells that generate most of the cell\'s supply of ATP, used as a source of chemical energy.', ex: 'Example: The mitochondria are often called the "powerhouse of the cell."' },
            { word: 'Entropy', pron: '/ntrpi/', def: 'A measure of the disorder or randomness in a system. In thermodynamics, it always increases in an isolated system.', ex: 'Example: When ice melts, entropy increases as molecules become more disordered.' },
            { word: 'Catalyst', pron: '/ktlst/', def: 'A substance that increases the rate of a chemical reaction without being consumed in the process.', ex: 'Example: Enzymes are biological catalysts that speed up reactions in living organisms.' },
            { word: 'Osmosis', pron: '/zmoss/', def: 'The movement of water molecules through a semipermeable membrane from a region of low solute concentration to high.', ex: 'Example: Plant roots absorb water from soil through osmosis.' },
            { word: 'Momentum', pron: '/momntm/', def: 'The quantity of motion of a moving body, measured as mass times velocity. It is conserved in closed systems.', ex: 'Example: A moving truck has more momentum than a bicycle at the same speed.' },
            { word: 'Equilibrium', pron: '/ikwlbrim/', def: 'A state of balance where opposing forces or rates are equal, resulting in no net change.', ex: 'Example: Chemical equilibrium is reached when forward and reverse reactions occur at equal rates.' },
            { word: 'Chromosome', pron: '/kromsom/', def: 'A thread-like structure of DNA and proteins found in the nucleus that carries genetic information.', ex: 'Example: Humans have 23 pairs of chromosomes in each cell.' },
            { word: 'Inertia', pron: '/nr/', def: 'The resistance of an object to any change in its state of motion or rest. Objects maintain their state unless acted upon.', ex: 'Example: A ball at rest stays at rest due to inertia until you kick it.' },
            { word: 'Diffraction', pron: '/dfrkn/', def: 'The bending of waves around obstacles or through openings. It occurs with all types of waves.', ex: 'Example: Light diffracts when passing through a narrow slit, creating an interference pattern.' },
            { word: 'Covalent', pron: '/kovelnt/', def: 'A type of chemical bond where atoms share electrons to achieve a stable electron configuration.', ex: 'Example: Water molecules have covalent bonds between hydrogen and oxygen atoms.' },
            { word: 'Amplitude', pron: '/mpltud/', def: 'The maximum displacement of a wave from its equilibrium position. It determines wave energy and intensity.', ex: 'Example: A louder sound has a greater amplitude than a quieter one.' },
            { word: 'Nucleus', pron: '/nuklis/', def: 'The central part of an atom containing protons and neutrons, or the organelle in cells containing DNA.', ex: 'Example: The nucleus of an atom contains nearly all of its mass.' },
            { word: 'Biodiversity', pron: '/baodavrsti/', def: 'The variety of life forms in an ecosystem, including genetic, species, and ecosystem diversity.', ex: 'Example: Rainforests have high biodiversity with millions of species.' }
        ];

        function getTodaysWord() {
            const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            return wordsOfTheDay[dayOfYear % wordsOfTheDay.length];
        }

        function openWotdModal() {
            const word = getTodaysWord();
            document.getElementById('wotdWord').textContent = word.word;
            document.getElementById('wotdPronunciation').textContent = word.pron;
            document.getElementById('wotdDefinition').textContent = word.def;
            document.getElementById('wotdExample').textContent = word.ex;
            document.getElementById('wotdModal').style.display = 'flex';
        }

        function closeWotdModal() {
            document.getElementById('wotdModal').style.display = 'none';
            addXP(10);
        }

        // Lab Report Builder Button
        const labReportBtn = document.createElement('button');
        labReportBtn.className = 'lab-report-btn';
        labReportBtn.innerHTML = '';
        labReportBtn.title = 'Lab Report Builder';
        labReportBtn.onclick = () => openLabReportModal();
        document.body.appendChild(labReportBtn);

        // Lab Report Builder Modal
        const labReportModal = document.createElement('div');
        labReportModal.className = 'lab-report-modal';
        labReportModal.id = 'labReportModal';
        labReportModal.innerHTML = `
            <div class="lab-report-content">
                <h3 style="color: #5d4037; margin-bottom: 20px;"> Lab Report Builder</h3>
                <div class="lab-report-section">
                    <label> Title</label>
                    <input type="text" id="labReportTitle" placeholder="Enter experiment title...">
                </div>
                <div class="lab-report-section">
                    <label> Objective</label>
                    <textarea id="labReportObjective" rows="2" placeholder="What are you trying to find out?"></textarea>
                </div>
                <div class="lab-report-section">
                    <label> Hypothesis</label>
                    <textarea id="labReportHypothesis" rows="2" placeholder="What do you think will happen?"></textarea>
                </div>
                <div class="lab-report-section">
                    <label> Materials</label>
                    <textarea id="labReportMaterials" rows="3" placeholder="List all materials needed..."></textarea>
                </div>
                <div class="lab-report-section">
                    <label> Procedure</label>
                    <textarea id="labReportProcedure" rows="4" placeholder="List the steps of your experiment..."></textarea>
                </div>
                <div class="lab-report-section">
                    <label> Results</label>
                    <textarea id="labReportResults" rows="3" placeholder="What happened? Record your data..."></textarea>
                </div>
                <div class="lab-report-section">
                    <label> Conclusion</label>
                    <textarea id="labReportConclusion" rows="3" placeholder="What did you learn? Was your hypothesis correct?"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button onclick="saveLabReport()" style="padding: 12px 25px; background: #5d4037; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold;"> Save Report</button>
                    <button onclick="clearLabReport()" style="padding: 12px 25px; background: #9e9e9e; color: white; border: none; border-radius: 25px; cursor: pointer;">Clear</button>
                    <button onclick="closeLabReportModal()" style="padding: 12px 25px; background: #ef5350; color: white; border: none; border-radius: 25px; cursor: pointer;">Close</button>
                </div>
                <div id="savedLabReports" style="margin-top: 20px;"></div>
            </div>
        `;
        document.body.appendChild(labReportModal);

        function openLabReportModal() {
            document.getElementById('labReportModal').style.display = 'flex';
            displaySavedLabReports();
        }

        function closeLabReportModal() {
            document.getElementById('labReportModal').style.display = 'none';
        }

        function saveLabReport() {
            const report = {
                title: document.getElementById('labReportTitle').value || 'Untitled',
                objective: document.getElementById('labReportObjective').value,
                hypothesis: document.getElementById('labReportHypothesis').value,
                materials: document.getElementById('labReportMaterials').value,
                procedure: document.getElementById('labReportProcedure').value,
                results: document.getElementById('labReportResults').value,
                conclusion: document.getElementById('labReportConclusion').value,
                date: new Date().toLocaleString()
            };
            const reports = JSON.parse(localStorage.getItem('labReports') || '[]');
            reports.unshift(report);
            localStorage.setItem('labReports', JSON.stringify(reports.slice(0, 10)));
            addXP(25);
            alert('Lab report saved! +25 XP');
            displaySavedLabReports();
        }

        function clearLabReport() {
            document.getElementById('labReportTitle').value = '';
            document.getElementById('labReportObjective').value = '';
            document.getElementById('labReportHypothesis').value = '';
            document.getElementById('labReportMaterials').value = '';
            document.getElementById('labReportProcedure').value = '';
            document.getElementById('labReportResults').value = '';
            document.getElementById('labReportConclusion').value = '';
        }

        function displaySavedLabReports() {
            const reports = JSON.parse(localStorage.getItem('labReports') || '[]');
            const container = document.getElementById('savedLabReports');
            if (reports.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No saved reports yet</p>';
                return;
            }
            container.innerHTML = '<h4 style="color: #5d4037; margin-bottom: 10px;"> Saved Reports</h4>' +
                reports.slice(0, 3).map((r, i) => `
                    <div style="background: #efebe9; padding: 10px; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="loadLabReport(${i})">
                        <strong>${r.title}</strong><br>
                        <small style="color: #666;">${r.date}</small>
                    </div>
                `).join('');
        }

        function loadLabReport(index) {
            const reports = JSON.parse(localStorage.getItem('labReports') || '[]');
            if (reports[index]) {
                const r = reports[index];
                document.getElementById('labReportTitle').value = r.title;
                document.getElementById('labReportObjective').value = r.objective;
                document.getElementById('labReportHypothesis').value = r.hypothesis;
                document.getElementById('labReportMaterials').value = r.materials;
                document.getElementById('labReportProcedure').value = r.procedure;
                document.getElementById('labReportResults').value = r.results;
                document.getElementById('labReportConclusion').value = r.conclusion;
            }
        }

        // Quick Reference Button
        const quickRefBtn = document.createElement('button');
        quickRefBtn.className = 'quick-ref-btn';
        quickRefBtn.innerHTML = '';
        quickRefBtn.title = 'Quick Reference';
        quickRefBtn.onclick = () => openQuickRefModal();
        document.body.appendChild(quickRefBtn);

        // Quick Reference Modal
        const quickRefModal = document.createElement('div');
        quickRefModal.className = 'quick-ref-modal';
        quickRefModal.id = 'quickRefModal';
        quickRefModal.innerHTML = `
            <div class="quick-ref-content">
                <h3 style="color: #1565c0; margin-bottom: 15px;"> Quick Reference</h3>
                <div class="quick-ref-tabs">
                    <button class="quick-ref-tab active" onclick="showRefCategory('physics')">Physics</button>
                    <button class="quick-ref-tab" onclick="showRefCategory('chemistry')">Chemistry</button>
                    <button class="quick-ref-tab" onclick="showRefCategory('biology')">Biology</button>
                    <button class="quick-ref-tab" onclick="showRefCategory('constants')">Constants</button>
                </div>
                <div id="quickRefCards"></div>
                <button onclick="closeQuickRefModal()" style="margin-top: 15px; padding: 10px 25px; background: #1565c0; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(quickRefModal);

        const quickRefData = {
            physics: [
                { title: 'Speed Formula', content: 'Speed = Distance  Time (v = d/t)' },
                { title: 'Force Formula', content: 'Force = Mass  Acceleration (F = ma)' },
                { title: 'Work Formula', content: 'Work = Force  Distance (W = Fd)' },
                { title: 'Power Formula', content: 'Power = Work  Time (P = W/t)' },
                { title: 'Kinetic Energy', content: 'KE = mv (half mass times velocity squared)' },
                { title: 'Potential Energy', content: 'PE = mgh (mass  gravity  height)' },
                { title: 'Ohm\'s Law', content: 'V = IR (Voltage = Current  Resistance)' },
                { title: 'Wave Speed', content: 'v = f (velocity = frequency  wavelength)' }
            ],
            chemistry: [
                { title: 'Density', content: 'Density = Mass  Volume ( = m/V)' },
                { title: 'Moles', content: 'n = m/M (moles = mass  molar mass)' },
                { title: 'pH Scale', content: 'pH 0-6: Acid | pH 7: Neutral | pH 8-14: Base' },
                { title: 'Common Elements', content: 'H-1, C-6, N-7, O-8, Na-11, Cl-17, Fe-26' },
                { title: 'Balancing Equations', content: 'Same atoms on both sides; adjust coefficients' },
                { title: 'State Symbols', content: '(s) solid, (l) liquid, (g) gas, (aq) aqueous' }
            ],
            biology: [
                { title: 'Cell Parts', content: 'Nucleus, Mitochondria, Ribosome, Cell Membrane' },
                { title: 'Photosynthesis', content: '6CO + 6HO  CHO + 6O' },
                { title: 'Respiration', content: 'CHO + 6O  6CO + 6HO + Energy' },
                { title: 'DNA Bases', content: 'A-T (Adenine-Thymine), G-C (Guanine-Cytosine)' },
                { title: 'Food Chain', content: 'Producer  Primary  Secondary  Tertiary' },
                { title: 'Classification', content: 'Kingdom  Phylum  Class  Order  Family  Genus  Species' }
            ],
            constants: [
                { title: 'Speed of Light', content: 'c = 3  10 m/s' },
                { title: 'Gravity (Earth)', content: 'g = 9.8 m/s (10 m/s)' },
                { title: 'Avogadro\'s Number', content: '6.02  10 particles/mol' },
                { title: 'Planck\'s Constant', content: 'h = 6.63  10 Js' },
                { title: 'Gas Constant', content: 'R = 8.314 J/(molK)' },
                { title: 'Electron Charge', content: 'e = 1.6  10 C' }
            ]
        };

        let currentRefCategory = 'physics';

        function openQuickRefModal() {
            document.getElementById('quickRefModal').style.display = 'flex';
            showRefCategory('physics');
        }

        function closeQuickRefModal() {
            document.getElementById('quickRefModal').style.display = 'none';
        }

        function showRefCategory(category) {
            currentRefCategory = category;
            document.querySelectorAll('.quick-ref-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            const cards = quickRefData[category];
            document.getElementById('quickRefCards').innerHTML = cards.map(card => `
                <div class="quick-ref-card">
                    <h4>${card.title}</h4>
                    <p>${card.content}</p>
                </div>
            `).join('');
        }

        console.log(' Word of the Day, Lab Report Builder, and Quick Reference loaded!');

        // ========== BATCH 86: Science Meme, Formula Solver, Revision Checklist ==========

        // Science Meme Button
        const memeBtn = document.createElement('button');
        memeBtn.className = 'meme-btn';
        memeBtn.innerHTML = '';
        memeBtn.title = 'Science Meme';
        memeBtn.onclick = () => openMemeModal();
        document.body.appendChild(memeBtn);

        // Science Meme Modal
        const memeModal = document.createElement('div');
        memeModal.className = 'meme-modal';
        memeModal.id = 'memeModal';
        memeModal.innerHTML = `
            <div class="meme-content">
                <h3 style="color: #f57c00; margin-bottom: 15px;"> Science Meme Break</h3>
                <div class="meme-display">
                    <div class="meme-emoji" id="memeEmoji"></div>
                    <div class="meme-text" id="memeText">Loading...</div>
                </div>
                <div class="meme-fact" id="memeFact"></div>
                <button onclick="nextMeme()" style="margin-top: 15px; padding: 12px 25px; background: #f57c00; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold;">Next Meme </button>
                <button onclick="closeMemeModal()" style="margin-top: 10px; padding: 10px 20px; background: #9e9e9e; color: white; border: none; border-radius: 20px; cursor: pointer; display: block; margin-left: auto; margin-right: auto;">Close</button>
            </div>
        `;
        document.body.appendChild(memeModal);

        const scienceMemes = [
            { emoji: '', text: 'Never trust an atom... they make up everything!', fact: 'Fun fact: There are about 7 octillion atoms in a human body!' },
            { emoji: '', text: 'I told a DNA joke... but you probably won\'t get it, it\'s in your genes!', fact: 'Fun fact: Human DNA is 99.9% identical between all people!' },
            { emoji: '', text: 'I\'m reading a book about anti-gravity... I can\'t put it down!', fact: 'Fun fact: Gravity on Mars is about 38% of Earth\'s gravity!' },
            { emoji: '', text: 'Why did the electron break up with the proton? There was no chemistry!', fact: 'Fun fact: Electrons move at about 2,200 km/s in orbit around atoms!' },
            { emoji: '', text: 'Biology is the only science where multiplication and division mean the same thing!', fact: 'Fun fact: Cell division (mitosis) creates two identical daughter cells!' },
            { emoji: '', text: 'What do chemists call a benzene ring with iron atoms? A ferrous wheel!', fact: 'Fun fact: Benzene was discovered in 1825 by Michael Faraday!' },
            { emoji: '', text: 'Why can\'t you trust an ocean? Because it\'s full of salty water!', fact: 'Fun fact: Ocean water is about 3.5% salt by weight!' },
            { emoji: '', text: 'The Sun is jealous of photons... they always get all the attention!', fact: 'Fun fact: Light from the Sun takes 8 minutes to reach Earth!' },
            { emoji: '', text: 'I have a joke about magnets... but I\'m not sure if it will attract interest!', fact: 'Fun fact: The Earth\'s magnetic field extends 65,000 km into space!' },
            { emoji: '', text: 'Why did the geologist break up? They took each other for granite!', fact: 'Fun fact: Granite makes up about 70% of Earth\'s continental crust!' },
            { emoji: '', text: 'Why did the bacteria fail the math test? It kept dividing!', fact: 'Fun fact: Some bacteria can divide every 20 minutes!' },
            { emoji: '', text: 'Why do scientists like nitrogen? Because it\'s so unreactive, it keeps to itself!', fact: 'Fun fact: Nitrogen makes up 78% of Earth\'s atmosphere!' }
        ];

        let currentMemeIndex = 0;

        function openMemeModal() {
            document.getElementById('memeModal').style.display = 'flex';
            showMeme();
        }

        function closeMemeModal() {
            document.getElementById('memeModal').style.display = 'none';
        }

        function showMeme() {
            const meme = scienceMemes[currentMemeIndex];
            document.getElementById('memeEmoji').textContent = meme.emoji;
            document.getElementById('memeText').textContent = meme.text;
            document.getElementById('memeFact').textContent = meme.fact;
        }

        function nextMeme() {
            currentMemeIndex = (currentMemeIndex + 1) % scienceMemes.length;
            showMeme();
            addXP(2);
        }

        // Formula Solver Button
        const formulaSolverBtn = document.createElement('button');
        formulaSolverBtn.className = 'formula-solver-btn';
        formulaSolverBtn.innerHTML = '';
        formulaSolverBtn.title = 'Formula Solver';
        formulaSolverBtn.onclick = () => openFormulaSolverModal();
        document.body.appendChild(formulaSolverBtn);

        // Formula Solver Modal
        const formulaSolverModal = document.createElement('div');
        formulaSolverModal.className = 'formula-solver-modal';
        formulaSolverModal.id = 'formulaSolverModal';
        formulaSolverModal.innerHTML = `
            <div class="formula-solver-content">
                <h3 style="color: #7b1fa2; margin-bottom: 15px;"> Formula Solver</h3>
                <select class="formula-select" id="formulaSelect" onchange="setupFormulaInputs()">
                    <option value="">Select a formula...</option>
                    <option value="speed">Speed (v = d/t)</option>
                    <option value="force">Force (F = ma)</option>
                    <option value="work">Work (W = Fd)</option>
                    <option value="power">Power (P = W/t)</option>
                    <option value="ke">Kinetic Energy (KE = mv)</option>
                    <option value="pe">Potential Energy (PE = mgh)</option>
                    <option value="ohm">Ohm's Law (V = IR)</option>
                    <option value="density">Density ( = m/V)</option>
                </select>
                <div class="formula-inputs" id="formulaInputs"></div>
                <div class="formula-result" id="formulaResult">Select a formula to begin</div>
                <button onclick="closeFormulaSolverModal()" style="margin-top: 15px; padding: 10px 25px; background: #7b1fa2; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(formulaSolverModal);

        const formulaConfigs = {
            speed: { inputs: ['Distance (m)', 'Time (s)'], calc: (d, t) => `Speed = ${(d/t).toFixed(2)} m/s`, unit: 'm/s' },
            force: { inputs: ['Mass (kg)', 'Acceleration (m/s)'], calc: (m, a) => `Force = ${(m*a).toFixed(2)} N`, unit: 'N' },
            work: { inputs: ['Force (N)', 'Distance (m)'], calc: (f, d) => `Work = ${(f*d).toFixed(2)} J`, unit: 'J' },
            power: { inputs: ['Work (J)', 'Time (s)'], calc: (w, t) => `Power = ${(w/t).toFixed(2)} W`, unit: 'W' },
            ke: { inputs: ['Mass (kg)', 'Velocity (m/s)'], calc: (m, v) => `KE = ${(0.5*m*v*v).toFixed(2)} J`, unit: 'J' },
            pe: { inputs: ['Mass (kg)', 'Height (m)'], calc: (m, h) => `PE = ${(m*9.8*h).toFixed(2)} J`, unit: 'J' },
            ohm: { inputs: ['Current (A)', 'Resistance ()'], calc: (i, r) => `Voltage = ${(i*r).toFixed(2)} V`, unit: 'V' },
            density: { inputs: ['Mass (kg)', 'Volume (m)'], calc: (m, v) => `Density = ${(m/v).toFixed(2)} kg/m`, unit: 'kg/m' }
        };

        function openFormulaSolverModal() {
            document.getElementById('formulaSolverModal').style.display = 'flex';
        }

        function closeFormulaSolverModal() {
            document.getElementById('formulaSolverModal').style.display = 'none';
        }

        function setupFormulaInputs() {
            const formula = document.getElementById('formulaSelect').value;
            const container = document.getElementById('formulaInputs');

            if (!formula) {
                container.innerHTML = '';
                document.getElementById('formulaResult').textContent = 'Select a formula to begin';
                return;
            }

            const config = formulaConfigs[formula];
            container.innerHTML = config.inputs.map((label, i) => `
                <div class="formula-input-row">
                    <label>${label}</label>
                    <input type="number" id="formulaInput${i}" oninput="calculateFormula()" placeholder="Enter value">
                </div>
            `).join('');
            document.getElementById('formulaResult').textContent = 'Enter values to calculate';
        }

        function calculateFormula() {
            const formula = document.getElementById('formulaSelect').value;
            if (!formula) return;

            const config = formulaConfigs[formula];
            const values = config.inputs.map((_, i) => parseFloat(document.getElementById(`formulaInput${i}`).value));

            if (values.some(v => isNaN(v))) {
                document.getElementById('formulaResult').textContent = 'Enter all values';
                return;
            }

            const result = config.calc(...values);
            document.getElementById('formulaResult').textContent = result;
            addXP(5);
        }

        // Revision Checklist Button
        const revisionBtn = document.createElement('button');
        revisionBtn.className = 'revision-btn';
        revisionBtn.innerHTML = '';
        revisionBtn.title = 'Revision Checklist';
        revisionBtn.onclick = () => openRevisionModal();
        document.body.appendChild(revisionBtn);

        // Revision Checklist Modal
        const revisionModal = document.createElement('div');
        revisionModal.className = 'revision-modal';
        revisionModal.id = 'revisionModal';
        revisionModal.innerHTML = `
            <div class="revision-content">
                <h3 style="color: #00695c; margin-bottom: 15px;"> Revision Checklist</h3>
                <div id="revisionTopics"></div>
                <div class="revision-progress">
                    <div class="revision-progress-fill" id="revisionProgressFill" style="width: 0%"></div>
                </div>
                <p id="revisionProgressText" style="text-align: center; margin-top: 10px; color: #00695c; font-weight: bold;">0% Complete</p>
                <button onclick="closeRevisionModal()" style="margin-top: 15px; padding: 10px 25px; background: #00695c; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(revisionModal);

        const revisionTopics = {
            'Physics - Forces': ['Newton\'s First Law', 'Newton\'s Second Law', 'Newton\'s Third Law', 'Friction', 'Gravity'],
            'Physics - Energy': ['Kinetic Energy', 'Potential Energy', 'Conservation of Energy', 'Work Done', 'Power'],
            'Chemistry - Atoms': ['Atomic Structure', 'Electron Configuration', 'Periodic Table', 'Isotopes', 'Ions'],
            'Chemistry - Reactions': ['Balancing Equations', 'Reaction Types', 'Rates of Reaction', 'Catalysts', 'Reversible Reactions'],
            'Biology - Cells': ['Cell Structure', 'Cell Membrane', 'Mitosis', 'Meiosis', 'Stem Cells'],
            'Biology - Systems': ['Digestive System', 'Circulatory System', 'Respiratory System', 'Nervous System', 'Immune System']
        };

        function getRevisionState() {
            return JSON.parse(localStorage.getItem('revisionChecklist') || '{}');
        }

        function saveRevisionState(state) {
            localStorage.setItem('revisionChecklist', JSON.stringify(state));
        }

        function openRevisionModal() {
            document.getElementById('revisionModal').style.display = 'flex';
            renderRevisionTopics();
        }

        function closeRevisionModal() {
            document.getElementById('revisionModal').style.display = 'none';
        }

        function renderRevisionTopics() {
            const state = getRevisionState();
            const container = document.getElementById('revisionTopics');

            container.innerHTML = Object.entries(revisionTopics).map(([topic, items]) => `
                <div class="revision-topic">
                    <strong>${topic}</strong>
                    <div style="margin-top: 10px;">
                        ${items.map(item => {
                            const key = `${topic}-${item}`;
                            const checked = state[key] ? 'checked' : '';
                            return `
                                <div class="revision-item">
                                    <input type="checkbox" id="rev-${key}" ${checked} onchange="toggleRevisionItem('${key}')">
                                    <label for="rev-${key}">${item}</label>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');

            updateRevisionProgress();
        }

        function toggleRevisionItem(key) {
            const state = getRevisionState();
            state[key] = !state[key];
            saveRevisionState(state);
            if (state[key]) addXP(5);
            updateRevisionProgress();
        }

        function updateRevisionProgress() {
            const state = getRevisionState();
            const totalItems = Object.values(revisionTopics).flat().length;
            const checkedItems = Object.values(state).filter(v => v).length;
            const percentage = Math.round((checkedItems / totalItems) * 100);

            document.getElementById('revisionProgressFill').style.width = `${percentage}%`;
            document.getElementById('revisionProgressText').textContent = `${percentage}% Complete (${checkedItems}/${totalItems})`;
        }

        console.log(' Science Meme, Formula Solver, and Revision Checklist loaded!');

        // ========== BATCH 87: Trivia Wheel, Focus Timer, Flashcard Deck ==========

        // Trivia Wheel Button
        const triviaWheelBtn = document.createElement('button');
        triviaWheelBtn.className = 'trivia-wheel-btn';
        triviaWheelBtn.innerHTML = '';
        triviaWheelBtn.title = 'Trivia Wheel';
        triviaWheelBtn.onclick = () => openTriviaWheelModal();
        document.body.appendChild(triviaWheelBtn);

        // Trivia Wheel Modal
        const triviaWheelModal = document.createElement('div');
        triviaWheelModal.className = 'trivia-wheel-modal';
        triviaWheelModal.id = 'triviaWheelModal';
        triviaWheelModal.innerHTML = `
            <div class="trivia-wheel-content">
                <h3 style="color: #c2185b; margin-bottom: 15px;"> Spin for Trivia!</h3>
                <div class="wheel-container">
                    <div class="wheel-pointer"></div>
                    <div class="wheel" id="triviaWheel" onclick="spinTriviaWheel()">
                        <span style="color: white; font-weight: bold;">SPIN!</span>
                    </div>
                </div>
                <div class="trivia-question-box" id="triviaQuestionBox" style="display: none;">
                    <p id="triviaQuestion" style="font-weight: bold; color: #880e4f; margin-bottom: 15px;"></p>
                    <div class="trivia-options" id="triviaOptions"></div>
                </div>
                <p id="triviaResult" style="font-weight: bold; margin-top: 15px;"></p>
                <button onclick="closeTriviaWheelModal()" style="margin-top: 10px; padding: 10px 25px; background: #c2185b; color: white; border: none; border-radius: 20px; cursor: pointer;">Close</button>
            </div>
        `;
        document.body.appendChild(triviaWheelModal);

        const triviaQuestions = [
            { q: 'What is the chemical symbol for gold?', opts: ['Au', 'Ag', 'Fe', 'Cu'], correct: 0 },
            { q: 'Which planet is known as the Red Planet?', opts: ['Venus', 'Mars', 'Jupiter', 'Saturn'], correct: 1 },
            { q: 'What is the powerhouse of the cell?', opts: ['Nucleus', 'Ribosome', 'Mitochondria', 'Golgi'], correct: 2 },
            { q: 'What is the speed of light?', opts: ['310 m/s', '310 m/s', '310 m/s', '310 m/s'], correct: 1 },
            { q: 'How many bones are in the adult human body?', opts: ['186', '206', '226', '246'], correct: 1 },
            { q: 'What gas do plants absorb from the air?', opts: ['Oxygen', 'Nitrogen', 'Carbon Dioxide', 'Hydrogen'], correct: 2 },
            { q: 'What is HO commonly known as?', opts: ['Salt', 'Sugar', 'Water', 'Acid'], correct: 2 },
            { q: 'Which force keeps planets in orbit?', opts: ['Friction', 'Gravity', 'Magnetism', 'Tension'], correct: 1 },
            { q: 'What is the hardest natural substance?', opts: ['Gold', 'Iron', 'Diamond', 'Quartz'], correct: 2 },
            { q: 'How many chromosomes do humans have?', opts: ['23', '46', '48', '44'], correct: 1 },
            { q: 'What type of energy is stored in food?', opts: ['Kinetic', 'Chemical', 'Nuclear', 'Thermal'], correct: 1 },
            { q: 'Which element has atomic number 1?', opts: ['Helium', 'Hydrogen', 'Carbon', 'Oxygen'], correct: 1 }
        ];

        let wheelRotation = 0;
        let currentTriviaQ = null;

        function openTriviaWheelModal() {
            document.getElementById('triviaWheelModal').style.display = 'flex';
            document.getElementById('triviaQuestionBox').style.display = 'none';
            document.getElementById('triviaResult').textContent = 'Click the wheel to spin!';
        }

        function closeTriviaWheelModal() {
            document.getElementById('triviaWheelModal').style.display = 'none';
        }

        function spinTriviaWheel() {
            if (currentTriviaQ !== null) return;

            wheelRotation += 1440 + Math.random() * 720;
            document.getElementById('triviaWheel').style.transform = `rotate(${wheelRotation}deg)`;

            setTimeout(() => {
                currentTriviaQ = triviaQuestions[Math.floor(Math.random() * triviaQuestions.length)];
                document.getElementById('triviaQuestion').textContent = currentTriviaQ.q;
                document.getElementById('triviaOptions').innerHTML = currentTriviaQ.opts.map((opt, i) =>
                    `<div class="trivia-option" onclick="answerTrivia(${i})">${opt}</div>`
                ).join('');
                document.getElementById('triviaQuestionBox').style.display = 'block';
                document.getElementById('triviaResult').textContent = '';
            }, 3000);
        }

        function answerTrivia(index) {
            if (!currentTriviaQ) return;

            const options = document.querySelectorAll('.trivia-option');
            options.forEach((opt, i) => {
                if (i === currentTriviaQ.correct) {
                    opt.classList.add('correct');
                } else if (i === index) {
                    opt.classList.add('wrong');
                }
            });

            if (index === currentTriviaQ.correct) {
                document.getElementById('triviaResult').textContent = ' Correct! +15 XP';
                document.getElementById('triviaResult').style.color = '#4caf50';
                addXP(15);
            } else {
                document.getElementById('triviaResult').textContent = ' Wrong! The answer was: ' + currentTriviaQ.opts[currentTriviaQ.correct];
                document.getElementById('triviaResult').style.color = '#f44336';
            }

            setTimeout(() => {
                currentTriviaQ = null;
                document.getElementById('triviaQuestionBox').style.display = 'none';
                document.getElementById('triviaResult').textContent = 'Spin again!';
                document.getElementById('triviaResult').style.color = '#c2185b';
            }, 2000);
        }

        // Focus Timer Button
        const focusTimerBtn = document.createElement('button');
        focusTimerBtn.className = 'focus-timer-btn';
        focusTimerBtn.innerHTML = '';
        focusTimerBtn.title = 'Focus Timer';
        focusTimerBtn.onclick = () => openFocusTimerModal();
        document.body.appendChild(focusTimerBtn);

        // Focus Timer Modal
        const focusTimerModal = document.createElement('div');
        focusTimerModal.className = 'focus-timer-modal';
        focusTimerModal.id = 'focusTimerModal';
        focusTimerModal.innerHTML = `
            <div class="focus-timer-content">
                <h3 style="color: #0288d1; margin-bottom: 10px;"> Focus Timer</h3>
                <p style="color: #666; margin-bottom: 15px;">Stay focused and earn XP!</p>
                <div class="timer-presets">
                    <button class="timer-preset active" onclick="setFocusTimer(15)">15m</button>
                    <button class="timer-preset" onclick="setFocusTimer(25)">25m</button>
                    <button class="timer-preset" onclick="setFocusTimer(45)">45m</button>
                </div>
                <div class="timer-display" id="focusTimerDisplay">15:00</div>
                <div class="timer-controls">
                    <button id="focusStartBtn" onclick="toggleFocusTimer()" style="background: #4caf50; color: white;"> Start</button>
                    <button onclick="resetFocusTimer()" style="background: #f44336; color: white;"> Reset</button>
                </div>
                <p id="focusTimerXP" style="margin-top: 15px; color: #0288d1; font-weight: bold;">Complete to earn XP!</p>
                <button onclick="closeFocusTimerModal()" style="margin-top: 15px; padding: 10px 25px; background: #0288d1; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(focusTimerModal);

        let focusTimeLeft = 15 * 60;
        let focusTimerInterval = null;
        let focusTimerRunning = false;
        let selectedFocusMinutes = 15;

        function openFocusTimerModal() {
            document.getElementById('focusTimerModal').style.display = 'flex';
        }

        function closeFocusTimerModal() {
            document.getElementById('focusTimerModal').style.display = 'none';
        }

        function setFocusTimer(minutes) {
            if (focusTimerRunning) return;
            selectedFocusMinutes = minutes;
            focusTimeLeft = minutes * 60;
            updateFocusDisplay();
            document.querySelectorAll('.timer-preset').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function updateFocusDisplay() {
            const mins = Math.floor(focusTimeLeft / 60);
            const secs = focusTimeLeft % 60;
            document.getElementById('focusTimerDisplay').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function toggleFocusTimer() {
            if (focusTimerRunning) {
                clearInterval(focusTimerInterval);
                focusTimerRunning = false;
                document.getElementById('focusStartBtn').textContent = ' Start';
                document.getElementById('focusStartBtn').style.background = '#4caf50';
            } else {
                focusTimerRunning = true;
                document.getElementById('focusStartBtn').textContent = ' Pause';
                document.getElementById('focusStartBtn').style.background = '#ff9800';
                focusTimerInterval = setInterval(() => {
                    focusTimeLeft--;
                    updateFocusDisplay();
                    if (focusTimeLeft <= 0) {
                        clearInterval(focusTimerInterval);
                        focusTimerRunning = false;
                        const earnedXP = selectedFocusMinutes * 2;
                        addXP(earnedXP);
                        document.getElementById('focusTimerDisplay').textContent = ' Done!';
                        document.getElementById('focusTimerXP').textContent = ` Session complete! +${earnedXP} XP earned!`;
                        document.getElementById('focusStartBtn').textContent = ' Start';
                        document.getElementById('focusStartBtn').style.background = '#4caf50';
                    }
                }, 1000);
            }
        }

        function resetFocusTimer() {
            clearInterval(focusTimerInterval);
            focusTimerRunning = false;
            focusTimeLeft = selectedFocusMinutes * 60;
            updateFocusDisplay();
            document.getElementById('focusStartBtn').textContent = ' Start';
            document.getElementById('focusStartBtn').style.background = '#4caf50';
            document.getElementById('focusTimerXP').textContent = 'Complete to earn XP!';
        }

        // Flashcard Deck Button
        const flashcardBtn = document.createElement('button');
        flashcardBtn.className = 'flashcard-btn';
        flashcardBtn.innerHTML = '';
        flashcardBtn.title = 'Flashcard Deck';
        flashcardBtn.onclick = () => openFlashcardModal();
        document.body.appendChild(flashcardBtn);

        // Flashcard Deck Modal
        const flashcardModal = document.createElement('div');
        flashcardModal.className = 'flashcard-modal';
        flashcardModal.id = 'flashcardModal';
        flashcardModal.innerHTML = `
            <div class="flashcard-content">
                <h3 style="color: #6a1b9a; margin-bottom: 15px;"> My Flashcards</h3>
                <div class="flashcard-display" id="flashcardDisplay" onclick="flipFlashcard()">
                    <span id="flashcardText">Click to start!</span>
                </div>
                <div class="flashcard-nav">
                    <button onclick="prevFlashcard()"> Prev</button>
                    <span id="flashcardCounter">0/0</span>
                    <button onclick="nextFlashcard()">Next </button>
                </div>
                <div class="flashcard-add">
                    <h4 style="color: #6a1b9a; margin-bottom: 10px;">Add New Card</h4>
                    <input type="text" id="flashcardFront" placeholder="Front (Question/Term)">
                    <textarea id="flashcardBack" rows="2" placeholder="Back (Answer/Definition)"></textarea>
                    <button onclick="addFlashcard()" style="width: 100%; padding: 12px; background: #6a1b9a; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Add Card +5 XP</button>
                </div>
                <button onclick="closeFlashcardModal()" style="margin-top: 15px; padding: 10px 25px; background: #6a1b9a; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(flashcardModal);

        let flashcards = JSON.parse(localStorage.getItem('userFlashcards') || '[]');
        let currentFlashcardIndex = 0;
        let showingFront = true;

        // Add default flashcards if none exist
        if (flashcards.length === 0) {
            flashcards = [
                { front: 'What is photosynthesis?', back: 'Process where plants convert light energy into chemical energy' },
                { front: 'What is F=ma?', back: 'Newton\'s Second Law: Force equals mass times acceleration' },
                { front: 'What is DNA?', back: 'Deoxyribonucleic acid - carries genetic information' },
                { front: 'What is an atom?', back: 'The smallest unit of matter that retains element properties' },
                { front: 'What is pH?', back: 'A measure of how acidic or basic a solution is (0-14 scale)' }
            ];
            localStorage.setItem('userFlashcards', JSON.stringify(flashcards));
        }

        function openFlashcardModal() {
            document.getElementById('flashcardModal').style.display = 'flex';
            showingFront = true;
            displayFlashcard();
        }

        function closeFlashcardModal() {
            document.getElementById('flashcardModal').style.display = 'none';
        }

        function displayFlashcard() {
            if (flashcards.length === 0) {
                document.getElementById('flashcardText').textContent = 'No cards yet! Add some below.';
                document.getElementById('flashcardCounter').textContent = '0/0';
                return;
            }
            const card = flashcards[currentFlashcardIndex];
            document.getElementById('flashcardText').textContent = showingFront ? card.front : card.back;
            document.getElementById('flashcardDisplay').style.background = showingFront
                ? 'linear-gradient(135deg, #f3e5f5, #e1bee7)'
                : 'linear-gradient(135deg, #e8f5e9, #c8e6c9)';
            document.getElementById('flashcardCounter').textContent = `${currentFlashcardIndex + 1}/${flashcards.length}`;
        }

        function flipFlashcard() {
            showingFront = !showingFront;
            displayFlashcard();
            if (!showingFront) addXP(2);
        }

        function prevFlashcard() {
            if (flashcards.length === 0) return;
            currentFlashcardIndex = (currentFlashcardIndex - 1 + flashcards.length) % flashcards.length;
            showingFront = true;
            displayFlashcard();
        }

        function nextFlashcard() {
            if (flashcards.length === 0) return;
            currentFlashcardIndex = (currentFlashcardIndex + 1) % flashcards.length;
            showingFront = true;
            displayFlashcard();
        }

        function addFlashcard() {
            const front = document.getElementById('flashcardFront').value.trim();
            const back = document.getElementById('flashcardBack').value.trim();
            if (!front || !back) {
                alert('Please fill in both front and back of the card!');
                return;
            }
            flashcards.push({ front, back });
            localStorage.setItem('userFlashcards', JSON.stringify(flashcards));
            document.getElementById('flashcardFront').value = '';
            document.getElementById('flashcardBack').value = '';
            addXP(5);
            displayFlashcard();
            alert('Flashcard added! +5 XP');
        }

        console.log(' Trivia Wheel, Focus Timer, and Flashcard Deck loaded!');

        // ========== BATCH 88: Study Goals, Science News, Achievement Badges ==========

        // Study Goals Button
        const studyGoalsBtn = document.createElement('button');
        studyGoalsBtn.className = 'study-goals-btn';
        studyGoalsBtn.innerHTML = '';
        studyGoalsBtn.title = 'Study Goals';
        studyGoalsBtn.onclick = () => openStudyGoalsModal();
        document.body.appendChild(studyGoalsBtn);

        // Study Goals Modal
        const studyGoalsModal = document.createElement('div');
        studyGoalsModal.className = 'study-goals-modal';
        studyGoalsModal.id = 'studyGoalsModal';
        studyGoalsModal.innerHTML = `
            <div class="study-goals-content">
                <h3 style="color: #388e3c; margin-bottom: 15px;"> My Study Goals</h3>
                <p style="color: #666; margin-bottom: 15px;">Set goals and earn XP when you complete them!</p>
                <div id="goalsContainer"></div>
                <div class="add-goal-section">
                    <input type="text" id="newGoalInput" placeholder="Add a new goal...">
                    <button onclick="addStudyGoal()" style="padding: 10px 20px; background: #388e3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Add</button>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: #e8f5e9; border-radius: 10px; text-align: center;">
                    <span id="goalsProgress" style="font-weight: bold; color: #388e3c;">0/0 goals completed today</span>
                </div>
                <button onclick="closeStudyGoalsModal()" style="margin-top: 15px; padding: 10px 25px; background: #388e3c; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(studyGoalsModal);

        function getStudyGoals() {
            const today = new Date().toDateString();
            const saved = JSON.parse(localStorage.getItem('studyGoals') || '{}');
            if (saved.date !== today) {
                return { date: today, goals: [] };
            }
            return saved;
        }

        function saveStudyGoals(data) {
            localStorage.setItem('studyGoals', JSON.stringify(data));
        }

        function openStudyGoalsModal() {
            document.getElementById('studyGoalsModal').style.display = 'flex';
            renderStudyGoals();
        }

        function closeStudyGoalsModal() {
            document.getElementById('studyGoalsModal').style.display = 'none';
        }

        function renderStudyGoals() {
            const data = getStudyGoals();
            const container = document.getElementById('goalsContainer');

            if (data.goals.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No goals yet! Add one below.</p>';
            } else {
                container.innerHTML = data.goals.map((goal, i) => `
                    <div class="goal-item">
                        <input type="checkbox" class="goal-checkbox" ${goal.completed ? 'checked' : ''} onchange="toggleStudyGoal(${i})">
                        <span class="goal-text ${goal.completed ? 'completed' : ''}">${goal.text}</span>
                        <button onclick="deleteStudyGoal(${i})" style="background: none; border: none; color: #f44336; cursor: pointer; font-size: 1.2rem;"></button>
                    </div>
                `).join('');
            }

            const completed = data.goals.filter(g => g.completed).length;
            document.getElementById('goalsProgress').textContent = `${completed}/${data.goals.length} goals completed today`;
        }

        function addStudyGoal() {
            const input = document.getElementById('newGoalInput');
            const text = input.value.trim();
            if (!text) return;

            const data = getStudyGoals();
            data.goals.push({ text, completed: false });
            saveStudyGoals(data);
            input.value = '';
            renderStudyGoals();
        }

        function toggleStudyGoal(index) {
            const data = getStudyGoals();
            data.goals[index].completed = !data.goals[index].completed;
            saveStudyGoals(data);
            if (data.goals[index].completed) {
                addXP(20);
            }
            renderStudyGoals();
            checkBadges();
        }

        function deleteStudyGoal(index) {
            const data = getStudyGoals();
            data.goals.splice(index, 1);
            saveStudyGoals(data);
            renderStudyGoals();
        }

        // Science News Button
        const scienceNewsBtn = document.createElement('button');
        scienceNewsBtn.className = 'science-news-btn';
        scienceNewsBtn.innerHTML = '';
        scienceNewsBtn.title = 'Science Facts';
        scienceNewsBtn.onclick = () => openScienceNewsModal();
        document.body.appendChild(scienceNewsBtn);

        // Science News Modal
        const scienceNewsModal = document.createElement('div');
        scienceNewsModal.className = 'science-news-modal';
        scienceNewsModal.id = 'scienceNewsModal';
        scienceNewsModal.innerHTML = `
            <div class="science-news-content">
                <h3 style="color: #d32f2f; margin-bottom: 15px;"> Science Facts & Discoveries</h3>
                <div id="newsContainer"></div>
                <button onclick="closeScienceNewsModal()" style="margin-top: 15px; padding: 10px 25px; background: #d32f2f; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(scienceNewsModal);

        const scienceFacts = [
            { cat: 'Space', title: 'Neutron Stars Are Incredibly Dense', snippet: 'A teaspoon of neutron star material would weigh about 6 billion tons on Earth. These stellar remnants pack massive amounts of matter into tiny spaces.' },
            { cat: 'Biology', title: 'Your DNA Could Stretch to Pluto', snippet: 'If you uncoiled all the DNA in your body and placed the strands end to end, they would stretch from Earth to Pluto and back!' },
            { cat: 'Chemistry', title: 'Water Can Boil and Freeze at the Same Time', snippet: 'At the right pressure and temperature (the triple point), water can exist as solid, liquid, and gas simultaneously!' },
            { cat: 'Physics', title: 'Light Takes 8 Minutes from the Sun', snippet: 'When you look at the Sun, you are seeing it as it was 8 minutes ago. Light travels at 300,000 km/s but the Sun is 150 million km away.' },
            { cat: 'Earth', title: 'Earth\'s Core Is as Hot as the Sun\'s Surface', snippet: 'The temperature at Earth\'s inner core reaches about 5,400C - comparable to the temperature at the surface of the Sun!' },
            { cat: 'Biology', title: 'Octopuses Have Three Hearts', snippet: 'Two hearts pump blood to the gills, while the third pumps it to the rest of the body. The main heart actually stops beating when they swim!' },
            { cat: 'Space', title: 'A Day on Venus Is Longer Than Its Year', snippet: 'Venus takes 243 Earth days to rotate once, but only 225 Earth days to orbit the Sun. It also rotates backwards!' },
            { cat: 'Chemistry', title: 'Honey Never Spoils', snippet: '3,000-year-old honey found in Egyptian tombs was still edible! Honey\'s low moisture and acidic pH create an inhospitable environment for bacteria.' },
            { cat: 'Physics', title: 'Sound Cannot Travel in Space', snippet: 'Space is a vacuum with no medium for sound waves to travel through. Astronauts communicate using radio waves instead.' },
            { cat: 'Biology', title: 'Humans Share 60% of DNA with Bananas', snippet: 'Despite our obvious differences, humans share a surprising amount of genetic material with the humble banana!' }
        ];

        function openScienceNewsModal() {
            document.getElementById('scienceNewsModal').style.display = 'flex';
            renderScienceNews();
        }

        function closeScienceNewsModal() {
            document.getElementById('scienceNewsModal').style.display = 'none';
        }

        function renderScienceNews() {
            // Show 4 random facts
            const shuffled = [...scienceFacts].sort(() => Math.random() - 0.5).slice(0, 4);
            document.getElementById('newsContainer').innerHTML = shuffled.map(fact => `
                <div class="news-item">
                    <span class="news-category">${fact.cat}</span>
                    <div class="news-title">${fact.title}</div>
                    <div class="news-snippet">${fact.snippet}</div>
                </div>
            `).join('');
        }

        // Achievement Badges Button
        const badgesBtn = document.createElement('button');
        badgesBtn.className = 'badges-btn';
        badgesBtn.innerHTML = '';
        badgesBtn.title = 'Achievement Badges';
        badgesBtn.onclick = () => openBadgesModal();
        document.body.appendChild(badgesBtn);

        // Achievement Badges Modal
        const badgesModal = document.createElement('div');
        badgesModal.className = 'badges-modal';
        badgesModal.id = 'badgesModal';
        badgesModal.innerHTML = `
            <div class="badges-content">
                <h3 style="color: #f57c00; margin-bottom: 15px;"> Achievement Badges</h3>
                <div class="badges-grid" id="badgesGrid"></div>
                <p id="badgesCount" style="text-align: center; margin-top: 15px; color: #666;"></p>
                <button onclick="closeBadgesModal()" style="margin-top: 15px; padding: 10px 25px; background: #f57c00; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(badgesModal);

        const allBadges = [
            { id: 'first_xp', icon: '', name: 'First Steps', desc: 'Earn your first XP', check: () => getXP() > 0 },
            { id: 'xp_100', icon: '', name: 'Century', desc: 'Earn 100 XP', check: () => getXP() >= 100 },
            { id: 'xp_500', icon: '', name: 'Rising Star', desc: 'Earn 500 XP', check: () => getXP() >= 500 },
            { id: 'xp_1000', icon: '', name: 'On Fire', desc: 'Earn 1000 XP', check: () => getXP() >= 1000 },
            { id: 'goal_1', icon: '', name: 'Goal Getter', desc: 'Complete a study goal', check: () => { const g = getStudyGoals(); return g.goals.some(x => x.completed); } },
            { id: 'flashcard_5', icon: '', name: 'Card Collector', desc: 'Create 5 flashcards', check: () => flashcards.length >= 5 },
            { id: 'early_bird', icon: '', name: 'Early Bird', desc: 'Study before 9 AM', check: () => new Date().getHours() < 9 },
            { id: 'night_owl', icon: '', name: 'Night Owl', desc: 'Study after 9 PM', check: () => new Date().getHours() >= 21 },
            { id: 'explorer', icon: '', name: 'Explorer', desc: 'Use 5 different tools', check: () => true }
        ];

        function getXP() {
            return parseInt(localStorage.getItem('scienceToolXP') || '0');
        }

        function getUnlockedBadges() {
            return JSON.parse(localStorage.getItem('unlockedBadges') || '[]');
        }

        function saveUnlockedBadges(badges) {
            localStorage.setItem('unlockedBadges', JSON.stringify(badges));
        }

        function checkBadges() {
            const unlocked = getUnlockedBadges();
            let newBadges = [];

            allBadges.forEach(badge => {
                if (!unlocked.includes(badge.id) && badge.check()) {
                    unlocked.push(badge.id);
                    newBadges.push(badge);
                }
            });

            if (newBadges.length > 0) {
                saveUnlockedBadges(unlocked);
                newBadges.forEach(badge => {
                    addXP(25);
                });
            }
        }

        function openBadgesModal() {
            document.getElementById('badgesModal').style.display = 'flex';
            renderBadges();
            checkBadges();
        }

        function closeBadgesModal() {
            document.getElementById('badgesModal').style.display = 'none';
        }

        function renderBadges() {
            const unlocked = getUnlockedBadges();
            document.getElementById('badgesGrid').innerHTML = allBadges.map(badge => {
                const isUnlocked = unlocked.includes(badge.id);
                return `
                    <div class="badge-item ${isUnlocked ? 'unlocked' : 'locked'}">
                        <div class="badge-icon">${badge.icon}</div>
                        <div class="badge-name">${badge.name}</div>
                        <div class="badge-desc">${badge.desc}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('badgesCount').textContent = `${unlocked.length}/${allBadges.length} badges unlocked`;
        }

        // Check badges on load
        setTimeout(checkBadges, 2000);

        console.log(' Study Goals, Science News, and Achievement Badges loaded!');

        // ========== BATCH 89: Science Dictionary, Study Streak, Quick Notes ==========

        // Science Dictionary Button
        const dictBtn = document.createElement('button');
        dictBtn.className = 'dict-btn';
        dictBtn.innerHTML = '';
        dictBtn.title = 'Science Dictionary';
        dictBtn.onclick = () => openDictModal();
        document.body.appendChild(dictBtn);

        // Science Dictionary Modal
        const dictModal = document.createElement('div');
        dictModal.className = 'dict-modal';
        dictModal.id = 'dictModal';
        dictModal.innerHTML = `
            <div class="dict-content">
                <h3 style="color: #455a64; margin-bottom: 15px;"> Science Dictionary</h3>
                <input type="text" class="dict-search" id="dictSearch" placeholder="Search for a term..." oninput="searchDictionary()">
                <div id="dictResults"></div>
                <button onclick="closeDictModal()" style="margin-top: 15px; padding: 10px 25px; background: #455a64; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(dictModal);

        const scienceDictionary = [
            { term: 'Acceleration', def: 'The rate of change of velocity over time. Measured in m/s.', cat: 'Physics' },
            { term: 'Atom', def: 'The smallest unit of matter that retains the properties of an element.', cat: 'Chemistry' },
            { term: 'Cell', def: 'The basic structural and functional unit of all living organisms.', cat: 'Biology' },
            { term: 'Density', def: 'Mass per unit volume. Calculated as mass divided by volume.', cat: 'Physics' },
            { term: 'Electron', def: 'A negatively charged subatomic particle that orbits the nucleus.', cat: 'Chemistry' },
            { term: 'Force', def: 'A push or pull that can change an object\'s motion. Measured in Newtons.', cat: 'Physics' },
            { term: 'Gene', def: 'A unit of heredity that contains instructions for making proteins.', cat: 'Biology' },
            { term: 'Hypothesis', def: 'A testable prediction or proposed explanation for an observation.', cat: 'General' },
            { term: 'Ion', def: 'An atom or molecule with a net electric charge due to electron loss/gain.', cat: 'Chemistry' },
            { term: 'Kinetic Energy', def: 'Energy possessed by an object due to its motion. KE = mv.', cat: 'Physics' },
            { term: 'Light Year', def: 'The distance light travels in one year (about 9.46 trillion km).', cat: 'Astronomy' },
            { term: 'Mitosis', def: 'Cell division that produces two identical daughter cells.', cat: 'Biology' },
            { term: 'Neutron', def: 'A neutral subatomic particle found in the nucleus of an atom.', cat: 'Chemistry' },
            { term: 'Osmosis', def: 'Movement of water across a membrane from low to high solute concentration.', cat: 'Biology' },
            { term: 'Photosynthesis', def: 'Process by which plants convert light energy into chemical energy.', cat: 'Biology' },
            { term: 'Quantum', def: 'The minimum amount of any physical entity involved in an interaction.', cat: 'Physics' },
            { term: 'Radiation', def: 'Energy emitted as waves or particles, including light and heat.', cat: 'Physics' },
            { term: 'Solution', def: 'A homogeneous mixture of two or more substances.', cat: 'Chemistry' },
            { term: 'Temperature', def: 'A measure of the average kinetic energy of particles in a substance.', cat: 'Physics' },
            { term: 'Velocity', def: 'Speed in a given direction. A vector quantity measured in m/s.', cat: 'Physics' },
            { term: 'Wavelength', def: 'The distance between consecutive peaks of a wave.', cat: 'Physics' },
            { term: 'Enzyme', def: 'A biological catalyst that speeds up chemical reactions in cells.', cat: 'Biology' },
            { term: 'Proton', def: 'A positively charged subatomic particle found in the nucleus.', cat: 'Chemistry' },
            { term: 'Gravity', def: 'The force of attraction between objects with mass.', cat: 'Physics' }
        ];

        function openDictModal() {
            document.getElementById('dictModal').style.display = 'flex';
            document.getElementById('dictSearch').value = '';
            showRandomTerms();
        }

        function closeDictModal() {
            document.getElementById('dictModal').style.display = 'none';
        }

        function showRandomTerms() {
            const random = [...scienceDictionary].sort(() => Math.random() - 0.5).slice(0, 3);
            document.getElementById('dictResults').innerHTML = random.map(item => `
                <div class="dict-result" style="margin-bottom: 10px;">
                    <div class="dict-term">${item.term}</div>
                    <div class="dict-definition">${item.def}</div>
                    <span class="dict-category">${item.cat}</span>
                </div>
            `).join('');
        }

        function searchDictionary() {
            const query = document.getElementById('dictSearch').value.toLowerCase();
            if (query.length < 2) {
                showRandomTerms();
                return;
            }
            const results = scienceDictionary.filter(item =>
                item.term.toLowerCase().includes(query) || item.def.toLowerCase().includes(query)
            );
            if (results.length === 0) {
                document.getElementById('dictResults').innerHTML = '<p style="text-align: center; color: #999;">No terms found. Try a different search.</p>';
            } else {
                document.getElementById('dictResults').innerHTML = results.slice(0, 5).map(item => `
                    <div class="dict-result" style="margin-bottom: 10px;">
                        <div class="dict-term">${item.term}</div>
                        <div class="dict-definition">${item.def}</div>
                        <span class="dict-category">${item.cat}</span>
                    </div>
                `).join('');
            }
        }

        // Study Streak Button
        const streakBtn = document.createElement('button');
        streakBtn.className = 'streak-btn';
        streakBtn.innerHTML = '';
        streakBtn.title = 'Study Streak';
        streakBtn.onclick = () => openStreakModal();
        document.body.appendChild(streakBtn);

        // Study Streak Modal
        const streakModal = document.createElement('div');
        streakModal.className = 'streak-modal';
        streakModal.id = 'streakModal';
        streakModal.innerHTML = `
            <div class="streak-content">
                <h3 style="color: #ff5722; margin-bottom: 10px;"> Study Streak</h3>
                <div class="streak-number" id="streakNumber">0</div>
                <div class="streak-label">day streak</div>
                <div class="streak-calendar" id="streakCalendar"></div>
                <p style="color: #666; font-size: 0.9rem;">Keep learning every day to maintain your streak!</p>
                <button onclick="closeStreakModal()" style="margin-top: 15px; padding: 10px 25px; background: #ff5722; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(streakModal);

        function getStreakData() {
            return JSON.parse(localStorage.getItem('studyStreak') || '{"dates": [], "currentStreak": 0}');
        }

        function saveStreakData(data) {
            localStorage.setItem('studyStreak', JSON.stringify(data));
        }

        function updateStreak() {
            const data = getStreakData();
            const today = new Date().toDateString();

            if (!data.dates.includes(today)) {
                data.dates.push(today);

                // Check if yesterday was recorded
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();

                if (data.dates.includes(yesterdayStr) || data.dates.length === 1) {
                    data.currentStreak++;
                } else {
                    data.currentStreak = 1;
                }

                saveStreakData(data);

                // Award XP for maintaining streak
                if (data.currentStreak > 1) {
                    addXP(10 * data.currentStreak);
                }
            }
        }

        function openStreakModal() {
            document.getElementById('streakModal').style.display = 'flex';
            updateStreak();
            renderStreakCalendar();
        }

        function closeStreakModal() {
            document.getElementById('streakModal').style.display = 'none';
        }

        function renderStreakCalendar() {
            const data = getStreakData();
            document.getElementById('streakNumber').textContent = data.currentStreak;

            const today = new Date();
            const calendar = document.getElementById('streakCalendar');
            let html = '';

            // Show last 14 days
            for (let i = 13; i >= 0; i--) {
                const date = new Date();
                date.setDate(today.getDate() - i);
                const dateStr = date.toDateString();
                const isActive = data.dates.includes(dateStr);
                const isToday = i === 0;

                html += `<div class="streak-day ${isActive ? 'active' : 'inactive'} ${isToday ? 'today' : ''}">${date.getDate()}</div>`;
            }

            calendar.innerHTML = html;
        }

        // Update streak on page load
        setTimeout(updateStreak, 1000);

        // Quick Notes Button
        const quickNotesBtn = document.createElement('button');
        quickNotesBtn.className = 'quick-notes-btn';
        quickNotesBtn.innerHTML = '';
        quickNotesBtn.title = 'Quick Notes';
        quickNotesBtn.onclick = () => openQuickNotesModal();
        document.body.appendChild(quickNotesBtn);

        // Quick Notes Modal
        const quickNotesModal = document.createElement('div');
        quickNotesModal.className = 'quick-notes-modal';
        quickNotesModal.id = 'quickNotesModal';
        quickNotesModal.innerHTML = `
            <div class="quick-notes-content">
                <h3 style="color: #9c27b0; margin-bottom: 15px;"> Quick Notes</h3>
                <div id="notesContainer"></div>
                <div class="add-note-area">
                    <textarea id="newNoteText" rows="3" placeholder="Jot down a quick note..."></textarea>
                    <button onclick="addQuickNote()" style="width: 100%; padding: 12px; background: #9c27b0; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px;">Add Note +5 XP</button>
                </div>
                <button onclick="closeQuickNotesModal()" style="margin-top: 15px; padding: 10px 25px; background: #9c27b0; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(quickNotesModal);

        function getQuickNotes() {
            return JSON.parse(localStorage.getItem('quickNotes') || '[]');
        }

        function saveQuickNotes(notes) {
            localStorage.setItem('quickNotes', JSON.stringify(notes));
        }

        function openQuickNotesModal() {
            document.getElementById('quickNotesModal').style.display = 'flex';
            renderQuickNotes();
        }

        function closeQuickNotesModal() {
            document.getElementById('quickNotesModal').style.display = 'none';
        }

        function renderQuickNotes() {
            const notes = getQuickNotes();
            const container = document.getElementById('notesContainer');

            if (notes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No notes yet! Add one below.</p>';
            } else {
                container.innerHTML = notes.map((note, i) => `
                    <div class="sticky-note">
                        <button class="sticky-note-delete" onclick="deleteQuickNote(${i})"></button>
                        <div class="sticky-note-text">${note.text}</div>
                        <div class="sticky-note-date">${note.date}</div>
                    </div>
                `).join('');
            }
        }

        function addQuickNote() {
            const text = document.getElementById('newNoteText').value.trim();
            if (!text) return;

            const notes = getQuickNotes();
            notes.unshift({
                text: text,
                date: new Date().toLocaleString()
            });
            saveQuickNotes(notes.slice(0, 20)); // Keep max 20 notes
            document.getElementById('newNoteText').value = '';
            addXP(5);
            renderQuickNotes();
        }

        function deleteQuickNote(index) {
            const notes = getQuickNotes();
            notes.splice(index, 1);
            saveQuickNotes(notes);
            renderQuickNotes();
        }

        console.log(' Science Dictionary, Study Streak, and Quick Notes loaded!');

        // ========== BATCH 90: Quiz History, Science Challenge, Learning Path ==========

        // Quiz History Button
        const quizHistoryBtn = document.createElement('button');
        quizHistoryBtn.className = 'quiz-history-btn';
        quizHistoryBtn.innerHTML = '';
        quizHistoryBtn.title = 'Quiz History';
        quizHistoryBtn.onclick = () => openQuizHistoryModal();
        document.body.appendChild(quizHistoryBtn);

        // Quiz History Modal
        const quizHistoryModal = document.createElement('div');
        quizHistoryModal.className = 'quiz-history-modal';
        quizHistoryModal.id = 'quizHistoryModal';
        quizHistoryModal.innerHTML = `
            <div class="quiz-history-content">
                <h3 style="color: #1976d2; margin-bottom: 15px;"> Quiz Performance</h3>
                <div class="history-stats" id="quizStats"></div>
                <h4 style="color: #1976d2; margin-bottom: 10px;">Recent Attempts</h4>
                <div id="quizHistoryList"></div>
                <button onclick="closeQuizHistoryModal()" style="margin-top: 15px; padding: 10px 25px; background: #1976d2; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(quizHistoryModal);

        function getQuizHistory() {
            return JSON.parse(localStorage.getItem('quizHistory') || '[]');
        }

        function saveQuizResult(score, total, topic) {
            const history = getQuizHistory();
            history.unshift({
                score,
                total,
                topic: topic || 'General',
                date: new Date().toLocaleString(),
                percentage: Math.round((score / total) * 100)
            });
            localStorage.setItem('quizHistory', JSON.stringify(history.slice(0, 20)));
        }

        function openQuizHistoryModal() {
            document.getElementById('quizHistoryModal').style.display = 'flex';
            renderQuizHistory();
        }

        function closeQuizHistoryModal() {
            document.getElementById('quizHistoryModal').style.display = 'none';
        }

        function renderQuizHistory() {
            const history = getQuizHistory();

            // Calculate stats
            const totalQuizzes = history.length;
            const avgScore = totalQuizzes > 0 ? Math.round(history.reduce((sum, h) => sum + h.percentage, 0) / totalQuizzes) : 0;
            const bestScore = totalQuizzes > 0 ? Math.max(...history.map(h => h.percentage)) : 0;

            document.getElementById('quizStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalQuizzes}</div>
                    <div class="stat-label">Total Quizzes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgScore}%</div>
                    <div class="stat-label">Average</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${bestScore}%</div>
                    <div class="stat-label">Best Score</div>
                </div>
            `;

            if (history.length === 0) {
                document.getElementById('quizHistoryList').innerHTML = '<p style="text-align: center; color: #999;">No quiz history yet. Take a quiz to see results!</p>';
            } else {
                document.getElementById('quizHistoryList').innerHTML = history.slice(0, 8).map(h => `
                    <div class="history-item">
                        <div>
                            <strong>${h.topic}</strong>
                            <div class="history-date">${h.date}</div>
                        </div>
                        <div class="history-score">${h.score}/${h.total} (${h.percentage}%)</div>
                    </div>
                `).join('');
            }
        }

        // Science Challenge Button
        const challengeBtn = document.createElement('button');
        challengeBtn.className = 'challenge-btn';
        challengeBtn.innerHTML = '';
        challengeBtn.title = 'Speed Challenge';
        challengeBtn.onclick = () => openChallengeModal();
        document.body.appendChild(challengeBtn);

        // Science Challenge Modal
        const challengeModal = document.createElement('div');
        challengeModal.className = 'challenge-modal';
        challengeModal.id = 'challengeModal';
        challengeModal.innerHTML = `
            <div class="challenge-content">
                <h3 style="color: #e91e63; margin-bottom: 10px;"> Speed Challenge</h3>
                <p style="color: #666;">Answer as many as you can in 60 seconds!</p>
                <div class="challenge-timer" id="challengeTimer">60</div>
                <div class="challenge-question" id="challengeQuestion">Ready?</div>
                <input type="text" class="challenge-input" id="challengeAnswer" placeholder="Type your answer..." onkeypress="if(event.key==='Enter')submitChallengeAnswer()">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="challengeStartBtn" onclick="startChallenge()" style="padding: 12px 25px; background: #e91e63; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold;">Start!</button>
                    <button onclick="closeChallengeModal()" style="padding: 12px 25px; background: #9e9e9e; color: white; border: none; border-radius: 25px; cursor: pointer;">Close</button>
                </div>
                <p id="challengeScore" style="margin-top: 15px; font-weight: bold; color: #e91e63;"></p>
            </div>
        `;
        document.body.appendChild(challengeModal);

        const challengeQuestions = [
            { q: 'Chemical symbol for water?', a: ['h2o'] },
            { q: 'How many planets in our solar system?', a: ['8', 'eight'] },
            { q: 'What gas do we breathe in?', a: ['oxygen', 'o2'] },
            { q: 'Powerhouse of the cell?', a: ['mitochondria'] },
            { q: 'Speed of light in m/s? (just the number)', a: ['300000000', '3e8'] },
            { q: 'Formula for force?', a: ['f=ma', 'ma', 'fma'] },
            { q: 'Atomic number of carbon?', a: ['6', 'six'] },
            { q: 'What organ pumps blood?', a: ['heart'] },
            { q: 'Largest planet?', a: ['jupiter'] },
            { q: 'Unit of electrical resistance?', a: ['ohm', 'ohms'] },
            { q: 'Process plants make food?', a: ['photosynthesis'] },
            { q: 'Number of bones in adult human?', a: ['206'] },
            { q: 'Chemical formula for salt?', a: ['nacl'] },
            { q: 'What planet is closest to the sun?', a: ['mercury'] },
            { q: 'Unit of force?', a: ['newton', 'newtons', 'n'] }
        ];

        let challengeTime = 60;
        let challengeInterval = null;
        let currentChallengeQ = null;
        let challengeCorrect = 0;

        function openChallengeModal() {
            document.getElementById('challengeModal').style.display = 'flex';
            resetChallenge();
        }

        function closeChallengeModal() {
            document.getElementById('challengeModal').style.display = 'none';
            if (challengeInterval) clearInterval(challengeInterval);
        }

        function resetChallenge() {
            challengeTime = 60;
            challengeCorrect = 0;
            document.getElementById('challengeTimer').textContent = '60';
            document.getElementById('challengeQuestion').textContent = 'Ready?';
            document.getElementById('challengeAnswer').value = '';
            document.getElementById('challengeScore').textContent = '';
            document.getElementById('challengeStartBtn').style.display = 'inline-block';
            document.getElementById('challengeAnswer').disabled = true;
        }

        function startChallenge() {
            document.getElementById('challengeStartBtn').style.display = 'none';
            document.getElementById('challengeAnswer').disabled = false;
            document.getElementById('challengeAnswer').focus();
            nextChallengeQuestion();

            challengeInterval = setInterval(() => {
                challengeTime--;
                document.getElementById('challengeTimer').textContent = challengeTime;

                if (challengeTime <= 0) {
                    endChallenge();
                }
            }, 1000);
        }

        function nextChallengeQuestion() {
            currentChallengeQ = challengeQuestions[Math.floor(Math.random() * challengeQuestions.length)];
            document.getElementById('challengeQuestion').textContent = currentChallengeQ.q;
            document.getElementById('challengeAnswer').value = '';
        }

        function submitChallengeAnswer() {
            if (!currentChallengeQ || challengeTime <= 0) return;

            const answer = document.getElementById('challengeAnswer').value.toLowerCase().trim();
            if (currentChallengeQ.a.includes(answer)) {
                challengeCorrect++;
                document.getElementById('challengeScore').textContent = ` Correct! Score: ${challengeCorrect}`;
            } else {
                document.getElementById('challengeScore').textContent = ` Try again! Score: ${challengeCorrect}`;
            }
            nextChallengeQuestion();
        }

        function endChallenge() {
            clearInterval(challengeInterval);
            document.getElementById('challengeAnswer').disabled = true;
            document.getElementById('challengeQuestion').textContent = 'Time\'s up!';
            document.getElementById('challengeScore').textContent = `Final Score: ${challengeCorrect} correct answers! +${challengeCorrect * 10} XP`;
            document.getElementById('challengeStartBtn').textContent = 'Play Again';
            document.getElementById('challengeStartBtn').style.display = 'inline-block';
            document.getElementById('challengeStartBtn').onclick = resetChallenge;
            addXP(challengeCorrect * 10);
            saveQuizResult(challengeCorrect, 15, 'Speed Challenge');
        }

        // Learning Path Button
        const learningPathBtn = document.createElement('button');
        learningPathBtn.className = 'learning-path-btn';
        learningPathBtn.innerHTML = '';
        learningPathBtn.title = 'Learning Path';
        learningPathBtn.onclick = () => openLearningPathModal();
        document.body.appendChild(learningPathBtn);

        // Learning Path Modal
        const learningPathModal = document.createElement('div');
        learningPathModal.className = 'learning-path-modal';
        learningPathModal.id = 'learningPathModal';
        learningPathModal.innerHTML = `
            <div class="learning-path-content">
                <h3 style="color: #00796b; margin-bottom: 15px;"> Your Learning Path</h3>
                <p style="color: #666; margin-bottom: 15px;">Follow this suggested progression to master science!</p>
                <div id="learningPathList"></div>
                <button onclick="closeLearningPathModal()" style="margin-top: 15px; padding: 10px 25px; background: #00796b; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(learningPathModal);

        const learningTopics = [
            { id: 1, title: 'Scientific Method', desc: 'Learn how scientists investigate and discover' },
            { id: 2, title: 'Matter & States', desc: 'Understand solids, liquids, gases, and changes' },
            { id: 3, title: 'Atomic Structure', desc: 'Explore atoms, protons, neutrons, electrons' },
            { id: 4, title: 'Chemical Reactions', desc: 'Learn how substances combine and change' },
            { id: 5, title: 'Forces & Motion', desc: 'Master Newton\'s laws and movement' },
            { id: 6, title: 'Energy Forms', desc: 'Understand kinetic, potential, and other energies' },
            { id: 7, title: 'Waves & Light', desc: 'Explore sound, light, and electromagnetic spectrum' },
            { id: 8, title: 'Cell Biology', desc: 'Discover cell structure and function' },
            { id: 9, title: 'Genetics & DNA', desc: 'Learn about heredity and genetic code' },
            { id: 10, title: 'Ecosystems', desc: 'Understand food webs and environmental science' }
        ];

        function getCompletedTopics() {
            return JSON.parse(localStorage.getItem('completedTopics') || '[]');
        }

        function toggleTopicComplete(id) {
            let completed = getCompletedTopics();
            if (completed.includes(id)) {
                completed = completed.filter(x => x !== id);
            } else {
                completed.push(id);
                addXP(30);
            }
            localStorage.setItem('completedTopics', JSON.stringify(completed));
            renderLearningPath();
        }

        function openLearningPathModal() {
            document.getElementById('learningPathModal').style.display = 'flex';
            renderLearningPath();
        }

        function closeLearningPathModal() {
            document.getElementById('learningPathModal').style.display = 'none';
        }

        function renderLearningPath() {
            const completed = getCompletedTopics();
            document.getElementById('learningPathList').innerHTML = learningTopics.map(topic => {
                const isCompleted = completed.includes(topic.id);
                return `
                    <div class="path-topic ${isCompleted ? 'completed' : ''}" onclick="toggleTopicComplete(${topic.id})">
                        <div class="path-number">${isCompleted ? '' : topic.id}</div>
                        <div class="path-info">
                            <div class="path-title">${topic.title}</div>
                            <div class="path-desc">${topic.desc}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        console.log(' Quiz History, Science Challenge, and Learning Path loaded!');

        // ========== BATCH 91: Science Tip, Memory Game, Quick Quiz ==========

        // Science Tip Button
        const tipBtn = document.createElement('button');
        tipBtn.className = 'tip-btn';
        tipBtn.innerHTML = '';
        tipBtn.title = 'Science Tip';
        tipBtn.onclick = () => openTipModal();
        document.body.appendChild(tipBtn);

        // Science Tip Modal
        const tipModal = document.createElement('div');
        tipModal.className = 'tip-modal';
        tipModal.id = 'tipModal';
        tipModal.innerHTML = `
            <div class="tip-content">
                <h3 style="color: #ff6f00; margin-bottom: 10px;"> Study Tip of the Day</h3>
                <div class="tip-icon" id="tipIcon"></div>
                <div class="tip-text" id="tipText">Loading...</div>
                <span class="tip-category" id="tipCategory">General</span>
                <button onclick="nextTip()" style="margin-top: 20px; padding: 12px 25px; background: #ff6f00; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold;">Next Tip</button>
                <button onclick="closeTipModal()" style="margin-top: 10px; padding: 10px 20px; background: #9e9e9e; color: white; border: none; border-radius: 20px; cursor: pointer; display: block; margin-left: auto; margin-right: auto;">Close</button>
            </div>
        `;
        document.body.appendChild(tipModal);

        const scienceTips = [
            { icon: '', text: 'Use active recall: Test yourself instead of just re-reading. Try to remember information before checking your notes.', cat: 'Memory' },
            { icon: '', text: 'Create your own diagrams and flowcharts. Drawing concepts helps your brain process and remember them better.', cat: 'Visual Learning' },
            { icon: '', text: 'Study in 25-minute focused blocks with 5-minute breaks (Pomodoro Technique). Your brain needs rest to consolidate learning.', cat: 'Time Management' },
            { icon: '', text: 'Connect new concepts to things you already know. Making associations helps information stick in long-term memory.', cat: 'Memory' },
            { icon: '', text: 'Teach the concept to someone else (or pretend to). If you can explain it simply, you truly understand it.', cat: 'Understanding' },
            { icon: '', text: 'Use mnemonics for lists. For example: "My Very Eager Mother Just Served Us Nachos" for planets.', cat: 'Memory' },
            { icon: '', text: 'Get enough sleep! Your brain consolidates memories during sleep. Pulling all-nighters hurts learning.', cat: 'Health' },
            { icon: '', text: 'Ask "why" and "how" questions. Understanding the reasons behind facts makes them easier to remember.', cat: 'Understanding' },
            { icon: '', text: 'Space out your studying over multiple days. Cramming doesn\'t work for long-term retention.', cat: 'Time Management' },
            { icon: '', text: 'Write summaries in your own words after each topic. This forces your brain to process the information.', cat: 'Note-Taking' },
            { icon: '', text: 'Focus on understanding concepts, not just memorizing facts. Science builds on foundations.', cat: 'Understanding' },
            { icon: '', text: 'Put away your phone while studying. Even having it visible reduces focus and learning.', cat: 'Focus' }
        ];

        let currentTipIndex = 0;

        function openTipModal() {
            document.getElementById('tipModal').style.display = 'flex';
            showTip();
        }

        function closeTipModal() {
            document.getElementById('tipModal').style.display = 'none';
        }

        function showTip() {
            const tip = scienceTips[currentTipIndex];
            document.getElementById('tipIcon').textContent = tip.icon;
            document.getElementById('tipText').textContent = tip.text;
            document.getElementById('tipCategory').textContent = tip.cat;
        }

        function nextTip() {
            currentTipIndex = (currentTipIndex + 1) % scienceTips.length;
            showTip();
            addXP(2);
        }

        // Memory Game Button
        const memoryBtn = document.createElement('button');
        memoryBtn.className = 'memory-btn';
        memoryBtn.innerHTML = '';
        memoryBtn.title = 'Memory Game';
        memoryBtn.onclick = () => openMemoryModal();
        document.body.appendChild(memoryBtn);

        // Memory Game Modal
        const memoryModal = document.createElement('div');
        memoryModal.className = 'memory-modal';
        memoryModal.id = 'memoryModal';
        memoryModal.innerHTML = `
            <div class="memory-content">
                <h3 style="color: #7c4dff; margin-bottom: 10px;"> Memory Match</h3>
                <p style="color: #666; margin-bottom: 15px;">Match science terms with their definitions!</p>
                <div class="memory-grid" id="memoryGrid"></div>
                <p id="memoryStatus" style="font-weight: bold; color: #7c4dff;">Matches: 0/4</p>
                <button onclick="resetMemoryGame()" style="margin-top: 10px; padding: 10px 20px; background: #7c4dff; color: white; border: none; border-radius: 20px; cursor: pointer;">New Game</button>
                <button onclick="closeMemoryModal()" style="margin-top: 10px; padding: 10px 20px; background: #9e9e9e; color: white; border: none; border-radius: 20px; cursor: pointer;">Close</button>
            </div>
        `;
        document.body.appendChild(memoryModal);

        const memoryPairs = [
            { term: 'Mitochondria', def: 'Cell powerhouse' },
            { term: 'Photosynthesis', def: 'Makes glucose' },
            { term: 'Gravity', def: 'Attracts mass' },
            { term: 'Atom', def: 'Smallest unit' },
            { term: 'DNA', def: 'Genetic code' },
            { term: 'Force', def: 'Push or pull' },
            { term: 'Electron', def: 'Negative charge' },
            { term: 'Osmosis', def: 'Water movement' }
        ];

        let memoryCards = [];
        let flippedCards = [];
        let matchedPairs = 0;

        function openMemoryModal() {
            document.getElementById('memoryModal').style.display = 'flex';
            resetMemoryGame();
        }

        function closeMemoryModal() {
            document.getElementById('memoryModal').style.display = 'none';
        }

        function resetMemoryGame() {
            // Select 4 random pairs
            const selected = [...memoryPairs].sort(() => Math.random() - 0.5).slice(0, 4);
            memoryCards = [];

            selected.forEach((pair, i) => {
                memoryCards.push({ id: i, text: pair.term, pairId: i });
                memoryCards.push({ id: i + 4, text: pair.def, pairId: i });
            });

            memoryCards = memoryCards.sort(() => Math.random() - 0.5);
            flippedCards = [];
            matchedPairs = 0;
            renderMemoryGrid();
            document.getElementById('memoryStatus').textContent = 'Matches: 0/4';
        }

        function renderMemoryGrid() {
            document.getElementById('memoryGrid').innerHTML = memoryCards.map((card, i) => {
                const isFlipped = flippedCards.includes(i);
                const isMatched = card.matched;
                return `<div class="memory-card ${isFlipped ? 'flipped' : ''} ${isMatched ? 'matched' : ''}" onclick="flipMemoryCard(${i})">${card.text}</div>`;
            }).join('');
        }

        function flipMemoryCard(index) {
            if (flippedCards.length >= 2 || flippedCards.includes(index) || memoryCards[index].matched) return;

            flippedCards.push(index);
            renderMemoryGrid();

            if (flippedCards.length === 2) {
                const [first, second] = flippedCards;
                if (memoryCards[first].pairId === memoryCards[second].pairId) {
                    memoryCards[first].matched = true;
                    memoryCards[second].matched = true;
                    matchedPairs++;
                    document.getElementById('memoryStatus').textContent = `Matches: ${matchedPairs}/4`;
                    flippedCards = [];
                    renderMemoryGrid();

                    if (matchedPairs === 4) {
                        addXP(20);
                        document.getElementById('memoryStatus').textContent = ' Complete! +20 XP';
                    }
                } else {
                    setTimeout(() => {
                        flippedCards = [];
                        renderMemoryGrid();
                    }, 1000);
                }
            }
        }

        // Quick Quiz Button
        const quickQuizBtn = document.createElement('button');
        quickQuizBtn.className = 'quick-quiz-btn';
        quickQuizBtn.innerHTML = '';
        quickQuizBtn.title = 'Quick Quiz';
        quickQuizBtn.onclick = () => openQuickQuizModal();
        document.body.appendChild(quickQuizBtn);

        // Quick Quiz Modal
        const quickQuizModal = document.createElement('div');
        quickQuizModal.className = 'quick-quiz-modal';
        quickQuizModal.id = 'quickQuizModal';
        quickQuizModal.innerHTML = `
            <div class="quick-quiz-content">
                <h3 style="color: #00bcd4; margin-bottom: 15px;"> Quick Quiz</h3>
                <div class="quiz-progress-bar">
                    <div class="quiz-progress-fill" id="quizProgressFill" style="width: 0%"></div>
                </div>
                <p id="quizQuestionNum" style="text-align: center; color: #666; margin-bottom: 10px;">Question 1/5</p>
                <div class="quiz-question-text" id="quizQuestionText">Loading...</div>
                <div class="quiz-options" id="quizOptions"></div>
                <div id="quizResult" style="text-align: center; margin-top: 15px; display: none;"></div>
                <button onclick="closeQuickQuizModal()" style="margin-top: 15px; padding: 10px 25px; background: #00bcd4; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(quickQuizModal);

        const quickQuizQuestions = [
            { q: 'What is the chemical formula for water?', opts: ['CO2', 'H2O', 'NaCl', 'O2'], correct: 1 },
            { q: 'What planet is closest to the Sun?', opts: ['Venus', 'Mars', 'Mercury', 'Earth'], correct: 2 },
            { q: 'What is the powerhouse of the cell?', opts: ['Nucleus', 'Mitochondria', 'Ribosome', 'Golgi'], correct: 1 },
            { q: 'What type of charge does an electron have?', opts: ['Positive', 'Negative', 'Neutral', 'Variable'], correct: 1 },
            { q: 'What gas do plants release during photosynthesis?', opts: ['CO2', 'Nitrogen', 'Oxygen', 'Hydrogen'], correct: 2 },
            { q: 'What is the SI unit of force?', opts: ['Joule', 'Watt', 'Newton', 'Pascal'], correct: 2 },
            { q: 'How many bones are in an adult human body?', opts: ['186', '206', '226', '256'], correct: 1 },
            { q: 'What is the largest organ in the human body?', opts: ['Heart', 'Liver', 'Skin', 'Brain'], correct: 2 },
            { q: 'What is the chemical symbol for gold?', opts: ['Go', 'Gd', 'Au', 'Ag'], correct: 2 },
            { q: 'What force keeps planets in orbit?', opts: ['Friction', 'Gravity', 'Magnetism', 'Inertia'], correct: 1 }
        ];

        let quizQuestions = [];
        let quizCurrentQ = 0;
        let quizScore = 0;

        function openQuickQuizModal() {
            document.getElementById('quickQuizModal').style.display = 'flex';
            startQuickQuiz();
        }

        function closeQuickQuizModal() {
            document.getElementById('quickQuizModal').style.display = 'none';
        }

        function startQuickQuiz() {
            quizQuestions = [...quickQuizQuestions].sort(() => Math.random() - 0.5).slice(0, 5);
            quizCurrentQ = 0;
            quizScore = 0;
            document.getElementById('quizResult').style.display = 'none';
            showQuizQuestion();
        }

        function showQuizQuestion() {
            if (quizCurrentQ >= quizQuestions.length) {
                endQuickQuiz();
                return;
            }

            const q = quizQuestions[quizCurrentQ];
            document.getElementById('quizQuestionNum').textContent = `Question ${quizCurrentQ + 1}/5`;
            document.getElementById('quizProgressFill').style.width = `${(quizCurrentQ / 5) * 100}%`;
            document.getElementById('quizQuestionText').textContent = q.q;
            document.getElementById('quizOptions').innerHTML = q.opts.map((opt, i) =>
                `<div class="quiz-option" onclick="answerQuickQuiz(${i})">${opt}</div>`
            ).join('');
        }

        function answerQuickQuiz(index) {
            const q = quizQuestions[quizCurrentQ];
            const options = document.querySelectorAll('.quiz-option');

            options.forEach((opt, i) => {
                opt.onclick = null;
                if (i === q.correct) opt.classList.add('correct');
                else if (i === index) opt.classList.add('wrong');
            });

            if (index === q.correct) quizScore++;

            setTimeout(() => {
                quizCurrentQ++;
                showQuizQuestion();
            }, 1000);
        }

        function endQuickQuiz() {
            document.getElementById('quizQuestionText').textContent = 'Quiz Complete!';
            document.getElementById('quizOptions').innerHTML = '';
            document.getElementById('quizProgressFill').style.width = '100%';
            document.getElementById('quizResult').style.display = 'block';
            document.getElementById('quizResult').innerHTML = `
                <h2 style="color: #00bcd4;">${quizScore}/5 Correct!</h2>
                <p>+${quizScore * 10} XP earned</p>
                <button onclick="startQuickQuiz()" style="margin-top: 10px; padding: 10px 20px; background: #00bcd4; color: white; border: none; border-radius: 20px; cursor: pointer;">Try Again</button>
            `;
            addXP(quizScore * 10);
            if (typeof saveQuizResult === 'function') {
                saveQuizResult(quizScore, 5, 'Quick Quiz');
            }
        }

        console.log(' Science Tip, Memory Game, and Quick Quiz loaded!');

        // ========== BATCH 92: Scoreboard, Random Fact, Homework Tracker ==========

        // Scoreboard Button
        const scoreboardBtn = document.createElement('button');
        scoreboardBtn.className = 'scoreboard-btn';
        scoreboardBtn.innerHTML = '';
        scoreboardBtn.title = 'Scoreboard';
        scoreboardBtn.onclick = () => openScoreboardModal();
        document.body.appendChild(scoreboardBtn);

        // Scoreboard Modal
        const scoreboardModal = document.createElement('div');
        scoreboardModal.className = 'scoreboard-modal';
        scoreboardModal.id = 'scoreboardModal';
        scoreboardModal.innerHTML = `
            <div class="scoreboard-content">
                <h3 style="color: #c62828; margin-bottom: 15px;"> Science Scoreboard</h3>
                <div id="scoreboardList"></div>
                <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #ffebee, #ffcdd2); border-radius: 12px;">
                    <p style="color: #c62828; font-weight: bold;">Your Rank</p>
                    <p id="yourRank" style="font-size: 1.5rem; font-weight: bold; color: #c62828;">Loading...</p>
                </div>
                <button onclick="closeScoreboardModal()" style="margin-top: 15px; padding: 10px 25px; background: #c62828; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(scoreboardModal);

        // Simulated leaderboard data
        const leaderboardNames = ['Alex', 'Jordan', 'Sam', 'Taylor', 'Casey', 'Morgan', 'Riley', 'Quinn', 'Avery', 'Skyler'];

        function generateLeaderboard() {
            const yourXP = parseInt(localStorage.getItem('scienceToolXP') || '0');
            const leaders = leaderboardNames.map(name => ({
                name,
                xp: Math.floor(Math.random() * 2000) + 100
            }));
            leaders.push({ name: 'You', xp: yourXP, isYou: true });
            return leaders.sort((a, b) => b.xp - a.xp);
        }

        function openScoreboardModal() {
            document.getElementById('scoreboardModal').style.display = 'flex';
            renderScoreboard();
        }

        function closeScoreboardModal() {
            document.getElementById('scoreboardModal').style.display = 'none';
        }

        function renderScoreboard() {
            const leaders = generateLeaderboard();
            const yourRank = leaders.findIndex(l => l.isYou) + 1;

            document.getElementById('scoreboardList').innerHTML = leaders.slice(0, 5).map((leader, i) => {
                const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                const medal = i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : (i + 1);
                return `
                    <div class="scoreboard-rank ${rankClass}" ${leader.isYou ? 'style="border: 2px solid #c62828;"' : ''}>
                        <span class="rank-number">${medal}</span>
                        <span style="flex: 1; font-weight: ${leader.isYou ? 'bold' : 'normal'};">${leader.name}</span>
                        <span class="rank-xp">${leader.xp} XP</span>
                    </div>
                `;
            }).join('');

            document.getElementById('yourRank').textContent = `#${yourRank} of ${leaders.length}`;
        }

        // Random Fact Button
        const randomFactBtn = document.createElement('button');
        randomFactBtn.className = 'random-fact-btn';
        randomFactBtn.innerHTML = '';
        randomFactBtn.title = 'Random Fact';
        randomFactBtn.onclick = () => openRandomFactModal();
        document.body.appendChild(randomFactBtn);

        // Random Fact Modal
        const randomFactModal = document.createElement('div');
        randomFactModal.className = 'random-fact-modal';
        randomFactModal.id = 'randomFactModal';
        randomFactModal.innerHTML = `
            <div class="random-fact-content">
                <h3 style="color: #2e7d32; margin-bottom: 15px;"> Random Science Fact</h3>
                <div class="fact-display">
                    <div class="fact-emoji" id="factEmoji"></div>
                    <div class="fact-text" id="factText">Loading...</div>
                </div>
                <button onclick="generateRandomFact()" style="padding: 12px 25px; background: #2e7d32; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold;">Another Fact! +3 XP</button>
                <button onclick="closeRandomFactModal()" style="margin-top: 10px; padding: 10px 20px; background: #9e9e9e; color: white; border: none; border-radius: 20px; cursor: pointer; display: block; margin-left: auto; margin-right: auto;">Close</button>
            </div>
        `;
        document.body.appendChild(randomFactModal);

        const randomFacts = [
            { emoji: '', fact: 'If you could uncoil all the DNA in your body, it would stretch about 10 billion miles - from Earth to Pluto and back!' },
            { emoji: '', fact: 'Lightning strikes Earth about 8 million times per day, or about 100 times per second.' },
            { emoji: '', fact: 'The ocean contains about 20 million tons of gold dissolved in it - but it\'s too diluted to extract profitably.' },
            { emoji: '', fact: 'Your brain generates about 20 watts of electrical power when you\'re awake - enough to power a dim light bulb.' },
            { emoji: '', fact: 'The Sun loses about 4 million tons of mass every second through nuclear fusion - and has enough fuel for another 5 billion years.' },
            { emoji: '', fact: 'There are more bacteria in your mouth than there are people on Earth - about 6 billion!' },
            { emoji: '', fact: 'Earth is the only planet not named after a god. Its name comes from Old English meaning "ground".' },
            { emoji: '', fact: 'A sneeze can travel up to 100 mph and send 100,000 germs into the air.' },
            { emoji: '', fact: 'The hottest temperature ever recorded on Earth was 56.7C (134F) in Death Valley, California.' },
            { emoji: '', fact: 'The coldest temperature ever recorded was -89.2C (-128.6F) at Antarctica\'s Vostok Station.' },
            { emoji: '', fact: 'Octopuses have three hearts, blue blood, and can change color in less than a second.' },
            { emoji: '', fact: 'The Moon is slowly drifting away from Earth at a rate of about 3.8 cm per year.' },
            { emoji: '', fact: 'Diamonds can form from peanut butter under extreme pressure - scientists have done it!' },
            { emoji: '', fact: 'Babies are born with about 270 bones, but adults only have 206 because some fuse together.' },
            { emoji: '', fact: 'A rainbow is actually a full circle - we just can\'t see the bottom half from the ground.' }
        ];

        function openRandomFactModal() {
            document.getElementById('randomFactModal').style.display = 'flex';
            generateRandomFact();
        }

        function closeRandomFactModal() {
            document.getElementById('randomFactModal').style.display = 'none';
        }

        function generateRandomFact() {
            const fact = randomFacts[Math.floor(Math.random() * randomFacts.length)];
            document.getElementById('factEmoji').textContent = fact.emoji;
            document.getElementById('factText').textContent = fact.fact;
            addXP(3);
        }

        // Homework Tracker Button
        const homeworkBtn = document.createElement('button');
        homeworkBtn.className = 'homework-btn';
        homeworkBtn.innerHTML = '';
        homeworkBtn.title = 'Homework Tracker';
        homeworkBtn.onclick = () => openHomeworkModal();
        document.body.appendChild(homeworkBtn);

        // Homework Tracker Modal
        const homeworkModal = document.createElement('div');
        homeworkModal.className = 'homework-modal';
        homeworkModal.id = 'homeworkModal';
        homeworkModal.innerHTML = `
            <div class="homework-content">
                <h3 style="color: #5e35b1; margin-bottom: 15px;"> Homework Tracker</h3>
                <div id="homeworkList"></div>
                <div class="add-homework">
                    <input type="text" id="homeworkTitle" placeholder="Assignment name...">
                    <input type="date" id="homeworkDue">
                    <button onclick="addHomework()" style="padding: 12px; background: #5e35b1; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Add Assignment</button>
                </div>
                <button onclick="closeHomeworkModal()" style="margin-top: 15px; padding: 10px 25px; background: #5e35b1; color: white; border: none; border-radius: 20px; cursor: pointer; width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(homeworkModal);

        function getHomework() {
            return JSON.parse(localStorage.getItem('scienceHomework') || '[]');
        }

        function saveHomework(hw) {
            localStorage.setItem('scienceHomework', JSON.stringify(hw));
        }

        function openHomeworkModal() {
            document.getElementById('homeworkModal').style.display = 'flex';
            renderHomework();
        }

        function closeHomeworkModal() {
            document.getElementById('homeworkModal').style.display = 'none';
        }

        function renderHomework() {
            const homework = getHomework();
            const container = document.getElementById('homeworkList');

            if (homework.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No homework yet! Add an assignment below.</p>';
                return;
            }

            const today = new Date().toDateString();
            container.innerHTML = homework.map((hw, i) => {
                const dueDate = new Date(hw.due);
                const isOverdue = dueDate < new Date() && !hw.completed;
                return `
                    <div class="homework-item ${hw.completed ? 'completed' : ''}">
                        <input type="checkbox" class="homework-checkbox" ${hw.completed ? 'checked' : ''} onchange="toggleHomework(${i})">
                        <div class="homework-info">
                            <div class="homework-title">${hw.title}</div>
                            <div class="homework-due ${isOverdue ? 'overdue' : ''}">Due: ${hw.due} ${isOverdue ? '(Overdue!)' : ''}</div>
                        </div>
                        <button onclick="deleteHomework(${i})" style="background: none; border: none; color: #f44336; cursor: pointer; font-size: 1.2rem;"></button>
                    </div>
                `;
            }).join('');
        }

        function addHomework() {
            const title = document.getElementById('homeworkTitle').value.trim();
            const due = document.getElementById('homeworkDue').value;

            if (!title || !due) {
                alert('Please enter both assignment name and due date!');
                return;
            }

            const homework = getHomework();
            homework.push({ title, due, completed: false });
            saveHomework(homework);
            document.getElementById('homeworkTitle').value = '';
            document.getElementById('homeworkDue').value = '';
            renderHomework();
        }

        function toggleHomework(index) {
            const homework = getHomework();
            homework[index].completed = !homework[index].completed;
            saveHomework(homework);
            if (homework[index].completed) {
                addXP(15);
            }
            renderHomework();
        }

        function deleteHomework(index) {
            const homework = getHomework();
            homework.splice(index, 1);
            saveHomework(homework);
            renderHomework();
        }

        console.log(' Scoreboard, Random Fact, and Homework Tracker loaded!');
    </script>

    <!-- Batch 93: Progress Rings Button -->
    <button class="progress-rings-btn" onclick="openProgressRings()" title="Progress Rings"></button>

    <!-- Progress Rings Modal -->
    <div class="progress-rings-modal" id="progressRingsModal" onclick="if(event.target===this)closeProgressRings()">
        <div class="progress-rings-content">
            <h3 style="margin: 0 0 20px 0; color: #7c4dff; text-align: center;"> Your Progress Rings</h3>
            <div class="ring-container" id="progressRingsContainer"></div>
            <p style="text-align: center; color: #666; margin-top: 20px; font-size: 0.85rem;">Complete activities to fill your rings!</p>
            <button onclick="closeProgressRings()" style="display: block; margin: 20px auto 0; padding: 10px 25px; background: #7c4dff; color: white; border: none; border-radius: 20px; cursor: pointer;">Close</button>
        </div>
    </div>

    <!-- Experiment Log Button -->
    <button class="experiment-log-btn" onclick="openExperimentLog()" title="Experiment Log"></button>

    <!-- Experiment Log Modal -->
    <div class="experiment-log-modal" id="experimentLogModal" onclick="if(event.target===this)closeExperimentLog()">
        <div class="experiment-log-content">
            <h3 style="margin: 0 0 20px 0; color: #00897b; text-align: center;"> Experiment Log</h3>
            <div id="experimentList"></div>
            <div class="add-experiment">
                <input type="text" id="experimentTitle" placeholder="Experiment name...">
                <textarea id="experimentNotes" rows="2" placeholder="What did you observe?"></textarea>
                <button onclick="addExperiment()" style="padding: 12px; background: linear-gradient(135deg, #00897b, #26a69a); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;"> Log Experiment (+20 XP)</button>
            </div>
            <button onclick="closeExperimentLog()" style="display: block; margin: 15px auto 0; padding: 10px 25px; background: #666; color: white; border: none; border-radius: 20px; cursor: pointer;">Close</button>
        </div>
    </div>

    <!-- Study Break Button -->
    <button class="study-break-btn" onclick="openStudyBreak()" title="Study Break Ideas"></button>

    <!-- Study Break Modal -->
    <div class="study-break-modal" id="studyBreakModal" onclick="if(event.target===this)closeStudyBreak()">
        <div class="study-break-content">
            <h3 style="margin: 0 0 15px 0; color: #ec407a;"> Take a Break!</h3>
            <p style="color: #666; font-size: 0.9rem;">Regular breaks help you learn better</p>
            <div class="break-activity" id="breakActivity"></div>
            <button class="new-break-btn" onclick="showRandomBreak()"> New Activity</button>
            <button onclick="closeStudyBreak()" style="display: block; margin: 15px auto 0; padding: 10px 25px; background: #999; color: white; border: none; border-radius: 20px; cursor: pointer;">Back to Studying</button>
        </div>
    </div>

    <script>
        // Batch 93: Progress Rings
        const progressCategories = [
            { id: 'questions', label: 'Questions', color: '#4caf50', icon: '' },
            { id: 'experiments', label: 'Experiments', color: '#00897b', icon: '' },
            { id: 'flashcards', label: 'Flashcards', color: '#ff9800', icon: '' },
            { id: 'quizzes', label: 'Quizzes', color: '#e91e63', icon: '' },
            { id: 'streak', label: 'Streak Days', color: '#9c27b0', icon: '' },
            { id: 'xp', label: 'XP Earned', color: '#2196f3', icon: '' }
        ];

        function getProgressData() {
            return JSON.parse(localStorage.getItem('progressRingsData') || '{"questions":0,"experiments":0,"flashcards":0,"quizzes":0,"streak":0,"xp":0}');
        }

        function updateProgressRing(category, amount) {
            const data = getProgressData();
            data[category] = (data[category] || 0) + amount;
            localStorage.setItem('progressRingsData', JSON.stringify(data));
        }

        function renderProgressRings() {
            const container = document.getElementById('progressRingsContainer');
            const data = getProgressData();
            const goals = { questions: 50, experiments: 10, flashcards: 30, quizzes: 20, streak: 7, xp: 1000 };

            container.innerHTML = progressCategories.map(cat => {
                const value = data[cat.id] || 0;
                const goal = goals[cat.id];
                const percent = Math.min((value / goal) * 100, 100);
                const circumference = 2 * Math.PI * 30;
                const offset = circumference - (percent / 100) * circumference;

                return `
                    <div class="progress-ring">
                        <svg class="ring-svg" viewBox="0 0 80 80">
                            <circle class="ring-bg" cx="40" cy="40" r="30"/>
                            <circle class="ring-progress" cx="40" cy="40" r="30"
                                stroke="${cat.color}"
                                stroke-dasharray="${circumference}"
                                stroke-dashoffset="${offset}"/>
                        </svg>
                        <div class="ring-value">${cat.icon} ${value}/${goal}</div>
                        <div class="ring-label">${cat.label}</div>
                    </div>
                `;
            }).join('');
        }

        function openProgressRings() {
            // Sync XP from main XP tracker
            const currentXP = parseInt(localStorage.getItem('scienceToolXP') || '0');
            const data = getProgressData();
            data.xp = currentXP;
            localStorage.setItem('progressRingsData', JSON.stringify(data));

            renderProgressRings();
            document.getElementById('progressRingsModal').style.display = 'flex';
        }

        function closeProgressRings() {
            document.getElementById('progressRingsModal').style.display = 'none';
        }

        // Experiment Log
        function getExperiments() {
            return JSON.parse(localStorage.getItem('experimentLog') || '[]');
        }

        function saveExperiments(experiments) {
            localStorage.setItem('experimentLog', JSON.stringify(experiments));
        }

        function renderExperiments() {
            const list = document.getElementById('experimentList');
            const experiments = getExperiments();

            if (experiments.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">No experiments logged yet. Start experimenting!</p>';
                return;
            }

            list.innerHTML = experiments.slice().reverse().map((exp, idx) => `
                <div class="experiment-entry">
                    <div class="experiment-title"> ${exp.title}</div>
                    <div class="experiment-date"> ${exp.date}</div>
                    ${exp.notes ? `<div class="experiment-notes">${exp.notes}</div>` : ''}
                    <button onclick="deleteExperiment(${experiments.length - 1 - idx})" style="margin-top: 8px; padding: 5px 10px; background: #ef5350; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.75rem;">Delete</button>
                </div>
            `).join('');
        }

        function addExperiment() {
            const title = document.getElementById('experimentTitle').value.trim();
            const notes = document.getElementById('experimentNotes').value.trim();

            if (!title) {
                alert('Please enter an experiment name!');
                return;
            }

            const experiments = getExperiments();
            experiments.push({
                title,
                notes,
                date: new Date().toLocaleDateString()
            });
            saveExperiments(experiments);

            // Update progress ring
            updateProgressRing('experiments', 1);

            addXP(20);
            document.getElementById('experimentTitle').value = '';
            document.getElementById('experimentNotes').value = '';
            renderExperiments();
        }

        function deleteExperiment(index) {
            const experiments = getExperiments();
            experiments.splice(index, 1);
            saveExperiments(experiments);
            renderExperiments();
        }

        function openExperimentLog() {
            renderExperiments();
            document.getElementById('experimentLogModal').style.display = 'flex';
        }

        function closeExperimentLog() {
            document.getElementById('experimentLogModal').style.display = 'none';
        }

        // Study Break Activities
        const breakActivities = [
            { emoji: '', title: 'Take a Walk', duration: '5-10 min', description: 'A short walk helps blood circulation and refreshes your brain!' },
            { emoji: '', title: 'Hydrate', duration: '2 min', description: 'Drink a glass of water. Your brain is 75% water!' },
            { emoji: '', title: '20-20-20 Eye Break', duration: '1 min', description: 'Look at something 20 feet away for 20 seconds to rest your eyes.' },
            { emoji: '', title: 'Deep Breathing', duration: '3 min', description: 'Take 10 deep breaths. Inhale for 4 counts, hold for 4, exhale for 4.' },
            { emoji: '', title: 'Healthy Snack', duration: '5 min', description: 'Grab a fruit or nuts. Brain food boosts concentration!' },
            { emoji: '', title: 'Listen to Music', duration: '5 min', description: 'Put on your favorite song and relax for a bit.' },
            { emoji: '', title: 'Hand Stretches', duration: '2 min', description: 'Stretch your fingers and wrists if you\'ve been writing a lot.' },
            { emoji: '', title: 'Look at Nature', duration: '3 min', description: 'Look outside at trees or plants. Green views reduce stress!' },
            { emoji: '', title: 'Watch Something Cute', duration: '3 min', description: 'Watch a short animal video. Cuteness improves focus!' },
            { emoji: '', title: 'Quick Exercises', duration: '5 min', description: 'Do 10 jumping jacks or stretches to energize yourself!' },
            { emoji: '', title: 'Text a Friend', duration: '3 min', description: 'Send a quick message to someone. Social connection matters!' },
            { emoji: '', title: 'Doodle Break', duration: '5 min', description: 'Draw anything you like! Doodling activates creative thinking.' }
        ];

        function showRandomBreak() {
            const activity = breakActivities[Math.floor(Math.random() * breakActivities.length)];
            document.getElementById('breakActivity').innerHTML = `
                <div class="break-emoji">${activity.emoji}</div>
                <div class="break-title">${activity.title}</div>
                <div class="break-duration"> ${activity.duration}</div>
                <div class="break-description">${activity.description}</div>
            `;
        }

        function openStudyBreak() {
            showRandomBreak();
            document.getElementById('studyBreakModal').style.display = 'flex';
        }

        function closeStudyBreak() {
            document.getElementById('studyBreakModal').style.display = 'none';
        }

        console.log(' Progress Rings, Experiment Log, and Study Breaks loaded!');
    </script>

    <!-- PowerPoint-style Table Grid Selector (positioned fixed, outside all containers) -->
    <div id="table-grid-selector" class="table-grid-selector">
        <h4 style="margin: 0 0 12px 0; font-size: 1rem; color: #2e7d32; font-weight: 600; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.2rem;"></span> Insert Table
        </h4>
        <p style="margin: 0 0 10px 0; font-size: 0.8rem; color: #666;">Hover to select size, click to insert</p>
        <div class="table-grid" id="table-grid"></div>
        <div class="grid-size-label" id="grid-size-label" style="text-align: center; margin-top: 12px; font-size: 0.95rem; color: #2e7d32; font-weight: 600; min-height: 20px;">Select size</div>
    </div>

</body>

</html>
